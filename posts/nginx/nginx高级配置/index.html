<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Nginx高级配置 - Daben's Blog</title><meta name=Description content="This is my cool site"><meta property="og:title" content="Nginx高级配置"><meta property="og:description" content="Nginx 高级配置及第三方模块"><meta property="og:type" content="article"><meta property="og:url" content="https://senmer.github.io/posts/nginx/nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-02T10:00:16+00:00"><meta property="article:modified_time" content="2022-08-02T10:00:16+00:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="Nginx高级配置"><meta name=twitter:description content="Nginx 高级配置及第三方模块"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://senmer.github.io/posts/nginx/nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/><link rel=prev href=https://senmer.github.io/posts/nginx/nginx%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE/><link rel=next href=https://senmer.github.io/posts/nginx/nginx%E5%AE%9E%E7%8E%B0rewrite%E5%8A%9F%E8%83%BD/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Nginx高级配置","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/senmer.github.io\/posts\/nginx\/nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE\/"},"genre":"posts","keywords":"nginx","wordcount":7216,"url":"https:\/\/senmer.github.io\/posts\/nginx\/nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE\/","datePublished":"2022-08-02T10:00:16+00:00","dateModified":"2022-08-02T10:00:16+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"作者"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Daben's Blog">Daben's Blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Daben's Blog">Daben's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Nginx高级配置</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>作者</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/nginx/><i class="far fa-folder fa-fw" aria-hidden=true></i>Nginx</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-08-02>2022-08-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 7216 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 15 分钟&nbsp;<span id=/posts/nginx/nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/ class=leancloud_visitors data-flag-title=Nginx高级配置>
<i class="far fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#内置变量>内置变量</a></li><li><a href=#自定义变量>自定义变量</a></li></ul><ul><li><a href=#自定义日志默认格式>自定义日志默认格式</a></li><li><a href=#自定义json格式日志>自定义json格式日志</a></li></ul><ul><li><a href=#https-相关参数>https 相关参数</a></li><li><a href=#自签名证书>自签名证书</a></li><li><a href=#https-配置>https 配置</a></li><li><a href=#实现多域名-https>实现多域名 https</a></li><li><a href=#实现-hsts>实现 HSTS</a></li></ul></nav></div></div><div class=content id=content><h1 id=nginx-高级配置及第三方模块>Nginx 高级配置及第三方模块</h1><h1 id=nginx-状态页>Nginx 状态页</h1><p>基于nginx 模块 ngx_http_stub_status_module 实现，在编译安装nginx的时候需要添加编译参数 &ndash;with-http_stub_status_module</p><p>注意：状态页显示的是整个服务器的状态，而非虚拟主机的状态</p><p>配置示例</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># nginx -V  #查看nginx编译参数，确定添加了ngx_http_stub_status_module模块</span>
</span></span><span class=line><span class=cl>nginx version: nginx/1.18.0
</span></span><span class=line><span class=cl>built by gcc 4.8.5 <span class=m>20150623</span> <span class=o>(</span>Red Hat 4.8.5-44<span class=o>)</span> <span class=o>(</span>GCC<span class=o>)</span> 
</span></span><span class=line><span class=cl>built with OpenSSL 1.0.2k-fips  <span class=m>26</span> Jan <span class=m>2017</span>
</span></span><span class=line><span class=cl>TLS SNI support enabled
</span></span><span class=line><span class=cl>configure arguments: --prefix<span class=o>=</span>/apps/nginx --user<span class=o>=</span>nginx --group<span class=o>=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># pwd</span>
</span></span><span class=line><span class=cl>/apps/nginx/conf.d
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># cat pc.conf #编辑虚拟主机，添加状态页配置</span>
</span></span><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>  listen <span class=m>80</span> default_server<span class=p>;</span>
</span></span><span class=line><span class=cl>  server_name pc.test.org<span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  location /nginx_status <span class=o>{</span>  <span class=c1>#状态页uri匹配规则</span>
</span></span><span class=line><span class=cl>        stub_status<span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##访问测试</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># curl pc.test.org/nginx_status/ </span>
</span></span><span class=line><span class=cl>Active connections: <span class=m>1</span> 
</span></span><span class=line><span class=cl>server accepts handled requests
</span></span><span class=line><span class=cl> <span class=m>11</span> <span class=m>11</span> <span class=m>15</span>   <span class=c1>#分别对应accepts,handled,requests三个字段</span>
</span></span><span class=line><span class=cl>Reading: <span class=m>0</span> Writing: <span class=m>1</span> Waiting: <span class=m>0</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##参数解释</span>
</span></span><span class=line><span class=cl>Active connections： <span class=c1>#当前处于活动状态的客户端连接数（=reading+writing+waiting）</span>
</span></span><span class=line><span class=cl>accepts：#统计总值，Nginx自启动后已经接受的客户端请求连接的总数。
</span></span><span class=line><span class=cl>handled：#统计总值，Nginx自启动后已经处理完成的客户端请求连接总数，通常等于accepts，除非有因为worker_connections限制等被拒绝的连接
</span></span><span class=line><span class=cl>requests：#统计总值，Nginx自启动后客户端发来的总的请求数（单次连接可能发生多次请求）。
</span></span><span class=line><span class=cl>Reading：#当前状态，正在读取客户端请求报文首部的连接的连接数,数值越大,说明排队现象严重,性能不足
</span></span><span class=line><span class=cl>Writing：#当前状态，正在向客户端发送响应报文过程中的连接数,数值越大,说明访问量很大
</span></span><span class=line><span class=cl>Waiting：#当前状态，正在等待客户端发出请求的空闲连接数，开启 keep-alive的情况下,这个值等于active – <span class=o>(</span>reading+writing<span class=o>)</span>
</span></span></code></pre></div><h1 id=nginx-第三方模块>Nginx 第三方模块</h1><p>第三方模块是对nginx 的功能扩展，第三方模块需要在编译安装nginx的时候使用参数&ndash;add-module=PATH指定路径添加，有的模块是由公司的开发人员针对业务需求定制开发的，有的模块是开源爱好者开发好之后上传到github进行开源的模块，nginx的第三方模块需要从源码重新编译进行支持</p><p>比如:开源的echo模块 <a href=https://github.com/openresty/echo-nginx-module target=_blank rel="noopener noreffer">https://github.com/openresty/echo-nginx-module</a></p><p>示例：添加第三方模块 echo-nginx-module</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#配置虚拟主机使用echo-nginx-module模块</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># cat pc.conf </span>
</span></span><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>  listen <span class=m>80</span> default_server<span class=p>;</span>
</span></span><span class=line><span class=cl>  server_name pc.test.org<span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  location /main <span class=o>{</span>
</span></span><span class=line><span class=cl>	index index.html<span class=p>;</span>
</span></span><span class=line><span class=cl> 	default_type text/html<span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=s2>&#34;hello world--&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	echo_reset_timer<span class=p>;</span>  <span class=c1>#将计时器开始时间重置为当前时间</span>
</span></span><span class=line><span class=cl>	echo_location /sub1<span class=p>;</span>
</span></span><span class=line><span class=cl>	echo_location /sub2<span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=s2>&#34;took </span><span class=nv>$echo_time_elapsed</span><span class=s2> sed for total.&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>location /sub1 <span class=o>{</span>
</span></span><span class=line><span class=cl>	echo_sleep 1<span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> sub1<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>location /sub2 <span class=o>{</span>
</span></span><span class=line><span class=cl>	echo_sleep 1<span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> sub2<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#语法检查报错</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># nginx -t</span>
</span></span><span class=line><span class=cl>nginx: <span class=o>[</span>emerg<span class=o>]</span> unknown directive <span class=s2>&#34;echo&#34;</span> in /apps/nginx/conf.d/pc.conf:8 <span class=c1>#不支持echo模块</span>
</span></span><span class=line><span class=cl>nginx: configuration file /apps/nginx/conf/nginx.conf <span class=nb>test</span> failed
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#查看当前nginx并未添加echo-nginx-module模块</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># nginx -V</span>
</span></span><span class=line><span class=cl>nginx version: nginx/1.18.0
</span></span><span class=line><span class=cl>built by gcc 4.8.5 <span class=m>20150623</span> <span class=o>(</span>Red Hat 4.8.5-44<span class=o>)</span> <span class=o>(</span>GCC<span class=o>)</span> 
</span></span><span class=line><span class=cl>built with OpenSSL 1.0.2k-fips  <span class=m>26</span> Jan <span class=m>2017</span>
</span></span><span class=line><span class=cl>TLS SNI support enabled
</span></span><span class=line><span class=cl>configure arguments: --prefix<span class=o>=</span>/apps/nginx --user<span class=o>=</span>nginx --group<span class=o>=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>###下载echo-nginx-mudule模块，重新编译nginx并添加此模块</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 src<span class=o>]</span><span class=c1># nginx -s stop  #停止老版本nginx</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># cd /usr/local/src</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 src<span class=o>]</span><span class=c1># git clone https://github.com/openresty/echo-nginx-module.git</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx-1.18.0<span class=o>]</span><span class=c1>#  ./configure \</span>
</span></span><span class=line><span class=cl>--prefix<span class=o>=</span>/apps/nginx <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--user<span class=o>=</span>nginx --group<span class=o>=</span>nginx <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-http_ssl_module <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-http_v2_module <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-http_realip_module <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-http_stub_status_module <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-http_gzip_static_module <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-pcre <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-stream <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-stream_ssl_module <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-stream_realip_module <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-http_perl_module <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--add-module<span class=o>=</span>/usr/local/src/echo-nginx-module  <span class=c1>#指定模块源代码路径</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 src<span class=o>]</span><span class=c1># make &amp;&amp; make install</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@centos7 nginx-1.18.0<span class=o>]</span><span class=c1># /apps/nginx/sbin/nginx -t  #语法检查通过</span>
</span></span><span class=line><span class=cl>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok
</span></span><span class=line><span class=cl>nginx: configuration file /apps/nginx/conf/nginx.conf <span class=nb>test</span> is successful
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx-1.18.0<span class=o>]</span><span class=c1># /apps/nginx/sbin/nginx -V  #查看编译后的新版本</span>
</span></span><span class=line><span class=cl>nginx version: nginx/1.18.0
</span></span><span class=line><span class=cl>built by gcc 4.8.5 <span class=m>20150623</span> <span class=o>(</span>Red Hat 4.8.5-44<span class=o>)</span> <span class=o>(</span>GCC<span class=o>)</span> 
</span></span><span class=line><span class=cl>built with OpenSSL 1.0.2k-fips  <span class=m>26</span> Jan <span class=m>2017</span>
</span></span><span class=line><span class=cl>TLS SNI support enabled
</span></span><span class=line><span class=cl>configure arguments: --prefix<span class=o>=</span>/apps/nginx --user<span class=o>=</span>nginx --group<span class=o>=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module<span class=o>=</span>/usr/local/src/echo-nginx-module
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#访问测试</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx-1.18.0<span class=o>]</span><span class=c1># nginx</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx-1.18.0<span class=o>]</span><span class=c1># curl pc.test.org/main/</span>
</span></span><span class=line><span class=cl>hello world--&gt;
</span></span><span class=line><span class=cl>172.16.16.88
</span></span><span class=line><span class=cl>sub1
</span></span><span class=line><span class=cl>sub2
</span></span><span class=line><span class=cl>took 2.009 sed <span class=k>for</span> total.
</span></span></code></pre></div><h1 id=nginx-使用变量>Nginx 使用变量</h1><p>nginx的变量可以在配置文件中引用，作为功能判断或者日志等场景使用</p><p>变量可以分为内置变量和自定义变量</p><p>内置变量是由nginx模块自带，通过变量可以获取到众多的与客户端访问相关的值。</p><h2 id=内置变量>内置变量</h2><p>官方文档 <a href=http://nginx.org/en/docs/varindex.html target=_blank rel="noopener noreffer">http://nginx.org/en/docs/varindex.html</a></p><p>常用内置变量</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>$remote_addr</span><span class=p>;</span> <span class=c1>#存放了客户端的地址，注意是客户端的公网IP</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$proxy_add_x_forwarded_for</span>  <span class=c1>#此变量表示将客户端IP追加请求报文中X-Forwarded-For首部字段,多个IP之间用逗号分隔,如果请求中没有X-Forwarded-For, 就使用$remote_addr</span>
</span></span><span class=line><span class=cl>the “X-Forwarded-For” client request header field with the <span class=nv>$remote_addr</span> variable 
</span></span><span class=line><span class=cl>appended to it, separated by a comma. If the “X-Forwarded-For” field is not 
</span></span><span class=line><span class=cl>present in the client request header, the <span class=nv>$proxy_add_x_forwarded_for</span> variable is 
</span></span><span class=line><span class=cl>equal to the <span class=nv>$remote_addr</span> variable.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$args</span><span class=p>;</span> <span class=c1>#存放了URL中的所有参数，例如:对于http://www.magedu.org/main/index.do?id=20190221&amp;partner=search $args的值就是：id=20190221&amp;partner=search</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$document_root</span><span class=p>;</span> <span class=c1>#保存了针对当前资源的请求的系统根目录,例如:/apps/nginx/html。</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$document_uri</span><span class=p>;</span> <span class=c1>#保存了当前请求中不包含参数的URI，注意是不包含请求的指令，比如:http://www.magedu.org/main/index.do?id=20190221&amp;partner=search会被定义为/main/index.do </span>
</span></span><span class=line><span class=cl><span class=c1>#$document_uri的值为:/main/index.do</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$host</span><span class=p>;</span> <span class=c1>#存放了请求的host名称</span>
</span></span><span class=line><span class=cl><span class=nv>$limit_rate</span><span class=p>;</span> <span class=c1>#如果nginx服务器使用limit_rate配置了显示网络速率，则会显示，如果没有设置， 则显示0</span>
</span></span><span class=line><span class=cl><span class=nv>$remote_port</span><span class=p>;</span> <span class=c1>#客户端请求Nginx服务器时随机打开的端口，这是每个客户端自己的端口</span>
</span></span><span class=line><span class=cl><span class=nv>$remote_user</span><span class=p>;</span> <span class=c1>#已经经过Auth Basic Module验证的用户名</span>
</span></span><span class=line><span class=cl><span class=nv>$request_body_file</span><span class=p>;</span> <span class=c1>#做反向代理时发给后端服务器的本地资源的名称</span>
</span></span><span class=line><span class=cl><span class=nv>$request_method</span><span class=p>;</span> <span class=c1>#请求资源的方式，GET/PUT/DELETE等</span>
</span></span><span class=line><span class=cl><span class=nv>$request_filename</span><span class=p>;</span> <span class=c1>#当前请求的资源文件的磁盘路径，由root或alias指令与URI请求生成的文件绝对路径，如:/apps/nginx/html/main/index.html</span>
</span></span><span class=line><span class=cl><span class=nv>$request_uri</span><span class=p>;</span> <span class=c1>#包含请求参数的原始URI，不包含主机名，相当于:$document_uri?$args,例如：/main/index.do?id=20190221&amp;partner=search </span>
</span></span><span class=line><span class=cl><span class=nv>$scheme</span><span class=p>;</span> <span class=c1>#请求的协议，例如:http，https,ftp等</span>
</span></span><span class=line><span class=cl><span class=nv>$server_protocol</span><span class=p>;</span> <span class=c1>#保存了客户端请求资源使用的协议的版本，例如:HTTP/1.0，HTTP/1.1，HTTP/2.0等</span>
</span></span><span class=line><span class=cl><span class=nv>$server_addr</span><span class=p>;</span> <span class=c1>#保存了服务器的IP地址</span>
</span></span><span class=line><span class=cl><span class=nv>$server_name</span><span class=p>;</span> <span class=c1>#请求的服务器的主机名</span>
</span></span><span class=line><span class=cl><span class=nv>$server_port</span><span class=p>;</span> <span class=c1>#请求的服务器的端口号</span>
</span></span><span class=line><span class=cl><span class=nv>$http_user_agent</span><span class=p>;</span> <span class=c1>#客户端浏览器的详细信息</span>
</span></span><span class=line><span class=cl><span class=nv>$http_cookie</span><span class=p>;</span> <span class=c1>#客户端的所有cookie信息</span>
</span></span><span class=line><span class=cl><span class=nv>$cookie_</span>&lt;name&gt; <span class=c1>#cookie中某个字段值，name为任意请求报文首部字部cookie的key</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$http_</span>&lt;name&gt; <span class=c1>#name为任意请求报文首部字段,表示记录请求报文的首部字段，name的对应的首部字段名需要为小写，如果有横线需要替换为下划线。</span>
</span></span><span class=line><span class=cl><span class=c1>#示例: </span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=nv>$http_user_agent</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=nv>$http_host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$sent_http_</span>&lt;name&gt; <span class=c1>#name为响应报文的首部字段，name的对应的首部字段名需要为小写，如果有横线需要替换为下划线,此变量有问题 </span>
</span></span><span class=line><span class=cl><span class=c1>#示例：</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=nv>$sent_http_server</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$arg_</span>&lt;name&gt; <span class=c1>#此变量存放了URL中的指定参数，name为请求url中指定的参数名</span>
</span></span><span class=line><span class=cl><span class=c1>#示例</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=nv>$arg_id</span><span class=p>;</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>##站点配置</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># cat /apps/nginx/conf.d/pc.conf </span>
</span></span><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>  listen <span class=m>80</span> default_server<span class=p>;</span>
</span></span><span class=line><span class=cl>  server_name pc.test.org<span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  location /main <span class=o>{</span>
</span></span><span class=line><span class=cl>   	index index.html<span class=p>;</span>
</span></span><span class=line><span class=cl>	default_type text/html<span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$args</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$document_root</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$document_uri</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$http_user_agent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$http_cookie</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$request_filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$scheme</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$scheme</span>://<span class=nv>$host$document_uri</span>?<span class=nv>$args</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##返回结果</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># curl -b title=test &#39;http://pc.test.org/main/index.do?id=2022&amp;partner=search&#39;</span>
</span></span><span class=line><span class=cl>172.16.16.88
</span></span><span class=line><span class=cl><span class=nv>id</span><span class=o>=</span>2022<span class=p>&amp;</span><span class=nv>partner</span><span class=o>=</span>search
</span></span><span class=line><span class=cl>/apps/nginx/html
</span></span><span class=line><span class=cl>/main/index.do
</span></span><span class=line><span class=cl>pc.test.org
</span></span><span class=line><span class=cl>curl/7.29.0
</span></span><span class=line><span class=cl><span class=nv>title</span><span class=o>=</span><span class=nb>test</span>
</span></span><span class=line><span class=cl>/apps/nginx/html/main/index.do
</span></span><span class=line><span class=cl>http
</span></span><span class=line><span class=cl>http://pc.test.org/main/index.do?id<span class=o>=</span>2022<span class=p>&amp;</span><span class=nv>partner</span><span class=o>=</span>search
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>##站点配置</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># cat /apps/nginx/conf.d/www.conf </span>
</span></span><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>  listen 80<span class=p>;</span>
</span></span><span class=line><span class=cl>  server_name www.test.com<span class=p>;</span>
</span></span><span class=line><span class=cl>  location /echo <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$request</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$args</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$document_uri</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$request_uri</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$document_root</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$request_method</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$request_filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$scheme</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>set</span>  <span class=nv>$test</span> <span class=nv>$http_host</span><span class=p>;</span>   <span class=c1>#自定义变量，将$http_host的值赋给test变量</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$test</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$http_User_Agent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$http_cookie</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$cookie_key1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##访问测试</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># curl -b &#39;key1=v1;key2=v2&#39; &#34;http://www.test.com/echo/index.html?id=666&amp;partner=search&#34; </span>
</span></span><span class=line><span class=cl>GET /echo/index.html?id<span class=o>=</span>666<span class=p>&amp;</span><span class=nv>partner</span><span class=o>=</span>search HTTP/1.1
</span></span><span class=line><span class=cl>172.16.16.88
</span></span><span class=line><span class=cl><span class=nv>id</span><span class=o>=</span>666<span class=p>&amp;</span><span class=nv>partner</span><span class=o>=</span>search
</span></span><span class=line><span class=cl>/echo/index.html
</span></span><span class=line><span class=cl>/echo/index.html?id<span class=o>=</span>666<span class=p>&amp;</span><span class=nv>partner</span><span class=o>=</span>search
</span></span><span class=line><span class=cl>/apps/nginx/html
</span></span><span class=line><span class=cl>www.test.com
</span></span><span class=line><span class=cl>GET
</span></span><span class=line><span class=cl>/apps/nginx/html/echo/index.html
</span></span><span class=line><span class=cl>http
</span></span><span class=line><span class=cl>www.test.com
</span></span><span class=line><span class=cl>curl/7.29.0
</span></span><span class=line><span class=cl><span class=nv>key1</span><span class=o>=</span>v1<span class=p>;</span><span class=nv>key2</span><span class=o>=</span>v2
</span></span><span class=line><span class=cl>v1
</span></span></code></pre></div><h2 id=自定义变量>自定义变量</h2><p>语法格式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Syntax: <span class=nb>set</span> <span class=nv>$variable</span> value<span class=p>;</span>
</span></span><span class=line><span class=cl>Default: —
</span></span><span class=line><span class=cl>Context: server, location, <span class=k>if</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>##站点配置</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># cat /apps/nginx/conf.d/www.conf </span>
</span></span><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>  listen 80<span class=p>;</span>
</span></span><span class=line><span class=cl>  server_name www.test.com<span class=p>;</span>
</span></span><span class=line><span class=cl>  location /echo <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=nb>set</span> <span class=nv>$name</span> test<span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>set</span> <span class=nv>$my_port</span> <span class=nv>$server_port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=nv>$my_port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=s2>&#34;server_name:</span><span class=nv>$server_port</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##访问测试</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># curl www.test.com/echo</span>
</span></span><span class=line><span class=cl>GET /echo HTTP/1.1
</span></span><span class=line><span class=cl>172.16.16.88
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/echo
</span></span><span class=line><span class=cl>/echo
</span></span><span class=line><span class=cl>/apps/nginx/html
</span></span><span class=line><span class=cl>www.test.com
</span></span><span class=line><span class=cl>GET
</span></span><span class=line><span class=cl>/apps/nginx/html/echo
</span></span><span class=line><span class=cl>http
</span></span><span class=line><span class=cl>www.test.com
</span></span><span class=line><span class=cl>curl/7.29.0
</span></span></code></pre></div><h1 id=nginx-自定义访问日志>Nginx 自定义访问日志</h1><p>访问日志是记录客户端即用户的具体请求内容信息，而在全局配置模块中的error_log是记录nginx服务器运行时的日志保存路径和日志的level，两者是不同的，而且Nginx的错误日志一般只有一个，但是访问日志可以在不同的server中定义多个。定义访问日志使用access_log指令指定日志保存路径，使用log_format指定日志的格式，格式中定义要保存的具体的日志内容。</p><p>访问日志由 ngx_http_log_module 模块实现</p><p>官方帮助文档：http://nginx.org/en/docs/http/ngx_http_log_module.html</p><p>语法格式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tex data-lang=tex><span class=line><span class=cl>Syntax: access<span class=nb>_</span>log path [format [buffer=size] [gzip[=level]] [flush=time] 
</span></span><span class=line><span class=cl>[if=condition]];
</span></span><span class=line><span class=cl>access<span class=nb>_</span>log off;
</span></span><span class=line><span class=cl>Default: 
</span></span><span class=line><span class=cl>access<span class=nb>_</span>log logs/access.log combined;
</span></span><span class=line><span class=cl>Context: http, server, location, if in location, limit<span class=nb>_</span>except
</span></span></code></pre></div><h2 id=自定义日志默认格式>自定义日志默认格式</h2><p>如果要保留日志的源格式，只需添加相应的日志内容，配置如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>http <span class=o>{</span>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    log_format my_nginx_format
</span></span><span class=line><span class=cl>        <span class=s1>&#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;$status $body_bytes_sent &#34;$http_referer&#34;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;$server_name:$server_port&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    access_log logs/access.log my_nginx_format<span class=p>;</span>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#注意：此指令一定要放在log_format命令后（nginx配置从上至下依次生效）</span>
</span></span><span class=line><span class=cl>access_log logs/access.log my_nginx_format<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##重启nginx访问测试</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># tail -3 logs/access.log </span>
</span></span><span class=line><span class=cl>172.16.16.88 - - <span class=o>[</span>02/Aug/2022:23:51:26 +0800<span class=o>]</span> <span class=s2>&#34;GET /echo HTTP/1.1&#34;</span> <span class=m>200</span> <span class=m>211</span> <span class=s2>&#34;-&#34;</span> <span class=s2>&#34;curl/7.29.0&#34;</span>  <span class=c1>#默认日志格式</span>
</span></span><span class=line><span class=cl>172.16.16.88 - - <span class=o>[</span>04/Aug/2022:19:08:42 +0800<span class=o>]</span> <span class=s2>&#34;GET / HTTP/1.1&#34;</span><span class=m>200</span> <span class=m>6</span> <span class=s2>&#34;-&#34;&#34;curl/7.29.0&#34;</span> <span class=s2>&#34;-&#34;</span>pc.test.org:80  <span class=c1>#自定义日志格式my_nginx_format</span>
</span></span></code></pre></div><h2 id=自定义json格式日志>自定义json格式日志</h2><p>nginx的默认日志格式记录的内容相对单一，且默认的格式也不方便后期做日志统计分析，生产环境中通常将nginx日志格式为json格式，然后配合ELK做日志收集、统计和分析。</p><p>配置示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>http <span class=o>{</span>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    log_format json_log
</span></span><span class=line><span class=cl>        <span class=s1>&#39;{&#34;@timestamp&#34;:&#34;$time_iso8601&#34;,&#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#34;clientip&#34;:&#34;$remote_addr&#34;,&#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#34;size&#34;:$body_bytes_sent,&#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#34;responsetime&#34;:$request_time,&#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#34;upstreamtime&#34;:&#34;$upstream_response_time&#34;,&#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#34;upstreamhost&#34;:&#34;$upstream_addr&#34;,&#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#34;http_host&#34;:&#34;$host&#34;,&#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#34;uri&#34;:&#34;$uri&#34;,&#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#34;xff&#34;:&#34;$http_x_forwarded_for&#34;,&#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#34;referer&#34;:&#34;$http_referer&#34;,&#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#34;tcp_xff&#34;:&#34;$proxy_protocol_addr&#34;,&#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#34;http_user_agent&#34;:&#34;$http_user_agent&#34;,&#39;</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;&#34;status&#34;:&#34;$status&#34;}&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    access_log logs/access.log json_log<span class=p>;</span>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##重启nginx，查看生成的日志格式</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># tail -1 logs/access.log </span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;@timestamp&#34;</span>:<span class=s2>&#34;2022-08-04T19:27:18+08:00&#34;</span>,<span class=s2>&#34;clientip&#34;</span>:<span class=s2>&#34;127.0.0.1&#34;</span>,<span class=s2>&#34;size&#34;</span>:6,<span class=s2>&#34;responsetime&#34;</span>:0.000,<span class=s2>&#34;upstreamtime&#34;</span>:<span class=s2>&#34;-&#34;</span>,<span class=s2>&#34;upstreamhost&#34;</span>:<span class=s2>&#34;-&#34;</span>,<span class=s2>&#34;http_host&#34;</span>:<span class=s2>&#34;localhost&#34;</span>,<span class=s2>&#34;uri&#34;</span>:<span class=s2>&#34;/index.html&#34;</span>,<span class=s2>&#34;xff&#34;</span>:<span class=s2>&#34;-&#34;</span>,<span class=s2>&#34;referer&#34;</span>:<span class=s2>&#34;-&#34;</span>,<span class=s2>&#34;tcp_xff&#34;</span>:<span class=s2>&#34;-&#34;</span>,<span class=s2>&#34;http_user_agent&#34;</span>:<span class=s2>&#34;curl/7.29.0&#34;</span>,<span class=s2>&#34;status&#34;</span>:<span class=s2>&#34;200&#34;</span>
</span></span></code></pre></div><h1 id=nginx-压缩功能>Nginx 压缩功能</h1><p>Nginx支持对指定类型的文件进行压缩然后再传输给客户端，而且压缩还可以设置压缩比例，压缩后的</p><p>文件大小将比源文件显著变小，这样有助于降低出口带宽的利用率，降低企业的IT支出，不过会占用相</p><p>应的CPU资源。</p><p>Nginx对文件的压缩功能是依赖于模块 ngx_http_gzip_module,默认是内置模块</p><p>官方文档：https://nginx.org/en/docs/http/ngx_http_gzip_module.html</p><p>格式：</p><pre tabindex=0><code>Syntax:	gzip on | off;
Default:	
gzip off;
Context:	http, server, location, if in location
</code></pre><p>相关指令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#启用或禁用gzip压缩，默认关闭</span>
</span></span><span class=line><span class=cl>gzip on <span class=p>|</span> off<span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#压缩比由低到高从1到9，默认为1</span>
</span></span><span class=line><span class=cl>gzip_comp_level level<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#禁用IE6 gzip功能</span>
</span></span><span class=line><span class=cl>gzip_disable <span class=s2>&#34;MSIE [1-6]\.&#34;</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#gzip压缩的最小文件，小于设置值的文件将不会压缩</span>
</span></span><span class=line><span class=cl>gzip_min_length 1k<span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#启用压缩功能时，协议的最小版本，默认HTTP/1.1</span>
</span></span><span class=line><span class=cl>gzip_http_version 1.0 <span class=p>|</span> 1.1<span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#指定Nginx服务需要向服务器申请的缓存空间的个数和大小,平台不同,默认:32 4k或者16 8k;</span>
</span></span><span class=line><span class=cl>gzip_buffers number size<span class=p>;</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#指明仅对哪些类型的资源执行压缩操作;默认为gzip_types text/html，不用显示指定，否则出错</span>
</span></span><span class=line><span class=cl>gzip_types mime-type ...<span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#如果启用压缩，是否在响应报文首部插入“Vary: Accept-Encoding”,一般建议打开</span>
</span></span><span class=line><span class=cl>gzip_vary on <span class=p>|</span> off<span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#预压缩，即直接从磁盘找到对应文件的gz后缀的式的压缩文件返回给用户，无需消耗服务器CPU</span>
</span></span><span class=line><span class=cl><span class=c1>#注意: 来自于ngx_http_gzip_static_module模块</span>
</span></span><span class=line><span class=cl>gzip_static on <span class=p>|</span> off<span class=p>;</span>
</span></span></code></pre></div><p>示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>##分别生成5Bytes 大小的index.html文件以及2k大小的2k.text</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># echo test &gt; /apps/nginx/html/pc/index.html</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># dd if=/dev/zero of=/apps/nginx/html/pc/2k.text bs=2k count=1</span>
</span></span><span class=line><span class=cl>1+0 records in
</span></span><span class=line><span class=cl>1+0 records out
</span></span><span class=line><span class=cl><span class=m>2048</span> bytes <span class=o>(</span>2.0 kB<span class=o>)</span> copied, 0.000405459 s, 5.1 MB/s
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># ll /apps/nginx/html/pc/2k.text -h</span>
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> root root 2.0K Aug  <span class=m>4</span> 20:01 /apps/nginx/html/pc/2k.text
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># ll /apps/nginx/html/pc/index.html -h</span>
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> nginx nginx <span class=m>5</span> Aug  <span class=m>4</span> 19:43 /apps/nginx/html/pc/index.html
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#准备站点配置</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># cat /apps/nginx/conf.d/pc.conf </span>
</span></span><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>  listen <span class=m>80</span> default_server<span class=p>;</span>
</span></span><span class=line><span class=cl>  server_name pc.test.org<span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  gzip on<span class=p>;</span>
</span></span><span class=line><span class=cl>  gzip_comp_level 5<span class=p>;</span>
</span></span><span class=line><span class=cl>  gzip_min_length 1k<span class=p>;</span>   <span class=c1>#小于1k的文件不压缩</span>
</span></span><span class=line><span class=cl>  gzip_types text/plain application/javascript application/x-javascript text/css 
</span></span><span class=line><span class=cl>  application/xml text/javascript application/x-httpd-php image/gif image/png<span class=p>;</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  gzip_vary on<span class=p>;</span>
</span></span><span class=line><span class=cl>  location / <span class=o>{</span>
</span></span><span class=line><span class=cl>   	index index.html<span class=p>;</span>
</span></span><span class=line><span class=cl>	default_type text/html<span class=p>;</span>
</span></span><span class=line><span class=cl>	root html/pc<span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># nginx -s reload</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># curl -I --compressed pc.test.org/index.html</span>
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>Server: nginx/1.18.0
</span></span><span class=line><span class=cl>Date: Thu, <span class=m>04</span> Aug <span class=m>2022</span> 12:02:22 GMT
</span></span><span class=line><span class=cl>Content-Type: text/html
</span></span><span class=line><span class=cl>Content-Length: <span class=m>5</span>        <span class=c1>#index.html文件未压缩，仍是5Bytes</span>
</span></span><span class=line><span class=cl>Last-Modified: Thu, <span class=m>04</span> Aug <span class=m>2022</span> 11:43:47 GMT
</span></span><span class=line><span class=cl>Connection: keep-alive
</span></span><span class=line><span class=cl>Keep-Alive: <span class=nv>timeout</span><span class=o>=</span><span class=m>60</span>
</span></span><span class=line><span class=cl>ETag: <span class=s2>&#34;62ebb0f3-5&#34;</span>
</span></span><span class=line><span class=cl>Accept-Ranges: bytes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># curl -I --compressed pc.test.org/2k.txt</span>
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>404</span> Not Found
</span></span><span class=line><span class=cl>Server: nginx/1.18.0
</span></span><span class=line><span class=cl>Date: Thu, <span class=m>04</span> Aug <span class=m>2022</span> 12:02:34 GMT
</span></span><span class=line><span class=cl>Content-Type: text/html
</span></span><span class=line><span class=cl>Content-Length: <span class=m>153</span>   <span class=c1>#2k.txt被压缩为153Bytes</span>
</span></span><span class=line><span class=cl>Connection: keep-alive
</span></span><span class=line><span class=cl>Keep-Alive: <span class=nv>timeout</span><span class=o>=</span><span class=m>60</span>
</span></span></code></pre></div><h1 id=nginx-配置https>Nginx 配置https</h1><h2 id=https-相关参数>https 相关参数</h2><p>nginx 的https 功能基于模块ngx_http_ssl_module实现，作为nginx的核心功能，yum安装的nginx默认就是开启的，编译安装的nginx需要指定编译参数&ndash;with-http_ssl_module开启。</p><p>官方文档：https://nginx.org/en/docs/http/ngx_http_ssl_module.html</p><p>相关指令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#为指定的虚拟主机配置是否启用ssl功能，此功能在1.15.0废弃，使用listen [ssl]替代</span>
</span></span><span class=line><span class=cl>ssl on <span class=p>|</span> off<span class=p>;</span>   
</span></span><span class=line><span class=cl>listen <span class=m>443</span> ssl<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#指向包含当前虚拟主机和CA的两个证书信息的文件，一般是crt文件</span>
</span></span><span class=line><span class=cl>ssl_certificate /path/to/file<span class=p>;</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#当前虚拟主机使用的私钥文件，一般是key文件</span>
</span></span><span class=line><span class=cl>ssl_certificate_key /path/to/file<span class=p>;</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#支持ssl协议版本，早期为ssl现在是TLS，默认为后三个 </span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#配置ssl缓存</span>
</span></span><span class=line><span class=cl>ssl_session_cache off <span class=p>|</span> none <span class=p>|</span> <span class=o>[</span>builtin<span class=o>[</span>:size<span class=o>]]</span> <span class=o>[</span>shared:name:size<span class=o>]</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   	off： <span class=c1>#关闭缓存</span>
</span></span><span class=line><span class=cl> 	none:  <span class=c1>#通知客户端支持ssl session cache，但实际不支持</span>
</span></span><span class=line><span class=cl> 	builtin<span class=o>[</span>:size<span class=o>]</span>：#使用OpenSSL内建缓存，为每worker进程私有
</span></span><span class=line><span class=cl> 	<span class=o>[</span>shared:name:size<span class=o>]</span>：#在各worker之间使用一个共享的缓存，需要定义一个缓存名称和缓存空间大小，一兆可以存储4000个会话信息，多个虚拟主机可以使用相同的缓存名称
</span></span><span class=line><span class=cl> 	
</span></span><span class=line><span class=cl><span class=c1>#客户端连接可以复用ssl session cache中缓存的有效时长，默认5m</span>
</span></span><span class=line><span class=cl>ssl_session_timeout time<span class=p>;</span> 
</span></span></code></pre></div><h2 id=自签名证书>自签名证书</h2><p>生成自签名证书</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>##进入nginx安装目录，新建存放证书的目录</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># cd /apps/nginx/</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># mkdir certs</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># cd certs/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##生成自签名CA证书ca.crt和私钥ca.key</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 certs<span class=o>]</span><span class=c1># openssl req -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 3650 -out ca.crt</span>
</span></span><span class=line><span class=cl>Generating a <span class=m>4096</span> bit RSA private key
</span></span><span class=line><span class=cl>...........................................................................................++
</span></span><span class=line><span class=cl>................................................................................................................................................................................++
</span></span><span class=line><span class=cl>writing new private key to <span class=s1>&#39;ca.key&#39;</span>
</span></span><span class=line><span class=cl>-----
</span></span><span class=line><span class=cl>You are about to be asked to enter information that will be incorporated
</span></span><span class=line><span class=cl>into your certificate request.
</span></span><span class=line><span class=cl>What you are about to enter is what is called a Distinguished Name or a DN.
</span></span><span class=line><span class=cl>There are quite a few fields but you can leave some blank
</span></span><span class=line><span class=cl>For some fields there will be a default value,
</span></span><span class=line><span class=cl>If you enter <span class=s1>&#39;.&#39;</span>, the field will be left blank.
</span></span><span class=line><span class=cl>-----
</span></span><span class=line><span class=cl>Country Name <span class=o>(</span><span class=m>2</span> letter code<span class=o>)</span> <span class=o>[</span>XX<span class=o>]</span>:cn
</span></span><span class=line><span class=cl>State or Province Name <span class=o>(</span>full name<span class=o>)</span> <span class=o>[]</span>:sichuan
</span></span><span class=line><span class=cl>Locality Name <span class=o>(</span>eg, city<span class=o>)</span> <span class=o>[</span>Default City<span class=o>]</span>:chengdu
</span></span><span class=line><span class=cl>Organization Name <span class=o>(</span>eg, company<span class=o>)</span> <span class=o>[</span>Default Company Ltd<span class=o>]</span>:nginx
</span></span><span class=line><span class=cl>Organizational Unit Name <span class=o>(</span>eg, section<span class=o>)</span> <span class=o>[]</span>:nginx.com
</span></span><span class=line><span class=cl>Common Name <span class=o>(</span>eg, your name or your server<span class=s1>&#39;s hostname) []:www.nginx.com
</span></span></span><span class=line><span class=cl><span class=s1>Email Address []:22@qq.com
</span></span></span><span class=line><span class=cl><span class=s1>[root@centos7 certs]# ls
</span></span></span><span class=line><span class=cl><span class=s1>ca.crt  ca.key
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>##生成网站私钥www.nginx.com.key和证书请求www.nginx.com.csr
</span></span></span><span class=line><span class=cl><span class=s1>[root@centos7 certs]# openssl req -newkey rsa:4096 -nodes -sha256 -keyout www.nginx.com.key -out www.nginx.com.csr  
</span></span></span><span class=line><span class=cl><span class=s1>Generating a 4096 bit RSA private key
</span></span></span><span class=line><span class=cl><span class=s1>.......++
</span></span></span><span class=line><span class=cl><span class=s1>...................................................................................++
</span></span></span><span class=line><span class=cl><span class=s1>writing new private key to &#39;</span>www.nginx.com.key<span class=s1>&#39;
</span></span></span><span class=line><span class=cl><span class=s1>-----
</span></span></span><span class=line><span class=cl><span class=s1>You are about to be asked to enter information that will be incorporated
</span></span></span><span class=line><span class=cl><span class=s1>into your certificate request.
</span></span></span><span class=line><span class=cl><span class=s1>What you are about to enter is what is called a Distinguished Name or a DN.
</span></span></span><span class=line><span class=cl><span class=s1>There are quite a few fields but you can leave some blank
</span></span></span><span class=line><span class=cl><span class=s1>For some fields there will be a default value,
</span></span></span><span class=line><span class=cl><span class=s1>If you enter &#39;</span>.<span class=s1>&#39;, the field will be left blank.
</span></span></span><span class=line><span class=cl><span class=s1>-----
</span></span></span><span class=line><span class=cl><span class=s1>Country Name (2 letter code) [XX]:cn       #国家
</span></span></span><span class=line><span class=cl><span class=s1>State or Province Name (full name) []:sichuan #省份
</span></span></span><span class=line><span class=cl><span class=s1>Locality Name (eg, city) [Default City]:chengdu #城市
</span></span></span><span class=line><span class=cl><span class=s1>Organization Name (eg, company) [Default Company Ltd]:nginx #公司
</span></span></span><span class=line><span class=cl><span class=s1>Organizational Unit Name (eg, section) []:nginx.com #部门
</span></span></span><span class=line><span class=cl><span class=s1>Common Name (eg, your name or your server&#39;</span>s hostname<span class=o>)</span> <span class=o>[]</span>:www.nginx.com <span class=c1>#通用名</span>
</span></span><span class=line><span class=cl>Email Address <span class=o>[]</span>:511670559@qq.com  <span class=c1>#邮箱</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Please enter the following <span class=s1>&#39;extra&#39;</span> attributes
</span></span><span class=line><span class=cl>to be sent with your certificate request
</span></span><span class=line><span class=cl>A challenge password <span class=o>[]</span>:  
</span></span><span class=line><span class=cl>An optional company name <span class=o>[]</span>:
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 certs<span class=o>]</span><span class=c1># ls www*</span>
</span></span><span class=line><span class=cl>www.nginx.com.csr  www.nginx.com.key  www.nginx.crt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##使用ca签发网站的证书www.nginx.crt</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 certs<span class=o>]</span><span class=c1># openssl x509 -req -days 3650 -in www.nginx.com.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out www.nginx.com.crt</span>
</span></span><span class=line><span class=cl>Signature ok
</span></span><span class=line><span class=cl><span class=nv>subject</span><span class=o>=</span>/C<span class=o>=</span>cn/ST<span class=o>=</span>sichuan/L<span class=o>=</span>chengdu/O<span class=o>=</span>nginx/OU<span class=o>=</span>nginx.com/CN<span class=o>=</span>www.nginx.com/emailAddress<span class=o>=</span>511670559@qq.com
</span></span><span class=line><span class=cl>Getting CA Private Key
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 certs<span class=o>]</span><span class=c1># ls</span>
</span></span><span class=line><span class=cl>ca.crt  ca.key  ca.srl  www.nginx.com.crt  www.nginx.com.csr  www.nginx.com.key
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##查看证书内容</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 certs<span class=o>]</span><span class=c1># openssl x509 -in www.nginx.com.crt -noout -text</span>
</span></span><span class=line><span class=cl>Certificate:
</span></span><span class=line><span class=cl>    Data:
</span></span><span class=line><span class=cl>        Version: <span class=m>1</span> <span class=o>(</span>0x0<span class=o>)</span>
</span></span><span class=line><span class=cl>        Serial Number:
</span></span><span class=line><span class=cl>            f5:49:30:f5:10:2f:4b:ea
</span></span><span class=line><span class=cl>    Signature Algorithm: sha256WithRSAEncryption
</span></span><span class=line><span class=cl>        Issuer: <span class=nv>C</span><span class=o>=</span>cn, <span class=nv>ST</span><span class=o>=</span>sichuan, <span class=nv>L</span><span class=o>=</span>chengdu, <span class=nv>O</span><span class=o>=</span>nginx, <span class=nv>OU</span><span class=o>=</span>nginx.com, <span class=nv>CN</span><span class=o>=</span>www.nginx.com/emailAddress<span class=o>=</span>22@qq.com
</span></span><span class=line><span class=cl>        Validity
</span></span><span class=line><span class=cl>            Not Before: Aug  <span class=m>4</span> 14:48:57 <span class=m>2022</span> GMT
</span></span><span class=line><span class=cl>            Not After : Aug  <span class=m>1</span> 14:48:57 <span class=m>2032</span> GMT
</span></span><span class=line><span class=cl>        Subject: <span class=nv>C</span><span class=o>=</span>cn, <span class=nv>ST</span><span class=o>=</span>sichuan, <span class=nv>L</span><span class=o>=</span>chengdu, <span class=nv>O</span><span class=o>=</span>nginx, <span class=nv>OU</span><span class=o>=</span>nginx.com, <span class=nv>CN</span><span class=o>=</span>www.nginx.com/emailAddress<span class=o>=</span>511670559@qq.com
</span></span><span class=line><span class=cl>        Subject Public Key Info:
</span></span><span class=line><span class=cl>            Public Key Algorithm: rsaEncryption
</span></span><span class=line><span class=cl>                Public-Key: <span class=o>(</span><span class=m>4096</span> bit<span class=o>)</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 将ca证书和网站证书输出到一个文件（注意前后次序）</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 certs<span class=o>]</span><span class=c1># cat www.nginx.com.crt ca.crt &gt; www.nginx.com.pem</span>
</span></span></code></pre></div><h2 id=https-配置>https 配置</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>##准备站点配置文件</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 certs<span class=o>]</span><span class=c1># cat /apps/nginx/conf.d/pc.conf </span>
</span></span><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>  listen 80<span class=p>;</span>
</span></span><span class=line><span class=cl>  listen <span class=m>443</span> ssl<span class=p>;</span>
</span></span><span class=line><span class=cl>  server_name pc.test.org<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  location / <span class=o>{</span>
</span></span><span class=line><span class=cl>   	index index.html<span class=p>;</span>
</span></span><span class=line><span class=cl>	default_type text/html<span class=p>;</span>
</span></span><span class=line><span class=cl>	root html/pc<span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl>  ssl_certificate /apps/nginx/certs/www.nginx.com.pem<span class=p>;</span>
</span></span><span class=line><span class=cl>  ssl_certificate_key /apps/nginx/certs/www.nginx.com.key<span class=p>;</span>
</span></span><span class=line><span class=cl>  ssl_session_cache shared:sslcache:20m<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##重启nginx</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 certs<span class=o>]</span><span class=c1># nginx -t</span>
</span></span><span class=line><span class=cl>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok
</span></span><span class=line><span class=cl>nginx: configuration file /apps/nginx/conf/nginx.conf <span class=nb>test</span> is successful
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 certs<span class=o>]</span><span class=c1># nginx -s reload</span>
</span></span></code></pre></div><p>浏览器访问测试，由于是自签名证书，浏览器并不信任</p><p><img class=lazyload src=/svg/loading.min.svg data-src=Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220804150608344.png data-srcset="Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220804150608344.png, Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220804150608344.png 1.5x, Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220804150608344.png 2x" data-sizes=auto alt=Nginx高级配置/image-20220804150608344.png title=image-20220804150608344></p><p><img class=lazyload src=/svg/loading.min.svg data-src=Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220804150708178.png data-srcset="Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220804150708178.png, Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220804150708178.png 1.5x, Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220804150708178.png 2x" data-sizes=auto alt=Nginx高级配置/image-20220804150708178.png title=Nginx高级配置/image-20220804150708178.png></p><p><img class=lazyload src=/svg/loading.min.svg data-src=Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220804150819669.png data-srcset="Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220804150819669.png, Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220804150819669.png 1.5x, Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220804150819669.png 2x" data-sizes=auto alt=Nginx高级配置/image-20220804150819669.png title=image-20220804150819669></p><h2 id=实现多域名-https>实现多域名 https</h2><p>Nginx 支持基于单个IP实现多域名的功能，并且还支持单IP多域名的基础之上实现HTTPS，其实是基于Nginx的 SNI（Server Name Indication）功能实现，SNI是为了解决一个Nginx服务器内使用一个IP绑定多个域名和证书的功能。其实现流程是客户端在连接到服务器建立SSL链接之前先发送要访问站点的域名（Hostname），这样服务器再根据这个域名返回给客户端一个合适的证书。</p><p>简单来说，SNI实现了为多个虚拟主机配置各自的https认证功能，配置方式和上一节内容类似，这里不做演示。</p><p>查看nginx支持SNI功能：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># nginx -V</span>
</span></span><span class=line><span class=cl>nginx version: nginx/1.18.0
</span></span><span class=line><span class=cl>built by gcc 4.8.5 <span class=m>20150623</span> <span class=o>(</span>Red Hat 4.8.5-44<span class=o>)</span> <span class=o>(</span>GCC<span class=o>)</span> 
</span></span><span class=line><span class=cl>built with OpenSSL 1.0.2k-fips  <span class=m>26</span> Jan <span class=m>2017</span>
</span></span><span class=line><span class=cl>TLS SNI support enabled  		<span class=c1>#支持SNI功能</span>
</span></span><span class=line><span class=cl>configure arguments: --prefix<span class=o>=</span>/apps/nginx --user<span class=o>=</span>nginx --group<span class=o>=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module<span class=o>=</span>/usr/local/src/echo-nginx-module
</span></span></code></pre></div><h2 id=实现-hsts>实现 HSTS</h2><p>官方文档：https://www.nginx.com/blog/http-strict-transport-security-hsts-and-nginx/</p><p><strong>未配置http跳转的情况时：</strong></p><p>实例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 站点配置</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># cat pc.conf </span>
</span></span><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>  listen 80<span class=p>;</span>
</span></span><span class=line><span class=cl>  listen <span class=m>443</span> ssl<span class=p>;</span>
</span></span><span class=line><span class=cl>  ssl_certificate /apps/nginx/certs/www.nginx.com.pem<span class=p>;</span>
</span></span><span class=line><span class=cl>  ssl_certificate_key /apps/nginx/certs/www.nginx.com.key<span class=p>;</span>
</span></span><span class=line><span class=cl>  ssl_session_cache shared:sslcache:20m<span class=p>;</span>
</span></span><span class=line><span class=cl>  ssl_session_timeout 10m<span class=p>;</span>
</span></span><span class=line><span class=cl>  server_name pc.test.org<span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  location / <span class=o>{</span>
</span></span><span class=line><span class=cl>   	index index.html<span class=p>;</span>
</span></span><span class=line><span class=cl>	default_type text/html<span class=p>;</span>
</span></span><span class=line><span class=cl>	root html/<span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#http访问成功</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># curl www.test.org</span>
</span></span><span class=line><span class=cl>default
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#https请求报错</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># curl www.test.org:443</span>
</span></span><span class=line><span class=cl>&lt;html&gt;
</span></span><span class=line><span class=cl>&lt;head&gt;&lt;title&gt;400 The plain HTTP request was sent to HTTPS port&lt;/title&gt;&lt;/head&gt;
</span></span><span class=line><span class=cl>&lt;body&gt;
</span></span><span class=line><span class=cl>&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;
</span></span><span class=line><span class=cl>&lt;center&gt;The plain HTTP request was sent to HTTPS port&lt;/center&gt;
</span></span><span class=line><span class=cl>&lt;hr&gt;&lt;center&gt;nginx/1.18.0&lt;/center&gt;
</span></span><span class=line><span class=cl>&lt;/body&gt;
</span></span><span class=line><span class=cl>&lt;/html&gt;
</span></span></code></pre></div><p><strong>配置rewrite实现http跳转https后：</strong></p><p>范例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>##站点配置</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># cat pc.conf </span>
</span></span><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>  listen 80<span class=p>;</span>
</span></span><span class=line><span class=cl>  listen <span class=m>443</span> ssl<span class=p>;</span>
</span></span><span class=line><span class=cl>  ssl_certificate /apps/nginx/certs/www.nginx.com.pem<span class=p>;</span>
</span></span><span class=line><span class=cl>  ssl_certificate_key /apps/nginx/certs/www.nginx.com.key<span class=p>;</span>
</span></span><span class=line><span class=cl>  ssl_session_cache shared:sslcache:20m<span class=p>;</span>
</span></span><span class=line><span class=cl>  ssl_session_timeout 10m<span class=p>;</span>
</span></span><span class=line><span class=cl>  server_name pc.test.org<span class=p>;</span>
</span></span><span class=line><span class=cl>  add_header Strict-Transport-Security <span class=s2>&#34;max-age=31536000; includeSubDomains&#34;</span>
</span></span><span class=line><span class=cl>always<span class=p>;</span> <span class=c1>#开启客户端缓存功能，当发起http请求时优先访问缓存，直接进行本地http跳转</span>
</span></span><span class=line><span class=cl>  location / <span class=o>{</span>
</span></span><span class=line><span class=cl>   	index index.html<span class=p>;</span>
</span></span><span class=line><span class=cl>	default_type text/html<span class=p>;</span>
</span></span><span class=line><span class=cl>	root html/<span class=p>;</span>
</span></span><span class=line><span class=cl>	     
</span></span><span class=line><span class=cl>	    <span class=c1>#配置http跳转https</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span> <span class=nv>$scheme</span> <span class=o>=</span> http <span class=o>)</span> <span class=o>{</span>   
</span></span><span class=line><span class=cl>            rewrite ^/<span class=o>(</span>.*<span class=o>)</span>$ https://www.test.org/<span class=nv>$1</span> redirect<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#发起http请求，返回响应码为302</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># curl pc.test.org</span>
</span></span><span class=line><span class=cl>&lt;html&gt;
</span></span><span class=line><span class=cl>&lt;head&gt;&lt;title&gt;302 Found&lt;/title&gt;&lt;/head&gt;
</span></span><span class=line><span class=cl>&lt;body&gt;
</span></span><span class=line><span class=cl>&lt;center&gt;&lt;h1&gt;302 Found&lt;/h1&gt;&lt;/center&gt;
</span></span><span class=line><span class=cl>&lt;hr&gt;&lt;center&gt;nginx/1.18.0&lt;/center&gt;
</span></span><span class=line><span class=cl>&lt;/body&gt;
</span></span><span class=line><span class=cl>&lt;/html&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># curl pc.test.org -L  #跟踪302重定向后又报证书校验错误</span>
</span></span><span class=line><span class=cl>curl: <span class=o>(</span>60<span class=o>)</span> Peer<span class=s1>&#39;s certificate issuer has been marked as not trusted by the user.
</span></span></span><span class=line><span class=cl><span class=s1>More details here: http://curl.haxx.se/docs/sslcerts.html
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>curl performs SSL certificate verification by default, using a &#34;bundle&#34;
</span></span></span><span class=line><span class=cl><span class=s1> of Certificate Authority (CA) public keys (CA certs). If the default
</span></span></span><span class=line><span class=cl><span class=s1> bundle file isn&#39;</span>t adequate, you can specify an alternate file
</span></span><span class=line><span class=cl> using the --cacert option.
</span></span><span class=line><span class=cl>If this HTTPS server uses a certificate signed by a CA represented in
</span></span><span class=line><span class=cl> the bundle, the certificate verification probably failed due to a
</span></span><span class=line><span class=cl> problem with the certificate <span class=o>(</span>it might be expired, or the name might
</span></span><span class=line><span class=cl> not match the domain name in the URL<span class=o>)</span>.
</span></span><span class=line><span class=cl>If you<span class=s1>&#39;d like to turn off curl&#39;</span>s verification of the certificate, use
</span></span><span class=line><span class=cl> the -k <span class=o>(</span>or --insecure<span class=o>)</span> option.
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1># 发起http请求，自动跳转https成功</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># curl pc.test.org -kL  #跟随重定向并忽略证书安全性检查，请求成功</span>
</span></span><span class=line><span class=cl>default
</span></span></code></pre></div><h1 id=关于-faviconio>关于 favicon.io</h1><p>favicon.ico 文件是网站标签页的小图标，当客户端使用浏览器问页面时，浏览器会自己主动发起请求获取页面的favicon.ico文件，但是当浏览器请求的favicon.ico文件不存在时，服务器会记录404日志，而且浏览器也会显示404报错</p><p>图标位置：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220805095057467.png data-srcset="Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220805095057467.png, Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220805095057467.png 1.5x, Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220805095057467.png 2x" data-sizes=auto alt=Nginx高级配置/image-20220805095057467.png title=image-20220805095057467></p><p>报错如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># tail -1 logs/error.log  # 日志中的报错</span>
</span></span><span class=line><span class=cl>2022/08/05 17:47:54 <span class=o>[</span>error<span class=o>]</span> 2604#0: *200 open<span class=o>()</span> <span class=s2>&#34;/apps/nginx/html/favicon.ico&#34;</span> failed <span class=o>(</span>2: No such file or directory<span class=o>)</span>, client: 172.16.16.1, server: pc.test.org, request: <span class=s2>&#34;GET /favicon.ico HTTP/1.1&#34;</span>, host: <span class=s2>&#34;pc.test.org&#34;</span>, referrer: <span class=s2>&#34;http://pc.test.org/&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># ls /apps/nginx/html/favicon.ico # 文件确实不存在</span>
</span></span><span class=line><span class=cl>ls: cannot access /apps/nginx/html/favicon.ico: No such file or directory
</span></span></code></pre></div><p>解决方案：</p><pre tabindex=0><code>#将自己的图标命令为favicon.ico放置于指定目录下
[root@centos7 html]# wget https://gitee.com/favicon.ico -P  /apps/nginx/html/
[root@centos7 html]# ll /apps/nginx/html/favicon.ico 
-rw-r--r-- 1 root root 41566 Jun 10 11:59 /apps/nginx/html/favicon.ico
</code></pre><p>访问测试（浏览器按快捷键 CTRL+F5 强制刷新）</p><p><img class=lazyload src=/svg/loading.min.svg data-src=Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220805100020035.png data-srcset="Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220805100020035.png, Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220805100020035.png 1.5x, Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220805100020035.png 2x" data-sizes=auto alt=Nginx高级配置/image-20220805100020035.png title=image-20220805100020035></p><h1 id=openssl版本升级>OpenSSL版本升级</h1><p>OpenSSL程序库当前广泛用于实现互联网的传输层安全（TLS）协议。心脏出血（Heartbleed），也简</p><p>称为心血漏洞，是一个出现在加密程序库OpenSSL的安全漏洞，此漏洞于2012年被引入了软件中，</p><p>2014年4月首次向公众披露。只要使用的是存在缺陷的OpenSSL实例，无论是服务器还是客户端，都可</p><p>能因此而受到攻击。此问题的原因是在实现TLS的心跳扩展时没有对输入进行适当验证（缺少边界检</p><p>查），因此漏洞的名称来源于“心跳”（heartbeat）。该程序错误属于缓冲区过读，即可以读取的数据比应该允许读取的还多。</p><p>范例：升级OpenSSL解决安全漏洞</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># nginx -V</span>
</span></span><span class=line><span class=cl>nginx version: nginx/1.18.0
</span></span><span class=line><span class=cl>built by gcc 4.8.5 <span class=m>20150623</span> <span class=o>(</span>Red Hat 4.8.5-44<span class=o>)</span> <span class=o>(</span>GCC<span class=o>)</span> 
</span></span><span class=line><span class=cl>built with OpenSSL 1.0.2k-fips  <span class=m>26</span> Jan <span class=m>2017</span>  <span class=c1>#当前OpenSSL版本</span>
</span></span><span class=line><span class=cl>TLS SNI support enabled
</span></span><span class=line><span class=cl>configure arguments: --prefix<span class=o>=</span>/apps/nginx --user<span class=o>=</span>nginx --group<span class=o>=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module<span class=o>=</span>/usr/local/src/echo-nginx-module
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##下载较新版本OpenSSL源码包</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># cd /usr/local/src/</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 src<span class=o>]</span><span class=c1># wget https://www.openssl.org/source/openssl-1.1.1h.tar.gz --no-check-certificate</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 src<span class=o>]</span><span class=c1># tar xf openssl-1.1.1h.tar.gz</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##编译安装OpenSSL</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 src<span class=o>]</span><span class=c1># cd /usr/local/src/nginx-1.18.0/</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx-1.18.0<span class=o>]</span><span class=c1># ./configure --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module  --with-openssl=/usr/local/src/openssl-1.1.1h  #注意OpenSSL路径要添加正确</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx-1.18.0<span class=o>]</span><span class=c1># make &amp;&amp; make install</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#语法检查通过</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx-1.18.0<span class=o>]</span><span class=c1># nginx -t</span>
</span></span><span class=line><span class=cl>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok
</span></span><span class=line><span class=cl>nginx: configuration file /apps/nginx/conf/nginx.conf <span class=nb>test</span> is successful
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx-1.18.0<span class=o>]</span><span class=c1># nginx -V</span>
</span></span><span class=line><span class=cl>nginx version: nginx/1.18.0
</span></span><span class=line><span class=cl>built by gcc 4.8.5 <span class=m>20150623</span> <span class=o>(</span>Red Hat 4.8.5-44<span class=o>)</span> <span class=o>(</span>GCC<span class=o>)</span> 
</span></span><span class=line><span class=cl>built with OpenSSL 1.1.1h  <span class=m>22</span> Sep <span class=m>2020</span>  <span class=c1>#版本升级成功</span>
</span></span><span class=line><span class=cl>TLS SNI support enabled
</span></span><span class=line><span class=cl>configure arguments: --prefix<span class=o>=</span>/apps/nginx --user<span class=o>=</span>nginx --group<span class=o>=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module<span class=o>=</span>/usr/local/src/echo-nginx-module --with-openssl<span class=o>=</span>/usr/local/src/openssl-1.1.1h
</span></span></code></pre></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-08-02</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://senmer.github.io/posts/nginx/nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/ data-title=Nginx高级配置 data-hashtags=nginx><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://senmer.github.io/posts/nginx/nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/ data-hashtag=nginx><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://senmer.github.io/posts/nginx/nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/ data-title=Nginx高级配置><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://senmer.github.io/posts/nginx/nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/ data-title=Nginx高级配置><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://senmer.github.io/posts/nginx/nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/ data-title=Nginx高级配置><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/nginx/>Nginx</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/nginx/nginx%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE/ class=prev rel=prev title=Nginx核心配置><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Nginx核心配置</a>
<a href=/posts/nginx/nginx%E5%AE%9E%E7%8E%B0rewrite%E5%8A%9F%E8%83%BD/ class=next rel=next title=/images/Nginx实现rewrite功能>/images/Nginx实现rewrite功能<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.105.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/valine@1.5.0/dist/Valine.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{valine:{appId:"5sitvRUskZFsUqZPlR7gPPkX-MdYXbMMI",appKey:"eOOoG9FJyETUTpDnzwzjb8z1",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-CN",pageSize:10,placeholder:"comment",recordIP:!0,serverURLs:"https://5sitvrus.api.lncldglobal.com",visitor:!0}},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>