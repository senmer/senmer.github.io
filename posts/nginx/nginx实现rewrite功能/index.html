<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Nginx实现rewrite功能 - Daben's Blog</title><meta name=Description content="This is my cool site"><meta property="og:title" content="Nginx实现rewrite功能"><meta property="og:description" content="Nginx实现网址重定向"><meta property="og:type" content="article"><meta property="og:url" content="https://senmer.github.io/posts/nginx/nginx%E5%AE%9E%E7%8E%B0rewrite%E5%8A%9F%E8%83%BD/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-10T16:32:07+00:00"><meta property="article:modified_time" content="2022-08-10T16:32:07+00:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="Nginx实现rewrite功能"><meta name=twitter:description content="Nginx实现网址重定向"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://senmer.github.io/posts/nginx/nginx%E5%AE%9E%E7%8E%B0rewrite%E5%8A%9F%E8%83%BD/><link rel=prev href=https://senmer.github.io/posts/nginx/nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/><link rel=next href=https://senmer.github.io/posts/shell/keepalived%E5%AE%89%E8%A3%85%E8%84%9A%E6%9C%AC/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Nginx实现rewrite功能","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/senmer.github.io\/posts\/nginx\/nginx%E5%AE%9E%E7%8E%B0rewrite%E5%8A%9F%E8%83%BD\/"},"genre":"posts","keywords":"","wordcount":4113,"url":"https:\/\/senmer.github.io\/posts\/nginx\/nginx%E5%AE%9E%E7%8E%B0rewrite%E5%8A%9F%E8%83%BD\/","datePublished":"2022-08-10T16:32:07+00:00","dateModified":"2022-08-10T16:32:07+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"作者"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?63ce39500f9db1110f1c08d9ed53fa96",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Daben's Blog">Daben's Blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Daben's Blog">Daben's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Nginx实现rewrite功能</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>作者</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/><i class="far fa-folder fa-fw" aria-hidden=true></i>Categories</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-08-10>2022-08-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 4113 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 9 分钟&nbsp;<span id=/posts/nginx/nginx%E5%AE%9E%E7%8E%B0rewrite%E5%8A%9F%E8%83%BD/ class=leancloud_visitors data-flag-title=Nginx实现rewrite功能>
<i class="far fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#if-指令>if 指令</a></li><li><a href=#set-指令>set 指令</a></li><li><a href=#break-指令>break 指令</a></li><li><a href=#return-指令>return 指令</a></li><li><a href=#rewrite_log-指令>rewrite_log 指令</a></li></ul><ul><li><a href=#rewrite-flag-使用介绍>rewrite flag 使用介绍</a></li><li><a href=#rewrite-案例域名重定向>rewrite 案例：域名重定向</a><ul><li><a href=#永久重定向-301>永久重定向 301</a></li><li><a href=#临时重定向-302>临时重定向 302</a></li></ul></li><li><a href=#rewrite-案例break与last>rewrite 案例：break与last</a><ul><li><a href=#break-案例>break 案例</a></li><li><a href=#last-案例>last 案例</a></li></ul></li><li><a href=#rewrite-案例自动跳转https>rewrite 案例：自动跳转https</a></li><li><a href=#rewrite-案例-重定向错误页面到主页>rewrite 案例： 重定向错误页面到主页</a></li><li><a href=#其他应用案例>其他应用案例</a></li></ul></nav></div></div><div class=content id=content><p>Nginx实现网址重定向</p><p>Nginx服务器利用 ngx_http_rewrite_module 模块解析和处理rewrite请求，此功能依靠 PCRE(perl compatible regular expression)，因此编译之前要安装PCRE库，rewrite是nginx服务器的重要功能之一，用于实现URL的重写，URL的重写是非常有用的功能，比如它可以在我们改变网站结构之后，不需要客户端修改原来的书签，也无需其他网站修改我们的链接，就可以设置为访问，另外还可以在一定程度上提高网站的安全性。</p><h1 id=ngx_http_rewrite_module-模块>ngx_http_rewrite_module 模块</h1><p>官方文档： <a href=https://nginx.org/en/docs/http/ngx_http_rewrite_module.html target=_blank rel="noopener noreffer">https://nginx.org/en/docs/http/ngx_http_rewrite_module.html</a></p><h2 id=if-指令>if 指令</h2><p>官方文档：https://nginx.org/en/docs/http/ngx_http_rewrite_module.html#if</p><p>if指令用于条件匹配判断，并根据条件判断结果选择不同的Nginx配置，可以配置在server或location块中进行配置，Nginx的if语法仅能使用if做单次判断，不支持使用if else或者if elif这样的多重判断，用法如下：</p><pre tabindex=0><code>if （条件匹配） { 
 action
}
</code></pre><p>if 指令使用正则表达式对变量进行匹配，匹配成功时if指令认为条件为true，否则认为false，支持以下条件判断运算符：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>=</span> <span class=c1>#比较变量和字符串是否相等，相等时if指令认为该条件为true，反之为false</span>
</span></span><span class=line><span class=cl>!<span class=o>=</span>  #比较变量和字符串是否不相等，不相等时if指令认为条件为true，反之为false
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>~ <span class=c1>#区分大小写字符，可以通过正则表达式匹配，满足匹配条件为真，不满足匹配条件为假</span>
</span></span><span class=line><span class=cl>!~ <span class=c1>#区分大小写字符,判断是否匹配，不满足匹配条件为真，满足匹配条件为假</span>
</span></span><span class=line><span class=cl>~* <span class=c1>#不区分大小写字符，可以通过正则表达式匹配，满足匹配条件为真，不满足匹配条件为假</span>
</span></span><span class=line><span class=cl>!~* <span class=c1>#不区分大小字符,判断是否匹配，满足匹配条件为假，不满足匹配条件为真</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-f 和 !-f <span class=c1>#判断请求的文件是否存在和是否不存在</span>
</span></span><span class=line><span class=cl>-d 和 !-d <span class=c1>#判断请求的目录是否存在和是否不存在</span>
</span></span><span class=line><span class=cl>-x 和 !-x <span class=c1>#判断文件是否可执行和是否不可执行</span>
</span></span><span class=line><span class=cl>-e 和 !-e <span class=c1>#判断请求的文件或目录是否存在和是否不存在(包括文件，目录，软链接) </span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#注意：</span>
</span></span><span class=line><span class=cl><span class=c1>#如果$变量的值为空字符串或0，则if指令认为该条件为false，其他条件为true。</span>
</span></span><span class=line><span class=cl><span class=c1>#nginx 1.0.1之前$变量的值如果以0开头的任意字符串会返回false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#示例：</span>
</span></span><span class=line><span class=cl>location /main <span class=o>{</span>
</span></span><span class=line><span class=cl>     index index.html<span class=p>;</span>
</span></span><span class=line><span class=cl>     default_type text/html<span class=p>;</span>
</span></span><span class=line><span class=cl>     <span class=k>if</span> <span class=o>(</span> <span class=nv>$scheme</span> <span class=o>=</span> http <span class=o>){</span>
</span></span><span class=line><span class=cl>       	<span class=nb>echo</span> <span class=s2>&#34;if-----&gt; </span><span class=nv>$scheme</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>     <span class=o>}</span>
</span></span><span class=line><span class=cl>     <span class=k>if</span> <span class=o>(</span> <span class=nv>$scheme</span> <span class=o>=</span> https <span class=o>){</span>
</span></span><span class=line><span class=cl>      	<span class=nb>echo</span> <span class=s2>&#34;if ----&gt; </span><span class=nv>$scheme</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  	 <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>     <span class=c1>#if (-f $request_filename) {</span>
</span></span><span class=line><span class=cl>     <span class=c1>#   echo &#34;$request_filename is exist&#34;;</span>
</span></span><span class=line><span class=cl>     <span class=c1>#}</span>
</span></span><span class=line><span class=cl>     <span class=k>if</span> <span class=o>(</span>!-e <span class=nv>$request_filename</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        echo <span class=s2>&#34;</span><span class=nv>$request_filename</span><span class=s2> is not exist&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        #return 409<span class=p>;</span>
</span></span><span class=line><span class=cl>  	 <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=set-指令>set 指令</h2><p>可以利用set指定定义变量，变量的值为字符串且支持字符串和nginx内置变量进行字符串拼接。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>location /main <span class=o>{</span>
</span></span><span class=line><span class=cl>   root /data/nginx/html/pc<span class=p>;</span>
</span></span><span class=line><span class=cl>   index index.html<span class=p>;</span>
</span></span><span class=line><span class=cl>   default_type text/html<span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nb>set</span> 	<span class=nv>$name</span> magedu<span class=p>;</span> 
</span></span><span class=line><span class=cl>   <span class=nb>echo</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>   <span class=nb>set</span> 	<span class=nv>$my_port</span> <span class=nv>$server_port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nb>echo</span> <span class=nv>$my_port</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=break-指令>break 指令</h2><p>用于中断当前相同作用域(location)中的其他Nginx指令，位于break指令后的其他指令不会执行。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>location /main <span class=o>{</span>
</span></span><span class=line><span class=cl>   root /data/nginx/html/pc<span class=p>;</span>
</span></span><span class=line><span class=cl>   index index.html<span class=p>;</span>
</span></span><span class=line><span class=cl>   default_type text/html<span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nb>set</span> <span class=nv>$name</span> magedu<span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nb>echo</span> <span class=nv>$name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   break<span class=p>;</span>  #location块中break后面的其他ngx_http_rewrite_module模块指令不会执行（如set指令）
</span></span><span class=line><span class=cl>   <span class=nb>set</span> <span class=nv>$my_port</span> <span class=nv>$server_port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nb>echo</span> <span class=nv>$my_port</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=return-指令>return 指令</h2><p>return用于完成对请求的处理，并直接向客户端返回响应状态码，比如:可以指定重定向URL(对于特殊重定向状态码，301/302等) 或者是指定提示文本内容(对于特殊状态码403/500等)，处于此指令后的所有配置都将不被执行，return可以在server、if 和 location块进行配置</p><p>语法格式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>return</span> code<span class=p>;</span> <span class=c1>#返回给客户端指定的HTTP状态码</span>
</span></span><span class=line><span class=cl><span class=k>return</span> code <span class=o>[</span>text<span class=o>]</span><span class=p>;</span> <span class=c1>#返回给客户端的状态码及响应报文的实体内容，可以调用变量,其中text如果有空格,需要用单或双引号引起来</span>
</span></span><span class=line><span class=cl><span class=k>return</span> code URL<span class=p>;</span> <span class=c1>#返回给客户端的URL地址</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>service error<span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># cat conf.d/pc.conf </span>
</span></span><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>    listen 80<span class=p>;</span>
</span></span><span class=line><span class=cl>    server_name pc.test.org<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    location / <span class=o>{</span>
</span></span><span class=line><span class=cl>    root /app/nginx/html/pc<span class=p>;</span>
</span></span><span class=line><span class=cl>	default_type text/html<span class=p>;</span>
</span></span><span class=line><span class=cl>	index index.html<span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=o>(</span><span class=nv>$scheme</span> <span class=o>=</span> http<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	    <span class=c1>#return 666;</span>
</span></span><span class=line><span class=cl>	    <span class=c1>#return 666 &#34;not allow http&#34;;</span>
</span></span><span class=line><span class=cl>	    <span class=c1>#return 301 http://www.baidu.com;</span>
</span></span><span class=line><span class=cl>	    <span class=k>return</span> <span class=m>500</span> <span class=s2>&#34;service error&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	    <span class=nb>echo</span> <span class=s2>&#34;if ------&gt; </span><span class=nv>$scheme</span><span class=s2>&#34;</span><span class=p>;</span> <span class=c1>#return 后面的指令不再执行</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>	  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##访问测试</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># curl pc.test.org</span>
</span></span><span class=line><span class=cl>service error<span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1>#</span>
</span></span></code></pre></div><h2 id=rewrite_log-指令>rewrite_log 指令</h2><p>设置是否开启记录ngx_http_rewrite_module 模块日志记录到 error_log日志文件当中，可以配置在http、server、location 或 if 中</p><p>注意：开启rewrite日志需要提前设置日志级别为notice</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>##开启错误日志</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># cat /apps/nginx/conf/nginx.conf |grep error_log</span>
</span></span><span class=line><span class=cl>error_log  logs/error.log  notice<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#开启rewrite_log</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># cat /apps/nginx/conf.d/pc.conf </span>
</span></span><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>    listen 80<span class=p>;</span>
</span></span><span class=line><span class=cl>    server_name pc.test.org<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    location / <span class=o>{</span>
</span></span><span class=line><span class=cl>        root /app/nginx/html/pc<span class=p>;</span>
</span></span><span class=line><span class=cl>        default_type text/html<span class=p>;</span>
</span></span><span class=line><span class=cl>        index index.html<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nb>set</span> <span class=nv>$name</span> test<span class=p>;</span>
</span></span><span class=line><span class=cl>        rewrite_log on<span class=p>;</span>
</span></span><span class=line><span class=cl>        break<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nb>set</span> <span class=nv>$my_port</span> <span class=nv>$server_port</span><span class=p>;</span>  <span class=c1>#由于只用了break指令，故set指令不会执行</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=nv>$my_port</span><span class=p>;</span>  <span class=c1>#echo指令将报错</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>	  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#访问测试</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># curl pc.test.org</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#查看日志记录</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># tail -1 /apps/nginx/logs/error.log </span>
</span></span><span class=line><span class=cl>2022/08/15 19:40:03 <span class=o>[</span>warn<span class=o>]</span> 1277#0: *7 using uninitialized <span class=s2>&#34;my_port&#34;</span> variable, client: 172.16.16.88, server: pc.test.org, request: <span class=s2>&#34;GET / HTTP/1.1&#34;</span>, host: <span class=s2>&#34;pc.test.org&#34;</span>
</span></span></code></pre></div><h1 id=rewrite-指令>rewrite 指令</h1><p>通过正则表达式的匹配来改变URI，可以同时存在一个或多个指令，按照顺序依次对URI进行匹配，rewrite主要是针对用户请求的URL或者是URI做具体处理</p><p>官方文档：https://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite</p><p>rewrite可以配置在 server、location、if 块中</p><p>语法格式：</p><pre tabindex=0><code>rewrite regex replacement [flag];
</code></pre><p>rewrite将用户请求的URI基于regex所描述的模式进行检查，匹配到时将其替换为表达式指定的新的URI</p><p>注意：如果在同一级配置块中存在多个rewrite规则，那么会自下而下逐个检查; 被某条件规则替换完成后，会重新进行新一轮的替换检查，隐含有循环机制, 但不超过10次; 如果超过，提示500响应码，[flag]所表示的标志位用于控制此循环机制</p><p>如果替换后的URL是以http://或https://开头，则替换结果会直接以重定向返回给客户端, 即永久重定向301</p><p><strong>正则表达式</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>.  	<span class=c1>#匹配除换行符以外的任意字符</span>
</span></span><span class=line><span class=cl><span class=se>\w</span>	<span class=c1>#匹配字母或数字或下划线或汉字</span>
</span></span><span class=line><span class=cl><span class=se>\s</span> 	<span class=c1>#匹配任意的空白符</span>
</span></span><span class=line><span class=cl><span class=se>\d</span> 	<span class=c1>#匹配数字</span>
</span></span><span class=line><span class=cl><span class=se>\b</span> 	<span class=c1>#匹配单词的开始或结束</span>
</span></span><span class=line><span class=cl>^  	<span class=c1>#匹配字付串的开始</span>
</span></span><span class=line><span class=cl>$  	<span class=c1>#匹配字符串的结束</span>
</span></span><span class=line><span class=cl>*  	<span class=c1>#匹配重复零次或更多次</span>
</span></span><span class=line><span class=cl>+  	<span class=c1>#匹配重复一次或更多次</span>
</span></span><span class=line><span class=cl>?  	<span class=c1>#匹配重复零次或一次</span>
</span></span><span class=line><span class=cl><span class=o>(</span>n<span class=o>)</span> <span class=c1>#匹配重复n次</span>
</span></span><span class=line><span class=cl><span class=o>{</span>n,<span class=o>}</span>	<span class=c1>#匹配重复n次或更多次</span>
</span></span><span class=line><span class=cl><span class=o>{</span>n,m<span class=o>}</span> 	<span class=c1>#匹配重复n到m次</span>
</span></span><span class=line><span class=cl>*? 	<span class=c1>#匹配重复任意次，但尽可能少重复</span>
</span></span><span class=line><span class=cl>+? 	<span class=c1>#匹配重复1次或更多次，但尽可能少重复</span>
</span></span><span class=line><span class=cl>?? 	<span class=c1>#匹配重复0次或1次，但尽可能少重复</span>
</span></span><span class=line><span class=cl><span class=o>{</span>n,m<span class=o>}</span>? <span class=c1>#匹配重复n到m次，但尽可能少重复</span>
</span></span><span class=line><span class=cl><span class=o>{</span>n,<span class=o>}</span>? 	<span class=c1>#匹配重复n次以上，但尽可能少重复</span>
</span></span><span class=line><span class=cl><span class=se>\W</span> 	 #匹配任意不是字母，数字，下划线，汉字的字符
</span></span><span class=line><span class=cl><span class=se>\S</span> 	<span class=c1>#匹配任意不是空白符的字符</span>
</span></span><span class=line><span class=cl><span class=se>\D</span> 	<span class=c1>#匹配任意非数字的字符</span>
</span></span><span class=line><span class=cl><span class=se>\B</span> 	<span class=c1>#匹配不是单词开头或结束的位置</span>
</span></span><span class=line><span class=cl><span class=o>[</span>^x<span class=o>]</span> 	<span class=c1>#匹配除了x以外的任意字符</span>
</span></span><span class=line><span class=cl><span class=o>[</span>^magedu<span class=o>]</span> 	<span class=c1>#匹配除了magedu 这几个字母以外的任意字符</span>
</span></span></code></pre></div><h2 id=rewrite-flag-使用介绍>rewrite flag 使用介绍</h2><p>利用nginx的rewrite的指令，可以实现url的重新跳转，rewrtie有四种不同的flag，分别是redirect(临时</p><p>重定向302)、permanent(永久重定向301)、break和last。其中前两种是跳转型的flag，后两种是代理型</p><ul><li>跳转型指由客户端浏览器重新对新地址进行请求</li><li>代理型是在WEB服务器内部实现跳转</li></ul><p>rewrite 格式</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Syntax: rewrite regex replacement <span class=o>[</span>flag<span class=o>]</span><span class=p>;</span> <span class=c1>#通过正则表达式处理用户请求并返回替换后的数据包。</span>
</span></span><span class=line><span class=cl>Default: —
</span></span><span class=line><span class=cl>Context: server, location, <span class=k>if</span>
</span></span></code></pre></div><p>flag 说明</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>redirect<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>#临时重定向，重写完成后以临时重定向方式直接返回重写后生成的新URL给客户端，由客户端重新发起请求;使用相对路径,或者http://或https://开头，状态码：302</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>permanent<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>#重写完成后以永久重定向方式直接返回重写后生成的新URL给客户端，由客户端重新发起请求，状态码：301</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>break<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>#重写完成后,停止对当前URL在当前location中后续的其它重写操作，而后直接跳转至重写规则配置块之后的其它配置;结束循环，建议在location中使用</span>
</span></span><span class=line><span class=cl><span class=c1>#适用于一个URL一次重写</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>last<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>#重写完成后,停止对当前URI在当前location中后续的其它重写操作，而后对新的URL启动新一轮重写检查，不建议在location中使用</span>
</span></span><span class=line><span class=cl><span class=c1>#适用于一个URL多次重写，要注意避免出现超过十次以及URL重写后返回错误的给用户</span>
</span></span></code></pre></div><h2 id=rewrite-案例域名重定向>rewrite 案例：域名重定向</h2><p>重定向分为临时重定向（301）和永久重定向（302），临时重定向不会缓存域名解析记录(A记录)，但是永久重定向会缓存。</p><p>示例：因业务需要，需将访问源域名pc.test.com 的请求重定向到mobile.test.com</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>##准备两个站点</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># curl pc.test.com</span>
</span></span><span class=line><span class=cl>pc_page
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># curl mobile.test.com</span>
</span></span><span class=line><span class=cl>mobile_page
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##配置跳转规则</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># cat conf.d/pc.conf </span>
</span></span><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>    listen 80<span class=p>;</span>
</span></span><span class=line><span class=cl>    server_name pc.test.com<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    location / <span class=o>{</span>
</span></span><span class=line><span class=cl>        root /apps/nginx/html/pc<span class=p>;</span>
</span></span><span class=line><span class=cl>        default_type text/html<span class=p>;</span>
</span></span><span class=line><span class=cl>        index index.html<span class=p>;</span>
</span></span><span class=line><span class=cl>         
</span></span><span class=line><span class=cl>      	<span class=c1>#rewrite / http://mobile.test.com;  #跳转至mobile.test.com</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>	  
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#测试跳转</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># curl pc.test.com -L</span>
</span></span><span class=line><span class=cl>mobile_page
</span></span></code></pre></div><h3 id=永久重定向-301>永久重定向 301</h3><p>域名永久型调整，即域名永远跳转至另外一个新的域名，之前的域名再也不使用，跳转记录可以缓存到</p><p>客户端浏览器</p><p>永久重定向会缓存DNS解析记录, 浏览器中有 from disk cache 信息</p><p>示例：访问www.360buy.com (京东早期域名）将永久跳转至 <a href=https://www.jd.com target=_blank rel="noopener noreffer">www.jd.com</a> （磁盘缓存该跳转信息）</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/images/Nginx%e5%ae%9e%e7%8e%b0rewrite%e5%8a%9f%e8%83%bd/image-20220815150427065.png data-srcset="/images/Nginx%e5%ae%9e%e7%8e%b0rewrite%e5%8a%9f%e8%83%bd/image-20220815150427065.png, /images/Nginx%e5%ae%9e%e7%8e%b0rewrite%e5%8a%9f%e8%83%bd/image-20220815150427065.png 1.5x, /images/Nginx%e5%ae%9e%e7%8e%b0rewrite%e5%8a%9f%e8%83%bd/image-20220815150427065.png 2x" data-sizes=auto alt=/images/Nginx实现rewrite功能/image-20220815150427065.png title=image-20220815150427065></p><h3 id=临时重定向-302>临时重定向 302</h3><p>域名临时重定向，告诉浏览器域名不是固定重定向到当前目标域名，后期可能随时会更改，因此浏览器</p><p>不会缓存当前域名的解析记录，而浏览器会缓存永久重定向的DNS解析记录，这也是临时重定向与永久</p><p>重定向最大的本质区别。</p><h2 id=rewrite-案例break与last>rewrite 案例：break与last</h2><h3 id=break-案例>break 案例</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># cat pc.conf</span>
</span></span><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>    listen 80<span class=p>;</span>
</span></span><span class=line><span class=cl>    server_name pc.test.com<span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    location /break <span class=o>{</span>
</span></span><span class=line><span class=cl>        root html<span class=p>;</span>
</span></span><span class=line><span class=cl>        index index.html<span class=p>;</span>
</span></span><span class=line><span class=cl>        rewrite ^/break/<span class=o>(</span>.*<span class=o>)</span> /test/<span class=nv>$1</span> break<span class=p>;</span> <span class=c1>#重写URL后，直接返回相应的请求结果</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    location /test <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=m>666</span> <span class=s2>&#34;====end====&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># curl pc.test.com/break/</span>
</span></span><span class=line><span class=cl><span class=o>====</span><span class=nv>end</span><span class=o>====[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># </span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#访问/break/** ，被重写为/test/**，但是重写后的路径并不存在，报错404</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># curl pc.test.com/break/**</span>
</span></span><span class=line><span class=cl>&lt;html&gt;
</span></span><span class=line><span class=cl>&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;
</span></span><span class=line><span class=cl>&lt;body&gt;
</span></span><span class=line><span class=cl>&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;
</span></span><span class=line><span class=cl>&lt;hr&gt;&lt;center&gt;nginx/1.18.0&lt;/center&gt;
</span></span><span class=line><span class=cl>&lt;/body&gt;
</span></span><span class=line><span class=cl>&lt;/html&gt;
</span></span></code></pre></div><h3 id=last-案例>last 案例</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># cat pc.conf</span>
</span></span><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>    listen 80<span class=p>;</span>
</span></span><span class=line><span class=cl>    server_name pc.test.com<span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    location /break <span class=o>{</span>
</span></span><span class=line><span class=cl>        root html<span class=p>;</span>
</span></span><span class=line><span class=cl>        index index.html<span class=p>;</span>
</span></span><span class=line><span class=cl>        rewrite ^/break/<span class=o>(</span>.*<span class=o>)</span> /test/<span class=nv>$1</span> last<span class=p>;</span>  <span class=c1>#重写请求URL后，重新发起请求匹配location</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    location /test <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=m>666</span> <span class=s2>&#34;====end====&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># curl pc.test.com/break/</span>
</span></span><span class=line><span class=cl><span class=o>====</span><span class=nv>end</span><span class=o>====[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># </span>
</span></span><span class=line><span class=cl><span class=c1>#访问/break/**, 被重写为/test/** , 重新发起新的匹配请求，匹配到/test，返回相应结果</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># curl pc.test.com/break/**  </span>
</span></span><span class=line><span class=cl><span class=o>====</span><span class=nv>end</span><span class=o>====[</span>root@centos7 conf.d<span class=o>]</span><span class=c1>#</span>
</span></span></code></pre></div><h2 id=rewrite-案例自动跳转https>rewrite 案例：自动跳转https</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># cat pc.conf</span>
</span></span><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>    listen 80<span class=p>;</span>
</span></span><span class=line><span class=cl>    listen <span class=m>443</span> ssl<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    server_name pc.test.com<span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ssl_certificate /apps/nginx/certs/www.nginx.com.pem<span class=p>;</span>
</span></span><span class=line><span class=cl>    ssl_certificate_key /apps/nginx/certs/www.nginx.com.key<span class=p>;</span>
</span></span><span class=line><span class=cl>    ssl_session_cache shared:sslcache:20m<span class=p>;</span> 
</span></span><span class=line><span class=cl>    ssl_session_timeout 10m<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    location / <span class=o>{</span>  <span class=c1>#配置全站https</span>
</span></span><span class=line><span class=cl>	root html/pc<span class=p>;</span>
</span></span><span class=line><span class=cl>	index index.html<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=o>(</span><span class=nv>$scheme</span> <span class=o>=</span> http<span class=o>)</span> <span class=o>{</span>  <span class=c1># </span>
</span></span><span class=line><span class=cl>	    rewrite / https://<span class=nv>$host</span> redirect<span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    location /login <span class=o>{</span>  <span class=c1>#配置部分站点https加密，如登录界面</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=o>(</span><span class=nv>$scheme</span> <span class=o>=</span> http<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	    rewrite / https://<span class=nv>$host</span>/login redirect<span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#访问测试，成功</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># curl  -ikL pc.test.com </span>
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>302</span> Moved Temporarily
</span></span><span class=line><span class=cl>Server: nginx/1.18.0
</span></span><span class=line><span class=cl>Date: Mon, <span class=m>15</span> Aug <span class=m>2022</span> 17:43:20 GMT
</span></span><span class=line><span class=cl>Content-Type: text/html
</span></span><span class=line><span class=cl>Content-Length: <span class=m>145</span>
</span></span><span class=line><span class=cl>Connection: keep-alive
</span></span><span class=line><span class=cl>Keep-Alive: <span class=nv>timeout</span><span class=o>=</span><span class=m>60</span>
</span></span><span class=line><span class=cl>Location: https://pc.test.com
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>Server: nginx/1.18.0
</span></span><span class=line><span class=cl>Date: Mon, <span class=m>15</span> Aug <span class=m>2022</span> 17:43:20 GMT
</span></span><span class=line><span class=cl>Content-Type: text/html
</span></span><span class=line><span class=cl>Content-Length: <span class=m>8</span>
</span></span><span class=line><span class=cl>Last-Modified: Mon, <span class=m>15</span> Aug <span class=m>2022</span> 12:24:47 GMT
</span></span><span class=line><span class=cl>Connection: keep-alive
</span></span><span class=line><span class=cl>Keep-Alive: <span class=nv>timeout</span><span class=o>=</span><span class=m>60</span>
</span></span><span class=line><span class=cl>ETag: <span class=s2>&#34;62fa3b0f-8&#34;</span>
</span></span><span class=line><span class=cl>Accept-Ranges: bytes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>pc_page
</span></span></code></pre></div><h2 id=rewrite-案例-重定向错误页面到主页>rewrite 案例： 重定向错误页面到主页</h2><p>案例：当用户访问一个不存在的URL时，将页面重定向至站点首页</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># cat pc.conf</span>
</span></span><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>    listen 80<span class=p>;</span>
</span></span><span class=line><span class=cl>    server_name pc.test.com<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    location / <span class=o>{</span>
</span></span><span class=line><span class=cl>	root html/pc<span class=p>;</span>
</span></span><span class=line><span class=cl>	index index.html<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=o>(</span> !-e <span class=nv>$request_filename</span> <span class=o>)</span> <span class=o>{</span>  <span class=c1>#配置跳转规则</span>
</span></span><span class=line><span class=cl>	    rewrite .* http://<span class=nv>$host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#访问不存在的页面测试</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># curl pc.test.com/** -L</span>
</span></span><span class=line><span class=cl>pc_page
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 conf.d<span class=o>]</span><span class=c1># curl pc.test.com/kk -L</span>
</span></span><span class=line><span class=cl>pc_page
</span></span></code></pre></div><h2 id=其他应用案例>其他应用案例</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#案例1:如果客户端浏览器包含MSIE，则rewrite客户端请求到/msie目录下</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span> <span class=nv>$http_user_agent</span> ~ MSIE<span class=o>){</span>
</span></span><span class=line><span class=cl> 	rewrite ^<span class=o>(</span>.*<span class=o>)</span>$ /msie/<span class=nv>$1</span> break<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1>#案例2: 更换目录访问方式, 目录转换为对象存储形式</span>
</span></span><span class=line><span class=cl><span class=c1>#要求:</span>
</span></span><span class=line><span class=cl><span class=c1>#/20200106/static -&gt;/static?id=20200106</span>
</span></span><span class=line><span class=cl><span class=c1>#/20200123/image -&gt;/image?id=20200123</span>
</span></span><span class=line><span class=cl>rewrite ^/<span class=o>(</span><span class=se>\d</span>+<span class=o>)</span>/<span class=o>(</span>.+<span class=o>)</span>/   /<span class=nv>$2</span>?id<span class=o>=</span><span class=nv>$l</span> last<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#案例3:多目录转换访问方式</span>
</span></span><span class=line><span class=cl><span class=c1>#要求: www.magedu.com/images/20200106/1.jpg =&gt; www.magedu.com/index.do?name=images&amp;dir=20200106=&amp;file=1.jpg</span>
</span></span><span class=line><span class=cl><span class=c1>#规则配置:</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=nv>$host</span> ~* <span class=o>(</span>.*<span class=o>)</span><span class=se>\.</span>magedu<span class=se>\.</span>com<span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl> rewrite ^/<span class=o>(</span>.*<span class=o>)</span>/<span class=o>(</span><span class=se>\d</span>+<span class=o>)</span>/<span class=o>(</span>.*<span class=o>)</span>$   /index.do?name<span class=o>=</span><span class=nv>$1</span><span class=p>&amp;</span><span class=nv>dir</span><span class=o>=</span><span class=nv>$2</span><span class=p>&amp;</span><span class=nv>file</span><span class=o>=</span><span class=nv>$3</span> last<span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-08-10</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://senmer.github.io/posts/nginx/nginx%E5%AE%9E%E7%8E%B0rewrite%E5%8A%9F%E8%83%BD/ data-title=Nginx实现rewrite功能 data-hashtags><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://senmer.github.io/posts/nginx/nginx%E5%AE%9E%E7%8E%B0rewrite%E5%8A%9F%E8%83%BD/ data-hashtag><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://senmer.github.io/posts/nginx/nginx%E5%AE%9E%E7%8E%B0rewrite%E5%8A%9F%E8%83%BD/ data-title=Nginx实现rewrite功能><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://senmer.github.io/posts/nginx/nginx%E5%AE%9E%E7%8E%B0rewrite%E5%8A%9F%E8%83%BD/ data-title=Nginx实现rewrite功能><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://senmer.github.io/posts/nginx/nginx%E5%AE%9E%E7%8E%B0rewrite%E5%8A%9F%E8%83%BD/ data-title=Nginx实现rewrite功能><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/>Tags</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/nginx/nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/ class=prev rel=prev title=Nginx高级配置><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Nginx高级配置</a>
<a href=/posts/shell/keepalived%E5%AE%89%E8%A3%85%E8%84%9A%E6%9C%AC/ class=next rel=next title=Keepalived安装脚本>Keepalived安装脚本<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.111.2">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/valine@1.5.0/dist/Valine.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{valine:{appId:"5sitvRUskZFsUqZPlR7gPPkX-MdYXbMMI",appKey:"eOOoG9FJyETUTpDnzwzjb8z1",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-CN",pageSize:10,placeholder:"comment",recordIP:!0,serverURLs:"https://5sitvrus.api.lncldglobal.com",visitor:!0}},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>