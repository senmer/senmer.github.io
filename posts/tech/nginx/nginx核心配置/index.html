<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Nginx核心配置 | WZ's Blog</title><meta name=keywords content="Nginx"><meta name=description content="主要介绍Nginx核心配置文件"><meta name=author content="nier"><link rel=canonical href=https://senmer.github.io/posts/tech/nginx/nginx%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE/><link crossorigin=anonymous href=/assets/css/stylesheet.5a2b6d77cc78ad18bcb4914c5c639c7ce5ab55e956c461d4310747892b3f50c2.css integrity="sha256-Wittd8x4rRi8tJFMXGOcfOWrVelWxGHUMQdHiSs/UMI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://senmer.github.io/img/Q.gif><link rel=icon type=image/png sizes=16x16 href=https://senmer.github.io/img/Q.gif><link rel=icon type=image/png sizes=32x32 href=https://senmer.github.io/img/Q.gif><link rel=apple-touch-icon href=https://senmer.github.io/img/Q.gif><link rel=mask-icon href=https://senmer.github.io/img/Q.gif><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js></script>
<script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="Nginx核心配置"><meta property="og:description" content="主要介绍Nginx核心配置文件"><meta property="og:type" content="article"><meta property="og:url" content="https://senmer.github.io/posts/tech/nginx/nginx%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-25T14:36:53+00:00"><meta property="article:modified_time" content="2022-07-25T14:36:53+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Nginx核心配置"><meta name=twitter:description content="主要介绍Nginx核心配置文件"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"📚文章","item":"https://senmer.github.io/posts/"},{"@type":"ListItem","position":2,"name":"👨🏻‍💻 技术","item":"https://senmer.github.io/posts/tech/"},{"@type":"ListItem","position":3,"name":"Nginx核心配置","item":"https://senmer.github.io/posts/tech/nginx/nginx%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Nginx核心配置","name":"Nginx核心配置","description":"主要介绍Nginx核心配置文件\n","keywords":["Nginx"],"articleBody":"主要介绍Nginx核心配置文件\n配置文件说明 nginx 官方文档：http://nginx.org/en/docs/\nnginx 配置文件组成： 主配置文件： nginx.conf 子配置文件： conf.d/*.conf fastcgi,， uwsgi，scgi 等协议的相关配置文件 mime.types：支持的mime类型，MIME（Multipurpose Internet Mail Extensions）多用途互联网邮件扩展类型，MIME消息能包含文本、图像、音频、视频以及其他应用程序专用的数据，是设定某种扩展名的文件用指定应用程序来打开的方式类型，当带有某种扩展名的文件被访问的时候，浏览器会自动使用指定应用程序打开（比如：应用程序会被下载，文本文件会直接显示内容）。简单来说，MIME就是利用扩展名标识文件类型，然后根据文件的类型做响应的处理。MIME 参考文档：https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types nginx 配置文件格式说明： 配置文件由指令和指令块构成 每条指令以分号；结束，指令和值之间以空格分隔 多条指令可以放在同一行，以分号分隔。但可读性差，不推荐这样配置 指令块以{ } 括号作为开始和结束的标识，将多条指令组织在一起，且支持嵌套 可通过include引入其他配置文件内容，提升配置文件的可维护性（如子配置文件conf.d/*.conf) 配置文件使用# 作为注释符，使用$引用变量 部分指令的参数支持正则表达式 nginx 主配置文件指令格式： directive value [value1 ...]; 说明： 1、指令必须以分号；结束 2、支持变量： 1）内建变量：由Nginx模块引入，可直接引用 2）自定义变量：由用户使用set指定定义，格式： set variable_name value; 3) 引用变量的方式：$variable_name 主配置文件结构：四部分 main block：主配置段，即全局配置段，对http,mail都有效 #事件驱动相关的配置 event { ... } #http/https 协议相关配置段 http { ... } #默认配置文件不包括下面两个块 #mail 协议相关配置段 mail { ... } #stream 服务器相关配置段 stream { ... } 默认的nginx.conf 配置文件说明\n##全局配置块，对全局生效。主要设置nginx的启动用户/组，启动的工作进程数量，工作模式，nginx的pid文件路径等。 user nginx nginx; worker_processes 1; #启动工作进程的数量，一般与CPU核心数一致 ##events块，主要影响nginx服务器与用户的网络连接，比如是否允许同时接受多个网络连接，使用哪种事件驱动模型，每个工作进程最大支持并发连接数，是否开启对多工作进程下的网络连接进行序列化等。 events { worker_connections 1024; #单个worker进程的最大并发连接数。作为web服务器时，nginx的最大并发数为：worker_connections * worker_processes。作为反向代理的时候为（worker_connections * worker_processes）/2 } ##http块是nginx服务器配置中的重要组成部分，缓存、代理和日志格式定义等绝大多数功能和第三方模块都在这里配置。http块可以包含多个server块，而一个server块又可以包含多个location块，server块可以配置文件引入、MIME-Type定义、日志自定义、是否启用sendfile、连接超时时间和单个链接的请求上限等。 http { include\tmime.types; default_type application/ostet-stream; sendfile\ton; #作为web服务器时打开sendfile加快静态文件传输，指定是否使用sendfile系统调用传输文件。sendfile系统调用在两个文件描述符之间直接传递数据（完全在内核空间进程），从而避免了数据在内核缓冲区和用户缓冲区之间的拷贝，效率很高，是零拷贝技术的一种。 keepalive_timeout 65; #长连接超时时间，单位：秒 ##server块可用于配置虚拟主机，有自己的全局配置，可以包含多个location块。可配置本虚拟机监听的端口，设置虚拟机名称，多个server监听同一个端口。 server { listen 80; #监听端口 server_name;\tlocalhost; #server的域名，配置多个虚拟主机时用到 location / { root\thtml; index\tindex.html index.htm; #网站默认主页 } error_page 500 502 503 504 /50x.html; #错误页面 ##location处理对应的不同错误码的页面定义到50x.html，指示了50.html文件所在目录 location = /50x.html { root\thtml; #错误页面文件所在目录 } } ##和邮件相关的配置 #mail { # ... #} mail 协议相关配置段 #tcp代理配置，1.9版本以上支持 #stream { # ... #} stream 服务器相关配置段 #导入其他路径的配置文件 #include /apps/nginx/conf.d/*.conf } 全局配置 main 全局配置块常见的配置指令分类\n正常运行必备的配置 优化性能相关的配置 用于调试定位问题相关的配置 事件驱动相关的配置 全局配置说明 user\tnginx nginx; #启动nginx工作进程的用户和组 worker_processes [number | auto]; #启动nginx工作进程的数量，一般和CPU核心数相同 worker_cpu_affinity 00000001 00000010 00000100 00001000; #将Nginx工作进程绑定到指定的CPU核心，默认Nginx是不进行进程绑定的，绑定并不是意味着当前nginx进程独占以一核心CPU，但是可以保证此进程不会运行在其他核心上，这就极大减少了nginx的工作进程在不同的cpu核心上的来回跳转，减少了CPU对进程的资源分配与回收以及内存管理等，因此可以有效的提升nginx服务器的性能。 CPU MASK: 00000001：0号CPU 00000010：1号CPU 10000000：7号CPU ##示例: [root@test conf]# egrep \"processes|affinity\" nginx.conf worker_processes 4;\t#启动四个worker进程 worker_cpu_affinity 0001 0010; #将workr进程绑定到 0号CPU和1号CPU [root@test conf]# lscpu | grep CPU\\(s\\) # CPU核数为2 CPU(s): 2 On-line CPU(s) list: 0,1 NUMA node0 CPU(s): 0,1 [root@test conf]# nginx -t #语法检查出现警告，因为worker进程数比CPU核心数多。多出的worker进程将绑定在‘上一个CPU核心‘也即0010上。对于‘上一个CPU核心’（last mask for remaining worker）的解释： processes：nginx分别将worker进程绑定到worker_cpu_affinity 指定的CPU核心上（从左至右的顺序），而从第三个work进程起并未指定对应的CPU核心，因此全部绑定到‘上一个CPU核心’ 0010这个CPU核心。 nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok nginx: [warn] the number of \"worker_processes\" is not equal to the number of \"worker_cpu_affinity\" masks, using last mask for remaining worker processes nginx: configuration file /apps/nginx/conf/nginx.conf test is successful [root@test conf]# ps axo pid,cmd,psr | grep nginx 827 nginx: master process /apps 0 1226 nginx: worker process 0 1227 nginx: worker process 1 1228 nginx: worker process 1 1229 nginx: worker process 1 1249 grep --color=auto nginx 0 #将worker进程数量改为2 [root@test conf]# vim nginx.conf [root@test conf]# egrep \"processes|affinity\" nginx.conf worker_processes 2; worker_cpu_affinity 0001 0010; #语法检查不再警告 [root@test conf]# nginx -s reload [root@test conf]# nginx -t nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok nginx: configuration file /apps/nginx/conf/nginx.conf test is successful [root@test conf]# ps axo pid,cmd,psr | grep nginx 827 nginx: master process /apps 1 1261 nginx: worker process 0 1262 nginx: worker process 1 1265 grep --color=auto nginx 1 #错误日志记录配置，语法：error_log file [debug | info | notice | warn | error | crit | alert | emerg] #括号内为日志记录详细级别（从左至右逐渐提高） ##示例配置 #error_log logs/error.log; #error_log logs/error.log notice; error_log /apps/nginx/logs/error.log error; #pid文件保存路径 pid /apps/nginx/logs/nginx.pid; worker_priority 0; #工作进程优先级，-20~20(19) worker_rlimit_nofile 65536; #所有worker进程能打开的文件数量上限,包括:Nginx的所有连接（例如与代理服务器的连接等），而不仅仅是与客户端的连接。该值最好与ulimit -n 或者limits.conf的值保持一致, #通过pam限制文件打开数量上限 [root@centos8 ~]#cat /etc/security/limits.conf * soft nofile 1000000 * hard nofile 1000000 #worker进程优先级 [root@test conf]# grep priority nginx.conf worker_priority 0; [root@test conf]# ps -axo pid,cmd,nice | grep nginx 827 nginx: master process /apps 0 1391 nginx: worker process 0 1392 nginx: worker process 0 1449 grep --color=auto nginx 0 daemon off; #前台运行Nginx服务，通常在测试环境或者docker环境中使用 master_process off|on; #是否开启Nginx的master-worker工作模式，仅用于开发调试场景,默认为on events { worker_connections 65536; #设置单个工作进程的最大并发连接数 use epoll; #使用epoll事件驱动，Nginx支持众多的事件驱动，比如:select、poll、epoll，只能设置在events模块中设置。 accept_mutex on; #on为同一时刻一个请求轮流由work进程处理,而防止被同时唤醒所有worker,避免多个睡眠进程被唤醒的设置，默认为off，新请求会唤醒所有worker进程,此过程也称为\"惊群\"，因此nginx刚安装完以后要进行适当的优化。建议设置为on multi_accept on; #on时Nginx服务器的每个工作进程可以同时接受多个新的网络连接，此指令默认为off，即默认为一个工作进程只能一次接受一个新的网络连接，打开后几个同时接受多个。建议设置为on } 范例：实现nginx的高并发配置\n[root@localhost conf]# ulimit -n 10 [root@localhost conf]# cat /apps/nginx/conf/nginx.conf | grep rlimit worker_rlimit_nofile 100; #默认配置不支持高并发，当worker_rlimit_nofile设置的值大于ulimit -n的值,会出现以下错误日志 [root@localhost conf]# ab -c 5000 -n 10000 http://127.0.0.1/ This is ApacheBench, Version 2.3 \u003c$Revision: 1430300 $\u003e Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/ Licensed to The Apache Software Foundation, http://www.apache.org/ Benchmarking 127.0.0.1 (be patient) socket: Too many open files (24) #打开的文件描述符过多 http 配置块 http 协议相关的配置结构\nhttp { ... ... server { #每个server用于定义一个虚拟主机,第一个server为默认虚拟服务器 ... } server { ... server_name #虚拟主机名 root #主目录 alias #路径别名 location [OPERATOR] URL { #指定URL的特性 ... if CONDITION { ... } } } } http 协议配置说明\nhttp { include mime.types; #导入支持的文件类型,是相对于/apps/nginx/conf目录 default_type application/octet-stream; #除mime.types中文件类型外,设置其它文件默认类型，访问其它类型时会提示下载不匹配的类型文件 #日志配置部分 #log_format main '$remote_addr - $remote_user [$time_local] \"$request\" ' # '$status $body_bytes_sent \"$http_referer\" ' # '\"$http_user_agent\" \"$http_x_forwarded_for\"'; #access_log logs/access.log main; #自定义优化参数 sendfile on; #tcp_nopush on; #在开启了sendfile的情况下，合并请求后统一发送给客户端,必须开启sendfile #tcp_nodelay off; #在开启了keepalived模式下的连接是否启用TCP_NODELAY选项，当为off时，延迟0.2s发送，默认On时，不延迟发送，立即发送用户响应报文。 #keepalive_timeout 0; keepalive_timeout 65 66; #设置会话保持时间,第二个值为响应首部:keep-Alived:timeout=65,可以和第一个值不同 #gzip on; #开启文件压缩 server { listen 80; #设置监听地址和端口 server_name localhost; #设置server name，可以以空格隔开写多个并支持正则表达式，如:*.magedu.com www.magedu.* ~^www\\d+\\.magedu\\.com$ default_server #charset koi8-r; #设置编码格式，默认是俄语格式，建议改为utf-8 #access_log logs/host.access.log main; location / { root html; index index.html index.htm; } #error_page 404 /404.html; # redirect server error pages to the static page /50x.html # error_page 500 502 503 504 /50x.html; #定义错误页面 location = /50x.html { root html; } # proxy the PHP scripts to Apache listening on 127.0.0.1:80 # #location ~ \\.php$ { #以http的方式转发php请求到指定web服务器 # proxy_pass http://127.0.0.1; #} # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000 # #location ~ \\.php$ { #以fastcgi的方式转发php请求到php处理 # root html; # fastcgi_pass 127.0.0.1:9000; # fastcgi_index index.php; # fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name; # include fastcgi_params; #} # deny access to .htaccess files, if Apache's document root # concurs with nginx's one # #location ~ /\\.ht { #拒绝web形式访问指定文件，如很多的网站都是通过.htaccess文件来改变自己的重定向等功能。 # deny all; #} location ~ /passwd.html { deny all; } } # another virtual host using mix of IP-, name-, and port-based configuration # #server { #自定义虚拟server # listen 8000; # listen somename:8080; # server_name somename alias another.alias; # location / { # root html; # index index.html index.htm; #指定默认网页文件，此指令由ngx_http_index_module模块提供 # } #} # HTTPS server # #server { #https服务器配置 # listen 443 ssl; # server_name localhost; # ssl_certificate cert.pem; # ssl_certificate_key cert.key; # ssl_session_cache shared:SSL:1m; # ssl_session_timeout 5m; # ssl_ciphers HIGH:!aNULL:!MD5; # ssl_prefer_server_ciphers on; # location / { # root html; # index index.html index.htm; # } #} MIME MIME参考文档： https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types\n#在响应报文中将指定的文件扩展名映射至MIME对应的类型 include mime.types; default_type application/octet-stream;#除mime.types中的类型外，指定其它文件的默认MIME类型，浏览器一般会提示下载 types { text/html html; image/gif gif; image/jpeg jpg; } 范例：\n#未定义mime.types类型 [root@localhost nginx]# ll html/mime.types ls: cannot access html/mime.types: No such file or directory [root@localhost nginx]# curl localhost/test.php -I HTTP/1.1 200 OK Server: nginx/1.18.0 Date: Thu, 28 Jul 2022 11:23:54 GMT Content-Type: application/octet-stream #mime未定义的类型默认视为二进制文件处理（如果是浏览器访问，则会下载test.php文件） Content-Length: 20 Last-Modified: Thu, 28 Jul 2022 11:19:48 GMT Connection: keep-alive Keep-Alive: timeout=66 #长连接显示的时长，由keepalive_timeout 65 66; 配置 ETag: \"62e270d4-14\" Accept-Ranges: bytes #修改默认文件类型 [root@localhost nginx]# cat conf/nginx.conf | grep default_type default_type text/html; [root@localhost nginx]# nginx -s reload [root@localhost nginx]# curl localhost/test.php -I HTTP/1.1 200 OK Server: nginx/1.18.0 Date: Thu, 28 Jul 2022 11:32:15 GMT Content-Type: text/html #将test.php识别为文本文件（如果是浏览器访问，直接显示文件内容） Content-Length: 20 Last-Modified: Thu, 28 Jul 2022 11:19:48 GMT Connection: keep-alive Keep-Alive: timeout=66 ETag: \"62e270d4-14\" Accept-Ranges: bytes 指定响应报文 #是否在响应报文中的Content-Type显示指定的字符集，默认off不显示 charset charset | off; #示例 charset utf-8; #是否在响应报文的Server首部显示nginx版本 server_tokens on | off | build | string; 范例：源码修改server字段\n#如果想自定义响应报文的nginx版本信息，需要修改源码文件，重新编译 #如果server_tokens on，修改 src/core/nginx.h 修改第13-14行，如下示例 #define NGINX_VERSION \"1.68.9\" #define NGINX_VER \"mynginx/\" NGINX_VERSION #如果server_tokens off，修改 src/http/ngx_http_header_filter_module.c 第49行，如下示例： static char ngx_http_server_string[] = \"Server: nginx\" CRLF; #把其中的nginx改为自己想要的文字即可,如：mynginx 核心配置示例 虚拟主机的实现 基于不同的IP、不同的端口以及不用域名实现不同的虚拟主机，依赖于核心模块ngx_http_core_module实现。\n新建两个虚拟主机 # 添加域名解析 [root@localhost conf.d]# cat /etc/hosts |grep test 172.16.16.88 pc.test.org mobile.test.org ## 开始新建虚拟主机 root@localhost nginx]# mkdir /apps/nginx/conf/conf.d [root@localhost nginx]# cd /apps/nginx/conf/conf.d/ [root@localhost conf.d]# vim /apps/nginx/conf/nginx.conf ...... include /apps/nginx/conf.d/*.conf; #在配置文件的最后面添加此行,注意不要放在最前面,会导致前面的配置无法生效（文件配置从上到下依次生效） [root@localhost conf.d]# cat pc.conf server { listen 80; server_name pc.test.org; location / { root html/pc; } } [root@localhost conf.d]# mkdir /apps/nginx/html/pc [root@localhost conf.d]# echo pc_page \u003e /apps/nginx/html/pc/index.html [root@localhost conf.d]# nginx -s reload [root@localhost conf.d]# curl pc.test.org #虚拟主机pc pc_page [root@localhost conf.d]# cat mobile.conf server { listen 80; server_name mobile.test.org; location / { root html/mobile; } } [root@localhost conf.d]# mkdir /apps/nginx/html/mobile #虚拟主机mobile [root@localhost conf.d]# echo mobile_page \u003e /apps/nginx/html/mobile/index.html mobile_page root 与 alias 的区别 root：指定web的家目录，在定义location的时候，文件的绝对路径等于 root+location\n范例:\n[root@localhost conf.d]# cat pc.conf server { listen 80; server_name pc.test.org; location / { root html/pc; } location /about { root /opt/html; #实际路径为/opt/html/about/index.html } } [root@localhost conf.d]# ll /opt/html/about/ total 4 -rw-r--r-- 1 root root 11 Jul 28 23:24 index.html [root@localhost conf.d]# cat /opt/html/about/index.html about_page [root@localhost conf.d]# nginx -s reload [root@localhost conf.d]# curl pc.test.org/about/ about_page alias：定义路径别名，会把访问的路径重新定义到其指定的路径,文档映射的另一种机制;仅能用于location上下文,此指令使用较少\n范例：\n[root@localhost conf.d]# cat pc.conf server { listen 80; server_name pc.test.org; location / { root html/pc; } location /about { alias /opt/html; #实际路径为/opt/html/index.html } } [root@localhost conf.d]# cat /opt/html/index.html about_page [root@localhost conf.d]# nginx -s reload [root@localhost conf.d]# curl pc.test.org/about/ about_page localtion 的匹配规则 在一个server中location配置段可存在多个，用于实现从uri到文件系统的路径映射；ngnix会根据用户请\n求的URI来检查定义的所有location，按一定的优先级找出一个最佳匹配，而后进行处理。\nlocation 官方帮助: http://nginx.org/en/docs/http/ngx_http_core_module.html#location\n#语法规则： location [ = | ~ | ~* | ^~ ] uri { ... } = #用于标准uri前，需要请求字串与uri精确匹配，大小敏感,如果匹配成功就停止向下匹配并立即处理请求 ^~ #用于标准uri前，表示包含正则表达式,并且匹配以指定的正则表达式开头,对URI的最左边部分做匹配检查，不区分字符大小写 ~ #用于标准uri前，表示包含正则表达式,并且区分大小写 ~* #用于标准uri前，表示包含正则表达式,并且不区分大小写 不带符号 #匹配起始于此uri的所有的uri \\ #用于标准uri前，表示包含正则表达式并且转义字符。可以将 . * ?等转义为普通符号 #匹配优先级从高到低： =, ^~, ~/~*, 不带符号 官方范例\nlocation = / { [ configuration A ] } location / { [ configuration B ] } location /documents/ { [ configuration C ] } location ^~ /images/ { [ configuration D ] } location ~* \\.(gif|jpg|jpeg)$ { [ configuration E ] } The “/” request will match configuration A(?), the “/index.html” request will match configuration B, the “/documents/document.html” request will match configuration C, the “/images/1.gif” request will match configuration D, and the “/documents/1.jpg” request will match configuration E. 匹配案例-精确匹配 在server部分使用location配置一个web界面，例如：当访问nginx服务器的/logo.jpg的时候要显示指定html文件的内容\n精确匹配一般用于匹配网站logo等相对固定的URL\n范例：精确匹配\n[root@localhost images]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; location / { root html/pc; } location /logo.jpg { root html/images; } } [root@localhost images]# ll /apps/nginx/html/images/logo.jpg -rw-r--r-- 1 root root 13110 Jul 29 15:11 /apps/nginx/html/images/logo.jpg #访问成功 [root@localhost images]# curl pc.test.org/logo.jpg -I HTTP/1.1 200 OK Server: nginx/1.18.0 Date: Fri, 29 Jul 2022 15:17:35 GMT Content-Type: image/jpeg Content-Length: 13110 Last-Modified: Fri, 29 Jul 2022 07:11:49 GMT Connection: keep-alive Keep-Alive: timeout=66 ETag: \"62e38835-3336\" Accept-Ranges: bytes 匹配案例-区分大小写 ~ 实现区分大小写的模糊匹配\n[root@localhost images]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; location / { root html/pc; } location ~ /A.?\\.jpg { #匹配字母A开头的jpg图片，后面?表示A后面零次或一个字符 root html/images; } } #确保资源存在 [root@localhost images]# ll /apps/nginx/html/images/A.jpg -rw-r--r-- 1 root root 13110 Jul 29 15:11 /apps/nginx/html/images/A.jpg [root@localhost images]# nginx -s reload #以大写URI访问成功 [root@localhost images]# curl -I pc.test.org/A.jpg HTTP/1.1 200 OK Server: nginx/1.18.0 Date: Fri, 29 Jul 2022 15:27:52 GMT Content-Type: image/jpeg Content-Length: 13110 Last-Modified: Fri, 29 Jul 2022 07:11:49 GMT Connection: keep-alive Keep-Alive: timeout=66 ETag: \"62e38835-3336\" Accept-Ranges: bytes #以小写URI访问失败 [root@localhost images]# curl -I pc.test.org/a.jpg HTTP/1.1 404 Not Found Server: nginx/1.18.0 Date: Fri, 29 Jul 2022 15:27:55 GMT Content-Type: text/html Content-Length: 153 Connection: keep-alive Keep-Alive: timeout=66 匹配案例-不区分大小写 ~* 用来对用户请求的uri做模糊匹配。\n注意：尽管匹配时不区分大小写，但实际请求是仍会以用户请求的uri去寻找相应的磁盘文件，如用户访问uri为/A.jpg，在location条件通过后就在对应路径下寻找磁盘中的A.jpg文件，如果磁盘上是a.jpg，则请求是失败的（在window系统中，文件名不区分大小写，该请求会成功——受文件系统影响）。\n[root@localhost images]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; location / { root html/pc; } location ~* /A.?\\.jpg { #匹配规则不区分大小写 root html/images; } } [root@localhost images]# ll /apps/nginx/html/images/a.jpg #磁盘中仅存在a.jpg文件 -rw-r--r-- 1 root root 13110 Jul 29 15:11 /apps/nginx/html/images/a.jpg [root@localhost images]# nginx -s reload #访问/a.jpg成功 [root@localhost images]# curl -I pc.test.org/a.jpg HTTP/1.1 200 OK Server: nginx/1.18.0 Date: Fri, 29 Jul 2022 15:41:25 GMT Content-Type: image/jpeg Content-Length: 13110 Last-Modified: Fri, 29 Jul 2022 07:11:49 GMT Connection: keep-alive Keep-Alive: timeout=66 ETag: \"62e38835-3336\" Accept-Ranges: bytes #访问/A.jpg失败。location匹配成功，但磁盘上并无A.jpg文件 [root@localhost images]# curl -I pc.test.org/A.jpg HTTP/1.1 404 Not Found Server: nginx/1.18.0 Date: Fri, 29 Jul 2022 15:41:48 GMT Content-Type: text/html Content-Length: 153 Connection: keep-alive Keep-Alive: timeout=66 nginx 四层访问控制 访问控制基于模块ngx_http_access_module实现，可以通过匹配客户端源IP地址进行限制\n注意: 如果能在防火墙设备控制, 最好就不要在nginx上配置,可以更好的节约资源\n官方帮助: http://nginx.org/en/docs/http/ngx_http_access_module.html\n范例：\n## 匹配时按从上至下的规则进行匹配，匹配到相应规则即停止———与防火墙的匹配规则类似 #如：有客户端（IP：10.1.1.0）访问配置了以下规则的web服务器时(访问URI:/about)，触发location /about语句块，匹配到allow 10.1.1.0/16，访问控制生效，访问成功。 location = /login/ { root /data/nginx/html/pc; allow 10.0.0.0/24; deny all; } location /about { alias /data/nginx/html/pc; index index.html; deny 192.168.1.1; allow 192.168.1.0/24; allow 10.1.1.0/16; allow 2001:0db8::/32; deny all; #按先小范围到大范围排序 } nginx 账户认证功能 由 ngx_http_auth_basic_module 模块提供此功能\n官方帮助：http://nginx.org/en/docs/http/ngx_http_auth_basic_module.html\n范例：\n#CentOS安装包 [root@centos8 ~]#yum -y install httpd-tools #Ubuntu安装包 [root@Ubuntu ~]#apt -y install apache2-utils #创建用户 #-b 非交互式方式提交密码 #-c 重新生成文件，覆盖已有文件。首次创建时使用 [root@localhost html]# htpasswd -bc /apps/nginx/conf/.htpasswd user1 passwd1 Adding password for user user1 [root@localhost html]# htpasswd -b /apps/nginx/conf/.htpasswd user2 passwd2 Adding password for user user2 #生成了带有两个用户的验证文件 [root@localhost html]# tail /apps/nginx/conf/.htpasswd user1:$apr1$vzRe30iJ$jF8BZbra6pI8O0JBqlmiP/ user2:$apr1$i2ON7LYs$pxzkeH.xxCdgj670m5cSW/ #网站登录页面配置 [root@localhost html]# cat /apps/nginx/html/index.html hello [root@localhost html]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; location /login { alias html/; index index.html; auth_basic \"login password\"; #指定提示文本信息 auth_basic_user_file /apps/nginx/conf/.htpasswd; #指定使用的验证文件 } } #直接访问登录页，失败。未通过验证 [root@localhost html]# curl pc.test.org/login/ 401 Authorization Required 401 Authorization Required nginx/1.18.0 ##分别使用两种方式输入用户名和密码验证 [root@localhost html]# curl http://user1:passwd1@pc.test.org/login/ hello [root@localhost html]# curl -u user2:passwd2 pc.test.org/login/ hello 自定义错误页面 自定义错误页，同时也可以用指定的响应状态码进行响应, 可在如下语句块配置：http, server, location, if in\nlocation\n格式：\nerror_page code ... [=[response]] uri; 范例：\n# 准备站点配置 [root@localhost html]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; error_page 404 400 /error.html; #访问不存在的页面，发生404错误，返回error.html错误页面 location /error.html { root html/; } } #准备错误页面 [root@localhost html]# cat /apps/nginx/html/error.html error-page [root@localhost html]# nginx -s reload #访问不存在的页面，触发404报错 [root@localhost html]# curl -I pc.test.org/dd HTTP/1.1 404 Not Found #查看错误码 Server: nginx/1.18.0 Date: Fri, 29 Jul 2022 17:02:12 GMT Content-Type: text/html Content-Length: 11 Connection: keep-alive Keep-Alive: timeout=66 ETag: \"62e411d9-b\" #触发404错误，返回错误页面（如果是浏览器测试，建议用google） [root@localhost html]# curl pc.test.org/dd error-page 范例：如果发生404 ，将错误码定义为502，且跳转到主页/index.html\n#站点配置 [root@localhost html]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; error_page 404 =502 /index.html; location /index.html { root html/; } } #主页配置 [root@localhost html]# cat /apps/nginx/html/index.html hello [root@localhost html]# nginx -s reload [root@localhost html]# curl pc.test.org/dd/ hello #验证错误码 [root@localhost html]# curl pc.test.org/dd/ -I HTTP/1.1 502 Bad Gateway #错误码为自定义的502 Server: nginx/1.18.0 Date: Fri, 29 Jul 2022 17:31:49 GMT Content-Type: text/html Content-Length: 6 Connection: keep-alive Keep-Alive: timeout=66 ETag: \"62e40fa4-6\" #重定向成功 [root@localhost html]# cat /apps/nginx/html/index.html hello 自定义错误日志 错误日志格式\nSyntax: error_log file [level]; #格式 Default: #默认值 error_log logs/error.log error; Context: main, http, mail, stream, server, location #可配置的语句块 level: debug, info, notice, warn, error, crit, alert, emerg #日志记录等级 范例：\n#站点配置 [root@localhost html]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; error_page 404 400 /error.html; access_log /apps/nginx/logs/test-access.log; #自定义正常访问日志 error_log /apps/nginx/logs/test-error.log; #自定义错误日志 location /error.html { root html/; } } #当前已有日志文件 [root@localhost html]# ls /apps/nginx/logs/ access.log error.log nginx.pid #重启nginx后生成自定义的错误日志 [root@localhost html]# nginx -s reload [root@localhost html]# ls /apps/nginx/logs/ access.log error.log nginx.pid test-access.log test-error.log #访问站点 [root@localhost html]# curl pc.test.org hello #日志成功记录 [root@localhost html]# tail /apps/nginx/logs/{test-access,test-error}.log ==\u003e /apps/nginx/logs/test-access.log \u003c== 172.16.16.88 - - [30/Jul/2022:01:17:55 +0800] \"GET / HTTP/1.1\" 200 6 \"-\" \"curl/7.29.0\" ==\u003e /apps/nginx/logs/test-error.log \u003c== 检测文件是否存在 try_files会按顺序检查文件是否存在，返回第一个找到的文件或文件夹（结尾加斜线表示为文件夹），如\n果所有文件或文件夹都找不到，会进行一个内部重定向到最后一个参数。只有最后一个参数可以引起一\n个内部重定向，之前的参数只设置内部URI的指向。最后一个参数是回退URI且必须存在，否则会出现内\n部500错误。\nSyntax: try_files file ... uri; try_files file ... =code; Default: — Context: server, location 范例: 如果不存在页面, 就转到default.html页面\n#准备站点配置 [root@localhost html]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; location / { root html/; index index.html; try_files $uri $uri.html $uri/index.html /about/default.html; } } #准备默认页面 [root@localhost html]# cat /apps/nginx/html/default.html default #访问测试 [root@localhost ~]# cat /apps/nginx/html/about/default.html about_page [root@localhost ~]# curl pc.test.org/xx/ about_page [root@localhost ~]# curl pc.test.org/xx.html about_page ##自定义响应码 [root@localhost ~]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; location / { root html/; index index.html; try_files $uri $uri.html $uri/index.html =555; #自定义响应码为555 } } #验证结果 [root@localhost ~]# curl pc.test.org/xx.html -I HTTP/1.1 555 #响应码为555 Server: nginx/1.18.0 Date: Mon, 01 Aug 2022 10:00:03 GMT Content-Length: 0 Connection: keep-alive Keep-Alive: timeout=66 长连接配置 keepalive_timeout timeout [header_timeout]; #设定保持连接超时时长，0表示禁止长连接，默认为75s，通常配置在http字段作为站点全局配置 keepalive_requests number; #在一次长连接上所允许请求的资源的最大数量，默认为100次,建议适 当调大,比如:500 范例：\n#站点主配置项 [root@localhost ~]# cat /apps/nginx/conf/nginx.conf | grep keepalive keepalive_requests 3; keepalive_timeout 65 60; [root@localhost ~]# cat /apps/nginx/html/index.html hello #长连接测试 [root@localhost ~]# telnet localhost 80 Trying ::1... telnet: connect to address ::1: Connection refused Trying 127.0.0.1... Connected to localhost. Escape character is '^]'. GET / HTTP/1.1 #发起get请求，重复三次或者时间到达65秒后，本次链接自动终止 HOST: localhost #域名为localhost HTTP/1.1 200 OK Server: nginx/1.18.0 Date: Mon, 01 Aug 2022 11:03:09 GMT Content-Type: text/html Content-Length: 6 Last-Modified: Fri, 29 Jul 2022 16:49:40 GMT Connection: keep-alive Keep-Alive: timeout=60 #显示的超时时间 ETag: \"62e40fa4-6\" Accept-Ranges: bytes hello #返回的页面内容 作为下载服务器 ngx_http_autoindex_module 模块处理以斜杠字符 “/” 结尾的请求，并生成目录列表,可以做为下载服务\n配置使用\n官方链接：http://nginx.org/en/docs/http/ngx_http_autoindex_module.html\n相关指令\nautoindex on | off; #自动文件索引功能，默为off autoindex_exact_size on | off; #计算文件精确大小（单位bytes），off 显示大概大小（单位K、M)，默认on autoindex_localtime on | off ; #显示本机时间而非GMT(格林威治)时间，默认off autoindex_format html | xml | json | jsonp; #显示索引的页面文件风格，默认html limit_rate rate; #限制响应客户端传输速率(除GET和HEAD以外的所有方法)，单位B/s,即bytes/second，默认值0,表示无限制,此指令由ngx_http_core_module提供 set $limit_rate 4k; #也可以通变量限速,单位B/s,同时设置,此项优级高于limit_rate ###Rate limit can also be set in the $limit_rate variable, however, since version 1.17.0, this method is not recommended: 范例：将nginx作为下载服务器\n#注意:download不需要index.html文件 [root@centos8 ~]# mkdir -p /data/nginx/html/pc/download [root@localhost ~]# touch /apps/nginx/html/download/{t1,t2,t3}.txt [root@localhost ~]# mkdir /apps/nginx/html/download/{d1,d2,d3} [root@localhost ~]# tree /apps/nginx/html/download /apps/nginx/html/download ├── d1 ├── d2 ├── d3 ├── t1.txt ├── t2.txt └── t3.txt 3 directories, 3 files [root@centos8 ~]# cat /apps/nginx/conf.d/pc.conf location /download { autoindex on; #自动索引功能 autoindex_exact_size off; #计算文件确切大小（单位bytes），此为默认值,off只显示大概大 小（单位kb、mb、gb） autoindex_localtime off; #on表示显示本机时间而非GMT(格林威治)时间,默为为off显示GMT 时间 limit_rate 1024k; #限速,默认不限速 root html/; } 结果验证\n作为上传服务器 相关指令\nclient_max_body_size 1m; #设置允许客户端上传单个文件大小的上限值，默认值为1m,上传文件超过此值会出413错误 client_body_buffer_size size; #用于接收每个客户端请求报文的body部分的缓冲区大小;默认16k;超出此大小时，其将被暂存到磁盘上的由client_body_temp_path指令所定义的位置 client_body_temp_path path [level1 [level2 [level3]]]; #设定存储客户端请求报文的body部分的临时存储路径及子目录结构和数量，目录名为16进制的数字，使用hash之后的值从后往前截取1位、2位、2位作为目录名 [root@centos8 ~]# md5sum /data/nginx/html/pc/index.html 95f6f65f498c74938064851b1bb 96 3d 4 /data/nginx/html/pc/index.html 1级目录占1位16进制，即2^4=16个目录 0-f 2级目录占2位16进制，即2^8=256个目录 00-ff 3级目录占2位16进制，即2^8=256个目录 00-ff #配置示例： client_max_body_size 100m; #如果太大，上传时会出现413错误。注意:如果php上传（如WordPress）,还需要修改/etc/php.ini的相关配置 client_body_buffer_size 1024k; client_body_temp_path /apps/nginx/client_body_temp/ 1 2 2; #上传时,Nginx会自动创建相关目录 ##上传文件后,会自动生成相关目录 [root@wang-liyun-pc ~]# tree /apps/nginx/client_body_temp/ /apps/nginx/client_body_temp/ ├── 5 │ └── 00 │ └── 00 └── 6 └── 00 └── 00 其他配置 keepalive_disable none | browser ...; #对哪种浏览器禁用长连接 limit_except method ... { ... } #仅用于location语句块，禁止客户端使用除了指定的请求方法之外的其它方法, 如果使用会出现403错误 method:GET, HEAD, POST, PUT, DELETE，MKCOL, COPY, MOVE, OPTIONS, PROPFIND, PROPPATCH, LOCK, UNLOCK, PATCH ##示例：除了GET之外的其它方法仅允许172.16.16.0/24网段主机使用 [root@localhost ~]# hostname -I #本机IP 172.16.16.88 [root@localhost ~]# ll /apps/nginx/html/upload/ #新建upload目录用于存储上传的文件 total 0 [root@localhost ~]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; location /upload { root html/; index index.html; limit_except GET { allow 172.16.16.88; deny all; } } } [root@localhost ~]# nginx -s reload [root@localhost ~]# curl -XPUT /etc/issue pc.test.org/upload curl: (3) malformed 405 Not Allowed #PUT方法具有访问权限，但是程序本身不支持文件上传功能 405 Not Allowed nginx/1.18.0 [root@localhost ~]# cat /apps/nginx/conf.d/pc.conf server { listen 80; server_name pc.test.org; location /upload { root html/; index index.html; limit_except GET { #allow 172.16.16.88; #禁止所有主机使用GET以外的方法 deny all; } } } [root@localhost ~]# curl -XPUT /etc/issue pc.test.org/upload curl: (3) malformed 403 Forbidden #再次访问测试，nginx拒绝访问 403 Forbidden nginx/1.18.0 aio on | off #是否启用asynchronous file I/O(AIO)功能，需要编译时添加参数开启 --with-file-aio #linux 2.6以上内核提供以下几个系统调用来支持aio： 1、SYS_io_setup：建立aio 的context 2、SYS_io_submit: 提交I/O操作请求 3、SYS_io_getevents：获取已完成的I/O事件 4、SYS_io_cancel：取消I/O操作请求 5、SYS_io_destroy：毁销aio的context directio size | off; #操作完全和aio相反，aio是读取文件而directio是写文件到磁盘，默认为关闭，当文件大于等于给定大小时，例如:directio 4m，同步（直接）写磁盘，而非写缓存。 open_file_cache off; #是否缓存打开过的文件信息 open_file_cache max=N [inactive=time]; #nginx可以缓存以下三种信息： (1) 文件元数据：文件的描述符、文件大小和最近一次的修改时间 (2) 打开的目录结构 (3) 没有找到的或者没有权限访问的文件的相关信息 max=N：#可缓存的缓存项上限数量;达到上限后会使用LRU(Least recently used，最近最少使用)算法实现管理 inactive=time：#缓存项的非活动时长，在此处指定的时长内未被命中的或命中的次数少于 open_file_cache_min_uses #指令所指定的次数的缓存项即为非活动项，将被删除 open_file_cache_valid time; #缓存项有效性的检查验证频率，默认值为60s open_file_cache_errors on | off; #是否缓存查找时发生错误的文件一类的信息,默认值为off open_file_cache_min_uses number; #open_file_cache指令的inactive参数指定的时长内，至少被命中此处指定的次数方可被归类为活动项,默认值为1 范例：\nopen_file_cache max=10000 inactive=60s; #最大缓存10000个文件，非活动数据超时时长60s open_file_cache_valid 60s; #每间隔60s检查一下缓存数据有效性 open_file_cache_min_uses 5; #60秒内至少被命中访问5次才被标记为活动数据 open_file_cache_errors on; #缓存错误信息 ","wordCount":"10564","inLanguage":"zh","datePublished":"2022-07-25T14:36:53Z","dateModified":"2022-07-25T14:36:53Z","author":{"@type":"Person","name":"nier"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://senmer.github.io/posts/tech/nginx/nginx%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE/"},"publisher":{"@type":"Organization","name":"WZ's Blog","logo":{"@type":"ImageObject","url":"https://senmer.github.io/img/Q.gif"}}}</script></head><body id=top><script>(function(){let e,t=new RegExp("(^| )change-themes=([^;]*)(;|$)");(e=document.cookie.match(t))||((new Date).getHours()>=19||(new Date).getHours()<6?(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark")):(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")))})(),localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?4d7c4710a089d70b71310f0e1ec7681b",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><a href=https://senmer.github.io/ accesskey=h title="WZ's Blog (Alt + H)"><img src=https://senmer.github.io/img/Q.gif alt=logo aria-label=logo height=35>WZ's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://senmer.github.io/search title="🔍 搜索 (Alt + /)" accesskey=/><span>🔍 搜索</span></a></li><li><a href=https://senmer.github.io/ title="🏠 主页"><span>🏠 主页</span></a></li><li><a href=https://senmer.github.io/posts/tech title="📚 文章"><span>📚 文章</span></a></li><li><a href=https://senmer.github.io/categories/ title="🧩 分类"><span>🧩 分类</span></a></li><li><a href=https://senmer.github.io/archives/ title="⏱️ 时间轴"><span>⏱️ 时间轴</span></a></li><li><a href=https://senmer.github.io/about title="🙋🏻‍♂️ 关于"><span>🙋🏻‍♂️ 关于</span></a></li><li><a href=https://senmer.github.io/links title="🤝 友链"><span>🤝 友链</span></a></li></ul></nav></header><main class="main page"><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}</style><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://senmer.github.io/>🏠 主页</a>&nbsp;»&nbsp;<a href=https://senmer.github.io/posts/>📚文章</a>&nbsp;»&nbsp;<a href=https://senmer.github.io/posts/tech/>👨🏻‍💻 技术</a></div><h1 class=post-title>Nginx核心配置</h1><div class=post-meta><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}.parent-post-meta{display:flex;flex-wrap:wrap;opacity:.8}</style><span class=parent-post-meta><span id=post_meta_style_1><span class="fa fa-calendar-check-o"></span>
<span>2022-07-25
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_3><span class="fa fa-file-word-o"></span>
<span>10564字
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_4><span class="fa fa-clock-o"></span>
<span>22分钟
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_5><span class="fa fa-user-o"></span>
<span>nier
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_6><span class="fa fa-tags" style=opacity:.8></span>
<span><span class=post-tags-meta><a href=https://senmer.github.io/tags/nginx/ style=color:var(--secondary)!important>Nginx</a></span></span></span></span>
<span style=opacity:.8><span id=post_meta_style_7>&nbsp;&nbsp;
<span class="fa fa-eye"></span>
<span><span id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv></span></span>
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_8><span class="fa fa-commenting-o"></span>
<span><script src=https://cdn.staticfile.org/twikoo/1.6.16/twikoo.all.min.js></script>
<script>let url=document.documentURI,dnsUrl="https://senmer.github.io/",urlSplit=url.split(dnsUrl),finalUrl=urlSplit[1];finalUrl[0]!=="/"&&(finalUrl="/"+finalUrl),twikoo.getCommentsCount({envId:"https://hugo-api-khaki.vercel.app/# 填写自己的twikoo id",region:null,urls:[finalUrl],includeReply:!1}).then(function(e){let t=e[0].count;const n=document.getElementById("comment_count");n.innerText=t}).catch(function(e){console.error(e)})</script><span id=comment_count></span></span></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e8%af%b4%e6%98%8e aria-label=配置文件说明>配置文件说明</a><ul><li><a href=#nginx-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e7%bb%84%e6%88%90 aria-label="nginx 配置文件组成：">nginx 配置文件组成：</a></li><li><a href=#nginx-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e6%a0%bc%e5%bc%8f%e8%af%b4%e6%98%8e aria-label="nginx 配置文件格式说明：">nginx 配置文件格式说明：</a></li><li><a href=#nginx-%e4%b8%bb%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e6%8c%87%e4%bb%a4%e6%a0%bc%e5%bc%8f aria-label="nginx 主配置文件指令格式：">nginx 主配置文件指令格式：</a></li><li><a href=#%e4%b8%bb%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e7%bb%93%e6%9e%84%e5%9b%9b%e9%83%a8%e5%88%86 aria-label=主配置文件结构：四部分>主配置文件结构：四部分</a></li></ul></li><li><a href=#%e5%85%a8%e5%b1%80%e9%85%8d%e7%bd%ae aria-label=全局配置>全局配置</a><ul><li><a href=#%e5%85%a8%e5%b1%80%e9%85%8d%e7%bd%ae%e8%af%b4%e6%98%8e aria-label=全局配置说明>全局配置说明</a></li></ul></li><li><a href=#http-%e9%85%8d%e7%bd%ae%e5%9d%97 aria-label="http 配置块">http 配置块</a><ul><ul><li><a href=#mime aria-label=MIME>MIME</a></li><li><a href=#%e6%8c%87%e5%ae%9a%e5%93%8d%e5%ba%94%e6%8a%a5%e6%96%87 aria-label=指定响应报文>指定响应报文</a></li></ul></ul></li><li><a href=#%e6%a0%b8%e5%bf%83%e9%85%8d%e7%bd%ae%e7%a4%ba%e4%be%8b aria-label=核心配置示例>核心配置示例</a><ul><ul><li><a href=#%e8%99%9a%e6%8b%9f%e4%b8%bb%e6%9c%ba%e7%9a%84%e5%ae%9e%e7%8e%b0 aria-label=虚拟主机的实现>虚拟主机的实现</a><ul><li><a href=#%e6%96%b0%e5%bb%ba%e4%b8%a4%e4%b8%aa%e8%99%9a%e6%8b%9f%e4%b8%bb%e6%9c%ba aria-label=新建两个虚拟主机>新建两个虚拟主机</a></li><li><a href=#root-%e4%b8%8e-alias-%e7%9a%84%e5%8c%ba%e5%88%ab aria-label="root 与 alias 的区别">root 与 alias 的区别</a></li></ul></li><li><a href=#localtion-%e7%9a%84%e5%8c%b9%e9%85%8d%e8%a7%84%e5%88%99 aria-label="localtion 的匹配规则">localtion 的匹配规则</a></li><li><a href=#%e5%8c%b9%e9%85%8d%e6%a1%88%e4%be%8b-%e7%b2%be%e7%a1%ae%e5%8c%b9%e9%85%8d aria-label=匹配案例-精确匹配>匹配案例-精确匹配</a></li><li><a href=#%e5%8c%b9%e9%85%8d%e6%a1%88%e4%be%8b-%e5%8c%ba%e5%88%86%e5%a4%a7%e5%b0%8f%e5%86%99 aria-label=匹配案例-区分大小写>匹配案例-区分大小写</a></li><li><a href=#%e5%8c%b9%e9%85%8d%e6%a1%88%e4%be%8b-%e4%b8%8d%e5%8c%ba%e5%88%86%e5%a4%a7%e5%b0%8f%e5%86%99 aria-label=匹配案例-不区分大小写>匹配案例-不区分大小写</a></li><li><a href=#nginx-%e5%9b%9b%e5%b1%82%e8%ae%bf%e9%97%ae%e6%8e%a7%e5%88%b6 aria-label="nginx 四层访问控制">nginx 四层访问控制</a></li><li><a href=#nginx-%e8%b4%a6%e6%88%b7%e8%ae%a4%e8%af%81%e5%8a%9f%e8%83%bd aria-label="nginx 账户认证功能">nginx 账户认证功能</a></li><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e9%94%99%e8%af%af%e9%a1%b5%e9%9d%a2 aria-label=自定义错误页面>自定义错误页面</a></li><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e9%94%99%e8%af%af%e6%97%a5%e5%bf%97 aria-label=自定义错误日志>自定义错误日志</a></li><li><a href=#%e6%a3%80%e6%b5%8b%e6%96%87%e4%bb%b6%e6%98%af%e5%90%a6%e5%ad%98%e5%9c%a8 aria-label=检测文件是否存在>检测文件是否存在</a></li><li><a href=#%e9%95%bf%e8%bf%9e%e6%8e%a5%e9%85%8d%e7%bd%ae aria-label=长连接配置>长连接配置</a></li><li><a href=#%e4%bd%9c%e4%b8%ba%e4%b8%8b%e8%bd%bd%e6%9c%8d%e5%8a%a1%e5%99%a8 aria-label=作为下载服务器>作为下载服务器</a></li><li><a href=#%e4%bd%9c%e4%b8%ba%e4%b8%8a%e4%bc%a0%e6%9c%8d%e5%8a%a1%e5%99%a8 aria-label=作为上传服务器>作为上传服务器</a></li><li><a href=#%e5%85%b6%e4%bb%96%e9%85%8d%e7%bd%ae aria-label=其他配置>其他配置</a></li></ul></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>主要介绍Nginx核心配置文件</p><h1 id=配置文件说明>配置文件说明<a hidden class=anchor aria-hidden=true href=#配置文件说明>#</a></h1><p>nginx 官方文档：http://nginx.org/en/docs/</p><h2 id=nginx-配置文件组成>nginx 配置文件组成：<a hidden class=anchor aria-hidden=true href=#nginx-配置文件组成>#</a></h2><ul><li>主配置文件： nginx.conf</li><li>子配置文件： conf.d/*.conf</li><li>fastcgi,， uwsgi，scgi 等协议的相关配置文件</li><li>mime.types：支持的mime类型，MIME（Multipurpose Internet Mail Extensions）多用途互联网邮件扩展类型，MIME消息能包含文本、图像、音频、视频以及其他应用程序专用的数据，是设定某种扩展名的文件用指定应用程序来打开的方式类型，当带有某种扩展名的文件被访问的时候，浏览器会自动使用指定应用程序打开（比如：应用程序会被下载，文本文件会直接显示内容）。简单来说，MIME就是利用扩展名标识文件类型，然后根据文件的类型做响应的处理。MIME 参考文档：https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types</li></ul><h2 id=nginx-配置文件格式说明>nginx 配置文件格式说明：<a hidden class=anchor aria-hidden=true href=#nginx-配置文件格式说明>#</a></h2><ul><li>配置文件由指令和指令块构成</li><li>每条指令以分号；结束，指令和值之间以空格分隔</li><li>多条指令可以放在同一行，以分号分隔。但可读性差，不推荐这样配置</li><li>指令块以{ } 括号作为开始和结束的标识，将多条指令组织在一起，且支持嵌套</li><li>可通过include引入其他配置文件内容，提升配置文件的可维护性（如子配置文件conf.d/*.conf)</li><li>配置文件使用# 作为注释符，使用$引用变量</li><li>部分指令的参数支持正则表达式</li></ul><h2 id=nginx-主配置文件指令格式>nginx 主配置文件指令格式：<a hidden class=anchor aria-hidden=true href=#nginx-主配置文件指令格式>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tex data-lang=tex><span style=display:flex><span>directive value [value1 ...];
</span></span><span style=display:flex><span>说明：
</span></span><span style=display:flex><span>1、指令必须以分号；结束
</span></span><span style=display:flex><span>2、支持变量：
</span></span><span style=display:flex><span>   1）内建变量：由Nginx模块引入，可直接引用
</span></span><span style=display:flex><span>   2）自定义变量：由用户使用set指定定义，格式： set  variable_name value;
</span></span><span style=display:flex><span>   3) 引用变量的方式：<span style=color:#e6db74>$</span>variable_name
</span></span></code></pre></div><h2 id=主配置文件结构四部分>主配置文件结构：四部分<a hidden class=anchor aria-hidden=true href=#主配置文件结构四部分>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tex data-lang=tex><span style=display:flex><span>main block：主配置段，即全局配置段，对http,mail都有效
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>#事件驱动相关的配置
</span></span><span style=display:flex><span>event {
</span></span><span style=display:flex><span> ...
</span></span><span style=display:flex><span>}   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>#http/https 协议相关配置段
</span></span><span style=display:flex><span>http {
</span></span><span style=display:flex><span> ...
</span></span><span style=display:flex><span>}      
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>#默认配置文件不包括下面两个块
</span></span><span style=display:flex><span>#mail 协议相关配置段
</span></span><span style=display:flex><span>mail {
</span></span><span style=display:flex><span> ...
</span></span><span style=display:flex><span>}    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>#stream 服务器相关配置段
</span></span><span style=display:flex><span>stream {
</span></span><span style=display:flex><span> ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>默认的nginx.conf 配置文件说明</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>##全局配置块，对全局生效。主要设置nginx的启动用户/组，启动的工作进程数量，工作模式，nginx的pid文件路径等。</span>
</span></span><span style=display:flex><span>user nginx nginx;
</span></span><span style=display:flex><span>worker_processes 1; <span style=color:#75715e>#启动工作进程的数量，一般与CPU核心数一致</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##events块，主要影响nginx服务器与用户的网络连接，比如是否允许同时接受多个网络连接，使用哪种事件驱动模型，每个工作进程最大支持并发连接数，是否开启对多工作进程下的网络连接进行序列化等。</span>
</span></span><span style=display:flex><span>events <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	worker_connections 1024; <span style=color:#75715e>#单个worker进程的最大并发连接数。作为web服务器时，nginx的最大并发数为：worker_connections * worker_processes。作为反向代理的时候为（worker_connections * worker_processes）/2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##http块是nginx服务器配置中的重要组成部分，缓存、代理和日志格式定义等绝大多数功能和第三方模块都在这里配置。http块可以包含多个server块，而一个server块又可以包含多个location块，server块可以配置文件引入、MIME-Type定义、日志自定义、是否启用sendfile、连接超时时间和单个链接的请求上限等。</span>
</span></span><span style=display:flex><span>http <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	include			mime.types;
</span></span><span style=display:flex><span>	default_type 	application/ostet-stream;
</span></span><span style=display:flex><span>	sendfile		on; 	<span style=color:#75715e>#作为web服务器时打开sendfile加快静态文件传输，指定是否使用sendfile系统调用传输文件。sendfile系统调用在两个文件描述符之间直接传递数据（完全在内核空间进程），从而避免了数据在内核缓冲区和用户缓冲区之间的拷贝，效率很高，是零拷贝技术的一种。</span>
</span></span><span style=display:flex><span>	keepalive_timeout 65; 	<span style=color:#75715e>#长连接超时时间，单位：秒</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>##server块可用于配置虚拟主机，有自己的全局配置，可以包含多个location块。可配置本虚拟机监听的端口，设置虚拟机名称，多个server监听同一个端口。</span>
</span></span><span style=display:flex><span>	server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		listen 			80; <span style=color:#75715e>#监听端口</span>
</span></span><span style=display:flex><span>		server_name;	localhost; <span style=color:#75715e>#server的域名，配置多个虚拟主机时用到</span>
</span></span><span style=display:flex><span>		location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			root	html;
</span></span><span style=display:flex><span>			index	index.html index.htm; <span style=color:#75715e>#网站默认主页</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		error_page <span style=color:#ae81ff>500</span> <span style=color:#ae81ff>502</span> <span style=color:#ae81ff>503</span> <span style=color:#ae81ff>504</span> /50x.html; <span style=color:#75715e>#错误页面</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>##location处理对应的不同错误码的页面定义到50x.html，指示了50.html文件所在目录</span>
</span></span><span style=display:flex><span>		location <span style=color:#f92672>=</span> /50x.html <span style=color:#f92672>{</span> 	
</span></span><span style=display:flex><span>        	root	html;   <span style=color:#75715e>#错误页面文件所在目录</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>##和邮件相关的配置</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#mail {</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#               ...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#}         mail 协议相关配置段</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#tcp代理配置，1.9版本以上支持</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#stream {</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#               ...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#}       stream 服务器相关配置段</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#导入其他路径的配置文件</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#include /apps/nginx/conf.d/*.conf</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=全局配置>全局配置<a hidden class=anchor aria-hidden=true href=#全局配置>#</a></h1><p>main 全局配置块常见的配置指令分类</p><ul><li>正常运行必备的配置</li><li>优化性能相关的配置</li><li>用于调试定位问题相关的配置</li><li>事件驱动相关的配置</li></ul><h2 id=全局配置说明>全局配置说明<a hidden class=anchor aria-hidden=true href=#全局配置说明>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>user	nginx nginx; <span style=color:#75715e>#启动nginx工作进程的用户和组</span>
</span></span><span style=display:flex><span>worker_processes <span style=color:#f92672>[</span>number | auto<span style=color:#f92672>]</span>; <span style=color:#75715e>#启动nginx工作进程的数量，一般和CPU核心数相同</span>
</span></span><span style=display:flex><span>worker_cpu_affinity <span style=color:#ae81ff>00000001</span> <span style=color:#ae81ff>00000010</span> <span style=color:#ae81ff>00000100</span> 00001000; <span style=color:#75715e>#将Nginx工作进程绑定到指定的CPU核心，默认Nginx是不进行进程绑定的，绑定并不是意味着当前nginx进程独占以一核心CPU，但是可以保证此进程不会运行在其他核心上，这就极大减少了nginx的工作进程在不同的cpu核心上的来回跳转，减少了CPU对进程的资源分配与回收以及内存管理等，因此可以有效的提升nginx服务器的性能。</span>
</span></span><span style=display:flex><span>CPU MASK: 00000001：0号CPU
</span></span><span style=display:flex><span>          00000010：1号CPU
</span></span><span style=display:flex><span>  		  10000000：7号CPU
</span></span><span style=display:flex><span>  		  
</span></span><span style=display:flex><span><span style=color:#75715e>##示例:</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@test conf<span style=color:#f92672>]</span><span style=color:#75715e># egrep &#34;processes|affinity&#34; nginx.conf</span>
</span></span><span style=display:flex><span>worker_processes 4;	 <span style=color:#75715e>#启动四个worker进程</span>
</span></span><span style=display:flex><span>worker_cpu_affinity <span style=color:#ae81ff>0001</span> 0010;   <span style=color:#75715e>#将workr进程绑定到 0号CPU和1号CPU</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@test conf<span style=color:#f92672>]</span><span style=color:#75715e># lscpu | grep CPU\(s\)   # CPU核数为2</span>
</span></span><span style=display:flex><span>CPU<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>:                <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>On-line CPU<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> list:   0,1
</span></span><span style=display:flex><span>NUMA node0 CPU<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>:     0,1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@test conf<span style=color:#f92672>]</span><span style=color:#75715e># nginx -t  #语法检查出现警告，因为worker进程数比CPU核心数多。多出的worker进程将绑定在‘上一个CPU核心‘也即0010上。对于‘上一个CPU核心’（last mask for remaining worker）的解释： processes：nginx分别将worker进程绑定到worker_cpu_affinity 指定的CPU核心上（从左至右的顺序），而从第三个work进程起并未指定对应的CPU核心，因此全部绑定到‘上一个CPU核心’ 0010这个CPU核心。</span>
</span></span><span style=display:flex><span>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok
</span></span><span style=display:flex><span>nginx: <span style=color:#f92672>[</span>warn<span style=color:#f92672>]</span> the number of <span style=color:#e6db74>&#34;worker_processes&#34;</span> is not equal to the number of <span style=color:#e6db74>&#34;worker_cpu_affinity&#34;</span> masks, using last mask <span style=color:#66d9ef>for</span> remaining worker processes
</span></span><span style=display:flex><span>nginx: configuration file /apps/nginx/conf/nginx.conf test is successful
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@test conf<span style=color:#f92672>]</span><span style=color:#75715e># ps axo pid,cmd,psr | grep nginx</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>827</span> nginx: master process /apps   <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1226</span> nginx: worker process         <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1227</span> nginx: worker process         <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1228</span> nginx: worker process         <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1229</span> nginx: worker process         <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1249</span> grep --color<span style=color:#f92672>=</span>auto nginx       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#将worker进程数量改为2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@test conf<span style=color:#f92672>]</span><span style=color:#75715e># vim nginx.conf</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@test conf<span style=color:#f92672>]</span><span style=color:#75715e># egrep &#34;processes|affinity&#34; nginx.conf</span>
</span></span><span style=display:flex><span>worker_processes 2;
</span></span><span style=display:flex><span>worker_cpu_affinity <span style=color:#ae81ff>0001</span> 0010;
</span></span><span style=display:flex><span><span style=color:#75715e>#语法检查不再警告</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@test conf<span style=color:#f92672>]</span><span style=color:#75715e># nginx -s reload  </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@test conf<span style=color:#f92672>]</span><span style=color:#75715e># nginx -t</span>
</span></span><span style=display:flex><span>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok
</span></span><span style=display:flex><span>nginx: configuration file /apps/nginx/conf/nginx.conf test is successful
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@test conf<span style=color:#f92672>]</span><span style=color:#75715e># ps axo pid,cmd,psr | grep nginx</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>827</span> nginx: master process /apps   <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1261</span> nginx: worker process         <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1262</span> nginx: worker process         <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1265</span> grep --color<span style=color:#f92672>=</span>auto nginx       <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e>#错误日志记录配置，语法：error_log file [debug | info | notice | warn | error | crit | alert | emerg]  #括号内为日志记录详细级别（从左至右逐渐提高）</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##示例配置</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#error_log logs/error.log;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#error_log logs/error.log notice;</span>
</span></span><span style=display:flex><span>error_log /apps/nginx/logs/error.log error;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#pid文件保存路径</span>
</span></span><span style=display:flex><span>pid       /apps/nginx/logs/nginx.pid;
</span></span><span style=display:flex><span>worker_priority 0; <span style=color:#75715e>#工作进程优先级，-20~20(19)</span>
</span></span><span style=display:flex><span>worker_rlimit_nofile 65536; <span style=color:#75715e>#所有worker进程能打开的文件数量上限,包括:Nginx的所有连接（例如与代理服务器的连接等），而不仅仅是与客户端的连接。该值最好与ulimit -n 或者limits.conf的值保持一致,</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#通过pam限制文件打开数量上限</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos8 ~<span style=color:#f92672>]</span><span style=color:#75715e>#cat /etc/security/limits.conf</span>
</span></span><span style=display:flex><span>*               soft   nofile          1000000
</span></span><span style=display:flex><span>*               hard   nofile          1000000
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#worker进程优先级</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@test conf<span style=color:#f92672>]</span><span style=color:#75715e># grep priority nginx.conf</span>
</span></span><span style=display:flex><span>worker_priority 0;
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@test conf<span style=color:#f92672>]</span><span style=color:#75715e># ps -axo pid,cmd,nice | grep nginx</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>827</span> nginx: master process /apps   <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1391</span> nginx: worker process         <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1392</span> nginx: worker process         <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1449</span> grep --color<span style=color:#f92672>=</span>auto nginx       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>daemon off;  #前台运行Nginx服务，通常在测试环境或者docker环境中使用
</span></span><span style=display:flex><span>master_process off|on; <span style=color:#75715e>#是否开启Nginx的master-worker工作模式，仅用于开发调试场景,默认为on</span>
</span></span><span style=display:flex><span>events <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   worker_connections  65536;  #设置单个工作进程的最大并发连接数
</span></span><span style=display:flex><span>   use epoll; <span style=color:#75715e>#使用epoll事件驱动，Nginx支持众多的事件驱动，比如:select、poll、epoll，只能设置在events模块中设置。</span>
</span></span><span style=display:flex><span>   accept_mutex on; <span style=color:#75715e>#on为同一时刻一个请求轮流由work进程处理,而防止被同时唤醒所有worker,避免多个睡眠进程被唤醒的设置，默认为off，新请求会唤醒所有worker进程,此过程也称为&#34;惊群&#34;，因此nginx刚安装完以后要进行适当的优化。建议设置为on</span>
</span></span><span style=display:flex><span>   multi_accept on; <span style=color:#75715e>#on时Nginx服务器的每个工作进程可以同时接受多个新的网络连接，此指令默认为off，即默认为一个工作进程只能一次接受一个新的网络连接，打开后几个同时接受多个。建议设置为on</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>范例：实现nginx的高并发配置</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf<span style=color:#f92672>]</span><span style=color:#75715e># ulimit -n </span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf/nginx.conf | grep rlimit</span>
</span></span><span style=display:flex><span>worker_rlimit_nofile 100;
</span></span><span style=display:flex><span><span style=color:#75715e>#默认配置不支持高并发，当worker_rlimit_nofile设置的值大于ulimit -n的值,会出现以下错误日志</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf<span style=color:#f92672>]</span><span style=color:#75715e># ab -c 5000 -n 10000 http://127.0.0.1/</span>
</span></span><span style=display:flex><span>This is ApacheBench, Version 2.3 &lt;$Revision: <span style=color:#ae81ff>1430300</span> $&gt;
</span></span><span style=display:flex><span>Copyright <span style=color:#ae81ff>1996</span> Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
</span></span><span style=display:flex><span>Licensed to The Apache Software Foundation, http://www.apache.org/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Benchmarking 127.0.0.1 <span style=color:#f92672>(</span>be patient<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>socket: Too many open files <span style=color:#f92672>(</span>24<span style=color:#f92672>)</span>     <span style=color:#75715e>#打开的文件描述符过多</span>
</span></span></code></pre></div><h1 id=http-配置块>http 配置块<a hidden class=anchor aria-hidden=true href=#http-配置块>#</a></h1><p>http 协议相关的配置结构</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>http <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span> 	...  
</span></span><span style=display:flex><span> 	server <span style=color:#f92672>{</span>    #每个server用于定义一个虚拟主机,第一个server为默认虚拟服务器
</span></span><span style=display:flex><span> 		...
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span> 	server <span style=color:#f92672>{</span>     
</span></span><span style=display:flex><span> 		...
</span></span><span style=display:flex><span> 		server_name   <span style=color:#75715e>#虚拟主机名</span>
</span></span><span style=display:flex><span>        root     <span style=color:#75715e>#主目录</span>
</span></span><span style=display:flex><span>        alias     <span style=color:#75715e>#路径别名</span>
</span></span><span style=display:flex><span>        location <span style=color:#f92672>[</span>OPERATOR<span style=color:#f92672>]</span> URL <span style=color:#f92672>{</span>     <span style=color:#75715e>#指定URL的特性</span>
</span></span><span style=display:flex><span>         	...
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> CONDITION <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            ...
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span> 		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span> 	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>http 协议配置说明</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>http <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   include       mime.types; <span style=color:#75715e>#导入支持的文件类型,是相对于/apps/nginx/conf目录</span>
</span></span><span style=display:flex><span>   default_type  application/octet-stream; <span style=color:#75715e>#除mime.types中文件类型外,设置其它文件默认类型，访问其它类型时会提示下载不匹配的类型文件</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#日志配置部分</span>
</span></span><span style=display:flex><span>    #log_format main  <span style=color:#e6db74>&#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;</span>
</span></span><span style=display:flex><span>    #                 <span style=color:#e6db74>&#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;</span>
</span></span><span style=display:flex><span>    #                 <span style=color:#e6db74>&#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;</span>;
</span></span><span style=display:flex><span>    #access_log logs/access.log main;
</span></span><span style=display:flex><span><span style=color:#75715e>#自定义优化参数</span>
</span></span><span style=display:flex><span>   	sendfile       on; 
</span></span><span style=display:flex><span>    #tcp_nopush    on; <span style=color:#75715e>#在开启了sendfile的情况下，合并请求后统一发送给客户端,必须开启sendfile</span>
</span></span><span style=display:flex><span>    #tcp_nodelay   off; <span style=color:#75715e>#在开启了keepalived模式下的连接是否启用TCP_NODELAY选项，当为off时，延迟0.2s发送，默认On时，不延迟发送，立即发送用户响应报文。</span>
</span></span><span style=display:flex><span>    #keepalive_timeout 0;
</span></span><span style=display:flex><span>  	keepalive_timeout  65 66; <span style=color:#75715e>#设置会话保持时间,第二个值为响应首部:keep-Alived:timeout=65,可以和第一个值不同</span>
</span></span><span style=display:flex><span>    #gzip on; <span style=color:#75715e>#开启文件压缩</span>
</span></span><span style=display:flex><span>    server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    	listen       80; <span style=color:#75715e>#设置监听地址和端口</span>
</span></span><span style=display:flex><span>       	server_name localhost; <span style=color:#75715e>#设置server name，可以以空格隔开写多个并支持正则表达式，如:*.magedu.com www.magedu.* ~^www\d+\.magedu\.com$ default_server </span>
</span></span><span style=display:flex><span>       	<span style=color:#75715e>#charset koi8-r; #设置编码格式，默认是俄语格式，建议改为utf-8</span>
</span></span><span style=display:flex><span>       	<span style=color:#75715e>#access_log logs/host.access.log main;</span>
</span></span><span style=display:flex><span>        location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>           root   html;
</span></span><span style=display:flex><span>           index index.html index.htm;
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        #error_page <span style=color:#ae81ff>404</span>             /404.html;
</span></span><span style=display:flex><span>        # redirect server error pages to the static page /50x.html
</span></span><span style=display:flex><span>        #
</span></span><span style=display:flex><span>        error_page   <span style=color:#ae81ff>500</span> <span style=color:#ae81ff>502</span> <span style=color:#ae81ff>503</span> <span style=color:#ae81ff>504</span> /50x.html; <span style=color:#75715e>#定义错误页面</span>
</span></span><span style=display:flex><span>        location <span style=color:#f92672>=</span> /50x.html <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>           root   html;
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        # proxy the PHP scripts to Apache listening on 127.0.0.1:80
</span></span><span style=display:flex><span>        #
</span></span><span style=display:flex><span>        #location ~ <span style=color:#ae81ff>\.</span>php$ <span style=color:#f92672>{</span> <span style=color:#75715e>#以http的方式转发php请求到指定web服务器</span>
</span></span><span style=display:flex><span>        #   proxy_pass   http://127.0.0.1;
</span></span><span style=display:flex><span>        #<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
</span></span><span style=display:flex><span>        #
</span></span><span style=display:flex><span>        #location ~ <span style=color:#ae81ff>\.</span>php$ <span style=color:#f92672>{</span> <span style=color:#75715e>#以fastcgi的方式转发php请求到php处理</span>
</span></span><span style=display:flex><span>        #   root           html;
</span></span><span style=display:flex><span>        #   fastcgi_pass   127.0.0.1:9000;
</span></span><span style=display:flex><span>        #   fastcgi_index index.php;
</span></span><span style=display:flex><span>        #   fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name;
</span></span><span style=display:flex><span>        #   include       fastcgi_params;
</span></span><span style=display:flex><span>        #<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        # deny access to .htaccess files, <span style=color:#66d9ef>if</span> Apache<span style=color:#e6db74>&#39;s document root
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # concurs with nginx&#39;</span>s one
</span></span><span style=display:flex><span>        #
</span></span><span style=display:flex><span>        #location ~ /<span style=color:#ae81ff>\.</span>ht <span style=color:#f92672>{</span> <span style=color:#75715e>#拒绝web形式访问指定文件，如很多的网站都是通过.htaccess文件来改变自己的重定向等功能。</span>
</span></span><span style=display:flex><span>        #   deny all;
</span></span><span style=display:flex><span>        #<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>       location ~ /passwd.html <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>           deny all;
</span></span><span style=display:flex><span>       <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    # another virtual host using mix of IP-, name-, and port-based configuration
</span></span><span style=display:flex><span>    #
</span></span><span style=display:flex><span>    #server <span style=color:#f92672>{</span> <span style=color:#75715e>#自定义虚拟server</span>
</span></span><span style=display:flex><span>    #   listen       8000;
</span></span><span style=display:flex><span>    #   listen       somename:8080;
</span></span><span style=display:flex><span>    #   server_name somename alias another.alias;
</span></span><span style=display:flex><span>    #   location / <span style=color:#f92672>{</span> 
</span></span><span style=display:flex><span>    #       root   html;
</span></span><span style=display:flex><span>    #       index index.html index.htm; <span style=color:#75715e>#指定默认网页文件，此指令由ngx_http_index_module模块提供</span>
</span></span><span style=display:flex><span>    #   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    #<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    # HTTPS server
</span></span><span style=display:flex><span>    #
</span></span><span style=display:flex><span>    #server <span style=color:#f92672>{</span> <span style=color:#75715e>#https服务器配置</span>
</span></span><span style=display:flex><span>    #   listen       <span style=color:#ae81ff>443</span> ssl;
</span></span><span style=display:flex><span>    #   server_name localhost;
</span></span><span style=display:flex><span>    #   ssl_certificate     cert.pem;
</span></span><span style=display:flex><span>    #   ssl_certificate_key cert.key;
</span></span><span style=display:flex><span>    #   ssl_session_cache   shared:SSL:1m;
</span></span><span style=display:flex><span>    #   ssl_session_timeout 5m;
</span></span><span style=display:flex><span>    #   ssl_ciphers HIGH:!aNULL:!MD5;
</span></span><span style=display:flex><span>    #   ssl_prefer_server_ciphers on;
</span></span><span style=display:flex><span>    #   location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    #       root   html;
</span></span><span style=display:flex><span>    #       index index.html index.htm;
</span></span><span style=display:flex><span>    #   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    #<span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=mime>MIME<a hidden class=anchor aria-hidden=true href=#mime>#</a></h3><p>MIME参考文档：
<a href=https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types>https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#在响应报文中将指定的文件扩展名映射至MIME对应的类型</span>
</span></span><span style=display:flex><span>include          mime.types;
</span></span><span style=display:flex><span>default_type     application/octet-stream;<span style=color:#75715e>#除mime.types中的类型外，指定其它文件的默认MIME类型，浏览器一般会提示下载</span>
</span></span><span style=display:flex><span>types <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	text/html html;
</span></span><span style=display:flex><span>    image/gif gif;
</span></span><span style=display:flex><span>    image/jpeg jpg;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#未定义mime.types类型</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost nginx<span style=color:#f92672>]</span><span style=color:#75715e># ll html/mime.types</span>
</span></span><span style=display:flex><span>ls: cannot access html/mime.types: No such file or directory
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost nginx<span style=color:#f92672>]</span><span style=color:#75715e># curl localhost/test.php -I</span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>Server: nginx/1.18.0
</span></span><span style=display:flex><span>Date: Thu, <span style=color:#ae81ff>28</span> Jul <span style=color:#ae81ff>2022</span> 11:23:54 GMT
</span></span><span style=display:flex><span>Content-Type: application/octet-stream  <span style=color:#75715e>#mime未定义的类型默认视为二进制文件处理（如果是浏览器访问，则会下载test.php文件）</span>
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>Last-Modified: Thu, <span style=color:#ae81ff>28</span> Jul <span style=color:#ae81ff>2022</span> 11:19:48 GMT
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span><span style=display:flex><span>Keep-Alive: timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>66</span>  <span style=color:#75715e>#长连接显示的时长，由keepalive_timeout  65 66; 配置</span>
</span></span><span style=display:flex><span>ETag: <span style=color:#e6db74>&#34;62e270d4-14&#34;</span>
</span></span><span style=display:flex><span>Accept-Ranges: bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#修改默认文件类型</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost nginx<span style=color:#f92672>]</span><span style=color:#75715e># cat conf/nginx.conf | grep default_type</span>
</span></span><span style=display:flex><span>    default_type  text/html;
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost nginx<span style=color:#f92672>]</span><span style=color:#75715e># nginx -s reload</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost nginx<span style=color:#f92672>]</span><span style=color:#75715e># curl localhost/test.php -I</span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>Server: nginx/1.18.0
</span></span><span style=display:flex><span>Date: Thu, <span style=color:#ae81ff>28</span> Jul <span style=color:#ae81ff>2022</span> 11:32:15 GMT
</span></span><span style=display:flex><span>Content-Type: text/html     <span style=color:#75715e>#将test.php识别为文本文件（如果是浏览器访问，直接显示文件内容）</span>
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>Last-Modified: Thu, <span style=color:#ae81ff>28</span> Jul <span style=color:#ae81ff>2022</span> 11:19:48 GMT
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span><span style=display:flex><span>Keep-Alive: timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>66</span>
</span></span><span style=display:flex><span>ETag: <span style=color:#e6db74>&#34;62e270d4-14&#34;</span>
</span></span><span style=display:flex><span>Accept-Ranges: bytes
</span></span></code></pre></div><h3 id=指定响应报文>指定响应报文<a hidden class=anchor aria-hidden=true href=#指定响应报文>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#是否在响应报文中的Content-Type显示指定的字符集，默认off不显示</span>
</span></span><span style=display:flex><span>charset charset | off;
</span></span><span style=display:flex><span><span style=color:#75715e>#示例</span>
</span></span><span style=display:flex><span>charset utf-8;
</span></span><span style=display:flex><span><span style=color:#75715e>#是否在响应报文的Server首部显示nginx版本</span>
</span></span><span style=display:flex><span>server_tokens on | off | build | string;
</span></span></code></pre></div><p>范例：源码修改server字段</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#如果想自定义响应报文的nginx版本信息，需要修改源码文件，重新编译</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#如果server_tokens on，修改 src/core/nginx.h 修改第13-14行，如下示例</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define NGINX_VERSION     &#34;1.68.9&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define NGINX_VER         &#34;mynginx/&#34; NGINX_VERSION</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#如果server_tokens off，修改 src/http/ngx_http_header_filter_module.c 第49行，如下示例：</span>
</span></span><span style=display:flex><span>static char ngx_http_server_string<span style=color:#f92672>[]</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Server: nginx&#34;</span> CRLF;
</span></span><span style=display:flex><span><span style=color:#75715e>#把其中的nginx改为自己想要的文字即可,如：mynginx</span>
</span></span></code></pre></div><h1 id=核心配置示例>核心配置示例<a hidden class=anchor aria-hidden=true href=#核心配置示例>#</a></h1><h3 id=虚拟主机的实现>虚拟主机的实现<a hidden class=anchor aria-hidden=true href=#虚拟主机的实现>#</a></h3><p>基于不同的IP、不同的端口以及不用域名实现不同的虚拟主机，依赖于核心模块ngx_http_core_module实现。</p><h4 id=新建两个虚拟主机>新建两个虚拟主机<a hidden class=anchor aria-hidden=true href=#新建两个虚拟主机>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 添加域名解析</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># cat /etc/hosts |grep test</span>
</span></span><span style=display:flex><span>172.16.16.88   pc.test.org  mobile.test.org
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## 开始新建虚拟主机</span>
</span></span><span style=display:flex><span>root@localhost nginx<span style=color:#f92672>]</span><span style=color:#75715e># mkdir /apps/nginx/conf/conf.d</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost nginx<span style=color:#f92672>]</span><span style=color:#75715e># cd /apps/nginx/conf/conf.d/</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># vim /apps/nginx/conf/nginx.conf</span>
</span></span><span style=display:flex><span>   ......
</span></span><span style=display:flex><span>   include /apps/nginx/conf.d/*.conf; <span style=color:#75715e>#在配置文件的最后面添加此行,注意不要放在最前面,会导致前面的配置无法生效（文件配置从上到下依次生效）</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># cat pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    root html/pc;
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># mkdir /apps/nginx/html/pc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># echo pc_page &gt; /apps/nginx/html/pc/index.html</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># nginx -s reload</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># curl pc.test.org   #虚拟主机pc</span>
</span></span><span style=display:flex><span>pc_page
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># cat mobile.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  server_name mobile.test.org;
</span></span><span style=display:flex><span>  location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    root html/mobile;
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># mkdir /apps/nginx/html/mobile  #虚拟主机mobile</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># echo mobile_page &gt; /apps/nginx/html/mobile/index.html</span>
</span></span><span style=display:flex><span>mobile_page
</span></span></code></pre></div><h4 id=root-与-alias-的区别>root 与 alias 的区别<a hidden class=anchor aria-hidden=true href=#root-与-alias-的区别>#</a></h4><p>root：指定web的家目录，在定义location的时候，文件的绝对路径等于 root+location</p><p>范例:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># cat pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    root html/pc;
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  location /about <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    root /opt/html;   <span style=color:#75715e>#实际路径为/opt/html/about/index.html</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># ll /opt/html/about/</span>
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>11</span> Jul <span style=color:#ae81ff>28</span> 23:24 index.html
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># cat /opt/html/about/index.html </span>
</span></span><span style=display:flex><span>about_page
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># nginx -s reload</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># curl pc.test.org/about/</span>
</span></span><span style=display:flex><span>about_page
</span></span></code></pre></div><p>alias：定义路径别名，会把访问的路径重新定义到其指定的路径,文档映射的另一种机制;仅能用于location上下文,此指令使用较少</p><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># cat pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    root html/pc;
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  location /about <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>     alias /opt/html;  <span style=color:#75715e>#实际路径为/opt/html/index.html</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># cat /opt/html/index.html </span>
</span></span><span style=display:flex><span>about_page
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># nginx -s reload</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost conf.d<span style=color:#f92672>]</span><span style=color:#75715e># curl pc.test.org/about/</span>
</span></span><span style=display:flex><span>about_page
</span></span></code></pre></div><h3 id=localtion-的匹配规则>localtion 的匹配规则<a hidden class=anchor aria-hidden=true href=#localtion-的匹配规则>#</a></h3><p>在一个server中location配置段可存在多个，用于实现从uri到文件系统的路径映射；ngnix会根据用户请</p><p>求的URI来检查定义的所有location，按一定的优先级找出一个最佳匹配，而后进行处理。</p><p>location 官方帮助: <a href=http://nginx.org/en/docs/http/ngx_http_core_module.html#location>http://nginx.org/en/docs/http/ngx_http_core_module.html#location</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#语法规则：</span>
</span></span><span style=display:flex><span>location <span style=color:#f92672>[</span> <span style=color:#f92672>=</span> | ~ | ~* | ^~ <span style=color:#f92672>]</span> uri <span style=color:#f92672>{</span> ... <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>=</span>   <span style=color:#75715e>#用于标准uri前，需要请求字串与uri精确匹配，大小敏感,如果匹配成功就停止向下匹配并立即处理请求</span>
</span></span><span style=display:flex><span>^~  #用于标准uri前，表示包含正则表达式,并且匹配以指定的正则表达式开头,对URI的最左边部分做匹配检查，不区分字符大小写
</span></span><span style=display:flex><span>~   <span style=color:#75715e>#用于标准uri前，表示包含正则表达式,并且区分大小写</span>
</span></span><span style=display:flex><span>~*  #用于标准uri前，表示包含正则表达式,并且不区分大小写
</span></span><span style=display:flex><span>不带符号 <span style=color:#75715e>#匹配起始于此uri的所有的uri</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>\ </span>  <span style=color:#75715e>#用于标准uri前，表示包含正则表达式并且转义字符。可以将 . * ?等转义为普通符号</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#匹配优先级从高到低：</span>
</span></span><span style=display:flex><span><span style=color:#f92672>=</span>, ^~, ~/~*, 不带符号
</span></span></code></pre></div><p>官方范例</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>location = / {
</span></span><span style=display:flex><span>   [ configuration A ]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>location / {
</span></span><span style=display:flex><span>   [ configuration B ]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>location /documents/ {
</span></span><span style=display:flex><span>   [ configuration C ]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>location ^~ /images/ {
</span></span><span style=display:flex><span>   [ configuration D ]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>location ~* \.(gif|jpg|jpeg)$ {
</span></span><span style=display:flex><span>   [ configuration E ]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>The “/” request will match configuration A(?), the “/index.html” request will 
</span></span><span style=display:flex><span>match configuration B,
</span></span><span style=display:flex><span>the “/documents/document.html” request will match configuration C, the 
</span></span><span style=display:flex><span>“/images/1.gif” request will match configuration D, and the “/documents/1.jpg” 
</span></span><span style=display:flex><span>request will match configuration E.
</span></span></code></pre></div><h3 id=匹配案例-精确匹配>匹配案例-精确匹配<a hidden class=anchor aria-hidden=true href=#匹配案例-精确匹配>#</a></h3><p>在server部分使用location配置一个web界面，例如：当访问nginx服务器的/logo.jpg的时候要显示指定html文件的内容</p><p>精确匹配一般用于匹配网站logo等相对固定的URL</p><p>范例：精确匹配</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost images<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf.d/pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    root html/pc;
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  location /logo.jpg <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>     root html/images;
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost images<span style=color:#f92672>]</span><span style=color:#75715e># ll /apps/nginx/html/images/logo.jpg </span>
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>13110</span> Jul <span style=color:#ae81ff>29</span> 15:11 /apps/nginx/html/images/logo.jpg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#访问成功</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost images<span style=color:#f92672>]</span><span style=color:#75715e># curl pc.test.org/logo.jpg -I</span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>Server: nginx/1.18.0
</span></span><span style=display:flex><span>Date: Fri, <span style=color:#ae81ff>29</span> Jul <span style=color:#ae81ff>2022</span> 15:17:35 GMT
</span></span><span style=display:flex><span>Content-Type: image/jpeg
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>13110</span>
</span></span><span style=display:flex><span>Last-Modified: Fri, <span style=color:#ae81ff>29</span> Jul <span style=color:#ae81ff>2022</span> 07:11:49 GMT
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span><span style=display:flex><span>Keep-Alive: timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>66</span>
</span></span><span style=display:flex><span>ETag: <span style=color:#e6db74>&#34;62e38835-3336&#34;</span>
</span></span><span style=display:flex><span>Accept-Ranges: bytes
</span></span></code></pre></div><h3 id=匹配案例-区分大小写>匹配案例-区分大小写<a hidden class=anchor aria-hidden=true href=#匹配案例-区分大小写>#</a></h3><p>~ 实现区分大小写的模糊匹配</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost images<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf.d/pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    root html/pc;
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  location ~ /A.?<span style=color:#ae81ff>\.</span>jpg <span style=color:#f92672>{</span>   <span style=color:#75715e>#匹配字母A开头的jpg图片，后面?表示A后面零次或一个字符</span>
</span></span><span style=display:flex><span>     root html/images;
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#确保资源存在</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost images<span style=color:#f92672>]</span><span style=color:#75715e># ll /apps/nginx/html/images/A.jpg </span>
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>13110</span> Jul <span style=color:#ae81ff>29</span> 15:11 /apps/nginx/html/images/A.jpg
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost images<span style=color:#f92672>]</span><span style=color:#75715e># nginx -s reload</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#以大写URI访问成功</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost images<span style=color:#f92672>]</span><span style=color:#75715e># curl -I pc.test.org/A.jpg</span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>Server: nginx/1.18.0
</span></span><span style=display:flex><span>Date: Fri, <span style=color:#ae81ff>29</span> Jul <span style=color:#ae81ff>2022</span> 15:27:52 GMT
</span></span><span style=display:flex><span>Content-Type: image/jpeg
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>13110</span>
</span></span><span style=display:flex><span>Last-Modified: Fri, <span style=color:#ae81ff>29</span> Jul <span style=color:#ae81ff>2022</span> 07:11:49 GMT
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span><span style=display:flex><span>Keep-Alive: timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>66</span>
</span></span><span style=display:flex><span>ETag: <span style=color:#e6db74>&#34;62e38835-3336&#34;</span>
</span></span><span style=display:flex><span>Accept-Ranges: bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#以小写URI访问失败</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost images<span style=color:#f92672>]</span><span style=color:#75715e># curl -I pc.test.org/a.jpg</span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>404</span> Not Found
</span></span><span style=display:flex><span>Server: nginx/1.18.0
</span></span><span style=display:flex><span>Date: Fri, <span style=color:#ae81ff>29</span> Jul <span style=color:#ae81ff>2022</span> 15:27:55 GMT
</span></span><span style=display:flex><span>Content-Type: text/html
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>153</span>
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span><span style=display:flex><span>Keep-Alive: timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>66</span>
</span></span></code></pre></div><h3 id=匹配案例-不区分大小写>匹配案例-不区分大小写<a hidden class=anchor aria-hidden=true href=#匹配案例-不区分大小写>#</a></h3><p>~* 用来对用户请求的uri做模糊匹配。</p><p>注意：尽管匹配时不区分大小写，但实际请求是仍会以用户请求的uri去寻找相应的磁盘文件，如用户访问uri为/A.jpg，在location条件通过后就在对应路径下寻找磁盘中的A.jpg文件，如果磁盘上是a.jpg，则请求是失败的（在window系统中，文件名不区分大小写，该请求会成功——受文件系统影响）。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost images<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf.d/pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    root html/pc;
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  location ~* /A.?<span style=color:#ae81ff>\.</span>jpg <span style=color:#f92672>{</span>  <span style=color:#75715e>#匹配规则不区分大小写</span>
</span></span><span style=display:flex><span>     root html/images;
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost images<span style=color:#f92672>]</span><span style=color:#75715e># ll /apps/nginx/html/images/a.jpg  #磁盘中仅存在a.jpg文件</span>
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>13110</span> Jul <span style=color:#ae81ff>29</span> 15:11 /apps/nginx/html/images/a.jpg
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost images<span style=color:#f92672>]</span><span style=color:#75715e># nginx -s reload</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#访问/a.jpg成功</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost images<span style=color:#f92672>]</span><span style=color:#75715e># curl -I pc.test.org/a.jpg</span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>Server: nginx/1.18.0
</span></span><span style=display:flex><span>Date: Fri, <span style=color:#ae81ff>29</span> Jul <span style=color:#ae81ff>2022</span> 15:41:25 GMT
</span></span><span style=display:flex><span>Content-Type: image/jpeg
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>13110</span>
</span></span><span style=display:flex><span>Last-Modified: Fri, <span style=color:#ae81ff>29</span> Jul <span style=color:#ae81ff>2022</span> 07:11:49 GMT
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span><span style=display:flex><span>Keep-Alive: timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>66</span>
</span></span><span style=display:flex><span>ETag: <span style=color:#e6db74>&#34;62e38835-3336&#34;</span>
</span></span><span style=display:flex><span>Accept-Ranges: bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#访问/A.jpg失败。location匹配成功，但磁盘上并无A.jpg文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost images<span style=color:#f92672>]</span><span style=color:#75715e># curl -I pc.test.org/A.jpg</span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>404</span> Not Found
</span></span><span style=display:flex><span>Server: nginx/1.18.0
</span></span><span style=display:flex><span>Date: Fri, <span style=color:#ae81ff>29</span> Jul <span style=color:#ae81ff>2022</span> 15:41:48 GMT
</span></span><span style=display:flex><span>Content-Type: text/html
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>153</span>
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span><span style=display:flex><span>Keep-Alive: timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>66</span>
</span></span></code></pre></div><h3 id=nginx-四层访问控制>nginx 四层访问控制<a hidden class=anchor aria-hidden=true href=#nginx-四层访问控制>#</a></h3><p>访问控制基于模块ngx_http_access_module实现，可以通过匹配客户端源IP地址进行限制</p><p>注意: 如果能在防火墙设备控制, 最好就不要在nginx上配置,可以更好的节约资源</p><p>官方帮助: <a href=http://nginx.org/en/docs/http/ngx_http_access_module.html>http://nginx.org/en/docs/http/ngx_http_access_module.html</a></p><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>## 匹配时按从上至下的规则进行匹配，匹配到相应规则即停止———与防火墙的匹配规则类似</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#如：有客户端（IP：10.1.1.0）访问配置了以下规则的web服务器时(访问URI:/about)，触发location /about语句块，匹配到allow 10.1.1.0/16，访问控制生效，访问成功。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>location <span style=color:#f92672>=</span> /login/ <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   root /data/nginx/html/pc;
</span></span><span style=display:flex><span>   allow 10.0.0.0/24;
</span></span><span style=display:flex><span>   deny all;
</span></span><span style=display:flex><span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>location /about <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   alias /data/nginx/html/pc;
</span></span><span style=display:flex><span>   index index.html;
</span></span><span style=display:flex><span>   deny  192.168.1.1;
</span></span><span style=display:flex><span>   allow 192.168.1.0/24;
</span></span><span style=display:flex><span>   allow 10.1.1.0/16;
</span></span><span style=display:flex><span>   allow 2001:0db8::/32;
</span></span><span style=display:flex><span>   deny all;  #按先小范围到大范围排序
</span></span><span style=display:flex><span> <span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=nginx-账户认证功能>nginx 账户认证功能<a hidden class=anchor aria-hidden=true href=#nginx-账户认证功能>#</a></h3><p>由 ngx_http_auth_basic_module 模块提供此功能</p><p>官方帮助：http://nginx.org/en/docs/http/ngx_http_auth_basic_module.html</p><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#CentOS安装包</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos8 ~<span style=color:#f92672>]</span><span style=color:#75715e>#yum -y install httpd-tools</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Ubuntu安装包</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@Ubuntu ~<span style=color:#f92672>]</span><span style=color:#75715e>#apt -y install apache2-utils</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#创建用户</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#-b 非交互式方式提交密码</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#-c 重新生成文件，覆盖已有文件。首次创建时使用</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># htpasswd -bc /apps/nginx/conf/.htpasswd user1 passwd1</span>
</span></span><span style=display:flex><span>Adding password <span style=color:#66d9ef>for</span> user user1
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># htpasswd -b /apps/nginx/conf/.htpasswd user2 passwd2</span>
</span></span><span style=display:flex><span>Adding password <span style=color:#66d9ef>for</span> user user2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#生成了带有两个用户的验证文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># tail /apps/nginx/conf/.htpasswd </span>
</span></span><span style=display:flex><span>user1:$apr1$vzRe30iJ$jF8BZbra6pI8O0JBqlmiP/
</span></span><span style=display:flex><span>user2:$apr1$i2ON7LYs$pxzkeH.xxCdgj670m5cSW/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#网站登录页面配置</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/html/index.html </span>
</span></span><span style=display:flex><span>hello
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf.d/pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  location /login <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    alias html/;
</span></span><span style=display:flex><span>    index index.html;
</span></span><span style=display:flex><span>    auth_basic <span style=color:#e6db74>&#34;login password&#34;</span>;  <span style=color:#75715e>#指定提示文本信息</span>
</span></span><span style=display:flex><span>    auth_basic_user_file /apps/nginx/conf/.htpasswd;  <span style=color:#75715e>#指定使用的验证文件</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#直接访问登录页，失败。未通过验证</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># curl pc.test.org/login/</span>
</span></span><span style=display:flex><span>&lt;html&gt;
</span></span><span style=display:flex><span>&lt;head&gt;&lt;title&gt;401 Authorization Required&lt;/title&gt;&lt;/head&gt;
</span></span><span style=display:flex><span>&lt;body&gt;
</span></span><span style=display:flex><span>&lt;center&gt;&lt;h1&gt;401 Authorization Required&lt;/h1&gt;&lt;/center&gt;
</span></span><span style=display:flex><span>&lt;hr&gt;&lt;center&gt;nginx/1.18.0&lt;/center&gt;
</span></span><span style=display:flex><span>&lt;/body&gt;
</span></span><span style=display:flex><span>&lt;/html&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##分别使用两种方式输入用户名和密码验证</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># curl http://user1:passwd1@pc.test.org/login/</span>
</span></span><span style=display:flex><span>hello
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># curl -u user2:passwd2 pc.test.org/login/</span>
</span></span><span style=display:flex><span>hello
</span></span></code></pre></div><h3 id=自定义错误页面>自定义错误页面<a hidden class=anchor aria-hidden=true href=#自定义错误页面>#</a></h3><p>自定义错误页，同时也可以用指定的响应状态码进行响应, 可在如下语句块配置：http, server, location, if in</p><p>location</p><p>格式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tex data-lang=tex><span style=display:flex><span>error_page code ... [=[response]] uri;
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 准备站点配置</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf.d/pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  error_page <span style=color:#ae81ff>404</span> <span style=color:#ae81ff>400</span>  /error.html;   <span style=color:#75715e>#访问不存在的页面，发生404错误，返回error.html错误页面</span>
</span></span><span style=display:flex><span>  location /error.html <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    root html/;
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#准备错误页面</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/html/error.html </span>
</span></span><span style=display:flex><span>error-page
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># nginx -s reload</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#访问不存在的页面，触发404报错</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># curl -I pc.test.org/dd</span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>404</span> Not Found   <span style=color:#75715e>#查看错误码</span>
</span></span><span style=display:flex><span>Server: nginx/1.18.0
</span></span><span style=display:flex><span>Date: Fri, <span style=color:#ae81ff>29</span> Jul <span style=color:#ae81ff>2022</span> 17:02:12 GMT
</span></span><span style=display:flex><span>Content-Type: text/html
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>11</span>
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span><span style=display:flex><span>Keep-Alive: timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>66</span>
</span></span><span style=display:flex><span>ETag: <span style=color:#e6db74>&#34;62e411d9-b&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#触发404错误，返回错误页面（如果是浏览器测试，建议用google）</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># curl pc.test.org/dd</span>
</span></span><span style=display:flex><span>error-page
</span></span></code></pre></div><p>范例：如果发生404 ，将错误码定义为502，且跳转到主页/index.html</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#站点配置</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf.d/pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  error_page 404 <span style=color:#f92672>=</span><span style=color:#ae81ff>502</span>  /index.html;
</span></span><span style=display:flex><span>  location /index.html <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    root html/;
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#主页配置</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/html/index.html </span>
</span></span><span style=display:flex><span>hello
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># nginx -s reload</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># curl pc.test.org/dd/</span>
</span></span><span style=display:flex><span>hello
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#验证错误码</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># curl pc.test.org/dd/ -I</span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>502</span> Bad Gateway  <span style=color:#75715e>#错误码为自定义的502</span>
</span></span><span style=display:flex><span>Server: nginx/1.18.0
</span></span><span style=display:flex><span>Date: Fri, <span style=color:#ae81ff>29</span> Jul <span style=color:#ae81ff>2022</span> 17:31:49 GMT
</span></span><span style=display:flex><span>Content-Type: text/html
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span><span style=display:flex><span>Keep-Alive: timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>66</span>
</span></span><span style=display:flex><span>ETag: <span style=color:#e6db74>&#34;62e40fa4-6&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#重定向成功</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/html/index.html </span>
</span></span><span style=display:flex><span>hello
</span></span></code></pre></div><h3 id=自定义错误日志>自定义错误日志<a hidden class=anchor aria-hidden=true href=#自定义错误日志>#</a></h3><p>错误日志格式</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Syntax: error_log file <span style=color:#f92672>[</span>level<span style=color:#f92672>]</span>;  <span style=color:#75715e>#格式</span>
</span></span><span style=display:flex><span>Default: 	<span style=color:#75715e>#默认值</span>
</span></span><span style=display:flex><span>error_log logs/error.log error;  
</span></span><span style=display:flex><span>Context: main, http, mail, stream, server, location  <span style=color:#75715e>#可配置的语句块</span>
</span></span><span style=display:flex><span>level: debug, info, notice, warn, error, crit, alert, emerg  <span style=color:#75715e>#日志记录等级</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#站点配置</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf.d/pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  error_page <span style=color:#ae81ff>404</span> <span style=color:#ae81ff>400</span>  /error.html;
</span></span><span style=display:flex><span>  access_log /apps/nginx/logs/test-access.log;  <span style=color:#75715e>#自定义正常访问日志</span>
</span></span><span style=display:flex><span>  error_log /apps/nginx/logs/test-error.log;   <span style=color:#75715e>#自定义错误日志</span>
</span></span><span style=display:flex><span>  location /error.html <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    root html/;
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#当前已有日志文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># ls /apps/nginx/logs/</span>
</span></span><span style=display:flex><span>access.log  error.log  nginx.pid
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#重启nginx后生成自定义的错误日志</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># nginx -s reload</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># ls /apps/nginx/logs/</span>
</span></span><span style=display:flex><span>access.log  error.log  nginx.pid  test-access.log  test-error.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#访问站点</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># curl pc.test.org</span>
</span></span><span style=display:flex><span>hello
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#日志成功记录</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># tail /apps/nginx/logs/{test-access,test-error}.log</span>
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>&gt; /apps/nginx/logs/test-access.log &lt;<span style=color:#f92672>==</span>
</span></span><span style=display:flex><span>172.16.16.88 - - <span style=color:#f92672>[</span>30/Jul/2022:01:17:55 +0800<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET / HTTP/1.1&#34;</span> <span style=color:#ae81ff>200</span> <span style=color:#ae81ff>6</span> <span style=color:#e6db74>&#34;-&#34;</span> <span style=color:#e6db74>&#34;curl/7.29.0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>&gt; /apps/nginx/logs/test-error.log &lt;<span style=color:#f92672>==</span>
</span></span></code></pre></div><h3 id=检测文件是否存在>检测文件是否存在<a hidden class=anchor aria-hidden=true href=#检测文件是否存在>#</a></h3><p>try_files会按顺序检查文件是否存在，返回第一个找到的文件或文件夹（结尾加斜线表示为文件夹），如</p><p>果所有文件或文件夹都找不到，会进行一个内部重定向到最后一个参数。只有最后一个参数可以引起一</p><p>个内部重定向，之前的参数只设置内部URI的指向。最后一个参数是回退URI且必须存在，否则会出现内</p><p>部500错误。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Syntax: try_files file ... uri;
</span></span><span style=display:flex><span>try_files file ... <span style=color:#f92672>=</span>code;
</span></span><span style=display:flex><span>Default: —
</span></span><span style=display:flex><span>Context: server, location
</span></span></code></pre></div><p>范例: 如果不存在页面, 就转到default.html页面</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#准备站点配置</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf.d/pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      root html/;
</span></span><span style=display:flex><span>      index index.html;
</span></span><span style=display:flex><span>      try_files $uri $uri.html $uri/index.html /about/default.html;
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#准备默认页面</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost html<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/html/default.html </span>
</span></span><span style=display:flex><span>default
</span></span><span style=display:flex><span><span style=color:#75715e>#访问测试</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/html/about/default.html </span>
</span></span><span style=display:flex><span>about_page
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># curl pc.test.org/xx/</span>
</span></span><span style=display:flex><span>about_page
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># curl pc.test.org/xx.html</span>
</span></span><span style=display:flex><span>about_page
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##自定义响应码</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf.d/pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      root html/;
</span></span><span style=display:flex><span>      index index.html;
</span></span><span style=display:flex><span>      try_files $uri $uri.html $uri/index.html <span style=color:#f92672>=</span>555;  <span style=color:#75715e>#自定义响应码为555</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#验证结果</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># curl pc.test.org/xx.html -I</span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>555</span>   <span style=color:#75715e>#响应码为555</span>
</span></span><span style=display:flex><span>Server: nginx/1.18.0
</span></span><span style=display:flex><span>Date: Mon, <span style=color:#ae81ff>01</span> Aug <span style=color:#ae81ff>2022</span> 10:00:03 GMT
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span><span style=display:flex><span>Keep-Alive: timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>66</span>
</span></span></code></pre></div><h3 id=长连接配置>长连接配置<a hidden class=anchor aria-hidden=true href=#长连接配置>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tex data-lang=tex><span style=display:flex><span>keepalive_timeout timeout [header_timeout];  #设定保持连接超时时长，0表示禁止长连接，默认为75s，通常配置在http字段作为站点全局配置
</span></span><span style=display:flex><span>keepalive_requests number;  #在一次长连接上所允许请求的资源的最大数量，默认为100次,建议适
</span></span><span style=display:flex><span>当调大,比如:500
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#站点主配置项</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf/nginx.conf | grep keepalive</span>
</span></span><span style=display:flex><span>    keepalive_requests 3;
</span></span><span style=display:flex><span>    keepalive_timeout <span style=color:#ae81ff>65</span> 60;
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/html/index.html </span>
</span></span><span style=display:flex><span>hello
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#长连接测试</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># telnet localhost 80</span>
</span></span><span style=display:flex><span>Trying ::1...
</span></span><span style=display:flex><span>telnet: connect to address ::1: Connection refused
</span></span><span style=display:flex><span>Trying 127.0.0.1...
</span></span><span style=display:flex><span>Connected to localhost.
</span></span><span style=display:flex><span>Escape character is <span style=color:#e6db74>&#39;^]&#39;</span>.
</span></span><span style=display:flex><span>GET / HTTP/1.1      <span style=color:#75715e>#发起get请求，重复三次或者时间到达65秒后，本次链接自动终止</span>
</span></span><span style=display:flex><span>HOST: localhost     <span style=color:#75715e>#域名为localhost</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>Server: nginx/1.18.0
</span></span><span style=display:flex><span>Date: Mon, <span style=color:#ae81ff>01</span> Aug <span style=color:#ae81ff>2022</span> 11:03:09 GMT
</span></span><span style=display:flex><span>Content-Type: text/html
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>Last-Modified: Fri, <span style=color:#ae81ff>29</span> Jul <span style=color:#ae81ff>2022</span> 16:49:40 GMT
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span><span style=display:flex><span>Keep-Alive: timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>  <span style=color:#75715e>#显示的超时时间</span>
</span></span><span style=display:flex><span>ETag: <span style=color:#e6db74>&#34;62e40fa4-6&#34;</span>
</span></span><span style=display:flex><span>Accept-Ranges: bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hello    <span style=color:#75715e>#返回的页面内容    </span>
</span></span></code></pre></div><h3 id=作为下载服务器>作为下载服务器<a hidden class=anchor aria-hidden=true href=#作为下载服务器>#</a></h3><p>ngx_http_autoindex_module 模块处理以斜杠字符 &ldquo;/&rdquo; 结尾的请求，并生成目录列表,可以做为下载服务</p><p>配置使用</p><p>官方链接：http://nginx.org/en/docs/http/ngx_http_autoindex_module.html</p><p>相关指令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>autoindex on | off; <span style=color:#75715e>#自动文件索引功能，默为off</span>
</span></span><span style=display:flex><span>autoindex_exact_size on | off;  #计算文件精确大小（单位bytes），off 显示大概大小（单位K、M<span style=color:#f92672>)</span>，默认on
</span></span><span style=display:flex><span>autoindex_localtime on | off ; <span style=color:#75715e>#显示本机时间而非GMT(格林威治)时间，默认off</span>
</span></span><span style=display:flex><span>autoindex_format html | xml | json | jsonp; <span style=color:#75715e>#显示索引的页面文件风格，默认html</span>
</span></span><span style=display:flex><span>limit_rate rate; <span style=color:#75715e>#限制响应客户端传输速率(除GET和HEAD以外的所有方法)，单位B/s,即bytes/second，默认值0,表示无限制,此指令由ngx_http_core_module提供</span>
</span></span><span style=display:flex><span>set $limit_rate 4k; <span style=color:#75715e>#也可以通变量限速,单位B/s,同时设置,此项优级高于limit_rate</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>###Rate limit can also be set in the $limit_rate variable, however, since version 1.17.0, this method is not recommended:</span>
</span></span></code></pre></div><p>范例：将nginx作为下载服务器</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#注意:download不需要index.html文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos8 ~<span style=color:#f92672>]</span><span style=color:#75715e># mkdir -p /data/nginx/html/pc/download</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># touch /apps/nginx/html/download/{t1,t2,t3}.txt</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># mkdir /apps/nginx/html/download/{d1,d2,d3}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># tree /apps/nginx/html/download</span>
</span></span><span style=display:flex><span>/apps/nginx/html/download
</span></span><span style=display:flex><span>├── d1
</span></span><span style=display:flex><span>├── d2
</span></span><span style=display:flex><span>├── d3
</span></span><span style=display:flex><span>├── t1.txt
</span></span><span style=display:flex><span>├── t2.txt
</span></span><span style=display:flex><span>└── t3.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span> directories, <span style=color:#ae81ff>3</span> files
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos8 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf.d/pc.conf</span>
</span></span><span style=display:flex><span> location /download <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   autoindex on;    #自动索引功能
</span></span><span style=display:flex><span>   autoindex_exact_size   off; <span style=color:#75715e>#计算文件确切大小（单位bytes），此为默认值,off只显示大概大</span>
</span></span><span style=display:flex><span>小（单位kb、mb、gb）  
</span></span><span style=display:flex><span>   autoindex_localtime   off; <span style=color:#75715e>#on表示显示本机时间而非GMT(格林威治)时间,默为为off显示GMT</span>
</span></span><span style=display:flex><span>时间
</span></span><span style=display:flex><span>   limit_rate 1024k;   <span style=color:#75715e>#限速,默认不限速</span>
</span></span><span style=display:flex><span>   root html/;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><strong>结果验证</strong></p><p><img loading=lazy src=Nginx%e6%a0%b8%e5%bf%83%e9%85%8d%e7%bd%ae/image-20220801113728007.png alt=image-20220801113728007></p><h3 id=作为上传服务器>作为上传服务器<a hidden class=anchor aria-hidden=true href=#作为上传服务器>#</a></h3><p>相关指令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>client_max_body_size 1m; <span style=color:#75715e>#设置允许客户端上传单个文件大小的上限值，默认值为1m,上传文件超过此值会出413错误</span>
</span></span><span style=display:flex><span>client_body_buffer_size size; <span style=color:#75715e>#用于接收每个客户端请求报文的body部分的缓冲区大小;默认16k;超出此大小时，其将被暂存到磁盘上的由client_body_temp_path指令所定义的位置</span>
</span></span><span style=display:flex><span>client_body_temp_path path <span style=color:#f92672>[</span>level1 <span style=color:#f92672>[</span>level2 <span style=color:#f92672>[</span>level3<span style=color:#f92672>]]]</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>#设定存储客户端请求报文的body部分的临时存储路径及子目录结构和数量，目录名为16进制的数字，使用hash之后的值从后往前截取1位、2位、2位作为目录名</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos8 ~<span style=color:#f92672>]</span><span style=color:#75715e># md5sum /data/nginx/html/pc/index.html </span>
</span></span><span style=display:flex><span>95f6f65f498c74938064851b1bb <span style=color:#ae81ff>96</span> 3d <span style=color:#ae81ff>4</span> /data/nginx/html/pc/index.html
</span></span><span style=display:flex><span>1级目录占1位16进制，即2^4<span style=color:#f92672>=</span>16个目录  0-f
</span></span><span style=display:flex><span>2级目录占2位16进制，即2^8<span style=color:#f92672>=</span>256个目录 00-ff
</span></span><span style=display:flex><span>3级目录占2位16进制，即2^8<span style=color:#f92672>=</span>256个目录 00-ff
</span></span><span style=display:flex><span><span style=color:#75715e>#配置示例：</span>
</span></span><span style=display:flex><span>client_max_body_size 100m; <span style=color:#75715e>#如果太大，上传时会出现413错误。注意:如果php上传（如WordPress）,还需要修改/etc/php.ini的相关配置</span>
</span></span><span style=display:flex><span>client_body_buffer_size 1024k;
</span></span><span style=display:flex><span>client_body_temp_path   /apps/nginx/client_body_temp/ <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> 2; <span style=color:#75715e>#上传时,Nginx会自动创建相关目录</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##上传文件后,会自动生成相关目录</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@wang-liyun-pc ~<span style=color:#f92672>]</span><span style=color:#75715e># tree /apps/nginx/client_body_temp/</span>
</span></span><span style=display:flex><span>/apps/nginx/client_body_temp/
</span></span><span style=display:flex><span>├── <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>│   └── <span style=color:#ae81ff>00</span>
</span></span><span style=display:flex><span>│       └── <span style=color:#ae81ff>00</span>
</span></span><span style=display:flex><span>└── <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>   └── <span style=color:#ae81ff>00</span>
</span></span><span style=display:flex><span>       └── <span style=color:#ae81ff>00</span>
</span></span></code></pre></div><h3 id=其他配置>其他配置<a hidden class=anchor aria-hidden=true href=#其他配置>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>keepalive_disable none | browser ...;  #对哪种浏览器禁用长连接
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>limit_except method ... <span style=color:#f92672>{</span> ... <span style=color:#f92672>}</span> <span style=color:#75715e>#仅用于location语句块，禁止客户端使用除了指定的请求方法之外的其它方法, 如果使用会出现403错误</span>
</span></span><span style=display:flex><span>method:GET, HEAD, POST, PUT, DELETE，MKCOL, COPY, MOVE, OPTIONS, PROPFIND, PROPPATCH, LOCK, UNLOCK, PATCH
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##示例：除了GET之外的其它方法仅允许172.16.16.0/24网段主机使用</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># hostname -I  #本机IP</span>
</span></span><span style=display:flex><span>172.16.16.88 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># ll /apps/nginx/html/upload/  #新建upload目录用于存储上传的文件</span>
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf.d/pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  location /upload <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      root html/;
</span></span><span style=display:flex><span>	  index index.html;
</span></span><span style=display:flex><span> 	  limit_except GET <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      	  allow 172.16.16.88;
</span></span><span style=display:flex><span>	      deny all;
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># nginx -s reload</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># curl -XPUT /etc/issue pc.test.org/upload</span>
</span></span><span style=display:flex><span>curl: <span style=color:#f92672>(</span>3<span style=color:#f92672>)</span> &lt;url&gt; malformed
</span></span><span style=display:flex><span>&lt;html&gt;
</span></span><span style=display:flex><span>&lt;head&gt;&lt;title&gt;405 Not Allowed&lt;/title&gt;&lt;/head&gt;  <span style=color:#75715e>#PUT方法具有访问权限，但是程序本身不支持文件上传功能</span>
</span></span><span style=display:flex><span>&lt;body&gt;
</span></span><span style=display:flex><span>&lt;center&gt;&lt;h1&gt;405 Not Allowed&lt;/h1&gt;&lt;/center&gt;
</span></span><span style=display:flex><span>&lt;hr&gt;&lt;center&gt;nginx/1.18.0&lt;/center&gt;
</span></span><span style=display:flex><span>&lt;/body&gt;
</span></span><span style=display:flex><span>&lt;/html&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf.d/pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  location /upload <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        root html/;
</span></span><span style=display:flex><span>	index index.html;
</span></span><span style=display:flex><span> 	limit_except GET <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>#allow 172.16.16.88;  #禁止所有主机使用GET以外的方法</span>
</span></span><span style=display:flex><span>	    deny all;
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost ~<span style=color:#f92672>]</span><span style=color:#75715e># curl -XPUT /etc/issue pc.test.org/upload</span>
</span></span><span style=display:flex><span>curl: <span style=color:#f92672>(</span>3<span style=color:#f92672>)</span> &lt;url&gt; malformed
</span></span><span style=display:flex><span>&lt;html&gt;
</span></span><span style=display:flex><span>&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt; <span style=color:#75715e>#再次访问测试，nginx拒绝访问</span>
</span></span><span style=display:flex><span>&lt;body&gt;
</span></span><span style=display:flex><span>&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;
</span></span><span style=display:flex><span>&lt;hr&gt;&lt;center&gt;nginx/1.18.0&lt;/center&gt;
</span></span><span style=display:flex><span>&lt;/body&gt;
</span></span><span style=display:flex><span>&lt;/html&gt;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aio on | off  #是否启用asynchronous file I/O<span style=color:#f92672>(</span>AIO<span style=color:#f92672>)</span>功能，需要编译时添加参数开启 --with-file-aio
</span></span><span style=display:flex><span><span style=color:#75715e>#linux 2.6以上内核提供以下几个系统调用来支持aio： 1、SYS_io_setup：建立aio 的context</span>
</span></span><span style=display:flex><span>2、SYS_io_submit: 提交I/O操作请求
</span></span><span style=display:flex><span>3、SYS_io_getevents：获取已完成的I/O事件
</span></span><span style=display:flex><span>4、SYS_io_cancel：取消I/O操作请求
</span></span><span style=display:flex><span>5、SYS_io_destroy：毁销aio的context
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>directio size | off; <span style=color:#75715e>#操作完全和aio相反，aio是读取文件而directio是写文件到磁盘，默认为关闭，当文件大于等于给定大小时，例如:directio 4m，同步（直接）写磁盘，而非写缓存。</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>open_file_cache off;  #是否缓存打开过的文件信息
</span></span><span style=display:flex><span>open_file_cache max<span style=color:#f92672>=</span>N <span style=color:#f92672>[</span>inactive<span style=color:#f92672>=</span>time<span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#nginx可以缓存以下三种信息：</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>1<span style=color:#f92672>)</span> 文件元数据：文件的描述符、文件大小和最近一次的修改时间
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>2<span style=color:#f92672>)</span> 打开的目录结构
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>3<span style=color:#f92672>)</span> 没有找到的或者没有权限访问的文件的相关信息 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>max<span style=color:#f92672>=</span>N：#可缓存的缓存项上限数量;达到上限后会使用LRU<span style=color:#f92672>(</span>Least recently used，最近最少使用<span style=color:#f92672>)</span>算法实现管理
</span></span><span style=display:flex><span>inactive<span style=color:#f92672>=</span>time：#缓存项的非活动时长，在此处指定的时长内未被命中的或命中的次数少于
</span></span><span style=display:flex><span>open_file_cache_min_uses <span style=color:#75715e>#指令所指定的次数的缓存项即为非活动项，将被删除</span>
</span></span><span style=display:flex><span>open_file_cache_valid time; <span style=color:#75715e>#缓存项有效性的检查验证频率，默认值为60s </span>
</span></span><span style=display:flex><span>open_file_cache_errors on | off; <span style=color:#75715e>#是否缓存查找时发生错误的文件一类的信息,默认值为off</span>
</span></span><span style=display:flex><span>open_file_cache_min_uses number; <span style=color:#75715e>#open_file_cache指令的inactive参数指定的时长内，至少被命中此处指定的次数方可被归类为活动项,默认值为1</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>open_file_cache max<span style=color:#f92672>=</span><span style=color:#ae81ff>10000</span> inactive<span style=color:#f92672>=</span>60s; <span style=color:#75715e>#最大缓存10000个文件，非活动数据超时时长60s</span>
</span></span><span style=display:flex><span>open_file_cache_valid   60s;  #每间隔60s检查一下缓存数据有效性
</span></span><span style=display:flex><span>open_file_cache_min_uses 5; <span style=color:#75715e>#60秒内至少被命中访问5次才被标记为活动数据</span>
</span></span><span style=display:flex><span>open_file_cache_errors   on; <span style=color:#75715e>#缓存错误信息</span>
</span></span></code></pre></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://senmer.github.io/posts/tech/nginx/nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/><span class=title>« 上一页</span><br><span>Nginx高级配置</span></a>
<a class=next href=https://senmer.github.io/posts/tech/nginx/nginx%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7/><span class=title>下一页 »</span><br><span>Nginx平滑升级和回滚</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Nginx核心配置 on twitter" href="https://twitter.com/intent/tweet/?text=Nginx%e6%a0%b8%e5%bf%83%e9%85%8d%e7%bd%ae&amp;url=https%3a%2f%2fsenmer.github.io%2fposts%2ftech%2fnginx%2fnginx%25E6%25A0%25B8%25E5%25BF%2583%25E9%2585%258D%25E7%25BD%25AE%2f&amp;hashtags=Nginx"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Nginx核心配置 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsenmer.github.io%2fposts%2ftech%2fnginx%2fnginx%25E6%25A0%25B8%25E5%25BF%2583%25E9%2585%258D%25E7%25BD%25AE%2f&amp;title=Nginx%e6%a0%b8%e5%bf%83%e9%85%8d%e7%bd%ae&amp;summary=Nginx%e6%a0%b8%e5%bf%83%e9%85%8d%e7%bd%ae&amp;source=https%3a%2f%2fsenmer.github.io%2fposts%2ftech%2fnginx%2fnginx%25E6%25A0%25B8%25E5%25BF%2583%25E9%2585%258D%25E7%25BD%25AE%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Nginx核心配置 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fsenmer.github.io%2fposts%2ftech%2fnginx%2fnginx%25E6%25A0%25B8%25E5%25BF%2583%25E9%2585%258D%25E7%25BD%25AE%2f&title=Nginx%e6%a0%b8%e5%bf%83%e9%85%8d%e7%bd%ae"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Nginx核心配置 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsenmer.github.io%2fposts%2ftech%2fnginx%2fnginx%25E6%25A0%25B8%25E5%25BF%2583%25E9%2585%258D%25E7%25BD%25AE%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Nginx核心配置 on whatsapp" href="https://api.whatsapp.com/send?text=Nginx%e6%a0%b8%e5%bf%83%e9%85%8d%e7%bd%ae%20-%20https%3a%2f%2fsenmer.github.io%2fposts%2ftech%2fnginx%2fnginx%25E6%25A0%25B8%25E5%25BF%2583%25E9%2585%258D%25E7%25BD%25AE%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Nginx核心配置 on telegram" href="https://telegram.me/share/url?text=Nginx%e6%a0%b8%e5%bf%83%e9%85%8d%e7%bd%ae&amp;url=https%3a%2f%2fsenmer.github.io%2fposts%2ftech%2fnginx%2fnginx%25E6%25A0%25B8%25E5%25BF%2583%25E9%2585%258D%25E7%25BD%25AE%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></div><style>.comments_details summary::marker{font-size:20px;content:'👉展开评论';color:var(--content)}.comments_details[open] summary::marker{font-size:20px;content:'👇关闭评论';color:var(--content)}</style><div><details class=comments_details><summary style="cursor:pointer;margin:50px 0 20px;width:130px"><span style=font-size:20px;color:var(--content)>...</span></summary><div id=tcomment></div></details><script src=https://cdn.staticfile.org/twikoo/1.6.16/twikoo.all.min.js></script><script>twikoo.init({envId:"https://hugo-api-khaki.vercel.app/# 填写自己的twikoo id",el:"#tcomment",lang:"zh-CN",region:null,path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><span>Copyright
&copy;
2020-2023
<a href=https://senmer.github.io/ style=color:#939393>WZ's Blog</a>
All Rights Reserved</span>
<a href=https://beian.miit.gov.cn/ target=_blank style=color:#939393></a>&nbsp;
<span><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null" style=display:inline-block;text-decoration:none;height:20px;color:#939393><img src style="float:left;margin:0 5px 0 0"></a></span>
<span id=busuanzi_container><span class="fa fa-user"></span> <span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye"></span> <span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span></span></a>
<script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>200||document.documentElement.scrollTop>200?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{(function(){document.cookie="change-themes="+escape("false")})(),document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.body.addEventListener("copy",function(e){if(window.getSelection().toString()&&window.getSelection().toString().length>50){let t=e.clipboardData||window.clipboardData;if(t){e.preventDefault();let n=window.getSelection().toString()+`

————————————————
版权声明：本文为「WZ's Blog」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：`+location.href,s=window.getSelection().toString()+`

————————————————
版权声明：本文为「WZ's Blog」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：`+location.href;t.setData("text/html",n),t.setData("text/plain",s)}}})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="复制";function i(){t.innerText="已复制！",setTimeout(()=>{t.innerText="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){let t=e.textContent+`
————————————————
版权声明：本文为「WZ's Blog」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：`+location.href;navigator.clipboard.writeText(t),i();return}const n=document.createRange();n.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(n);try{document.execCommand("copy"),i()}catch{}s.removeRange(n)});let l=e.className.replaceAll("language-",""),n=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),o=document.createElement("div");o.innerText=l,n.setAttribute("class","mac-tool"),a.setAttribute("class","mac bb1"),r.setAttribute("class","mac bb2"),c.setAttribute("class","mac bb3"),o.setAttribute("class","language-type"),n.appendChild(a),n.appendChild(r),n.appendChild(c),n.appendChild(o),s.classList.contains("highlight")?(s.appendChild(t),s.appendChild(n)):s.parentNode.firstChild==s||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?(e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t),s.appendChild(n)):(e.parentNode.appendChild(t),s.appendChild(n)))})</script><script>$("code[class^=language] ").on("mouseover",function(){this.clientWidth<this.scrollWidth&&($(this).css("width","135%"),$(this).css("border-top-right-radius","var(--radius)"))}).on("mouseout",function(){$(this).css("width","100%"),$(this).css("border-top-right-radius","unset")})</script></body></html>