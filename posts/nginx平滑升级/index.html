<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Nginx平滑升级和回滚 - 我的全新 Hugo 网站</title><meta name=Description content="This is my cool site"><meta property="og:title" content="Nginx平滑升级和回滚"><meta property="og:description" content="利用Nginx信号实现平滑升级"><meta property="og:type" content="article"><meta property="og:url" content="http://example.org/posts/nginx%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-20T16:41:28+00:00"><meta property="article:modified_time" content="2022-07-20T16:41:28+00:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="Nginx平滑升级和回滚"><meta name=twitter:description content="利用Nginx信号实现平滑升级"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://example.org/posts/nginx%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7/><link rel=prev href=http://example.org/posts/nginx%E5%AE%89%E8%A3%85%E8%84%9A%E6%9C%AC/><link rel=next href=http://example.org/posts/nginx%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Nginx平滑升级和回滚","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/example.org\/posts\/nginx%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7\/"},"genre":"posts","keywords":"升级、回滚","wordcount":2967,"url":"http:\/\/example.org\/posts\/nginx%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7\/","datePublished":"2022-07-20T16:41:28+00:00","dateModified":"2022-07-20T16:41:28+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"作者"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="我的全新 Hugo 网站">My cool site</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="我的全新 Hugo 网站">My cool site</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Nginx平滑升级和回滚</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>作者</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/nginx/><i class="far fa-folder fa-fw" aria-hidden=true></i>Nginx</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-07-20>2022-07-20</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 2967 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 6 分钟&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#nginx-命令>Nginx 命令</a></li><li><a href=#quit-信号>quit 信号</a></li><li><a href=#reload-信号>reload 信号</a></li><li><a href=#reopen信号>reopen信号</a></li></ul><ul><li><a href=#平滑升级流程>平滑升级流程</a></li><li><a href=#平滑升级和回滚案例>平滑升级和回滚案例</a></li></ul></nav></div></div><div class=content id=content><h1 id=利用nginx信号实现平滑升级>利用Nginx信号实现平滑升级</h1><h1 id=nginx-命令和信号>Nginx 命令和信号</h1><h2 id=nginx-命令>Nginx 命令</h2><p>可以通过nginx命令向nginx进程发送信号，实现各种功能</p><p>nginx 命令格式</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nginx <span class=o>[</span>-?hvVtTq<span class=o>]</span> <span class=o>[</span>-s signal<span class=o>]</span> <span class=o>[</span>-c filename<span class=o>]</span> <span class=o>[</span>-p prefix<span class=o>]</span> <span class=o>[</span>-g directives<span class=o>]</span>
</span></span></code></pre></div><p>选项说明</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tex data-lang=tex><span class=line><span class=cl>帮助: -? -h
</span></span><span class=line><span class=cl>使用指定的配置文件: -c
</span></span><span class=line><span class=cl>指定配置指令:-g
</span></span><span class=line><span class=cl>指定运行目录:-p
</span></span><span class=line><span class=cl>测试配置文件是否有语法错误:-t -T
</span></span><span class=line><span class=cl>打印nginx的版本信息、编译信息等:-v -V
</span></span><span class=line><span class=cl>发送信号: -s 示例: nginx -s reload
</span></span></code></pre></div><p>信号说明</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tex data-lang=tex><span class=line><span class=cl>立刻停止服务:stop,相当于信号SIGTERM,SIGINT
</span></span><span class=line><span class=cl>优雅的停止服务:quit,相当于信号SIGQUIT
</span></span><span class=line><span class=cl>平滑重启，重新加载配置文件: reload,相当于信号SIGHUP
</span></span><span class=line><span class=cl>重新开始记录日志文件:reopen,相当于信号SIGUSR1,在切割日志时用途较大
</span></span><span class=line><span class=cl>平滑升级可执行程序:发送信号SIGUSR2,在升级版本时使用
</span></span><span class=line><span class=cl>优雅的停止工作进程:发送信号SIGWINCH,在升级版本时使用
</span></span></code></pre></div><p>范例：查看nginx 使用帮助</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># nginx -h</span>
</span></span><span class=line><span class=cl>nginx version: nginx/1.18.0
</span></span><span class=line><span class=cl>Usage: nginx <span class=o>[</span>-?hvVtTq<span class=o>]</span> <span class=o>[</span>-s signal<span class=o>]</span> <span class=o>[</span>-c filename<span class=o>]</span> <span class=o>[</span>-p prefix<span class=o>]</span> <span class=o>[</span>-g directives<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Options:
</span></span><span class=line><span class=cl>  -?,-h         : this <span class=nb>help</span>
</span></span><span class=line><span class=cl>  -v            : show version and <span class=nb>exit</span>
</span></span><span class=line><span class=cl>  -V            : show version and configure options <span class=k>then</span> <span class=nb>exit</span>
</span></span><span class=line><span class=cl>  -t            : <span class=nb>test</span> configuration and <span class=nb>exit</span>
</span></span><span class=line><span class=cl>  -T            : <span class=nb>test</span> configuration, dump it and <span class=nb>exit</span>
</span></span><span class=line><span class=cl>  -q            : suppress non-error messages during configuration testing
</span></span><span class=line><span class=cl>  -s signal     : send signal to a master process: stop, quit, reopen, reload
</span></span><span class=line><span class=cl>  -p prefix     : <span class=nb>set</span> prefix path <span class=o>(</span>default: /apps/nginx/<span class=o>)</span>
</span></span><span class=line><span class=cl>  -c filename   : <span class=nb>set</span> configuration file <span class=o>(</span>default: conf/nginx.conf<span class=o>)</span>
</span></span><span class=line><span class=cl>  -g directives : <span class=nb>set</span> global directives out of configuration file
</span></span></code></pre></div><h2 id=quit-信号>quit 信号</h2><p><strong>quit信号运行流程</strong></p><ol><li>设置定时器: worker_shutdown_timeout #一定时间后关闭work进程，防止超时。</li><li>关闭监听句柄。 #不再接收新的连接请求</li><li>关闭空闲连接</li><li>在循环中等待全部连接关闭 #待连接任务执行完毕后关闭连接</li><li>退出nginx所有进程</li></ol><p><strong>范例：quit 信号停止nginx进程</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@centos7 html<span class=o>]</span><span class=c1># pwd  #进入nginx安装目录下</span>
</span></span><span class=line><span class=cl>/apps/nginx/html
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 html<span class=o>]</span><span class=c1># dd if=/dev/zero of=/apps/nginx/html/bigfile bs=1M count=1024  #生成1G的大文件bigfile</span>
</span></span><span class=line><span class=cl>1024+0 records in
</span></span><span class=line><span class=cl>1024+0 records out
</span></span><span class=line><span class=cl><span class=m>1073741824</span> bytes <span class=o>(</span>1.1 GB<span class=o>)</span> copied, 6.78492 s, <span class=m>158</span> MB/s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 html<span class=o>]</span><span class=c1># ll -h bigfile </span>
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> root root 1.0G Jul <span class=m>21</span> 17:37 bigfile
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 html<span class=o>]</span><span class=c1># hostname -I   #Nginx服务器地址</span>
</span></span><span class=line><span class=cl>172.16.16.88
</span></span></code></pre></div><p><img class=lazyload src=/svg/loading.min.svg data-src=Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/image-20220721094628824.png data-srcset="Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/image-20220721094628824.png, Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/image-20220721094628824.png 1.5x, Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/image-20220721094628824.png 2x" data-sizes=auto alt=Nginx平滑升级/image-20220721094628824.png title=image-20220721094628824></p><h2 id=reload-信号>reload 信号</h2><p><strong>reload信号运行流程</strong></p><p><img class=lazyload src=/svg/loading.min.svg data-src=Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/34.png data-srcset="Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/34.png, Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/34.png 1.5x, Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/34.png 2x" data-sizes=auto alt=Nginx平滑升级/34.png title=reload信号></p><p><img class=lazyload src=/svg/loading.min.svg data-src=Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/35.png data-srcset="Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/35.png, Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/35.png 1.5x, Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/35.png 2x" data-sizes=auto alt=Nginx平滑升级/35.png title=不停机更新配置></p><p><strong>利用 reload 可以实现平滑修改配置并生效</strong></p><ol><li>向master进程发送HUP信号(reload命令)</li><li>master进程校验配置语法是否正确</li><li>master进程打开新的监听端口</li><li>master进程用新的配置启动新的worker子进程</li><li>master进程向老worker子进程发送QUIT信号通知旧的worker处理完当前连接后退出，空闲worker旧进程不再处理新来的请求</li><li>旧worker进程关闭监听句柄，处理完当前连接后结束进程</li></ol><p><strong>范例：想nginx发送reload信号实现不停机更新配置</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># nginx  #启动nginx</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># ps -ef|grep nginx  #当前有一个master进程和一个worker进程</span>
</span></span><span class=line><span class=cl>root      <span class=m>20091</span>      <span class=m>1</span>  <span class=m>0</span> 17:51 ?        00:00:00 nginx: master process nginx
</span></span><span class=line><span class=cl>nginx     <span class=m>20092</span>  <span class=m>20091</span>  <span class=m>0</span> 17:51 ?        00:00:00 nginx: worker process
</span></span><span class=line><span class=cl>root      <span class=m>20094</span>  <span class=m>19981</span>  <span class=m>0</span> 17:51 pts/1    00:00:00 grep --color<span class=o>=</span>auto nginx
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># cat /apps/nginx/conf/nginx.conf | grep processes   #当前配置nginx的worker进程数为1</span>
</span></span><span class=line><span class=cl>worker_processes  1<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># sed -i &#39;/worker_processes/c\worker_processes 3;&#39; /apps/nginx/conf/nginx.conf #将worker_processes 的值改为3</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># grep worker_processes /apps/nginx/conf/nginx.conf</span>
</span></span><span class=line><span class=cl>worker_processes 3<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># nginx -t &amp;&amp; nginx -s reload  #检查配置并发送reload信号</span>
</span></span><span class=line><span class=cl>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok
</span></span><span class=line><span class=cl>nginx: configuration file /apps/nginx/conf/nginx.conf <span class=nb>test</span> is successful
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># ps -ef | grep nginx #nginx的worker进程数量为3</span>
</span></span><span class=line><span class=cl>root      <span class=m>20091</span>      <span class=m>1</span>  <span class=m>0</span> 17:51 ?        00:00:00 nginx: master process nginx
</span></span><span class=line><span class=cl>nginx     <span class=m>20158</span>  <span class=m>20091</span>  <span class=m>0</span> 18:05 ?        00:00:00 nginx: worker process
</span></span><span class=line><span class=cl>nginx     <span class=m>20159</span>  <span class=m>20091</span>  <span class=m>0</span> 18:05 ?        00:00:00 nginx: worker process
</span></span><span class=line><span class=cl>nginx     <span class=m>20160</span>  <span class=m>20091</span>  <span class=m>0</span> 18:05 ?        00:00:00 nginx: worker process
</span></span><span class=line><span class=cl>root      <span class=m>20162</span>  <span class=m>19981</span>  <span class=m>0</span> 18:05 pts/1    00:00:00 grep --color<span class=o>=</span>auto nginx
</span></span></code></pre></div><h2 id=reopen信号>reopen信号</h2><p><strong>reopen 信号重写日志文件</strong></p><p><strong>1、nginx 当前将日志记录在access.log文件</strong></p><p><img class=lazyload src=/svg/loading.min.svg data-src=Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/image-20220721101352816.png data-srcset="Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/image-20220721101352816.png, Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/image-20220721101352816.png 1.5x, Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/image-20220721101352816.png 2x" data-sizes=auto alt=Nginx平滑升级/image-20220721101352816.png title=image-20220721101352816></p><p><strong>2、将access.log 重命名为access.log.old，日志仍记录到access.log.old文件中（因为Nginx已持有此文件的描述符</strong>）</p><p><img class=lazyload src=/svg/loading.min.svg data-src=Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/image-20220721102109230.png data-srcset="Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/image-20220721102109230.png, Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/image-20220721102109230.png 1.5x, Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/image-20220721102109230.png 2x" data-sizes=auto alt=Nginx平滑升级/image-20220721102109230.png title=image-20220721102109230></p><p><strong>3、新建access.log文件，向nginx发送reopen信号，使得新的日志记录在新生成的文件中（用于实现日志轮转）</strong></p><p><img class=lazyload src=/svg/loading.min.svg data-src=Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/image-20220721102806088.png data-srcset="Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/image-20220721102806088.png, Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/image-20220721102806088.png 1.5x, Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/image-20220721102806088.png 2x" data-sizes=auto alt=Nginx平滑升级/image-20220721102806088.png title=image-20220721102806088></p><h1 id=nginx-平滑升级和回滚>Nginx 平滑升级和回滚</h1><p>工作中有时候需要对Nginx版本进行升级以满足对其功能的需求，例如添加新模块，需要新功能，而此时</p><p>Nginx又在运行着重要业务不能直接停掉。在此背景下可选择平滑升级nginx</p><h2 id=平滑升级流程>平滑升级流程</h2><p><img class=lazyload src=/svg/loading.min.svg data-src=Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/36.png data-srcset="Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/36.png, Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/36.png 1.5x, Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/36.png 2x" data-sizes=auto alt=Nginx平滑升级/36.png title=平滑升级></p><p><img class=lazyload src=/svg/loading.min.svg data-src=Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/37.png data-srcset="Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/37.png, Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/37.png 1.5x, Nginx%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7/37.png 2x" data-sizes=auto alt=Nginx平滑升级/37.png title=不停机更新></p><p><strong>平滑升级流程</strong></p><ol><li>将旧Nginx二进制文件换成新Nginx程序文件（注意先备份)</li><li>向master进程发送USR2信号，master进程自动修改pid文件名加上后缀.oldbin,成为nginx.pid.oldbin</li><li>master进程用新Nginx文件启动新master进程成为旧master的子进程,系统中将有新旧两个Nginx主进程，新生成的master进程的PID存放至新生成的pid文件nginx.pid</li><li>主进程共同提供Web服务,当前新的请求仍然由旧Nginx的worker进程进行处理</li><li>向旧的Nginx服务进程发送WINCH信号，使旧的Nginx worker进程平滑停止</li><li>向旧master进程发送QUIT信号，关闭老master，进程自动删除Nginx.pid.oldbin文件</li><li>如果发现升级有问题,可以回滚∶向老master发送HUP，向新master发送QUIT</li></ol><h2 id=平滑升级和回滚案例>平滑升级和回滚案例</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#当前nginx版本及安装路径</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># nginx -v </span>
</span></span><span class=line><span class=cl>nginx version: nginx/1.18.0
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx<span class=o>]</span><span class=c1># which nginx</span>
</span></span><span class=line><span class=cl>/apps/nginx/sbin/nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#获取老版本编译参数  --prefix </span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># nginx -V</span>
</span></span><span class=line><span class=cl>nginx version: nginx/1.18.0
</span></span><span class=line><span class=cl>built by gcc 4.8.5 <span class=m>20150623</span> <span class=o>(</span>Red Hat 4.8.5-44<span class=o>)</span> <span class=o>(</span>GCC<span class=o>)</span> 
</span></span><span class=line><span class=cl>built with OpenSSL 1.0.2k-fips  <span class=m>26</span> Jan <span class=m>2017</span>
</span></span><span class=line><span class=cl>TLS SNI support enabled
</span></span><span class=line><span class=cl>configure arguments: --prefix<span class=o>=</span>/apps/nginx --user<span class=o>=</span>nginx --group<span class=o>=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#下载一个较新版本，使用上一步获得的编译参数进行编译</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># wget http://nginx.org/download/nginx-1.20.1.tar.gz</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># tar xf nginx-1.20.1.tar.gz </span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># cd nginx-1.20.1/</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx-1.20.1<span class=o>]</span><span class=c1># ./configure --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx-1.20.1<span class=o>]</span><span class=c1># make  #不需要执行make install</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 nginx-1.20.1<span class=o>]</span><span class=c1># objs/nginx -v #查看编译结果</span>
</span></span><span class=line><span class=cl>nginx version: nginx/1.20.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#备份旧版nginx程序（用于回滚）</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># mv /apps/nginx/sbin/{nginx,nginx.old}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#将编译后的新版nginx拷贝到旧版安装路径下</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># cp ./nginx-1.20.1/objs/nginx /apps/nginx/sbin/</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># ll /apps/nginx/sbin/</span>
</span></span><span class=line><span class=cl>total <span class=m>15308</span>
</span></span><span class=line><span class=cl>-rwxr-xr-x <span class=m>1</span> root root <span class=m>7893488</span> Jul <span class=m>21</span> 18:49 nginx
</span></span><span class=line><span class=cl>-rwxr-xr-x <span class=m>1</span> root root <span class=m>7774224</span> Jul <span class=m>21</span> 00:17 nginx.old
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#验证替换结果</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># /apps/nginx/sbin/nginx -t</span>
</span></span><span class=line><span class=cl>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok
</span></span><span class=line><span class=cl>nginx: configuration file /apps/nginx/conf/nginx.conf <span class=nb>test</span> is successful
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># /apps/nginx/sbin/nginx -v</span>
</span></span><span class=line><span class=cl>nginx version: nginx/1.20.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#nginx 默认将pid文件存放于/app/nginx/logs/路径下</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># grep pid /apps/nginx/conf/nginx.conf</span>
</span></span><span class=line><span class=cl><span class=c1>#pid        logs/nginx.pid;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># ll /apps/nginx/logs/nginx.pid </span>
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> root root <span class=m>6</span> Jul <span class=m>21</span> 19:01 /apps/nginx/logs/nginx.pid
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#查看当前nginx进程</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># ps -ef | grep nginx</span>
</span></span><span class=line><span class=cl>root      <span class=m>23503</span>      <span class=m>1</span>  <span class=m>0</span> 19:06 ?        00:00:00 nginx: master process nginx
</span></span><span class=line><span class=cl>nginx     <span class=m>23504</span>  <span class=m>23503</span>  <span class=m>0</span> 19:06 ?        00:00:00 nginx: worker process
</span></span><span class=line><span class=cl>root      <span class=m>23545</span>  <span class=m>23521</span>  <span class=m>0</span> 19:07 pts/1    00:00:00 grep --color<span class=o>=</span>auto nginx
</span></span><span class=line><span class=cl><span class=c1>#向旧版nginx发送USR2信号</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># kill -USR2 `cat /apps/nginx/logs/nginx.pid`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#此时有两个master进程共存，其中一个master是新版nginx生成的。由新版nginx负责监听处理新的请求，旧版nginx不再处理。</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># ps -ef | grep nginx</span>
</span></span><span class=line><span class=cl>root      <span class=m>23503</span>      <span class=m>1</span>  <span class=m>0</span> 19:06 ?        00:00:00 nginx: master process nginx
</span></span><span class=line><span class=cl>nginx     <span class=m>23504</span>  <span class=m>23503</span>  <span class=m>0</span> 19:06 ?        00:00:00 nginx: worker process
</span></span><span class=line><span class=cl>root      <span class=m>23547</span>  <span class=m>23503</span>  <span class=m>0</span> 19:07 ?        00:00:00 nginx: master process nginx
</span></span><span class=line><span class=cl>nginx     <span class=m>23548</span>  <span class=m>23547</span>  <span class=m>0</span> 19:07 ?        00:00:00 nginx: worker process
</span></span><span class=line><span class=cl>root      <span class=m>23550</span>  <span class=m>23521</span>  <span class=m>0</span> 19:07 pts/1    00:00:00 grep --color<span class=o>=</span>auto nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#新版本master进程是旧版nginx进程的子进程</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># pstree -p| grep nginx</span>
</span></span><span class=line><span class=cl>           <span class=p>|</span>-nginx<span class=o>(</span>23503<span class=o>)</span>-+-nginx<span class=o>(</span>23547<span class=o>)</span>---nginx<span class=o>(</span>23548<span class=o>)</span>
</span></span><span class=line><span class=cl>           <span class=p>|</span>              <span class=sb>`</span>-nginx<span class=o>(</span>23504<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#查看端口监听情况，两个版本都在监听80端口，但实际的请求是由旧版nginx的worker进程处理</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># lsof -i :80</span>
</span></span><span class=line><span class=cl>COMMAND   PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
</span></span><span class=line><span class=cl>nginx   <span class=m>23503</span>  root    6u  IPv4 <span class=m>191644</span>      0t0  TCP *:http <span class=o>(</span>LISTEN<span class=o>)</span>
</span></span><span class=line><span class=cl>nginx   <span class=m>23504</span> nginx    6u  IPv4 <span class=m>191644</span>      0t0  TCP *:http <span class=o>(</span>LISTEN<span class=o>)</span>
</span></span><span class=line><span class=cl>nginx   <span class=m>23547</span>  root    6u  IPv4 <span class=m>191644</span>      0t0  TCP *:http <span class=o>(</span>LISTEN<span class=o>)</span>
</span></span><span class=line><span class=cl>nginx   <span class=m>23548</span> nginx    6u  IPv4 <span class=m>191644</span>      0t0  TCP *:http <span class=o>(</span>LISTEN<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#pid文件也生成了新旧两个版本</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># ll /apps/nginx/logs/</span>
</span></span><span class=line><span class=cl>total <span class=m>20</span>
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> nginx root  <span class=m>172</span> Jul <span class=m>21</span> 18:48 access.log
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> root  root  <span class=m>258</span> Jul <span class=m>21</span> 18:19 access.log.old
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> nginx root <span class=m>1879</span> Jul <span class=m>21</span> 19:07 error.log
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> root  root    <span class=m>6</span> Jul <span class=m>21</span> 19:07 nginx.pid
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> root  root    <span class=m>6</span> Jul <span class=m>21</span> 19:06 nginx.pid.oldbin
</span></span><span class=line><span class=cl>。
</span></span><span class=line><span class=cl><span class=c1>#向旧版nginx主进程发送WINCH信号，它会逐步关闭所有worker进程（主进程不退出，方便回滚），而后所有请求将由新版nginx处理</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># kill -WINCH `cat /apps/nginx/logs/nginx.pid.oldbin`</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># pstree -p| grep nginx</span>
</span></span><span class=line><span class=cl>           <span class=p>|</span>-nginx<span class=o>(</span>23503<span class=o>)</span>---nginx<span class=o>(</span>23547<span class=o>)</span>---nginx<span class=o>(</span>23548<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># ps -ef | grep nginx</span>
</span></span><span class=line><span class=cl>root      <span class=m>23503</span>      <span class=m>1</span>  <span class=m>0</span> 19:06 ?        00:00:00 nginx: master process nginx
</span></span><span class=line><span class=cl>root      <span class=m>23547</span>  <span class=m>23503</span>  <span class=m>0</span> 19:07 ?        00:00:00 nginx: master process nginx
</span></span><span class=line><span class=cl>nginx     <span class=m>23548</span>  <span class=m>23547</span>  <span class=m>0</span> 19:07 ?        00:00:00 nginx: worker process
</span></span><span class=line><span class=cl>root      <span class=m>23598</span>  <span class=m>23521</span>  <span class=m>0</span> 19:22 pts/1    00:00:00 grep --color<span class=o>=</span>auto nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#如果此时新版本出现问题，可执行回滚操作</span>
</span></span><span class=line><span class=cl><span class=c1>####################回滚######################</span>
</span></span><span class=line><span class=cl><span class=c1>#向旧版nginx发送HUP信号，重新生成work进程处理新的请求</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># kill -HUP `cat /apps/nginx/logs/nginx.pid.oldbin`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#关闭新版nginx进程</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># kill -QUIT `cat /apps/nginx/logs/nginx.pid`</span>
</span></span><span class=line><span class=cl><span class=c1>#####################回滚####################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#经过一段时间后，如果新版nginx正常运行，就可以关闭旧版nginx主进程master</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># kill -QUIT `cat /apps/nginx/logs/nginx.pid.oldbin`</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># ps -ef | grep nginx</span>
</span></span><span class=line><span class=cl>root      <span class=m>23547</span>      <span class=m>1</span>  <span class=m>0</span> 19:07 ?        00:00:00 nginx: master process nginx
</span></span><span class=line><span class=cl>nginx     <span class=m>23548</span>  <span class=m>23547</span>  <span class=m>0</span> 19:07 ?        00:00:00 nginx: worker process
</span></span><span class=line><span class=cl>root      <span class=m>23603</span>  <span class=m>23521</span>  <span class=m>0</span> 19:27 pts/1    00:00:00 grep --color<span class=o>=</span>auto nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#版本升级成功</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># nginx -v</span>
</span></span><span class=line><span class=cl>nginx version: nginx/1.20.1
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos7 ~<span class=o>]</span><span class=c1># curl localhost &amp;&gt; /dev/null &amp;&amp; echo $?</span>
</span></span><span class=line><span class=cl><span class=m>0</span>
</span></span></code></pre></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-07-20</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=http://example.org/posts/nginx%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7/ data-title=Nginx平滑升级和回滚 data-hashtags=升级、回滚><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=http://example.org/posts/nginx%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7/ data-hashtag=升级、回滚><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=http://example.org/posts/nginx%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7/ data-title=Nginx平滑升级和回滚><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=http://example.org/posts/nginx%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7/ data-title=Nginx平滑升级和回滚><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=http://example.org/posts/nginx%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7/ data-title=Nginx平滑升级和回滚><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/%E5%8D%87%E7%BA%A7%E5%9B%9E%E6%BB%9A/>升级、回滚</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/nginx%E5%AE%89%E8%A3%85%E8%84%9A%E6%9C%AC/ class=prev rel=prev title=Nginx安装脚本><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Nginx安装脚本</a>
<a href=/posts/nginx%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE/ class=next rel=next title=Nginx核心配置>Nginx核心配置<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.105.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>