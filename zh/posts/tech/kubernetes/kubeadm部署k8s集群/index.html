<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Kubeadméƒ¨ç½²k8sé›†ç¾¤ | WZ's Blog</title>
<meta name=keywords content><meta name=description content="ä¸€ã€ ç®€ä»‹ 1.1 k8s æ˜¯ä»€ä¹ˆ Kubernetesï¼ˆé€šå¸¸è¢«ç®€ç§°ä¸ºK8sï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å’Œç®¡ç†å¹³å°ï¼Œç”¨äºè‡ªåŠ¨åŒ–å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ã€æ‰©å±•å’Œæ“ä½œã€‚å®ƒç”±Googleå¼€å‘å¹¶æèµ ç»™äº†äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼ˆCNCFï¼‰ã€‚Kubernetesæ—¨åœ¨è§£å†³å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ç®¡ç†å’Œéƒ¨ç½²é—®é¢˜ï¼Œä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿæ›´è½»æ¾åœ°æ„"><meta name=author content="wz"><link rel=canonical href=https://senmer.github.io/zh/posts/tech/kubernetes/kubeadm%E9%83%A8%E7%BD%B2k8s%E9%9B%86%E7%BE%A4/><link crossorigin=anonymous href=/assets/css/stylesheet.5a2b6d77cc78ad18bcb4914c5c639c7ce5ab55e956c461d4310747892b3f50c2.css integrity="sha256-Wittd8x4rRi8tJFMXGOcfOWrVelWxGHUMQdHiSs/UMI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://senmer.github.io/img/Q.gif><link rel=icon type=image/png sizes=16x16 href=https://senmer.github.io/img/Q.gif><link rel=icon type=image/png sizes=32x32 href=https://senmer.github.io/img/Q.gif><link rel=apple-touch-icon href=https://senmer.github.io/img/Q.gif><link rel=mask-icon href=https://senmer.github.io/img/Q.gif><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer src=https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script src=https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?4d7c4710a089d70b71310f0e1ec7681b",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="Kubeadméƒ¨ç½²k8sé›†ç¾¤"><meta property="og:description" content="ä¸€ã€ ç®€ä»‹ 1.1 k8s æ˜¯ä»€ä¹ˆ Kubernetesï¼ˆé€šå¸¸è¢«ç®€ç§°ä¸ºK8sï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å’Œç®¡ç†å¹³å°ï¼Œç”¨äºè‡ªåŠ¨åŒ–å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ã€æ‰©å±•å’Œæ“ä½œã€‚å®ƒç”±Googleå¼€å‘å¹¶æèµ ç»™äº†äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼ˆCNCFï¼‰ã€‚Kubernetesæ—¨åœ¨è§£å†³å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ç®¡ç†å’Œéƒ¨ç½²é—®é¢˜ï¼Œä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿæ›´è½»æ¾åœ°æ„"><meta property="og:type" content="article"><meta property="og:url" content="https://senmer.github.io/zh/posts/tech/kubernetes/kubeadm%E9%83%A8%E7%BD%B2k8s%E9%9B%86%E7%BE%A4/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-02T22:37:50+08:00"><meta property="article:modified_time" content="2023-10-02T22:37:50+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Kubeadméƒ¨ç½²k8sé›†ç¾¤"><meta name=twitter:description content="ä¸€ã€ ç®€ä»‹ 1.1 k8s æ˜¯ä»€ä¹ˆ Kubernetesï¼ˆé€šå¸¸è¢«ç®€ç§°ä¸ºK8sï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å’Œç®¡ç†å¹³å°ï¼Œç”¨äºè‡ªåŠ¨åŒ–å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ã€æ‰©å±•å’Œæ“ä½œã€‚å®ƒç”±Googleå¼€å‘å¹¶æèµ ç»™äº†äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼ˆCNCFï¼‰ã€‚Kubernetesæ—¨åœ¨è§£å†³å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ç®¡ç†å’Œéƒ¨ç½²é—®é¢˜ï¼Œä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿæ›´è½»æ¾åœ°æ„"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"ğŸ“šæ–‡ç« ","item":"https://senmer.github.io/zh/posts/"},{"@type":"ListItem","position":2,"name":"ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯","item":"https://senmer.github.io/zh/posts/tech/"},{"@type":"ListItem","position":3,"name":"Kubeadméƒ¨ç½²k8sé›†ç¾¤","item":"https://senmer.github.io/zh/posts/tech/kubernetes/kubeadm%E9%83%A8%E7%BD%B2k8s%E9%9B%86%E7%BE%A4/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kubeadméƒ¨ç½²k8sé›†ç¾¤","name":"Kubeadméƒ¨ç½²k8sé›†ç¾¤","description":"ä¸€ã€ ç®€ä»‹ 1.1 k8s æ˜¯ä»€ä¹ˆ Kubernetesï¼ˆé€šå¸¸è¢«ç®€ç§°ä¸ºK8sï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å’Œç®¡ç†å¹³å°ï¼Œç”¨äºè‡ªåŠ¨åŒ–å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ã€æ‰©å±•å’Œæ“ä½œã€‚å®ƒç”±Googleå¼€å‘å¹¶æèµ ç»™äº†äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼ˆCNCFï¼‰ã€‚Kubernetesæ—¨åœ¨è§£å†³å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ç®¡ç†å’Œéƒ¨ç½²é—®é¢˜ï¼Œä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿæ›´è½»æ¾åœ°æ„","keywords":[""],"articleBody":"ä¸€ã€ ç®€ä»‹ 1.1 k8s æ˜¯ä»€ä¹ˆ Kubernetesï¼ˆé€šå¸¸è¢«ç®€ç§°ä¸ºK8sï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å’Œç®¡ç†å¹³å°ï¼Œç”¨äºè‡ªåŠ¨åŒ–å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ã€æ‰©å±•å’Œæ“ä½œã€‚å®ƒç”±Googleå¼€å‘å¹¶æèµ ç»™äº†äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼ˆCNCFï¼‰ã€‚Kubernetesæ—¨åœ¨è§£å†³å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ç®¡ç†å’Œéƒ¨ç½²é—®é¢˜ï¼Œä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿæ›´è½»æ¾åœ°æ„å»ºã€äº¤ä»˜å’Œè¿è¡Œå®¹å™¨åŒ–åº”ç”¨ã€‚\n1.2 k8s çš„ä¼˜åŠ¿ Kubernetes æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å¹³å°ï¼Œå®ƒæä¾›äº†ä¸€ç§ç®¡ç†å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„å¼ºå¤§æ–¹å¼ã€‚ä»¥ä¸‹æ˜¯ Kubernetes çš„ä¸€äº›ä¼˜åŠ¿ï¼š\nè‡ªåŠ¨åŒ–å’Œè‡ªæˆ‘ä¿®å¤ï¼š Kubernetes å¯ä»¥è‡ªåŠ¨ç›‘æµ‹åº”ç”¨ç¨‹åºçŠ¶æ€å¹¶è¿›è¡Œè‡ªæˆ‘ä¿®å¤ï¼Œç¡®ä¿åº”ç”¨æŒç»­ç¨³å®šè¿è¡Œã€‚å¦‚æœæŸä¸ªå®¹å™¨æˆ–èŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼ŒKubernetes ä¼šè‡ªåŠ¨é‡æ–°å¯åŠ¨å®¹å™¨æˆ–è¿ç§»å·¥ä½œè´Ÿè½½ã€‚ å¼¹æ€§æ‰©å±•ï¼š Kubernetes å…è®¸æ ¹æ®éœ€è¦æ‰©å±•æˆ–ç¼©å‡åº”ç”¨ç¨‹åºå®ä¾‹çš„æ•°é‡ã€‚è¿™ç§è‡ªåŠ¨æ‰©å±•èƒ½åŠ›å¯æ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´åº”ç”¨çš„è§„æ¨¡ï¼Œä»¥æ»¡è¶³æµé‡éœ€æ±‚ï¼ŒåŒæ—¶åœ¨éœ€æ±‚å‡å°‘æ—¶èŠ‚çº¦èµ„æºã€‚ è´Ÿè½½å‡è¡¡ï¼š Kubernetes æ”¯æŒå†…ç½®çš„è´Ÿè½½å‡è¡¡ï¼Œå¯ä»¥å°†ä¼ å…¥çš„æµé‡åˆ†å‘åˆ°ä¸åŒçš„å®¹å™¨å®ä¾‹ä¸­ï¼Œç¡®ä¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿæœ‰æ•ˆåœ°å¤„ç†é«˜æµé‡ã€‚ è‡ªåŠ¨éƒ¨ç½²å’Œæ»šåŠ¨æ›´æ–°ï¼š é€šè¿‡å£°æ˜å¼çš„é…ç½®ï¼ŒKubernetes å…è®¸ä½ è½»æ¾åœ°è¿›è¡Œåº”ç”¨ç¨‹åºçš„éƒ¨ç½²å’Œæ›´æ–°ã€‚æ»šåŠ¨æ›´æ–°åŠŸèƒ½å¯ä»¥é€æ­¥æ›¿æ¢æ—§ç‰ˆæœ¬çš„å®¹å™¨ï¼Œä»è€Œå‡å°‘åº”ç”¨ç¨‹åºçš„åœæœºæ—¶é—´ã€‚ å¤šç¯å¢ƒæ”¯æŒï¼š Kubernetes æ”¯æŒå¤šä¸ªç¯å¢ƒï¼ˆä¾‹å¦‚å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰ä¹‹é—´çš„è½»æ¾è¿ç§»ï¼Œç¡®ä¿åº”ç”¨åœ¨ä¸åŒé˜¶æ®µçš„ä¸€è‡´æ€§ã€‚ å£°æ˜å¼é…ç½®ï¼š ä½ å¯ä»¥ä½¿ç”¨ Kubernetes çš„ YAML æ–‡ä»¶æ¥å®šä¹‰åº”ç”¨ç¨‹åºçš„é…ç½®å’Œéƒ¨ç½²è¦æ±‚ã€‚è¿™ç§å£°æ˜å¼çš„æ–¹æ³•è®©ä½ èƒ½å¤Ÿæ›´æ¸…æ™°åœ°å®šä¹‰åº”ç”¨ç¨‹åºçŠ¶æ€ï¼Œè€Œ Kubernetes è´Ÿè´£å°†ç³»ç»ŸçŠ¶æ€è°ƒæ•´ä¸ºæ‰€éœ€çŠ¶æ€ã€‚ è‡ªå®šä¹‰èµ„æºå’Œæ‰©å±•æ€§ï¼š Kubernetes å…è®¸ä½ åˆ›å»ºè‡ªå®šä¹‰èµ„æºå’Œæ§åˆ¶å™¨ï¼Œä»è€Œå¯ä»¥æ‰©å±•å¹³å°çš„åŠŸèƒ½ï¼Œæ»¡è¶³ç‰¹å®šåº”ç”¨ç¨‹åºæˆ–ä¸šåŠ¡çš„éœ€æ±‚ã€‚ å¤šç§å®¹å™¨è¿è¡Œæ—¶æ”¯æŒï¼š Kubernetes æ”¯æŒå¤šç§å®¹å™¨è¿è¡Œæ—¶ï¼Œå¦‚ Dockerã€Containerd ç­‰ï¼Œä½¿ä½ å¯ä»¥é€‰æ‹©æœ€é€‚åˆä½ çš„åº”ç”¨çš„è¿è¡Œæ—¶ç¯å¢ƒã€‚ ç¤¾åŒºæ”¯æŒå’Œç”Ÿæ€ç³»ç»Ÿï¼š Kubernetes æ‹¥æœ‰åºå¤§çš„ç¤¾åŒºå’Œä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿï¼Œæœ‰å¤§é‡çš„å·¥å…·ã€æ’ä»¶å’ŒæœåŠ¡ï¼Œå¯ä»¥å¸®åŠ©ä½ æ›´å¥½åœ°ç®¡ç†ã€ç›‘æ§å’Œæ‰©å±•ä½ çš„åº”ç”¨ç¨‹åºã€‚ è·¨äº‘å’Œæœ¬åœ°ç¯å¢ƒï¼š Kubernetes å¯ä»¥åœ¨ä¸åŒçš„äº‘å¹³å°å’Œæœ¬åœ°ç¯å¢ƒä¸­è¿è¡Œï¼Œä½¿ä½ èƒ½å¤Ÿåœ¨ä¸åŒçš„åŸºç¡€æ¶æ„ä¸Šä¿æŒä¸€è‡´çš„éƒ¨ç½²å’Œç®¡ç†ä½“éªŒã€‚ æ€»ä¹‹ï¼ŒKubernetes æä¾›äº†å¼ºå¤§çš„å®¹å™¨ç¼–æ’å’Œç®¡ç†åŠŸèƒ½ï¼Œå¸®åŠ©å¼€å‘äººå‘˜å’Œè¿ç»´å›¢é˜Ÿæ›´æœ‰æ•ˆåœ°éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†å®¹å™¨åŒ–åº”ç”¨ç¨‹åºã€‚å®ƒçš„ä¼˜åŠ¿åœ¨äºè‡ªåŠ¨åŒ–ã€å¼¹æ€§ã€çµæ´»æ€§ä»¥åŠä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿã€‚\n1.3 k8s ç»„ä»¶ä»‹ç» Kubernetesï¼ˆé€šå¸¸ç®€ç§°ä¸ºK8sï¼‰ç”±å¤šä¸ªç»„ä»¶ç»„æˆï¼Œè¿™äº›ç»„ä»¶å…±åŒåä½œä»¥ç®¡ç†å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸã€‚ä»¥ä¸‹æ˜¯å¸¸è§çš„ Kubernetes ç»„ä»¶åŠå…¶åŠŸèƒ½ä»‹ç»ï¼š\nKubeletï¼š è¿è¡Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ä»£ç†ï¼Œè´Ÿè´£ç®¡ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸã€‚å®ƒä¸ Master èŠ‚ç‚¹é€šä¿¡ï¼Œç¡®ä¿å®¹å™¨åœ¨èŠ‚ç‚¹ä¸ŠæŒ‰ç…§æ‰€éœ€çš„çŠ¶æ€è¿è¡Œã€‚ Kube-Proxyï¼š ä¹Ÿè¿è¡Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šï¼Œç»´æŠ¤ç½‘ç»œè§„åˆ™ä»¥å®ç° Service æš´éœ²å’Œè´Ÿè½½å‡è¡¡ã€‚å®ƒæ ¹æ® Service é…ç½®æ›´æ–°èŠ‚ç‚¹ä¸Šçš„ iptables è§„åˆ™ã€‚ Kube-Schedulerï¼š è´Ÿè´£ç›‘è§†æ–°åˆ›å»ºçš„ Podï¼Œå¹¶æ ¹æ®å„ç§æ¡ä»¶ï¼ˆå¦‚èµ„æºéœ€æ±‚ã€äº²å’Œæ€§ã€äº²å’Œæ€§ç­‰ï¼‰å°†å…¶è°ƒåº¦åˆ°é›†ç¾¤ä¸­çš„é€‚å½“èŠ‚ç‚¹ä¸Šã€‚ Kube-Controller-Managerï¼š åŒ…å«å¤šä¸ªæ§åˆ¶å™¨ï¼Œç”¨äºç›‘æ§é›†ç¾¤çŠ¶æ€å¹¶æ ¹æ®éœ€è¦è¿›è¡Œè‡ªåŠ¨ä¿®å¤ã€‚å…¶ä¸­ä¸€äº›æ§åˆ¶å™¨åŒ…æ‹¬ï¼š Replication Controller å’Œ ReplicaSet æ§åˆ¶å™¨ï¼š ç¡®ä¿åœ¨é›†ç¾¤ä¸­è¿è¡ŒæŒ‡å®šæ•°é‡çš„ Pod å‰¯æœ¬ã€‚ Deployment æ§åˆ¶å™¨ï¼š ç®¡ç†åº”ç”¨ç¨‹åºçš„æ»šåŠ¨æ›´æ–°å’Œç‰ˆæœ¬æ§åˆ¶ã€‚ Namespace æ§åˆ¶å™¨ï¼š ç®¡ç†å‘½åç©ºé—´çš„åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤ã€‚ Etcdï¼š æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ç³»ç»Ÿï¼Œç”¨äºå­˜å‚¨é›†ç¾¤çš„é…ç½®ä¿¡æ¯ã€çŠ¶æ€å’Œå…ƒæ•°æ®ã€‚Kubernetes ä½¿ç”¨ Etcd æ¥å­˜å‚¨æ‰€æœ‰å…³é”®ä¿¡æ¯ï¼ŒåŒ…æ‹¬é…ç½®ã€éƒ¨ç½²å’ŒæœåŠ¡å‘ç°ã€‚ API Serverï¼š æä¾›äº† Kubernetes é›†ç¾¤çš„ APIï¼Œå…è®¸ç”¨æˆ·å’Œå…¶ä»–ç»„ä»¶ä¸é›†ç¾¤è¿›è¡Œäº¤äº’ã€‚æ‰€æœ‰çš„èµ„æºå’Œæ“ä½œéƒ½é€šè¿‡ API Server è¿›è¡Œè®¿é—®å’Œç®¡ç†ã€‚ Container Runtimeï¼š è´Ÿè´£è¿è¡Œå®¹å™¨ï¼Œå¸¸è§çš„å®¹å™¨è¿è¡Œæ—¶åŒ…æ‹¬ Dockerã€Containerd ç­‰ã€‚ Controller Managerï¼š åŒ…å«ä¸€ç³»åˆ—æ§åˆ¶å™¨ï¼Œè¿™äº›æ§åˆ¶å™¨å¯ä»¥ç›‘æ§é›†ç¾¤ä¸­çš„èµ„æºçŠ¶æ€ï¼Œå¹¶ç¡®ä¿æ‰€éœ€çŠ¶æ€ä¸å®é™…çŠ¶æ€ä¿æŒä¸€è‡´ã€‚ Cloud Controller Managerï¼š åœ¨äº‘å¹³å°ä¸Šè¿è¡Œï¼Œç”¨äºé›†æˆ Kubernetes é›†ç¾¤ä¸ç‰¹å®šäº‘æä¾›å•†çš„åŠŸèƒ½ï¼Œå¦‚è‡ªåŠ¨æ‰©å±•ã€è´Ÿè½½å‡è¡¡ç­‰ã€‚ Admission Controllersï¼š ç”¨äºæ‹¦æˆªå’Œä¿®æ”¹è¿›å…¥ Kubernetes é›†ç¾¤çš„è¯·æ±‚ã€‚è¿™äº›æ§åˆ¶å™¨å¯ä»¥æ‰§è¡ŒéªŒè¯ã€é»˜è®¤å€¼è®¾ç½®å’Œä¿®æ”¹è¯·æ±‚ï¼Œä»¥ç¡®ä¿éµå¾ªé›†ç¾¤ç­–ç•¥ã€‚ Ingress Controllerï¼š ç®¡ç† Ingress èµ„æºï¼Œå°†å¤–éƒ¨æµé‡å¼•å¯¼åˆ°é›†ç¾¤å†…éƒ¨çš„æœåŠ¡ã€‚ Podsï¼š æ˜¯ Kubernetes çš„æœ€å°è°ƒåº¦å•ä½ï¼Œå¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ã€‚å®ƒä»¬å¯ä»¥å…±äº«ç½‘ç»œå’Œå­˜å‚¨ï¼Œå½¢æˆä¸€ä¸ªé€»è¾‘å•å…ƒã€‚ Servicesï¼š ç”¨äºå®šä¹‰ä¸€ç»„ Pod çš„è®¿é—®æ–¹å¼ï¼Œæä¾›è´Ÿè½½å‡è¡¡å’ŒæœåŠ¡å‘ç°åŠŸèƒ½ï¼Œä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿåœ¨ä¸åŒçš„ Pod ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚ ConfigMaps å’Œ Secretsï¼š ç”¨äºå°†é…ç½®å’Œæœºå¯†ä¿¡æ¯ä¸åº”ç”¨ç¨‹åºåˆ†å¼€ï¼Œå¹¶åœ¨å®¹å™¨ä¸­ä»¥ç¯å¢ƒå˜é‡æˆ–å·çš„å½¢å¼æä¾›ã€‚ è¿™äº›ç»„ä»¶ä¸€èµ·ååŒå·¥ä½œï¼Œä½¿ Kubernetes èƒ½å¤Ÿæä¾›å¼ºå¤§çš„å®¹å™¨ç¼–æ’å’Œç®¡ç†åŠŸèƒ½ã€‚æ¯ä¸ªç»„ä»¶éƒ½æ‰®æ¼”ç€ä¸åŒçš„è§’è‰²ï¼Œç¡®ä¿å®¹å™¨åŒ–åº”ç”¨ç¨‹åºèƒ½å¤Ÿä»¥é«˜å¯ç”¨æ€§ã€è‡ªåŠ¨åŒ–å’Œå¼¹æ€§çš„æ–¹å¼è¿è¡Œã€‚\näºŒã€k8s å®‰è£…éƒ¨ç½²ï¼ˆkubeadmï¼‰ æ³¨æ„ï¼šæœ¬æ–‡å®‰è£…çš„ k8s ç‰ˆæœ¬ä¸º v1.17.11ï¼Œä¸èƒ½ç›´æ¥é€šè¿‡ kubeadm æ‰§è¡Œå‡çº§æ“ä½œã€‚å¦‚æœéœ€è¦è¿›è¡Œå‡çº§æ“ä½œï¼Œéœ€è¦æ»¡è¶³ version \u003e= 1.18.0\n2.1 å®‰è£…æ–¹å¼ Kubernetes çš„å®‰è£…å¯ä»¥åˆ†ä¸ºå¤šç§æ–¹å¼ï¼Œæ ¹æ®ä½ çš„éœ€æ±‚å’Œç¯å¢ƒé€‰æ‹©åˆé€‚çš„å®‰è£…æ–¹å¼ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ Kubernetes å®‰è£…æ–¹å¼ï¼š\nMinikubeï¼š å¦‚æœä½ æƒ³åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­å¿«é€Ÿæ­å»ºä¸€ä¸ªå•èŠ‚ç‚¹çš„ Kubernetes é›†ç¾¤ï¼Œå¯ä»¥ä½¿ç”¨ Minikubeã€‚Minikube åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºï¼Œå¹¶åœ¨å…¶ä¸­è¿è¡Œä¸€ä¸ªå•èŠ‚ç‚¹çš„ Kubernetes é›†ç¾¤ã€‚é€‚åˆå­¦ä¹ å’Œå¼€å‘ç›®çš„ã€‚\nKubeadmï¼š Kubeadm æ˜¯ä¸€ä¸ªå®˜æ–¹ç»´æŠ¤çš„å·¥å…·ï¼Œç”¨äºåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¿«é€Ÿéƒ¨ç½² Kubernetes é›†ç¾¤ã€‚å®ƒå¯ä»¥åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šè®¾ç½®ä¸€ä¸ªé«˜åº¦å¯é…ç½®çš„é›†ç¾¤ï¼Œé€‚ç”¨äºè¾ƒå°è§„æ¨¡çš„ç”Ÿäº§ç¯å¢ƒã€‚\nKubesprayï¼ˆåŸå…ˆå«Kargoï¼‰ï¼š Kubespray æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œç”¨äºéƒ¨ç½²é«˜åº¦å®šåˆ¶åŒ–çš„ Kubernetes é›†ç¾¤ã€‚å®ƒæ”¯æŒå¤šç§æ“ä½œç³»ç»Ÿå’Œäº‘å¹³å°ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®é…ç½®è¦æ±‚è¿›è¡Œå®šåˆ¶åŒ–éƒ¨ç½²ã€‚\nManaged Kubernetes Servicesï¼š ä¸»è¦äº‘æä¾›å•†ï¼ˆå¦‚AWSã€Google Cloudã€Azureï¼‰æä¾›æ‰˜ç®¡çš„ Kubernetes æœåŠ¡ï¼Œå¦‚Amazon EKSã€Google Kubernetes Engineï¼ˆGKEï¼‰ã€Azure Kubernetes Serviceï¼ˆAKSï¼‰ã€‚è¿™äº›æœåŠ¡ä¼šä¸ºä½ è‡ªåŠ¨ç®¡ç†é›†ç¾¤çš„ç»´æŠ¤ã€å‡çº§å’Œå¯ç”¨æ€§ã€‚\nRancherï¼š Rancher æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç®¡ç†å¹³å°ï¼Œå¯ä»¥å¸®åŠ©ä½ åœ¨ä¸åŒçš„åŸºç¡€è®¾æ–½ä¸Šè½»æ¾éƒ¨ç½²å’Œç®¡ç† Kubernetes é›†ç¾¤ã€‚\nK3sï¼š K3s æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ Kubernetes å‘è¡Œç‰ˆï¼Œæ—¨åœ¨ä¸ºèµ„æºå—é™çš„ç¯å¢ƒï¼ˆå¦‚è¾¹ç¼˜è®¡ç®—ï¼‰æä¾›æ›´è½»ä¾¿çš„å®‰è£…å’Œç®¡ç†ã€‚\nè‡ªå®šä¹‰å®‰è£…è„šæœ¬ï¼š ä½ å¯ä»¥æ ¹æ® Kubernetes çš„å®˜æ–¹æ–‡æ¡£ï¼Œåœ¨è‡ªå·±çš„ç¯å¢ƒä¸­ç¼–å†™è‡ªå®šä¹‰çš„å®‰è£…è„šæœ¬ã€‚è¿™æ ·å¯ä»¥æ›´å¥½åœ°é€‚åº”ç‰¹å®šéœ€æ±‚å’Œæ¶æ„ã€‚\nå¯¹äºåˆå­¦è€…æ¥è¯´ï¼ŒMinikube å’Œ Managed Kubernetes Services æ˜¯è¾ƒä¸ºç®€å•çš„å…¥é—¨æ–¹å¼ã€‚è€Œå¯¹äºç”Ÿäº§ç¯å¢ƒï¼ŒKubeadmã€Kubespray å’Œ Rancher æä¾›äº†æ›´å¤§çš„çµæ´»æ€§å’Œæ§åˆ¶æƒã€‚åœ¨é€‰æ‹©å®‰è£…æ–¹å¼æ—¶ï¼Œè€ƒè™‘åˆ°ä½ çš„æŠ€æœ¯æ°´å¹³ã€éƒ¨ç½²è§„æ¨¡å’Œæ‰€åœ¨çš„åŸºç¡€è®¾æ–½ç¯å¢ƒæ˜¯å¾ˆé‡è¦çš„ã€‚æ— è®ºé€‰æ‹©å“ªç§æ–¹å¼ï¼Œç¡®ä¿å‚è€ƒå®˜æ–¹æ–‡æ¡£å’Œæœ€ä½³å®è·µæ¥ç¡®ä¿å®‰è£…çš„æ­£ç¡®æ€§å’Œå¯é æ€§ã€‚\n2.2 éƒ¨ç½²è¿‡ç¨‹ å®‰è£…å‰å‡†å¤‡ï¼š\nç¦ç”¨ swap åˆ†åŒº\nå…³é—­ selinux\nå…³é—­ iptablesã€NetworkManager æœåŠ¡\nåŒæ­¥æœåŠ¡å™¨æ—¶é—´\n# ntpdate ntp.aliyun.com # hwclock -w ä¼˜åŒ–å†…æ ¸å‚æ•°å¹¶ä¿®æ”¹èµ„æºé™åˆ¶\n[root@centos7 ~]# cat /etc/sysctl.conf net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-iptables = 1 net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-arptables = 1 net.ipv4.tcp_tw_reuse = 0 net.ipv4.ip_nonlocal_bind = 1 net.core.somaxconn = 32768 net.netfilter.nf_conntrack_max = 1000000 vm.swappiness = 0 vm.max_map_count = 655360 fs.file-max = 655360 [root@centos7 ~]# cat /etc/security/limits.conf # * soft core unlimited * hard core unlimited * soft nproc 1000000 * hard nproc 1000000 * soft nofile 1000000 * hard nofile 1000000 * soft memlock 24800 * hard memlock 24800 * soft msgqueue 8192000 * hard msgqueue 8192000 root soft core unlimited root hard core unlimited root soft nproc 1000000 root hard nproc 1000000 root soft nofile 1000000 root hard nofile 1000000 root soft memlock 24800 root hard memlock 24800 root soft msgqueue 8192000 root hard msgqueue 8192000 2.2.1 å…·ä½“æ­¥éª¤ åŸºç¡€ç¯å¢ƒå‡†å¤‡ éƒ¨ç½² harbor å’Œ haproxy é«˜å¯ç”¨åå‘ä»£ç†ï¼Œå®ç°æ§åˆ¶èŠ‚ç‚¹ API çš„é«˜å¯ç”¨ åœ¨æ‰€æœ‰ master èŠ‚ç‚¹å®‰è£…æŒ‡å®šçš„ kubeadmã€kubeletã€kubectlã€docker åœ¨æ‰€æœ‰ node èŠ‚ç‚¹æŒ‰çˆªç»™ä½ æŒ‡å®šç‰ˆæœ¬çš„ kubeadmã€dockerã€kubeletï¼ˆå¯é€‰ï¼‰ åœ¨ master èŠ‚ç‚¹è¿è¡Œ kubeadm ini åˆå§‹åŒ–å‘½ä»¤åˆ›å»ºé›†ç¾¤ éªŒè¯ master èŠ‚ç‚¹çŠ¶æ€ åœ¨ node èŠ‚ç‚¹ä½¿ç”¨ kubeadm å‘½ä»¤å°†è‡ªèº«åŠ å…¥é›†ç¾¤ éªŒè¯ ndoe èŠ‚ç‚¹çŠ¶æ€ åˆ›å»º pod å¹¶æµ‹è¯•ç½‘ç»œæ˜¯å¦æ­£å¸¸ éƒ¨ç½² dashboard é›†ç¾¤å‡çº§ 2.2.2 éƒ¨ç½²ç¯å¢ƒ å¦‚æœæ˜¯è™šæ‹ŸåŒ–ç¯å¢ƒï¼Œæœ€å¥½æ¯ä¸ªé‡è¦èŠ‚ç‚¹åšå¥½å¿«ç…§\n**æ“ä½œç³»ç»Ÿï¼š**Centos 7.8\n**å®‰è£…æ–¹å¼ï¼š**æœ€å°åŒ–å®‰è£…\n**éƒ¨ç½²æ–¹å¼ï¼š**VMware 16 Pro\nè§’è‰² ä¸»æœºå IP é…ç½® k8s-master-01 master-01.example.local 10.0.0.11 2U 2G k8s-master-02 master-02.example.local 10.0.0.12 2U 2G k8s-master-03 master-03.example.local 10.0.0.13 2U 2G ha-01 ha-01.example.local 10.0.0.14 1U 2G ha-02 ha-02.example.local 10.0.0.15 1U 2G harbor harbor.example.local 10.0.0.16 2U 4G node-01 node-01.example.local 10.0.0.17 1U 2G node-02 node-02.example.local 10.0.0.18 1U 2G node-03 node-03.example.local 10.0.0.19 1U 2G 2.3 éƒ¨ç½²é«˜å¯ç”¨åå‘ä»£ç† åŸºäº Keepalived + haproxå®ç°é«˜å¯ç”¨åå‘ä»£ç†ï¼Œå®ç° k8s apiserver æœåŠ¡çš„é«˜å¯ç”¨\nha-01ï¼š\nyum install -y keepalived yum install -y haproxy cp /usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.vrrp /etc/keepalived/keepalived.conf [root@ha-01 ~]# cat /etc/keepalived/keepalived.conf ! Configuration File for keepalived global_defs { notification_email { acassen } notification_email_from Alexandre.Cassen@firewall.loc smtp_server 192.168.200.1 smtp_connect_timeout 30 router_id LVS_DEVEL } vrrp_instance k8s { state MASTER interface eth0 garp_master_delay 10 smtp_alert virtual_router_id 51 priority 100 advert_int 1 authentication { auth_type PASS auth_pass 1111 } virtual_ipaddress { 10.0.0.188 label eth0:1 10.0.0.199 label eth0:2 } } [root@ha-01 ~]# tail -n 60 /etc/haproxy/haproxy.cfg ... defaults mode http log global option httplog option dontlognull option http-server-close option forwardfor except 127.0.0.0/8 option redispatch retries 3 timeout http-request 10s timeout queue 1m timeout connect 10s timeout client 1m timeout server 1m timeout http-keep-alive 10s timeout check 10s maxconn 3000 listen stats mode http bind 0.0.0.0:9999 stats enable log global stats uri /haproxy-status stats auth admin:passwd listen k8s-apiserver-6443 bind 10.0.0.188:6443 mode tcp balance roundrobin server 10.0.0.11 10.0.0.11:6443 check inter 3s fall 3 rise 5 server 10.0.0.12 10.0.0.12:6443 check inter 3s fall 3 rise 5 server 10.0.0.13 10.0.0.13:6443 check inter 3s fall 3 rise 5 listen k8s-node-80 bind 10.0.0.199:80 mode tcp balance roundrobin server 10.0.0.17 10.0.0.17:30004 check inter 3s fall 3 rise 5 server 10.0.0.18 10.0.0.18:30004 check inter 3s fall 3 rise 5 server 10.0.0.19 10.0.0.19:30004 check inter 3s fall 3 rise 5 [root@ha-01 ~]# systemctl enable --now keepalived.service [root@ha-01 ~]# systemctl enable --now haproxy.service ha2:\nyum install -y keepalived yum install -y haproxy cp /usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.vrrp /etc/keepalived/keepalived.conf [root@ha-01 ~]# cat /etc/keepalived/keepalived.conf ! Configuration File for keepalived global_defs { notification_email { acassen } notification_email_from Alexandre.Cassen@firewall.loc smtp_server 192.168.200.1 smtp_connect_timeout 30 router_id LVS_DEVEL } vrrp_instance k8s { state MASTER interface eth0 garp_master_delay 10 smtp_alert virtual_router_id 51 priority 100 advert_int 1 authentication { auth_type PASS auth_pass 1111 } virtual_ipaddress { 10.0.0.188 label eth0:1 10.0.0.199 label eth0:2 } } [root@ha-02 ~]# tail -n 60 /etc/haproxy/haproxy.cfg ... defaults mode http log global option httplog option dontlognull option http-server-close option forwardfor except 127.0.0.0/8 option redispatch retries 3 timeout http-request 10s timeout queue 1m timeout connect 10s timeout client 1m timeout server 1m timeout http-keep-alive 10s timeout check 10s maxconn 3000 listen stats mode http bind 0.0.0.0:9999 stats enable log global stats uri /haproxy-status stats auth admin:passwd listen k8s-apiserver-6443 bind 10.0.0.188:6443 mode tcp balance roundrobin server 10.0.0.11 10.0.0.11:6443 check inter 3s fall 3 rise 5 server 10.0.0.12 10.0.0.12:6443 check inter 3s fall 3 rise 5 server 10.0.0.13 10.0.0.13:6443 check inter 3s fall 3 rise 5 listen k8s-node-80 bind 10.0.0.199:80 mode tcp balance roundrobin server 10.0.0.17 10.0.0.17:30004 check inter 3s fall 3 rise 5 server 10.0.0.18 10.0.0.18:30004 check inter 3s fall 3 rise 5 server 10.0.0.19 10.0.0.19:30004 check inter 3s fall 3 rise 5 [root@ha-02 ~]# systemctl enable --now keepalived.service [root@ha-02 ~]# systemctl enable --now haproxy.service # vip åœ¨ ha-01 èŠ‚ç‚¹ [root@ha-01 ~]# ifconfig eth0:1 eth0:1: flags=4163 mtu 1500 inet 10.0.0.188 netmask 255.255.255.255 broadcast 0.0.0.0 ether 00:0c:29:cd:4b:70 txqueuelen 1000 (Ethernet) [root@ha-01 ~]# ifconfig eth0:2 eth0:2: flags=4163 mtu 1500 inet 10.0.0.199 netmask 255.255.255.255 broadcast 0.0.0.0 ether 00:0c:29:cd:4b:70 txqueuelen 1000 (Ethernet) æµè§ˆå™¨æŸ¥çœ‹çŠ¶æ€é¡µ\n2.4 éƒ¨ç½² harbor https://goharbor.io/docs/2.9.0/install-config/installation-prereqs/\nhttps://docs.docker.com/engine/install/centos/\nsudo yum remove -y docker \\ docker-client \\ docker-client-latest \\ docker-common \\ docker-latest \\ docker-latest-logrotate \\ docker-logrotate \\ docker-engine # å®‰è£… docker sudo yum install -y yum-utils sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo sudo yum install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin systemctl enable --now docker [root@harbor harbor]# docker -v Docker version 24.0.6, build ed223bc # ä¸‹è½½å¹¶å®‰è£… harbor wget https://github.com/goharbor/harbor/releases/download/v2.8.4/harbor-offline-installer-v2.8.4.tgz tar xf harbor-offline-installer-v2.8.4.tgz cd harbor [root@harbor harbor]# cp harbor.yml.tmpl harbor.yml # å…³é—­ https [root@harbor harbor]# grep -A 7 \"https related config\" harbor.yml # https related config #https: # # https port for harbor, default is 443 # port: 443 # # The path of cert and key files for nginx # certificate: /your/certificate/path # private_key: /your/private/key/path # ä¿®æ”¹ hostname [root@harbor harbor]# grep -m 1 hostname: harbor.yml hostname: harbor.example.local # ä¿®æ”¹å¯†ç  [root@harbor harbor]# grep -m 1 passwd harbor.yml harbor_admin_password: passwd # å¼€å§‹å®‰è£… ./install.sh # docker-compose å®‰è£…è·¯å¾„ [root@harbor harbor]# rpm -ql docker-compose-plugin |grep docker-compose /usr/libexec/docker/cli-plugins/docker-compose ç™»å½• harbor å¹¶åˆ›å»ºé¡¹ç›®\næ³¨æ„ï¼š è‡ªè¡Œåœ¨ window ä¸»æœºæ·»åŠ  hosts è§£æ 10.0.0.16 harbor.example.local\n2.5 æ‰€æœ‰èŠ‚ç‚¹å®‰è£… docker Release v1.17.11 Â· kubernetes/kubernetes (github.com)\næ‰€æœ‰èŠ‚ç‚¹ï¼ˆè¿™é‡Œä¸“æŒ‡ master å’Œ nodeï¼‰å®‰è£… docker\næ³¨æ„ï¼š ç”Ÿäº§ç¯å¢ƒè¦é€‰æ‹© k8s æŒ‡å®šçš„ç‰ˆæœ¬ï¼Œå…·ä½“æŸ¥é˜…å¯¹åº”ç‰ˆæœ¬çš„ CHANGELOG\nkubernetes/CHANGELOG/CHANGELOG-1.17.md at master Â· kubernetes/kubernetes (github.com)\nå®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ docker\nsudo yum remove docker \\ docker-client \\ docker-client-latest \\ docker-common \\ docker-latest \\ docker-latest-logrotate \\ docker-logrotate \\ docker-engine sudo yum install -y yum-utils sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo # è¿™é‡Œç›´æ¥å®‰è£… 19.03.9-3 ç‰ˆæœ¬çš„ docker # yum list docker-ce --showduplicates | sort -r | grep 19.03 docker-ce.x86_64 3:19.03.9-3.el7 docker-ce-stable # sudo yum install -y docker-ce-19.03.9 docker-ce-cli-19.03.9 containerd.io docker-compose-plugin # docker version Client: Docker Engine - Community Version: 19.03.9 API version: 1.40 Go version: go1.13.10 Git commit: 9d988398e7 Built: Fri May 15 00:25:27 2020 OS/Arch: linux/amd64 Experimental: false Server: Docker Engine - Community Engine: Version: 19.03.9 # ç”±äº harbor ä»“åº“æœªå¯ç”¨ https ï¼Œå› æ­¤éœ€è¦åœ¨ service æ–‡ä»¶åŠ ä¸Šè¯¥å‚æ•° # dockerd --help |grep insec --insecure-registry list Enable insecure registry communication # grep insecure-registry /lib/systemd/system/docker.service ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --insecure-registry harbor.example.com # systemctl enable --now docker 2.6 æ‰€æœ‰èŠ‚ç‚¹å®‰è£…é›†ç¾¤åˆå§‹åŒ–å·¥å…· 2.6.1 é…ç½®å›½å†…é•œåƒæº cat \u003c /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/ enabled=1 gpgcheck=0 repo_gpgcheck=0 gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF 2.6.2 å®‰è£…åˆå§‹åŒ–å·¥å…· æ³¨æ„ï¼škubectl æ˜¯å®¢æˆ·ç«¯å‘½ä»¤ï¼Œå› æ­¤åœ¨ node å¯ä»¥é€‰æ‹©æ€§å®‰è£…\nyum install -y kubelet-1.17.11 kubectl-1.17.11 kubeadm-1.17.11 systemctl enable --now kubelet # é…ç½® kubeadm å­å‘½ä»¤è‡ªåŠ¨è¡¥å…¨ mkdir ~/.kube/ kubeadm completion bash \u003e ~/.kube/kubeadm_completion.sh source ~/.kube/kubeadm_completion.sh 2.6.3 kubeadm å‘½ä»¤çš„ä½¿ç”¨ æŸ¥çœ‹å¸®åŠ©\nkubeadm --help æŸ¥çœ‹ç‰ˆæœ¬\n[root@master-01 ~]# kubeadm version kubeadm version: \u0026version.Info{Major:\"1\", Minor:\"17\", GitVersion:\"v1.17.11\", GitCommit:\"ea5f00d93211b7c80247bf607cfa422ad6fb5347\", GitTreeState:\"clean\", BuildDate:\"2020-08-13T15:17:52Z\", GoVersion:\"go1.13.15\", Compiler:\"gc\", Platform:\"linux/amd64\"} æŸ¥çœ‹éƒ¨ç½²æŒ‡å®šç‰ˆæœ¬çš„é›†ç¾¤æ‰€éœ€è¦çš„é•œåƒ\n[root@master-01 ~]# kubeadm config images list --kubernetes-version v1.17.11 W0930 17:59:27.921963 6797 validation.go:28] Cannot validate kube-proxy config - no validator is available W0930 17:59:27.922001 6797 validation.go:28] Cannot validate kubelet config - no validator is available k8s.gcr.io/kube-apiserver:v1.17.11 k8s.gcr.io/kube-controller-manager:v1.17.11 k8s.gcr.io/kube-scheduler:v1.17.11 k8s.gcr.io/kube-proxy:v1.17.11 k8s.gcr.io/pause:3.1 k8s.gcr.io/etcd:3.4.3-0 k8s.gcr.io/coredns:1.6.5 ç”±äºæ˜¯å›½å¤–çš„é•œåƒï¼Œç”±äºç½‘ç»œåŸå› ï¼Œå¤§æ¦‚ç‡æ˜¯ä¸‹è½½ä¸æˆåŠŸçš„ã€‚å› æ­¤å°†é•œåƒåœ°å€æ¢æˆé˜¿é‡Œçš„ï¼Œç„¶åæ‰‹åŠ¨ pull\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.17.11 docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.17.11 docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.17.11 docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.17.11 docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.4.3-0 docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.6.5 2.7 k8s å•èŠ‚ç‚¹éƒ¨ç½² 2.7.1 å¼€å§‹éƒ¨ç½² é¦–å…ˆç»™ master-01 æ·»åŠ ä¸€ä¸ªå¿«ç…§ï¼Œåä¸º initï¼Œæ–¹ä¾¿åç»­å›é€€\nè¿™é‡Œé€‰æ‹© master-01 è¿›è¡Œæ¼”ç¤º\n[root@master-01 ~]# kubeadm init --apiserver-advertise-address=10.0.0.11 --apiserver-bind-port=6443 --kubernetes-version=v1.17.11 --pod-network-cidr=10.100.0.0/16 --service-cidr=10.200.0.0/16 --service-dns-domain=example.local --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers # --v=6 å¦‚æœå¡ä½æˆ–è€…è¶…æ—¶å¯ä»¥åŠ è¯¥é€‰é¡¹æ¥æŸ¥çœ‹è¯¦ç»†æŠ¥é”™ä¿¡æ¯ å®‰è£…ç»“æœæ‰“å°åœ¨æ§åˆ¶å°ï¼Œä¸ºæ–¹ä¾¿åç»­æ·»åŠ  node èŠ‚ç‚¹åˆ°é›†ç¾¤ç­‰æ“ä½œï¼Œæœ€å¥½å°†æ‰“å°ç»“æœè¿›è¡Œä¿å­˜\n... Your Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: # æ‰§è¡Œä»¥ä¸‹ä¸‰è¡Œå‘½ä»¤ï¼Œå¯é€šè¿‡ kubectl å‘½ä»¤æ“ä½œé›†ç¾¤ mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config You should now deploy a pod network to the cluster. Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ Then you can join any number of worker nodes by running the following on each as root: # node èŠ‚ç‚¹è¿è¡Œè¯¥å‘½ä»¤å¯åŠ å…¥é›†ç¾¤ kubeadm join 10.0.0.11:6443 --token s14pux.a81q4ai54mpumsz4 \\ --discovery-token-ca-cert-hash sha256:5ab171bccb95245c209ddcbb614ae943b31b05e3a4ce2eb47d349655955c185f 2.7.2 éªŒè¯ç»“æœ [root@master-01 ~]# kubectl get pod The connection to the server localhost:8080 was refused - did you specify the right host or port? [root@master-01 ~]# [root@master-01 ~]# mkdir -p $HOME/.kube [root@master-01 ~]# sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config [root@master-01 ~]# sudo chown $(id -u):$(id -g) $HOME/.kube/config [root@master-01 ~]# kubectl get pod No resources found in default namespace. 2.7.3 éƒ¨ç½²ç½‘ç»œç»„ä»¶ k8s æ”¯æŒçš„ç½‘ç»œç»„ä»¶ï¼šå®‰è£…æ‰©å±•ï¼ˆAddonï¼‰ | Kubernetes\nè¿™é‡Œé€‰æ‹©éƒ¨ç½² flannel-io/flannel: flannel is a network fabric for containers, designed for Kubernetes (github.com)\nä¸‹è½½ yaml æ–‡ä»¶å¹¶ä¿®æ”¹ network ä¸ºé›†ç¾¤åˆå§‹åŒ–æ—¶è§„åˆ’çš„ pod ç½‘æ®µ 10.100.0.0/16\n[root@master-01 ~]# wget https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml [root@master-01 ~]# grep -m 1 Network kube-flannel.yml \"Network\": \"10.100.0.0/16\", å¼€å§‹éƒ¨ç½²\n[root@master-01 ~]# kubectl apply -f kube-flannel.yml namespace/kube-flannel created serviceaccount/flannel created clusterrole.rbac.authorization.k8s.io/flannel created clusterrolebinding.rbac.authorization.k8s.io/flannel created configmap/kube-flannel-cfg created daemonset.apps/kube-flannel-ds created # æˆåŠŸéƒ¨ç½² [root@master-01 ~]# kubectl get pod -A | grep flannel kube-flannel kube-flannel-ds-zvcp7 1/1 Running 0 2m9s å»é™¤ master-01 çš„æ±¡ç‚¹\n# é»˜è®¤æƒ…å†µä¸‹ master è¢«æ‰“ä¸Šäº†æ±¡ç‚¹ï¼Œä¸ä¼šè¢«è°ƒåº¦ [root@master-01 ~]# kubectl describe node master-01.example.local | grep Taints Taints: node-role.kubernetes.io/master:NoSchedule # å»é™¤ master-01 çš„æ±¡ç‚¹ [root@master-01 ~]# kubectl taint nodes master-01.example.local node-role.kubernetes.io/master:NoSchedule- node/master-01.example.local untainted éƒ¨ç½² busybox éªŒè¯ pod ç½‘ç»œ\n[root@master-01 ~]# kubectl run my-container --image=busybox --command -- bash kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead. [root@master-01 ~]# kubectl run my-container --image=busybox --command -- ping www.baidu.com kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead. deployment.apps/my-container created [root@master-01 ~]# kubectl get pod NAME READY STATUS RESTARTS AGE my-container-84ff747745-sjd97 1/1 Running 0 10s # ç½‘ç»œæ­£å¸¸ [root@master-01 ~]# kubectl exec -it my-container-84ff747745-sjd97 -- sh / # ping www.baidu.com -c 3 PING www.baidu.com (14.119.104.189): 56 data bytes 64 bytes from 14.119.104.189: seq=0 ttl=127 time=9.193 ms 64 bytes from 14.119.104.189: seq=1 ttl=127 time=9.475 ms 64 bytes from 14.119.104.189: seq=2 ttl=127 time=9.668 ms 2.8 k8s å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼ˆé«˜å¯ç”¨ï¼‰ è¿™é‡Œå°†ç”¨åˆ°æ‰€æœ‰ä¸‰ä¸ª master èŠ‚ç‚¹è¿›è¡Œæ¼”ç¤ºï¼Œç”±äº mater-01 éƒ¨ç½²äº†å•èŠ‚ç‚¹ï¼Œé¦–å…ˆå°†å…¶è¿˜åŸåˆ°å¿«ç…§ init ï¼ˆæ²¡æœ‰å¿«ç…§çš„è¯ï¼Œå¯ä»¥å‚è€ƒ kubeadm reset )\n2.8.1 å¼€å§‹éƒ¨ç½² ç›¸æ¯”å•èŠ‚ç‚¹éƒ¨ç½²è€Œè¨€ï¼Œå¤šäº†ä¸€ä¸ªé€‰é¡¹ --control-plane-endpoint=10.0.0.188 æŒ‡å®šäº†é«˜å¯ç”¨åå‘ä»£ç†çš„ VIPï¼Œè¿™é‡Œè¿˜æ˜¯é€‰æ‹© master-01 åˆ›å»ºé›†ç¾¤ï¼ˆä»»é€‰ä¸€ä¸ª master èŠ‚ç‚¹å‡å¯ï¼‰\nå¦‚æœè´Ÿè½½å‡è¡¡å™¨æœªé…ç½®æ­£ç¡®ï¼Œä¼šæœ‰ä»¥ä¸‹æŠ¥é”™ï¼š\nOct 1 14:06:58 master-01 kubelet: E1001 14:06:58.218726 2977 reflector.go:153] k8s.io/client-go/informers/factory.go:135: Failed to lisriver: Get https://load-balancer.example.com:6443/apis/storage.k8s.io/v1beta1/csidrivers?limit=500\u0026resourceVersion=0: EOF\n[root@master-01 ~]# echo 10.0.0.188 load-balancer.example.com \u003e\u003e /etc/hosts [root@master-01 ~]# kubeadm init --apiserver-advertise-address=10.0.0.11 --control-plane-endpoint=load-balancer.example.com --apiserver-bind-port=6443 --kubernetes-version=v1.17.11 --pod-network-cidr=10.100.0.0/16 --service-cidr=10.200.0.0/16 --service-dns-domain=example.local --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers ... Your Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config You should now deploy a pod network to the cluster. Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ You can now join any number of control-plane nodes by copying certificate authorities and service account keys on each node and then running the following as root: # æ·»åŠ  master èŠ‚ç‚¹åˆ°é›†ç¾¤ kubeadm join load-balancer.example.com:6443 --token iata77.l5yqheznrbz3i0jm \\ --discovery-token-ca-cert-hash sha256:9cf6a8410183e55ff71f0f64f0aea35f3a1498e3e0e6311cf0571a3a2021931a \\ --control-plane # éœ€è¦æ‰‹åŠ¨ç”Ÿæˆ Then you can join any number of worker nodes by running the following on each as root: # æ·»åŠ  node èŠ‚ç‚¹åˆ°é›†ç¾¤ kubeadm join load-balancer.example.com:6443 --token iata77.l5yqheznrbz3i0jm \\ --discovery-token-ca-cert-hash sha256:9cf6a8410183e55ff71f0f64f0aea35f3a1498e3e0e6311cf0571a3a2021931a # å‡†å¤‡é›†ç¾¤è®¤è¯æ–‡ä»¶ [root@master-01 ~]# mkdir -p $HOME/.kube [root@master-01 ~]# sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config [root@master-01 ~]# sudo chown $(id -u):$(id -g) $HOME/.kube/config # æˆåŠŸè·å–é›†ç¾¤ä¿¡æ¯ [root@master-01 ~]# kubectl get node NAME STATUS ROLES AGE VERSION master-01.example.local Ready master 91m v1.17.11 # éƒ¨ç½² flannelï¼Œ å‚è€ƒ 2.7.3 [root@master-01 ~]# kubectl apply -f kube-flannel.yml namespace/kube-flannel created serviceaccount/flannel created clusterrole.rbac.authorization.k8s.io/flannel created clusterrolebinding.rbac.authorization.k8s.io/flannel created configmap/kube-flannel-cfg created daemonset.apps/kube-flannel-ds created [root@master-01 ~]# kubectl get pod -A |grep flannel kube-flannel kube-flannel-ds-97c97 1/1 Running 0 94s è¡¥å……ï¼š é™¤äº†ä½¿ç”¨å‘½ä»¤çš„æ–¹å¼ï¼Œè¿˜å¯ä»¥åŸºäº yaml æ–‡ä»¶è¿›è¡Œé›†ç¾¤çš„åˆå§‹åŒ–ï¼ˆè¿™é‡Œä»…ç»™å‡ºå…³é”®å‘½ä»¤ï¼‰\n# ç”Ÿæˆåˆå§‹åŒ–é…ç½® # kubeadm config print init-defaults \u003e cluster-init.yaml # æ ¹æ®éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ # cat cluster-init.yaml apiVersion: kubeadm.k8s.io/v1beta2 bootstrapTokens: - groups: - system:bootstrappers:kubeadm:default-node-token token: abcdef.0123456789abcdef ttl: 24h0m0s usages: - signing - authentication kind: InitConfiguration localAPIEndpoint: advertiseAddress: 1.2.3.4 bindPort: 6443 nodeRegistration: criSocket: /var/run/dockershim.sock name: master-01.example.local taints: - effect: NoSchedule key: node-role.kubernetes.io/master --- apiServer: timeoutForControlPlane: 4m0s apiVersion: kubeadm.k8s.io/v1beta2 certificatesDir: /etc/kubernetes/pki clusterName: kubernetes controllerManager: {} dns: type: CoreDNS etcd: local: dataDir: /var/lib/etcd imageRepository: k8s.gcr.io kind: ClusterConfiguration kubernetesVersion: v1.17.0 networking: dnsDomain: cluster.local podSubnet: 10.100.0.0/16 serviceSubnet: 10.200.0.0/16 scheduler: {} # åˆ›å»ºé›†ç¾¤ kubeadm init --config cluster-init.yaml 2.8.2 æ·»åŠ  master èŠ‚ç‚¹ ç”Ÿæˆ --control-plane å‚æ•°æ‰€éœ€ key\n[root@master-01 ~]# kubeadm init phase upload-certs --upload-certs I1001 16:10:41.762369 58794 version.go:251] remote version is much newer: v1.28.2; falling back to: stable-1.17 W1001 16:10:46.609771 58794 validation.go:28] Cannot validate kube-proxy config - no validator is available W1001 16:10:46.609786 58794 validation.go:28] Cannot validate kubelet config - no validator is available [upload-certs] Storing the certificates in Secret \"kubeadm-certs\" in the \"kube-system\" Namespace [upload-certs] Using certificate key: c67c9859d32c5f7e1fd75cfca8569aac32ae4f9344fcd6b8d53ad9b998362e05 # è¿™å°±æ˜¯éœ€è¦çš„ key åˆ†åˆ«æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°† master-02 å’Œ master-03 åŠ å…¥ control-plane\n# echo 10.0.0.188 load-balancer.example.com \u003e\u003e /etc/hosts # kubeadm join load-balancer.example.com:6443 --token iata77.l5yqheznrbz3i0jm \\ --discovery-token-ca-cert-hash sha256:9cf6a8410183e55ff71f0f64f0aea35f3a1498e3e0e6311cf0571a3a2021931a \\ --control-plane --certificate-key c67c9859d32c5f7e1fd75cfca8569aac32ae4f9344fcd6b8d53ad9b998362e05 ... This node has joined the cluster and a new control plane instance was created: * Certificate signing request was sent to apiserver and approval was received. * The Kubelet was informed of the new secure connection details. * Control plane (master) label and taint were applied to the new node. * The Kubernetes control plane instances scaled up. * A new etcd member was added to the local/stacked etcd cluster. To start administering your cluster from this node, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config Run 'kubectl get nodes' to see this node join the cluster. # æˆåŠŸåŠ å…¥èŠ‚ç‚¹ [root@master-02 ~]# kubectl get nodes NAME STATUS ROLES AGE VERSION master-01.example.local Ready master 132m v1.17.11 master-02.example.local Ready master 8m25s v1.17.11 master-03.example.local Ready master 14s v1.17.11 2.8.3 æ·»åŠ  node èŠ‚ç‚¹ åˆ†åˆ«å„ä¸ª node èŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤\necho 10.0.0.188 load-balancer.example.com \u003e\u003e /etc/hosts kubeadm join load-balancer.example.com:6443 --token iata77.l5yqheznrbz3i0jm \\ --discovery-token-ca-cert-hash sha256:9cf6a8410183e55ff71f0f64f0aea35f3a1498e3e0e6311cf0571a3a2021931a æ·»åŠ å®Œæˆåçš„ç»“æœ\n[root@master-02 ~]# kubectl get nodes NAME STATUS ROLES AGE VERSION master-01.example.local Ready master 176m v1.17.11 master-02.example.local Ready master 52m v1.17.11 master-03.example.local Ready master 44m v1.17.11 node-01.example.local Ready 95s v1.17.11 node-02.example.local Ready 34m v1.17.11 node-03.example.local Ready 74s v1.17.11 2.8.4 æŸ¥çœ‹é›†ç¾¤è¯ä¹¦ [root@master-02 ~]# kubectl get csr NAME AGE REQUESTOR CONDITION csr-4fsl6 47m system:bootstrap:tdi58m Approved,Issued csr-hc9g7 4m system:bootstrap:tdi58m Approved,Issued csr-jh7gj 55m system:bootstrap:tdi58m Approved,Issued csr-k8psl 3m39s system:bootstrap:tdi58m Approved,Issued csr-qcjln 36m system:bootstrap:tdi58m Approved,Issued csr-vvtfq 2m53s system:bootstrap:tdi58m Approved,Issued 2.8.5 åˆ›å»º pod éªŒè¯é›†ç¾¤ç½‘ç»œ [root@master-01 ~]# kubectl run net-test --image=alpine sleep 3600 kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead. deployment.apps/net-test created [root@master-01 ~]# kubectl get pod -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES net-test-88ff4d957-rnrsk 1/1 Running 0 21s 10.100.4.2 node-01.example.local [root@master-01 ~]# kubectl exec -it net-test-88ff4d957-rnrsk -- sh / # ping www.baidu.com PING www.baidu.com (14.119.104.189): 56 data bytes 64 bytes from 14.119.104.189: seq=0 ttl=127 time=8.608 ms 64 bytes from 14.119.104.189: seq=1 ttl=127 time=9.249 ms 64 bytes from 14.119.104.189: seq=2 ttl=127 time=9.576 ms ä¸‰ã€éƒ¨ç½² Dashboard 3.1 å‡†å¤‡é…ç½®æ–‡ä»¶ [root@master-01 ~]# wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.2.0/aio/deploy/recommended.yaml [root@master-01 ~]# mv recommended.yaml dashboard.yaml # é»˜è®¤çš„æ˜¯ä»¥ ClusterIP å‘å¸ƒçš„ï¼Œåªèƒ½é›†ç¾¤å†…è®¿é—®ã€‚è¿™é‡Œå°†å…¶æ”¹ä¸º NodePort çš„æ–¹å¼éƒ¨ç½² [root@master-01 ~]# grep NodePort -C 10 dashboard.yaml --- kind: Service apiVersion: v1 metadata: labels: k8s-app: kubernetes-dashboard name: kubernetes-dashboard namespace: kubernetes-dashboard spec: type: NodePort # æ–°å¢ ports: - port: 443 targetPort: 8443 nodePort: 30000 # æ–°å¢ selector: k8s-app: kubernetes-dashboard --- apiVersion: v1 kind: Secret metadata: labels: k8s-app: kubernetes-dashboard 3.2 éƒ¨ç½²å¹¶éªŒè¯æ•ˆæœ [root@master-01 ~]# kubectl apply -f dashboard.yaml # æŸ¥çœ‹ pod å’Œ service æœåŠ¡çŠ¶æ€ [root@master-01 ~]# kubectl get pod,svc -n kubernetes-dashboard -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES pod/dashboard-metrics-scraper-894c58c65-tsqb7 1/1 Running 0 32m 10.100.4.4 node-01.example.local pod/kubernetes-dashboard-fc4fc66cc-vvbht 1/1 Running 0 32m 10.100.4.3 node-01.example.local NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR service/dashboard-metrics-scraper ClusterIP 10.200.205.233 8000/TCP 32m k8s-app=dashboard-metrics-scraper service/kubernetes-dashboard NodePort 10.200.198.74 443:30000/TCP 32m k8s-app=kubernetes-dashboard # èŠ‚ç‚¹ç›‘å¬äº† 30000 ç«¯å£ [root@node-01 ~]# ss -ntl |grep 30000 LISTEN 0 32768 [::]:30000 [::]:* ç”±äºæ˜¯ https åè®®ï¼Œä½†æ˜¯è¯ä¹¦æ˜¯ç§æœ‰çš„ï¼Œä½¿ç”¨ chrome æˆ– edge æµè§ˆå™¨æ— æ³•è®¿é—® dashboardã€‚å› æ­¤é€‰æ‹© firefox æµè§ˆå™¨è¿›è¡Œè®¿é—®\nè®¿é—® dashboard éœ€è¦ä½¿ç”¨ token æˆ–è€… kubeconfig æ–‡ä»¶è¿›è¡Œè®¤è¯ï¼Œè¿™é‡Œé€‰æ‹© token è¿›è¡ŒéªŒè¯ã€‚ä¸‹é¢å¼€å§‹ç”Ÿæˆ token\n# åˆ›å»ºè´¦å· [root@master-01 ~]# kubectl create serviceaccount dashboard-admin -n kubernetes-dashboard serviceaccount/dashboard-admin created # æˆæƒ [root@master-01 ~]# kubectl create clusterrolebinding dashboard-admin-rb --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-admin # è·å–è´¦å· token [root@master-01 ~]# kubectl get secrets -n kubernetes-dashboard | grep dashboard-admin dashboard-admin-token-wr4jl kubernetes.io/service-account-token 3 15s [root@master-01 ~]# kubectl describe secrets dashboard-admin-token-wr4jl -n kubernetes-dashboard Name: dashboard-admin-token-wr4jl Namespace: kubernetes-dashboard Labels: Annotations: kubernetes.io/service-account.name: dashboard-admin kubernetes.io/service-account.uid: 66e3f61f-9172-400c-b454-d9fb1a93be4c Type: kubernetes.io/service-account-token Data ==== ca.crt: 1025 bytes namespace: 20 bytes token: eyJhbGciOiJSUzI1NiIsImtpZCI6IndQay1pc3ctc3RyWDh3dXQtTHR1N09PLVVBdUExdXJkRVRQeFpmbWlmQ1kifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tN3NweDkiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiMjQ5OTJlMzctNmI1Yi00ODZmLTkwYmUtYmQxYTU2NGM0MmJhIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9.jXYf6lQQBW9kb3KUYpoAi57JbBFwMkUdx3Gb0jK4sN8E80WIM6lyGLktsTCmNoS21BN-bGyusqT5nNJAPhrVYaEjF6pSSLrd49LHF0Wetv04Jh5fdw-aHYuR15QKCZgGjedzuUHD4F8-6Ba5ZqMh67JjKI3Dhb-dIuBIVN3KLi2_D62F4VoCryZB3ExVfdRqZmQmI0EJ5XursMgCzL9v9VCPw9FatL604n5658CuXQNXc6uIpAVwuf3G_4uBoRQ-LcyPXov9JIoSv-qbxnotgZ2xXcHWZ7HIxa1pCRL8YG_bx03ZUE04GebjF9yNeki9Dxsp4gIxDcr09ByzO0gmgg å°†ä¸Šè¿° token å¡«å…¥è¾“å…¥æ¡†(ä¸è¦å¸¦å¤šä½™ç©ºæ ¼ï¼‰ï¼ŒæˆåŠŸè®¿é—® dashboard\nå››ã€k8s éƒ¨ç½² nginx + tomcat Deployments | Kubernetes\nç›®æ ‡ï¼šå®ç°åŠ¨é™åˆ†ç¦»çš„æ•ˆæœï¼Œè¿™é‡Œä»…æ¼”ç¤ºç®€å•çš„å®ç°æ•ˆæœ\n4.1 éƒ¨ç½² nginx [root@master-01 nginx]# pwd /root/yaml/nginx [root@master-01 nginx]# cat nginx.yml apiVersion: apps/v1 kind: Deployment metadata: namespace: default name: nginx-deployment labels: app: nginx spec: replicas: 1 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.18.0 ports: - containerPort: 80 --- apiVersion: v1 kind: Service metadata: labels: app: nginx-service-labels name: nginx-service namespace: default spec: type: NodePort ports: - name: http-nginx port: 80 protocol: TCP targetPort: 80 nodeport: 30004 selector: app: nginx [root@master-01 nginx]# kubectl apply -f nginx.yml æŸ¥çœ‹éƒ¨ç½²ç»“æœ\n[root@master-01 nginx]# kubectl get pod,svc -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES pod/nginx-deployment-d44c4d8f4-bftm4 1/1 Running 0 4m11s 10.100.3.3 node-01.example.local NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR service/kubernetes ClusterIP 10.200.0.1 443/TCP 162m service/nginx-service NodePort 10.200.231.164 80:30004/TCP 4m11s app=nginx æ ¹æ®ä»¥ä¸Šç»“æœå¯çŸ¥ï¼Œnginx æˆåŠŸéƒ¨ç½²ï¼Œä¸” pod è¢«è°ƒåº¦åˆ°äº† node-01 èŠ‚ç‚¹\n4.2 éƒ¨ç½² tomcat [root@master-01 tomcat]# pwd /root/yaml/tomcat [root@master-01 tomcat]# cat tomcat.yml apiVersion: apps/v1 kind: Deployment metadata: namespace: default name: tomcat-deployment labels: apps: tomcat spec: replicas: 1 selector: matchLabels: app: tomcat template: metadata: labels: app: tomcat spec: containers: - name: tomcat image: tomcat ports: - containerPort: 8080 --- apiVersion: v1 kind: Service metadata: labels: app: tomcat-service-label name: tomcat-service namespace: spec: type: NodePort ports: - name: tomcat-http port: 80 protocol: TCP targetPort: 8080 nodePort: 30005 selector: app: tomcat [root@master-01 tomcat]# kubectl apply -f tomcat.yml æŸ¥çœ‹éƒ¨ç½²ç»“æœ\n[root@master-01 ~]# kubectl get pod,svc -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES pod/nginx-deployment-d44c4d8f4-bftm4 1/1 Running 0 4m11s 10.100.3.3 node-01.example.local pod/tomcat-deployment-78c89857d6-9qtr9 1/1 Running 0 4m14s 10.100.3.2 node-01.example.local NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR service/kubernetes ClusterIP 10.200.0.1 443/TCP 162m service/nginx-service NodePort 10.200.231.164 80:30004/TCP 4m11s app=nginx service/tomcat-service NodePort 10.200.206.119 80:30005/TCP 4m14s app=tomcat ç”Ÿæˆä¸€ä¸ªtomcat ä¸´æ—¶é¡µé¢\n[root@master-01 yaml]# kubectl get pod NAME READY STATUS RESTARTS AGE nginx-deployment-d44c4d8f4-bftm4 1/1 Running 0 6m18s tomcat-deployment-78c89857d6-9qtr9 1/1 Running 0 6m21s [root@master-01 yaml]# [root@master-01 yaml]# kubectl exec -it tomcat-deployment-78c89857d6-9qtr9 bash root@tomcat-deployment-78c89857d6-9qtr9:/usr/local/tomcat# cd webapps root@tomcat-deployment-78c89857d6-9qtr9:/usr/local/tomcat/webapps# mkdir tomcat root@tomcat-deployment-78c89857d6-9qtr9:/usr/local/tomcat/webapps# echo \"Tomcat test page for pod of k8s~\" \u003e tomcat/index.html root@tomcat-deployment-78c89857d6-9qtr9:/usr/local/tomcat/webapps# exit exit 4.3 ä» dashboard æŸ¥çœ‹ç»“æœ 4.4 é…ç½® nginx å®ç°åŠ¨é™åˆ†ç¦» [[root@master-01 ~]# kubectl get pod,svc NAME READY STATUS RESTARTS AGE pod/net-test-88ff4d957-krc9v 1/1 Running 0 44m pod/nginx-deployment-d44c4d8f4-bftm4 1/1 Running 0 70m pod/tomcat-deployment-78c89857d6-9qtr9 1/1 Running 0 70m NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/kubernetes ClusterIP 10.200.0.1 443/TCP 3h49m service/nginx-service NodePort 10.200.231.164 80:30004/TCP 70m service/tomcat-service NodePort 10.200.206.119 80:30005/TCP 70m [root@master-01 ~]# kubectl exec -it nginx-deployment-d44c4d8f4-bftm4 bash root@nginx-deployment-d44c4d8f4-bftm4:/# root@nginx-deployment-d44c4d8f4-sfslr:/# cat \u003e /etc/nginx/conf.d/default.conf \u003c\u003c EOF server { listen 80; listen [::]:80; server_name localhost; location /tomcat { proxy_pass http://tomcat-service.default.svc.example.local; } error_page 500 502 503 504 /50x.html; location = /50x.html { root /usr/share/nginx/html; } } EOF root@nginx-deployment-d44c4d8f4-bftm4:/# nginx -t nginx: the configuration file /etc/nginx/nginx.conf syntax is ok nginx: configuration file /etc/nginx/nginx.conf test is successful root@nginx-deployment-d44c4d8f4-bftm4:/# nginx -s reload 2023/10/02 11:44:15 [notice] 997#997: signal process started äº”ã€k8s é›†ç¾¤ç®¡ç† 5.1 token ç®¡ç† [root@master-01 ~]# kubeadm # åŒå‡» tab è¡¥å…¨å¾—åˆ°çš„ç»“æœ alpha completion config init join reset token upgrade version [root@master-01 ~]# kubeadm token create delete generate list 5.2 reset å‘½ä»¤ åœ¨åˆå§‹åŒ–é›†ç¾¤æ—¶ï¼Œå¦‚æœç”Ÿæˆäº†é”™è¯¯çš„é…ç½®ï¼Œå¯ä»¥ç”¨è¯¥å‘½ä»¤é‡ç½®ç¯å¢ƒ\n[root@master-01 ~]# kubeadm reset kubeadm reset å‘½ä»¤ç”¨äºå°†KubernetesèŠ‚ç‚¹ï¼ˆé€šå¸¸æ˜¯å·¥ä½œèŠ‚ç‚¹ï¼‰æ¢å¤åˆ°å…¶åˆå§‹çŠ¶æ€ï¼Œå°†èŠ‚ç‚¹ä»Kubernetesé›†ç¾¤ä¸­åˆ†ç¦»å¹¶æ¸…ç†é›†ç¾¤ç›¸å…³çš„é…ç½®å’Œæ•°æ®ã€‚è¿™ä¸ªå‘½ä»¤çš„ä¸»è¦ä½œç”¨åŒ…æ‹¬ï¼š\nèŠ‚ç‚¹çš„è„±ç¦»é›†ç¾¤ï¼škubeadm reset ä¼šå°†èŠ‚ç‚¹ä»Kubernetesé›†ç¾¤ä¸­åˆ†ç¦»ã€‚è¿™åŒ…æ‹¬åˆ é™¤èŠ‚ç‚¹çš„è¯ä¹¦ã€ä»é›†ç¾¤ä¸­åˆ é™¤èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œå¹¶ä¸”èŠ‚ç‚¹å°†ä¸å†å‚ä¸é›†ç¾¤ä¸­çš„é€šä¿¡å’Œç®¡ç†ã€‚\næ¸…ç†é…ç½®æ–‡ä»¶ï¼šå®ƒä¼šåˆ é™¤Kubernetesçš„é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚kubeconfigæ–‡ä»¶ï¼Œä»¥åŠCNIï¼ˆå®¹å™¨ç½‘ç»œæ¥å£ï¼‰æ’ä»¶çš„é…ç½®ï¼Œä»¥ç¡®ä¿ä¸å†å½±å“Kubernetesé›†ç¾¤ã€‚\næ¸…ç†æ•°æ®ï¼škubeadm reset è¿˜ä¼šæ¸…ç†èŠ‚ç‚¹ä¸Šçš„Kubernetesæ•°æ®ï¼ŒåŒ…æ‹¬åˆ é™¤å®¹å™¨ã€å·ã€æ•°æ®å­˜å‚¨ç­‰ï¼Œä»¥ç¡®ä¿èŠ‚ç‚¹ä¸å†åŒ…å«ä¸Kubernetesé›†ç¾¤ç›¸å…³çš„æ®‹ç•™æ•°æ®ã€‚\nè¿™ä¸ªå‘½ä»¤é€šå¸¸åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä½¿ç”¨ï¼š\nå½“ä½ éœ€è¦å¸è½½æˆ–ç§»é™¤èŠ‚ç‚¹ä¸Šçš„Kubernetesæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ kubeadm reset æ¥æ¸…ç†èŠ‚ç‚¹ï¼Œç„¶åé‡æ–°é…ç½®æˆ–é‡æ–°éƒ¨ç½²Kubernetesã€‚\nåœ¨æµ‹è¯•ç¯å¢ƒä¸­ï¼Œå½“ä½ éœ€è¦é‡ç½®ä¸€ä¸ªèŠ‚ç‚¹ä»¥è¿›è¡Œæ–°çš„Kubernetesé›†ç¾¤é…ç½®æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ kubeadm resetã€‚\nè¯·æ³¨æ„ï¼Œkubeadm reset åªåº”è¯¥ç”¨äºèŠ‚ç‚¹çº§åˆ«çš„æ“ä½œï¼Œå¹¶ä¸”åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨æ—¶éœ€è¦è°¨æ…ï¼Œå› ä¸ºå®ƒä¼šåˆ é™¤èŠ‚ç‚¹ä¸Šçš„Kubernetesç›¸å…³æ•°æ®ã€‚å¦‚æœä½ éœ€è¦ä»æ•´ä¸ªKubernetesé›†ç¾¤ä¸­ç§»é™¤èŠ‚ç‚¹ï¼Œè¯·é¦–å…ˆä½¿ç”¨ kubectl drain å‘½ä»¤å°†èŠ‚ç‚¹ä¸Šçš„å·¥ä½œè´Ÿè½½è¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œç„¶åå†ä½¿ç”¨ kubeadm reset è¿›è¡ŒèŠ‚ç‚¹çš„é‡ç½®å’Œå¸è½½ã€‚\n5.3 æŸ¥çœ‹è¯ä¹¦æœ‰æ•ˆæœŸ [root@master-01 ~]# kubeadm alpha certs kubeconfig kubelet selfhosting [root@master-01 ~]# kubeadm alpha certs certificate-key check-expiration renew # æ£€æŸ¥è¯ä¹¦æ˜¯å¦è¿‡æœŸï¼Œå¯ä»¥å‘ç° kubeadm éƒ¨ç½²çš„é›†ç¾¤ï¼Œè¯ä¹¦æœ‰æ•ˆæœŸä¸º 365dï¼ˆä¸€å¹´ï¼‰ [root@master-01 ~]# kubeadm alpha certs check-expiration [check-expiration] Reading configuration from the cluster... [check-expiration] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml' CERTIFICATE EXPIRES RESIDUAL TIME CERTIFICATE AUTHORITY EXTERNALLY MANAGED admin.conf Oct 01, 2024 07:58 UTC 364d no apiserver Oct 01, 2024 07:58 UTC 364d ca no apiserver-etcd-client Oct 01, 2024 07:58 UTC 364d etcd-ca no apiserver-kubelet-client Oct 01, 2024 07:58 UTC 364d ca no controller-manager.conf Oct 01, 2024 07:58 UTC 364d no etcd-healthcheck-client Oct 01, 2024 07:58 UTC 364d etcd-ca no etcd-peer Oct 01, 2024 07:58 UTC 364d etcd-ca no etcd-server Oct 01, 2024 07:58 UTC 364d etcd-ca no front-proxy-client Oct 01, 2024 07:58 UTC 364d front-proxy-ca no scheduler.conf Oct 01, 2024 07:58 UTC 364d no CERTIFICATE AUTHORITY EXPIRES RESIDUAL TIME EXTERNALLY MANAGED ca Sep 29, 2033 07:58 UTC 9y no etcd-ca Sep 29, 2033 07:58 UTC 9y no front-proxy-ca Sep 29, 2033 07:58 UTC 9y no 5.4 æ›´æ–°è¯ä¹¦æœ‰æ•ˆæœŸ å‚è€ƒé“¾æ¥ï¼š\nhttps://www.qikqiak.com/post/update-k8s-10y-expire-certs/\nhttps://www.chenshaowen.com/blog/how-to-renew-kubernetes-certs-manually.html\n[root@master-01 ~]# kubeadm alpha certs renew admin.conf apiserver-etcd-client etcd-healthcheck-client front-proxy-client all apiserver-kubelet-client etcd-peer scheduler.conf apiserver controller-manager.conf etcd-server # æ›´æ–°æ‰€æœ‰è¯ä¹¦ [root@master-01 ~]# kubeadm alpha certs renew all å®Œæˆåé‡å¯ kube-apiserverã€kube-controllerã€kube-scheduler è¿™ 3ä¸ªå®¹å™¨å³å¯ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ apiserver çš„è¯ä¹¦çš„æœ‰æ•ˆæœŸæ¥éªŒè¯æ˜¯å¦æ›´æ–°æˆåŠŸï¼š\n[root@master-01 ~]# docker ps |egrep \"k8s_kube-apiserver|k8s_kube-scheduler|k8s_kube-controller\"|awk '{print $1}'|xargs docker restart c2d987734f5a 043af8733130 5a87240ba97a [root@master-01 ~]# echo | openssl s_client -showcerts -connect 127.0.0.1:6443 -servername api 2\u003e/dev/null | openssl x509 -noout -enddate notAfter=Oct 1 13:17:56 2024 GMT å…­ã€k8s é›†ç¾¤å‡çº§ kubeadm éƒ¨ç½²çš„é›†ç¾¤éœ€è¦ç”¨ kubeadm æ¥å‡çº§ï¼Œé¦–å…ˆéœ€è¦å°† kubeadm å‡çº§åˆ°ç›®æ ‡ç‰ˆæœ¬ï¼Œç„¶åå†ç»§ç»­å…¶ä»–æ“ä½œã€‚\n6.1 å‡çº§å‡†å¤‡ æœ¬æ¬¡å‡çº§ï¼Œç›®æ ‡ç‰ˆæœ¬ï¼šv1.19.2\næŸ¥çœ‹å½“å‰ç‰ˆæœ¬\n[root@master-01 ~]# kubeadm version kubeadm version: \u0026version.Info{Major:\"1\", Minor:\"17\", GitVersion:\"v1.17.11\", GitCommit:\"ea5f00d93211b7c80247bf607cfa422ad6fb5347\", GitTreeState:\"clean\", BuildDate:\"2020-08-13T15:17:52Z\", GoVersion:\"go1.13.15\", Compiler:\"gc\", Platform:\"linux/amd64\"} # æŸ¥çœ‹ yum æºæ˜¯å¦æœ‰ç›®æ ‡ç‰ˆæœ¬ [root@master-01 ~]# yum list kubectl kubeadm kubelet --showduplicates | grep 1.19.2 kubeadm.x86_64 1.19.2-0 kubernetes kubectl.x86_64 1.19.2-0 kubernetes kubelet.x86_64 1.19.2-0 kubernetes 6.2 å‡çº§ master èŠ‚ç‚¹ æ»šåŠ¨å¼å‡çº§ master èŠ‚ç‚¹\n# å®‰è£…éƒ¨ç½²å·¥å…· yum install -y kubelet-1.19.2 kubectl-1.19.2 kubeadm-1.19.2 [root@master-01 ~]# kubeadm version kubeadm version: \u0026version.Info{Major:\"1\", Minor:\"19\", GitVersion:\"v1.19.2\", GitCommit:\"f5743093fd1c663cb0cbc89748f730662345d44d\", GitTreeState:\"clean\", BuildDate:\"2020-09-16T13:38:53Z\", GoVersion:\"go1.15\", Compiler:\"gc\", Platform:\"linux/amd64\"} æŸ¥çœ‹ç‰ˆæœ¬å‡çº§è®¡åˆ’\n[root@master-01 ~]# kubeadm upgrade plan [upgrade/config] Making sure the configuration is correct: [upgrade/config] Reading configuration from the cluster... [upgrade/config] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml' [upgrade/config] FATAL: this version of kubeadm only supports deploying clusters with the control plane version \u003e= 1.18.0. Current version: v1.17.11 # ç‰ˆæœ¬ä½äº 1.18.0ï¼Œkubeadm ä¸æ”¯æŒå‡çº§æ“ä½œ To see the stack trace of this error execute with --v=5 or higher å¦‚æœé€‰æ‹©çš„ç‰ˆæœ¬ç¬¦åˆ kubeadm çš„è¦æ±‚ï¼Œåˆ™ç»§ç»­ä»¥ä¸‹æ“ä½œ\n[root@master-01 ~]# kubeadm upgrade apply v1.19.2 å‡çº§å®Œæˆåï¼Œå¯ä»¥æŸ¥çœ‹é•œåƒç‰ˆæœ¬\n# docker images 6.3 å‡çº§ node èŠ‚ç‚¹ åŒæ ·æ˜¯æ»šåŠ¨å‡çº§çš„æ–¹å¼è¿›è¡Œ\n# å®‰è£…éƒ¨ç½²å·¥å…· yum install -y kubelet-1.19.2 kubectl-1.19.2 kubeadm-1.19.2 # æ‰§è¡Œå‡çº§æ“ä½œ kubeadm upgrade node --kubelet-version 1.19.2 ","wordCount":"8416","inLanguage":"zh","datePublished":"2023-10-02T22:37:50+08:00","dateModified":"2023-10-02T22:37:50+08:00","author":[{"@type":"Person","name":"wz"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://senmer.github.io/zh/posts/tech/kubernetes/kubeadm%E9%83%A8%E7%BD%B2k8s%E9%9B%86%E7%BE%A4/"},"publisher":{"@type":"Organization","name":"WZ's Blog","logo":{"@type":"ImageObject","url":"https://senmer.github.io/img/Q.gif"}}}</script></head><body id=top><script>(function(){let e,t=new RegExp("(^| )change-themes=([^;]*)(;|$)");(e=document.cookie.match(t))||((new Date).getHours()>=19||(new Date).getHours()<6?(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark")):(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")))})(),localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://senmer.github.io/zh/ accesskey=h title="WZ's Blog (Alt + H)"><img src=https://senmer.github.io/img/Q.gif alt=logo aria-label=logo height=35>WZ's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://senmer.github.io/zh/search title="ğŸ” æœç´¢ (Alt + /)" accesskey=/><span>ğŸ” æœç´¢</span></a></li><li><a href=https://senmer.github.io/zh/ title="ğŸ  ä¸»é¡µ"><span>ğŸ  ä¸»é¡µ</span></a></li><li><a href=https://senmer.github.io/zh/posts/tech title="ğŸ“š æ–‡ç« "><span>ğŸ“š æ–‡ç« </span></a></li><li><a href=https://senmer.github.io/zh/categories/ title="ğŸ§© åˆ†ç±»"><span>ğŸ§© åˆ†ç±»</span></a></li><li><a href=https://senmer.github.io/zh/archives/ title="â±ï¸ æ—¶é—´è½´"><span>â±ï¸ æ—¶é—´è½´</span></a></li></ul></nav></header><main class="main page"><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}</style><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://senmer.github.io/zh/>ğŸ  ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://senmer.github.io/zh/posts/>ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href=https://senmer.github.io/zh/posts/tech/>ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div><h1 class=post-title>Kubeadméƒ¨ç½²k8sé›†ç¾¤</h1><div class=post-meta><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}.parent-post-meta{display:flex;flex-wrap:wrap;opacity:.8}</style><span class=parent-post-meta><span id=post_meta_style_1><span class="fa fa-calendar-check-o"></span>
<span>2023-10-02
&nbsp;&nbsp;
</span></span><span id=post_meta_style_3><span class="fa fa-file-word-o"></span>
<span>8416å­—
&nbsp;&nbsp;
</span></span><span id=post_meta_style_4><span class="fa fa-clock-o"></span>
<span>17åˆ†é’Ÿ
&nbsp;&nbsp;
</span></span><span id=post_meta_style_5><span class="fa fa-user-o"></span>
<span>wz
&nbsp;&nbsp;
</span></span><span id=post_meta_style_6><span class="fa fa-tags" style=opacity:.8></span>
<span><span class=post-tags-meta></span></span></span></span><span style=opacity:.8><span id=post_meta_style_7>&nbsp;&nbsp;
<span class="fa fa-eye"></span>
<span><span id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv></span></span>
&nbsp;&nbsp;
</span></span><span id=post_meta_style_8><span class="fa fa-commenting-o"></span>
<span><script src=https://cdn.staticfile.org/twikoo/1.6.16/twikoo.all.min.js></script><script>let url=document.documentURI,dnsUrl="https://senmer.github.io/",urlSplit=url.split(dnsUrl),finalUrl=urlSplit[1];finalUrl[0]!=="/"&&(finalUrl="/"+finalUrl),twikoo.getCommentsCount({envId:"https://hugo-api-khaki.vercel.app/# å¡«å†™è‡ªå·±çš„twikoo id",region:null,urls:[finalUrl],includeReply:!1}).then(function(e){let t=e[0].count;const n=document.getElementById("comment_count");n.innerText=t}).catch(function(e){console.error(e)})</script><span id=comment_count></span></span></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#%e4%b8%80-%e7%ae%80%e4%bb%8b aria-label="ä¸€ã€ ç®€ä»‹">ä¸€ã€ ç®€ä»‹</a><ul><li><a href=#11-k8s-%e6%98%af%e4%bb%80%e4%b9%88 aria-label="1.1 k8s æ˜¯ä»€ä¹ˆ">1.1 k8s æ˜¯ä»€ä¹ˆ</a></li><li><a href=#12-k8s-%e7%9a%84%e4%bc%98%e5%8a%bf aria-label="1.2 k8s çš„ä¼˜åŠ¿">1.2 k8s çš„ä¼˜åŠ¿</a></li><li><a href=#13-k8s-%e7%bb%84%e4%bb%b6%e4%bb%8b%e7%bb%8d aria-label="1.3 k8s ç»„ä»¶ä»‹ç»">1.3 k8s ç»„ä»¶ä»‹ç»</a></li></ul></li><li><a href=#%e4%ba%8ck8s-%e5%ae%89%e8%a3%85%e9%83%a8%e7%bd%b2kubeadm aria-label="äºŒã€k8s å®‰è£…éƒ¨ç½²ï¼ˆkubeadmï¼‰">äºŒã€k8s å®‰è£…éƒ¨ç½²ï¼ˆkubeadmï¼‰</a><ul><li><a href=#21-%e5%ae%89%e8%a3%85%e6%96%b9%e5%bc%8f aria-label="2.1 å®‰è£…æ–¹å¼">2.1 å®‰è£…æ–¹å¼</a></li><li><a href=#22-%e9%83%a8%e7%bd%b2%e8%bf%87%e7%a8%8b aria-label="2.2 éƒ¨ç½²è¿‡ç¨‹">2.2 éƒ¨ç½²è¿‡ç¨‹</a><ul><li><a href=#221-%e5%85%b7%e4%bd%93%e6%ad%a5%e9%aa%a4 aria-label="2.2.1 å…·ä½“æ­¥éª¤">2.2.1 å…·ä½“æ­¥éª¤</a></li><li><a href=#222--%e9%83%a8%e7%bd%b2%e7%8e%af%e5%a2%83 aria-label="2.2.2  éƒ¨ç½²ç¯å¢ƒ">2.2.2 éƒ¨ç½²ç¯å¢ƒ</a></li></ul></li><li><a href=#23-%e9%83%a8%e7%bd%b2%e9%ab%98%e5%8f%af%e7%94%a8%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86 aria-label="2.3 éƒ¨ç½²é«˜å¯ç”¨åå‘ä»£ç†">2.3 éƒ¨ç½²é«˜å¯ç”¨åå‘ä»£ç†</a></li><li><a href=#24-%e9%83%a8%e7%bd%b2-harbor aria-label="2.4 éƒ¨ç½² harbor">2.4 éƒ¨ç½² harbor</a></li><li><a href=#25-%e6%89%80%e6%9c%89%e8%8a%82%e7%82%b9%e5%ae%89%e8%a3%85-docker aria-label="2.5 æ‰€æœ‰èŠ‚ç‚¹å®‰è£… docker">2.5 æ‰€æœ‰èŠ‚ç‚¹å®‰è£… docker</a></li><li><a href=#26-%e6%89%80%e6%9c%89%e8%8a%82%e7%82%b9%e5%ae%89%e8%a3%85%e9%9b%86%e7%be%a4%e5%88%9d%e5%a7%8b%e5%8c%96%e5%b7%a5%e5%85%b7 aria-label="2.6 æ‰€æœ‰èŠ‚ç‚¹å®‰è£…é›†ç¾¤åˆå§‹åŒ–å·¥å…·">2.6 æ‰€æœ‰èŠ‚ç‚¹å®‰è£…é›†ç¾¤åˆå§‹åŒ–å·¥å…·</a><ul><li><a href=#261-%e9%85%8d%e7%bd%ae%e5%9b%bd%e5%86%85%e9%95%9c%e5%83%8f%e6%ba%90 aria-label="2.6.1 é…ç½®å›½å†…é•œåƒæº">2.6.1 é…ç½®å›½å†…é•œåƒæº</a></li><li><a href=#262-%e5%ae%89%e8%a3%85%e5%88%9d%e5%a7%8b%e5%8c%96%e5%b7%a5%e5%85%b7 aria-label="2.6.2 å®‰è£…åˆå§‹åŒ–å·¥å…·">2.6.2 å®‰è£…åˆå§‹åŒ–å·¥å…·</a></li><li><a href=#263-kubeadm-%e5%91%bd%e4%bb%a4%e7%9a%84%e4%bd%bf%e7%94%a8 aria-label="2.6.3 kubeadm å‘½ä»¤çš„ä½¿ç”¨">2.6.3 kubeadm å‘½ä»¤çš„ä½¿ç”¨</a></li></ul></li><li><a href=#27-k8s-%e5%8d%95%e8%8a%82%e7%82%b9%e9%83%a8%e7%bd%b2 aria-label="2.7 k8s å•èŠ‚ç‚¹éƒ¨ç½²">2.7 k8s å•èŠ‚ç‚¹éƒ¨ç½²</a><ul><li><a href=#271-%e5%bc%80%e5%a7%8b%e9%83%a8%e7%bd%b2 aria-label="2.7.1 å¼€å§‹éƒ¨ç½²">2.7.1 å¼€å§‹éƒ¨ç½²</a></li><li><a href=#272-%e9%aa%8c%e8%af%81%e7%bb%93%e6%9e%9c aria-label="2.7.2 éªŒè¯ç»“æœ">2.7.2 éªŒè¯ç»“æœ</a></li><li><a href=#273-%e9%83%a8%e7%bd%b2%e7%bd%91%e7%bb%9c%e7%bb%84%e4%bb%b6 aria-label="2.7.3 éƒ¨ç½²ç½‘ç»œç»„ä»¶">2.7.3 éƒ¨ç½²ç½‘ç»œç»„ä»¶</a></li></ul></li><li><a href=#28-k8s-%e5%a4%9a%e8%8a%82%e7%82%b9%e9%83%a8%e7%bd%b2%e9%ab%98%e5%8f%af%e7%94%a8 aria-label="2.8 k8s å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼ˆé«˜å¯ç”¨ï¼‰">2.8 k8s å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼ˆé«˜å¯ç”¨ï¼‰</a><ul><li><a href=#281-%e5%bc%80%e5%a7%8b%e9%83%a8%e7%bd%b2 aria-label="2.8.1 å¼€å§‹éƒ¨ç½²">2.8.1 å¼€å§‹éƒ¨ç½²</a></li><li><a href=#282-%e6%b7%bb%e5%8a%a0-master-%e8%8a%82%e7%82%b9 aria-label="2.8.2 æ·»åŠ  master èŠ‚ç‚¹">2.8.2 æ·»åŠ  master èŠ‚ç‚¹</a></li><li><a href=#283-%e6%b7%bb%e5%8a%a0-node-%e8%8a%82%e7%82%b9 aria-label="2.8.3 æ·»åŠ  node èŠ‚ç‚¹">2.8.3 æ·»åŠ  node èŠ‚ç‚¹</a></li><li><a href=#284-%e6%9f%a5%e7%9c%8b%e9%9b%86%e7%be%a4%e8%af%81%e4%b9%a6 aria-label="2.8.4 æŸ¥çœ‹é›†ç¾¤è¯ä¹¦">2.8.4 æŸ¥çœ‹é›†ç¾¤è¯ä¹¦</a></li><li><a href=#285-%e5%88%9b%e5%bb%ba-pod-%e9%aa%8c%e8%af%81%e9%9b%86%e7%be%a4%e7%bd%91%e7%bb%9c aria-label="2.8.5 åˆ›å»º pod éªŒè¯é›†ç¾¤ç½‘ç»œ">2.8.5 åˆ›å»º pod éªŒè¯é›†ç¾¤ç½‘ç»œ</a></li></ul></li></ul></li><li><a href=#%e4%b8%89%e9%83%a8%e7%bd%b2-dashboard aria-label="ä¸‰ã€éƒ¨ç½² Dashboard">ä¸‰ã€éƒ¨ç½² Dashboard</a><ul><li><a href=#31-%e5%87%86%e5%a4%87%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-label="3.1 å‡†å¤‡é…ç½®æ–‡ä»¶">3.1 å‡†å¤‡é…ç½®æ–‡ä»¶</a></li><li><a href=#32-%e9%83%a8%e7%bd%b2%e5%b9%b6%e9%aa%8c%e8%af%81%e6%95%88%e6%9e%9c aria-label="3.2 éƒ¨ç½²å¹¶éªŒè¯æ•ˆæœ">3.2 éƒ¨ç½²å¹¶éªŒè¯æ•ˆæœ</a></li></ul></li><li><a href=#%e5%9b%9bk8s-%e9%83%a8%e7%bd%b2-nginx--tomcat aria-label="å››ã€k8s éƒ¨ç½² nginx + tomcat">å››ã€k8s éƒ¨ç½² nginx + tomcat</a><ul><li><a href=#41-%e9%83%a8%e7%bd%b2-nginx aria-label="4.1 éƒ¨ç½² nginx">4.1 éƒ¨ç½² nginx</a></li><li><a href=#42-%e9%83%a8%e7%bd%b2-tomcat aria-label="4.2 éƒ¨ç½² tomcat">4.2 éƒ¨ç½² tomcat</a></li><li><a href=#43-%e4%bb%8e-dashboard-%e6%9f%a5%e7%9c%8b%e7%bb%93%e6%9e%9c aria-label="4.3 ä» dashboard æŸ¥çœ‹ç»“æœ">4.3 ä» dashboard æŸ¥çœ‹ç»“æœ</a></li><li><a href=#44-%e9%85%8d%e7%bd%ae-nginx-%e5%ae%9e%e7%8e%b0%e5%8a%a8%e9%9d%99%e5%88%86%e7%a6%bb aria-label="4.4 é…ç½® nginx å®ç°åŠ¨é™åˆ†ç¦»">4.4 é…ç½® nginx å®ç°åŠ¨é™åˆ†ç¦»</a></li></ul></li><li><a href=#%e4%ba%94k8s-%e9%9b%86%e7%be%a4%e7%ae%a1%e7%90%86 aria-label="äº”ã€k8s é›†ç¾¤ç®¡ç†">äº”ã€k8s é›†ç¾¤ç®¡ç†</a><ul><li><a href=#51-token-%e7%ae%a1%e7%90%86 aria-label="5.1 token ç®¡ç†">5.1 token ç®¡ç†</a></li><li><a href=#52-reset-%e5%91%bd%e4%bb%a4 aria-label="5.2 reset å‘½ä»¤">5.2 reset å‘½ä»¤</a></li><li><a href=#53-%e6%9f%a5%e7%9c%8b%e8%af%81%e4%b9%a6%e6%9c%89%e6%95%88%e6%9c%9f aria-label="5.3 æŸ¥çœ‹è¯ä¹¦æœ‰æ•ˆæœŸ">5.3 æŸ¥çœ‹è¯ä¹¦æœ‰æ•ˆæœŸ</a></li><li><a href=#54-%e6%9b%b4%e6%96%b0%e8%af%81%e4%b9%a6%e6%9c%89%e6%95%88%e6%9c%9f aria-label="5.4 æ›´æ–°è¯ä¹¦æœ‰æ•ˆæœŸ">5.4 æ›´æ–°è¯ä¹¦æœ‰æ•ˆæœŸ</a></li></ul></li><li><a href=#%e5%85%adk8s-%e9%9b%86%e7%be%a4%e5%8d%87%e7%ba%a7 aria-label="å…­ã€k8s é›†ç¾¤å‡çº§">å…­ã€k8s é›†ç¾¤å‡çº§</a><ul><li><a href=#61-%e5%8d%87%e7%ba%a7%e5%87%86%e5%a4%87 aria-label="6.1 å‡çº§å‡†å¤‡">6.1 å‡çº§å‡†å¤‡</a></li><li><a href=#62-%e5%8d%87%e7%ba%a7-master-%e8%8a%82%e7%82%b9 aria-label="6.2 å‡çº§ master èŠ‚ç‚¹">6.2 å‡çº§ master èŠ‚ç‚¹</a></li><li><a href=#63-%e5%8d%87%e7%ba%a7-node-%e8%8a%82%e7%82%b9 aria-label="6.3 å‡çº§ node èŠ‚ç‚¹">6.3 å‡çº§ node èŠ‚ç‚¹</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=ä¸€-ç®€ä»‹>ä¸€ã€ ç®€ä»‹<a hidden class=anchor aria-hidden=true href=#ä¸€-ç®€ä»‹>#</a></h2><h3 id=11-k8s-æ˜¯ä»€ä¹ˆ>1.1 k8s æ˜¯ä»€ä¹ˆ<a hidden class=anchor aria-hidden=true href=#11-k8s-æ˜¯ä»€ä¹ˆ>#</a></h3><p>Kubernetesï¼ˆé€šå¸¸è¢«ç®€ç§°ä¸ºK8sï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å’Œç®¡ç†å¹³å°ï¼Œç”¨äºè‡ªåŠ¨åŒ–å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ã€æ‰©å±•å’Œæ“ä½œã€‚å®ƒç”±Googleå¼€å‘å¹¶æèµ ç»™äº†äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼ˆCNCFï¼‰ã€‚Kubernetesæ—¨åœ¨è§£å†³å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ç®¡ç†å’Œéƒ¨ç½²é—®é¢˜ï¼Œä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿæ›´è½»æ¾åœ°æ„å»ºã€äº¤ä»˜å’Œè¿è¡Œå®¹å™¨åŒ–åº”ç”¨ã€‚</p><h3 id=12-k8s-çš„ä¼˜åŠ¿>1.2 k8s çš„ä¼˜åŠ¿<a hidden class=anchor aria-hidden=true href=#12-k8s-çš„ä¼˜åŠ¿>#</a></h3><p>Kubernetes æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å¹³å°ï¼Œå®ƒæä¾›äº†ä¸€ç§ç®¡ç†å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„å¼ºå¤§æ–¹å¼ã€‚ä»¥ä¸‹æ˜¯ Kubernetes çš„ä¸€äº›ä¼˜åŠ¿ï¼š</p><ol><li><strong>è‡ªåŠ¨åŒ–å’Œè‡ªæˆ‘ä¿®å¤ï¼š</strong> Kubernetes å¯ä»¥è‡ªåŠ¨ç›‘æµ‹åº”ç”¨ç¨‹åºçŠ¶æ€å¹¶è¿›è¡Œè‡ªæˆ‘ä¿®å¤ï¼Œç¡®ä¿åº”ç”¨æŒç»­ç¨³å®šè¿è¡Œã€‚å¦‚æœæŸä¸ªå®¹å™¨æˆ–èŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼ŒKubernetes ä¼šè‡ªåŠ¨é‡æ–°å¯åŠ¨å®¹å™¨æˆ–è¿ç§»å·¥ä½œè´Ÿè½½ã€‚</li><li><strong>å¼¹æ€§æ‰©å±•ï¼š</strong> Kubernetes å…è®¸æ ¹æ®éœ€è¦æ‰©å±•æˆ–ç¼©å‡åº”ç”¨ç¨‹åºå®ä¾‹çš„æ•°é‡ã€‚è¿™ç§è‡ªåŠ¨æ‰©å±•èƒ½åŠ›å¯æ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´åº”ç”¨çš„è§„æ¨¡ï¼Œä»¥æ»¡è¶³æµé‡éœ€æ±‚ï¼ŒåŒæ—¶åœ¨éœ€æ±‚å‡å°‘æ—¶èŠ‚çº¦èµ„æºã€‚</li><li><strong>è´Ÿè½½å‡è¡¡ï¼š</strong> Kubernetes æ”¯æŒå†…ç½®çš„è´Ÿè½½å‡è¡¡ï¼Œå¯ä»¥å°†ä¼ å…¥çš„æµé‡åˆ†å‘åˆ°ä¸åŒçš„å®¹å™¨å®ä¾‹ä¸­ï¼Œç¡®ä¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿæœ‰æ•ˆåœ°å¤„ç†é«˜æµé‡ã€‚</li><li><strong>è‡ªåŠ¨éƒ¨ç½²å’Œæ»šåŠ¨æ›´æ–°ï¼š</strong> é€šè¿‡å£°æ˜å¼çš„é…ç½®ï¼ŒKubernetes å…è®¸ä½ è½»æ¾åœ°è¿›è¡Œåº”ç”¨ç¨‹åºçš„éƒ¨ç½²å’Œæ›´æ–°ã€‚æ»šåŠ¨æ›´æ–°åŠŸèƒ½å¯ä»¥é€æ­¥æ›¿æ¢æ—§ç‰ˆæœ¬çš„å®¹å™¨ï¼Œä»è€Œå‡å°‘åº”ç”¨ç¨‹åºçš„åœæœºæ—¶é—´ã€‚</li><li><strong>å¤šç¯å¢ƒæ”¯æŒï¼š</strong> Kubernetes æ”¯æŒå¤šä¸ªç¯å¢ƒï¼ˆä¾‹å¦‚å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰ä¹‹é—´çš„è½»æ¾è¿ç§»ï¼Œç¡®ä¿åº”ç”¨åœ¨ä¸åŒé˜¶æ®µçš„ä¸€è‡´æ€§ã€‚</li><li><strong>å£°æ˜å¼é…ç½®ï¼š</strong> ä½ å¯ä»¥ä½¿ç”¨ Kubernetes çš„ YAML æ–‡ä»¶æ¥å®šä¹‰åº”ç”¨ç¨‹åºçš„é…ç½®å’Œéƒ¨ç½²è¦æ±‚ã€‚è¿™ç§å£°æ˜å¼çš„æ–¹æ³•è®©ä½ èƒ½å¤Ÿæ›´æ¸…æ™°åœ°å®šä¹‰åº”ç”¨ç¨‹åºçŠ¶æ€ï¼Œè€Œ Kubernetes è´Ÿè´£å°†ç³»ç»ŸçŠ¶æ€è°ƒæ•´ä¸ºæ‰€éœ€çŠ¶æ€ã€‚</li><li><strong>è‡ªå®šä¹‰èµ„æºå’Œæ‰©å±•æ€§ï¼š</strong> Kubernetes å…è®¸ä½ åˆ›å»ºè‡ªå®šä¹‰èµ„æºå’Œæ§åˆ¶å™¨ï¼Œä»è€Œå¯ä»¥æ‰©å±•å¹³å°çš„åŠŸèƒ½ï¼Œæ»¡è¶³ç‰¹å®šåº”ç”¨ç¨‹åºæˆ–ä¸šåŠ¡çš„éœ€æ±‚ã€‚</li><li><strong>å¤šç§å®¹å™¨è¿è¡Œæ—¶æ”¯æŒï¼š</strong> Kubernetes æ”¯æŒå¤šç§å®¹å™¨è¿è¡Œæ—¶ï¼Œå¦‚ Dockerã€Containerd ç­‰ï¼Œä½¿ä½ å¯ä»¥é€‰æ‹©æœ€é€‚åˆä½ çš„åº”ç”¨çš„è¿è¡Œæ—¶ç¯å¢ƒã€‚</li><li><strong>ç¤¾åŒºæ”¯æŒå’Œç”Ÿæ€ç³»ç»Ÿï¼š</strong> Kubernetes æ‹¥æœ‰åºå¤§çš„ç¤¾åŒºå’Œä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿï¼Œæœ‰å¤§é‡çš„å·¥å…·ã€æ’ä»¶å’ŒæœåŠ¡ï¼Œå¯ä»¥å¸®åŠ©ä½ æ›´å¥½åœ°ç®¡ç†ã€ç›‘æ§å’Œæ‰©å±•ä½ çš„åº”ç”¨ç¨‹åºã€‚</li><li><strong>è·¨äº‘å’Œæœ¬åœ°ç¯å¢ƒï¼š</strong> Kubernetes å¯ä»¥åœ¨ä¸åŒçš„äº‘å¹³å°å’Œæœ¬åœ°ç¯å¢ƒä¸­è¿è¡Œï¼Œä½¿ä½ èƒ½å¤Ÿåœ¨ä¸åŒçš„åŸºç¡€æ¶æ„ä¸Šä¿æŒä¸€è‡´çš„éƒ¨ç½²å’Œç®¡ç†ä½“éªŒã€‚</li></ol><p>æ€»ä¹‹ï¼ŒKubernetes æä¾›äº†å¼ºå¤§çš„å®¹å™¨ç¼–æ’å’Œç®¡ç†åŠŸèƒ½ï¼Œå¸®åŠ©å¼€å‘äººå‘˜å’Œè¿ç»´å›¢é˜Ÿæ›´æœ‰æ•ˆåœ°éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†å®¹å™¨åŒ–åº”ç”¨ç¨‹åºã€‚å®ƒçš„ä¼˜åŠ¿åœ¨äºè‡ªåŠ¨åŒ–ã€å¼¹æ€§ã€çµæ´»æ€§ä»¥åŠä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿã€‚</p><h3 id=13-k8s-ç»„ä»¶ä»‹ç»>1.3 k8s ç»„ä»¶ä»‹ç»<a hidden class=anchor aria-hidden=true href=#13-k8s-ç»„ä»¶ä»‹ç»>#</a></h3><p>Kubernetesï¼ˆé€šå¸¸ç®€ç§°ä¸ºK8sï¼‰ç”±å¤šä¸ªç»„ä»¶ç»„æˆï¼Œè¿™äº›ç»„ä»¶å…±åŒåä½œä»¥ç®¡ç†å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸã€‚ä»¥ä¸‹æ˜¯å¸¸è§çš„ Kubernetes ç»„ä»¶åŠå…¶åŠŸèƒ½ä»‹ç»ï¼š</p><ol><li><strong>Kubeletï¼š</strong> è¿è¡Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ä»£ç†ï¼Œè´Ÿè´£ç®¡ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸã€‚å®ƒä¸ Master èŠ‚ç‚¹é€šä¿¡ï¼Œç¡®ä¿å®¹å™¨åœ¨èŠ‚ç‚¹ä¸ŠæŒ‰ç…§æ‰€éœ€çš„çŠ¶æ€è¿è¡Œã€‚</li><li><strong>Kube-Proxyï¼š</strong> ä¹Ÿè¿è¡Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šï¼Œç»´æŠ¤ç½‘ç»œè§„åˆ™ä»¥å®ç° Service æš´éœ²å’Œè´Ÿè½½å‡è¡¡ã€‚å®ƒæ ¹æ® Service é…ç½®æ›´æ–°èŠ‚ç‚¹ä¸Šçš„ iptables è§„åˆ™ã€‚</li><li><strong>Kube-Schedulerï¼š</strong> è´Ÿè´£ç›‘è§†æ–°åˆ›å»ºçš„ Podï¼Œå¹¶æ ¹æ®å„ç§æ¡ä»¶ï¼ˆå¦‚èµ„æºéœ€æ±‚ã€äº²å’Œæ€§ã€äº²å’Œæ€§ç­‰ï¼‰å°†å…¶è°ƒåº¦åˆ°é›†ç¾¤ä¸­çš„é€‚å½“èŠ‚ç‚¹ä¸Šã€‚</li><li><strong>Kube-Controller-Managerï¼š</strong> åŒ…å«å¤šä¸ªæ§åˆ¶å™¨ï¼Œç”¨äºç›‘æ§é›†ç¾¤çŠ¶æ€å¹¶æ ¹æ®éœ€è¦è¿›è¡Œè‡ªåŠ¨ä¿®å¤ã€‚å…¶ä¸­ä¸€äº›æ§åˆ¶å™¨åŒ…æ‹¬ï¼š<ul><li><strong>Replication Controller å’Œ ReplicaSet æ§åˆ¶å™¨ï¼š</strong> ç¡®ä¿åœ¨é›†ç¾¤ä¸­è¿è¡ŒæŒ‡å®šæ•°é‡çš„ Pod å‰¯æœ¬ã€‚</li><li><strong>Deployment æ§åˆ¶å™¨ï¼š</strong> ç®¡ç†åº”ç”¨ç¨‹åºçš„æ»šåŠ¨æ›´æ–°å’Œç‰ˆæœ¬æ§åˆ¶ã€‚</li><li><strong>Namespace æ§åˆ¶å™¨ï¼š</strong> ç®¡ç†å‘½åç©ºé—´çš„åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤ã€‚</li></ul></li><li><strong>Etcdï¼š</strong> æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ç³»ç»Ÿï¼Œç”¨äºå­˜å‚¨é›†ç¾¤çš„é…ç½®ä¿¡æ¯ã€çŠ¶æ€å’Œå…ƒæ•°æ®ã€‚Kubernetes ä½¿ç”¨ Etcd æ¥å­˜å‚¨æ‰€æœ‰å…³é”®ä¿¡æ¯ï¼ŒåŒ…æ‹¬é…ç½®ã€éƒ¨ç½²å’ŒæœåŠ¡å‘ç°ã€‚</li><li><strong>API Serverï¼š</strong> æä¾›äº† Kubernetes é›†ç¾¤çš„ APIï¼Œå…è®¸ç”¨æˆ·å’Œå…¶ä»–ç»„ä»¶ä¸é›†ç¾¤è¿›è¡Œäº¤äº’ã€‚æ‰€æœ‰çš„èµ„æºå’Œæ“ä½œéƒ½é€šè¿‡ API Server è¿›è¡Œè®¿é—®å’Œç®¡ç†ã€‚</li><li><strong>Container Runtimeï¼š</strong> è´Ÿè´£è¿è¡Œå®¹å™¨ï¼Œå¸¸è§çš„å®¹å™¨è¿è¡Œæ—¶åŒ…æ‹¬ Dockerã€Containerd ç­‰ã€‚</li><li><strong>Controller Managerï¼š</strong> åŒ…å«ä¸€ç³»åˆ—æ§åˆ¶å™¨ï¼Œè¿™äº›æ§åˆ¶å™¨å¯ä»¥ç›‘æ§é›†ç¾¤ä¸­çš„èµ„æºçŠ¶æ€ï¼Œå¹¶ç¡®ä¿æ‰€éœ€çŠ¶æ€ä¸å®é™…çŠ¶æ€ä¿æŒä¸€è‡´ã€‚</li><li><strong>Cloud Controller Managerï¼š</strong> åœ¨äº‘å¹³å°ä¸Šè¿è¡Œï¼Œç”¨äºé›†æˆ Kubernetes é›†ç¾¤ä¸ç‰¹å®šäº‘æä¾›å•†çš„åŠŸèƒ½ï¼Œå¦‚è‡ªåŠ¨æ‰©å±•ã€è´Ÿè½½å‡è¡¡ç­‰ã€‚</li><li><strong>Admission Controllersï¼š</strong> ç”¨äºæ‹¦æˆªå’Œä¿®æ”¹è¿›å…¥ Kubernetes é›†ç¾¤çš„è¯·æ±‚ã€‚è¿™äº›æ§åˆ¶å™¨å¯ä»¥æ‰§è¡ŒéªŒè¯ã€é»˜è®¤å€¼è®¾ç½®å’Œä¿®æ”¹è¯·æ±‚ï¼Œä»¥ç¡®ä¿éµå¾ªé›†ç¾¤ç­–ç•¥ã€‚</li><li><strong>Ingress Controllerï¼š</strong> ç®¡ç† Ingress èµ„æºï¼Œå°†å¤–éƒ¨æµé‡å¼•å¯¼åˆ°é›†ç¾¤å†…éƒ¨çš„æœåŠ¡ã€‚</li><li><strong>Podsï¼š</strong> æ˜¯ Kubernetes çš„æœ€å°è°ƒåº¦å•ä½ï¼Œå¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ã€‚å®ƒä»¬å¯ä»¥å…±äº«ç½‘ç»œå’Œå­˜å‚¨ï¼Œå½¢æˆä¸€ä¸ªé€»è¾‘å•å…ƒã€‚</li><li><strong>Servicesï¼š</strong> ç”¨äºå®šä¹‰ä¸€ç»„ Pod çš„è®¿é—®æ–¹å¼ï¼Œæä¾›è´Ÿè½½å‡è¡¡å’ŒæœåŠ¡å‘ç°åŠŸèƒ½ï¼Œä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿåœ¨ä¸åŒçš„ Pod ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚</li><li><strong>ConfigMaps å’Œ Secretsï¼š</strong> ç”¨äºå°†é…ç½®å’Œæœºå¯†ä¿¡æ¯ä¸åº”ç”¨ç¨‹åºåˆ†å¼€ï¼Œå¹¶åœ¨å®¹å™¨ä¸­ä»¥ç¯å¢ƒå˜é‡æˆ–å·çš„å½¢å¼æä¾›ã€‚</li></ol><p>è¿™äº›ç»„ä»¶ä¸€èµ·ååŒå·¥ä½œï¼Œä½¿ Kubernetes èƒ½å¤Ÿæä¾›å¼ºå¤§çš„å®¹å™¨ç¼–æ’å’Œç®¡ç†åŠŸèƒ½ã€‚æ¯ä¸ªç»„ä»¶éƒ½æ‰®æ¼”ç€ä¸åŒçš„è§’è‰²ï¼Œç¡®ä¿å®¹å™¨åŒ–åº”ç”¨ç¨‹åºèƒ½å¤Ÿä»¥é«˜å¯ç”¨æ€§ã€è‡ªåŠ¨åŒ–å’Œå¼¹æ€§çš„æ–¹å¼è¿è¡Œã€‚</p><h2 id=äºŒk8s-å®‰è£…éƒ¨ç½²kubeadm>äºŒã€k8s å®‰è£…éƒ¨ç½²ï¼ˆkubeadmï¼‰<a hidden class=anchor aria-hidden=true href=#äºŒk8s-å®‰è£…éƒ¨ç½²kubeadm>#</a></h2><blockquote><p>æ³¨æ„ï¼šæœ¬æ–‡å®‰è£…çš„ k8s ç‰ˆæœ¬ä¸º <code>v1.17.11</code>ï¼Œä¸èƒ½ç›´æ¥é€šè¿‡ kubeadm æ‰§è¡Œå‡çº§æ“ä½œã€‚å¦‚æœéœ€è¦è¿›è¡Œå‡çº§æ“ä½œï¼Œéœ€è¦æ»¡è¶³ <code>version >= 1.18.0</code></p></blockquote><h3 id=21-å®‰è£…æ–¹å¼>2.1 å®‰è£…æ–¹å¼<a hidden class=anchor aria-hidden=true href=#21-å®‰è£…æ–¹å¼>#</a></h3><p>Kubernetes çš„å®‰è£…å¯ä»¥åˆ†ä¸ºå¤šç§æ–¹å¼ï¼Œæ ¹æ®ä½ çš„éœ€æ±‚å’Œç¯å¢ƒé€‰æ‹©åˆé€‚çš„å®‰è£…æ–¹å¼ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ Kubernetes å®‰è£…æ–¹å¼ï¼š</p><ol><li><p><strong>Minikubeï¼š</strong> å¦‚æœä½ æƒ³åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­å¿«é€Ÿæ­å»ºä¸€ä¸ªå•èŠ‚ç‚¹çš„ Kubernetes é›†ç¾¤ï¼Œå¯ä»¥ä½¿ç”¨ Minikubeã€‚Minikube åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºï¼Œå¹¶åœ¨å…¶ä¸­è¿è¡Œä¸€ä¸ªå•èŠ‚ç‚¹çš„ Kubernetes é›†ç¾¤ã€‚é€‚åˆå­¦ä¹ å’Œå¼€å‘ç›®çš„ã€‚</p></li><li><p><strong>Kubeadmï¼š</strong> Kubeadm æ˜¯ä¸€ä¸ªå®˜æ–¹ç»´æŠ¤çš„å·¥å…·ï¼Œç”¨äºåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¿«é€Ÿéƒ¨ç½² Kubernetes é›†ç¾¤ã€‚å®ƒå¯ä»¥åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šè®¾ç½®ä¸€ä¸ªé«˜åº¦å¯é…ç½®çš„é›†ç¾¤ï¼Œé€‚ç”¨äºè¾ƒå°è§„æ¨¡çš„ç”Ÿäº§ç¯å¢ƒã€‚</p></li><li><p><strong>Kubesprayï¼ˆåŸå…ˆå«Kargoï¼‰ï¼š</strong> Kubespray æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œç”¨äºéƒ¨ç½²é«˜åº¦å®šåˆ¶åŒ–çš„ Kubernetes é›†ç¾¤ã€‚å®ƒæ”¯æŒå¤šç§æ“ä½œç³»ç»Ÿå’Œäº‘å¹³å°ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®é…ç½®è¦æ±‚è¿›è¡Œå®šåˆ¶åŒ–éƒ¨ç½²ã€‚</p></li><li><p><strong>Managed Kubernetes Servicesï¼š</strong> ä¸»è¦äº‘æä¾›å•†ï¼ˆå¦‚AWSã€Google Cloudã€Azureï¼‰æä¾›æ‰˜ç®¡çš„ Kubernetes æœåŠ¡ï¼Œå¦‚Amazon EKSã€Google Kubernetes Engineï¼ˆGKEï¼‰ã€Azure Kubernetes Serviceï¼ˆAKSï¼‰ã€‚è¿™äº›æœåŠ¡ä¼šä¸ºä½ è‡ªåŠ¨ç®¡ç†é›†ç¾¤çš„ç»´æŠ¤ã€å‡çº§å’Œå¯ç”¨æ€§ã€‚</p></li><li><p><strong>Rancherï¼š</strong> Rancher æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç®¡ç†å¹³å°ï¼Œå¯ä»¥å¸®åŠ©ä½ åœ¨ä¸åŒçš„åŸºç¡€è®¾æ–½ä¸Šè½»æ¾éƒ¨ç½²å’Œç®¡ç† Kubernetes é›†ç¾¤ã€‚</p></li><li><p><strong>K3sï¼š</strong> K3s æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ Kubernetes å‘è¡Œç‰ˆï¼Œæ—¨åœ¨ä¸ºèµ„æºå—é™çš„ç¯å¢ƒï¼ˆå¦‚è¾¹ç¼˜è®¡ç®—ï¼‰æä¾›æ›´è½»ä¾¿çš„å®‰è£…å’Œç®¡ç†ã€‚</p></li><li><p><strong>è‡ªå®šä¹‰å®‰è£…è„šæœ¬ï¼š</strong> ä½ å¯ä»¥æ ¹æ® Kubernetes çš„å®˜æ–¹æ–‡æ¡£ï¼Œåœ¨è‡ªå·±çš„ç¯å¢ƒä¸­ç¼–å†™è‡ªå®šä¹‰çš„å®‰è£…è„šæœ¬ã€‚è¿™æ ·å¯ä»¥æ›´å¥½åœ°é€‚åº”ç‰¹å®šéœ€æ±‚å’Œæ¶æ„ã€‚</p></li></ol><p>å¯¹äºåˆå­¦è€…æ¥è¯´ï¼ŒMinikube å’Œ Managed Kubernetes Services æ˜¯è¾ƒä¸ºç®€å•çš„å…¥é—¨æ–¹å¼ã€‚è€Œå¯¹äºç”Ÿäº§ç¯å¢ƒï¼ŒKubeadmã€Kubespray å’Œ Rancher æä¾›äº†æ›´å¤§çš„çµæ´»æ€§å’Œæ§åˆ¶æƒã€‚åœ¨é€‰æ‹©å®‰è£…æ–¹å¼æ—¶ï¼Œè€ƒè™‘åˆ°ä½ çš„æŠ€æœ¯æ°´å¹³ã€éƒ¨ç½²è§„æ¨¡å’Œæ‰€åœ¨çš„åŸºç¡€è®¾æ–½ç¯å¢ƒæ˜¯å¾ˆé‡è¦çš„ã€‚æ— è®ºé€‰æ‹©å“ªç§æ–¹å¼ï¼Œç¡®ä¿å‚è€ƒå®˜æ–¹æ–‡æ¡£å’Œæœ€ä½³å®è·µæ¥ç¡®ä¿å®‰è£…çš„æ­£ç¡®æ€§å’Œå¯é æ€§ã€‚</p><h3 id=22-éƒ¨ç½²è¿‡ç¨‹>2.2 éƒ¨ç½²è¿‡ç¨‹<a hidden class=anchor aria-hidden=true href=#22-éƒ¨ç½²è¿‡ç¨‹>#</a></h3><p><strong>å®‰è£…å‰å‡†å¤‡ï¼š</strong></p><ul><li><p>ç¦ç”¨ swap åˆ†åŒº</p></li><li><p>å…³é—­ selinux</p></li><li><p>å…³é—­ iptablesã€NetworkManager æœåŠ¡</p></li><li><p>åŒæ­¥æœåŠ¡å™¨æ—¶é—´</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># ntpdate ntp.aliyun.com</span>
</span></span><span style=display:flex><span><span style=color:#75715e># hwclock -w</span>
</span></span></code></pre></div></li><li><p>ä¼˜åŒ–å†…æ ¸å‚æ•°å¹¶ä¿®æ”¹èµ„æºé™åˆ¶</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /etc/sysctl.conf </span>
</span></span><span style=display:flex><span>net.ipv4.ip_forward <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>net.bridge.bridge-nf-call-iptables <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>net.bridge.bridge-nf-call-ip6tables <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>net.bridge.bridge-nf-call-arptables <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>net.ipv4.tcp_tw_reuse <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>net.ipv4.ip_nonlocal_bind <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> 
</span></span><span style=display:flex><span>net.core.somaxconn <span style=color:#f92672>=</span> <span style=color:#ae81ff>32768</span>
</span></span><span style=display:flex><span>net.netfilter.nf_conntrack_max <span style=color:#f92672>=</span> <span style=color:#ae81ff>1000000</span>
</span></span><span style=display:flex><span>vm.swappiness <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>vm.max_map_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>655360</span>
</span></span><span style=display:flex><span>fs.file-max <span style=color:#f92672>=</span> <span style=color:#ae81ff>655360</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /etc/security/limits.conf </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#&lt;domain&gt;      &lt;type&gt;  &lt;item&gt;         &lt;value&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>*                soft    core            unlimited 
</span></span><span style=display:flex><span>*                hard    core            unlimited 
</span></span><span style=display:flex><span>*                soft    nproc           <span style=color:#ae81ff>1000000</span> 
</span></span><span style=display:flex><span>*                hard    nproc           <span style=color:#ae81ff>1000000</span> 
</span></span><span style=display:flex><span>*                soft    nofile          <span style=color:#ae81ff>1000000</span> 
</span></span><span style=display:flex><span>*                hard    nofile          <span style=color:#ae81ff>1000000</span> 
</span></span><span style=display:flex><span>*                soft    memlock         <span style=color:#ae81ff>24800</span> 
</span></span><span style=display:flex><span>*                hard    memlock         <span style=color:#ae81ff>24800</span> 
</span></span><span style=display:flex><span>*                soft    msgqueue        <span style=color:#ae81ff>8192000</span> 
</span></span><span style=display:flex><span>*                hard    msgqueue        <span style=color:#ae81ff>8192000</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root             soft    core            unlimited
</span></span><span style=display:flex><span>root             hard    core            unlimited
</span></span><span style=display:flex><span>root             soft    nproc           <span style=color:#ae81ff>1000000</span>
</span></span><span style=display:flex><span>root             hard    nproc           <span style=color:#ae81ff>1000000</span>
</span></span><span style=display:flex><span>root             soft    nofile          <span style=color:#ae81ff>1000000</span>
</span></span><span style=display:flex><span>root             hard    nofile          <span style=color:#ae81ff>1000000</span>
</span></span><span style=display:flex><span>root             soft    memlock         <span style=color:#ae81ff>24800</span>  
</span></span><span style=display:flex><span>root             hard    memlock         <span style=color:#ae81ff>24800</span>    
</span></span><span style=display:flex><span>root             soft    msgqueue        <span style=color:#ae81ff>8192000</span>
</span></span><span style=display:flex><span>root             hard    msgqueue        <span style=color:#ae81ff>8192000</span>
</span></span></code></pre></div></li></ul><h4 id=221-å…·ä½“æ­¥éª¤>2.2.1 å…·ä½“æ­¥éª¤<a hidden class=anchor aria-hidden=true href=#221-å…·ä½“æ­¥éª¤>#</a></h4><ol><li>åŸºç¡€ç¯å¢ƒå‡†å¤‡</li><li>éƒ¨ç½² harbor å’Œ haproxy é«˜å¯ç”¨åå‘ä»£ç†ï¼Œå®ç°æ§åˆ¶èŠ‚ç‚¹ API çš„é«˜å¯ç”¨</li><li>åœ¨æ‰€æœ‰ master èŠ‚ç‚¹å®‰è£…æŒ‡å®šçš„ kubeadmã€kubeletã€kubectlã€docker</li><li>åœ¨æ‰€æœ‰ node èŠ‚ç‚¹æŒ‰çˆªç»™ä½ æŒ‡å®šç‰ˆæœ¬çš„ kubeadmã€dockerã€kubeletï¼ˆå¯é€‰ï¼‰</li><li>åœ¨ master èŠ‚ç‚¹è¿è¡Œ kubeadm ini åˆå§‹åŒ–å‘½ä»¤åˆ›å»ºé›†ç¾¤</li><li>éªŒè¯ master èŠ‚ç‚¹çŠ¶æ€</li><li>åœ¨ node èŠ‚ç‚¹ä½¿ç”¨ kubeadm å‘½ä»¤å°†è‡ªèº«åŠ å…¥é›†ç¾¤</li><li>éªŒè¯ ndoe èŠ‚ç‚¹çŠ¶æ€</li><li>åˆ›å»º pod å¹¶æµ‹è¯•ç½‘ç»œæ˜¯å¦æ­£å¸¸</li><li>éƒ¨ç½² dashboard</li><li>é›†ç¾¤å‡çº§</li></ol><h4 id=222--éƒ¨ç½²ç¯å¢ƒ>2.2.2 éƒ¨ç½²ç¯å¢ƒ<a hidden class=anchor aria-hidden=true href=#222--éƒ¨ç½²ç¯å¢ƒ>#</a></h4><blockquote><p>å¦‚æœæ˜¯è™šæ‹ŸåŒ–ç¯å¢ƒï¼Œæœ€å¥½æ¯ä¸ªé‡è¦èŠ‚ç‚¹åšå¥½å¿«ç…§</p></blockquote><p>**æ“ä½œç³»ç»Ÿï¼š**Centos 7.8</p><p>**å®‰è£…æ–¹å¼ï¼š**æœ€å°åŒ–å®‰è£…</p><p>**éƒ¨ç½²æ–¹å¼ï¼š**VMware 16 Pro</p><table><thead><tr><th>è§’è‰²</th><th>ä¸»æœºå</th><th>IP</th><th>é…ç½®</th></tr></thead><tbody><tr><td>k8s-master-01</td><td>master-01.example.local</td><td>10.0.0.11</td><td>2U 2G</td></tr><tr><td>k8s-master-02</td><td>master-02.example.local</td><td>10.0.0.12</td><td>2U 2G</td></tr><tr><td>k8s-master-03</td><td>master-03.example.local</td><td>10.0.0.13</td><td>2U 2G</td></tr><tr><td>ha-01</td><td>ha-01.example.local</td><td>10.0.0.14</td><td>1U 2G</td></tr><tr><td>ha-02</td><td>ha-02.example.local</td><td>10.0.0.15</td><td>1U 2G</td></tr><tr><td>harbor</td><td>harbor.example.local</td><td>10.0.0.16</td><td>2U 4G</td></tr><tr><td>node-01</td><td>node-01.example.local</td><td>10.0.0.17</td><td>1U 2G</td></tr><tr><td>node-02</td><td>node-02.example.local</td><td>10.0.0.18</td><td>1U 2G</td></tr><tr><td>node-03</td><td>node-03.example.local</td><td>10.0.0.19</td><td>1U 2G</td></tr></tbody></table><h3 id=23-éƒ¨ç½²é«˜å¯ç”¨åå‘ä»£ç†>2.3 éƒ¨ç½²é«˜å¯ç”¨åå‘ä»£ç†<a hidden class=anchor aria-hidden=true href=#23-éƒ¨ç½²é«˜å¯ç”¨åå‘ä»£ç†>#</a></h3><p>åŸºäº Keepalived + haproxå®ç°é«˜å¯ç”¨åå‘ä»£ç†ï¼Œå®ç° k8s apiserver æœåŠ¡çš„é«˜å¯ç”¨</p><p><strong>ha-01ï¼š</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install -y keepalived
</span></span><span style=display:flex><span>yum install -y haproxy
</span></span><span style=display:flex><span>cp /usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.vrrp /etc/keepalived/keepalived.conf 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ha-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /etc/keepalived/keepalived.conf </span>
</span></span><span style=display:flex><span>! Configuration File <span style=color:#66d9ef>for</span> keepalived
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>global_defs <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   notification_email <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>     acassen
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>   notification_email_from Alexandre.Cassen@firewall.loc
</span></span><span style=display:flex><span>   smtp_server 192.168.200.1
</span></span><span style=display:flex><span>   smtp_connect_timeout <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>   router_id LVS_DEVEL
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>vrrp_instance k8s <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    state MASTER
</span></span><span style=display:flex><span>    interface eth0
</span></span><span style=display:flex><span>    garp_master_delay <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>    smtp_alert
</span></span><span style=display:flex><span>    virtual_router_id <span style=color:#ae81ff>51</span>
</span></span><span style=display:flex><span>    priority <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    advert_int <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    authentication <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        auth_type PASS
</span></span><span style=display:flex><span>        auth_pass <span style=color:#ae81ff>1111</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    virtual_ipaddress <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	10.0.0.188 label eth0:1
</span></span><span style=display:flex><span>	10.0.0.199 label eth0:2
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ha-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># tail -n 60 /etc/haproxy/haproxy.cfg</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>defaults
</span></span><span style=display:flex><span>    mode                    http
</span></span><span style=display:flex><span>    log                     global
</span></span><span style=display:flex><span>    option                  httplog
</span></span><span style=display:flex><span>    option                  dontlognull
</span></span><span style=display:flex><span>    option http-server-close
</span></span><span style=display:flex><span>    option forwardfor       except 127.0.0.0/8
</span></span><span style=display:flex><span>    option                  redispatch
</span></span><span style=display:flex><span>    retries                 <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>    timeout http-request    10s
</span></span><span style=display:flex><span>    timeout queue           1m
</span></span><span style=display:flex><span>    timeout connect         10s
</span></span><span style=display:flex><span>    timeout client          1m
</span></span><span style=display:flex><span>    timeout server          1m
</span></span><span style=display:flex><span>    timeout http-keep-alive 10s
</span></span><span style=display:flex><span>    timeout check           10s
</span></span><span style=display:flex><span>    maxconn                 <span style=color:#ae81ff>3000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>listen stats
</span></span><span style=display:flex><span>    mode http
</span></span><span style=display:flex><span>    bind 0.0.0.0:9999
</span></span><span style=display:flex><span>    stats enable
</span></span><span style=display:flex><span>    log global
</span></span><span style=display:flex><span>    stats uri /haproxy-status
</span></span><span style=display:flex><span>    stats auth admin:passwd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>listen k8s-apiserver-6443
</span></span><span style=display:flex><span>    bind 10.0.0.188:6443
</span></span><span style=display:flex><span>    mode tcp
</span></span><span style=display:flex><span>    balance roundrobin
</span></span><span style=display:flex><span>    server 10.0.0.11 10.0.0.11:6443 check inter 3s fall <span style=color:#ae81ff>3</span> rise <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>    server 10.0.0.12 10.0.0.12:6443 check inter 3s fall <span style=color:#ae81ff>3</span> rise <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>    server 10.0.0.13 10.0.0.13:6443 check inter 3s fall <span style=color:#ae81ff>3</span> rise <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>listen k8s-node-80
</span></span><span style=display:flex><span>    bind 10.0.0.199:80
</span></span><span style=display:flex><span>    mode tcp
</span></span><span style=display:flex><span>    balance roundrobin
</span></span><span style=display:flex><span>    server 10.0.0.17 10.0.0.17:30004 check inter 3s fall <span style=color:#ae81ff>3</span> rise <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>    server 10.0.0.18 10.0.0.18:30004 check inter 3s fall <span style=color:#ae81ff>3</span> rise <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>    server 10.0.0.19 10.0.0.19:30004 check inter 3s fall <span style=color:#ae81ff>3</span> rise <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ha-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># systemctl enable --now keepalived.service </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ha-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># systemctl enable --now haproxy.service </span>
</span></span></code></pre></div><p><strong>ha2:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install -y keepalived
</span></span><span style=display:flex><span>yum install -y haproxy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cp /usr/share/doc/keepalived-1.3.5/samples/keepalived.conf.vrrp /etc/keepalived/keepalived.conf 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ha-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /etc/keepalived/keepalived.conf </span>
</span></span><span style=display:flex><span>! Configuration File <span style=color:#66d9ef>for</span> keepalived
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>global_defs <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   notification_email <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>     acassen
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>   notification_email_from Alexandre.Cassen@firewall.loc
</span></span><span style=display:flex><span>   smtp_server 192.168.200.1
</span></span><span style=display:flex><span>   smtp_connect_timeout <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>   router_id LVS_DEVEL
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>vrrp_instance k8s <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    state MASTER
</span></span><span style=display:flex><span>    interface eth0
</span></span><span style=display:flex><span>    garp_master_delay <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>    smtp_alert
</span></span><span style=display:flex><span>    virtual_router_id <span style=color:#ae81ff>51</span>
</span></span><span style=display:flex><span>    priority <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    advert_int <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    authentication <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        auth_type PASS
</span></span><span style=display:flex><span>        auth_pass <span style=color:#ae81ff>1111</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    virtual_ipaddress <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	10.0.0.188 label eth0:1
</span></span><span style=display:flex><span>	10.0.0.199 label eth0:2
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ha-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># tail -n 60 /etc/haproxy/haproxy.cfg</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>defaults
</span></span><span style=display:flex><span>    mode                    http
</span></span><span style=display:flex><span>    log                     global
</span></span><span style=display:flex><span>    option                  httplog
</span></span><span style=display:flex><span>    option                  dontlognull
</span></span><span style=display:flex><span>    option http-server-close
</span></span><span style=display:flex><span>    option forwardfor       except 127.0.0.0/8
</span></span><span style=display:flex><span>    option                  redispatch
</span></span><span style=display:flex><span>    retries                 <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>    timeout http-request    10s
</span></span><span style=display:flex><span>    timeout queue           1m
</span></span><span style=display:flex><span>    timeout connect         10s
</span></span><span style=display:flex><span>    timeout client          1m
</span></span><span style=display:flex><span>    timeout server          1m
</span></span><span style=display:flex><span>    timeout http-keep-alive 10s
</span></span><span style=display:flex><span>    timeout check           10s
</span></span><span style=display:flex><span>    maxconn                 <span style=color:#ae81ff>3000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>listen stats
</span></span><span style=display:flex><span>    mode http
</span></span><span style=display:flex><span>    bind 0.0.0.0:9999
</span></span><span style=display:flex><span>    stats enable
</span></span><span style=display:flex><span>    log global
</span></span><span style=display:flex><span>    stats uri /haproxy-status
</span></span><span style=display:flex><span>    stats auth admin:passwd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>listen k8s-apiserver-6443
</span></span><span style=display:flex><span>    bind 10.0.0.188:6443
</span></span><span style=display:flex><span>    mode tcp
</span></span><span style=display:flex><span>    balance roundrobin
</span></span><span style=display:flex><span>    server 10.0.0.11 10.0.0.11:6443 check inter 3s fall <span style=color:#ae81ff>3</span> rise <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>    server 10.0.0.12 10.0.0.12:6443 check inter 3s fall <span style=color:#ae81ff>3</span> rise <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>    server 10.0.0.13 10.0.0.13:6443 check inter 3s fall <span style=color:#ae81ff>3</span> rise <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>listen k8s-node-80
</span></span><span style=display:flex><span>    bind 10.0.0.199:80
</span></span><span style=display:flex><span>    mode tcp
</span></span><span style=display:flex><span>    balance roundrobin
</span></span><span style=display:flex><span>    server 10.0.0.17 10.0.0.17:30004 check inter 3s fall <span style=color:#ae81ff>3</span> rise <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>    server 10.0.0.18 10.0.0.18:30004 check inter 3s fall <span style=color:#ae81ff>3</span> rise <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>    server 10.0.0.19 10.0.0.19:30004 check inter 3s fall <span style=color:#ae81ff>3</span> rise <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ha-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># systemctl enable --now keepalived.service </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ha-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># systemctl enable --now haproxy.service </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># vip åœ¨ ha-01 èŠ‚ç‚¹</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ha-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ifconfig eth0:1</span>
</span></span><span style=display:flex><span>eth0:1: flags<span style=color:#f92672>=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span style=color:#ae81ff>1500</span>
</span></span><span style=display:flex><span>        inet 10.0.0.188  netmask 255.255.255.255  broadcast 0.0.0.0
</span></span><span style=display:flex><span>        ether 00:0c:29:cd:4b:70  txqueuelen <span style=color:#ae81ff>1000</span>  <span style=color:#f92672>(</span>Ethernet<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ha-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ifconfig eth0:2</span>
</span></span><span style=display:flex><span>eth0:2: flags<span style=color:#f92672>=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span style=color:#ae81ff>1500</span>
</span></span><span style=display:flex><span>        inet 10.0.0.199  netmask 255.255.255.255  broadcast 0.0.0.0
</span></span><span style=display:flex><span>        ether 00:0c:29:cd:4b:70  txqueuelen <span style=color:#ae81ff>1000</span>  <span style=color:#f92672>(</span>Ethernet<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>æµè§ˆå™¨æŸ¥çœ‹çŠ¶æ€é¡µ</p><p><img loading=lazy src=/images/Kubernetes/image-20230929162915126.png alt=image-20230929162915126></p><h3 id=24-éƒ¨ç½²-harbor>2.4 éƒ¨ç½² harbor<a hidden class=anchor aria-hidden=true href=#24-éƒ¨ç½²-harbor>#</a></h3><p><a href=https://goharbor.io/docs/2.9.0/install-config/installation-prereqs/>https://goharbor.io/docs/2.9.0/install-config/installation-prereqs/</a></p><p><a href=https://docs.docker.com/engine/install/centos/>https://docs.docker.com/engine/install/centos/</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum remove -y docker <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                  docker-client <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                  docker-client-latest <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                  docker-common <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                  docker-latest <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                  docker-latest-logrotate <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                  docker-logrotate <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                  docker-engine
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å®‰è£… docker</span>
</span></span><span style=display:flex><span>sudo yum install -y yum-utils
</span></span><span style=display:flex><span>sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo yum install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
</span></span><span style=display:flex><span>systemctl enable --now docker
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@harbor harbor<span style=color:#f92672>]</span><span style=color:#75715e># docker -v</span>
</span></span><span style=display:flex><span>Docker version 24.0.6, build ed223bc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ä¸‹è½½å¹¶å®‰è£… harbor</span>
</span></span><span style=display:flex><span>wget https://github.com/goharbor/harbor/releases/download/v2.8.4/harbor-offline-installer-v2.8.4.tgz
</span></span><span style=display:flex><span>tar xf harbor-offline-installer-v2.8.4.tgz
</span></span><span style=display:flex><span>cd harbor
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@harbor harbor<span style=color:#f92672>]</span><span style=color:#75715e># cp harbor.yml.tmpl harbor.yml</span>
</span></span><span style=display:flex><span><span style=color:#75715e># å…³é—­ https</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@harbor harbor<span style=color:#f92672>]</span><span style=color:#75715e># grep -A 7 &#34;https related config&#34; harbor.yml</span>
</span></span><span style=display:flex><span><span style=color:#75715e># https related config</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#https:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  # https port for harbor, default is 443</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  port: 443</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  # The path of cert and key files for nginx</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  certificate: /your/certificate/path</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  private_key: /your/private/key/path</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ä¿®æ”¹ hostname</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@harbor harbor<span style=color:#f92672>]</span><span style=color:#75715e># grep -m 1  hostname: harbor.yml</span>
</span></span><span style=display:flex><span>hostname: harbor.example.local
</span></span><span style=display:flex><span><span style=color:#75715e># ä¿®æ”¹å¯†ç </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@harbor harbor<span style=color:#f92672>]</span><span style=color:#75715e># grep -m 1  passwd harbor.yml</span>
</span></span><span style=display:flex><span>harbor_admin_password: passwd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å¼€å§‹å®‰è£…</span>
</span></span><span style=display:flex><span>./install.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># docker-compose å®‰è£…è·¯å¾„</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@harbor harbor<span style=color:#f92672>]</span><span style=color:#75715e># rpm -ql docker-compose-plugin |grep docker-compose</span>
</span></span><span style=display:flex><span>/usr/libexec/docker/cli-plugins/docker-compose
</span></span></code></pre></div><p>ç™»å½• harbor å¹¶åˆ›å»ºé¡¹ç›®</p><p><strong>æ³¨æ„ï¼š</strong> è‡ªè¡Œåœ¨ window ä¸»æœºæ·»åŠ  hosts è§£æ <code>10.0.0.16 harbor.example.local</code></p><p><img loading=lazy src=/images/Kubernetes/image-20231002153741384.png alt=image-20231002153741384></p><h3 id=25-æ‰€æœ‰èŠ‚ç‚¹å®‰è£…-docker>2.5 æ‰€æœ‰èŠ‚ç‚¹å®‰è£… docker<a hidden class=anchor aria-hidden=true href=#25-æ‰€æœ‰èŠ‚ç‚¹å®‰è£…-docker>#</a></h3><p><a href=https://github.com/kubernetes/kubernetes/releases/tag/v1.17.11>Release v1.17.11 Â· kubernetes/kubernetes (github.com)</a></p><p>æ‰€æœ‰èŠ‚ç‚¹ï¼ˆè¿™é‡Œä¸“æŒ‡ master å’Œ nodeï¼‰å®‰è£… docker</p><p><strong>æ³¨æ„ï¼š</strong> ç”Ÿäº§ç¯å¢ƒè¦é€‰æ‹© k8s æŒ‡å®šçš„ç‰ˆæœ¬ï¼Œå…·ä½“æŸ¥é˜…å¯¹åº”ç‰ˆæœ¬çš„ CHANGELOG</p><p><a href=https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.17.md#v11711>kubernetes/CHANGELOG/CHANGELOG-1.17.md at master Â· kubernetes/kubernetes (github.com)</a></p><p><img loading=lazy src=/images/Kubernetes/image-20230930170028721.png alt=image-20230930170028721></p><p>å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ docker</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum remove docker <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                  docker-client <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                  docker-client-latest <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                  docker-common <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                  docker-latest <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                  docker-latest-logrotate <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                  docker-logrotate <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                  docker-engine
</span></span><span style=display:flex><span>                  
</span></span><span style=display:flex><span>sudo yum install -y yum-utils
</span></span><span style=display:flex><span>sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># è¿™é‡Œç›´æ¥å®‰è£… 19.03.9-3 ç‰ˆæœ¬çš„ docker</span>
</span></span><span style=display:flex><span><span style=color:#75715e># yum list docker-ce --showduplicates | sort -r | grep 19.03</span>
</span></span><span style=display:flex><span>docker-ce.x86_64            3:19.03.9-3.el7                    docker-ce-stable
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># sudo yum install -y docker-ce-19.03.9 docker-ce-cli-19.03.9 containerd.io docker-compose-plugin</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#75715e># docker version</span>
</span></span><span style=display:flex><span>Client: Docker Engine - Community
</span></span><span style=display:flex><span> Version:           19.03.9
</span></span><span style=display:flex><span> API version:       1.40
</span></span><span style=display:flex><span> Go version:        go1.13.10
</span></span><span style=display:flex><span> Git commit:        9d988398e7
</span></span><span style=display:flex><span> Built:             Fri May <span style=color:#ae81ff>15</span> 00:25:27 <span style=color:#ae81ff>2020</span>
</span></span><span style=display:flex><span> OS/Arch:           linux/amd64
</span></span><span style=display:flex><span> Experimental:      false
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Server: Docker Engine - Community
</span></span><span style=display:flex><span> Engine:
</span></span><span style=display:flex><span>  Version:          19.03.9
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ç”±äº harbor ä»“åº“æœªå¯ç”¨ https ï¼Œå› æ­¤éœ€è¦åœ¨ service æ–‡ä»¶åŠ ä¸Šè¯¥å‚æ•°</span>
</span></span><span style=display:flex><span><span style=color:#75715e># dockerd --help |grep insec</span>
</span></span><span style=display:flex><span>      --insecure-registry list                  Enable insecure registry communication
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span><span style=color:#75715e># grep insecure-registry /lib/systemd/system/docker.service</span>
</span></span><span style=display:flex><span>ExecStart<span style=color:#f92672>=</span>/usr/bin/dockerd -H fd:// --containerd<span style=color:#f92672>=</span>/run/containerd/containerd.sock --insecure-registry harbor.example.com
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># systemctl enable --now docker</span>
</span></span></code></pre></div><h3 id=26-æ‰€æœ‰èŠ‚ç‚¹å®‰è£…é›†ç¾¤åˆå§‹åŒ–å·¥å…·>2.6 æ‰€æœ‰èŠ‚ç‚¹å®‰è£…é›†ç¾¤åˆå§‹åŒ–å·¥å…·<a hidden class=anchor aria-hidden=true href=#26-æ‰€æœ‰èŠ‚ç‚¹å®‰è£…é›†ç¾¤åˆå§‹åŒ–å·¥å…·>#</a></h3><h4 id=261-é…ç½®å›½å†…é•œåƒæº>2.6.1 é…ç½®å›½å†…é•œåƒæº<a hidden class=anchor aria-hidden=true href=#261-é…ç½®å›½å†…é•œåƒæº>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[kubernetes]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>name=Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#e6db74>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>enabled=1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>gpgcheck=0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>repo_gpgcheck=0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><h4 id=262-å®‰è£…åˆå§‹åŒ–å·¥å…·>2.6.2 å®‰è£…åˆå§‹åŒ–å·¥å…·<a hidden class=anchor aria-hidden=true href=#262-å®‰è£…åˆå§‹åŒ–å·¥å…·>#</a></h4><p><strong>æ³¨æ„ï¼škubectl æ˜¯å®¢æˆ·ç«¯å‘½ä»¤ï¼Œå› æ­¤åœ¨ node å¯ä»¥é€‰æ‹©æ€§å®‰è£…</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install -y kubelet-1.17.11 kubectl-1.17.11 kubeadm-1.17.11
</span></span><span style=display:flex><span>systemctl enable --now kubelet
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># é…ç½® kubeadm å­å‘½ä»¤è‡ªåŠ¨è¡¥å…¨</span>
</span></span><span style=display:flex><span>mkdir ~/.kube/
</span></span><span style=display:flex><span>kubeadm completion bash &gt; ~/.kube/kubeadm_completion.sh
</span></span><span style=display:flex><span>source ~/.kube/kubeadm_completion.sh
</span></span></code></pre></div><h4 id=263-kubeadm-å‘½ä»¤çš„ä½¿ç”¨>2.6.3 kubeadm å‘½ä»¤çš„ä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#263-kubeadm-å‘½ä»¤çš„ä½¿ç”¨>#</a></h4><p>æŸ¥çœ‹å¸®åŠ©</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubeadm --help 
</span></span></code></pre></div><p>æŸ¥çœ‹ç‰ˆæœ¬</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubeadm  version</span>
</span></span><span style=display:flex><span>kubeadm version: &amp;version.Info<span style=color:#f92672>{</span>Major:<span style=color:#e6db74>&#34;1&#34;</span>, Minor:<span style=color:#e6db74>&#34;17&#34;</span>, GitVersion:<span style=color:#e6db74>&#34;v1.17.11&#34;</span>, GitCommit:<span style=color:#e6db74>&#34;ea5f00d93211b7c80247bf607cfa422ad6fb5347&#34;</span>, GitTreeState:<span style=color:#e6db74>&#34;clean&#34;</span>, BuildDate:<span style=color:#e6db74>&#34;2020-08-13T15:17:52Z&#34;</span>, GoVersion:<span style=color:#e6db74>&#34;go1.13.15&#34;</span>, Compiler:<span style=color:#e6db74>&#34;gc&#34;</span>, Platform:<span style=color:#e6db74>&#34;linux/amd64&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>æŸ¥çœ‹éƒ¨ç½²æŒ‡å®šç‰ˆæœ¬çš„é›†ç¾¤æ‰€éœ€è¦çš„é•œåƒ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubeadm config images list --kubernetes-version v1.17.11</span>
</span></span><span style=display:flex><span>W0930 17:59:27.921963    <span style=color:#ae81ff>6797</span> validation.go:28<span style=color:#f92672>]</span> Cannot validate kube-proxy config - no validator is available
</span></span><span style=display:flex><span>W0930 17:59:27.922001    <span style=color:#ae81ff>6797</span> validation.go:28<span style=color:#f92672>]</span> Cannot validate kubelet config - no validator is available
</span></span><span style=display:flex><span>k8s.gcr.io/kube-apiserver:v1.17.11
</span></span><span style=display:flex><span>k8s.gcr.io/kube-controller-manager:v1.17.11
</span></span><span style=display:flex><span>k8s.gcr.io/kube-scheduler:v1.17.11
</span></span><span style=display:flex><span>k8s.gcr.io/kube-proxy:v1.17.11
</span></span><span style=display:flex><span>k8s.gcr.io/pause:3.1
</span></span><span style=display:flex><span>k8s.gcr.io/etcd:3.4.3-0
</span></span><span style=display:flex><span>k8s.gcr.io/coredns:1.6.5
</span></span></code></pre></div><p>ç”±äºæ˜¯å›½å¤–çš„é•œåƒï¼Œç”±äºç½‘ç»œåŸå› ï¼Œå¤§æ¦‚ç‡æ˜¯ä¸‹è½½ä¸æˆåŠŸçš„ã€‚å› æ­¤å°†é•œåƒåœ°å€æ¢æˆé˜¿é‡Œçš„ï¼Œç„¶åæ‰‹åŠ¨ pull</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.17.11
</span></span><span style=display:flex><span>docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.17.11
</span></span><span style=display:flex><span>docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.17.11
</span></span><span style=display:flex><span>docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.17.11
</span></span><span style=display:flex><span>docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1
</span></span><span style=display:flex><span>docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.4.3-0
</span></span><span style=display:flex><span>docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.6.5
</span></span></code></pre></div><h3 id=27-k8s-å•èŠ‚ç‚¹éƒ¨ç½²>2.7 k8s å•èŠ‚ç‚¹éƒ¨ç½²<a hidden class=anchor aria-hidden=true href=#27-k8s-å•èŠ‚ç‚¹éƒ¨ç½²>#</a></h3><h4 id=271-å¼€å§‹éƒ¨ç½²>2.7.1 å¼€å§‹éƒ¨ç½²<a hidden class=anchor aria-hidden=true href=#271-å¼€å§‹éƒ¨ç½²>#</a></h4><blockquote><p>é¦–å…ˆç»™ master-01 æ·»åŠ ä¸€ä¸ªå¿«ç…§ï¼Œåä¸º initï¼Œæ–¹ä¾¿åç»­å›é€€</p></blockquote><p>è¿™é‡Œé€‰æ‹© master-01 è¿›è¡Œæ¼”ç¤º</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubeadm init --apiserver-advertise-address=10.0.0.11 --apiserver-bind-port=6443 --kubernetes-version=v1.17.11 --pod-network-cidr=10.100.0.0/16 --service-cidr=10.200.0.0/16 --service-dns-domain=example.local --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers  # --v=6 å¦‚æœå¡ä½æˆ–è€…è¶…æ—¶å¯ä»¥åŠ è¯¥é€‰é¡¹æ¥æŸ¥çœ‹è¯¦ç»†æŠ¥é”™ä¿¡æ¯</span>
</span></span></code></pre></div><p>å®‰è£…ç»“æœæ‰“å°åœ¨æ§åˆ¶å°ï¼Œä¸ºæ–¹ä¾¿åç»­æ·»åŠ  node èŠ‚ç‚¹åˆ°é›†ç¾¤ç­‰æ“ä½œï¼Œæœ€å¥½å°†æ‰“å°ç»“æœè¿›è¡Œä¿å­˜</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Your Kubernetes control-plane has initialized successfully!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>To start using your cluster, you need to run the following as a regular user:
</span></span><span style=display:flex><span><span style=color:#75715e># æ‰§è¡Œä»¥ä¸‹ä¸‰è¡Œå‘½ä»¤ï¼Œå¯é€šè¿‡ kubectl å‘½ä»¤æ“ä½œé›†ç¾¤</span>
</span></span><span style=display:flex><span>  mkdir -p $HOME/.kube
</span></span><span style=display:flex><span>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style=display:flex><span>  sudo chown <span style=color:#66d9ef>$(</span>id -u<span style=color:#66d9ef>)</span>:<span style=color:#66d9ef>$(</span>id -g<span style=color:#66d9ef>)</span> $HOME/.kube/config
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>You should now deploy a pod network to the cluster.
</span></span><span style=display:flex><span>Run <span style=color:#e6db74>&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span style=display:flex><span>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># node èŠ‚ç‚¹è¿è¡Œè¯¥å‘½ä»¤å¯åŠ å…¥é›†ç¾¤</span>
</span></span><span style=display:flex><span>kubeadm join 10.0.0.11:6443 --token s14pux.a81q4ai54mpumsz4 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --discovery-token-ca-cert-hash sha256:5ab171bccb95245c209ddcbb614ae943b31b05e3a4ce2eb47d349655955c185f
</span></span></code></pre></div><h4 id=272-éªŒè¯ç»“æœ>2.7.2 éªŒè¯ç»“æœ<a hidden class=anchor aria-hidden=true href=#272-éªŒè¯ç»“æœ>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pod</span>
</span></span><span style=display:flex><span>The connection to the server localhost:8080 was refused - did you specify the right host or port?
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e>#   </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e>#   mkdir -p $HOME/.kube</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e>#   sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e>#   sudo chown $(id -u):$(id -g) $HOME/.kube/config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pod</span>
</span></span><span style=display:flex><span>No resources found in default namespace.
</span></span></code></pre></div><h4 id=273-éƒ¨ç½²ç½‘ç»œç»„ä»¶>2.7.3 éƒ¨ç½²ç½‘ç»œç»„ä»¶<a hidden class=anchor aria-hidden=true href=#273-éƒ¨ç½²ç½‘ç»œç»„ä»¶>#</a></h4><p>k8s æ”¯æŒçš„ç½‘ç»œç»„ä»¶ï¼š<a href=https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/addons/>å®‰è£…æ‰©å±•ï¼ˆAddonï¼‰ | Kubernetes</a></p><p>è¿™é‡Œé€‰æ‹©éƒ¨ç½² <a href=https://github.com/flannel-io/flannel#deploying-flannel-manually>flannel-io/flannel: flannel is a network fabric for containers, designed for Kubernetes (github.com)</a></p><p>ä¸‹è½½ yaml æ–‡ä»¶å¹¶ä¿®æ”¹ network ä¸ºé›†ç¾¤åˆå§‹åŒ–æ—¶è§„åˆ’çš„ pod ç½‘æ®µ 10.100.0.0/16</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># wget https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># grep -m 1 Network kube-flannel.yml </span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;Network&#34;</span>: <span style=color:#e6db74>&#34;10.100.0.0/16&#34;</span>,
</span></span></code></pre></div><p>å¼€å§‹éƒ¨ç½²</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl apply -f kube-flannel.yml </span>
</span></span><span style=display:flex><span>namespace/kube-flannel created
</span></span><span style=display:flex><span>serviceaccount/flannel created
</span></span><span style=display:flex><span>clusterrole.rbac.authorization.k8s.io/flannel created
</span></span><span style=display:flex><span>clusterrolebinding.rbac.authorization.k8s.io/flannel created
</span></span><span style=display:flex><span>configmap/kube-flannel-cfg created
</span></span><span style=display:flex><span>daemonset.apps/kube-flannel-ds created
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æˆåŠŸéƒ¨ç½²</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pod -A | grep flannel</span>
</span></span><span style=display:flex><span>kube-flannel   kube-flannel-ds-zvcp7                             1/1     Running   <span style=color:#ae81ff>0</span>          2m9s
</span></span></code></pre></div><p>å»é™¤ master-01 çš„æ±¡ç‚¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># é»˜è®¤æƒ…å†µä¸‹ master è¢«æ‰“ä¸Šäº†æ±¡ç‚¹ï¼Œä¸ä¼šè¢«è°ƒåº¦</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl describe node master-01.example.local | grep Taints</span>
</span></span><span style=display:flex><span>Taints:             node-role.kubernetes.io/master:NoSchedule
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å»é™¤ master-01 çš„æ±¡ç‚¹</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl taint nodes master-01.example.local node-role.kubernetes.io/master:NoSchedule-</span>
</span></span><span style=display:flex><span>node/master-01.example.local untainted
</span></span></code></pre></div><p>éƒ¨ç½² busybox éªŒè¯ pod ç½‘ç»œ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl run my-container --image=busybox --command -- bash</span>
</span></span><span style=display:flex><span>kubectl run --generator<span style=color:#f92672>=</span>deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator<span style=color:#f92672>=</span>run-pod/v1 or kubectl create instead.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl run my-container --image=busybox --command -- ping www.baidu.com</span>
</span></span><span style=display:flex><span>kubectl run --generator<span style=color:#f92672>=</span>deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator<span style=color:#f92672>=</span>run-pod/v1 or kubectl create instead.
</span></span><span style=display:flex><span>deployment.apps/my-container created
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pod </span>
</span></span><span style=display:flex><span>NAME                            READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>my-container-84ff747745-sjd97   1/1     Running   <span style=color:#ae81ff>0</span>          10s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ç½‘ç»œæ­£å¸¸</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl exec -it my-container-84ff747745-sjd97 -- sh</span>
</span></span><span style=display:flex><span>/ <span style=color:#75715e># ping www.baidu.com -c 3</span>
</span></span><span style=display:flex><span>PING www.baidu.com <span style=color:#f92672>(</span>14.119.104.189<span style=color:#f92672>)</span>: <span style=color:#ae81ff>56</span> data bytes
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 14.119.104.189: seq<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>127</span> time<span style=color:#f92672>=</span>9.193 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 14.119.104.189: seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>127</span> time<span style=color:#f92672>=</span>9.475 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 14.119.104.189: seq<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>127</span> time<span style=color:#f92672>=</span>9.668 ms
</span></span></code></pre></div><h3 id=28-k8s-å¤šèŠ‚ç‚¹éƒ¨ç½²é«˜å¯ç”¨>2.8 k8s å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼ˆé«˜å¯ç”¨ï¼‰<a hidden class=anchor aria-hidden=true href=#28-k8s-å¤šèŠ‚ç‚¹éƒ¨ç½²é«˜å¯ç”¨>#</a></h3><p>è¿™é‡Œå°†ç”¨åˆ°æ‰€æœ‰ä¸‰ä¸ª master èŠ‚ç‚¹è¿›è¡Œæ¼”ç¤ºï¼Œç”±äº mater-01 éƒ¨ç½²äº†å•èŠ‚ç‚¹ï¼Œé¦–å…ˆå°†å…¶è¿˜åŸåˆ°å¿«ç…§ init ï¼ˆæ²¡æœ‰å¿«ç…§çš„è¯ï¼Œå¯ä»¥å‚è€ƒ <code>kubeadm reset </code>)</p><h4 id=281-å¼€å§‹éƒ¨ç½²>2.8.1 å¼€å§‹éƒ¨ç½²<a hidden class=anchor aria-hidden=true href=#281-å¼€å§‹éƒ¨ç½²>#</a></h4><p>ç›¸æ¯”å•èŠ‚ç‚¹éƒ¨ç½²è€Œè¨€ï¼Œå¤šäº†ä¸€ä¸ªé€‰é¡¹ <code>--control-plane-endpoint=10.0.0.188</code> æŒ‡å®šäº†é«˜å¯ç”¨åå‘ä»£ç†çš„ VIPï¼Œè¿™é‡Œè¿˜æ˜¯é€‰æ‹© master-01 åˆ›å»ºé›†ç¾¤ï¼ˆä»»é€‰ä¸€ä¸ª master èŠ‚ç‚¹å‡å¯ï¼‰</p><blockquote><p>å¦‚æœè´Ÿè½½å‡è¡¡å™¨æœªé…ç½®æ­£ç¡®ï¼Œä¼šæœ‰ä»¥ä¸‹æŠ¥é”™ï¼š</p><p><code>Oct 1 14:06:58 master-01 kubelet: E1001 14:06:58.218726 2977 reflector.go:153] k8s.io/client-go/informers/factory.go:135: Failed to lisriver: Get https://load-balancer.example.com:6443/apis/storage.k8s.io/v1beta1/csidrivers?limit=500&amp;resourceVersion=0: EOF</code></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># echo 10.0.0.188  load-balancer.example.com &gt;&gt; /etc/hosts</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubeadm init --apiserver-advertise-address=10.0.0.11 --control-plane-endpoint=load-balancer.example.com --apiserver-bind-port=6443 --kubernetes-version=v1.17.11 --pod-network-cidr=10.100.0.0/16 --service-cidr=10.200.0.0/16 --service-dns-domain=example.local --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Your Kubernetes control-plane has initialized successfully!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>To start using your cluster, you need to run the following as a regular user:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  mkdir -p $HOME/.kube
</span></span><span style=display:flex><span>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style=display:flex><span>  sudo chown <span style=color:#66d9ef>$(</span>id -u<span style=color:#66d9ef>)</span>:<span style=color:#66d9ef>$(</span>id -g<span style=color:#66d9ef>)</span> $HOME/.kube/config
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>You should now deploy a pod network to the cluster.
</span></span><span style=display:flex><span>Run <span style=color:#e6db74>&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span style=display:flex><span>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>You can now join any number of control-plane nodes by copying certificate authorities
</span></span><span style=display:flex><span>and service account keys on each node and <span style=color:#66d9ef>then</span> running the following as root:
</span></span><span style=display:flex><span><span style=color:#75715e># æ·»åŠ  master èŠ‚ç‚¹åˆ°é›†ç¾¤ </span>
</span></span><span style=display:flex><span>  kubeadm join load-balancer.example.com:6443 --token iata77.l5yqheznrbz3i0jm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --discovery-token-ca-cert-hash sha256:9cf6a8410183e55ff71f0f64f0aea35f3a1498e3e0e6311cf0571a3a2021931a <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --control-plane <span style=color:#75715e># éœ€è¦æ‰‹åŠ¨ç”Ÿæˆ</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style=display:flex><span><span style=color:#75715e># æ·»åŠ  node èŠ‚ç‚¹åˆ°é›†ç¾¤</span>
</span></span><span style=display:flex><span>kubeadm join load-balancer.example.com:6443 --token iata77.l5yqheznrbz3i0jm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --discovery-token-ca-cert-hash sha256:9cf6a8410183e55ff71f0f64f0aea35f3a1498e3e0e6311cf0571a3a2021931a 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å‡†å¤‡é›†ç¾¤è®¤è¯æ–‡ä»¶</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># mkdir -p $HOME/.kube</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># sudo chown $(id -u):$(id -g) $HOME/.kube/config</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æˆåŠŸè·å–é›†ç¾¤ä¿¡æ¯</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get node</span>
</span></span><span style=display:flex><span>NAME                      STATUS   ROLES    AGE   VERSION
</span></span><span style=display:flex><span>master-01.example.local   Ready    master   91m   v1.17.11
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># éƒ¨ç½² flannelï¼Œ å‚è€ƒ 2.7.3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl apply -f kube-flannel.yml</span>
</span></span><span style=display:flex><span>namespace/kube-flannel created
</span></span><span style=display:flex><span>serviceaccount/flannel created
</span></span><span style=display:flex><span>clusterrole.rbac.authorization.k8s.io/flannel created
</span></span><span style=display:flex><span>clusterrolebinding.rbac.authorization.k8s.io/flannel created
</span></span><span style=display:flex><span>configmap/kube-flannel-cfg created
</span></span><span style=display:flex><span>daemonset.apps/kube-flannel-ds created
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pod -A |grep flannel</span>
</span></span><span style=display:flex><span>kube-flannel   kube-flannel-ds-97c97                             1/1     Running   <span style=color:#ae81ff>0</span>          94s
</span></span></code></pre></div><p><strong>è¡¥å……ï¼š</strong> é™¤äº†ä½¿ç”¨å‘½ä»¤çš„æ–¹å¼ï¼Œè¿˜å¯ä»¥åŸºäº yaml æ–‡ä»¶è¿›è¡Œé›†ç¾¤çš„åˆå§‹åŒ–ï¼ˆè¿™é‡Œä»…ç»™å‡ºå…³é”®å‘½ä»¤ï¼‰</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># ç”Ÿæˆåˆå§‹åŒ–é…ç½®</span>
</span></span><span style=display:flex><span><span style=color:#75715e># kubeadm config print init-defaults &gt; cluster-init.yaml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ ¹æ®éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶</span>
</span></span><span style=display:flex><span><span style=color:#75715e># cat cluster-init.yaml </span>
</span></span><span style=display:flex><span>apiVersion: kubeadm.k8s.io/v1beta2
</span></span><span style=display:flex><span>bootstrapTokens:
</span></span><span style=display:flex><span>- groups:
</span></span><span style=display:flex><span>  - system:bootstrappers:kubeadm:default-node-token
</span></span><span style=display:flex><span>  token: abcdef.0123456789abcdef
</span></span><span style=display:flex><span>  ttl: 24h0m0s
</span></span><span style=display:flex><span>  usages:
</span></span><span style=display:flex><span>  - signing
</span></span><span style=display:flex><span>  - authentication
</span></span><span style=display:flex><span>kind: InitConfiguration
</span></span><span style=display:flex><span>localAPIEndpoint:
</span></span><span style=display:flex><span>  advertiseAddress: 1.2.3.4
</span></span><span style=display:flex><span>  bindPort: <span style=color:#ae81ff>6443</span>
</span></span><span style=display:flex><span>nodeRegistration:
</span></span><span style=display:flex><span>  criSocket: /var/run/dockershim.sock
</span></span><span style=display:flex><span>  name: master-01.example.local
</span></span><span style=display:flex><span>  taints:
</span></span><span style=display:flex><span>  - effect: NoSchedule
</span></span><span style=display:flex><span>    key: node-role.kubernetes.io/master
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiServer:
</span></span><span style=display:flex><span>  timeoutForControlPlane: 4m0s
</span></span><span style=display:flex><span>apiVersion: kubeadm.k8s.io/v1beta2
</span></span><span style=display:flex><span>certificatesDir: /etc/kubernetes/pki
</span></span><span style=display:flex><span>clusterName: kubernetes
</span></span><span style=display:flex><span>controllerManager: <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>dns:
</span></span><span style=display:flex><span>  type: CoreDNS
</span></span><span style=display:flex><span>etcd:
</span></span><span style=display:flex><span>  local:
</span></span><span style=display:flex><span>    dataDir: /var/lib/etcd
</span></span><span style=display:flex><span>imageRepository: k8s.gcr.io
</span></span><span style=display:flex><span>kind: ClusterConfiguration
</span></span><span style=display:flex><span>kubernetesVersion: v1.17.0
</span></span><span style=display:flex><span>networking:
</span></span><span style=display:flex><span>  dnsDomain: cluster.local
</span></span><span style=display:flex><span>  podSubnet: 10.100.0.0/16
</span></span><span style=display:flex><span>  serviceSubnet: 10.200.0.0/16
</span></span><span style=display:flex><span>scheduler: <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºé›†ç¾¤</span>
</span></span><span style=display:flex><span>kubeadm init --config cluster-init.yaml
</span></span></code></pre></div><h4 id=282-æ·»åŠ -master-èŠ‚ç‚¹>2.8.2 æ·»åŠ  master èŠ‚ç‚¹<a hidden class=anchor aria-hidden=true href=#282-æ·»åŠ -master-èŠ‚ç‚¹>#</a></h4><p>ç”Ÿæˆ <code>--control-plane</code> å‚æ•°æ‰€éœ€ key</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubeadm init phase upload-certs --upload-certs</span>
</span></span><span style=display:flex><span>I1001 16:10:41.762369   <span style=color:#ae81ff>58794</span> version.go:251<span style=color:#f92672>]</span> remote version is much newer: v1.28.2; falling back to: stable-1.17
</span></span><span style=display:flex><span>W1001 16:10:46.609771   <span style=color:#ae81ff>58794</span> validation.go:28<span style=color:#f92672>]</span> Cannot validate kube-proxy config - no validator is available
</span></span><span style=display:flex><span>W1001 16:10:46.609786   <span style=color:#ae81ff>58794</span> validation.go:28<span style=color:#f92672>]</span> Cannot validate kubelet config - no validator is available
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>upload-certs<span style=color:#f92672>]</span> Storing the certificates in Secret <span style=color:#e6db74>&#34;kubeadm-certs&#34;</span> in the <span style=color:#e6db74>&#34;kube-system&#34;</span> Namespace
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>upload-certs<span style=color:#f92672>]</span> Using certificate key:
</span></span><span style=display:flex><span>c67c9859d32c5f7e1fd75cfca8569aac32ae4f9344fcd6b8d53ad9b998362e05 <span style=color:#75715e># è¿™å°±æ˜¯éœ€è¦çš„ key</span>
</span></span></code></pre></div><p>åˆ†åˆ«æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°† <code>master-02</code> å’Œ <code>master-03</code> åŠ å…¥ <code>control-plane</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># echo 10.0.0.188  load-balancer.example.com &gt;&gt; /etc/hosts</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># kubeadm join load-balancer.example.com:6443 --token iata77.l5yqheznrbz3i0jm \</span>
</span></span><span style=display:flex><span>    --discovery-token-ca-cert-hash sha256:9cf6a8410183e55ff71f0f64f0aea35f3a1498e3e0e6311cf0571a3a2021931a <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --control-plane --certificate-key  c67c9859d32c5f7e1fd75cfca8569aac32ae4f9344fcd6b8d53ad9b998362e05
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>This node has joined the cluster and a new control plane instance was created:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>* Certificate signing request was sent to apiserver and approval was received.
</span></span><span style=display:flex><span>* The Kubelet was informed of the new secure connection details.
</span></span><span style=display:flex><span>* Control plane <span style=color:#f92672>(</span>master<span style=color:#f92672>)</span> label and taint were applied to the new node.
</span></span><span style=display:flex><span>* The Kubernetes control plane instances scaled up.
</span></span><span style=display:flex><span>* A new etcd member was added to the local/stacked etcd cluster.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>To start administering your cluster from this node, you need to run the following as a regular user:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	mkdir -p $HOME/.kube
</span></span><span style=display:flex><span>	sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style=display:flex><span>	sudo chown <span style=color:#66d9ef>$(</span>id -u<span style=color:#66d9ef>)</span>:<span style=color:#66d9ef>$(</span>id -g<span style=color:#66d9ef>)</span> $HOME/.kube/config
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Run <span style=color:#e6db74>&#39;kubectl get nodes&#39;</span> to see this node join the cluster.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æˆåŠŸåŠ å…¥èŠ‚ç‚¹</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get nodes</span>
</span></span><span style=display:flex><span>NAME                      STATUS   ROLES    AGE     VERSION
</span></span><span style=display:flex><span>master-01.example.local   Ready    master   132m    v1.17.11
</span></span><span style=display:flex><span>master-02.example.local   Ready    master   8m25s   v1.17.11
</span></span><span style=display:flex><span>master-03.example.local   Ready    master   14s     v1.17.11
</span></span></code></pre></div><h4 id=283-æ·»åŠ -node-èŠ‚ç‚¹>2.8.3 æ·»åŠ  node èŠ‚ç‚¹<a hidden class=anchor aria-hidden=true href=#283-æ·»åŠ -node-èŠ‚ç‚¹>#</a></h4><p>åˆ†åˆ«å„ä¸ª node èŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo 10.0.0.188  load-balancer.example.com &gt;&gt; /etc/hosts
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubeadm join load-balancer.example.com:6443 --token iata77.l5yqheznrbz3i0jm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --discovery-token-ca-cert-hash sha256:9cf6a8410183e55ff71f0f64f0aea35f3a1498e3e0e6311cf0571a3a2021931a
</span></span></code></pre></div><p>æ·»åŠ å®Œæˆåçš„ç»“æœ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get nodes</span>
</span></span><span style=display:flex><span>NAME                      STATUS   ROLES    AGE    VERSION
</span></span><span style=display:flex><span>master-01.example.local   Ready    master   176m   v1.17.11
</span></span><span style=display:flex><span>master-02.example.local   Ready    master   52m    v1.17.11
</span></span><span style=display:flex><span>master-03.example.local   Ready    master   44m    v1.17.11
</span></span><span style=display:flex><span>node-01.example.local     Ready    &lt;none&gt;   95s    v1.17.11
</span></span><span style=display:flex><span>node-02.example.local     Ready    &lt;none&gt;   34m    v1.17.11
</span></span><span style=display:flex><span>node-03.example.local     Ready    &lt;none&gt;   74s    v1.17.11
</span></span></code></pre></div><h4 id=284-æŸ¥çœ‹é›†ç¾¤è¯ä¹¦>2.8.4 æŸ¥çœ‹é›†ç¾¤è¯ä¹¦<a hidden class=anchor aria-hidden=true href=#284-æŸ¥çœ‹é›†ç¾¤è¯ä¹¦>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-02 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get csr</span>
</span></span><span style=display:flex><span>NAME        AGE     REQUESTOR                 CONDITION
</span></span><span style=display:flex><span>csr-4fsl6   47m     system:bootstrap:tdi58m   Approved,Issued
</span></span><span style=display:flex><span>csr-hc9g7   4m      system:bootstrap:tdi58m   Approved,Issued
</span></span><span style=display:flex><span>csr-jh7gj   55m     system:bootstrap:tdi58m   Approved,Issued
</span></span><span style=display:flex><span>csr-k8psl   3m39s   system:bootstrap:tdi58m   Approved,Issued
</span></span><span style=display:flex><span>csr-qcjln   36m     system:bootstrap:tdi58m   Approved,Issued
</span></span><span style=display:flex><span>csr-vvtfq   2m53s   system:bootstrap:tdi58m   Approved,Issued
</span></span></code></pre></div><h4 id=285-åˆ›å»º-pod-éªŒè¯é›†ç¾¤ç½‘ç»œ>2.8.5 åˆ›å»º pod éªŒè¯é›†ç¾¤ç½‘ç»œ<a hidden class=anchor aria-hidden=true href=#285-åˆ›å»º-pod-éªŒè¯é›†ç¾¤ç½‘ç»œ>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl run net-test --image=alpine sleep 3600</span>
</span></span><span style=display:flex><span>kubectl run --generator<span style=color:#f92672>=</span>deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator<span style=color:#f92672>=</span>run-pod/v1 or kubectl create instead.
</span></span><span style=display:flex><span>deployment.apps/net-test created
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pod -o wide</span>
</span></span><span style=display:flex><span>NAME                       READY   STATUS    RESTARTS   AGE   IP           NODE                    NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>net-test-88ff4d957-rnrsk   1/1     Running   <span style=color:#ae81ff>0</span>          21s   10.100.4.2   node-01.example.local   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl exec -it net-test-88ff4d957-rnrsk -- sh</span>
</span></span><span style=display:flex><span>/ <span style=color:#75715e># ping www.baidu.com</span>
</span></span><span style=display:flex><span>PING www.baidu.com <span style=color:#f92672>(</span>14.119.104.189<span style=color:#f92672>)</span>: <span style=color:#ae81ff>56</span> data bytes
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 14.119.104.189: seq<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>127</span> time<span style=color:#f92672>=</span>8.608 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 14.119.104.189: seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>127</span> time<span style=color:#f92672>=</span>9.249 ms
</span></span><span style=display:flex><span><span style=color:#ae81ff>64</span> bytes from 14.119.104.189: seq<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>127</span> time<span style=color:#f92672>=</span>9.576 ms
</span></span></code></pre></div><h2 id=ä¸‰éƒ¨ç½²-dashboard>ä¸‰ã€éƒ¨ç½² Dashboard<a hidden class=anchor aria-hidden=true href=#ä¸‰éƒ¨ç½²-dashboard>#</a></h2><h3 id=31-å‡†å¤‡é…ç½®æ–‡ä»¶>3.1 å‡†å¤‡é…ç½®æ–‡ä»¶<a hidden class=anchor aria-hidden=true href=#31-å‡†å¤‡é…ç½®æ–‡ä»¶>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.2.0/aio/deploy/recommended.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># mv recommended.yaml dashboard.yaml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># é»˜è®¤çš„æ˜¯ä»¥ ClusterIP å‘å¸ƒçš„ï¼Œåªèƒ½é›†ç¾¤å†…è®¿é—®ã€‚è¿™é‡Œå°†å…¶æ”¹ä¸º NodePort çš„æ–¹å¼éƒ¨ç½²</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># grep NodePort -C 10 dashboard.yaml </span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    k8s-app: kubernetes-dashboard
</span></span><span style=display:flex><span>  name: kubernetes-dashboard
</span></span><span style=display:flex><span>  namespace: kubernetes-dashboard
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: NodePort <span style=color:#75715e># æ–°å¢</span>
</span></span><span style=display:flex><span>  ports:
</span></span><span style=display:flex><span>    - port: <span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>      targetPort: <span style=color:#ae81ff>8443</span>
</span></span><span style=display:flex><span>      nodePort: <span style=color:#ae81ff>30000</span> <span style=color:#75715e># æ–°å¢</span>
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    k8s-app: kubernetes-dashboard
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Secret
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    k8s-app: kubernetes-dashboard
</span></span></code></pre></div><h3 id=32-éƒ¨ç½²å¹¶éªŒè¯æ•ˆæœ>3.2 éƒ¨ç½²å¹¶éªŒè¯æ•ˆæœ<a hidden class=anchor aria-hidden=true href=#32-éƒ¨ç½²å¹¶éªŒè¯æ•ˆæœ>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl apply -f dashboard.yaml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹ pod å’Œ service æœåŠ¡çŠ¶æ€</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pod,svc -n kubernetes-dashboard -o wide</span>
</span></span><span style=display:flex><span>NAME                                            READY   STATUS    RESTARTS   AGE   IP           NODE                    NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>pod/dashboard-metrics-scraper-894c58c65-tsqb7   1/1     Running   <span style=color:#ae81ff>0</span>          32m   10.100.4.4   node-01.example.local   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>pod/kubernetes-dashboard-fc4fc66cc-vvbht        1/1     Running   <span style=color:#ae81ff>0</span>          32m   10.100.4.3   node-01.example.local   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>         AGE   SELECTOR
</span></span><span style=display:flex><span>service/dashboard-metrics-scraper   ClusterIP   10.200.205.233   &lt;none&gt;        8000/TCP        32m   k8s-app<span style=color:#f92672>=</span>dashboard-metrics-scraper
</span></span><span style=display:flex><span>service/kubernetes-dashboard        NodePort    10.200.198.74    &lt;none&gt;        443:30000/TCP   32m   k8s-app<span style=color:#f92672>=</span>kubernetes-dashboard
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># èŠ‚ç‚¹ç›‘å¬äº† 30000 ç«¯å£</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@node-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># ss -ntl |grep 30000</span>
</span></span><span style=display:flex><span>LISTEN     <span style=color:#ae81ff>0</span>      <span style=color:#ae81ff>32768</span>     <span style=color:#f92672>[</span>::<span style=color:#f92672>]</span>:30000                 <span style=color:#f92672>[</span>::<span style=color:#f92672>]</span>:* 
</span></span></code></pre></div><p>ç”±äºæ˜¯ https åè®®ï¼Œä½†æ˜¯è¯ä¹¦æ˜¯ç§æœ‰çš„ï¼Œä½¿ç”¨ chrome æˆ– edge æµè§ˆå™¨æ— æ³•è®¿é—® dashboardã€‚å› æ­¤é€‰æ‹© firefox æµè§ˆå™¨è¿›è¡Œè®¿é—®</p><p><img loading=lazy src=/images/Kubernetes/image-20231001204858526.png alt=image-20231001204858526></p><p>è®¿é—® dashboard éœ€è¦ä½¿ç”¨ token æˆ–è€… kubeconfig æ–‡ä»¶è¿›è¡Œè®¤è¯ï¼Œè¿™é‡Œé€‰æ‹© token è¿›è¡ŒéªŒè¯ã€‚ä¸‹é¢å¼€å§‹ç”Ÿæˆ token</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºè´¦å·</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl create serviceaccount dashboard-admin -n kubernetes-dashboard</span>
</span></span><span style=display:flex><span>serviceaccount/dashboard-admin created
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æˆæƒ</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl create clusterrolebinding dashboard-admin-rb --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-admin</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># è·å–è´¦å· token</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get secrets -n kubernetes-dashboard | grep dashboard-admin</span>
</span></span><span style=display:flex><span>dashboard-admin-token-wr4jl        kubernetes.io/service-account-token   <span style=color:#ae81ff>3</span>      15s
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl describe secrets dashboard-admin-token-wr4jl -n kubernetes-dashboard</span>
</span></span><span style=display:flex><span>Name:         dashboard-admin-token-wr4jl
</span></span><span style=display:flex><span>Namespace:    kubernetes-dashboard
</span></span><span style=display:flex><span>Labels:       &lt;none&gt;
</span></span><span style=display:flex><span>Annotations:  kubernetes.io/service-account.name: dashboard-admin
</span></span><span style=display:flex><span>              kubernetes.io/service-account.uid: 66e3f61f-9172-400c-b454-d9fb1a93be4c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Type:  kubernetes.io/service-account-token
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Data
</span></span><span style=display:flex><span><span style=color:#f92672>====</span>
</span></span><span style=display:flex><span>ca.crt:     <span style=color:#ae81ff>1025</span> bytes
</span></span><span style=display:flex><span>namespace:  <span style=color:#ae81ff>20</span> bytes
</span></span><span style=display:flex><span>token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IndQay1pc3ctc3RyWDh3dXQtTHR1N09PLVVBdUExdXJkRVRQeFpmbWlmQ1kifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tN3NweDkiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiMjQ5OTJlMzctNmI1Yi00ODZmLTkwYmUtYmQxYTU2NGM0MmJhIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9.jXYf6lQQBW9kb3KUYpoAi57JbBFwMkUdx3Gb0jK4sN8E80WIM6lyGLktsTCmNoS21BN-bGyusqT5nNJAPhrVYaEjF6pSSLrd49LHF0Wetv04Jh5fdw-aHYuR15QKCZgGjedzuUHD4F8-6Ba5ZqMh67JjKI3Dhb-dIuBIVN3KLi2_D62F4VoCryZB3ExVfdRqZmQmI0EJ5XursMgCzL9v9VCPw9FatL604n5658CuXQNXc6uIpAVwuf3G_4uBoRQ-LcyPXov9JIoSv-qbxnotgZ2xXcHWZ7HIxa1pCRL8YG_bx03ZUE04GebjF9yNeki9Dxsp4gIxDcr09ByzO0gmgg 
</span></span></code></pre></div><p>å°†ä¸Šè¿° token å¡«å…¥è¾“å…¥æ¡†(ä¸è¦å¸¦å¤šä½™ç©ºæ ¼ï¼‰ï¼ŒæˆåŠŸè®¿é—® dashboard</p><p><img loading=lazy src=/images/Kubernetes/image-20231001205626389.png alt=image-20231001205626389></p><h2 id=å››k8s-éƒ¨ç½²-nginx--tomcat>å››ã€k8s éƒ¨ç½² nginx + tomcat<a hidden class=anchor aria-hidden=true href=#å››k8s-éƒ¨ç½²-nginx--tomcat>#</a></h2><p><a href=https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/>Deployments | Kubernetes</a></p><p>ç›®æ ‡ï¼šå®ç°åŠ¨é™åˆ†ç¦»çš„æ•ˆæœï¼Œè¿™é‡Œä»…æ¼”ç¤ºç®€å•çš„å®ç°æ•ˆæœ</p><h3 id=41-éƒ¨ç½²-nginx>4.1 éƒ¨ç½² nginx<a hidden class=anchor aria-hidden=true href=#41-éƒ¨ç½²-nginx>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 nginx<span style=color:#f92672>]</span><span style=color:#75715e># pwd</span>
</span></span><span style=display:flex><span>/root/yaml/nginx
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 nginx<span style=color:#f92672>]</span><span style=color:#75715e># cat nginx.yml </span>
</span></span><span style=display:flex><span>apiVersion: apps/v1
</span></span><span style=display:flex><span>kind: Deployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>  name: nginx-deployment
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    app: nginx
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  replicas: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    matchLabels:
</span></span><span style=display:flex><span>      app: nginx
</span></span><span style=display:flex><span>  template:
</span></span><span style=display:flex><span>    metadata:
</span></span><span style=display:flex><span>      labels:
</span></span><span style=display:flex><span>        app: nginx
</span></span><span style=display:flex><span>    spec:
</span></span><span style=display:flex><span>      containers:
</span></span><span style=display:flex><span>      - name: nginx
</span></span><span style=display:flex><span>        image: nginx:1.18.0
</span></span><span style=display:flex><span>        ports:
</span></span><span style=display:flex><span>        - containerPort: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    app: nginx-service-labels
</span></span><span style=display:flex><span>  name: nginx-service
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: NodePort
</span></span><span style=display:flex><span>  ports:
</span></span><span style=display:flex><span>  - name: http-nginx
</span></span><span style=display:flex><span>    port: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>    protocol: TCP
</span></span><span style=display:flex><span>    targetPort: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>    nodeport: <span style=color:#ae81ff>30004</span>
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    app: nginx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 nginx<span style=color:#f92672>]</span><span style=color:#75715e># kubectl apply -f nginx.yml</span>
</span></span></code></pre></div><p>æŸ¥çœ‹éƒ¨ç½²ç»“æœ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 nginx<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pod,svc -o wide</span>
</span></span><span style=display:flex><span>NAME                                     READY   STATUS    RESTARTS   AGE     IP           NODE                    NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>pod/nginx-deployment-d44c4d8f4-bftm4     1/1     Running   <span style=color:#ae81ff>0</span>          4m11s   10.100.3.3   node-01.example.local   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>        AGE     SELECTOR
</span></span><span style=display:flex><span>service/kubernetes       ClusterIP   10.200.0.1       &lt;none&gt;        443/TCP        162m    &lt;none&gt;
</span></span><span style=display:flex><span>service/nginx-service    NodePort    10.200.231.164   &lt;none&gt;        80:30004/TCP   4m11s   app<span style=color:#f92672>=</span>nginx
</span></span></code></pre></div><p>æ ¹æ®ä»¥ä¸Šç»“æœå¯çŸ¥ï¼Œnginx æˆåŠŸéƒ¨ç½²ï¼Œä¸” pod è¢«è°ƒåº¦åˆ°äº† node-01 èŠ‚ç‚¹</p><p><img loading=lazy src=/images/Kubernetes/image-20231002174034317.png alt=image-20231002174034317></p><h3 id=42-éƒ¨ç½²-tomcat>4.2 éƒ¨ç½² tomcat<a hidden class=anchor aria-hidden=true href=#42-éƒ¨ç½²-tomcat>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 tomcat<span style=color:#f92672>]</span><span style=color:#75715e># pwd</span>
</span></span><span style=display:flex><span>/root/yaml/tomcat
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 tomcat<span style=color:#f92672>]</span><span style=color:#75715e># cat tomcat.yml </span>
</span></span><span style=display:flex><span>apiVersion: apps/v1
</span></span><span style=display:flex><span>kind: Deployment
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  namespace: default
</span></span><span style=display:flex><span>  name: tomcat-deployment
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    apps: tomcat
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  replicas: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    matchLabels:
</span></span><span style=display:flex><span>      app: tomcat
</span></span><span style=display:flex><span>  template:
</span></span><span style=display:flex><span>    metadata:
</span></span><span style=display:flex><span>      labels:
</span></span><span style=display:flex><span>        app: tomcat
</span></span><span style=display:flex><span>    spec:
</span></span><span style=display:flex><span>      containers:
</span></span><span style=display:flex><span>      - name: tomcat
</span></span><span style=display:flex><span>        image: tomcat
</span></span><span style=display:flex><span>        ports:
</span></span><span style=display:flex><span>        - containerPort: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Service
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    app: tomcat-service-label
</span></span><span style=display:flex><span>  name: tomcat-service
</span></span><span style=display:flex><span>  namespace:
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  type: NodePort
</span></span><span style=display:flex><span>  ports:
</span></span><span style=display:flex><span>    - name: tomcat-http
</span></span><span style=display:flex><span>      port: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>      protocol: TCP
</span></span><span style=display:flex><span>      targetPort: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>      nodePort: <span style=color:#ae81ff>30005</span>
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    app: tomcat
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 tomcat<span style=color:#f92672>]</span><span style=color:#75715e># kubectl apply -f tomcat.yml</span>
</span></span></code></pre></div><p>æŸ¥çœ‹éƒ¨ç½²ç»“æœ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pod,svc -o wide</span>
</span></span><span style=display:flex><span>NAME                                     READY   STATUS    RESTARTS   AGE     IP           NODE                    NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>pod/nginx-deployment-d44c4d8f4-bftm4     1/1     Running   <span style=color:#ae81ff>0</span>          4m11s   10.100.3.3   node-01.example.local   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>pod/tomcat-deployment-78c89857d6-9qtr9   1/1     Running   <span style=color:#ae81ff>0</span>          4m14s   10.100.3.2   node-01.example.local   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>        AGE     SELECTOR
</span></span><span style=display:flex><span>service/kubernetes       ClusterIP   10.200.0.1       &lt;none&gt;        443/TCP        162m    &lt;none&gt;
</span></span><span style=display:flex><span>service/nginx-service    NodePort    10.200.231.164   &lt;none&gt;        80:30004/TCP   4m11s   app<span style=color:#f92672>=</span>nginx
</span></span><span style=display:flex><span>service/tomcat-service   NodePort    10.200.206.119   &lt;none&gt;        80:30005/TCP   4m14s   app<span style=color:#f92672>=</span>tomcat
</span></span></code></pre></div><p><img loading=lazy src=/images/Kubernetes/image-20231002174257600.png alt=image-20231002174257600></p><p>ç”Ÿæˆä¸€ä¸ªtomcat ä¸´æ—¶é¡µé¢</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 yaml<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pod</span>
</span></span><span style=display:flex><span>NAME                                 READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>nginx-deployment-d44c4d8f4-bftm4     1/1     Running   <span style=color:#ae81ff>0</span>          6m18s
</span></span><span style=display:flex><span>tomcat-deployment-78c89857d6-9qtr9   1/1     Running   <span style=color:#ae81ff>0</span>          6m21s
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 yaml<span style=color:#f92672>]</span><span style=color:#75715e># </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 yaml<span style=color:#f92672>]</span><span style=color:#75715e># kubectl exec -it tomcat-deployment-78c89857d6-9qtr9 bash</span>
</span></span><span style=display:flex><span>root@tomcat-deployment-78c89857d6-9qtr9:/usr/local/tomcat# cd webapps
</span></span><span style=display:flex><span>root@tomcat-deployment-78c89857d6-9qtr9:/usr/local/tomcat/webapps# mkdir tomcat
</span></span><span style=display:flex><span>root@tomcat-deployment-78c89857d6-9qtr9:/usr/local/tomcat/webapps# echo <span style=color:#e6db74>&#34;Tomcat test page for pod of k8s~&#34;</span> &gt; tomcat/index.html
</span></span><span style=display:flex><span>root@tomcat-deployment-78c89857d6-9qtr9:/usr/local/tomcat/webapps# exit
</span></span><span style=display:flex><span>exit
</span></span></code></pre></div><p><img loading=lazy src=/images/Kubernetes/image-20231002175227287.png alt=image-20231002175227287></p><h3 id=43-ä»-dashboard-æŸ¥çœ‹ç»“æœ>4.3 ä» dashboard æŸ¥çœ‹ç»“æœ<a hidden class=anchor aria-hidden=true href=#43-ä»-dashboard-æŸ¥çœ‹ç»“æœ>#</a></h3><p><img loading=lazy src=/images/Kubernetes/image-20231002174505455.png alt=image-20231002174505455></p><h3 id=44-é…ç½®-nginx-å®ç°åŠ¨é™åˆ†ç¦»>4.4 é…ç½® nginx å®ç°åŠ¨é™åˆ†ç¦»<a hidden class=anchor aria-hidden=true href=#44-é…ç½®-nginx-å®ç°åŠ¨é™åˆ†ç¦»>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pod,svc </span>
</span></span><span style=display:flex><span>NAME                                     READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>pod/net-test-88ff4d957-krc9v             1/1     Running   <span style=color:#ae81ff>0</span>          44m
</span></span><span style=display:flex><span>pod/nginx-deployment-d44c4d8f4-bftm4     1/1     Running   <span style=color:#ae81ff>0</span>          70m
</span></span><span style=display:flex><span>pod/tomcat-deployment-78c89857d6-9qtr9   1/1     Running   <span style=color:#ae81ff>0</span>          70m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>        AGE
</span></span><span style=display:flex><span>service/kubernetes       ClusterIP   10.200.0.1       &lt;none&gt;        443/TCP        3h49m
</span></span><span style=display:flex><span>service/nginx-service    NodePort    10.200.231.164   &lt;none&gt;        80:30004/TCP   70m
</span></span><span style=display:flex><span>service/tomcat-service   NodePort    10.200.206.119   &lt;none&gt;        80:30005/TCP   70m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl exec -it nginx-deployment-d44c4d8f4-bftm4 bash</span>
</span></span><span style=display:flex><span>root@nginx-deployment-d44c4d8f4-bftm4:/# 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@nginx-deployment-d44c4d8f4-sfslr:/# cat &gt; /etc/nginx/conf.d/default.conf <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>server {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    listen       80;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    listen  [::]:80;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    server_name  localhost;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    location /tomcat {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        proxy_pass http://tomcat-service.default.svc.example.local;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    error_page   500 502 503 504  /50x.html;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    location = /50x.html {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        root   /usr/share/nginx/html;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@nginx-deployment-d44c4d8f4-bftm4:/# nginx -t        
</span></span><span style=display:flex><span>nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
</span></span><span style=display:flex><span>nginx: configuration file /etc/nginx/nginx.conf test is successful
</span></span><span style=display:flex><span>root@nginx-deployment-d44c4d8f4-bftm4:/# nginx -s reload
</span></span><span style=display:flex><span>2023/10/02 11:44:15 <span style=color:#f92672>[</span>notice<span style=color:#f92672>]</span> 997#997: signal process started
</span></span></code></pre></div><p><img loading=lazy src=/images/Kubernetes/image-20231002194611155.png alt=image-20231002194611155></p><h2 id=äº”k8s-é›†ç¾¤ç®¡ç†>äº”ã€k8s é›†ç¾¤ç®¡ç†<a hidden class=anchor aria-hidden=true href=#äº”k8s-é›†ç¾¤ç®¡ç†>#</a></h2><h3 id=51-token-ç®¡ç†>5.1 token ç®¡ç†<a hidden class=anchor aria-hidden=true href=#51-token-ç®¡ç†>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubeadm # åŒå‡» tab è¡¥å…¨å¾—åˆ°çš„ç»“æœ</span>
</span></span><span style=display:flex><span>alpha       completion  config      init        join        reset       token       upgrade     version     
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubeadm token </span>
</span></span><span style=display:flex><span>create    delete    generate  list
</span></span></code></pre></div><h3 id=52-reset-å‘½ä»¤>5.2 reset å‘½ä»¤<a hidden class=anchor aria-hidden=true href=#52-reset-å‘½ä»¤>#</a></h3><p>åœ¨åˆå§‹åŒ–é›†ç¾¤æ—¶ï¼Œå¦‚æœç”Ÿæˆäº†é”™è¯¯çš„é…ç½®ï¼Œå¯ä»¥ç”¨è¯¥å‘½ä»¤é‡ç½®ç¯å¢ƒ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubeadm reset</span>
</span></span></code></pre></div><p><code>kubeadm reset</code> å‘½ä»¤ç”¨äºå°†KubernetesèŠ‚ç‚¹ï¼ˆé€šå¸¸æ˜¯å·¥ä½œèŠ‚ç‚¹ï¼‰æ¢å¤åˆ°å…¶åˆå§‹çŠ¶æ€ï¼Œå°†èŠ‚ç‚¹ä»Kubernetesé›†ç¾¤ä¸­åˆ†ç¦»å¹¶æ¸…ç†é›†ç¾¤ç›¸å…³çš„é…ç½®å’Œæ•°æ®ã€‚è¿™ä¸ªå‘½ä»¤çš„ä¸»è¦ä½œç”¨åŒ…æ‹¬ï¼š</p><ol><li><p><strong>èŠ‚ç‚¹çš„è„±ç¦»é›†ç¾¤</strong>ï¼š<code>kubeadm reset</code> ä¼šå°†èŠ‚ç‚¹ä»Kubernetesé›†ç¾¤ä¸­åˆ†ç¦»ã€‚è¿™åŒ…æ‹¬åˆ é™¤èŠ‚ç‚¹çš„è¯ä¹¦ã€ä»é›†ç¾¤ä¸­åˆ é™¤èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œå¹¶ä¸”èŠ‚ç‚¹å°†ä¸å†å‚ä¸é›†ç¾¤ä¸­çš„é€šä¿¡å’Œç®¡ç†ã€‚</p></li><li><p><strong>æ¸…ç†é…ç½®æ–‡ä»¶</strong>ï¼šå®ƒä¼šåˆ é™¤Kubernetesçš„é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚kubeconfigæ–‡ä»¶ï¼Œä»¥åŠCNIï¼ˆå®¹å™¨ç½‘ç»œæ¥å£ï¼‰æ’ä»¶çš„é…ç½®ï¼Œä»¥ç¡®ä¿ä¸å†å½±å“Kubernetesé›†ç¾¤ã€‚</p></li><li><p><strong>æ¸…ç†æ•°æ®</strong>ï¼š<code>kubeadm reset</code> è¿˜ä¼šæ¸…ç†èŠ‚ç‚¹ä¸Šçš„Kubernetesæ•°æ®ï¼ŒåŒ…æ‹¬åˆ é™¤å®¹å™¨ã€å·ã€æ•°æ®å­˜å‚¨ç­‰ï¼Œä»¥ç¡®ä¿èŠ‚ç‚¹ä¸å†åŒ…å«ä¸Kubernetesé›†ç¾¤ç›¸å…³çš„æ®‹ç•™æ•°æ®ã€‚</p></li></ol><p>è¿™ä¸ªå‘½ä»¤é€šå¸¸åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä½¿ç”¨ï¼š</p><ul><li><p>å½“ä½ éœ€è¦å¸è½½æˆ–ç§»é™¤èŠ‚ç‚¹ä¸Šçš„Kubernetesæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>kubeadm reset</code> æ¥æ¸…ç†èŠ‚ç‚¹ï¼Œç„¶åé‡æ–°é…ç½®æˆ–é‡æ–°éƒ¨ç½²Kubernetesã€‚</p></li><li><p>åœ¨æµ‹è¯•ç¯å¢ƒä¸­ï¼Œå½“ä½ éœ€è¦é‡ç½®ä¸€ä¸ªèŠ‚ç‚¹ä»¥è¿›è¡Œæ–°çš„Kubernetesé›†ç¾¤é…ç½®æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>kubeadm reset</code>ã€‚</p></li></ul><p>è¯·æ³¨æ„ï¼Œ<code>kubeadm reset</code> åªåº”è¯¥ç”¨äºèŠ‚ç‚¹çº§åˆ«çš„æ“ä½œï¼Œå¹¶ä¸”åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨æ—¶éœ€è¦è°¨æ…ï¼Œå› ä¸ºå®ƒä¼šåˆ é™¤èŠ‚ç‚¹ä¸Šçš„Kubernetesç›¸å…³æ•°æ®ã€‚å¦‚æœä½ éœ€è¦ä»æ•´ä¸ªKubernetesé›†ç¾¤ä¸­ç§»é™¤èŠ‚ç‚¹ï¼Œè¯·é¦–å…ˆä½¿ç”¨ <code>kubectl drain</code> å‘½ä»¤å°†èŠ‚ç‚¹ä¸Šçš„å·¥ä½œè´Ÿè½½è¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œç„¶åå†ä½¿ç”¨ <code>kubeadm reset</code> è¿›è¡ŒèŠ‚ç‚¹çš„é‡ç½®å’Œå¸è½½ã€‚</p><h3 id=53-æŸ¥çœ‹è¯ä¹¦æœ‰æ•ˆæœŸ>5.3 æŸ¥çœ‹è¯ä¹¦æœ‰æ•ˆæœŸ<a hidden class=anchor aria-hidden=true href=#53-æŸ¥çœ‹è¯ä¹¦æœ‰æ•ˆæœŸ>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubeadm alpha </span>
</span></span><span style=display:flex><span>certs        kubeconfig   kubelet      selfhosting  
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubeadm alpha certs </span>
</span></span><span style=display:flex><span>certificate-key   check-expiration  renew    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ£€æŸ¥è¯ä¹¦æ˜¯å¦è¿‡æœŸï¼Œå¯ä»¥å‘ç° kubeadm éƒ¨ç½²çš„é›†ç¾¤ï¼Œè¯ä¹¦æœ‰æ•ˆæœŸä¸º 365dï¼ˆä¸€å¹´ï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubeadm alpha certs check-expiration </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>check-expiration<span style=color:#f92672>]</span> Reading configuration from the cluster...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>check-expiration<span style=color:#f92672>]</span> FYI: You can look at this config file with <span style=color:#e6db74>&#39;kubectl -n kube-system get cm kubeadm-config -oyaml&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
</span></span><span style=display:flex><span>admin.conf                 Oct 01, <span style=color:#ae81ff>2024</span> 07:58 UTC   364d                                    no      
</span></span><span style=display:flex><span>apiserver                  Oct 01, <span style=color:#ae81ff>2024</span> 07:58 UTC   364d            ca                      no      
</span></span><span style=display:flex><span>apiserver-etcd-client      Oct 01, <span style=color:#ae81ff>2024</span> 07:58 UTC   364d            etcd-ca                 no      
</span></span><span style=display:flex><span>apiserver-kubelet-client   Oct 01, <span style=color:#ae81ff>2024</span> 07:58 UTC   364d            ca                      no      
</span></span><span style=display:flex><span>controller-manager.conf    Oct 01, <span style=color:#ae81ff>2024</span> 07:58 UTC   364d                                    no      
</span></span><span style=display:flex><span>etcd-healthcheck-client    Oct 01, <span style=color:#ae81ff>2024</span> 07:58 UTC   364d            etcd-ca                 no      
</span></span><span style=display:flex><span>etcd-peer                  Oct 01, <span style=color:#ae81ff>2024</span> 07:58 UTC   364d            etcd-ca                 no      
</span></span><span style=display:flex><span>etcd-server                Oct 01, <span style=color:#ae81ff>2024</span> 07:58 UTC   364d            etcd-ca                 no      
</span></span><span style=display:flex><span>front-proxy-client         Oct 01, <span style=color:#ae81ff>2024</span> 07:58 UTC   364d            front-proxy-ca          no      
</span></span><span style=display:flex><span>scheduler.conf             Oct 01, <span style=color:#ae81ff>2024</span> 07:58 UTC   364d                                    no      
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
</span></span><span style=display:flex><span>ca                      Sep 29, <span style=color:#ae81ff>2033</span> 07:58 UTC   9y              no      
</span></span><span style=display:flex><span>etcd-ca                 Sep 29, <span style=color:#ae81ff>2033</span> 07:58 UTC   9y              no      
</span></span><span style=display:flex><span>front-proxy-ca          Sep 29, <span style=color:#ae81ff>2033</span> 07:58 UTC   9y              no 
</span></span></code></pre></div><h3 id=54-æ›´æ–°è¯ä¹¦æœ‰æ•ˆæœŸ>5.4 æ›´æ–°è¯ä¹¦æœ‰æ•ˆæœŸ<a hidden class=anchor aria-hidden=true href=#54-æ›´æ–°è¯ä¹¦æœ‰æ•ˆæœŸ>#</a></h3><p>å‚è€ƒé“¾æ¥ï¼š</p><p><a href=https://www.qikqiak.com/post/update-k8s-10y-expire-certs/>https://www.qikqiak.com/post/update-k8s-10y-expire-certs/</a></p><p><a href=https://www.chenshaowen.com/blog/how-to-renew-kubernetes-certs-manually.html>https://www.chenshaowen.com/blog/how-to-renew-kubernetes-certs-manually.html</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubeadm alpha certs renew </span>
</span></span><span style=display:flex><span>admin.conf                apiserver-etcd-client     etcd-healthcheck-client   front-proxy-client        
</span></span><span style=display:flex><span>all                       apiserver-kubelet-client  etcd-peer                 scheduler.conf            
</span></span><span style=display:flex><span>apiserver                 controller-manager.conf   etcd-server  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ›´æ–°æ‰€æœ‰è¯ä¹¦</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubeadm alpha certs renew all</span>
</span></span></code></pre></div><p>å®Œæˆåé‡å¯ kube-apiserverã€kube-controllerã€kube-scheduler è¿™ 3ä¸ªå®¹å™¨å³å¯ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ apiserver çš„è¯ä¹¦çš„æœ‰æ•ˆæœŸæ¥éªŒè¯æ˜¯å¦æ›´æ–°æˆåŠŸï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># docker ps |egrep &#34;k8s_kube-apiserver|k8s_kube-scheduler|k8s_kube-controller&#34;|awk &#39;{print $1}&#39;|xargs docker restart</span>
</span></span><span style=display:flex><span>c2d987734f5a
</span></span><span style=display:flex><span>043af8733130
</span></span><span style=display:flex><span>5a87240ba97a
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># echo | openssl s_client -showcerts -connect 127.0.0.1:6443 -servername api 2&gt;/dev/null | openssl x509 -noout -enddate</span>
</span></span><span style=display:flex><span>notAfter<span style=color:#f92672>=</span>Oct  <span style=color:#ae81ff>1</span> 13:17:56 <span style=color:#ae81ff>2024</span> GMT
</span></span></code></pre></div><h2 id=å…­k8s-é›†ç¾¤å‡çº§>å…­ã€k8s é›†ç¾¤å‡çº§<a hidden class=anchor aria-hidden=true href=#å…­k8s-é›†ç¾¤å‡çº§>#</a></h2><p>kubeadm éƒ¨ç½²çš„é›†ç¾¤éœ€è¦ç”¨ kubeadm æ¥å‡çº§ï¼Œé¦–å…ˆéœ€è¦å°† kubeadm å‡çº§åˆ°ç›®æ ‡ç‰ˆæœ¬ï¼Œç„¶åå†ç»§ç»­å…¶ä»–æ“ä½œã€‚</p><h3 id=61-å‡çº§å‡†å¤‡>6.1 å‡çº§å‡†å¤‡<a hidden class=anchor aria-hidden=true href=#61-å‡çº§å‡†å¤‡>#</a></h3><p>æœ¬æ¬¡å‡çº§ï¼Œç›®æ ‡ç‰ˆæœ¬ï¼š<code>v1.19.2</code></p><p>æŸ¥çœ‹å½“å‰ç‰ˆæœ¬</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubeadm version</span>
</span></span><span style=display:flex><span>kubeadm version: &amp;version.Info<span style=color:#f92672>{</span>Major:<span style=color:#e6db74>&#34;1&#34;</span>, Minor:<span style=color:#e6db74>&#34;17&#34;</span>, GitVersion:<span style=color:#e6db74>&#34;v1.17.11&#34;</span>, GitCommit:<span style=color:#e6db74>&#34;ea5f00d93211b7c80247bf607cfa422ad6fb5347&#34;</span>, GitTreeState:<span style=color:#e6db74>&#34;clean&#34;</span>, BuildDate:<span style=color:#e6db74>&#34;2020-08-13T15:17:52Z&#34;</span>, GoVersion:<span style=color:#e6db74>&#34;go1.13.15&#34;</span>, Compiler:<span style=color:#e6db74>&#34;gc&#34;</span>, Platform:<span style=color:#e6db74>&#34;linux/amd64&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹ yum æºæ˜¯å¦æœ‰ç›®æ ‡ç‰ˆæœ¬</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># yum list kubectl kubeadm kubelet --showduplicates | grep 1.19.2</span>
</span></span><span style=display:flex><span>kubeadm.x86_64                       1.19.2-0                        kubernetes 
</span></span><span style=display:flex><span>kubectl.x86_64                       1.19.2-0                        kubernetes 
</span></span><span style=display:flex><span>kubelet.x86_64                       1.19.2-0                        kubernetes
</span></span></code></pre></div><h3 id=62-å‡çº§-master-èŠ‚ç‚¹>6.2 å‡çº§ master èŠ‚ç‚¹<a hidden class=anchor aria-hidden=true href=#62-å‡çº§-master-èŠ‚ç‚¹>#</a></h3><p>æ»šåŠ¨å¼å‡çº§ master èŠ‚ç‚¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># å®‰è£…éƒ¨ç½²å·¥å…·</span>
</span></span><span style=display:flex><span>yum install -y kubelet-1.19.2 kubectl-1.19.2 kubeadm-1.19.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubeadm version</span>
</span></span><span style=display:flex><span>kubeadm version: &amp;version.Info<span style=color:#f92672>{</span>Major:<span style=color:#e6db74>&#34;1&#34;</span>, Minor:<span style=color:#e6db74>&#34;19&#34;</span>, GitVersion:<span style=color:#e6db74>&#34;v1.19.2&#34;</span>, GitCommit:<span style=color:#e6db74>&#34;f5743093fd1c663cb0cbc89748f730662345d44d&#34;</span>, GitTreeState:<span style=color:#e6db74>&#34;clean&#34;</span>, BuildDate:<span style=color:#e6db74>&#34;2020-09-16T13:38:53Z&#34;</span>, GoVersion:<span style=color:#e6db74>&#34;go1.15&#34;</span>, Compiler:<span style=color:#e6db74>&#34;gc&#34;</span>, Platform:<span style=color:#e6db74>&#34;linux/amd64&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>æŸ¥çœ‹ç‰ˆæœ¬å‡çº§è®¡åˆ’</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubeadm upgrade plan</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>upgrade/config<span style=color:#f92672>]</span> Making sure the configuration is correct:
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>upgrade/config<span style=color:#f92672>]</span> Reading configuration from the cluster...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>upgrade/config<span style=color:#f92672>]</span> FYI: You can look at this config file with <span style=color:#e6db74>&#39;kubectl -n kube-system get cm kubeadm-config -oyaml&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>upgrade/config<span style=color:#f92672>]</span> FATAL: this version of kubeadm only supports deploying clusters with the control plane version &gt;<span style=color:#f92672>=</span> 1.18.0. Current version: v1.17.11   <span style=color:#75715e># ç‰ˆæœ¬ä½äº 1.18.0ï¼Œkubeadm ä¸æ”¯æŒå‡çº§æ“ä½œ</span>
</span></span><span style=display:flex><span>To see the stack trace of this error execute with --v<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span> or higher
</span></span></code></pre></div><p>å¦‚æœé€‰æ‹©çš„ç‰ˆæœ¬ç¬¦åˆ kubeadm çš„è¦æ±‚ï¼Œåˆ™ç»§ç»­ä»¥ä¸‹æ“ä½œ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@master-01 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubeadm upgrade apply v1.19.2</span>
</span></span></code></pre></div><p>å‡çº§å®Œæˆåï¼Œå¯ä»¥æŸ¥çœ‹é•œåƒç‰ˆæœ¬</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># docker images</span>
</span></span></code></pre></div><h3 id=63-å‡çº§-node-èŠ‚ç‚¹>6.3 å‡çº§ node èŠ‚ç‚¹<a hidden class=anchor aria-hidden=true href=#63-å‡çº§-node-èŠ‚ç‚¹>#</a></h3><p>åŒæ ·æ˜¯æ»šåŠ¨å‡çº§çš„æ–¹å¼è¿›è¡Œ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># å®‰è£…éƒ¨ç½²å·¥å…·</span>
</span></span><span style=display:flex><span>yum install -y kubelet-1.19.2 kubectl-1.19.2 kubeadm-1.19.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ‰§è¡Œå‡çº§æ“ä½œ</span>
</span></span><span style=display:flex><span>kubeadm upgrade node --kubelet-version 1.19.2
</span></span></code></pre></div></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://senmer.github.io/img/wechat_pay.png alt=wechat_pay></a><p>å¾®ä¿¡</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://senmer.github.io/img/alipay.png alt=alipay></a><p>æ”¯ä»˜å®</p></div></div><button id=rewardButton onclick='var qr=document.getElementById("QR");qr.style.opacity==="0"?qr.style.opacity="1":qr.style.opacity="0"'>
<span>ğŸ§§ é¼“åŠ±</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://senmer.github.io/zh/posts/tech/ldap/openldap%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>OpenLDAPå®‰è£…å’Œä½¿ç”¨</span>
</a><a class=next href=https://senmer.github.io/zh/posts/tech/kafka/kafka%E7%AE%80%E4%BB%8B%E4%B8%8E%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>Kafkaç®€ä»‹ä¸é›†ç¾¤éƒ¨ç½²</span></a></nav></footer></div><style>.comments_details summary::marker{font-size:20px;content:'ğŸ‘‰å±•å¼€è¯„è®º';color:var(--content)}.comments_details[open] summary::marker{font-size:20px;content:'ğŸ‘‡å…³é—­è¯„è®º';color:var(--content)}</style><div><details class=comments_details open><summary style=display:none></summary><div id=tcomment></div></details><script src=https://cdn.staticfile.org/twikoo/1.6.16/twikoo.all.min.js></script><script>twikoo.init({envId:"https://hugo-api-khaki.vercel.app/# å¡«å†™è‡ªå·±çš„twikoo id",el:"#tcomment",lang:"zh-CN",region:null,path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><span>Copyright
&copy;
2020-2023
<a href=https://senmer.github.io/zh/ style=color:#939393>WZ's Blog</a>
All Rights Reserved
</span><a href=https://beian.miit.gov.cn/ target=_blank style=color:#939393></a>&nbsp;
<span><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null" style=display:inline-block;text-decoration:none;height:20px;color:#939393><img src style="float:left;margin:0 5px 0 0">
</a></span><span id=busuanzi_container><span class="fa fa-user"></span> <span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye"></span> <span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span>
</span></a><script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>200||document.documentElement.scrollTop>200?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{(function(){document.cookie="change-themes="+escape("false")})(),document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.body.addEventListener("copy",function(e){if(window.getSelection().toString()&&window.getSelection().toString().length>50){let t=e.clipboardData||window.clipboardData;if(t){e.preventDefault();let n=window.getSelection().toString(),s=window.getSelection().toString();t.setData("text/html",n),t.setData("text/plain",s)}}})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="å¤åˆ¶";function i(){t.innerText="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerText="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){let t=e.textContent;navigator.clipboard.writeText(t),i();return}const n=document.createRange();n.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(n);try{document.execCommand("copy"),i()}catch{}s.removeRange(n)});let l=e.className.replaceAll("language-",""),n=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),o=document.createElement("div");o.innerText=l,n.setAttribute("class","mac-tool"),a.setAttribute("class","mac bb1"),r.setAttribute("class","mac bb2"),c.setAttribute("class","mac bb3"),o.setAttribute("class","language-type"),n.appendChild(a),n.appendChild(r),n.appendChild(c),n.appendChild(o),s.classList.contains("highlight")?(s.appendChild(t),s.appendChild(n)):s.parentNode.firstChild==s||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?(e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t),s.appendChild(n)):(e.parentNode.appendChild(t),s.appendChild(n)))})</script></body></html>