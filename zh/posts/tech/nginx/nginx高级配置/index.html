<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Nginx高级配置 | WZ's Blog</title>
<meta name=keywords content="nginx"><meta name=description content="Nginx 高级配置及第三方模块"><meta name=author content="wz"><link rel=canonical href=https://senmer.github.io/zh/posts/tech/nginx/nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/><link crossorigin=anonymous href=/assets/css/stylesheet.5a2b6d77cc78ad18bcb4914c5c639c7ce5ab55e956c461d4310747892b3f50c2.css integrity="sha256-Wittd8x4rRi8tJFMXGOcfOWrVelWxGHUMQdHiSs/UMI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://senmer.github.io/img/Q.gif><link rel=icon type=image/png sizes=16x16 href=https://senmer.github.io/img/Q.gif><link rel=icon type=image/png sizes=32x32 href=https://senmer.github.io/img/Q.gif><link rel=apple-touch-icon href=https://senmer.github.io/img/Q.gif><link rel=mask-icon href=https://senmer.github.io/img/Q.gif><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script src=https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?4d7c4710a089d70b71310f0e1ec7681b",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="Nginx高级配置"><meta property="og:description" content="Nginx 高级配置及第三方模块"><meta property="og:type" content="article"><meta property="og:url" content="https://senmer.github.io/zh/posts/tech/nginx/nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-02T10:00:16+00:00"><meta property="article:modified_time" content="2022-08-02T10:00:16+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Nginx高级配置"><meta name=twitter:description content="Nginx 高级配置及第三方模块"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"📚文章","item":"https://senmer.github.io/zh/posts/"},{"@type":"ListItem","position":2,"name":"👨🏻‍💻 技术","item":"https://senmer.github.io/zh/posts/tech/"},{"@type":"ListItem","position":3,"name":"Nginx高级配置","item":"https://senmer.github.io/zh/posts/tech/nginx/nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Nginx高级配置","name":"Nginx高级配置","description":"Nginx 高级配置及第三方模块\n","keywords":["nginx"],"articleBody":"Nginx 高级配置及第三方模块\nNginx 状态页 基于nginx 模块 ngx_http_stub_status_module 实现，在编译安装nginx的时候需要添加编译参数 –with-http_stub_status_module\n注意：状态页显示的是整个服务器的状态，而非虚拟主机的状态\n配置示例\n[root@centos7 conf.d]# nginx -V #查看nginx编译参数，确定添加了ngx_http_stub_status_module模块 nginx version: nginx/1.18.0 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) built with OpenSSL 1.0.2k-fips 26 Jan 2017 TLS SNI support enabled configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module [root@centos7 conf.d]# pwd /apps/nginx/conf.d [root@centos7 conf.d]# cat pc.conf #编辑虚拟主机，添加状态页配置 server { listen 80 default_server; server_name pc.test.org; location /nginx_status { #状态页uri匹配规则 stub_status; } } ##访问测试 [root@centos7 conf.d]# curl pc.test.org/nginx_status/ Active connections: 1 server accepts handled requests 11 11 15 #分别对应accepts,handled,requests三个字段 Reading: 0 Writing: 1 Waiting: 0 ##参数解释 Active connections： #当前处于活动状态的客户端连接数（=reading+writing+waiting） accepts：#统计总值，Nginx自启动后已经接受的客户端请求连接的总数。 handled：#统计总值，Nginx自启动后已经处理完成的客户端请求连接总数，通常等于accepts，除非有因为worker_connections限制等被拒绝的连接 requests：#统计总值，Nginx自启动后客户端发来的总的请求数（单次连接可能发生多次请求）。 Reading：#当前状态，正在读取客户端请求报文首部的连接的连接数,数值越大,说明排队现象严重,性能不足 Writing：#当前状态，正在向客户端发送响应报文过程中的连接数,数值越大,说明访问量很大 Waiting：#当前状态，正在等待客户端发出请求的空闲连接数，开启 keep-alive的情况下,这个值等于active – (reading+writing) Nginx 第三方模块 第三方模块是对nginx 的功能扩展，第三方模块需要在编译安装nginx的时候使用参数–add-module=PATH指定路径添加，有的模块是由公司的开发人员针对业务需求定制开发的，有的模块是开源爱好者开发好之后上传到github进行开源的模块，nginx的第三方模块需要从源码重新编译进行支持\n比如:开源的echo模块 https:/github.com/openresty/echo-nginx-module\n示例：添加第三方模块 echo-nginx-module\n#配置虚拟主机使用echo-nginx-module模块 [root@centos7 conf.d]# cat pc.conf server { listen 80 default_server; server_name pc.test.org; location /main { index index.html; default_type text/html; echo \"hello world--\u003e\"; echo $remote_addr; echo_reset_timer; #将计时器开始时间重置为当前时间 echo_location /sub1; echo_location /sub2; echo \"took $echo_time_elapsed sed for total.\"; } } location /sub1 { echo_sleep 1; echo sub1; } location /sub2 { echo_sleep 1; echo sub2; } #语法检查报错 [root@centos7 conf.d]# nginx -t nginx: [emerg] unknown directive \"echo\" in /apps/nginx/conf.d/pc.conf:8 #不支持echo模块 nginx: configuration file /apps/nginx/conf/nginx.conf test failed #查看当前nginx并未添加echo-nginx-module模块 [root@centos7 conf.d]# nginx -V nginx version: nginx/1.18.0 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) built with OpenSSL 1.0.2k-fips 26 Jan 2017 TLS SNI support enabled configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module ###下载echo-nginx-mudule模块，重新编译nginx并添加此模块 [root@centos7 src]# nginx -s stop #停止老版本nginx [root@centos7 conf.d]# cd /usr/local/src [root@centos7 src]# git clone https:/github.com/openresty/echo-nginx-module.git [root@centos7 nginx-1.18.0]# ./configure \\ --prefix=/apps/nginx \\ --user=nginx --group=nginx \\ --with-http_ssl_module \\ --with-http_v2_module \\ --with-http_realip_module \\ --with-http_stub_status_module \\ --with-http_gzip_static_module \\ --with-pcre \\ --with-stream \\ --with-stream_ssl_module \\ --with-stream_realip_module \\ --with-http_perl_module \\ --add-module=/usr/local/src/echo-nginx-module #指定模块源代码路径 [root@centos7 src]# make \u0026\u0026 make install root@centos7 nginx-1.18.0]# /apps/nginx/sbin/nginx -t #语法检查通过 nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok nginx: configuration file /apps/nginx/conf/nginx.conf test is successful [root@centos7 nginx-1.18.0]# /apps/nginx/sbin/nginx -V #查看编译后的新版本 nginx version: nginx/1.18.0 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) built with OpenSSL 1.0.2k-fips 26 Jan 2017 TLS SNI support enabled configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module #访问测试 [root@centos7 nginx-1.18.0]# nginx [root@centos7 nginx-1.18.0]# curl pc.test.org/main/ hello world--\u003e 172.16.16.88 sub1 sub2 took 2.009 sed for total. Nginx 使用变量 nginx的变量可以在配置文件中引用，作为功能判断或者日志等场景使用\n变量可以分为内置变量和自定义变量\n内置变量是由nginx模块自带，通过变量可以获取到众多的与客户端访问相关的值。\n内置变量 官方文档 http:/nginx.org/en/docs/varindex.html\n常用内置变量\n$remote_addr; #存放了客户端的地址，注意是客户端的公网IP $proxy_add_x_forwarded_for #此变量表示将客户端IP追加请求报文中X-Forwarded-For首部字段,多个IP之间用逗号分隔,如果请求中没有X-Forwarded-For, 就使用$remote_addr the “X-Forwarded-For” client request header field with the $remote_addr variable appended to it, separated by a comma. If the “X-Forwarded-For” field is not present in the client request header, the $proxy_add_x_forwarded_for variable is equal to the $remote_addr variable. $args; #存放了URL中的所有参数，例如:对于http:/www.magedu.org/main/index.do?id=20190221\u0026partner=search $args的值就是：id=20190221\u0026partner=search $document_root; #保存了针对当前资源的请求的系统根目录,例如:/apps/nginx/html。 $document_uri; #保存了当前请求中不包含参数的URI，注意是不包含请求的指令，比如:http:/www.magedu.org/main/index.do?id=20190221\u0026partner=search会被定义为/main/index.do #$document_uri的值为:/main/index.do $host; #存放了请求的host名称 $limit_rate; #如果nginx服务器使用limit_rate配置了显示网络速率，则会显示，如果没有设置， 则显示0 $remote_port; #客户端请求Nginx服务器时随机打开的端口，这是每个客户端自己的端口 $remote_user; #已经经过Auth Basic Module验证的用户名 $request_body_file; #做反向代理时发给后端服务器的本地资源的名称 $request_method; #请求资源的方式，GET/PUT/DELETE等 $request_filename; #当前请求的资源文件的磁盘路径，由root或alias指令与URI请求生成的文件绝对路径，如:/apps/nginx/html/main/index.html $request_uri; #包含请求参数的原始URI，不包含主机名，相当于:$document_uri?$args,例如：/main/index.do?id=20190221\u0026partner=search $scheme; #请求的协议，例如:http，https,ftp等 $server_protocol; #保存了客户端请求资源使用的协议的版本，例如:HTTP/1.0，HTTP/1.1，HTTP/2.0等 $server_addr; #保存了服务器的IP地址 $server_name; #请求的服务器的主机名 $server_port; #请求的服务器的端口号 $http_user_agent; #客户端浏览器的详细信息 $http_cookie; #客户端的所有cookie信息 $cookie_ #cookie中某个字段值，name为任意请求报文首部字部cookie的key $http_ #name为任意请求报文首部字段,表示记录请求报文的首部字段，name的对应的首部字段名需要为小写，如果有横线需要替换为下划线。 #示例: echo $http_user_agent; echo $http_host; $sent_http_ #name为响应报文的首部字段，name的对应的首部字段名需要为小写，如果有横线需要替换为下划线,此变量有问题 #示例： echo $sent_http_server; $arg_ #此变量存放了URL中的指定参数，name为请求url中指定的参数名 #示例 echo $arg_id; 范例：\n##站点配置 [root@centos7 ~]# cat /apps/nginx/conf.d/pc.conf server { listen 80 default_server; server_name pc.test.org; location /main { index index.html; default_type text/html; echo $remote_addr; echo $args; echo $document_root; echo $document_uri; echo $host; echo $http_user_agent; echo $http_cookie; echo $request_filename; echo $scheme; echo $scheme:/$host$document_uri?$args; } } ##返回结果 [root@centos7 ~]# curl -b title=test 'http:/pc.test.org/main/index.do?id=2022\u0026partner=search' 172.16.16.88 id=2022\u0026partner=search /apps/nginx/html /main/index.do pc.test.org curl/7.29.0 title=test /apps/nginx/html/main/index.do http http:/pc.test.org/main/index.do?id=2022\u0026partner=search 范例：\n##站点配置 [root@centos7 ~]# cat /apps/nginx/conf.d/www.conf server { listen 80; server_name www.test.com; location /echo { echo $request; echo $proxy_add_x_forwarded_for; echo $args; echo $document_uri; echo $request_uri; echo $document_root; echo $host; echo $request_method; echo $request_filename; echo $scheme; set $test $http_host; #自定义变量，将$http_host的值赋给test变量 echo $test; echo $http_User_Agent; echo $http_cookie; echo $cookie_key1; } } ##访问测试 [root@centos7 ~]# curl -b 'key1=v1;key2=v2' \"http:/www.test.com/echo/index.html?id=666\u0026partner=search\" GET /echo/index.html?id=666\u0026partner=search HTTP/1.1 172.16.16.88 id=666\u0026partner=search /echo/index.html /echo/index.html?id=666\u0026partner=search /apps/nginx/html www.test.com GET /apps/nginx/html/echo/index.html http www.test.com curl/7.29.0 key1=v1;key2=v2 v1 自定义变量 语法格式：\nSyntax: set $variable value; Default: — Context: server, location, if 范例：\n##站点配置 [root@centos7 ~]# cat /apps/nginx/conf.d/www.conf server { listen 80; server_name www.test.com; location /echo { set $name test; echo $name; set $my_port $server_port; echo $my_port; echo \"server_name:$server_port\"; } } ##访问测试 [root@centos7 ~]# curl www.test.com/echo GET /echo HTTP/1.1 172.16.16.88 /echo /echo /apps/nginx/html www.test.com GET /apps/nginx/html/echo http www.test.com curl/7.29.0 Nginx 自定义访问日志 访问日志是记录客户端即用户的具体请求内容信息，而在全局配置模块中的error_log是记录nginx服务器运行时的日志保存路径和日志的level，两者是不同的，而且Nginx的错误日志一般只有一个，但是访问日志可以在不同的server中定义多个。定义访问日志使用access_log指令指定日志保存路径，使用log_format指定日志的格式，格式中定义要保存的具体的日志内容。\n访问日志由 ngx_http_log_module 模块实现\n官方帮助文档：http:/nginx.org/en/docs/http/ngx_http_log_module.html\n语法格式：\nSyntax: access_log path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]]; access_log off; Default: access_log logs/access.log combined; Context: http, server, location, if in location, limit_except 自定义日志默认格式 如果要保留日志的源格式，只需添加相应的日志内容，配置如下：\nhttp { ... log_format my_nginx_format '$remote_addr - $remote_user [$time_local] \"$request\"' '$status $body_bytes_sent \"$http_referer\"' '\"$http_user_agent\" \"$http_x_forwarded_for\"' '$server_name:$server_port'; access_log logs/access.log my_nginx_format; ... } #注意：此指令一定要放在log_format命令后（nginx配置从上至下依次生效） access_log logs/access.log my_nginx_format; ##重启nginx访问测试 [root@centos7 nginx]# tail -3 logs/access.log 172.16.16.88 - - [02/Aug/2022:23:51:26 +0800] \"GET /echo HTTP/1.1\" 200 211 \"-\" \"curl/7.29.0\" #默认日志格式 172.16.16.88 - - [04/Aug/2022:19:08:42 +0800] \"GET / HTTP/1.1\"200 6 \"-\"\"curl/7.29.0\" \"-\"pc.test.org:80 #自定义日志格式my_nginx_format 自定义json格式日志 nginx的默认日志格式记录的内容相对单一，且默认的格式也不方便后期做日志统计分析，生产环境中通常将nginx日志格式为json格式，然后配合ELK做日志收集、统计和分析。\n配置示例：\nhttp { ... log_format json_log '{\"@timestamp\":\"$time_iso8601\",' '\"clientip\":\"$remote_addr\",' '\"size\":$body_bytes_sent,' '\"responsetime\":$request_time,' '\"upstreamtime\":\"$upstream_response_time\",' '\"upstreamhost\":\"$upstream_addr\",' '\"http_host\":\"$host\",' '\"uri\":\"$uri\",' '\"xff\":\"$http_x_forwarded_for\",' '\"referer\":\"$http_referer\",' '\"tcp_xff\":\"$proxy_protocol_addr\",' '\"http_user_agent\":\"$http_user_agent\",' '\"status\":\"$status\"}'; access_log logs/access.log json_log; ... } ##重启nginx，查看生成的日志格式 [root@centos7 nginx]# tail -1 logs/access.log {\"@timestamp\":\"2022-08-04T19:27:18+08:00\",\"clientip\":\"127.0.0.1\",\"size\":6,\"responsetime\":0.000,\"upstreamtime\":\"-\",\"upstreamhost\":\"-\",\"http_host\":\"localhost\",\"uri\":\"/index.html\",\"xff\":\"-\",\"referer\":\"-\",\"tcp_xff\":\"-\",\"http_user_agent\":\"curl/7.29.0\",\"status\":\"200\" Nginx 压缩功能 Nginx支持对指定类型的文件进行压缩然后再传输给客户端，而且压缩还可以设置压缩比例，压缩后的\n文件大小将比源文件显著变小，这样有助于降低出口带宽的利用率，降低企业的IT支出，不过会占用相\n应的CPU资源。\nNginx对文件的压缩功能是依赖于模块 ngx_http_gzip_module,默认是内置模块\n官方文档：https:/nginx.org/en/docs/http/ngx_http_gzip_module.html\n格式：\nSyntax:\tgzip on | off; Default:\tgzip off; Context:\thttp, server, location, if in location 相关指令：\n#启用或禁用gzip压缩，默认关闭 gzip on | off; #压缩比由低到高从1到9，默认为1 gzip_comp_level level; #禁用IE6 gzip功能 gzip_disable \"MSIE [1-6]\\.\"; #gzip压缩的最小文件，小于设置值的文件将不会压缩 gzip_min_length 1k; #启用压缩功能时，协议的最小版本，默认HTTP/1.1 gzip_http_version 1.0 | 1.1; #指定Nginx服务需要向服务器申请的缓存空间的个数和大小,平台不同,默认:32 4k或者16 8k; gzip_buffers number size; #指明仅对哪些类型的资源执行压缩操作;默认为gzip_types text/html，不用显示指定，否则出错 gzip_types mime-type ...; #如果启用压缩，是否在响应报文首部插入“Vary: Accept-Encoding”,一般建议打开 gzip_vary on | off; #预压缩，即直接从磁盘找到对应文件的gz后缀的式的压缩文件返回给用户，无需消耗服务器CPU #注意: 来自于ngx_http_gzip_static_module模块 gzip_static on | off; 示例：\n##分别生成5Bytes 大小的index.html文件以及2k大小的2k.text [root@centos7 ~]# echo test \u003e /apps/nginx/html/pc/index.html [root@centos7 ~]# dd if=/dev/zero of=/apps/nginx/html/pc/2k.text bs=2k count=1 1+0 records in 1+0 records out 2048 bytes (2.0 kB) copied, 0.000405459 s, 5.1 MB/s [root@centos7 ~]# ll /apps/nginx/html/pc/2k.text -h -rw-r--r-- 1 root root 2.0K Aug 4 20:01 /apps/nginx/html/pc/2k.text [root@centos7 ~]# ll /apps/nginx/html/pc/index.html -h -rw-r--r-- 1 nginx nginx 5 Aug 4 19:43 /apps/nginx/html/pc/index.html #准备站点配置 [root@centos7 ~]# cat /apps/nginx/conf.d/pc.conf server { listen 80 default_server; server_name pc.test.org; gzip on; gzip_comp_level 5; gzip_min_length 1k; #小于1k的文件不压缩 gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/gif image/png; gzip_vary on; location / { index index.html; default_type text/html; root html/pc; } } [root@centos7 ~]# nginx -s reload [root@centos7 ~]# curl -I --compressed pc.test.org/index.html HTTP/1.1 200 OK Server: nginx/1.18.0 Date: Thu, 04 Aug 2022 12:02:22 GMT Content-Type: text/html Content-Length: 5 #index.html文件未压缩，仍是5Bytes Last-Modified: Thu, 04 Aug 2022 11:43:47 GMT Connection: keep-alive Keep-Alive: timeout=60 ETag: \"62ebb0f3-5\" Accept-Ranges: bytes [root@centos7 ~]# curl -I --compressed pc.test.org/2k.txt HTTP/1.1 404 Not Found Server: nginx/1.18.0 Date: Thu, 04 Aug 2022 12:02:34 GMT Content-Type: text/html Content-Length: 153 #2k.txt被压缩为153Bytes Connection: keep-alive Keep-Alive: timeout=60 Nginx 配置https https 相关参数 nginx 的https 功能基于模块ngx_http_ssl_module实现，作为nginx的核心功能，yum安装的nginx默认就是开启的，编译安装的nginx需要指定编译参数–with-http_ssl_module开启。\n官方文档：https:/nginx.org/en/docs/http/ngx_http_ssl_module.html\n相关指令：\n#为指定的虚拟主机配置是否启用ssl功能，此功能在1.15.0废弃，使用listen [ssl]替代 ssl on | off; listen 443 ssl; #指向包含当前虚拟主机和CA的两个证书信息的文件，一般是crt文件 ssl_certificate /path/to/file; #当前虚拟主机使用的私钥文件，一般是key文件 ssl_certificate_key /path/to/file; #支持ssl协议版本，早期为ssl现在是TLS，默认为后三个 #配置ssl缓存 ssl_session_cache off | none | [builtin[:size]] [shared:name:size]; off： #关闭缓存 none: #通知客户端支持ssl session cache，但实际不支持 builtin[:size]：#使用OpenSSL内建缓存，为每worker进程私有 [shared:name:size]：#在各worker之间使用一个共享的缓存，需要定义一个缓存名称和缓存空间大小，一兆可以存储4000个会话信息，多个虚拟主机可以使用相同的缓存名称 #客户端连接可以复用ssl session cache中缓存的有效时长，默认5m ssl_session_timeout time; 自签名证书 生成自签名证书\n##进入nginx安装目录，新建存放证书的目录 [root@centos7 ~]# cd /apps/nginx/ [root@centos7 nginx]# mkdir certs [root@centos7 nginx]# cd certs/ ##生成自签名CA证书ca.crt和私钥ca.key [root@centos7 certs]# openssl req -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 3650 -out ca.crt Generating a 4096 bit RSA private key ...........................................................................................++ ................................................................................................................................................................................++ writing new private key to 'ca.key' ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [XX]:cn State or Province Name (full name) []:sichuan Locality Name (eg, city) [Default City]:chengdu Organization Name (eg, company) [Default Company Ltd]:nginx Organizational Unit Name (eg, section) []:nginx.com Common Name (eg, your name or your server's hostname) []:www.nginx.com Email Address []:22@qq.com [root@centos7 certs]# ls ca.crt ca.key ##生成网站私钥www.nginx.com.key和证书请求www.nginx.com.csr [root@centos7 certs]# openssl req -newkey rsa:4096 -nodes -sha256 -keyout www.nginx.com.key -out www.nginx.com.csr Generating a 4096 bit RSA private key .......++ ...................................................................................++ writing new private key to 'www.nginx.com.key' ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [XX]:cn #国家 State or Province Name (full name) []:sichuan #省份 Locality Name (eg, city) [Default City]:chengdu #城市 Organization Name (eg, company) [Default Company Ltd]:nginx #公司 Organizational Unit Name (eg, section) []:nginx.com #部门 Common Name (eg, your name or your server's hostname) []:www.nginx.com #通用名 Email Address []:511670559@qq.com #邮箱 Please enter the following 'extra' attributes to be sent with your certificate request A challenge password []: An optional company name []: [root@centos7 certs]# ls www* www.nginx.com.csr www.nginx.com.key www.nginx.crt ##使用ca签发网站的证书www.nginx.crt [root@centos7 certs]# openssl x509 -req -days 3650 -in www.nginx.com.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out www.nginx.com.crt Signature ok subject=/C=cn/ST=sichuan/L=chengdu/O=nginx/OU=nginx.com/CN=www.nginx.com/emailAddress=511670559@qq.com Getting CA Private Key [root@centos7 certs]# ls ca.crt ca.key ca.srl www.nginx.com.crt www.nginx.com.csr www.nginx.com.key ##查看证书内容 [root@centos7 certs]# openssl x509 -in www.nginx.com.crt -noout -text Certificate: Data: Version: 1 (0x0) Serial Number: f5:49:30:f5:10:2f:4b:ea Signature Algorithm: sha256WithRSAEncryption Issuer: C=cn, ST=sichuan, L=chengdu, O=nginx, OU=nginx.com, CN=www.nginx.com/emailAddress=22@qq.com Validity Not Before: Aug 4 14:48:57 2022 GMT Not After : Aug 1 14:48:57 2032 GMT Subject: C=cn, ST=sichuan, L=chengdu, O=nginx, OU=nginx.com, CN=www.nginx.com/emailAddress=511670559@qq.com Subject Public Key Info: Public Key Algorithm: rsaEncryption Public-Key: (4096 bit) ... ## 将ca证书和网站证书输出到一个文件（注意前后次序） [root@centos7 certs]# cat www.nginx.com.crt ca.crt \u003e www.nginx.com.pem https 配置 ##准备站点配置文件 [root@centos7 certs]# cat /apps/nginx/conf.d/pc.conf server { listen 80; listen 443 ssl; server_name pc.test.org; location / { index index.html; default_type text/html; root html/pc; } ssl_certificate /apps/nginx/certs/www.nginx.com.pem; ssl_certificate_key /apps/nginx/certs/www.nginx.com.key; ssl_session_cache shared:sslcache:20m; } ##重启nginx [root@centos7 certs]# nginx -t nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok nginx: configuration file /apps/nginx/conf/nginx.conf test is successful [root@centos7 certs]# nginx -s reload 浏览器访问测试，由于是自签名证书，浏览器并不信任\n实现多域名 https Nginx 支持基于单个IP实现多域名的功能，并且还支持单IP多域名的基础之上实现HTTPS，其实是基于Nginx的 SNI（Server Name Indication）功能实现，SNI是为了解决一个Nginx服务器内使用一个IP绑定多个域名和证书的功能。其实现流程是客户端在连接到服务器建立SSL链接之前先发送要访问站点的域名（Hostname），这样服务器再根据这个域名返回给客户端一个合适的证书。\n简单来说，SNI实现了为多个虚拟主机配置各自的https认证功能，配置方式和上一节内容类似，这里不做演示。\n查看nginx支持SNI功能：\n[root@centos7 nginx]# nginx -V nginx version: nginx/1.18.0 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) built with OpenSSL 1.0.2k-fips 26 Jan 2017 TLS SNI support enabled #支持SNI功能 configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module 实现 HSTS 官方文档：https:/www.nginx.com/blog/http-strict-transport-security-hsts-and-nginx/\n未配置http跳转的情况时：\n实例：\n# 站点配置 [root@centos7 conf.d]# cat pc.conf server { listen 80; listen 443 ssl; ssl_certificate /apps/nginx/certs/www.nginx.com.pem; ssl_certificate_key /apps/nginx/certs/www.nginx.com.key; ssl_session_cache shared:sslcache:20m; ssl_session_timeout 10m; server_name pc.test.org; location / { index index.html; default_type text/html; root html/; } } #http访问成功 [root@centos7 conf.d]# curl www.test.org default #https请求报错 [root@centos7 conf.d]# curl www.test.org:443 400 The plain HTTP request was sent to HTTPS port 400 Bad Request The plain HTTP request was sent to HTTPS port nginx/1.18.0 配置rewrite实现http跳转https后：\n范例：\n##站点配置 [root@centos7 conf.d]# cat pc.conf server { listen 80; listen 443 ssl; ssl_certificate /apps/nginx/certs/www.nginx.com.pem; ssl_certificate_key /apps/nginx/certs/www.nginx.com.key; ssl_session_cache shared:sslcache:20m; ssl_session_timeout 10m; server_name pc.test.org; add_header Strict-Transport-Security \"max-age=31536000; includeSubDomains\" always; #开启客户端缓存功能，当发起http请求时优先访问缓存，直接进行本地http跳转 location / { index index.html; default_type text/html; root html/; #配置http跳转https if ( $scheme = http ) { rewrite ^/(.*)$ https:/www.test.org/$1 redirect; } } } #发起http请求，返回响应码为302 [root@centos7 conf.d]# curl pc.test.org 302 Found 302 Found nginx/1.18.0 [root@centos7 conf.d]# curl pc.test.org -L #跟踪302重定向后又报证书校验错误 curl: (60) Peer's certificate issuer has been marked as not trusted by the user. More details here: http:/curl.haxx.se/docs/sslcerts.html curl performs SSL certificate verification by default, using a \"bundle\" of Certificate Authority (CA) public keys (CA certs). If the default bundle file isn't adequate, you can specify an alternate file using the --cacert option. If this HTTPS server uses a certificate signed by a CA represented in the bundle, the certificate verification probably failed due to a problem with the certificate (it might be expired, or the name might not match the domain name in the URL). If you'd like to turn off curl's verification of the certificate, use the -k (or --insecure) option. # 发起http请求，自动跳转https成功 [root@centos7 conf.d]# curl pc.test.org -kL #跟随重定向并忽略证书安全性检查，请求成功 default 关于 favicon.io favicon.ico 文件是网站标签页的小图标，当客户端使用浏览器问页面时，浏览器会自己主动发起请求获取页面的favicon.ico文件，但是当浏览器请求的favicon.ico文件不存在时，服务器会记录404日志，而且浏览器也会显示404报错\n图标位置：\n报错如下：\n[root@centos7 nginx]# tail -1 logs/error.log # 日志中的报错 2022/08/05 17:47:54 [error] 2604#0: *200 open() \"/apps/nginx/html/favicon.ico\" failed (2: No such file or directory), client: 172.16.16.1, server: pc.test.org, request: \"GET /favicon.ico HTTP/1.1\", host: \"pc.test.org\", referrer: \"http:/pc.test.org/\" [root@centos7 nginx]# ls /apps/nginx/html/favicon.ico # 文件确实不存在 ls: cannot access /apps/nginx/html/favicon.ico: No such file or directory 解决方案：\n#将自己的图标命令为favicon.ico放置于指定目录下 [root@centos7 html]# wget https:/gitee.com/favicon.ico -P /apps/nginx/html/ [root@centos7 html]# ll /apps/nginx/html/favicon.ico -rw-r--r-- 1 root root 41566 Jun 10 11:59 /apps/nginx/html/favicon.ico 访问测试（浏览器按快捷键 CTRL+F5 强制刷新）\nOpenSSL版本升级 OpenSSL程序库当前广泛用于实现互联网的传输层安全（TLS）协议。心脏出血（Heartbleed），也简\n称为心血漏洞，是一个出现在加密程序库OpenSSL的安全漏洞，此漏洞于2012年被引入了软件中，\n2014年4月首次向公众披露。只要使用的是存在缺陷的OpenSSL实例，无论是服务器还是客户端，都可\n能因此而受到攻击。此问题的原因是在实现TLS的心跳扩展时没有对输入进行适当验证（缺少边界检\n查），因此漏洞的名称来源于“心跳”（heartbeat）。该程序错误属于缓冲区过读，即可以读取的数据比应该允许读取的还多。\n范例：升级OpenSSL解决安全漏洞\n[root@centos7 ~]# nginx -V nginx version: nginx/1.18.0 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) built with OpenSSL 1.0.2k-fips 26 Jan 2017 #当前OpenSSL版本 TLS SNI support enabled configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module ##下载较新版本OpenSSL源码包 [root@centos7 ~]# cd /usr/local/src/ [root@centos7 src]# wget https:/www.openssl.org/source/openssl-1.1.1h.tar.gz --no-check-certificate [root@centos7 src]# tar xf openssl-1.1.1h.tar.gz ##编译安装OpenSSL [root@centos7 src]# cd /usr/local/src/nginx-1.18.0/ [root@centos7 nginx-1.18.0]# ./configure --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module --with-openssl=/usr/local/src/openssl-1.1.1h #注意OpenSSL路径要添加正确 [root@centos7 nginx-1.18.0]# make \u0026\u0026 make install #语法检查通过 [root@centos7 nginx-1.18.0]# nginx -t nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok nginx: configuration file /apps/nginx/conf/nginx.conf test is successful [root@centos7 nginx-1.18.0]# nginx -V nginx version: nginx/1.18.0 built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) built with OpenSSL 1.1.1h 22 Sep 2020 #版本升级成功 TLS SNI support enabled configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module --with-openssl=/usr/local/src/openssl-1.1.1h ","wordCount":"7210","inLanguage":"zh","datePublished":"2022-08-02T10:00:16Z","dateModified":"2022-08-02T10:00:16Z","author":{"@type":"Person","name":"wz"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://senmer.github.io/zh/posts/tech/nginx/nginx%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/"},"publisher":{"@type":"Organization","name":"WZ's Blog","logo":{"@type":"ImageObject","url":"https://senmer.github.io/img/Q.gif"}}}</script></head><body id=top><script>(function(){let e,t=new RegExp("(^| )change-themes=([^;]*)(;|$)");(e=document.cookie.match(t))||((new Date).getHours()>=19||(new Date).getHours()<6?(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark")):(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")))})(),localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://senmer.github.io/zh/ accesskey=h title="WZ's Blog (Alt + H)"><img src=https://senmer.github.io/img/Q.gif alt=logo aria-label=logo height=35>WZ's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://senmer.github.io/zh/search title="🔍 搜索 (Alt + /)" accesskey=/><span>🔍 搜索</span></a></li><li><a href=https://senmer.github.io/zh/ title="🏠 主页"><span>🏠 主页</span></a></li><li><a href=https://senmer.github.io/zh/posts/tech title="📚 文章"><span>📚 文章</span></a></li><li><a href=https://senmer.github.io/zh/categories/ title="🧩 分类"><span>🧩 分类</span></a></li><li><a href=https://senmer.github.io/zh/archives/ title="⏱️ 时间轴"><span>⏱️ 时间轴</span></a></li></ul></nav></header><main class="main page"><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}</style><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://senmer.github.io/zh/>🏠 主页</a>&nbsp;»&nbsp;<a href=https://senmer.github.io/zh/posts/>📚文章</a>&nbsp;»&nbsp;<a href=https://senmer.github.io/zh/posts/tech/>👨🏻‍💻 技术</a></div><h1 class=post-title>Nginx高级配置</h1><div class=post-meta><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}.parent-post-meta{display:flex;flex-wrap:wrap;opacity:.8}</style><span class=parent-post-meta><span id=post_meta_style_1><span class="fa fa-calendar-check-o"></span>
<span>2022-08-02
&nbsp;&nbsp;
</span></span><span id=post_meta_style_3><span class="fa fa-file-word-o"></span>
<span>7210字
&nbsp;&nbsp;
</span></span><span id=post_meta_style_4><span class="fa fa-clock-o"></span>
<span>15分钟
&nbsp;&nbsp;
</span></span><span id=post_meta_style_5><span class="fa fa-user-o"></span>
<span>wz
&nbsp;&nbsp;
</span></span><span id=post_meta_style_6><span class="fa fa-tags" style=opacity:.8></span>
<span><span class=post-tags-meta><a href=https://senmer.github.io/zh/tags/nginx/ style=color:var(--secondary)!important>Nginx</a>
</span></span></span></span><span style=opacity:.8><span id=post_meta_style_7>&nbsp;&nbsp;
<span class="fa fa-eye"></span>
<span><span id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv></span></span>
&nbsp;&nbsp;
</span></span><span id=post_meta_style_8><span class="fa fa-commenting-o"></span>
<span><script src=https://cdn.staticfile.org/twikoo/1.6.16/twikoo.all.min.js></script><script>let url=document.documentURI,dnsUrl="https://senmer.github.io/",urlSplit=url.split(dnsUrl),finalUrl=urlSplit[1];finalUrl[0]!=="/"&&(finalUrl="/"+finalUrl),twikoo.getCommentsCount({envId:"https://hugo-api-khaki.vercel.app/# 填写自己的twikoo id",region:null,urls:[finalUrl],includeReply:!1}).then(function(e){let t=e[0].count;const n=document.getElementById("comment_count");n.innerText=t}).catch(function(e){console.error(e)})</script><span id=comment_count></span></span></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#nginx-%e7%8a%b6%e6%80%81%e9%a1%b5 aria-label="Nginx 状态页">Nginx 状态页</a></li><li><a href=#nginx-%e7%ac%ac%e4%b8%89%e6%96%b9%e6%a8%a1%e5%9d%97 aria-label="Nginx 第三方模块">Nginx 第三方模块</a></li><li><a href=#nginx-%e4%bd%bf%e7%94%a8%e5%8f%98%e9%87%8f aria-label="Nginx 使用变量">Nginx 使用变量</a><ul><li><a href=#%e5%86%85%e7%bd%ae%e5%8f%98%e9%87%8f aria-label=内置变量>内置变量</a></li><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e5%8f%98%e9%87%8f aria-label=自定义变量>自定义变量</a></li></ul></li><li><a href=#nginx-%e8%87%aa%e5%ae%9a%e4%b9%89%e8%ae%bf%e9%97%ae%e6%97%a5%e5%bf%97 aria-label="Nginx 自定义访问日志">Nginx 自定义访问日志</a><ul><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e6%97%a5%e5%bf%97%e9%bb%98%e8%ae%a4%e6%a0%bc%e5%bc%8f aria-label=自定义日志默认格式>自定义日志默认格式</a></li><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89json%e6%a0%bc%e5%bc%8f%e6%97%a5%e5%bf%97 aria-label=自定义json格式日志>自定义json格式日志</a></li></ul></li><li><a href=#nginx-%e5%8e%8b%e7%bc%a9%e5%8a%9f%e8%83%bd aria-label="Nginx 压缩功能">Nginx 压缩功能</a></li><li><a href=#nginx-%e9%85%8d%e7%bd%aehttps aria-label="Nginx 配置https">Nginx 配置https</a><ul><li><a href=#https-%e7%9b%b8%e5%85%b3%e5%8f%82%e6%95%b0 aria-label="https 相关参数">https 相关参数</a></li><li><a href=#%e8%87%aa%e7%ad%be%e5%90%8d%e8%af%81%e4%b9%a6 aria-label=自签名证书>自签名证书</a></li><li><a href=#https-%e9%85%8d%e7%bd%ae aria-label="https 配置">https 配置</a></li><li><a href=#%e5%ae%9e%e7%8e%b0%e5%a4%9a%e5%9f%9f%e5%90%8d-https aria-label="实现多域名 https">实现多域名 https</a></li><li><a href=#%e5%ae%9e%e7%8e%b0-hsts aria-label="实现 HSTS">实现 HSTS</a></li></ul></li><li><a href=#%e5%85%b3%e4%ba%8e-faviconio aria-label="关于 favicon.io">关于 favicon.io</a></li><li><a href=#openssl%e7%89%88%e6%9c%ac%e5%8d%87%e7%ba%a7 aria-label=OpenSSL版本升级>OpenSSL版本升级</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>Nginx 高级配置及第三方模块</p><h1 id=nginx-状态页>Nginx 状态页<a hidden class=anchor aria-hidden=true href=#nginx-状态页>#</a></h1><p>基于nginx 模块 ngx_http_stub_status_module 实现，在编译安装nginx的时候需要添加编译参数 &ndash;with-http_stub_status_module</p><p>注意：状态页显示的是整个服务器的状态，而非虚拟主机的状态</p><p>配置示例</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 conf.d<span style=color:#f92672>]</span><span style=color:#75715e># nginx -V  #查看nginx编译参数，确定添加了ngx_http_stub_status_module模块</span>
</span></span><span style=display:flex><span>nginx version: nginx/1.18.0
</span></span><span style=display:flex><span>built by gcc 4.8.5 <span style=color:#ae81ff>20150623</span> <span style=color:#f92672>(</span>Red Hat 4.8.5-44<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>GCC<span style=color:#f92672>)</span> 
</span></span><span style=display:flex><span>built with OpenSSL 1.0.2k-fips  <span style=color:#ae81ff>26</span> Jan <span style=color:#ae81ff>2017</span>
</span></span><span style=display:flex><span>TLS SNI support enabled
</span></span><span style=display:flex><span>configure arguments: --prefix<span style=color:#f92672>=</span>/apps/nginx --user<span style=color:#f92672>=</span>nginx --group<span style=color:#f92672>=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 conf.d<span style=color:#f92672>]</span><span style=color:#75715e># pwd</span>
</span></span><span style=display:flex><span>/apps/nginx/conf.d
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 conf.d<span style=color:#f92672>]</span><span style=color:#75715e># cat pc.conf #编辑虚拟主机，添加状态页配置</span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen <span style=color:#ae81ff>80</span> default_server;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  location /nginx_status <span style=color:#f92672>{</span>  <span style=color:#75715e>#状态页uri匹配规则</span>
</span></span><span style=display:flex><span>        stub_status;
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##访问测试</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 conf.d<span style=color:#f92672>]</span><span style=color:#75715e># curl pc.test.org/nginx_status/ </span>
</span></span><span style=display:flex><span>Active connections: <span style=color:#ae81ff>1</span> 
</span></span><span style=display:flex><span>server accepts handled requests
</span></span><span style=display:flex><span> <span style=color:#ae81ff>11</span> <span style=color:#ae81ff>11</span> <span style=color:#ae81ff>15</span>   <span style=color:#75715e>#分别对应accepts,handled,requests三个字段</span>
</span></span><span style=display:flex><span>Reading: <span style=color:#ae81ff>0</span> Writing: <span style=color:#ae81ff>1</span> Waiting: <span style=color:#ae81ff>0</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##参数解释</span>
</span></span><span style=display:flex><span>Active connections： <span style=color:#75715e>#当前处于活动状态的客户端连接数（=reading+writing+waiting）</span>
</span></span><span style=display:flex><span>accepts：#统计总值，Nginx自启动后已经接受的客户端请求连接的总数。
</span></span><span style=display:flex><span>handled：#统计总值，Nginx自启动后已经处理完成的客户端请求连接总数，通常等于accepts，除非有因为worker_connections限制等被拒绝的连接
</span></span><span style=display:flex><span>requests：#统计总值，Nginx自启动后客户端发来的总的请求数（单次连接可能发生多次请求）。
</span></span><span style=display:flex><span>Reading：#当前状态，正在读取客户端请求报文首部的连接的连接数,数值越大,说明排队现象严重,性能不足
</span></span><span style=display:flex><span>Writing：#当前状态，正在向客户端发送响应报文过程中的连接数,数值越大,说明访问量很大
</span></span><span style=display:flex><span>Waiting：#当前状态，正在等待客户端发出请求的空闲连接数，开启 keep-alive的情况下,这个值等于active – <span style=color:#f92672>(</span>reading+writing<span style=color:#f92672>)</span>
</span></span></code></pre></div><h1 id=nginx-第三方模块>Nginx 第三方模块<a hidden class=anchor aria-hidden=true href=#nginx-第三方模块>#</a></h1><p>第三方模块是对nginx 的功能扩展，第三方模块需要在编译安装nginx的时候使用参数&ndash;add-module=PATH指定路径添加，有的模块是由公司的开发人员针对业务需求定制开发的，有的模块是开源爱好者开发好之后上传到github进行开源的模块，nginx的第三方模块需要从源码重新编译进行支持</p><p>比如:开源的echo模块 https:/github.com/openresty/echo-nginx-module</p><p>示例：添加第三方模块 echo-nginx-module</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#配置虚拟主机使用echo-nginx-module模块</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 conf.d<span style=color:#f92672>]</span><span style=color:#75715e># cat pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen <span style=color:#ae81ff>80</span> default_server;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  location /main <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	index index.html;
</span></span><span style=display:flex><span> 	default_type text/html;
</span></span><span style=display:flex><span>	echo <span style=color:#e6db74>&#34;hello world--&gt;&#34;</span>;
</span></span><span style=display:flex><span>	echo $remote_addr;
</span></span><span style=display:flex><span>	echo_reset_timer;  <span style=color:#75715e>#将计时器开始时间重置为当前时间</span>
</span></span><span style=display:flex><span>	echo_location /sub1;
</span></span><span style=display:flex><span>	echo_location /sub2;
</span></span><span style=display:flex><span>	echo <span style=color:#e6db74>&#34;took </span>$echo_time_elapsed<span style=color:#e6db74> sed for total.&#34;</span>;
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>location /sub1 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	echo_sleep 1;
</span></span><span style=display:flex><span>	echo sub1;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>location /sub2 <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	echo_sleep 1;
</span></span><span style=display:flex><span>	echo sub2;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#语法检查报错</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 conf.d<span style=color:#f92672>]</span><span style=color:#75715e># nginx -t</span>
</span></span><span style=display:flex><span>nginx: <span style=color:#f92672>[</span>emerg<span style=color:#f92672>]</span> unknown directive <span style=color:#e6db74>&#34;echo&#34;</span> in /apps/nginx/conf.d/pc.conf:8 <span style=color:#75715e>#不支持echo模块</span>
</span></span><span style=display:flex><span>nginx: configuration file /apps/nginx/conf/nginx.conf test failed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#查看当前nginx并未添加echo-nginx-module模块</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 conf.d<span style=color:#f92672>]</span><span style=color:#75715e># nginx -V</span>
</span></span><span style=display:flex><span>nginx version: nginx/1.18.0
</span></span><span style=display:flex><span>built by gcc 4.8.5 <span style=color:#ae81ff>20150623</span> <span style=color:#f92672>(</span>Red Hat 4.8.5-44<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>GCC<span style=color:#f92672>)</span> 
</span></span><span style=display:flex><span>built with OpenSSL 1.0.2k-fips  <span style=color:#ae81ff>26</span> Jan <span style=color:#ae81ff>2017</span>
</span></span><span style=display:flex><span>TLS SNI support enabled
</span></span><span style=display:flex><span>configure arguments: --prefix<span style=color:#f92672>=</span>/apps/nginx --user<span style=color:#f92672>=</span>nginx --group<span style=color:#f92672>=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>###下载echo-nginx-mudule模块，重新编译nginx并添加此模块</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 src<span style=color:#f92672>]</span><span style=color:#75715e># nginx -s stop  #停止老版本nginx</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 conf.d<span style=color:#f92672>]</span><span style=color:#75715e># cd /usr/local/src</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 src<span style=color:#f92672>]</span><span style=color:#75715e># git clone https:/github.com/openresty/echo-nginx-module.git</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 nginx-1.18.0<span style=color:#f92672>]</span><span style=color:#75715e>#  ./configure \</span>
</span></span><span style=display:flex><span>--prefix<span style=color:#f92672>=</span>/apps/nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--user<span style=color:#f92672>=</span>nginx --group<span style=color:#f92672>=</span>nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-http_ssl_module <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-http_v2_module <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-http_realip_module <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-http_stub_status_module <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-http_gzip_static_module <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-pcre <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-stream <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-stream_ssl_module <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-stream_realip_module <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-http_perl_module <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--add-module<span style=color:#f92672>=</span>/usr/local/src/echo-nginx-module  <span style=color:#75715e>#指定模块源代码路径</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 src<span style=color:#f92672>]</span><span style=color:#75715e># make &amp;&amp; make install</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@centos7 nginx-1.18.0<span style=color:#f92672>]</span><span style=color:#75715e># /apps/nginx/sbin/nginx -t  #语法检查通过</span>
</span></span><span style=display:flex><span>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok
</span></span><span style=display:flex><span>nginx: configuration file /apps/nginx/conf/nginx.conf test is successful
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 nginx-1.18.0<span style=color:#f92672>]</span><span style=color:#75715e># /apps/nginx/sbin/nginx -V  #查看编译后的新版本</span>
</span></span><span style=display:flex><span>nginx version: nginx/1.18.0
</span></span><span style=display:flex><span>built by gcc 4.8.5 <span style=color:#ae81ff>20150623</span> <span style=color:#f92672>(</span>Red Hat 4.8.5-44<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>GCC<span style=color:#f92672>)</span> 
</span></span><span style=display:flex><span>built with OpenSSL 1.0.2k-fips  <span style=color:#ae81ff>26</span> Jan <span style=color:#ae81ff>2017</span>
</span></span><span style=display:flex><span>TLS SNI support enabled
</span></span><span style=display:flex><span>configure arguments: --prefix<span style=color:#f92672>=</span>/apps/nginx --user<span style=color:#f92672>=</span>nginx --group<span style=color:#f92672>=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module<span style=color:#f92672>=</span>/usr/local/src/echo-nginx-module
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#访问测试</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 nginx-1.18.0<span style=color:#f92672>]</span><span style=color:#75715e># nginx</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 nginx-1.18.0<span style=color:#f92672>]</span><span style=color:#75715e># curl pc.test.org/main/</span>
</span></span><span style=display:flex><span>hello world--&gt;
</span></span><span style=display:flex><span>172.16.16.88
</span></span><span style=display:flex><span>sub1
</span></span><span style=display:flex><span>sub2
</span></span><span style=display:flex><span>took 2.009 sed <span style=color:#66d9ef>for</span> total.
</span></span></code></pre></div><h1 id=nginx-使用变量>Nginx 使用变量<a hidden class=anchor aria-hidden=true href=#nginx-使用变量>#</a></h1><p>nginx的变量可以在配置文件中引用，作为功能判断或者日志等场景使用</p><p>变量可以分为内置变量和自定义变量</p><p>内置变量是由nginx模块自带，通过变量可以获取到众多的与客户端访问相关的值。</p><h2 id=内置变量>内置变量<a hidden class=anchor aria-hidden=true href=#内置变量>#</a></h2><p>官方文档 http:/nginx.org/en/docs/varindex.html</p><p>常用内置变量</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$remote_addr; <span style=color:#75715e>#存放了客户端的地址，注意是客户端的公网IP</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$proxy_add_x_forwarded_for  <span style=color:#75715e>#此变量表示将客户端IP追加请求报文中X-Forwarded-For首部字段,多个IP之间用逗号分隔,如果请求中没有X-Forwarded-For, 就使用$remote_addr</span>
</span></span><span style=display:flex><span>the “X-Forwarded-For” client request header field with the $remote_addr variable 
</span></span><span style=display:flex><span>appended to it, separated by a comma. If the “X-Forwarded-For” field is not 
</span></span><span style=display:flex><span>present in the client request header, the $proxy_add_x_forwarded_for variable is 
</span></span><span style=display:flex><span>equal to the $remote_addr variable.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$args; <span style=color:#75715e>#存放了URL中的所有参数，例如:对于http:/www.magedu.org/main/index.do?id=20190221&amp;partner=search $args的值就是：id=20190221&amp;partner=search</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$document_root; <span style=color:#75715e>#保存了针对当前资源的请求的系统根目录,例如:/apps/nginx/html。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$document_uri; <span style=color:#75715e>#保存了当前请求中不包含参数的URI，注意是不包含请求的指令，比如:http:/www.magedu.org/main/index.do?id=20190221&amp;partner=search会被定义为/main/index.do </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#$document_uri的值为:/main/index.do</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$host; <span style=color:#75715e>#存放了请求的host名称</span>
</span></span><span style=display:flex><span>$limit_rate; <span style=color:#75715e>#如果nginx服务器使用limit_rate配置了显示网络速率，则会显示，如果没有设置， 则显示0</span>
</span></span><span style=display:flex><span>$remote_port; <span style=color:#75715e>#客户端请求Nginx服务器时随机打开的端口，这是每个客户端自己的端口</span>
</span></span><span style=display:flex><span>$remote_user; <span style=color:#75715e>#已经经过Auth Basic Module验证的用户名</span>
</span></span><span style=display:flex><span>$request_body_file; <span style=color:#75715e>#做反向代理时发给后端服务器的本地资源的名称</span>
</span></span><span style=display:flex><span>$request_method; <span style=color:#75715e>#请求资源的方式，GET/PUT/DELETE等</span>
</span></span><span style=display:flex><span>$request_filename; <span style=color:#75715e>#当前请求的资源文件的磁盘路径，由root或alias指令与URI请求生成的文件绝对路径，如:/apps/nginx/html/main/index.html</span>
</span></span><span style=display:flex><span>$request_uri; <span style=color:#75715e>#包含请求参数的原始URI，不包含主机名，相当于:$document_uri?$args,例如：/main/index.do?id=20190221&amp;partner=search </span>
</span></span><span style=display:flex><span>$scheme; <span style=color:#75715e>#请求的协议，例如:http，https,ftp等</span>
</span></span><span style=display:flex><span>$server_protocol; <span style=color:#75715e>#保存了客户端请求资源使用的协议的版本，例如:HTTP/1.0，HTTP/1.1，HTTP/2.0等</span>
</span></span><span style=display:flex><span>$server_addr; <span style=color:#75715e>#保存了服务器的IP地址</span>
</span></span><span style=display:flex><span>$server_name; <span style=color:#75715e>#请求的服务器的主机名</span>
</span></span><span style=display:flex><span>$server_port; <span style=color:#75715e>#请求的服务器的端口号</span>
</span></span><span style=display:flex><span>$http_user_agent; <span style=color:#75715e>#客户端浏览器的详细信息</span>
</span></span><span style=display:flex><span>$http_cookie; <span style=color:#75715e>#客户端的所有cookie信息</span>
</span></span><span style=display:flex><span>$cookie_&lt;name&gt; <span style=color:#75715e>#cookie中某个字段值，name为任意请求报文首部字部cookie的key</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$http_&lt;name&gt; <span style=color:#75715e>#name为任意请求报文首部字段,表示记录请求报文的首部字段，name的对应的首部字段名需要为小写，如果有横线需要替换为下划线。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#示例: </span>
</span></span><span style=display:flex><span>echo $http_user_agent; 
</span></span><span style=display:flex><span>echo $http_host;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$sent_http_&lt;name&gt; <span style=color:#75715e>#name为响应报文的首部字段，name的对应的首部字段名需要为小写，如果有横线需要替换为下划线,此变量有问题 </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#示例：</span>
</span></span><span style=display:flex><span>echo $sent_http_server;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$arg_&lt;name&gt; <span style=color:#75715e>#此变量存放了URL中的指定参数，name为请求url中指定的参数名</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#示例</span>
</span></span><span style=display:flex><span>echo $arg_id;
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>##站点配置</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf.d/pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen <span style=color:#ae81ff>80</span> default_server;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  location /main <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   	index index.html;
</span></span><span style=display:flex><span>	default_type text/html;
</span></span><span style=display:flex><span>	echo $remote_addr;
</span></span><span style=display:flex><span>	echo $args;
</span></span><span style=display:flex><span>	echo $document_root;
</span></span><span style=display:flex><span>	echo $document_uri;
</span></span><span style=display:flex><span>	echo $host;
</span></span><span style=display:flex><span>	echo $http_user_agent;
</span></span><span style=display:flex><span>	echo $http_cookie;
</span></span><span style=display:flex><span>	echo $request_filename;
</span></span><span style=display:flex><span>	echo $scheme;
</span></span><span style=display:flex><span>	echo $scheme:/$host$document_uri?$args; 
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##返回结果</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># curl -b title=test &#39;http:/pc.test.org/main/index.do?id=2022&amp;partner=search&#39;</span>
</span></span><span style=display:flex><span>172.16.16.88
</span></span><span style=display:flex><span>id<span style=color:#f92672>=</span>2022&amp;partner<span style=color:#f92672>=</span>search
</span></span><span style=display:flex><span>/apps/nginx/html
</span></span><span style=display:flex><span>/main/index.do
</span></span><span style=display:flex><span>pc.test.org
</span></span><span style=display:flex><span>curl/7.29.0
</span></span><span style=display:flex><span>title<span style=color:#f92672>=</span>test
</span></span><span style=display:flex><span>/apps/nginx/html/main/index.do
</span></span><span style=display:flex><span>http
</span></span><span style=display:flex><span>http:/pc.test.org/main/index.do?id<span style=color:#f92672>=</span>2022&amp;partner<span style=color:#f92672>=</span>search
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>##站点配置</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf.d/www.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  server_name www.test.com;
</span></span><span style=display:flex><span>  location /echo <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	echo $request;
</span></span><span style=display:flex><span>	echo $proxy_add_x_forwarded_for;
</span></span><span style=display:flex><span>	echo $args;
</span></span><span style=display:flex><span>	echo $document_uri;
</span></span><span style=display:flex><span>	echo $request_uri;
</span></span><span style=display:flex><span>	echo $document_root;
</span></span><span style=display:flex><span>	echo $host;
</span></span><span style=display:flex><span>	echo $request_method;
</span></span><span style=display:flex><span>	echo $request_filename;
</span></span><span style=display:flex><span>	echo $scheme;
</span></span><span style=display:flex><span>	set  $test $http_host;   <span style=color:#75715e>#自定义变量，将$http_host的值赋给test变量</span>
</span></span><span style=display:flex><span>	echo $test;
</span></span><span style=display:flex><span>	echo $http_User_Agent;
</span></span><span style=display:flex><span>	echo $http_cookie;
</span></span><span style=display:flex><span>	echo $cookie_key1;
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##访问测试</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># curl -b &#39;key1=v1;key2=v2&#39; &#34;http:/www.test.com/echo/index.html?id=666&amp;partner=search&#34; </span>
</span></span><span style=display:flex><span>GET /echo/index.html?id<span style=color:#f92672>=</span>666&amp;partner<span style=color:#f92672>=</span>search HTTP/1.1
</span></span><span style=display:flex><span>172.16.16.88
</span></span><span style=display:flex><span>id<span style=color:#f92672>=</span>666&amp;partner<span style=color:#f92672>=</span>search
</span></span><span style=display:flex><span>/echo/index.html
</span></span><span style=display:flex><span>/echo/index.html?id<span style=color:#f92672>=</span>666&amp;partner<span style=color:#f92672>=</span>search
</span></span><span style=display:flex><span>/apps/nginx/html
</span></span><span style=display:flex><span>www.test.com
</span></span><span style=display:flex><span>GET
</span></span><span style=display:flex><span>/apps/nginx/html/echo/index.html
</span></span><span style=display:flex><span>http
</span></span><span style=display:flex><span>www.test.com
</span></span><span style=display:flex><span>curl/7.29.0
</span></span><span style=display:flex><span>key1<span style=color:#f92672>=</span>v1;key2<span style=color:#f92672>=</span>v2
</span></span><span style=display:flex><span>v1
</span></span></code></pre></div><h2 id=自定义变量>自定义变量<a hidden class=anchor aria-hidden=true href=#自定义变量>#</a></h2><p>语法格式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Syntax: set $variable value;
</span></span><span style=display:flex><span>Default: —
</span></span><span style=display:flex><span>Context: server, location, <span style=color:#66d9ef>if</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>##站点配置</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf.d/www.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  server_name www.test.com;
</span></span><span style=display:flex><span>  location /echo <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	set $name test;
</span></span><span style=display:flex><span>	echo $name;
</span></span><span style=display:flex><span>	set $my_port $server_port;
</span></span><span style=display:flex><span>	echo $my_port;
</span></span><span style=display:flex><span>	echo <span style=color:#e6db74>&#34;server_name:</span>$server_port<span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##访问测试</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># curl www.test.com/echo</span>
</span></span><span style=display:flex><span>GET /echo HTTP/1.1
</span></span><span style=display:flex><span>172.16.16.88
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/echo
</span></span><span style=display:flex><span>/echo
</span></span><span style=display:flex><span>/apps/nginx/html
</span></span><span style=display:flex><span>www.test.com
</span></span><span style=display:flex><span>GET
</span></span><span style=display:flex><span>/apps/nginx/html/echo
</span></span><span style=display:flex><span>http
</span></span><span style=display:flex><span>www.test.com
</span></span><span style=display:flex><span>curl/7.29.0
</span></span></code></pre></div><h1 id=nginx-自定义访问日志>Nginx 自定义访问日志<a hidden class=anchor aria-hidden=true href=#nginx-自定义访问日志>#</a></h1><p>访问日志是记录客户端即用户的具体请求内容信息，而在全局配置模块中的error_log是记录nginx服务器运行时的日志保存路径和日志的level，两者是不同的，而且Nginx的错误日志一般只有一个，但是访问日志可以在不同的server中定义多个。定义访问日志使用access_log指令指定日志保存路径，使用log_format指定日志的格式，格式中定义要保存的具体的日志内容。</p><p>访问日志由 ngx_http_log_module 模块实现</p><p>官方帮助文档：http:/nginx.org/en/docs/http/ngx_http_log_module.html</p><p>语法格式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tex data-lang=tex><span style=display:flex><span>Syntax: access_log path [format [buffer=size] [gzip[=level]] [flush=time] 
</span></span><span style=display:flex><span>[if=condition]];
</span></span><span style=display:flex><span>access_log off;
</span></span><span style=display:flex><span>Default: 
</span></span><span style=display:flex><span>access_log logs/access.log combined;
</span></span><span style=display:flex><span>Context: http, server, location, if in location, limit_except
</span></span></code></pre></div><h2 id=自定义日志默认格式>自定义日志默认格式<a hidden class=anchor aria-hidden=true href=#自定义日志默认格式>#</a></h2><p>如果要保留日志的源格式，只需添加相应的日志内容，配置如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>http <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    log_format my_nginx_format
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;$status $body_bytes_sent &#34;$http_referer&#34;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;$server_name:$server_port&#39;</span>;
</span></span><span style=display:flex><span>    access_log logs/access.log my_nginx_format;
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#注意：此指令一定要放在log_format命令后（nginx配置从上至下依次生效）</span>
</span></span><span style=display:flex><span>access_log logs/access.log my_nginx_format;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##重启nginx访问测试</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 nginx<span style=color:#f92672>]</span><span style=color:#75715e># tail -3 logs/access.log </span>
</span></span><span style=display:flex><span>172.16.16.88 - - <span style=color:#f92672>[</span>02/Aug/2022:23:51:26 +0800<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET /echo HTTP/1.1&#34;</span> <span style=color:#ae81ff>200</span> <span style=color:#ae81ff>211</span> <span style=color:#e6db74>&#34;-&#34;</span> <span style=color:#e6db74>&#34;curl/7.29.0&#34;</span>  <span style=color:#75715e>#默认日志格式</span>
</span></span><span style=display:flex><span>172.16.16.88 - - <span style=color:#f92672>[</span>04/Aug/2022:19:08:42 +0800<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET / HTTP/1.1&#34;</span><span style=color:#ae81ff>200</span> <span style=color:#ae81ff>6</span> <span style=color:#e6db74>&#34;-&#34;&#34;curl/7.29.0&#34;</span> <span style=color:#e6db74>&#34;-&#34;</span>pc.test.org:80  <span style=color:#75715e>#自定义日志格式my_nginx_format</span>
</span></span></code></pre></div><h2 id=自定义json格式日志>自定义json格式日志<a hidden class=anchor aria-hidden=true href=#自定义json格式日志>#</a></h2><p>nginx的默认日志格式记录的内容相对单一，且默认的格式也不方便后期做日志统计分析，生产环境中通常将nginx日志格式为json格式，然后配合ELK做日志收集、统计和分析。</p><p>配置示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>http <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    log_format json_log
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;{&#34;@timestamp&#34;:&#34;$time_iso8601&#34;,&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#34;clientip&#34;:&#34;$remote_addr&#34;,&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#34;size&#34;:$body_bytes_sent,&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#34;responsetime&#34;:$request_time,&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#34;upstreamtime&#34;:&#34;$upstream_response_time&#34;,&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#34;upstreamhost&#34;:&#34;$upstream_addr&#34;,&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#34;http_host&#34;:&#34;$host&#34;,&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#34;uri&#34;:&#34;$uri&#34;,&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#34;xff&#34;:&#34;$http_x_forwarded_for&#34;,&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#34;referer&#34;:&#34;$http_referer&#34;,&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#34;tcp_xff&#34;:&#34;$proxy_protocol_addr&#34;,&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#34;http_user_agent&#34;:&#34;$http_user_agent&#34;,&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;&#34;status&#34;:&#34;$status&#34;}&#39;</span>;
</span></span><span style=display:flex><span>    access_log logs/access.log json_log;
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##重启nginx，查看生成的日志格式</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 nginx<span style=color:#f92672>]</span><span style=color:#75715e># tail -1 logs/access.log </span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;@timestamp&#34;</span>:<span style=color:#e6db74>&#34;2022-08-04T19:27:18+08:00&#34;</span>,<span style=color:#e6db74>&#34;clientip&#34;</span>:<span style=color:#e6db74>&#34;127.0.0.1&#34;</span>,<span style=color:#e6db74>&#34;size&#34;</span>:6,<span style=color:#e6db74>&#34;responsetime&#34;</span>:0.000,<span style=color:#e6db74>&#34;upstreamtime&#34;</span>:<span style=color:#e6db74>&#34;-&#34;</span>,<span style=color:#e6db74>&#34;upstreamhost&#34;</span>:<span style=color:#e6db74>&#34;-&#34;</span>,<span style=color:#e6db74>&#34;http_host&#34;</span>:<span style=color:#e6db74>&#34;localhost&#34;</span>,<span style=color:#e6db74>&#34;uri&#34;</span>:<span style=color:#e6db74>&#34;/index.html&#34;</span>,<span style=color:#e6db74>&#34;xff&#34;</span>:<span style=color:#e6db74>&#34;-&#34;</span>,<span style=color:#e6db74>&#34;referer&#34;</span>:<span style=color:#e6db74>&#34;-&#34;</span>,<span style=color:#e6db74>&#34;tcp_xff&#34;</span>:<span style=color:#e6db74>&#34;-&#34;</span>,<span style=color:#e6db74>&#34;http_user_agent&#34;</span>:<span style=color:#e6db74>&#34;curl/7.29.0&#34;</span>,<span style=color:#e6db74>&#34;status&#34;</span>:<span style=color:#e6db74>&#34;200&#34;</span>
</span></span></code></pre></div><h1 id=nginx-压缩功能>Nginx 压缩功能<a hidden class=anchor aria-hidden=true href=#nginx-压缩功能>#</a></h1><p>Nginx支持对指定类型的文件进行压缩然后再传输给客户端，而且压缩还可以设置压缩比例，压缩后的</p><p>文件大小将比源文件显著变小，这样有助于降低出口带宽的利用率，降低企业的IT支出，不过会占用相</p><p>应的CPU资源。</p><p>Nginx对文件的压缩功能是依赖于模块 ngx_http_gzip_module,默认是内置模块</p><p>官方文档：https:/nginx.org/en/docs/http/ngx_http_gzip_module.html</p><p>格式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Syntax:	gzip on | off;
</span></span><span style=display:flex><span>Default:	
</span></span><span style=display:flex><span>gzip off;
</span></span><span style=display:flex><span>Context:	http, server, location, if in location
</span></span></code></pre></div><p>相关指令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#启用或禁用gzip压缩，默认关闭</span>
</span></span><span style=display:flex><span>gzip on | off; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#压缩比由低到高从1到9，默认为1</span>
</span></span><span style=display:flex><span>gzip_comp_level level;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#禁用IE6 gzip功能</span>
</span></span><span style=display:flex><span>gzip_disable <span style=color:#e6db74>&#34;MSIE [1-6]\.&#34;</span>; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#gzip压缩的最小文件，小于设置值的文件将不会压缩</span>
</span></span><span style=display:flex><span>gzip_min_length 1k; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#启用压缩功能时，协议的最小版本，默认HTTP/1.1</span>
</span></span><span style=display:flex><span>gzip_http_version 1.0 | 1.1; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#指定Nginx服务需要向服务器申请的缓存空间的个数和大小,平台不同,默认:32 4k或者16 8k;</span>
</span></span><span style=display:flex><span>gzip_buffers number size;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#指明仅对哪些类型的资源执行压缩操作;默认为gzip_types text/html，不用显示指定，否则出错</span>
</span></span><span style=display:flex><span>gzip_types mime-type ...; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#如果启用压缩，是否在响应报文首部插入“Vary: Accept-Encoding”,一般建议打开</span>
</span></span><span style=display:flex><span>gzip_vary on | off; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#预压缩，即直接从磁盘找到对应文件的gz后缀的式的压缩文件返回给用户，无需消耗服务器CPU</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#注意: 来自于ngx_http_gzip_static_module模块</span>
</span></span><span style=display:flex><span>gzip_static on | off;
</span></span></code></pre></div><p>示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>##分别生成5Bytes 大小的index.html文件以及2k大小的2k.text</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># echo test &gt; /apps/nginx/html/pc/index.html</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># dd if=/dev/zero of=/apps/nginx/html/pc/2k.text bs=2k count=1</span>
</span></span><span style=display:flex><span>1+0 records in
</span></span><span style=display:flex><span>1+0 records out
</span></span><span style=display:flex><span><span style=color:#ae81ff>2048</span> bytes <span style=color:#f92672>(</span>2.0 kB<span style=color:#f92672>)</span> copied, 0.000405459 s, 5.1 MB/s
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># ll /apps/nginx/html/pc/2k.text -h</span>
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root 2.0K Aug  <span style=color:#ae81ff>4</span> 20:01 /apps/nginx/html/pc/2k.text
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># ll /apps/nginx/html/pc/index.html -h</span>
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> nginx nginx <span style=color:#ae81ff>5</span> Aug  <span style=color:#ae81ff>4</span> 19:43 /apps/nginx/html/pc/index.html
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#准备站点配置</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf.d/pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen <span style=color:#ae81ff>80</span> default_server;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  gzip on;
</span></span><span style=display:flex><span>  gzip_comp_level 5;
</span></span><span style=display:flex><span>  gzip_min_length 1k;   <span style=color:#75715e>#小于1k的文件不压缩</span>
</span></span><span style=display:flex><span>  gzip_types text/plain application/javascript application/x-javascript text/css 
</span></span><span style=display:flex><span>  application/xml text/javascript application/x-httpd-php image/gif image/png;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  gzip_vary on;
</span></span><span style=display:flex><span>  location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   	index index.html;
</span></span><span style=display:flex><span>	default_type text/html;
</span></span><span style=display:flex><span>	root html/pc;
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># nginx -s reload</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># curl -I --compressed pc.test.org/index.html</span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>Server: nginx/1.18.0
</span></span><span style=display:flex><span>Date: Thu, <span style=color:#ae81ff>04</span> Aug <span style=color:#ae81ff>2022</span> 12:02:22 GMT
</span></span><span style=display:flex><span>Content-Type: text/html
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>5</span>        <span style=color:#75715e>#index.html文件未压缩，仍是5Bytes</span>
</span></span><span style=display:flex><span>Last-Modified: Thu, <span style=color:#ae81ff>04</span> Aug <span style=color:#ae81ff>2022</span> 11:43:47 GMT
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span><span style=display:flex><span>Keep-Alive: timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>ETag: <span style=color:#e6db74>&#34;62ebb0f3-5&#34;</span>
</span></span><span style=display:flex><span>Accept-Ranges: bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># curl -I --compressed pc.test.org/2k.txt</span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>404</span> Not Found
</span></span><span style=display:flex><span>Server: nginx/1.18.0
</span></span><span style=display:flex><span>Date: Thu, <span style=color:#ae81ff>04</span> Aug <span style=color:#ae81ff>2022</span> 12:02:34 GMT
</span></span><span style=display:flex><span>Content-Type: text/html
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>153</span>   <span style=color:#75715e>#2k.txt被压缩为153Bytes</span>
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span><span style=display:flex><span>Keep-Alive: timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>
</span></span></code></pre></div><h1 id=nginx-配置https>Nginx 配置https<a hidden class=anchor aria-hidden=true href=#nginx-配置https>#</a></h1><h2 id=https-相关参数>https 相关参数<a hidden class=anchor aria-hidden=true href=#https-相关参数>#</a></h2><p>nginx 的https 功能基于模块ngx_http_ssl_module实现，作为nginx的核心功能，yum安装的nginx默认就是开启的，编译安装的nginx需要指定编译参数&ndash;with-http_ssl_module开启。</p><p>官方文档：https:/nginx.org/en/docs/http/ngx_http_ssl_module.html</p><p>相关指令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#为指定的虚拟主机配置是否启用ssl功能，此功能在1.15.0废弃，使用listen [ssl]替代</span>
</span></span><span style=display:flex><span>ssl on | off;   
</span></span><span style=display:flex><span>listen <span style=color:#ae81ff>443</span> ssl;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#指向包含当前虚拟主机和CA的两个证书信息的文件，一般是crt文件</span>
</span></span><span style=display:flex><span>ssl_certificate /path/to/file;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#当前虚拟主机使用的私钥文件，一般是key文件</span>
</span></span><span style=display:flex><span>ssl_certificate_key /path/to/file;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#支持ssl协议版本，早期为ssl现在是TLS，默认为后三个 </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#配置ssl缓存</span>
</span></span><span style=display:flex><span>ssl_session_cache off | none | <span style=color:#f92672>[</span>builtin<span style=color:#f92672>[</span>:size<span style=color:#f92672>]]</span> <span style=color:#f92672>[</span>shared:name:size<span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>   	off： <span style=color:#75715e>#关闭缓存</span>
</span></span><span style=display:flex><span> 	none:  <span style=color:#75715e>#通知客户端支持ssl session cache，但实际不支持</span>
</span></span><span style=display:flex><span> 	builtin<span style=color:#f92672>[</span>:size<span style=color:#f92672>]</span>：#使用OpenSSL内建缓存，为每worker进程私有
</span></span><span style=display:flex><span> 	<span style=color:#f92672>[</span>shared:name:size<span style=color:#f92672>]</span>：#在各worker之间使用一个共享的缓存，需要定义一个缓存名称和缓存空间大小，一兆可以存储4000个会话信息，多个虚拟主机可以使用相同的缓存名称
</span></span><span style=display:flex><span> 	
</span></span><span style=display:flex><span><span style=color:#75715e>#客户端连接可以复用ssl session cache中缓存的有效时长，默认5m</span>
</span></span><span style=display:flex><span>ssl_session_timeout time; 
</span></span></code></pre></div><h2 id=自签名证书>自签名证书<a hidden class=anchor aria-hidden=true href=#自签名证书>#</a></h2><p>生成自签名证书</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>##进入nginx安装目录，新建存放证书的目录</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># cd /apps/nginx/</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 nginx<span style=color:#f92672>]</span><span style=color:#75715e># mkdir certs</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 nginx<span style=color:#f92672>]</span><span style=color:#75715e># cd certs/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##生成自签名CA证书ca.crt和私钥ca.key</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 certs<span style=color:#f92672>]</span><span style=color:#75715e># openssl req -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 3650 -out ca.crt</span>
</span></span><span style=display:flex><span>Generating a <span style=color:#ae81ff>4096</span> bit RSA private key
</span></span><span style=display:flex><span>...........................................................................................++
</span></span><span style=display:flex><span>................................................................................................................................................................................++
</span></span><span style=display:flex><span>writing new private key to <span style=color:#e6db74>&#39;ca.key&#39;</span>
</span></span><span style=display:flex><span>-----
</span></span><span style=display:flex><span>You are about to be asked to enter information that will be incorporated
</span></span><span style=display:flex><span>into your certificate request.
</span></span><span style=display:flex><span>What you are about to enter is what is called a Distinguished Name or a DN.
</span></span><span style=display:flex><span>There are quite a few fields but you can leave some blank
</span></span><span style=display:flex><span>For some fields there will be a default value,
</span></span><span style=display:flex><span>If you enter <span style=color:#e6db74>&#39;.&#39;</span>, the field will be left blank.
</span></span><span style=display:flex><span>-----
</span></span><span style=display:flex><span>Country Name <span style=color:#f92672>(</span><span style=color:#ae81ff>2</span> letter code<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>XX<span style=color:#f92672>]</span>:cn
</span></span><span style=display:flex><span>State or Province Name <span style=color:#f92672>(</span>full name<span style=color:#f92672>)</span> <span style=color:#f92672>[]</span>:sichuan
</span></span><span style=display:flex><span>Locality Name <span style=color:#f92672>(</span>eg, city<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>Default City<span style=color:#f92672>]</span>:chengdu
</span></span><span style=display:flex><span>Organization Name <span style=color:#f92672>(</span>eg, company<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>Default Company Ltd<span style=color:#f92672>]</span>:nginx
</span></span><span style=display:flex><span>Organizational Unit Name <span style=color:#f92672>(</span>eg, section<span style=color:#f92672>)</span> <span style=color:#f92672>[]</span>:nginx.com
</span></span><span style=display:flex><span>Common Name <span style=color:#f92672>(</span>eg, your name or your server<span style=color:#e6db74>&#39;s hostname) []:www.nginx.com
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Email Address []:22@qq.com
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[root@centos7 certs]# ls
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ca.crt  ca.key
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>##生成网站私钥www.nginx.com.key和证书请求www.nginx.com.csr
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[root@centos7 certs]# openssl req -newkey rsa:4096 -nodes -sha256 -keyout www.nginx.com.key -out www.nginx.com.csr  
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Generating a 4096 bit RSA private key
</span></span></span><span style=display:flex><span><span style=color:#e6db74>.......++
</span></span></span><span style=display:flex><span><span style=color:#e6db74>...................................................................................++
</span></span></span><span style=display:flex><span><span style=color:#e6db74>writing new private key to &#39;</span>www.nginx.com.key<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>-----
</span></span></span><span style=display:flex><span><span style=color:#e6db74>You are about to be asked to enter information that will be incorporated
</span></span></span><span style=display:flex><span><span style=color:#e6db74>into your certificate request.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>What you are about to enter is what is called a Distinguished Name or a DN.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>There are quite a few fields but you can leave some blank
</span></span></span><span style=display:flex><span><span style=color:#e6db74>For some fields there will be a default value,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>If you enter &#39;</span>.<span style=color:#e6db74>&#39;, the field will be left blank.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>-----
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Country Name (2 letter code) [XX]:cn       #国家
</span></span></span><span style=display:flex><span><span style=color:#e6db74>State or Province Name (full name) []:sichuan #省份
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Locality Name (eg, city) [Default City]:chengdu #城市
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Organization Name (eg, company) [Default Company Ltd]:nginx #公司
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Organizational Unit Name (eg, section) []:nginx.com #部门
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Common Name (eg, your name or your server&#39;</span>s hostname<span style=color:#f92672>)</span> <span style=color:#f92672>[]</span>:www.nginx.com <span style=color:#75715e>#通用名</span>
</span></span><span style=display:flex><span>Email Address <span style=color:#f92672>[]</span>:511670559@qq.com  <span style=color:#75715e>#邮箱</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Please enter the following <span style=color:#e6db74>&#39;extra&#39;</span> attributes
</span></span><span style=display:flex><span>to be sent with your certificate request
</span></span><span style=display:flex><span>A challenge password <span style=color:#f92672>[]</span>:  
</span></span><span style=display:flex><span>An optional company name <span style=color:#f92672>[]</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 certs<span style=color:#f92672>]</span><span style=color:#75715e># ls www*</span>
</span></span><span style=display:flex><span>www.nginx.com.csr  www.nginx.com.key  www.nginx.crt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##使用ca签发网站的证书www.nginx.crt</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 certs<span style=color:#f92672>]</span><span style=color:#75715e># openssl x509 -req -days 3650 -in www.nginx.com.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out www.nginx.com.crt</span>
</span></span><span style=display:flex><span>Signature ok
</span></span><span style=display:flex><span>subject<span style=color:#f92672>=</span>/C<span style=color:#f92672>=</span>cn/ST<span style=color:#f92672>=</span>sichuan/L<span style=color:#f92672>=</span>chengdu/O<span style=color:#f92672>=</span>nginx/OU<span style=color:#f92672>=</span>nginx.com/CN<span style=color:#f92672>=</span>www.nginx.com/emailAddress<span style=color:#f92672>=</span>511670559@qq.com
</span></span><span style=display:flex><span>Getting CA Private Key
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 certs<span style=color:#f92672>]</span><span style=color:#75715e># ls</span>
</span></span><span style=display:flex><span>ca.crt  ca.key  ca.srl  www.nginx.com.crt  www.nginx.com.csr  www.nginx.com.key
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##查看证书内容</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 certs<span style=color:#f92672>]</span><span style=color:#75715e># openssl x509 -in www.nginx.com.crt -noout -text</span>
</span></span><span style=display:flex><span>Certificate:
</span></span><span style=display:flex><span>    Data:
</span></span><span style=display:flex><span>        Version: <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>0x0<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        Serial Number:
</span></span><span style=display:flex><span>            f5:49:30:f5:10:2f:4b:ea
</span></span><span style=display:flex><span>    Signature Algorithm: sha256WithRSAEncryption
</span></span><span style=display:flex><span>        Issuer: C<span style=color:#f92672>=</span>cn, ST<span style=color:#f92672>=</span>sichuan, L<span style=color:#f92672>=</span>chengdu, O<span style=color:#f92672>=</span>nginx, OU<span style=color:#f92672>=</span>nginx.com, CN<span style=color:#f92672>=</span>www.nginx.com/emailAddress<span style=color:#f92672>=</span>22@qq.com
</span></span><span style=display:flex><span>        Validity
</span></span><span style=display:flex><span>            Not Before: Aug  <span style=color:#ae81ff>4</span> 14:48:57 <span style=color:#ae81ff>2022</span> GMT
</span></span><span style=display:flex><span>            Not After : Aug  <span style=color:#ae81ff>1</span> 14:48:57 <span style=color:#ae81ff>2032</span> GMT
</span></span><span style=display:flex><span>        Subject: C<span style=color:#f92672>=</span>cn, ST<span style=color:#f92672>=</span>sichuan, L<span style=color:#f92672>=</span>chengdu, O<span style=color:#f92672>=</span>nginx, OU<span style=color:#f92672>=</span>nginx.com, CN<span style=color:#f92672>=</span>www.nginx.com/emailAddress<span style=color:#f92672>=</span>511670559@qq.com
</span></span><span style=display:flex><span>        Subject Public Key Info:
</span></span><span style=display:flex><span>            Public Key Algorithm: rsaEncryption
</span></span><span style=display:flex><span>                Public-Key: <span style=color:#f92672>(</span><span style=color:#ae81ff>4096</span> bit<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## 将ca证书和网站证书输出到一个文件（注意前后次序）</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 certs<span style=color:#f92672>]</span><span style=color:#75715e># cat www.nginx.com.crt ca.crt &gt; www.nginx.com.pem</span>
</span></span></code></pre></div><h2 id=https-配置>https 配置<a hidden class=anchor aria-hidden=true href=#https-配置>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>##准备站点配置文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 certs<span style=color:#f92672>]</span><span style=color:#75715e># cat /apps/nginx/conf.d/pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  listen <span style=color:#ae81ff>443</span> ssl;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   	index index.html;
</span></span><span style=display:flex><span>	default_type text/html;
</span></span><span style=display:flex><span>	root html/pc;
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  ssl_certificate /apps/nginx/certs/www.nginx.com.pem;
</span></span><span style=display:flex><span>  ssl_certificate_key /apps/nginx/certs/www.nginx.com.key;
</span></span><span style=display:flex><span>  ssl_session_cache shared:sslcache:20m;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##重启nginx</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 certs<span style=color:#f92672>]</span><span style=color:#75715e># nginx -t</span>
</span></span><span style=display:flex><span>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok
</span></span><span style=display:flex><span>nginx: configuration file /apps/nginx/conf/nginx.conf test is successful
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 certs<span style=color:#f92672>]</span><span style=color:#75715e># nginx -s reload</span>
</span></span></code></pre></div><p>浏览器访问测试，由于是自签名证书，浏览器并不信任</p><p><img loading=lazy src=/images/Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220804150608344.png alt=image-20220804150608344></p><p><img loading=lazy src=/images/Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220804150708178.png alt></p><p><img loading=lazy src=/images/Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220804150819669.png alt=image-20220804150819669></p><h2 id=实现多域名-https>实现多域名 https<a hidden class=anchor aria-hidden=true href=#实现多域名-https>#</a></h2><p>Nginx 支持基于单个IP实现多域名的功能，并且还支持单IP多域名的基础之上实现HTTPS，其实是基于Nginx的 SNI（Server Name Indication）功能实现，SNI是为了解决一个Nginx服务器内使用一个IP绑定多个域名和证书的功能。其实现流程是客户端在连接到服务器建立SSL链接之前先发送要访问站点的域名（Hostname），这样服务器再根据这个域名返回给客户端一个合适的证书。</p><p>简单来说，SNI实现了为多个虚拟主机配置各自的https认证功能，配置方式和上一节内容类似，这里不做演示。</p><p>查看nginx支持SNI功能：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 nginx<span style=color:#f92672>]</span><span style=color:#75715e># nginx -V</span>
</span></span><span style=display:flex><span>nginx version: nginx/1.18.0
</span></span><span style=display:flex><span>built by gcc 4.8.5 <span style=color:#ae81ff>20150623</span> <span style=color:#f92672>(</span>Red Hat 4.8.5-44<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>GCC<span style=color:#f92672>)</span> 
</span></span><span style=display:flex><span>built with OpenSSL 1.0.2k-fips  <span style=color:#ae81ff>26</span> Jan <span style=color:#ae81ff>2017</span>
</span></span><span style=display:flex><span>TLS SNI support enabled  		<span style=color:#75715e>#支持SNI功能</span>
</span></span><span style=display:flex><span>configure arguments: --prefix<span style=color:#f92672>=</span>/apps/nginx --user<span style=color:#f92672>=</span>nginx --group<span style=color:#f92672>=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module<span style=color:#f92672>=</span>/usr/local/src/echo-nginx-module
</span></span></code></pre></div><h2 id=实现-hsts>实现 HSTS<a hidden class=anchor aria-hidden=true href=#实现-hsts>#</a></h2><p>官方文档：https:/www.nginx.com/blog/http-strict-transport-security-hsts-and-nginx/</p><p><strong>未配置http跳转的情况时：</strong></p><p>实例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 站点配置</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 conf.d<span style=color:#f92672>]</span><span style=color:#75715e># cat pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  listen <span style=color:#ae81ff>443</span> ssl;
</span></span><span style=display:flex><span>  ssl_certificate /apps/nginx/certs/www.nginx.com.pem;
</span></span><span style=display:flex><span>  ssl_certificate_key /apps/nginx/certs/www.nginx.com.key;
</span></span><span style=display:flex><span>  ssl_session_cache shared:sslcache:20m;
</span></span><span style=display:flex><span>  ssl_session_timeout 10m;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   	index index.html;
</span></span><span style=display:flex><span>	default_type text/html;
</span></span><span style=display:flex><span>	root html/;
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#http访问成功</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 conf.d<span style=color:#f92672>]</span><span style=color:#75715e># curl www.test.org</span>
</span></span><span style=display:flex><span>default
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#https请求报错</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 conf.d<span style=color:#f92672>]</span><span style=color:#75715e># curl www.test.org:443</span>
</span></span><span style=display:flex><span>&lt;html&gt;
</span></span><span style=display:flex><span>&lt;head&gt;&lt;title&gt;400 The plain HTTP request was sent to HTTPS port&lt;/title&gt;&lt;/head&gt;
</span></span><span style=display:flex><span>&lt;body&gt;
</span></span><span style=display:flex><span>&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;
</span></span><span style=display:flex><span>&lt;center&gt;The plain HTTP request was sent to HTTPS port&lt;/center&gt;
</span></span><span style=display:flex><span>&lt;hr&gt;&lt;center&gt;nginx/1.18.0&lt;/center&gt;
</span></span><span style=display:flex><span>&lt;/body&gt;
</span></span><span style=display:flex><span>&lt;/html&gt;
</span></span></code></pre></div><p><strong>配置rewrite实现http跳转https后：</strong></p><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>##站点配置</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 conf.d<span style=color:#f92672>]</span><span style=color:#75715e># cat pc.conf </span>
</span></span><span style=display:flex><span>server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  listen 80;
</span></span><span style=display:flex><span>  listen <span style=color:#ae81ff>443</span> ssl;
</span></span><span style=display:flex><span>  ssl_certificate /apps/nginx/certs/www.nginx.com.pem;
</span></span><span style=display:flex><span>  ssl_certificate_key /apps/nginx/certs/www.nginx.com.key;
</span></span><span style=display:flex><span>  ssl_session_cache shared:sslcache:20m;
</span></span><span style=display:flex><span>  ssl_session_timeout 10m;
</span></span><span style=display:flex><span>  server_name pc.test.org;
</span></span><span style=display:flex><span>  add_header Strict-Transport-Security <span style=color:#e6db74>&#34;max-age=31536000; includeSubDomains&#34;</span>
</span></span><span style=display:flex><span>always; <span style=color:#75715e>#开启客户端缓存功能，当发起http请求时优先访问缓存，直接进行本地http跳转</span>
</span></span><span style=display:flex><span>  location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   	index index.html;
</span></span><span style=display:flex><span>	default_type text/html;
</span></span><span style=display:flex><span>	root html/;
</span></span><span style=display:flex><span>	     
</span></span><span style=display:flex><span>	    <span style=color:#75715e>#配置http跳转https</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span> $scheme <span style=color:#f92672>=</span> http <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>   
</span></span><span style=display:flex><span>            rewrite ^/<span style=color:#f92672>(</span>.*<span style=color:#f92672>)</span>$ https:/www.test.org/$1 redirect;
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#发起http请求，返回响应码为302</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 conf.d<span style=color:#f92672>]</span><span style=color:#75715e># curl pc.test.org</span>
</span></span><span style=display:flex><span>&lt;html&gt;
</span></span><span style=display:flex><span>&lt;head&gt;&lt;title&gt;302 Found&lt;/title&gt;&lt;/head&gt;
</span></span><span style=display:flex><span>&lt;body&gt;
</span></span><span style=display:flex><span>&lt;center&gt;&lt;h1&gt;302 Found&lt;/h1&gt;&lt;/center&gt;
</span></span><span style=display:flex><span>&lt;hr&gt;&lt;center&gt;nginx/1.18.0&lt;/center&gt;
</span></span><span style=display:flex><span>&lt;/body&gt;
</span></span><span style=display:flex><span>&lt;/html&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 conf.d<span style=color:#f92672>]</span><span style=color:#75715e># curl pc.test.org -L  #跟踪302重定向后又报证书校验错误</span>
</span></span><span style=display:flex><span>curl: <span style=color:#f92672>(</span>60<span style=color:#f92672>)</span> Peer<span style=color:#e6db74>&#39;s certificate issuer has been marked as not trusted by the user.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>More details here: http:/curl.haxx.se/docs/sslcerts.html
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>curl performs SSL certificate verification by default, using a &#34;bundle&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74> of Certificate Authority (CA) public keys (CA certs). If the default
</span></span></span><span style=display:flex><span><span style=color:#e6db74> bundle file isn&#39;</span>t adequate, you can specify an alternate file
</span></span><span style=display:flex><span> using the --cacert option.
</span></span><span style=display:flex><span>If this HTTPS server uses a certificate signed by a CA represented in
</span></span><span style=display:flex><span> the bundle, the certificate verification probably failed due to a
</span></span><span style=display:flex><span> problem with the certificate <span style=color:#f92672>(</span>it might be expired, or the name might
</span></span><span style=display:flex><span> not match the domain name in the URL<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>If you<span style=color:#e6db74>&#39;d like to turn off curl&#39;</span>s verification of the certificate, use
</span></span><span style=display:flex><span> the -k <span style=color:#f92672>(</span>or --insecure<span style=color:#f92672>)</span> option.
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e># 发起http请求，自动跳转https成功</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 conf.d<span style=color:#f92672>]</span><span style=color:#75715e># curl pc.test.org -kL  #跟随重定向并忽略证书安全性检查，请求成功</span>
</span></span><span style=display:flex><span>default
</span></span></code></pre></div><h1 id=关于-faviconio>关于 favicon.io<a hidden class=anchor aria-hidden=true href=#关于-faviconio>#</a></h1><p>favicon.ico 文件是网站标签页的小图标，当客户端使用浏览器问页面时，浏览器会自己主动发起请求获取页面的favicon.ico文件，但是当浏览器请求的favicon.ico文件不存在时，服务器会记录404日志，而且浏览器也会显示404报错</p><p>图标位置：</p><p><img loading=lazy src=/images/Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220805095057467.png alt=image-20220805095057467></p><p>报错如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 nginx<span style=color:#f92672>]</span><span style=color:#75715e># tail -1 logs/error.log  # 日志中的报错</span>
</span></span><span style=display:flex><span>2022/08/05 17:47:54 <span style=color:#f92672>[</span>error<span style=color:#f92672>]</span> 2604#0: *200 open<span style=color:#f92672>()</span> <span style=color:#e6db74>&#34;/apps/nginx/html/favicon.ico&#34;</span> failed <span style=color:#f92672>(</span>2: No such file or directory<span style=color:#f92672>)</span>, client: 172.16.16.1, server: pc.test.org, request: <span style=color:#e6db74>&#34;GET /favicon.ico HTTP/1.1&#34;</span>, host: <span style=color:#e6db74>&#34;pc.test.org&#34;</span>, referrer: <span style=color:#e6db74>&#34;http:/pc.test.org/&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 nginx<span style=color:#f92672>]</span><span style=color:#75715e># ls /apps/nginx/html/favicon.ico # 文件确实不存在</span>
</span></span><span style=display:flex><span>ls: cannot access /apps/nginx/html/favicon.ico: No such file or directory
</span></span></code></pre></div><p>解决方案：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>#将自己的图标命令为favicon.ico放置于指定目录下
</span></span><span style=display:flex><span>[root@centos7 html]# wget https:/gitee.com/favicon.ico -P  /apps/nginx/html/
</span></span><span style=display:flex><span>[root@centos7 html]# ll /apps/nginx/html/favicon.ico 
</span></span><span style=display:flex><span>-rw-r--r-- 1 root root 41566 Jun 10 11:59 /apps/nginx/html/favicon.ico
</span></span></code></pre></div><p>访问测试（浏览器按快捷键 CTRL+F5 强制刷新）</p><p><img loading=lazy src=/images/Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/image-20220805100020035.png alt=image-20220805100020035></p><h1 id=openssl版本升级>OpenSSL版本升级<a hidden class=anchor aria-hidden=true href=#openssl版本升级>#</a></h1><p>OpenSSL程序库当前广泛用于实现互联网的传输层安全（TLS）协议。心脏出血（Heartbleed），也简</p><p>称为心血漏洞，是一个出现在加密程序库OpenSSL的安全漏洞，此漏洞于2012年被引入了软件中，</p><p>2014年4月首次向公众披露。只要使用的是存在缺陷的OpenSSL实例，无论是服务器还是客户端，都可</p><p>能因此而受到攻击。此问题的原因是在实现TLS的心跳扩展时没有对输入进行适当验证（缺少边界检</p><p>查），因此漏洞的名称来源于“心跳”（heartbeat）。该程序错误属于缓冲区过读，即可以读取的数据比应该允许读取的还多。</p><p>范例：升级OpenSSL解决安全漏洞</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># nginx -V</span>
</span></span><span style=display:flex><span>nginx version: nginx/1.18.0
</span></span><span style=display:flex><span>built by gcc 4.8.5 <span style=color:#ae81ff>20150623</span> <span style=color:#f92672>(</span>Red Hat 4.8.5-44<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>GCC<span style=color:#f92672>)</span> 
</span></span><span style=display:flex><span>built with OpenSSL 1.0.2k-fips  <span style=color:#ae81ff>26</span> Jan <span style=color:#ae81ff>2017</span>  <span style=color:#75715e>#当前OpenSSL版本</span>
</span></span><span style=display:flex><span>TLS SNI support enabled
</span></span><span style=display:flex><span>configure arguments: --prefix<span style=color:#f92672>=</span>/apps/nginx --user<span style=color:#f92672>=</span>nginx --group<span style=color:#f92672>=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module<span style=color:#f92672>=</span>/usr/local/src/echo-nginx-module
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##下载较新版本OpenSSL源码包</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 ~<span style=color:#f92672>]</span><span style=color:#75715e># cd /usr/local/src/</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 src<span style=color:#f92672>]</span><span style=color:#75715e># wget https:/www.openssl.org/source/openssl-1.1.1h.tar.gz --no-check-certificate</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 src<span style=color:#f92672>]</span><span style=color:#75715e># tar xf openssl-1.1.1h.tar.gz</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>##编译安装OpenSSL</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 src<span style=color:#f92672>]</span><span style=color:#75715e># cd /usr/local/src/nginx-1.18.0/</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 nginx-1.18.0<span style=color:#f92672>]</span><span style=color:#75715e># ./configure --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module  --with-openssl=/usr/local/src/openssl-1.1.1h  #注意OpenSSL路径要添加正确</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 nginx-1.18.0<span style=color:#f92672>]</span><span style=color:#75715e># make &amp;&amp; make install</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#语法检查通过</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 nginx-1.18.0<span style=color:#f92672>]</span><span style=color:#75715e># nginx -t</span>
</span></span><span style=display:flex><span>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok
</span></span><span style=display:flex><span>nginx: configuration file /apps/nginx/conf/nginx.conf test is successful
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@centos7 nginx-1.18.0<span style=color:#f92672>]</span><span style=color:#75715e># nginx -V</span>
</span></span><span style=display:flex><span>nginx version: nginx/1.18.0
</span></span><span style=display:flex><span>built by gcc 4.8.5 <span style=color:#ae81ff>20150623</span> <span style=color:#f92672>(</span>Red Hat 4.8.5-44<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>GCC<span style=color:#f92672>)</span> 
</span></span><span style=display:flex><span>built with OpenSSL 1.1.1h  <span style=color:#ae81ff>22</span> Sep <span style=color:#ae81ff>2020</span>  <span style=color:#75715e>#版本升级成功</span>
</span></span><span style=display:flex><span>TLS SNI support enabled
</span></span><span style=display:flex><span>configure arguments: --prefix<span style=color:#f92672>=</span>/apps/nginx --user<span style=color:#f92672>=</span>nginx --group<span style=color:#f92672>=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module<span style=color:#f92672>=</span>/usr/local/src/echo-nginx-module --with-openssl<span style=color:#f92672>=</span>/usr/local/src/openssl-1.1.1h
</span></span></code></pre></div></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://senmer.github.io/img/wechat_pay.png alt=wechat_pay></a><p>微信</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://senmer.github.io/img/alipay.png alt=alipay></a><p>支付宝</p></div></div><button id=rewardButton onclick='var qr=document.getElementById("QR");qr.style.opacity==="0"?qr.style.opacity="1":qr.style.opacity="0"'>
<span>🧧 鼓励</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://senmer.github.io/zh/posts/tech/nginx/nginx%E5%AE%9E%E7%8E%B0rewrite%E5%8A%9F%E8%83%BD/><span class=title>« 上一页</span><br><span>Nginx实现rewrite功能</span>
</a><a class=next href=https://senmer.github.io/zh/posts/tech/nginx/nginx%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE/><span class=title>下一页 »</span><br><span>Nginx核心配置</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Nginx高级配置 on twitter" href="https://twitter.com/intent/tweet/?text=Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae&amp;url=https%3a%2f%2fsenmer.github.io%2fzh%2fposts%2ftech%2fnginx%2fnginx%25E9%25AB%2598%25E7%25BA%25A7%25E9%2585%258D%25E7%25BD%25AE%2f&amp;hashtags=nginx"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Nginx高级配置 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsenmer.github.io%2fzh%2fposts%2ftech%2fnginx%2fnginx%25E9%25AB%2598%25E7%25BA%25A7%25E9%2585%258D%25E7%25BD%25AE%2f&amp;title=Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae&amp;summary=Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae&amp;source=https%3a%2f%2fsenmer.github.io%2fzh%2fposts%2ftech%2fnginx%2fnginx%25E9%25AB%2598%25E7%25BA%25A7%25E9%2585%258D%25E7%25BD%25AE%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Nginx高级配置 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fsenmer.github.io%2fzh%2fposts%2ftech%2fnginx%2fnginx%25E9%25AB%2598%25E7%25BA%25A7%25E9%2585%258D%25E7%25BD%25AE%2f&title=Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Nginx高级配置 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsenmer.github.io%2fzh%2fposts%2ftech%2fnginx%2fnginx%25E9%25AB%2598%25E7%25BA%25A7%25E9%2585%258D%25E7%25BD%25AE%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Nginx高级配置 on whatsapp" href="https://api.whatsapp.com/send?text=Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae%20-%20https%3a%2f%2fsenmer.github.io%2fzh%2fposts%2ftech%2fnginx%2fnginx%25E9%25AB%2598%25E7%25BA%25A7%25E9%2585%258D%25E7%25BD%25AE%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Nginx高级配置 on telegram" href="https://telegram.me/share/url?text=Nginx%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae&amp;url=https%3a%2f%2fsenmer.github.io%2fzh%2fposts%2ftech%2fnginx%2fnginx%25E9%25AB%2598%25E7%25BA%25A7%25E9%2585%258D%25E7%25BD%25AE%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></div><style>.comments_details summary::marker{font-size:20px;content:'👉展开评论';color:var(--content)}.comments_details[open] summary::marker{font-size:20px;content:'👇关闭评论';color:var(--content)}</style><div><details class=comments_details open><summary style=display:none></summary><div id=tcomment></div></details><script src=https://cdn.staticfile.org/twikoo/1.6.16/twikoo.all.min.js></script><script>twikoo.init({envId:"https://hugo-api-khaki.vercel.app/# 填写自己的twikoo id",el:"#tcomment",lang:"zh-CN",region:null,path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><span>Copyright
&copy;
2020-2023
<a href=https://senmer.github.io/zh/ style=color:#939393>WZ's Blog</a>
All Rights Reserved
</span><a href=https://beian.miit.gov.cn/ target=_blank style=color:#939393></a>&nbsp;
<span><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null" style=display:inline-block;text-decoration:none;height:20px;color:#939393><img src style="float:left;margin:0 5px 0 0">
</a></span><span id=busuanzi_container><span class="fa fa-user"></span> <span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye"></span> <span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span>
</span></a><script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>200||document.documentElement.scrollTop>200?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{(function(){document.cookie="change-themes="+escape("false")})(),document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.body.addEventListener("copy",function(e){if(window.getSelection().toString()&&window.getSelection().toString().length>50){let t=e.clipboardData||window.clipboardData;if(t){e.preventDefault();let n=window.getSelection().toString(),s=window.getSelection().toString();t.setData("text/html",n),t.setData("text/plain",s)}}})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="复制";function i(){t.innerText="已复制！",setTimeout(()=>{t.innerText="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){let t=e.textContent;navigator.clipboard.writeText(t),i();return}const n=document.createRange();n.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(n);try{document.execCommand("copy"),i()}catch{}s.removeRange(n)});let l=e.className.replaceAll("language-",""),n=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),o=document.createElement("div");o.innerText=l,n.setAttribute("class","mac-tool"),a.setAttribute("class","mac bb1"),r.setAttribute("class","mac bb2"),c.setAttribute("class","mac bb3"),o.setAttribute("class","language-type"),n.appendChild(a),n.appendChild(r),n.appendChild(c),n.appendChild(o),s.classList.contains("highlight")?(s.appendChild(t),s.appendChild(n)):s.parentNode.firstChild==s||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?(e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t),s.appendChild(n)):(e.parentNode.appendChild(t),s.appendChild(n)))})</script></body></html>