<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Ansible | WZ's Blog</title><meta name=keywords content><meta name=description content="1 Ansible 简介 1.1 Ansible 发展史 作者：Michael DeHaan（ Cobbler 与 Func 作者） Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离，远程实时控制前线的舰队战斗。 2012-03-09，发布0.0.1版，2015-10-17，Red Hat宣布1.5亿美元收购An"><meta name=author content="wz"><link rel=canonical href=https://senmer.github.io/zh/posts/tech/ansible/ansible/><link crossorigin=anonymous href=/assets/css/stylesheet.5a2b6d77cc78ad18bcb4914c5c639c7ce5ab55e956c461d4310747892b3f50c2.css integrity="sha256-Wittd8x4rRi8tJFMXGOcfOWrVelWxGHUMQdHiSs/UMI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://senmer.github.io/img/Q.gif><link rel=icon type=image/png sizes=16x16 href=https://senmer.github.io/img/Q.gif><link rel=icon type=image/png sizes=32x32 href=https://senmer.github.io/img/Q.gif><link rel=apple-touch-icon href=https://senmer.github.io/img/Q.gif><link rel=mask-icon href=https://senmer.github.io/img/Q.gif><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer src=https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js></script>
<script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?4d7c4710a089d70b71310f0e1ec7681b",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="Ansible"><meta property="og:description" content="1 Ansible 简介 1.1 Ansible 发展史 作者：Michael DeHaan（ Cobbler 与 Func 作者） Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离，远程实时控制前线的舰队战斗。 2012-03-09，发布0.0.1版，2015-10-17，Red Hat宣布1.5亿美元收购An"><meta property="og:type" content="article"><meta property="og:url" content="https://senmer.github.io/zh/posts/tech/ansible/ansible/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-28T15:39:37+08:00"><meta property="article:modified_time" content="2023-08-28T15:39:37+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Ansible"><meta name=twitter:description content="1 Ansible 简介 1.1 Ansible 发展史 作者：Michael DeHaan（ Cobbler 与 Func 作者） Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离，远程实时控制前线的舰队战斗。 2012-03-09，发布0.0.1版，2015-10-17，Red Hat宣布1.5亿美元收购An"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"📚文章","item":"https://senmer.github.io/zh/posts/"},{"@type":"ListItem","position":2,"name":"👨🏻‍💻 技术","item":"https://senmer.github.io/zh/posts/tech/"},{"@type":"ListItem","position":3,"name":"Ansible","item":"https://senmer.github.io/zh/posts/tech/ansible/ansible/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Ansible","name":"Ansible","description":"1 Ansible 简介 1.1 Ansible 发展史 作者：Michael DeHaan（ Cobbler 与 Func 作者） Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离，远程实时控制前线的舰队战斗。 2012-03-09，发布0.0.1版，2015-10-17，Red Hat宣布1.5亿美元收购An","keywords":[""],"articleBody":"1 Ansible 简介 1.1 Ansible 发展史 作者：Michael DeHaan（ Cobbler 与 Func 作者）\nAnsible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离，远程实时控制前线的舰队战斗。\n2012-03-09，发布0.0.1版，2015-10-17，Red Hat宣布1.5亿美元收购Ansible。\nAnsible「2.9」 中文官方文档 — Ansible Documentation (cn-ansibledoc.readthedocs.io)\n1.2 Ansible 功能 批量远程执行命令、安装和配置各种服务 利用 Playbook 和 Role 编排企业级的复杂的 IT 架构任务 提供自动化运维工具的开发 API，如 JumpServer 就是基于 Ansible 实现自动化管理功能 1.3 Ansible 特点 1.3.1 优点 功能丰富：模块数量达数千个，且支持自定义模块和多数编程语言 简单易用：Ansible 不使用 C/S 架构管理节点，即没有 Agent，去中心化管理方式 安全：基于 OpenSSH 协议实现安全通讯，无需专用协议 幂等性：可以重复多次执行，对系统不会产生影响 使用 YAML 格式的配置文件，简单易读 Playbook 和 Role 支持编排复杂任务，增强代码复用性 Python 语言实现, 基于 Paramiko（ python 对 ssh 的实现），PyYAML，Jinja2（模板语言）三个关 键模块 1.3.2 缺点 管理主机较多时，执行效率不如 saltstack 当前还不支持像 MySQL 数据库类似的事务回滚 1.3.3 注意事项 安装了 ansible 的主机官方称之为管理机，工作中也常称之为：中控、主控、master 或者堡垒机\n被管理的主机一般称之为受管理节点，被控端，受控端\n管理机 Python 版本需要 2.6 及以上\n受管理节点 Python 版本低于 2.4 ，需要安装 python-simplejson\n受管理节点如果启用 SELinux ，需要安装 libselinux-python\nWindows 不能做为管理机，只能是受管理节点\n2 Ansible 安装和常见模块 2.1 Ansible 安装 中文文档：安装 Ansible — Ansible Documentation (cn-ansibledoc.readthedocs.io)\n英文文档：Ansible Documentation — Ansible Documentation\nCentOS 安装:\nyum install -y ansible Ubuntu 安装：\napt install -y ansible pip 安装（不推荐）：\npip install ansible 查看已安装的 ansible 版本\nansible --version 2.2 Ansible 相关文件 2.2.1 Ansible 配置文件列表 /etc/ansible/ansible.cfg 主配置文件，如果需要，可以为每个项目创建独有的 ansible.cfg 文件。 /etc/ansible/hosts 主机清单文件，包含所有受管理节点的 IP 及其他相关信息 /etc/ansible/roles 存放各个角色的目录 2.2.2 Ansible 主配置文件 Ansible 的配置文件可以有多个来源，优先级从高到低顺序如下：\nANSIBLE_CONFIG #环境变量 ./ansible.cfg\t~/.ansible.cfg /etc/ansible/ansible.cfg\t#系统默认配置 Ansible 的默认配置文件 /etc/ansible/ansible.cfg ，其中大部分注释内容即为默认值，没有特殊需要，可以不用修改。\n[defaults] # some basic default values... #inventory = /etc/ansible/hosts #library = /usr/share/my_modules/ #module_utils = /usr/share/my_module_utils/ #remote_tmp = ~/.ansible/tmp #local_tmp = ~/.ansible/tmp #plugin_filters_cfg = /etc/ansible/plugin_filters.yml #forks = 5 #poll_interval = 15 #sudo_user = root #ask_sudo_pass = True #ask_pass = True #transport = smart #remote_port = 22 #module_lang = C #module_set_locale = False # plays will gather facts by default, which contain information about 范例：通过环境变量 ANSIBLE_CONFIG 指定 ansible 配置文件路径\n[root@ansible ~]# ll /data/ansible.cfg # 并不存在的配置文件 ls: cannot access /data/ansible.cfg: No such file or directory [root@ansible ~]# export ANSIBLE_CONFIG=/data/ansible.cfg [root@ansible ~]# ansible --version ansible 2.9.27 config file = /etc/ansible/ansible.cfg # 还是默认配置文件 configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python2.7/site-packages/ansible executable location = /usr/bin/ansible python version = 2.7.5 (default, Oct 30 2018, 23:45:53) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)] [root@ansible ~]# touch /data/ansible.cfg #创建此文件 [root@ansible ~]# ansible --version ansible 2.9.27 config file = /data/ansible.cfg # 成功指定 configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python2.7/site-packages/ansible executable location = /usr/bin/ansible python version = 2.7.5 (default, Oct 30 2018, 23:45:53) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)] 2.2.3 Inventory 主机清单文件 ansible 的主要功能在于批量管理主机，这些被管理的主机就使用 inventory 文件来指定。\n生产环境可以为每个项目创建独有的 ansible.cfg 文件和 hosts 文件，实现项目之前的隔离管理。\n官方文档：https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html\n主机清单文件格式\ninventory 文件遵循 INI 文件风格，可以对主机进行分组管理，且可以针对每个主机指定非默认的端口和账号等信息\n常用 Inventory 参数说明\nansible_ssh_host # 远程主机名与想要设定的主机的别名不同的话，可通过此变量设置。 ansible_ssh_port # ssh 端口号，如果不是默认的端口号，通过此变量设置。或者ip:端口的形式指定 192.168.1.100:2222 ansible_ssh_user # ssh 用户名 ansible_ssh_pass # ssh 密码(这种方式并不安全，强烈建议使用 --ask-pass 或者配置 ssh 免密) ansible_sudo_pass # sudo 密码(这种方式并不安全，强烈建议使用 --ask-sudo-pass) ansible_sudo_exe (new in version 1.8) # sudo 命令路径(适用于1.8及以上版本) ansible_connection # 与主机的连接类型.比如:local, ssh 或者 paramiko。 Ansible 1.2 以前默认使用 paramiko。1.2 以后默认使用 'smart'，'smart' 方式会根据是否支持 ControlPersist, 来判断'ssh' 方式是否可行。 ansible_ssh_private_key_file # ssh 使用的私钥文件，适用于有多个密钥，而你不想使用 ssh 代理的情况。 ansible_shell_type # 目标系统的 shell 类型。默认情况下，命令的执行使用 'sh' 语法, 可设置为'csh' 或 'fish'。 ansible_python_interpreter # 目标主机的 python 路径，适用于的情况: 系统中有多个 Python, 或者命令路径不是\"/usr/bin/python\"，比如 \\*BSD, 或者 /usr/bin/python 不是 2.X 版本的Python。之所以不使用 \"/usr/bin/env\" 机制，因为这要求远程用户的路径设置正确，且要求 \"python\" 可执行程序名不可为 python 以外的名字(实际有可能名为python26) 范例：主机和组嵌套\nntp.time.org [databases] www.db1.org:2222 www.db2.org [web] www.web1.com www.web2.com [proxy] pro[1:3].test.com pro-db[a:f].test.com # server 组成员：web, proxy [server:children] # children 是内置变量 web proxy 范例：基于用户名和密码连接\n[test] 10.0.0.1 ansible_connection=local #指定本地连接方式，如：ssh localhost 10.0.0.2 ansible_connection=ssh ansible_ssh_port=2222 ansible_ssh_user=user ansible_ssh_password=passwd 10.0.0.3 ansible_ssh_user=test ansible_ssh_password=test [web] web01 ansible_ssh_host=10.0.0.5 # web01 为别名 web02 ansible_ssh_host=10.0.0.6 [web:vars] # vars 是内置变量，这里为 web 组内的成员定义了一个组变量 ansible_ssh_password=test 2.3 Ansible 相关工具 /usr/bin/ansible 主程序，临时命令执行工具 /usr/bin/ansible-doc 查看配置文档，模块功能查看工具,相当于man /usr/bin/ansible-playbook 定制自动化任务，编排剧本工具,相当于脚本 /usr/bin/ansible-pull 远程执行命令的工具 /usr/bin/ansible-vault 文件加密工具 /usr/bin/ansible-console 基于Console界面与用户交互的执行工具 /usr/bin/ansible-galaxy 下载/上传优秀代码或Roles模块的官网平台 利用 ansible 实现管理的主要方式：\nAnsible Ad-Hoc 主要用于命令行执行命令，适合于简单任务 Ansible playbook 主要用于长期规划好的，大型项目场景 ansible 使用前准备：\nansible 大部分工具使用 ssh 协议来进行远程主机管理，因此在使用此工具前需要配置好密钥认证，如果使用密码验证会很麻烦，而且并不安全。\n在首次 ssh 某台主机时，会有一个是否信任主机的提示：\n[root@ansible ~]# ssh localhost The authenticity of host 'localhost (::1)' can't be established. ECDSA key fingerprint is SHA256:kFbXYFVk/H+j5h1JTkIf9HAw+zXbWQIHqG03FutZJ3E. ECDSA key fingerprint is MD5:7b:d4:06:49:45:fa:58:b0💿de:ef:bc:1e:14:09:f3. Are you sure you want to continue connecting (yes/no)? 可以修改 /etc/ssh/ssh_config的配置来避免该提示：\nStrictHostKeyChecking no 以下准备了一个脚本来实现 ssh 免密登录：\n准备一个清单文件，写入相应的IP\n[root@ansible ~]# cat hosts.txt 10.0.0.1 10.0.0.2 10.0.0.3 脚本内容：\n#!/bin/bash # 需要修改的参数 ################### # 读取主机列表文件 hosts_file=\"hosts.txt\" # 远程用户名 remote_user=\"your_username\" # 并发任务数量 concurrency=10 # SSH 密码 export ssh_password=\"your_password\" ########################## # 颜色定义 RED='\\033[0;31m' GREEN='\\033[0;32m' NC='\\033[0m' # No Color # 打印带颜色的消息 print_message() { local message=\"$1\" local color=\"$2\" echo -e \"${color}$message${NC}\" } # 检查主机列表文件是否存在 if [ ! -f \"$hosts_file\" ]; then echo -e \"\\033[31mHosts file not found: $hosts_file\\033[0m\" exit 1 fi # 安装 sshpass rpm -q sshpass \u0026\u003e /dev/null || yum install -y sshpass # 安装 parallel rpm -qi parallel \u0026\u003e /dev/null || yum install -y parallel # 生成 id_rsa 密钥 [ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa -P '' # mkfifo 创建命名管道 tempfifo=\"/tmp/$$.fifo\" mkfifo ${tempfifo} # 关联fifo文件和fd6，使文件描述符为非阻塞式 exec 6\u003c\u003e${tempfifo} rm -f ${tempfifo} # 为文件描述符创建占位信息 for ((i=1;i\u003c=${concurrency};i++)) do { echo \"\" \u003e\u00266 } done # 逐行读取主机列表文件并执行任务 while IFS= read -r host; do read -u6 ## read -u6命令执行一次，相当于尝试从fd6中获取一行，如果获取不到，则阻塞获取到了 ## 一行后，fd6就少了一行了，开始处理子进程，子进程放在后台执行 { sshpass -p \"$ssh_password\" ssh-copy-id -o StrictHostKeyChecking=no \"$remote_user@$host\" \u0026\u003e/dev/null; exit_code=$? if [ $exit_code -eq 0 ]; then print_message \"成功免密主机: $host\" \"$GREEN\" else print_message \"失败免密主机: $host\" \"$RED\" fi echo \"\" \u003e\u00266 # 完成后再补充一个空值到fd6中，释放一个锁 } \u0026 done \u003c \"$hosts_file\" wait # 关闭fd6管道 exec 6\u003e\u0026- 2.3.1 Ansible-doc 此工具用于显示模块帮助文档，类似 man\n使用格式：\nansible-doc [options] [module...] -l, --list # 列出可用模块 -s, --snippet # 显示指定模块的playbook片段 常用选项：\n# 列出所有模块 ansible-doc -l # 查看指定模块帮助用法 ansible-doc ping # 查看常用playbook选项 ansible-doc -s ping 查看模块相关的插件\n# connection 模块相关组件 ansible-doc -t connection -l # lookup 模块相关组件 ansible-doc -t lookup -l 2.3.2 Ansible 2.3.2.1 Ansible Ad-Hoc Ansible Ad-Hoc 主要就是使用ansible主程序\n通常用来执行一次性任务，不会保存命令执行的信息，常用于测试场景\n2.3.2.2 Ansible 命令用法 格式：\nansible [-m module_name] [-a args] 常用选项：\n--version\t# 查看 ansible 版本和配置文件路径 -m # 指定使用的模块，不指定默认为 command -v # 用于 debug，-vv -vvv 可显示更详细命令执行过程的日志 --list-hosts\t# 显示清单文件中的主机列表 -C, --check\t# 模拟执行，并不对目标主机做实际改动，可以用来检查语法 -T, --timeout=TIMEOUT # 指定命令执行超时时间 -k, --ask-pass # 提示输入 ssh 密码，使用密码验证，默认使用 key 验证 -u, --user=USERNAME # 指定 sudo 用户，默认为 root -b, --become # 使用 sudo 机制 --become-user=USERNAME # 指定 sudo 的目标用户，默认为 root -K, --ask-become-pass\t# 提示输入 sudo 密码 -f , --FORKS # 指定并发数 范例：使用 localhost 走本地协议，并不需要密码（包括 sudo 密码）：\n# 以test 用户执行操作， [root@ansible ~]# ansible localhost -m ping -u test localhost | SUCCESS =\u003e { \"changed\": false, \"ping\": \"pong\" } # 指定了用户为 test，但并未生效 [root@ansible ~]# ansible localhost -m shell -a \"whoami\" -u test localhost | CHANGED | rc=0 \u003e\u003e root # 以 test 用户使用 sudo 机制执行命令 [root@ansible ~]# [root@ansible ~]# ansible localhost -m shell -a \"whoami\" -u test -b -become-user=root localhost | CHANGED | rc=0 \u003e\u003e root 范例：使用 IP连接，可观测到 ansible 的相关特性\n# 本机IP [root@ansible ~]# hostname -I 192.168.0.133 # 将本机IP加入清单文件（localhost不需要显式加入） [root@ansible ~]# grep $(hostname -I) /etc/ansible/hosts 192.168.0.133 # 没有输入密码提示权限不足 [root@ansible ~]# ansible 192.168.0.133 -m shell -a \"whoami\" -u test 192.168.0.133 | UNREACHABLE! =\u003e { \"changed\": false, \"msg\": \"Failed to connect to the host via ssh: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).\", \"unreachable\": true } # 加入 -k 选项输入密码，成功执行 [root@ansible ~]# ansible 192.168.0.133 -m shell -a \"whoami\" -u test -k SSH password: 192.168.0.133 | CHANGED | rc=0 \u003e\u003e test # sudo 也是同样的情况，不输入密码会报错 [root@ansible ~]# ansible 192.168.0.133 -m shell -a \"whoami\" -u test -k -b SSH password: 192.168.0.133 | FAILED | rc=-1 \u003e\u003e Missing sudo password # 输入密码后成功执行 [root@ansible ~]# ansible 192.168.0.133 -m shell -a \"whoami\" -u test -k -b -K SSH password: BECOME password[defaults to SSH password]: 192.168.0.133 | CHANGED | rc=0 \u003e\u003e root 范例：并发执行控制\n# 分别执行一下以下两个命令观察运行效果，可以发现执行的之间基本一致 [root@ansible ~]# ansible localhost -a 'sleep 3' -f 1 [root@ansible ~]# ansible localhost -a 'sleep 3' -f 10 范例：使用普通用户进行远程管理\n# 在所有控制端和被控制端创建普通账号并修改密码（本次示例为均为192.168.0.133） [root@ansible ~]# useradd test [root@ansible ~]# echo test:test | chpasswd # 添加sudo授权 [root@ansible ~]# visudo # 添加一行 test\tALL=(ALL) ALL # 校验配置无误 [root@ansible ~]# visudo -c /etc/sudoers: parsed OK # 切换到普通用户 [root@ansible ~]# su - test # 生成密钥对 [test@ansible ~]$ ssh-keygen -f ~/.ssh/id_rsa -P ' # 将公钥拷贝到目标主机 [test@ansible ~] ssh-copy-id -o \"StrictHostKeyChecking=no\" test@192.168.0.133 # 验证免密登录成功 [test@ansible ~]$ ssh test@192.168.0.133 Last login: Mon Jun 12 09:50:05 2023 # 使用ansible进行远程控制，提示权限不足 [test@ansible ~]$ ansible 192.168.0.133 -m shell -a 'ls /root/' 192.168.0.133 | FAILED | rc=2 \u003e\u003e ls: cannot open directory /root/: Permission deniednon-zero return code # 使用 sudo 提权后执行成功 [test@ansible ~]$ ansible 192.168.0.133 -m shell -a 'ls /root/' -b -K BECOME password: 192.168.0.133 | CHANGED | rc=0 \u003e\u003e ansible.cfg **注意：**在上面的示例中，ansible 远控时并未指定远程的用户名，当没有用 -u 指定远程用户名时，默认使用当前的本机用户名进行远程\n[root@ansible ~]# ansible 192.168.0.133 -m shell -a 'whoami' 192.168.0.133 | CHANGED | rc=0 \u003e\u003e root [root@ansible ~]# su - test Last login: Mon Jun 12 10:03:04 CST 2023 from 192.168.0.133 on pts/3 [test@ansible ~]$ ansible 192.168.0.133 -m shell -a 'whoami' 192.168.0.133 | CHANGED | rc=0 \u003e\u003e test # 通过 -u 显式指明远程用户名 [test@ansible ~]$ ansible 192.168.0.133 -m shell -a 'whoami' -u root -k SSH password: 192.168.0.133 | CHANGED | rc=0 \u003e\u003e root ansible Host-pattern\n用于匹配主机清单中的主机\n准备主机清单文件：\n[root@ansible ~]# cat /etc/ansible/hosts 192.168.0.133 [hello] 192.168.0.1 172.31.5.1 [world] 10.0.0.1 172.31.5.1 all : 内置变量，表示所有主机\n[root@ansible ~]# ansible all --list-hosts hosts (4): 192.168.0.133 10.0.0.1 172.31.5.1 192.168.0.1 *: 通配符\n[root@ansible ~]# ansible \"*\" --list-hosts hosts (4): 192.168.0.133 10.0.0.1 172.31.5.1 192.168.0.1 [root@ansible ~]# ansible \"192.168.0.*\" --list-hosts hosts (2): 192.168.0.1 192.168.0.133 逻辑或\n[root@ansible ~]# ansible \"hello:world\" --list-hosts hosts (3): 192.168.0.1 172.31.5.1 10.0.0.1 逻辑与\n[root@ansible ~]# ansible \"hello:\u0026world\" --list-hosts hosts (1): 172.31.5.1 逻辑非\n# 引用!号时,不要用双引号,而使用单引号 # 在Ansible中，单引号用于指定字面值模式，以确保其中的内容被视为普通字符，而不进行变量展开或转义字符处理。 [root@ansible ~]# ansible 'all:!hello:!world' --list-hosts hosts (1): 192.168.0.133 正则表达式\nansible \"~(web|db).*\\.test\\.com\" -m ping \"~(web|db).*\\.test\\.com\"是用于选择目标主机的模式（pattern）。让我们逐步解释这个模式：\n~是Ansible中用于匹配正则表达式的运算符。 (web|db)表示选择以\"web\"或\"db\"开头的字符串。在这种情况下，模式将匹配\"web\"或\"db\"之后的任意字符。 .*表示匹配零个或多个任意字符。 \\.test\\.com表示匹配字符串\".test.com\"。 因此，整个模式~(web|db).*\\.test\\.com将匹配以\"web\"或\"db\"开头，然后是任意字符（零个或多个），最后以\".test.com\"结尾的字符串。\n使用该模式，ansible命令将选择符合该模式的远程主机，并对它们执行Ping操作。Ping操作旨在检查与目标主机的连通性，并确定是否可以与之通信。\n综上所述，ansible \"~(web|db).*\\.test\\.com\" -m ping命令将使用Ansible选择以\"web\"或\"db\"开头，然后是任意字符，最后以\".test.com\"结尾的主机，并对它们执行Ping操作。\n2.3.2.3 Ansible 命令执行过程 加载配置文件，默认为 /etc/ansible/ansible.cfg 匹配主机清单中对应的主机或者主机组 加载对应的模块文件，如：shell 通过 ansible 将模块或命令生成临时 py 文件，并将该文件传输至受控节点：$HOME/.ansible/tmp/ansible-tmp-数字/XXX.PY文件 赋予 xxx.py 文件执行权限：+x 执行并返回结果 删除 xxx.py 文件，结束 2.3.2.4 Ansible 命令执行状态 每种状态对应了一个颜色标识\n[root@ansible ~]# grep -A 14 '\\[colors\\]' /etc/ansible/ansible.cfg [colors] #highlight = white #verbose = blue #warn = bright purple #error = red #debug = dark gray #deprecate = purple #skip = cyan #unreachable = red #ok = green #changed = yellow #diff_add = green #diff_remove = red #diff_lines = cyan 常见的三种颜色标识：\n绿色：表示任务成功完成。当任务在远程主机上成功执行并返回正确的结果时，该任务将以绿色显示。\n**黄色：**表示任务已更改。当任务在远程主机上执行并导致一些更改时，但不会破坏系统或引发错误时，该任务将以黄色显示。例如，如果某个配置文件的某行已更改，但该更改不会导致问题或错误，任务状态将显示为黄色。\n**红色：**表示任务失败。当任务在远程主机上执行时发生错误或返回错误结果时，该任务将以红色显示。这可能是由于连接问题、权限问题、语法错误或其他原因导致的失败。\n2.3.3 ansible-console 此工具主要用于交互式执行命令，支持命令补全，ansible 2.0+ 版本新增\n提示符格式：\n远程用户@目标主机组（组中的主机数量）[f:并发数]$ 常用命令：\n设置并发数：forks 切换组：cd [group_name]\n查看当前组中的主机：list\n查看所有的内置命令：？或 help\n退出：exit 或者 Ctrl+ D\n示例：\n[root@ansible ~]# ansible-console Welcome to the ansible console. Type help or ? to list commands. root@all (4)[f:5]$ forks 6 root@all (4)[f:6]$ cd hello root@hello (2)[f:6]$ exit 2.3.4 ansible-playbook 此工具主要用于执行编写好的 playbook 任务\n范例：\n[root@ansible playbooks]# cat hello.yaml # playbook 任务，打印 hello world - hosts: localhost remote_user: root gather_facts: no tasks: - name: hello world shell: wall \"hello world\" # 向所有已登录用户广播消息 [root@ansible playbooks]# ansible-playbook hello.yaml # 执行 playbook 任务 PLAY [localhost] *************************************************************************************************************************************** TASK [hello world] ************************************************************************************************************************************* Broadcast message from root@ansible.localdomain (Mon Jun 19 09:15:36 2023): hello world changed: [localhost] PLAY RECAP ********************************************************************************************************************************************* localhost : ok=1 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 2.3.5 ansible-vault 此工具用于加密，解密 yaml 文件\n格式：\nansible-vault [create,decrypt,edit,view,encrypt,encrypt_string,rekey] \u003c*.yaml\u003e 范例：\n[root@ansible playbooks]# ansible-vault encrypt hello.yaml # 加密文件 New Vault password: Confirm New Vault password: Encryption successful [root@ansible playbooks]# ansible-vault view hello.yaml # 查看加密文件内容，需要输入正确的密码 Vault password: - hosts: localhost remote_user: root gather_facts: no tasks: - name: hello world shell: wall \"hello world\" [root@ansible playbooks]# cat hello.yaml # 正常查看，只能看到密文 $ANSIBLE_VAULT;1.1;AES256 62623561653235343235613763393365396164323430366161363731646339303965316136333964 6662366334363161363465636630646532616334666538640a383037313035646537613264306130 62323438653861613736336339353037373537633066396566366136373832666332636364336362 6130363834346566630a343765303630616631643436373036353966356663366537343863653535 65653565653765363961313738386266336538353336376664643330316633303636333337336237 35653162313461383436643237623034363436373430363237346334663062306638386566313738 36346165643437643230396664346564383039623434346332313961303331383331313761663939 63313665306463356433393731663965366131353336666135343530613062306433623234623666 39633764623862353238613139333264343735303330626432363831646331653666313361316565 3034363863323531393761316363626263653838313734343134 [root@ansible playbooks]# ansible-playbook hello.yaml # 不能直接执行已加密的 playbook ERROR! Attempting to decrypt but no vault secrets found [root@ansible playbooks]# ansible-playbook --ask-vault-pass hello.yaml # 加入选项，输入密码后执行 [root@ansible playbooks]# cat pass.txt # 准备密码文件，存放密码 dd [root@ansible playbooks]# ansible-playbook --vault-password-file pass.txt hello.yaml # 从文件中读取密码 [root@ansible playbooks]# grep vault_password_file /etc/ansible/ansible.cfg # 修改配置文件中的该项，指定密码文件路径 vault_password_file = /etc/ansible/pass.txt [root@ansible playbooks]# ansible-playbook hello.yaml # 可以正常执行 playbook [root@ansible playbooks]# ansible-vault edit hello.yaml # 编辑加密文件，需要输入正确的密码 Vault password: [root@ansible playbooks]# ansible-vault decrypt hello.yaml # 解密文件 Vault password: Decryption successful [root@ansible playbooks]# cat hello.yaml # 可以看到未加密的原文 - hosts: localhost remote_user: root gather_facts: no tasks: - name: hello world shell: wall \"hello world +++\" [root@ansible playbooks]# ansible-vault create new.yaml # 可以直接创建一个加密文件 New Vault password: Confirm New Vault password: [root@ansible playbooks]# ansible-vault rekey new.yaml # 输入旧密码后，可以更改密码 Vault password: New Vault password: Confirm New Vault password: Rekey successful 2.3.6 ansible-galaxy Galaxy 是一个免费网站, 类似于github网站, 网站上发布了很多的共享的roles角色。\nAnsible 提供了ansible-galaxy命令行工具连接 https://galaxy.ansible.com 网站下载相应的roles，进行\ninit (初始化)、search ( 查拘)、install (安装)、 remove(移除)等操作。\nansible-galaxy是一个与Ansible配置管理工具相关的命令行工具。它用于管理和扩展Ansible角色和集合。\n使用ansible-galaxy，可以执行以下操作：\n安装角色和集合：可以使用ansible-galaxy install命令安装其他人编写的Ansible角色或集合。例如，要安装一个名为myrole的角色，可以运行以下命令（默认下载到~/.ansible/roles下）：\nansible-galaxy install myrole 创建角色：使用ansible-galaxy init命令可以创建一个新的Ansible角色结构。该命令将生成一个包含目录和文件的目录结构，用于组织角色的任务、变量、模板等内容。例如，要创建一个名为myrole的角色，可以运行以下命令：\nansible-galaxy init myrole 列出已安装的角色和集合：使用ansible-galaxy list命令可以列出已经安装在系统上的角色和集合。这将显示已安装的角色和集合的名称、版本号和其他详细信息。\n删除角色和集合：可以使用ansible-galaxy remove命令从系统中删除已安装的角色和集合。例如，要删除一个名为myrole的角色，可以运行以下命令：\nansible-galaxy remove myrole 这些只是ansible-galaxy命令的一些常见用法示例。有关更多详细信息和选项，请查阅Ansible官方文档或运行ansible-galaxy --help命令来获取帮助。\n2.4 Ansible 常用模块 2015年12月只270多个模块\n2016年12年26日ansible 1.9.2 有540个模块\n2018年01月12日ansible 2.3.8 有1378个模块\n2018年05月28日ansible 2.5.3 有1562个模块\n2018年07月15日ansible 2.6.3 有1852个模块\n2018年11月19日ansible 2.7.2 有2080个模块\n2020年03月02日ansible 2.9.5 有3387个模块\n2021年12月22日ansible 2.11.8 有6141个模块\n2022年06月04日ansible 2.12.6 有6763个模块\n虽然模块众多，但最常用的模块约30个左右，针对特定业务学习需要的模块即可\n常用模块帮助文档参考：\nModule Index — Ansible Documentation\nAll modules — Ansible Documentation\n本章节内容以此主机清单进行演示，ansible 为管理节点，remote 为受控节点\n[root@ansible ~]# hostname -I 192.168.0.133 [root@ansible ~]# cat /etc/ansible/hosts remote ansible_ssh_host=192.168.0.134 remote2 ansible_ssh_host=192.168.0.135 2.4.1 command 模块 默认模块。在远程主机执行命令，执行命令时不加 -m 则默认使用此模块\n此命令不支持 \u003c, \u003e, |, ; and \u0026 等高级特性或运算符\n此模块不具备幂等性\n常用选项：\nchdir=DIR\t# 切换目录 creates=FILE\t# 当 FILE 不存在时，执行操作 removes=FILE\t# 当 FILE 存在时，执行操作\t范例：\n# 切换目录，查看系统版本 [root@ansible ~]# ansible localhost -a 'chdir=/etc cat centos-release' localhost | CHANGED | rc=0 \u003e\u003e CentOS Linux release 7.6.1810 (Core) # 当 /tmp/tmp.txt 存在时，打印 hello [root@ansible ~]# ansible localhost -a 'chdir=/etc creates=/tmp/tmp.txt echo hello' localhost | CHANGED | rc=0 \u003e\u003e hello # 当 /tmp/tmp.txt 存在时，打印 hell，这里条件不满足，任务直接被跳过 [root@ansible ~]# ansible localhost -a 'chdir=/etc removes=/tmp/tmp.txt echo hello' localhost | SUCCESS | rc=0 \u003e\u003e skipped, since /tmp/tmp.txt does not exist 不支持的高级特性：\n# 创建 hello.txt, 命令执行成功 [root@ansible ~]# ansible localhost -a 'chdir=/tmp echo hello \u003e hello.txt' localhost | CHANGED | rc=0 \u003e\u003e hello \u003e hello.txt # 实际上文件并不存在 [root@ansible ~]# ansible localhost -a 'chdir=/tmp ll hello.txt' localhost | FAILED | rc=2 \u003e\u003e [Errno 2] No such file or directory [root@ansible ~]# ll /tmp/hello.txt ls: cannot access /tmp/hello.txt: No such file or directory # 不支持 \u0026\u0026 ; | 等符号（尽管执行不报错） [root@ansible ~]# ansible localhost -a 'chdir=/tmp echo hello \u003e hello.txt \u0026\u0026 echo world' localhost | CHANGED | rc=0 \u003e\u003e hello \u003e hello.txt \u0026\u0026 echo world [root@ansible ~]# ansible localhost -a 'chdir=/tmp echo hello \u003e hello.txt ; echo world' localhost | CHANGED | rc=0 \u003e\u003e hello \u003e hello.txt ; echo world [root@ansible ~]# ansible localhost -m command -a \"echo test | passwd --stdin pass\" localhost | CHANGED | rc=0 \u003e\u003e test | passwd --stdin pass 2.4.2 shell 模块 此模块功能与 command 几乎一致，但是功能会更强。Command 模块不支持的重定向，管道符等运算符在 Shell 模块中都是支持的（尽管如此，实际使用时尽量避免使用过于复杂或特殊的符号），除非有使用高级特性的需求，否则官方更推荐使用 command 模块（更加安全和稳定）。\n此模块不具备幂等性\n常见选项\nchdir=DIR\t# 切换目录 creates=FILE\t# 当 FILE 不存在时，执行操作 removes=FILE\t# 当 FILE 存在时，执行操作 范例：\n# 打印变量 [root@ansible ~]# ansible localhost -m shell -a \"echo $HOSTNAME\" localhost | CHANGED | rc=0 \u003e\u003e localhost.localdomain # 修改账号密码 [root@ansible ~]# ansible localhost -m shell -a \"echo pass | passwd --stdin test\" localhost | CHANGED | rc=0 \u003e\u003e Changing password for user test. passwd: all authentication tokens updated successfully. # 使用重定向生成文件，并输出内容 [root@ansible ~]# ansible localhost -m shell -a \"echo hello \u003e /tmp/hello.txt \u0026\u0026 ls /tmp/hello.txt \u0026\u0026 cat /tmp/hello.txt\" localhost | CHANGED | rc=0 \u003e\u003e /tmp/hello.txt hello 注意：类似 cat /tmp/test.md | awk -F’|’ ‘{print $1,$2}’ \u0026\u003e /tmp/example.txt 的复杂命令，即使使用Shell模块也可能会失败。可以考虑将命令写成 shell 脚本，再通过 Script 模块进行调用\nAnsible 命令所使用的默认模块是 command，可以通过修改配置项重新指定为别的模块：\n[root@ansible ~]# grep module_name /etc/ansible/ansible.cfg #module_name = command 2.4.3 script 模块 此模块可以在远程主机执行 Ansible 主机上的脚本（脚本不需要执行权限）\n此模块不具备幂等性\n常见选项\nchdir=DIR\t# 切换目录 creates=FILE\t# 当 FILE 不存在时，执行操作 removes=FILE\t# 当 FILE 存在时，执行操作\t范例：\n# 准备一个脚本文件 [root@ansible ~]# cat test.sh echo hello # 该文件无执行权限 [root@ansible ~]# ll test.sh -rw-r--r--. 1 root root 11 Jun 20 15:44 test.sh # 通过 script模块 在目标主机执行该脚本 [root@ansible ~]# ansible remote -m script -a 'test.sh' remote | CHANGED =\u003e { \"changed\": true, \"rc\": 0, \"stderr\": \"Shared connection to 192.168.0.134 closed.\\r\\n\", \"stderr_lines\": [ \"Shared connection to 192.168.0.134 closed.\" ], \"stdout\": \"hello\\r\\n\", \"stdout_lines\": [ \"hello\" ] } 2.4.4 copy 模块 此模块用于文件拷贝，有两种用法：\n将 ansible 主机上的文件拷贝到受控节点 将受控节点的文件拷贝到受控节点的其他路径 常见选项\nsrc # 控制端的源文件路径 dest # 被控端的文件路径 owner # 属主 group # 属组 mode # 权限 backup # 是否备份 validate # 验证成功才会执行copy remote_src # no 是默认值, 表示 src 文件在 ansible 主机, yes表示 src 文件在远程主机 范例：\n# 创建local.txt 并将其拷贝到 remote 主机上 [root@ansible ~]# touch local.txt [root@ansible ~]# ansible remote -m copy -a 'src=local.txt dest=/tmp/remote.txt owner=test mode=600' # 成功拷贝到 remote 主机 [root@ansible ~]# ansible remote -a 'ls /tmp/remote.txt' remote | CHANGED | rc=0 \u003e\u003e /tmp/remote.txt # 修改local.txt 文件内容，再次执行拷贝操作 [root@ansible ~]# echo hello \u003e\u003e local.txt # 当文件内容变化，且 backup=yes 时，会在拷贝操作执行前，在目标主机生成一个以时间戳为后缀的备份文件，如：remote.txt.9235.2023-06-20@16:52:58~ [root@ansible ~]# ansible remote -a \"ls /tmp\" remote | CHANGED | rc=0 \u003e\u003e ansible_command_payload_QQiJzZ remote.txt remote.txt.9235.2023-06-20@16:52:58~ # 拷贝 remote 主机的文件到指定路径，remote_src 表示源文件在目标主机上 [root@ansible ~]# ansible remote -m copy -a \"src=/tmp/remote.txt dest=/tmp/local.txt owner=test mode=600 remote_src=yes\" # 成功在 remote 主机的 /tmp 目录下 复制了一个 local.txt 文件 [root@ansible ~]# ansible remote -a \"ls /tmp/local.txt\" remote | CHANGED | rc=0 \u003e\u003e /tmp/local.txt # 直接指定文件内容，生成文件 [root@ansible ~]# ansible remote -m copy -a 'content=\"hello\\nworld\\n\" dest=/tmp/hello.txt' [root@ansible ~]# ansible remote -a 'cat /tmp/hello.txt' remote | CHANGED | rc=0 \u003e\u003e hello world #### 拷贝整个文件夹 /tmp 到 remote 主机。注意：是 /tmp 而非 /tmp/ [root@ansible ~]# ansible remote -m copy -a 'src=/tmp dest=/tmp/' [root@ansible ~]# ansible remote -a 'ls -d /tmp/tmp' remote | CHANGED | rc=0 \u003e\u003e /tmp/tmp ### 拷贝/tmp 文件夹下的文件到目标主机 # 提前在目标主机新建一个空文件夹用于存放 /tmp 目录下的文件 [root@remote ~]# ls -d /test/ /test/ # 在 /tmp 文件夹下有一个 test.txt 文件 [root@ansible ~]# ls /tmp/test.txt /tmp/test.txt # 执行拷贝操作，观察到成功拷贝 /tmp 文件夹下的文件到目标主机 [root@ansible ~]# ansible remote -m copy -a 'src=/tmp/ dest=/test' [root@ansible ~]# ansible remote -a 'ls /test' remote | CHANGED | rc=0 \u003e\u003e test.txt # 复制文件并执行校验命令，注意：%s 是一个占位符，将在命令执行时被替换为源文件的路径。 [root@ansible ~]# ansible remote -m copy -a \"src=/etc/sudoers dest=/etc/sudoers.bak remote_src=yes validate='/usr/sbin/visudo -csf %s'\" 2.4.5 get_url 模块 此模块使用 http、https 或 ftp 协议下载文件\n常用参数：\nurl # 下载文件的URL,支持 HTTP，HTTPS 或 FTP 协议 dest # 下载到目标路径（绝对路径），如果目标是一个目录，就用原文件名，如果目标设置了名称就用目标设置的名称 owner # 指定属主 group # 指定属组 mode # 指定权限 force # 如果 yes，dest 不是目录，将每次下载文件，如果内容改变替换文件。如果 no，则只有在目标不存在时才会下载，默认：no checksum # 对目标文件在下载后计算摘要，以确保其完整性 # 示例: # checksum=\"sha256:D98291AC[...]B6DC7B97\", # checksum=\"sha256:http://example.com/path/sha256sum.txt\" url_username # 用于HTTP基本认证的用户名。 对于允许空密码的站点，此参数可以不使用 `url_password' url_password # 用于HTTP基本认证的密码。 如果未指定`url_username'参数，则不生效 `url_password'参数 validate_certs # 如果“no”，SSL证书将不会被验证。 适用于自签名证书在私有网站上使用 timeout # URL请求的超时时间,秒为单位 范例：\n# 下载 nginx 至 remote 主机，并校验 md5 值 [root@ansible ~]# ansible remote -m get_url -a 'url=http://nginx.org/download/nginx-1.18.0.tar.gz dest=/usr/local/src checksum=\"md5:b2d33d24d89b8b1f87ff5d251aa27eb8\"' # 下载成功 [root@ansible ~]# ansible remote -a 'ls /usr/local/src/' remote | CHANGED | rc=0 \u003e\u003e nginx-1.18.0.tar.gz 2.4.6 fetch 模块 此模块可以将受控节点的文件拉取至 ansible 主控端，和 copy 模块功能相反，目前不支持拉取目录\n常见选项\nsrc # 受控节点源文件路径 dest # ansible 主控端目录路径 范例：\n# 如果同时拉取多台主机的同一文件，ansible 会为每台主机建立单独的文件夹来存放拉取的文件 [root@ansible ~]# ansible all --list-hosts hosts (2): remote remote2 # 将远程主机的redhat-release 文件拉取至 ansible 主机的 /tmp/os目录下（目录会自动创建） [root@ansible ~]# ansible all -m fetch -a 'src=/etc/redhat-release dest=/tmp/os/' [root@ansible ~]# tree /tmp/os/ /tmp/os/ ├── remote │ └── etc │ └── redhat-release └── remote2 └── etc └── redhat-release 4 directories, 2 files 2.4.7 file 模块 此模块用于创建，删除文件，目录和软连接以及修改相关属性\n常见选项\npath # 在被控端创建的路径 owner # 属主 group # 属组 mode # 权限 state # 状态 =touch # 创建文件 =directory # 创建目录 =link # 软链接 =hard # 硬链接 recurse # yes 表示递归授权 范例：\n# 创建文件并修改属主 [root@ansible ~]# ansible remote -m file -a 'path=/tmp/file.txt state=touch owner=test mode=755' # 删除文件 [root@ansible ~]# ansible remote -m file -a 'path=/tmp/file.txt state=absent' # 创建软连接，其中 dest 还可以替换为[ path | name ] [root@ansible ~]# ansible remote -m file -a 'src=/etc/redhat-release dest=/tmp/release-link state=link' [root@ansible ~]# ansible remote -a 'cat /tmp/release-link' remote | CHANGED | rc=0 \u003e\u003e CentOS Linux release 7.6.1810 (Core) # 创建目录 [root@ansible ~]# ansible remote -m file -a 'path=/tmp/dir state=directory' # 递归修改文件属性 [root@ansible ~]# ansible remote -m file -a 'path=/tmp owner=test group=test recurse=yes' 2.4.8 stat 模块 此模块用于检查文件或文件系统状态\nansible.builtin.stat module – Retrieve file or file system status — Ansible Documentation\n常见选项\npath # 文件或对象的完整路径（必须） 常见返回值：\nattributes：# 返回指定文件的属性。 executable：# 如果调用的用户在目标路径上有执行权限，则返回 true。 exists：\t# 如果指定的路径存在，返回真。 gr_name：# 返回文件所有者的组的名称。 islbk：\t# 如果指定的文件是一个块状设备，则返回true。 ischr： # 如果指定的文件是一个字符文件，则返回真。 isreg：\t# 如果指定的文件是一个常规文件，则返回真。 isdir：\t# 如果指定的文件是一个目录，则返回真。 islnk：\t# 如果目标文件是一个链接，则返回真。 mode：\t# 以八进制符号返回文件权限。 isuid： # isuid 表示 \"is setuid\"，用于判断文件是否具有设置用户 ID (Set User ID，SUID) 权限。 范例：\n[root@remote ~]# chmod a+s /etc/centos-release [root@remote ~]# ll /etc/centos-release -rwSr-Sr--. 1 root root 38 Nov 23 2018 /etc/centos-release [root@ansible ~]# ansible remote -m stat -a 'path=/etc/centos-release' remote | SUCCESS =\u003e { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python\" }, \"changed\": false, \"stat\": { \"atime\": 1687316675.220694, \"attr_flags\": \"\", \"attributes\": [], \"block_size\": 4096, \"blocks\": 8, \"charset\": \"us-ascii\", \"checksum\": \"dd9a53b0d396d3ab190cfbc08dca572d3e741a03\", \"ctime\": 1687316666.4736364, \"dev\": 64768, \"device_type\": 0, \"executable\": false, \"exists\": true, \"gid\": 0, \"gr_name\": \"root\", \"inode\": 67184137, \"isblk\": false, \"ischr\": false, \"isdir\": false, \"isfifo\": false, \"isgid\": true, \"islnk\": false, \"isreg\": true, \"issock\": false, \"isuid\": true, \"mimetype\": \"text/plain\", \"mode\": \"6644\", \"mtime\": 1542979018.0, \"nlink\": 1, \"path\": \"/etc/centos-release\", \"pw_name\": \"root\", \"readable\": true, \"rgrp\": true, \"roth\": true, \"rusr\": true, \"size\": 38, \"uid\": 0, \"version\": \"815093836\", \"wgrp\": false, \"woth\": false, \"writeable\": true, \"wusr\": true, \"xgrp\": false, \"xoth\": false, \"xusr\": false } } 2.4.9 unarchive 模块 此模块用于解包和解压缩，有两种用法：\n将 ansible 主机上的压缩文件解压至受控节点的指定路径下 将非 ansible 的其他主机的压缩文件解压到受控节点的指定路径下 常见参数：\nremote_src # yes 表示源文件在远程被控主机或非 ansible 的其它主机上，no 表示文件在ansible主机上, 默认值为 no, 此选项代替copy选项（已废弃） src #源路径，可以是 ansible 主机上的路径，也可以是远程主机(被管理端或者第三方主机)上的路径，如果是远程主机上的路径，则需要设置 remote_src=yes dest # 远程主机上的目标路径 mode # 设置解压缩后的文件权限 creates=PATH # 当PATH不存在时才会执行 范例：\n# 解压本地文件到受控节点的指定目录（目标目录不存在会报错，不会自动创建） [root@ansible ~]# ansible remote -m unarchive -a 'src=/tmp/test.tar.gz dest=/tmp/' # 解压其他主机的压缩包到受控节点 [root@ansible ~]# ansible remote -m unarchive -a 'src=https://releases.ansible.com/ansible/ansible-2.1.6.0-0.1.rc1.tar.gz dest=/tmp remote_src=yes' 2.4.10 archive 模块 此模块用于在受控节点打包压缩文件\n常见选项\npath # 压缩的文件或目录 dest # 压缩后的文件 format # 压缩格式,支持gz,bz2,xz,tar,zip 范例：\n[root@ansible tmp]# ansible remote -m archive -a 'path=/etc/redhat-release dest=/tmp/log.tar.gz format=gz' 2.4.11 hostname 模块 此模块用于修改主机名\n常见选项\nname # 要修改的目标主机名 范例：\n[root@ansible ~]# ansible remote -m hostname -a 'name=test' 2.4.12 cron 模块 此模块用于创建计划任务\n常见选项\nname # 任务名称，可以根据此名称删除对应的计划任务 minute # 分钟 hour # 小时 weekday # 周 user\t# 任务由哪个用户运行；默认root job # 任务 范例：\n# 创建一个计划任务，命名为 test [root@ansible ~]# ansible remote -m cron -a 'minute=0 hour=2 weekday=1-5 job=\"echo test\" name=hello' # 查看创建结果 [root@ansible ~]# ansible remote -a 'crontab -l' remote | CHANGED | rc=0 \u003e\u003e #Ansible: hello 0 2 * * 1-5 echo test 2.4.13 yum 和 apt 模块 此模块用于管理软件包\nyum：适用于RHEL，CentoOS，Fedora 等系统 apt：适用于Debian，Ubuntu 等系统 yum 模块常见选项\nname # 软件包名称 state # 状态 =present # 安装, 此为默认值 =absent # 删除 =latest # 最新版 list # 列出指定包 enablerepo # 启用仓库xx disablerepo # 禁用仓库xx exclude # 排除指定的包 validate # 是否检验, 默认为 yes 范例：\n# 安装 httpd ansible remote -m yum -a 'name=httpd state=present' # 删除 httpd ansible remote -m yum -a 'name=httpd state=absent' # 从网络源安装 zabbix （由于缺少其他依赖包，该命令可能执行失败） ansible remote -m yum -a 'name=https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/8/x86_64/zabbix-agent2-5.0.24-1.el8.x86_64.rpm state=present validate_certs=no' # 启用 epel 源安装 nginx ansible remote -m yum -a 'name=nginx state=present enablerepo=epel' # 明确禁用 epel 源会导致安装失败（找不到 nginx 包） ansible remote -m yum -a 'name=nginx state=present disablerepo=epel' # 安装除了 kernel* 和 foo* 匹配到的其余所有包（测试使用，谨慎执行） ansible remote -m yum -a 'name=* state=latest exclude=kerner*,foo*' # 列出所有版本的包 ansible remote -m yum -a 'list=tree' 2.4.14 yum_repository 此模块用于 yum 仓库的配置管理\n常见选项\nname # 仓库id，也是配置文件名 description # 仓库描述名称,对应配置文件中的name= baseurl # 仓库的地址 gpgcheck # 开启密钥验证 gpgkey # 仓库公钥路径 范例：\n# 添加 nginx 仓库 [root@ansible ~]# ansible remote -m yum_repository -a 'name=nginx-repo description=\"nginx repo\" baseurl=\"http://nginx.org/packages/centos/$releasever/$basearch/\" gpgcheck=yes gpgkey=\"https://nginx.org/keys/nginx_signing.key\"' # 查看添加结果 [root@ansible ~]# ansible remote -a 'cat /etc/yum.repos.d/nginx-repo.repo' remote | CHANGED | rc=0 \u003e\u003e [nginx-repo] baseurl = http://nginx.org/packages/centos/$releasever/$basearch/ gpgcheck = 1 gpgkey = https://nginx.org/keys/nginx_signing.key name = nginx repo # 删除 nginx 仓库 [root@ansible ~]# ansible remote -m yum_repository -a 'name=nginx-repo state=absent' 2.4.15 service 模块 此模块和 systemd 的功能类似，用于管理系统服务\n常见选项\nname # 服务名称 state # 服务状态 =started # 启动 =stopped # 停止 =restarted # 重启 =reloaded # 重载 enabled # 开启自启动 daemon_reload # 加载新的配置文件,适用于systemd模块 范例：\n# 启动并设置 httpd 服务开机自启动 ansible remote -m service -a 'name=httpd state=started enabled=yes' # 关闭 httpd 服务，并关闭开机自启 ansible remote -m service -a 'name=httpd state=stopped enabled=no' # 重启指定网卡服务 ansible remote -m service -a 'name=network state=restarted args=ens33' 2.4.16 user 模块 此模块用于用户管理\n常用选项\nname # 创建的名称 uid # 指定 uid group # 指定基本组 shell # 登录 shell 类型默认 /bin/bash create_home # 是否创建家目录 password # 设定对应的密码，必须是加密后的字符串才行，否则不生效 system # yes 表示系统用户 groups # 附加组 append # 追加附加组使用, yes 表示增加新的附加组 state # absent 删除 remove # yes 表示删除用户时将家目录一起删除 generate_ssh_key # 创建私钥 ssh_keyu_bits # 私钥位数 ssh_key_file # 私钥文件路径 范例：\n# 创建用户并指定相关属性（家目录会自动创建） ansible remote -m user -a 'name=test uid=1001 home=/app/test shell=/bin/sh' # 创建系统用户（uid \u003c 1000） ansible remote -m user -a 'name=test1 home=/app/test1 shell=/bin/bash system=yes' # 利用 debug 模块生成加密密码 [root@ansible ~]# ansible localhost -m debug -a 'msg={{ \"123456\" | password_hash(\"sha512\",\"salt\") }}' localhost | SUCCESS =\u003e { \"msg\": \"$6$salt$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w.igcOo1R7vBYR65JquIQ/7siC7VRpmteKvZmfSkNc69.\" } # 创建用户并指定密码（如果直接指定明文密码，执行虽然成功，但是登录时会报密码错误） ansible remote -m user -a 'name=test2 shell=/bin/bash password=$6$salt$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w.igcOo1R7vBYR65JquIQ/7siC7VRpmteKvZmfSkNc69.' # 创建用户并生成 2048 bit 的用户私钥 ansible remote -m user -a 'name=test3 generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=.ssh/id_rsa' 2.4.17 group 模块 此模块用于管理用户组\n常见选项\nname # 指定组名称 gid # 指定gid state =present # 创建, 默认 =absent # 删除 范例：\n# 创建系统用户组 ansible remote -m group -a 'name=test system=yes' # 删除组 ansible remote -m group -a 'name=test state=absent' 2.4.18 lineinfile 模块\n此模块相当于 sed ，用于对文本进行单行替换。之所以不用 sed ，是因为 ansible 对特殊符号的支持不强，实际操作时可能无法替换，且需要对符号进行转义，比较麻烦。\n常见选项\npath # 被控端文件的路径 regexp # 正则匹配字符串 line # 替换的目标内容 state # absent 表示删除 insertafter # 插入到匹配行前 insertbefore # 插入到匹配行后 backrefs # 是否支持后向引用 backup # 修改前先备份 create # 如果文件不存在, 则创建, 默认不存在会出错 mode # 指定权限 owner # 指定用户 group # 指定组 # 注意 # regexp参数：使用正则表达式匹配对应的行，当替换文本时，如果匹配到了多行，只有最后一个匹配行会被替换。当删除文本时，所有匹配到的行都会被删除。 范例：\n# 修改 httpd 服务的监听端口 ansible remote -m lineinfile -a 'path=/etc/httpd/conf/httpd.conf regexp=\"^Listen\" line=\"Listen 8080\"' # 禁用 selinux ansible remote -m lineinfile -a 'path=/etc/selinux/config regexp=\"^SELINUX=\" line=\"SELINUX=disabled\"' # 添加网关 ansible remote -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=\"GATEWAY=10.0.0.254\"' # 在最后一行添加网关配置 ansible remote -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=\"GATEWAY=10.0.0.254\"' # 验证添加结果 [root@ansible ~]# ansible remote -a 'tail -n1 /etc/sysconfig/network-scripts/ifcfg-ens33' remote | CHANGED | rc=0 \u003e\u003e GATEWAY=10.0.0.254 # 删除添加的网关配置 ansible remote -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=\"GATEWAY=10.0.0.254\" state=absent' # 添加一个网关，在 \"NAME=\" 该行前添加 ansible remote -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=\"GATEWAY=10.0.0.254\" insertbefore=\"^NAME=\"' # 查看添加结果 [root@ansible ~]# ansible remote -a 'grep -i gateway /etc/sysconfig/network-scripts/ifcfg-ens33 -A 1' remote | CHANGED | rc=0 \u003e\u003e GATEWAY=10.0.0.254 NAME=\"ens33\" 2.4.18 lineinfile 模块 此模块主要用于基于正则的单行文本匹配和替换\nansible 对特殊符号的支持不是很好，如果用 sed 进行复杂字符替换很可能出现问题，因此在进行文本替换时，最好用该模块而非sed\n常见选项\npath #被控端文件的路径 regexp #正则匹配语法格式,表示被替换的内容 line #替换为的内容 state #absent表示删除 insertafter #插入匹配行后 insertbefore #插入匹配行前 backrefs #支持后向引用, yes 和 no backup #修改前先备份 create #如果文件不存在, 则创建, 默认不存在会出错 mode #指定权限 owner #指定用户 group #指定组 #注意 regexp 参数：使用正则表达式匹配对应的行，有两种处理方式 当替换文本时，如果有多个匹配行，则只会对最后一行进行替换 当删除文本时，如果有多行文本都能被匹配，这么这些行都会被删除。 范例：\n# 关闭 selinux ansible remote -m lineinfile -a \"path=/etc/selinux/config regexp='^SELINUX=' line='SELINUX=disabled'\" # 添加 DNS 配置（最后一行） ansible remote -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=\"DNS1=8.8.8.8\"' # 添加 DNS 配置（匹配行下添加） ansible remote -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-ens33 insertafter=\"^NAME\" line=\"DNS1=8.8.8.8\"' # 删除一行 ansible remote -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=\"DNS1=8.8.8.8\" state=\"absent\"' # 删除注释行 ansible remote -m lineinfile -a 'dest=/etc/fstab state=absent regexp=\"^#\"' ### 多行相同文本，只替换最后一行 [root@ansible ~]# ansible remote -a 'cat /root/test.txt' remote | CHANGED | rc=0 \u003e\u003e a a a [root@ansible ~]# ansible remote -m lineinfile -a \"path=/root/test.txt regexp='a' line='b'\" remote | CHANGED =\u003e { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python\" }, \"backup\": \"\", \"changed\": true, \"msg\": \"line replaced\" } [root@ansible ~]# ansible remote -a 'cat /root/test.txt' remote | CHANGED | rc=0 \u003e\u003e a a b 2.4.19 replace 模块 该模块与 sed 类似，主要用于基于正则的多行文本匹配和替换\n常见选项\npath # 被控端文件的路径 regexp # 正则匹配语法格式 replace # 目标替换内容 after # 插入匹配行后 before # 插入匹配行前 backup # 修改前先备份 mode # 指定权限 owner # 指定用户 group # 指定组 范例：\nansible remote -m replace -a \"path=/etc/fstab regexp='^(UUID.*)' replace='#\\1'\" ansible remote -m replace -a \"path=/etc/fstab regexp='^#(UUID.*)' replace='\\1'\" ### 多行匹配替换 [root@ansible ~]# ansible remote -a 'cat /root/test.txt' remote | CHANGED | rc=0 \u003e\u003e b b b [root@ansible ~]# ansible remote -m replace -a \"path=/root/test.txt regexp='b' replace='a'\" remote | CHANGED =\u003e { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python\" }, \"changed\": true, \"msg\": \"2 replacements made\" } [root@ansible ~]# ansible remote -a 'cat /root/test.txt' remote | CHANGED | rc=0 \u003e\u003e a a a 2.4.20 selinux 模块 该模块用来管理 selinux 策略。根据国内使用习惯，这里主要演示如何关闭 selinux\n常见选项\npolicy # 指定SELINUXTYPE=targeted state # 指定SELINUX=disabled 范例：\n[root@ansible ~]# ansible remote -m selinux -a 'state=disabled' [WARNING]: SELinux state temporarily changed from 'enforcing' to 'permissive'. State change will take effect next reboot. remote | CHANGED =\u003e { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python\" }, \"changed\": true, \"configfile\": \"/etc/selinux/config\", \"msg\": \"\", \"policy\": \"targeted\", \"reboot_required\": true, \"state\": \"disabled\" } [root@ansible ~]# ansible remote -a \"grep -v '#' /etc/selinux/config\" remote | CHANGED | rc=0 \u003e\u003e SELINUX=disabled SELINUXTYPE=targeted [root@ansible ~]# ansible remote -a \"getenforce\" remote | CHANGED | rc=0 \u003e\u003e Permissive 2.4.21 reboot 模块 用于重启目标机器\n常见选项\nmsg # 重启提示内容 pre_reboot_delay # 重启前的延迟时间，单位：s post_reboot_delay # 重启后经过多少时间再验证系统功能是否正常，单位：s reboot_timeout #重启后延迟时间再执行测试成功与否的命令 test_command #执行测试成功与否的命令 范例：重启系统，会阻塞等待重启完成才会返回执行结果\n[root@ansible ~]# ansible remote -m reboot -a \"msg='host will be reboot'\" remote | CHANGED =\u003e { \"changed\": true, \"elapsed\": 17, \"rebooted\": true } 2.4.22 mount 模块 用于文件系统的管理\n常见选项\nsrc #源设备路径，或网络地址 path #挂载至本地哪个路径下 fstype #设备类型 opts #挂载的选项 state #挂载还是卸载 =present #永久挂载，但没有立即生效 =absent #卸载临时挂载,并删除永久挂载 =mounted #临时挂载 =unmounted #临时卸载 范例：\n# 永久卸载 [root@ansible ~]# ansible remote -m mount -a 'src=/dev/sdb path=/app state=absent' # 永久挂载，不会立即生效，仅修改/etc/fstab 文件 [root@ansible ~]# ansible remote -m mount -a 'src=/dev/sdb path=/app state=absent' fstype=xfs opts=noatime path=swap state=present' # 临时挂载 [root@ansible ~]# ansible remote -m mount -a 'src=/dev/sdb path=/app fstype=xfs opts=default state=mounted' # 临时卸载 [root@ansible ~]# ansible remote -m mount -a 'src=/dev/sdb path=/app fstype=xfs opts=default state=unmounted' opts=noatime：opts是传递给mount命令的额外选项，这里使用的是noatime，表示在读取文件时，不更新文件的最后访问时间。这可以提高文件系统的性能。默认是 default\n2.4.23 setup 模块 该模块用于收集目标主机的系统信息，在使用 ansible 时，是默认启用的。该模块收集到的信息可以通过变量引用，但是通常情况下，它会影响执行速度。如果不需要，可以显式关闭以提高执行效率。\n可以使用 gather_facts: no 来禁止 Ansible 收集 facts 信息\n常见选项\nfilter # 指定过滤条件 范例：\nansible remote -m setup ansible remote -m setup -a \"filter=ansible_nodename\" ansible remote -m setup -a \"filter=ansible_hostname\" ansible remote -m setup -a \"filter=ansible_domain\" ansible remote -m setup -a \"filter=ansible_memtotal_mb\" ansible remote -m setup -a \"filter=ansible_memory_mb\" ansible remote -m setup -a \"filter=ansible_memfree_mb\" ansible remote -m setup -a \"filter=ansible_os_family\" ansible remote -m setup -a \"filter=ansible_distribution\" ansible remote -m setup -a \"filter=ansible_distribution_major_version\" ansible remote -m setup -a \"filter=ansible_distribution_version\" ansible remote -m setup -a \"filter=ansible_processor_vcpus\" ansible remote -m setup -a \"filter=ansible_remote_ipv4_addresses\" ansible remote -m setup -a \"filter=ansible_architecture\" ansible remote -m setup -a \"filter=ansible_uptime_seconds\" ansible remote -m setup -a \"filter=ansible_processor*\" ansible remote -m setup -a 'filter=ansible_env' 2.4.24 debug 模块 此模块用于打印相关信息，类似于 print 和 echo\n常见选项\nmsg\t# 打印内容 var\t# 设置变量并赋值 verbosity # 详细级别 范例：未指定msg，默认打印 hello world\n[root@ansible ~]# ansible remote -m debug remote | SUCCESS =\u003e { \"msg\": \"Hello world!\" } 范例：打印变量值\n[root@ansible playbooks]# cat debug.yaml --- - hosts: remote gather_facts: yes tasks: - name: print value of variable debug: msg: host \"{{ ansible_nodename }}\" [root@ansible playbooks]# ansible-playbook debug.yaml PLAY [remote] *************************************************************************************** TASK [Gathering Facts] ****************************************************************************** ok: [remote] TASK [print value of variable] ********************************************************************** ok: [remote] =\u003e { \"msg\": \"host \\\"remote\\\"\" } PLAY RECAP ****************************************************************************************** remote : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 范例：通过下标打印指定对应字符\n[root@ansible playbooks]# cat debug.yaml --- - hosts: remote gather_facts: no vars: str: \"01234\" tasks: - debug: msg: - \"{{ str[0] }}\" - \"{{ str[1] }}\" - \"{{ str[2] }}\" [root@ansible playbooks]# ansible-playbook debug.yaml PLAY [remote] *************************************************************************************** TASK [debug] **************************************************************************************** ok: [remote] =\u003e { \"msg\": [ \"0\", \"1\", \"2\" ] } PLAY RECAP ****************************************************************************************** remote : ok=1 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 2.4.25 sysctl 模块 此模块用于修改内核参数\n常见选项\nname # 内核参数名 value # 指定值 state # 是否保存在sysctl.conf文件中，默认present sysctl_set #使用sysctl -w 验证值生效 范例：\n[root@ansible playbooks]# ansible remote -m sysctl -a 'name=net.ipv4.ip_forward value=1 state=present' remote | CHANGED =\u003e { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python\" }, \"changed\": true } [root@ansible playbooks]# ansible remote -a 'grep forward /etc/sysctl.conf' remote | CHANGED | rc=0 \u003e\u003e net.ipv4.ip_forward=1 其他示例：\n--- - hosts: remote gather_facts: no tasks: - name: Change Port Range sysctl: name: net.ipv4.ip_local_port_range value: '1024 65000' sysctl_set: yes - name: Enabled Forward sysctl: name: net.ipv4.ip_forward value: '1' sysctl_set: yes - name: Enabled tcp_reuse sysctl: name: net.ipv4.tcp_tw_reuse value: '1' sysctl_set: yes - name: Chanage tcp tw_buckets sysctl: name: net.ipv4.tcp_max_tw_buckets value: '5000' sysctl_set: yes - name: Chanage tcp_syncookies sysctl: name: net.ipv4.tcp_syncookies value: '1' sysctl_set: yes - name: Chanage tcp max_syn_backlog sysctl: name: net.ipv4.tcp_max_syn_backlog value: '8192' sysctl_set: yes - name: Chanage tcp Established Maxconn sysctl: name: net.core.somaxconn value: '32768' sysctl_set: yes state: present - name: Chanage tcp_syn_retries sysctl: name: net.ipv4.tcp_syn_retries value: '2' sysctl_set: yes state: present - name: Chanage net.ipv4.tcp_synack_retries sysctl: name: net.ipv4.tcp_synack_retries value: '2' sysctl_set: yes state: present 2.4.26 pam_limits 模块 此模块用于修改内核资源限制\n常见选项\nname\t# 内核参数 value\t# 指定值 state\t# 是否保存在 sysctl.conf 文件中，默认保存 sysctl_set # 使 sysctl -w 验证值生效 范例：\nansible remote -m sysctl -a 'name=net.ipv4.ip_forward value=1 state=present' 范例内核参数优化：\n--- - hosts: remote gather_facts: no vars: limits_conf_dest: '/etc/security/limits.conf' tasks: - name: Modify {{ limits_conf_dest }} pam_limits: dest: \"{{ limits_conf_dest }}\" domain: '*' limit_type: \"{{ item.limit_type }}\" limit_item: \"{{ item.limit_item }}\" value: \"{{ item.value }}\" loop: - { limit_type: 'soft', limit_item: 'nofile', value: '655350' } - { limit_type: 'hard', limit_item: 'nofile', value: '655350' } - { limit_type: 'soft', limit_item: 'nproc', value: '655350' } - { limit_type: 'hard', limit_item: 'nproc', value: '655350' } 3 Ansible Playbook 3.1 Playbook 简介 官网：Ansible playbooks — Ansible Documentation\nPlaybook 是 Ansible 中用于定义自动化任务的文本文件。它是一种声明性的描述方式，用于指定一系列步骤和配置，以便 Ansible 可以在远程主机上执行这些步骤。Playbook 可以用于配置服务器、部署应用程序、管理系统等一系列自动化任务。\n以下是 Playbook 的一些重要特点和组成部分：\n声明性描述: Playbook 采用声明性的方式描述了你要执行的任务，而不需要详细说明每个步骤的执行过程。\nYAML 格式: Playbook 是用 YAML（Yet Another Markup Language）格式编写的。YAML 格式具有良好的可读性，使得 Playbook 更易于理解和编写。\n主机清单: 在 Playbook 中，你可以指定要执行任务的目标主机。这通常通过清单文件来实现，清单文件列出了要执行任务的远程主机。\n任务: Playbook 由一个或多个任务组成，每个任务描述了一个特定的操作，如运行命令、复制文件、安装软件等。\n模块: 任务使用模块来执行实际的操作。模块是 Ansible 功能的构建块，它们封装了各种不同类型的任务，例如远程执行命令、文件操作、软件包管理等。\n变量: 你可以在 Playbook 中使用变量来存储数据，如主机名、IP 地址、配置选项等。变量可以提高可维护性和可重用性。\n条件和循环: Playbook 支持条件语句和循环，允许你在特定情况下执行不同的操作，或者在多个主机上重复执行任务。\n角色: 角色是一种组织和复用 Playbook 的方式，可以将相关任务和变量组织到一个结构化的目录中，以便更好地管理和维护。\n总之，Playbook 是 Ansible 中定义和管理自动化任务的核心部分，它使你能够以可维护且可扩展的方式管理远程主机上的配置和操作。\n3.1.1 Playbook 组成 一个 playbook(剧本)文件是一个YAML语言编写的文本文件 通常一个playbook只包括一个play 一个 play的主要包括两部分: 主机和tasks. 即实现在指定一组主机上执行一个tasks定义好的任务列表。 一个tasks中可以有一个或多个task任务 每一个Task本质上就是调用ansible的一个module 在复杂场景中,一个playbook中也可以包括多个play，实现对多组不同的主机执行不同的任务 以下是一个示例 Playbook，展示了如何通过多个 play 执行不同任务：\n--- # 这是一个 Ansible Playbook 示例，用于展示多个 play 的用法 # 第一个 play：配置 Web 服务器 - name: 配置 Web 服务器 hosts: web_servers tasks: - name: 安装 Apache yum: name: httpd state: present - name: 启动 Apache 服务 service: name: httpd state: started # 第二个 play：配置数据库服务器 - name: 配置数据库服务器 hosts: db_servers tasks: - name: 安装 MySQL yum: name: mysql-server state: present - name: 启动 MySQL 服务 service: name: mysqld state: started 在上面的示例中，我们有两个 play：\n第一个 play:\n名称：配置 Web 服务器 主机：web_servers 主机组 任务： 安装 Apache 软件包 启动 Apache 服务 第二个 play:\n名称：配置数据库服务器 主机：db_servers 主机组 任务： 安装 MySQL 软件包 启动 MySQL 服务 每个 play 都独立执行，并且可以在不同的主机组上执行不同的任务。在复杂的场景中，这种结构可以让你更有效地管理和组织自动化任务。注释中提供了每个 play 所涉及的步骤和任务的描述，以帮助你理解 Playbook 的结构和功能。\n2.1.2 Playbook 和 Ad-Hoc 对比 Ansible 提供了两种主要的操作方式：Playbook 和 Ad-Hoc 命令，用于在远程主机上执行任务。下面是它们之间的详细对比：\nPlaybook:\n描述性操作：Playbook 是用 YAML 文件编写的，以声明性的方式描述了要执行的任务和配置。它更适合用于复杂的、长期的自动化任务。\n复杂性：Playbook 支持多个主机、多个任务、变量、循环和条件等复杂的操作。它适合管理全面的配置和部署。\n结构化组织：Playbook 允许将任务组织成逻辑的 play，每个 play 都可以在特定的主机组上执行。这使得任务更加模块化和可扩展。\n可维护性：由于它是文本文件，Playbook 可以轻松地进行版本控制、文档化和共享。适合长期维护和团队协作。\n变量和模板：Playbook 支持定义变量和使用 Jinja2 模板生成配置文件，从而实现更高度的可定制性。\nAd-Hoc 命令:\n即时性操作：Ad-Hoc 命令是直接在命令行中执行的，适用于即时需要的、单次性的任务。\n命令行操作：Ad-Hoc 命令更适合临时操作，无需编写或保存文件，直接在命令行中执行。\n简单任务：它适合执行简单的、快速的任务，如查看系统状态、执行一次性命令等。\n命令模块：Ad-Hoc 命令使用命令模块来执行任务，它们比 Playbook 的模块少，功能相对有限。\n难以维护：由于命令直接在命令行中执行，Ad-Hoc 命令的可读性差，不适合长期维护和跟踪。\n不支持复杂逻辑：Ad-Hoc 命令不支持像 Playbook 中的复杂逻辑、条件判断和循环。\n选择适用场景：\n如果你需要执行复杂的多步骤任务、配置管理和自动化流程，应优先使用 Playbook。 如果你需要快速执行一次性的任务，例如系统诊断、快速检查等，可以使用 Ad-Hoc 命令。 最终，选择 Playbook 还是 Ad-Hoc 命令取决于你的任务需求、复杂性和长期维护的要求。\n3.2 Plabook 核心组件 当涉及 Ansible Playbook 的组件时，以下是每个组件的简单示例说明：\n主机清单（Inventory）示例： 主机清单文件列出了 Ansible 将要管理的主机和主机组。这是一个简单的主机清单示例：\n[web_servers] web1 ansible_host=192.168.1.10 web2 ansible_host=192.168.1.11 [db_servers] db1 ansible_host=192.168.1.20 变量（Variables）示例： 你可以在 Playbook 中使用变量来设置不同的值，以便在不同的环境中重用配置。这是一个简单的变量示例：\n--- - name: Example Playbook with Variables hosts: web_servers vars: http_port: 80 tasks: - name: Display HTTP Port debug: msg: \"HTTP port is {{ http_port }}\" 任务（Tasks）示例： 任务是 Playbook 中的操作单元，由模块组成。这是一个简单的任务示例：\n--- - name: Example Task hosts: web_servers tasks: - name: Ensure Apache is installed yum: name: httpd state: present 处理配置（Handlers）示例： 处理配置用于在任务执行后触发一些操作，通常用于重新启动服务或重新加载配置。这是一个简单的处理配置示例：\n--- - name: Example Playbook with Handlers hosts: web_servers tasks: - name: Ensure Apache is installed yum: name: httpd state: present notify: - Restart Apache handlers: - name: Restart Apache service: name: httpd state: restarted 剧本（Play）示例： 剧本由一个或多个任务组成，用于在一组主机上执行操作。这是一个包含多个任务的剧本示例：\n--- - name: Example Play hosts: web_servers tasks: - name: Ensure Apache is installed yum: name: httpd state: present - name: Copy index.html copy: src: /path/to/index.html dest: /var/www/html/ 在每个示例中，我提供了一个基本的演示，说明了每个组件的用法和作用。这应该有助于你更好地理解 Ansible Playbook 的不同组件以及它们是如何一起工作的。\n3.3 Playbook 命令 命令格式\nansible-playbook ... [options] 常见选项\n--syntax,--syntax-check # 语法检查,功能相当于bash -n -C --check # 模拟执行 dry run ，只检测可能会发生的改变，但不真正执行操作 --list-hosts # 列出运行任务的主机 --list-tags # 列出 tag --list-tasks # 列出 task --limit HOST_NAME # 只针对主机列表中的特定主机执行 -i INVENTORY_PATH, --inventory INVENTORY_PATH # 指定主机清单文件, 通常一个项对应一个主机清单文件 --start-at-task START_AT_TASK # 从指定 task 开始执行, 而非从头开始, START_AT_TASK为任务的 name -v -vv -vvv # 显示过程 范例：打印 hello world\n[root@ansible playbooks]# cat hello.yaml --- - hosts: remote gather_facts: no # 不收集目标主机信息，加快执行速度 tasks: - name: hello command: echo \"hello world!\" [root@ansible playbooks]# ansible-playbook hello.yaml 示例：\n# 列出 playbook 中的主机 [root@ansible playbooks]# ansible-playbook hello.yaml --list-hosts playbook: hello.yaml play #1 (remote): remote\tTAGS: [] pattern: [u'remote'] hosts (1): remote # 列出 playbook 中的任务 [root@ansible playbooks]# ansible-playbook hello.yaml --list-tasks playbook: hello.yaml play #1 (remote): remote\tTAGS: [] tasks: hello\tTAGS: [] 3.4 ignore_errors 在 playbook 执行时，如果某个 task 出错，则后续任务不会再执行\n[root@ansible playbooks]# cat test_ignore.yaml --- - hosts: remote gather_facts: no tasks: - name: task1 command: /bin/false ignore_errors: yes # 忽略该task的报错，继续执行后续任务 - name: task2 command: echo \"hello world!\" - hosts: remote gather_facts: no tasks: - name: task3 command: /bin/false # 此步骤报错，不再执行后续任务 - name: task4 command: echo \"END---\" #实际运行效果：task4不会执行 [root@ansible playbooks]# ansible-playbook test_ignore.yaml PLAY [remote] *********************************************************************** TASK [task1] ************************************************************************ fatal: [remote]: FAILED! =\u003e {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": true, \"cmd\": [\"/bin/false\"], \"delta\": \"0:00:00.272950\", \"end\": \"2023-08-23 16:10:01.027320\", \"msg\": \"non-zero return code\", \"rc\": 1, \"start\": \"2023-08-23 16:10:00.754370\", \"stderr\": \"\", \"stderr_lines\": [], \"stdout\": \"\", \"stdout_lines\": []} ...ignoring TASK [task2] ************************************************************************ changed: [remote] PLAY [remote] *********************************************************************** TASK [task3] ************************************************************************ fatal: [remote]: FAILED! =\u003e {\"changed\": true, \"cmd\": [\"/bin/false\"], \"delta\": \"0:00:00.276205\", \"end\": \"2023-08-23 16:10:02.161360\", \"msg\": \"non-zero return code\", \"rc\": 1, \"start\": \"2023-08-23 16:10:01.885155\", \"stderr\": \"\", \"stderr_lines\": [], \"stdout\": \"\", \"stdout_lines\": []} PLAY RECAP ************************************************************************** remote : ok=2 changed=2 unreachable=0 failed=1 skipped=0 rescued=0 ignored=1 3.5 handlers 和 notify Handlers 本质是 task list ，类似于 MySQL 中的触发器触发的行为，其中的 task 与前述的 task 并没有本质上的不同，只有在关注的资源发生变化时，才会采取一定的操作。\nNotify 对应的 action 在所有 task 都执行完才会最后被触发，这样可避免多个 task 多次改变发生时每次都触发执行指定的操作，Handlers 仅在所有的变化发生完成后一次性地执行指定操作。\n在 notify 中列出的操作称为 handler ，也即 notify 中调用 handler 中定义的操作\n注意:\n如果多个 task 通知了相同的handlers， 此handlers仅会在所有task结束后运行一 次。 只有 notify 对应的 task 发生改变了才会通知 handlers，没有改变则不会触发handlers handlers 是在所有前面的 tasks 都成功执行才会执行，如果前面任何一个 task 失败，会导致 handler 跳过执行 示例：执行两个 handle\n--- - hosts: remote gather_facts: no tasks: - name: task1 command: /bin/true notify: # 触发 handlers 中的任务执行 - get up - go to school handlers: - name: get up debug: msg: \"Get it\" - name: go to school debug: msg: \"I am going to school\" [root@ansible playbooks]# ansible-playbook test.yaml PLAY [remote] ****************************************************************** TASK [task1] ******************************************************************* changed: [remote] RUNNING HANDLER [get up] ******************************************************* ok: [remote] =\u003e { \"msg\": \"Get it\" } RUNNING HANDLER [go to school] ************************************************* ok: [remote] =\u003e { \"msg\": \"I am going to school\" } PLAY RECAP ********************************************************************* remote : ok=3 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 如果有任意一个task 执行失败，handlers 中的任务不会执行（即使加了ignore_errors），此时可以加上force_handlers: yes来强制执行 handlers\n--- - hosts: remote gather_facts: no force_handlers: yes # 忽略任一 task 执行报错，继续其他 task 及其 handler tasks: - name: task1 command: /bin/true notify: # 触发 handlers 中的任务执行 - get up - name: task2 command: /bin/false notify: - go to school\t# 由于task2 报错，不会通知相应的handler执行 handlers: - name: get up debug: msg: \"Get it\" - name: go to school debug: msg: \"I am going to school\" [root@ansible playbooks]# ansible-playbook test.yaml PLAY [remote] ****************************************************************** TASK [task1] ******************************************************************* changed: [remote] TASK [task2] ******************************************************************* fatal: [remote]: FAILED! =\u003e {\"changed\": true, \"cmd\": [\"/bin/false\"], \"delta\": \"0:00:00.273631\", \"end\": \"2023-08-24 08:52:38.649403\", \"msg\": \"non-zero return code\", \"rc\": 1, \"start\": \"2023-08-24 08:52:38.375772\", \"stderr\": \"\", \"stderr_lines\": [], \"stdout\": \"\", \"stdout_lines\": []} RUNNING HANDLER [get up] ******************************************************* ok: [remote] =\u003e { \"msg\": \"Get it\" } PLAY RECAP ********************************************************************* remote : ok=2 changed=1 unreachable=0 failed=1 skipped=0 rescued=0 ignored=0 3.6 Playbook 中使用 tags Tags — Ansible Documentation\n默认情况下，ansible 会执行 playbook 中的所有任务。根据需要，可以给指定的 task 指定标签，即 tag，而后在执行 playbook 时，带上对应的 tag 以运行指定的 task。\n一个 task 可以有多个 tag 内置的 tag 有： tagged，untagged 和 all，它们分别是仅运行有tag，没有tag的任务和所有任务。 范例：\n[root@ansible playbooks]# cat test_tags.yml --- - hosts: remote remote_user: root gather_facts: no tasks: - name: task1 debug: msg: \"task1\" tags: - tag1 - tag_one - name: task2 debug: msg: \"task2\" - name: task3 debug: msg: \"task3\" # 列出所有 tag [root@ansible playbooks]# ansible-playbook test_tags.yml --list-tags playbook: test_tags.yml play #1 (remote): remote\tTAGS: [] TASK TAGS: [tag1, tag_one] # 只运行带有 tag1 的 task [root@ansible playbooks]# ansible-playbook test_tags.yml -t tag1 PLAY [remote] ****************************************************************** TASK [task1] ******************************************************************* ok: [remote] =\u003e { \"msg\": \"task1\" } PLAY RECAP ********************************************************************* remote : ok=1 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 # 只运行没有 tag 的 task [root@ansible playbooks]# ansible-playbook test_tags.yml -t untagged PLAY [remote] ****************************************************************** TASK [task2] ******************************************************************* ok: [remote] =\u003e { \"msg\": \"task2\" } TASK [task3] ******************************************************************* ok: [remote] =\u003e { \"msg\": \"task3\" } PLAY RECAP ********************************************************************* remote : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 # 不执行有特定 tag 的 task [root@ansible playbooks]# ansible-playbook test_tags.yml --skip-tags tag_one # 不执行没有 tag 的 task [root@ansible playbooks]# ansible-playbook test_tags.yml --skip-tags untagged 3.7 Playbook 中使用变量 在 Ansible 中，setup 模块用于收集有关远程主机的各种信息，这些信息被称为 “facts”。这些 facts 包括有关操作系统、硬件、网络、内存、CPU 等的信息，可以用于编写更加灵活和动态的剧本。使用 setup 模块可以通过 Ansible 收集远程主机的 facts。调用 playbook 时默认调用此模块，可通过 gather_facts: no 来禁止。\n变量命令规则：由字母，数字，下划线组成且只能以字母开头\n变量调用方式：通过 {{ VARIBLE_NAME }} 调用变量，建议变量名前后加空格，且有时需要以双引号包裹 ”{{ VARIBLE_NAME }}“ （如：debug 模块中）\n变量来源：\nansible 的 setup 模块收集的 facts 变量\n通过命令行指定变量，优先级最高\nansible-playbook my_playbook.yml -e \"my_variable=value\" 在 playbook 中定义\n- name: Example Playbook hosts: servers vars: my_var: \"Hello, Ansible!\" tasks: - name: Display variable debug: var: my_var 在独立的YAML文件中定义，然后通过关键字 vars_files 引入\n- hosts: remote vars_fiels: - my_vars.yml 在主机清单文件中定义\n主机变量： 在主机清单（Inventory）中定义的变量，优先级高于组变量\n[my_hosts] host1 my_variable=host_value 组变量： 在主机清单中的组级别定义的变量。\n[my_group:vars] my_variable=group_value 在项目中针对主机和主机组定义\n在项目目录下创建 host_vars 和 group_vars 目录，在其中新建 YAML 文件定义变量\n在 role （角色）中定义\n在 Ansible 角色中，变量也有优先级，类似于 Ansible 的其他变量。角色内的变量可以分为几个不同的级别，优先级从高到低排列如下：\n角色任务变量（Role Task Variables）：这些变量在角色内的任务中定义，并且只在特定任务中生效。这些变量的优先级最高，会覆盖其他级别的变量。\n在角色任务中定义的变量，通常存储在任务中的 vars 部分：\n- name: Example role task debug: msg: \"This is a task with a role-level variable\" vars: task_variable: value 角色默认变量（Role Default Variables）：角色的默认变量存储在角色的 defaults 目录下。这些变量在角色内部被认为是默认设置，除非被其他级别的变量覆盖。\n角色默认变量存储在 roles/role_name/defaults/main.yml 文件中。\n角色变量（Role Variables）：在使用角色时，可以在主剧本中为角色设置变量。这些变量可以影响角色中的任务和默认变量。\n在主剧本中为角色设置变量的方式如下：\n- name: Playbook using a role hosts: target_hosts roles: - role: role_name vars: role_var: value 主机清单中的变量（Inventory Variables）：在主机清单中为主机或主机组定义的变量。这些变量在角色内也可以使用，但是其优先级较低。\n在主机清单中为主机定义变量的方式如下：\n[target_hosts] host1 ansible_ssh_host=192.168.1.1 role_var=value 变量优先级从高到低如下：\n1. 命令行 -e 传递的变量 2. playbook 中 2.1 vars_files 引入的变量 2.1 playbook 中 vars 变量定义 3. host_vars/主机名文件 4. 主机清单中的主机变量 5. group_vars 5.1 主机组名文件 5.2 all.yml 6. 主机清单中的组变量 总的来说，变量定义方式多而杂，实际使用时应避免在多个地方定义同一个变量，降低复杂度，从而降低维护成本，减少出错的可能性。\n3.7.1 使用 setup 模块中的变量 3.7.1.1 使用 facts 变量 本模块自动在playbook调用，生成的系统状态信息, 并将之存放在facts变量中\nfacts 包括的信息很多,如: 主机名, IP, CPU, 内存, 网卡等\nfacts 变量的实际使用场景案例\n通过facts变量获取被控端CPU的个数信息，从而生成不同的Nginx配置文件\n通过facts变量获取被控端内存大小信息，从而生成不同的memcached的配置文件\n通过facts变量获取被控端主机名称信息，从而生成不同的Zabbix配置文件\n通过facts变量获取被控端网卡信息，从而生成不同的主机名\n……\n范例：\n# 获取网卡信息 [root@ansible playbooks]# ansible localhost -m setup -a 'filter=\"ansible_default_ipv4\"' localhost | SUCCESS =\u003e { \"ansible_facts\": { \"ansible_default_ipv4\": { \"address\": \"192.168.146.128\", \"alias\": \"ens33\", \"broadcast\": \"192.168.146.255\", \"gateway\": \"192.168.146.254\", \"interface\": \"ens33\", \"macaddress\": \"00:0c:29:c6:1a:98\", \"mtu\": 1500, \"netmask\": \"255.255.255.0\", \"network\": \"192.168.146.0\", \"type\": \"ether\" } }, \"changed\": false } # 查看主机名 [root@ansible playbooks]# ansible localhost -m setup -a 'filter=\"ansible_nodename\"' localhost | SUCCESS =\u003e { \"ansible_facts\": { \"ansible_nodename\": \"ansible\" }, \"changed\": false } # 根据主机名生成日志文件 [root@ansible playbooks]# vim touch_host_log.yaml [root@ansible playbooks]# ansible-playbook touch_host_log.yaml [root@ansible playbooks]# ansible remote -a 'ls /tmp/remote.log' remote | CHANGED | rc=0 \u003e\u003e /tmp/remote.log # 获取网卡地址 [root@ansible playbooks]# cat show_ip_of_eth0.yaml --- - hosts: remote tasks: - name: show ens33 ip address of {{ ansible_facts[\"eth0\"][\"ipv4\"][\"address\"] }} debug: msg: Ip address {{ ansible_facts.ens33.ipv4.address }} - name: another way debug: Ip address {{ ansible_facts[\"ens33\"][\"ipv4\"][\"address\"] }} [root@ansible playbooks]# ansible-playbook show_ip_of_eth0.yaml PLAY [remote] ****************************************************************** TASK [Gathering Facts] ********************************************************* ok: [remote] TASK [show ens33 ip address of {{ ansible_facts[\"eth0\"][\"ipv4\"][\"address\"] }}] *** ok: [remote] =\u003e { \"msg\": \"Ip address 192.168.146.129\" } TASK [another way] ************************************************************* ok: [remote] =\u003e { \"msg\": \"Hello world!\" } PLAY RECAP ********************************************************************* remote : ok=3 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 3.7.1.2 性能优化 执行 playbook 时，默认启用 setup 模块收集目标主机的 facts 变量，会耗费一定时间。可选则以下两种方式进行配置\n如果不需要使用到目标主机的变量信息，可以通过 gather_facts: no 选项来关闭此行为\n--- - hosts: all gather_facts: no 在 Ansible 中，“facts 缓存” 是指将主机的事实数据（例如主机名、操作系统信息、IP 地址等）缓存起来，以便在后续的 Ansible 运行中重用这些数据，从而减少系统资源的使用和提高执行效率。\n要启用 Ansible 的 Facts 缓存功能，你可以在 Ansible 配置文件中进行设置。默认情况下，Ansible 将事实数据存储在内存中，但你也可以选择将其存储在磁盘上以实现持久性。\n以下是启用 Ansible Facts 缓存的配置示例：\n存储在内存中： 在 Ansible 配置文件中（通常是 /etc/ansible/ansible.cfg 或 ~/.ansible.cfg），添加以下配置行：\n[defaults] gathering = smart fact_caching = memory 存储在磁盘上： 要将 Facts 存储在磁盘上，你需要选择一个目录来保存缓存数据。在 Ansible 配置文件中添加以下配置行：\n[defaults] gathering = smart fact_caching = jsonfile fact_caching_connection = /path/to/cache_directory 将 /path/to/cache_directory 替换为你想要存储 Facts 缓存数据的实际目录路径。\n完成配置后，重新运行 Ansible 命令，它将使用 Facts 缓存来加速执行过程。\n请注意，以上配置示例适用于 Ansible 版本较新的情况。在特定的 Ansible 版本中，配置选项可能会有所不同。在使用前，请确保查阅与你所使用的 Ansible 版本相匹配的官方文档或手册。\n3.7.2 命令行中给 playbook 传递变量 在 Ansible 的 ansible-playbook 命令行中，可以使用 -e 选项来传递额外的变量给 playbook。这可以让你在运行 playbook 时动态地指定变量的值，而不必修改 playbook 文件本身。以下是传递变量的几种方式：\n传递单个变量：\nansible-playbook -e \"variable_name=variable_value\" playbook.yml 传递多个变量：\n如果你想传递多个变量，可以使用多个 -e 选项或者将多个变量放在一个引号中，用空格或逗号分隔。\nansible-playbook -e \"variable1=value1 variable2=value2\" playbook.yml 或者：\nansible-playbook -e \"variable1=value1\" -e \"variable2=value2\" playbook.yml 传递 yaml 变量文件\n假设你的 YAML 文件 vars.yml 如下：\n#vars.yml my_variable: \"Hello, Ansible!\" database_host: \"db.example.com\" database_port: 3306 通过 -e 选项传递此文件中的变量\nansible-playbook -e @vars.yaml playbook.yml 传递 JSON 文件：\n你也可以将变量保存在一个 JSON 格式的文件中，然后使用 -e 选项传递文件路径。\nansible-playbook -e @variables.json playbook.yml 其中，variables.json 是一个包含变量的 JSON 文件。\n无论你选择哪种方式，传递的变量都可以在 playbook 中使用，例如：\n[root@ansible playbooks]# cat playbook.yml --- - name: Example Playbook gather_facts: no hosts: remote tasks: - debug: var: my_variable [root@ansible playbooks]# ansible-playbook -e @vars.yaml playbook.yml PLAY [Example Playbook] ******************************************************** TASK [debug] ******************************************************************* ok: [remote] =\u003e { \"my_variable\": \"Hello, Ansible!\" } PLAY RECAP ********************************************************************* remote : ok=1 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 在这个例子中，my_variable 变量的值将根据在命令行中传递的值进行设定。\n3.7.3 在 playbook 文件中定义变量 在Playbook级别定义变量：\n在Playbook中，你可以使用vars关键字来定义变量。这些变量将在整个Playbook中可用。\n--- - name: Example Playbook hosts: my_hosts vars: variable_name: variable_value tasks: - name: Task using variable debug: var: variable_name 变量之间相互引用:\n--- - name: Example Playbook hosts: localhost vars: remote_ip: \"{{ ansible_default_ipv4.address }}\" tasks: - name: Task using variable debug: var: remote_ip 3.7.4 在外部变量文件中定义变量： vars_files 中的文件路径是相对于当前工作目录的。如果变量文件位于 Playbook 文件的同一目录中，你可以直接提供文件名，如 vars_files: vars.yml。如果在其他目录中，就需要提供完整的相对或绝对路径。\n将变量存储在外部文件中，然后在Playbook中导入这些变量。这在需要共享变量的多个Playbook之间很有用。\n--- - name: Example Playbook hosts: my_hosts vars_files: - vars.yml tasks: - name: Task using variable debug: var: variable_name 外部变量文件 vars.yml 的内容：\nvariable_name: variable_value 3.7.5 在主机清单中定义变量 在Ansible中，你可以为主机和主机组定义变量，以便在Playbooks中使用这些变量来控制任务的行为。这有助于实现更灵活的配置和动态性。下面是关于如何在Ansible中为主机和主机组定义变量的详细信息：\n主机变量：\n你可以为每个具体的主机定义变量，这些变量只适用于该主机。在Ansible的Inventory文件（通常是INI格式或YAML格式）中，你可以像这样为主机定义变量：\nINI格式：\n[my_hosts] host1 ansible_ssh_host=192.168.1.1 [my_hosts:vars] some_variable=some_value YAML格式：\nmy_hosts: hosts: host1: ansible_ssh_host: 192.168.1.1 vars: some_variable: some_value 主机组变量：\n你可以为主机组定义变量，这些变量将应用于该主机组中的所有主机。同样，在Inventory文件中，你可以为主机组定义变量：\nINI格式：\n[my_hosts] host1 ansible_ssh_host=192.168.1.1 host2 ansible_ssh_host=192.168.1.2 [my_hosts:vars] some_variable=some_value YAML格式：\nmy_hosts: hosts: host1: ansible_ssh_host: 192.168.1.1 host2: ansible_ssh_host: 192.168.1.2 vars: some_variable: some_value 使用变量：\n在Playbook中，你可以使用定义的主机变量和主机组变量。例如：\n--- - name: Example Playbook hosts: my_hosts tasks: - name: Task using host variable debug: var: hostvars[inventory_hostname]['some_variable'] - name: Task using host group variable debug: var: groupvars['my_hosts']['some_variable'] - name: normal use debug: var: some_variable 上述代码中，hostvars[inventory_hostname]['some_variable'] 用于访问特定主机的变量，而 groupvars['my_hosts']['some_variable'] 用于访问主机组的变量。\n通过这些方法，你可以在Ansible中为主机和主机组定义变量，从而实现更加动态和可配置的Playbooks。\n3.7.6 host_vars 和 group_vars 在 Ansible 中，host_vars 和 group_vars 是用于管理主机和主机组变量的特殊目录。这些目录允许你在不同的级别为主机和主机组定义变量，以便在你的 Ansible 任务中使用。这样，你可以根据需要为不同的主机或主机组配置特定的变量值，而不必在每个任务中都手动指定这些值。\n以下是关于 host_vars 和 group_vars 的更详细介绍和使用方法：\n1. host_vars： host_vars 目录用于为单个主机定义变量。在这个目录下，你可以为每个主机创建一个单独的 YAML 文件，文件名与主机的名称匹配。这些变量将仅应用于特定的主机。\n目录结构示例：\n. ├── inventory.ini ├── host_vars │ ├── server1.yml │ ├── server2.yml │ └── ... └── group_vars ├── group1.yml ├── group2.yml └── ... 2. group_vars： group_vars 目录用于为主机组定义变量。主机组是在 Ansible 主机清单文件（通常是 inventory.ini）中定义的。你可以为每个主机组创建一个单独的 YAML 文件，文件名与主机组的名称匹配。这些变量将应用于主机组中的所有主机。\n使用方法：\n在你的 Ansible 项目目录中创建 host_vars 和 group_vars 目录。\n在 host_vars 目录中创建一个或多个 YAML 文件，每个文件对应一个主机，并在其中定义你希望在这些主机上使用的变量。\n在 group_vars 目录中创建一个或多个 YAML 文件，每个文件对应一个主机组，并在其中定义你希望在这些主机组上使用的变量。\n在 Ansible 主机清单文件（通常是 inventory.ini）中，将主机分配给相应的主机组。\n在你的 Ansible 任务中，你可以直接使用这些变量，Ansible 会自动加载它们。\n示例：\n假设你有两台主机：webserver1 和 webserver2，你还有一个主机组：webservers。你想要为每个主机和主机组定义一些变量。\nhost_vars/webserver1.yml:\n# host_vars/webserver1.yml app_port: 8080 app_env: production host_vars/webserver2.yml:\n# host_vars/webserver2.yml app_port: 8000 app_env: staging group_vars/webservers.yml:\n# group_vars/webservers.yml app_user: webuser app_path: /var/www/app inventory.ini:\n[webservers] webserver1 webserver2 playbook.yml:\n--- - name: Configure web servers hosts: webservers tasks: - name: Display app settings debug: msg: \"App running on port {{ app_port }} with environment {{ app_env }}. User: {{ app_user }} Path: {{ app_path }}\" 在这个示例中，webserver1 和 webserver2 分别有各自的变量，而 webservers 主机组共享了相同的变量。在任务中，你可以直接使用这些变量，Ansible 会将它们与相应的主机或主机组关联起来。\n使用 host_vars 和 group_vars 可以使你的 Ansible 项目更有结构，更易于维护，因为你可以将变量与主机和主机组关联起来，而不必在每个任务中都重复定义。\n3.7.7 register 在 Ansible 中，register 是一个用于捕获任务执行结果的关键字。通过使用 register，你可以将任务的输出、返回值或其他信息保存到一个变量中，以便后续任务可以使用这些信息。这在处理任务的输出、错误处理和条件执行方面非常有用。\n使用方法：\n在 Ansible playbook 的任务中，你可以使用 register 来捕获任务的输出。以下是一个基本的用法示例：\n--- - name: Execute a command hosts: myhosts tasks: - name: Run a command and capture the output command: echo \"Hello, Ansible!\" register: command_output - name: Display the captured output debug: var: command_output.stdout 在这个示例中，register: command_output 将捕获 echo 命令的输出，并将其保存在 command_output 变量中。接下来的任务使用 debug 模块来显示这个变量的值。\nregister 变量对象中包含多个属性，你可以根据需要使用它们。一些常用的属性包括：\nstdout：捕获任务的标准输出内容。 stderr：捕获任务的标准错误输出内容。 rc：捕获任务的返回代码（退出状态码）。 changed：指示任务是否导致了变化（True 或 False）。 以下是一个更复杂的示例，演示如何根据 register 变量的值来执行不同的任务：\n--- - name: Check if a file exists hosts: myhosts tasks: - name: Check file existence stat: path: /path/to/file.txt register: file_status - name: Display file status debug: msg: \"File exists: {{ file_status.stat.exists }}\" when: file_status.stat.exists - name: Create the file if it doesn't exist file: path: /path/to/file.txt state: touch when: not file_status.stat.exists 在这个示例中，首先使用 stat 模块检查文件是否存在，并将结果保存在 file_status 变量中。接下来的两个任务根据 file_status 的值来执行不同的操作：如果文件存在，则显示一条消息；如果文件不存在，则创建文件。\n总之，register 是 Ansible 中非常有用的功能，可以捕获任务的输出和状态，并在 playbook 中进行进一步的处理、判断和控制流程。\n3.8 Jinja2 模板的介绍和使用 Jinja2 是一种模板引擎，广泛用于将动态内容嵌入静态文本中，例如在配置文件、报告生成和文档自动生成等领域。在 Ansible 中，Jinja2 用于处理变量、条件语句和循环，以生成动态的配置文件和任务。\n基本概念：\nJinja2 模板引擎基于 Python，它允许你在文本中插入动态值、执行条件判断和循环操作。模板使用双大括号 {{ }} 来表示变量，{% %} 来表示控制语句，如条件和循环。\n使用方法：\n以下是一些常见的 Jinja2 模板用法示例：\n1. 插入变量：\nHello, {{ name }}! 这将会将 name 变量的值插入到文本中。\n2. 使用条件语句：\n{% if age \u003e 18 %} You are an adult. {% else %} You are not yet an adult. {% endif %} 根据条件判断来显示不同的文本。\n3. 循环：\n{% for item in items %} - {{ item }} {% endfor %} 在循环中遍历列表 items 并为每个项目生成文本。\n4. 过滤器：\n{{ text | upper }} 使用过滤器将文本转换为大写。\n在 Ansible 中的应用：\n在 Ansible Playbooks 和模板中，你可以使用 Jinja2 来动态生成配置文件、任务和变量。例如，你可以在配置文件模板中插入主机和变量信息，然后使用 Ansible 将模板渲染为实际的配置文件。\n示例：\n假设你有一个 web_servers 主机组，并且你想为每台主机生成一个 Nginx 配置文件，其中包含主机的 IP 和端口信息。\nnginx.conf.j2 模板文件：\nserver { listen {{ nginx_port }}; server_name {{ ansible_host }}; location / { proxy_pass http://{{ ansible_host }}:{{ app_port }}; } } playbook.yml 文件：\n--- - name: Generate Nginx configs hosts: web_servers tasks: - name: Render Nginx config template: src: nginx.conf.j2 dest: /etc/nginx/sites-available/{{ ansible_host }} 在这个示例中，nginx.conf.j2 是一个 Jinja2 模板文件，使用了变量和控制语句来动态生成 Nginx 配置文件。template 模块会将模板渲染为实际的配置文件，放置在 /etc/nginx/sites-available 目录下，文件名与主机名相同。\n总结：\nJinja2 是一个强大的模板引擎，可以在 Ansible 中用于生成动态内容，从而提高配置管理和自动化部署的灵活性和效率。通过使用 Jinja2，你可以根据需要将变量、条件和循环嵌入到文本中，生成符合要求的配置和任务。\n3.9 循环和迭代 3.7.8 loop 在 Ansible 中，迭代和循环是非常重要的概念，它们允许你对一组主机或一组数据执行相同的操作。Ansible 提供了多种方法来实现迭代和循环，其中最常用的方法是使用 loop 关键字或 with_* 关键字系列。\n以下是 Ansible 中实现迭代和循环的一些方法：\n使用 loop 关键字： loop 关键字允许你在任务级别循环执行任务。你可以将其与 items 参数结合使用，传递一个列表或字典，然后在每次迭代中访问该列表或字典的元素。\n- name: Loop example debug: msg: \"Item: {{ item }}\" loop: - item1 - item2 - item3 使用 with_items： 在旧版本的 Ansible 中，你可能会看到 with_items 关键字，它在较新版本中已被 loop 替代（ansible 2.5+），但在一些旧代码中仍然可能会使用。\n- name: Loop example (with_items) debug: msg: \"Item: {{ item }}\" with_items: - item1 - item2 - item3 使用其他 with_* 关键字： Ansible 提供了多个 with_* 关键字，例如 with_dict、with_fileglob、with_sequence 等，用于在不同情况下进行循环操作。\n- name: Looping with a dictionary debug: msg: \"Key: {{ item.key }}, Value: {{ item.value }}\" with_dict: key1: value1 key2: value2 key3: value3 这些示例只是介绍了 Ansible 中迭代和循环的基本概念。你可以根据自己的需要，结合 Ansible 的模块和功能，更复杂地实现迭代和循环操作。无论你是在处理主机还是数据集，迭代和循环都能帮助你更高效地管理和配置系统。\n3.7.9 until 在Ansible中，“until” 是一个用于控制循环执行任务的关键字。它通常与 “register”（用于存储任务执行结果）和一些条件一起使用，以便在满足特定条件之前重复执行某个任务。“until” 的主要作用是允许任务在达到预期状态之前重试，直到满足特定条件为止。\n以下是 “until” 关键字的基本语法：\n- name: Retry a task until a condition is met some_module: # Replace with the actual module you're using # module arguments... register: result # Store the task execution result in the 'result' variable until: result is success # The condition to check, can be customized based on the task result retries: 10 # Number of times to retry the task delay: 10 # Time (in seconds) to wait between retries 在上面的示例中，“some_module” 是要执行的任务模块，“result” 是用于存储任务执行结果的变量。通过 “until” 关键字，你可以指定一个条件来检查任务执行结果是否满足预期。如果条件不满足，任务将在 “retries” 次数内重复执行，每次重试之间会等待 “delay” 秒。\n这是一个更具体的示例，假设你要等待某个服务启动成功后才继续执行后续任务：\n- name: Start the service systemd: name: my-service state: started register: service_result - name: Wait for the service to be up wait_for: host: localhost port: 8080 until: service_result is success retries: 10 delay: 5 在这个示例中，首先使用 “systemd” 模块启动了一个名为 “my-service” 的服务，并将结果存储在 “service_result” 变量中。接下来，使用 “wait_for” 模块等待 localhost 的 8080 端口开放，直到 “service_result” 变量的值变为 “success”，或者达到最大重试次数为止。\n请注意，“until” 并不是所有Ansible模块都支持的参数，只有部分模块（如 “wait_for”、“command” 等）允许在任务级别使用 “until” 来执行条件判断和循环操作。\n3.7.10 with_lines 在 Ansible 中，with_lines 是一个用于在任务中遍历文本行的循环构造。它允许你将每一行作为一个迭代项，以便在每次迭代中执行任务。\n以下是 with_lines 的基本语法：\n- name: Perform tasks with each line of a file some_module: # Replace with the actual module you're using # module arguments... with_lines: - /path/to/file.txt # Path to the file containing lines to iterate over 在上述示例中，some_module 是要执行的任务模块，/path/to/file.txt 是包含要迭代的文本行的文件的路径。\n这是一个更具体的示例，假设你有一个文本文件，其中包含一些IP地址，你想使用 ping 命令对每个IP地址执行网络连接测试：\n- name: Ping each IP address from a file ping: with_lines: - /path/to/ip_addresses.txt 在这个示例中，ping 模块将会对文件 /path/to/ip_addresses.txt 中的每个IP地址执行网络连接测试。Ansible会将文件的每一行作为一个迭代项传递给 ping 模块。\n需要注意的是，with_lines 在处理大型文件时可能会导致性能问题，因为它需要一次性读取整个文件并将其加载到内存中。如果文件较大，你可能需要考虑使用更适合的方法，例如将文件内容存储在变量中，然后使用循环结构遍历变量。\n另外，从 Ansible 2.5 版本开始，with_lines 已被弃用，建议使用 loop 构造代替。以下是如何使用 loop 来完成上述示例：\n- name: Ping each IP address from a file ping: loop: \"{{ lookup('file', '/path/to/ip_addresses.txt').splitlines() }}\" 在这个示例中，lookup('file', '/path/to/ip_addresses.txt').splitlines() 将会读取文件中的内容，并使用换行符将其拆分为行的列表，然后使用 loop 对每个IP地址执行 ping 模块。这种方法更为灵活且不会一次性加载整个文件。\n3.10 条件判断 when 在 Ansible 中，when 是一个条件语句，它允许你在任务执行之前指定一个条件，只有当条件满足时，任务才会被执行。这可以用于根据不同的情况来决定是否跳过或执行某个任务。\n以下是 when 的基本语法：\n- name: Perform a task conditionally some_module: # Replace with the actual module you're using # module arguments... when: condition # The condition to check before executing the task 在上述示例中，some_module 是要执行的任务模块，condition 是一个表达式，只有在表达式评估为 true 时，任务才会被执行。\n这是一个更具体的示例，假设你只想在操作系统是 Ubuntu 时才执行特定的任务：\n- name: Install a package only on Ubuntu apt: name: some-package state: present when: ansible_distribution == 'Ubuntu' 在这个示例中，apt 模块用于安装软件包，但是只有当 Ansible 变量 ansible_distribution 的值为 ‘Ubuntu’ 时，任务才会被执行。\nwhen 表达式可以是 Ansible 变量、事实（facts）、比较操作、逻辑运算等。你可以根据需要来创建复杂的条件来决定任务是否应该被执行。例如：\n- name: Perform a task only if a certain variable is true some_module: # module arguments... when: my_variable == true - name: Perform a task only if a file exists some_module: # module arguments... when: ansible_facts['file_exists'] == true - name: Perform a task only if multiple conditions are true some_module: # module arguments... when: ansible_os_family == 'Debian' and ansible_distribution_version | version_compare('9', '\u003e=') 请注意，when 是一个在任务级别使用的参数，它适用于单个任务。如果你希望在剧本（playbook）级别上设置条件，可以在每个任务中使用 block 结构，然后在 block 结构上使用 when 条件。\n3.11 分组 block 在 Ansible 中，block 是一个用于创建任务块的结构。它允许你将多个相关的任务组织在一起，以便在其中应用共同的条件、处理错误以及设置通用的参数。block 可以与 rescue 和 always 配合使用，以提供更丰富的任务控制和错误处理能力。\n以下是 block 结构的基本语法：\n- name: A playbook with a block hosts: target_hosts tasks: - block: # Start of the block - name: Task 1 some_module: # module arguments... - name: Task 2 some_module: # module arguments... rescue: # Optional, tasks to run if an error occurs within the block - name: Rescue task some_module: # module arguments... always: # Optional, tasks to run regardless of success or failure - name: Always task some_module: # module arguments... 在上述示例中，block 结构内包含两个任务（Task 1 和 Task 2）。如果 block 结构内的任务中的任何一个失败，那么 rescue 部分的任务将会被执行。无论 block 结构内的任务成功与否，always 部分的任务都会被执行。\n以下是一个更具体的示例，展示了 block 结构如何与错误处理和条件一起使用：\n- name: Install a package with error handling hosts: target_hosts tasks: - block: - name: Install the package apt: name: some-package state: present rescue: - name: Handle error debug: msg: \"An error occurred while installing the package.\" always: - name: Clean up apt: name: some-package state: absent 在这个示例中，block 结构内的任务尝试安装一个软件包。如果安装过程中出现错误，rescue 部分的任务会被执行，显示一条错误消息。无论是否出现错误，always 部分的任务都会被执行，确保最终将软件包从系统中移除。\n使用 block 结构可以使剧本更具可读性，减少冗余代码，并提供更好的错误处理机制，因为你可以集中管理错误的处理方式。\n3.12 changed_when 当确定某个 task 不会对被控制端做修改时但执行结果却显示是黄色的 changed 状态, 可以通过changed_when: false 关闭 changed 状态\n在 Ansible 中，changed_when 是一个用于控制任务是否被标记为已更改（changed）的选项。默认情况下，如果任务执行导致了任何状态更改，该任务将被标记为已更改。然而，通过使用 changed_when，你可以自定义标记任务是否已更改的条件，而不仅仅依赖于默认的状态变化检测。\nchanged_when 允许你在任务级别设置一个条件表达式。如果该表达式评估为 true，那么任务将被标记为已更改。如果该表达式评估为 false，那么任务将被标记为未更改。\n以下是 changed_when 的基本语法：\n- name: Task with custom change condition some_module: # Replace with the actual module you're using # module arguments... changed_when: condition_expression 在上述示例中，some_module 是要执行的任务模块，condition_expression 是一个自定义条件表达式，用于判断是否将任务标记为已更改。\n这是一个示例，展示如何使用 changed_when 控制任务是否被标记为已更改：\n- name: Run a command and control changed status command: echo \"Hello, world!\" register: command_output changed_when: \"command_output.stdout != 'Hello, world!\\n'\" 在这个示例中，command 模块执行一个命令来输出 “Hello, world!\"，并将输出结果存储在 command_output 变量中。通过使用 changed_when，我们指定了一个条件表达式，只有当命令的输出不等于 “Hello, world!\\n” 时，该任务才会被标记为已更改。\n通过使用 changed_when，你可以更精确地控制任务的更改状态，而不受默认状态变化检测的限制。这在某些情况下很有用，特别是当任务的状态变化可能不直接与输出结果相关时。\n3.13 滚动执行 serial 滚动执行（Rolling Deployment）是一种软件部署策略，用于将新版本的软件逐步部署到生产环境，而不是一次性将所有实例都更新为新版本。这种部署策略旨在减少风险，确保系统的可用性和稳定性，因为如果在全面部署新版本后出现问题，可能会影响整个系统。\n在滚动执行中，新版本的软件会首先部署到一小部分服务器（通常是一组）上，然后进行测试和验证。一旦新版本在这些服务器上得到确认，就会逐步将新版本应用于其他服务器，逐步增加服务器数量，直到所有服务器都完成了升级。\n在 Ansible 中，你可以通过编写适当的剧本（playbook）和任务，以及使用 serial 参数来实现滚动执行。serial 参数允许你指定每次在多少个目标主机上运行任务。这使得你可以控制在一次部署中逐步更新多少台主机。\n以下是使用 Ansible 实现滚动执行的示例：\n- name: Rolling deployment with Ansible hosts: target_hosts serial: 2 # Number of hosts to update simultaneously in each batch tasks: - name: Deploy new version some_module: # Replace with the actual module you're using # module arguments... 在上述示例中，serial: 2 表示每次将同时在两台目标主机上运行任务。这会使得每次部署只更新两台主机，然后逐步增加更新数量，直到所有目标主机都完成升级。\n请注意，实际的滚动执行策略可能因组织的需求和应用程序的特性而有所不同。你可以根据实际情况来调整 serial 参数的值以及部署任务的其他参数，以满足你的部署策略和可用性要求。\n3.14 delegate_to 在 Ansible 中，delegate_to 是一个用于指定任务应该在哪个远程主机上执行的参数。通过使用 delegate_to，你可以将任务委托给一个特定的主机执行，而不是默认在目标主机上执行。\n这是一个示例，展示如何使用 delegate_to 将任务委托给另一个主机执行：\n- name: Run a task on a specific host command: echo \"This task runs on a different host\" delegate_to: specific_host 在这个示例中，command 模块将执行 echo 命令，但是任务会被委托给 specific_host 执行，而不是默认的目标主机。\n需要注意的是，delegate_to 参数通常用于特定的情况，例如需要在特定主机上执行一些配置管理任务、收集信息或执行某些故障排除操作时。在大多数情况下，任务将在目标主机上执行，而不需要使用 delegate_to。\n3.15 run_onece 在 Ansible 中，run_once 是一个用于控制任务是否仅在一个主机上运行的参数。通常情况下，Ansible 会在目标主机上的每个主机上运行任务。但是，有时你可能只希望在所有目标主机中的一个上运行任务，而不是在每个主机上都运行。\n这是一个示例，展示如何使用 run_once 使任务只在一个主机上运行：\n- name: Run a task only once command: echo \"This task runs only once\" run_once: true 在这个示例中，command 模块会执行 echo 命令，但是该任务只会在目标主机中的一个主机上运行。\n使用 run_once 参数通常用于一些只需在整个剧本中执行一次的任务，例如收集汇总信息或配置初始化。注意，run_once 并不会影响其他任务的执行方式，其他任务仍然会在每个目标主机上运行。\n3.16 环境变量 environment 在 Ansible 中，environment 是一个参数，用于在任务级别设置环境变量。通过使用 environment 参数，你可以为任务设置特定的环境变量，这些变量将在任务执行期间对命令、脚本等操作产生影响。\n这是一个示例，展示如何使用 environment 参数设置环境变量：\n- name: Run a task with custom environment variables command: echo \"VAR1 is $VAR1, VAR2 is $VAR2\" environment: VAR1: value1 VAR2: value2 在这个示例中，command 模块会执行 echo 命令，打印出由 environment 参数指定的环境变量值。\n使用 environment 参数可以让你在任务执行过程中设置临时环境变量，这对于定制任务行为、传递配置信息或设置执行环境非常有用。这些环境变量只会在任务执行期间生效，不会影响到其他任务或目标主机的状态。\n3.17 include 和 import 在 Ansible 中，你可以使用 include 和 import 语句来实现 YAML 文件之间的相互调用和重用。这可以帮助你组织和管理大型的 Ansible 剧本，使其更加模块化和易于维护。\n以下是一个示例，演示了如何使用 include 和 import_playbook 来实现 YAML 文件之间的相互调用和重用。\n假设我们有以下文件结构：\nansible_project/ ├── main_playbook.yml ├── tasks/ │ ├── common_tasks.yml │ ├── task1.yml │ └── task2.yml └── playbooks/ └── other_playbook.yml main_playbook.yml 是主剧本文件，它引入了其他文件并定义了一些任务。 - name: Main Playbook hosts: target_hosts tasks: - include: tasks/common_tasks.yml - include: tasks/task1.yml - include: tasks/task2.yml - import_playbook: playbooks/other_playbook.yml common_tasks.yml 文件包含一些公共任务，这些任务可以被多个剧本重用。 - name: Common Task 1 debug: msg: \"This is a common task.\" - name: Common Task 2 debug: msg: \"Another common task.\" task1.yml 文件包含特定的任务。 - name: Task 1 debug: msg: \"Task 1 is executed.\" task2.yml 文件也包含特定的任务。 - name: Task 2 debug: msg: \"Task 2 is executed.\" other_playbook.yml 是另一个独立的剧本。 - name: Other Playbook hosts: other_hosts tasks: - name: Task in Other Playbook debug: msg: \"This task is from another playbook.\" 在这个示例中，main_playbook.yml 引入了多个文件并定义了一系列任务。common_tasks.yml 包含了一些公共任务，这些任务可以在主剧本和其他剧本中重用。task1.yml 和 task2.yml 分别包含特定的任务。other_playbook.yml 是另一个独立的剧本，它可以被导入到主剧本中。\n通过这种方式，你可以将 Ansible 代码模块化，提高可维护性，并根据需要重用任务和剧本。\n4 Ansible Roles Ansible 角色是一种用于组织和重用 Ansible 代码的结构化方式。角色允许你将任务、变量、模板和处理逻辑组织成一个可独立调用的单元，使得你能够更好地管理复杂的剧本和部署。\n角色的组织结构如下：\nmy_role/ ├── tasks/ │ ├── main.yml │ ├── task1.yml │ └── task2.yml ├── vars/ │ └── main.yml ├── templates/ │ ├── template1.j2 │ └── template2.j2 └── meta/ └── main.yml tasks/ 目录包含主任务文件 main.yml，以及其他任务文件如 task1.yml 和 task2.yml，这些文件包含要执行的任务。 vars/ 目录包含变量文件 main.yml，这些变量可以在角色中使用。 templates/ 目录包含模板文件，这些文件可以在角色中使用作为配置文件模板。 meta/ 目录包含角色元数据文件 main.yml，其中包含有关角色的信息，如作者、依赖等。 以下是一个示例，展示如何创建和使用 Ansible 角色。\n创建一个名为 my_role 的角色目录结构： ansible_project/ └── roles/ └── my_role/ ├── tasks/ │ └── main.yml ├── vars/ │ └── main.yml ├── templates/ │ └── template1.j2 └── meta/ └── main.yml 编辑 my_role/tasks/main.yml 文件，定义要执行的任务： - name: Task 1 in Role debug: msg: \"Task 1 of my_role is executed.\" - name: Task 2 in Role debug: msg: \"Task 2 of my_role is executed.\" 编辑 my_role/vars/main.yml 文件，定义角色变量： role_var1: value1 role_var2: value2 编辑 my_role/templates/template1.j2 文件，创建一个配置文件模板： [Section] var1 = {{ role_var1 }} var2 = {{ role_var2 }} 编辑 my_role/meta/main.yml 文件，定义角色元数据： galaxy_info: author: Your Name description: A sample Ansible role license: MIT min_ansible_version: 2.9 platforms: - name: Fedora versions: - all - name: Ubuntu versions: - all 在主剧本中使用角色： - name: Playbook using the role hosts: target_hosts roles: - my_role 在这个示例中，my_role 角色被定义为一个独立的目录，其中包含了任务、变量、模板和元数据。主剧本通过 roles 部分引用了这个角色，并在目标主机上执行了角色中的任务和操作。\n使用角色可以使 Ansible 代码更加模块化、易于维护和重用，特别是在处理多个项目、环境或应用程序时。\n","wordCount":"29021","inLanguage":"zh","datePublished":"2023-08-28T15:39:37+08:00","dateModified":"2023-08-28T15:39:37+08:00","author":[{"@type":"Person","name":"wz"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://senmer.github.io/zh/posts/tech/ansible/ansible/"},"publisher":{"@type":"Organization","name":"WZ's Blog","logo":{"@type":"ImageObject","url":"https://senmer.github.io/img/Q.gif"}}}</script></head><body id=top><script>(function(){let e,t=new RegExp("(^| )change-themes=([^;]*)(;|$)");(e=document.cookie.match(t))||((new Date).getHours()>=19||(new Date).getHours()<6?(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark")):(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")))})(),localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://senmer.github.io/zh/ accesskey=h title="WZ's Blog (Alt + H)"><img src=https://senmer.github.io/img/Q.gif alt=logo aria-label=logo height=35>WZ's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://senmer.github.io/zh/search title="🔍 搜索 (Alt + /)" accesskey=/><span>🔍 搜索</span></a></li><li><a href=https://senmer.github.io/zh/ title="🏠 主页"><span>🏠 主页</span></a></li><li><a href=https://senmer.github.io/zh/posts/tech title="📚 文章"><span>📚 文章</span></a></li><li><a href=https://senmer.github.io/zh/categories/ title="🧩 分类"><span>🧩 分类</span></a></li><li><a href=https://senmer.github.io/zh/archives/ title="⏱️ 时间轴"><span>⏱️ 时间轴</span></a></li><li><a href=https://senmer.github.io/zh/about title="🙋🏻‍♂️ 关于"><span>🙋🏻‍♂️ 关于</span></a></li><li><a href=https://senmer.github.io/zh/links title="🤝 友链"><span>🤝 友链</span></a></li></ul></nav></header><main class="main page"><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}</style><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://senmer.github.io/zh/>🏠 主页</a>&nbsp;»&nbsp;<a href=https://senmer.github.io/zh/posts/>📚文章</a>&nbsp;»&nbsp;<a href=https://senmer.github.io/zh/posts/tech/>👨🏻‍💻 技术</a></div><h1 class=post-title>Ansible</h1><div class=post-meta><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}.parent-post-meta{display:flex;flex-wrap:wrap;opacity:.8}</style><span class=parent-post-meta><span id=post_meta_style_1><span class="fa fa-calendar-check-o"></span>
<span>2023-08-28
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_3><span class="fa fa-file-word-o"></span>
<span>29021字
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_4><span class="fa fa-clock-o"></span>
<span>58分钟
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_5><span class="fa fa-user-o"></span>
<span>wz
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_6><span class="fa fa-tags" style=opacity:.8></span>
<span><span class=post-tags-meta></span></span></span></span><span style=opacity:.8><span id=post_meta_style_7>&nbsp;&nbsp;
<span class="fa fa-eye"></span>
<span><span id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv></span></span>
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_8><span class="fa fa-commenting-o"></span>
<span><script src=https://cdn.staticfile.org/twikoo/1.6.16/twikoo.all.min.js></script>
<script>let url=document.documentURI,dnsUrl="https://senmer.github.io/",urlSplit=url.split(dnsUrl),finalUrl=urlSplit[1];finalUrl[0]!=="/"&&(finalUrl="/"+finalUrl),twikoo.getCommentsCount({envId:"https://hugo-api-khaki.vercel.app/# 填写自己的twikoo id",region:null,urls:[finalUrl],includeReply:!1}).then(function(e){let t=e[0].count;const n=document.getElementById("comment_count");n.innerText=t}).catch(function(e){console.error(e)})</script><span id=comment_count></span></span></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#1-ansible-%e7%ae%80%e4%bb%8b aria-label="1 Ansible 简介">1 Ansible 简介</a><ul><li><a href=#11-ansible-%e5%8f%91%e5%b1%95%e5%8f%b2 aria-label="1.1 Ansible 发展史">1.1 Ansible 发展史</a></li><li><a href=#12-ansible-%e5%8a%9f%e8%83%bd aria-label="1.2 Ansible 功能">1.2 Ansible 功能</a></li><li><a href=#13-ansible-%e7%89%b9%e7%82%b9 aria-label="1.3 Ansible 特点">1.3 Ansible 特点</a><ul><li><a href=#131-%e4%bc%98%e7%82%b9 aria-label="1.3.1 优点">1.3.1 优点</a></li><li><a href=#132-%e7%bc%ba%e7%82%b9 aria-label="1.3.2 缺点">1.3.2 缺点</a></li><li><a href=#133-%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9 aria-label="1.3.3 注意事项">1.3.3 注意事项</a></li></ul></li></ul></li><li><a href=#2-ansible-%e5%ae%89%e8%a3%85%e5%92%8c%e5%b8%b8%e8%a7%81%e6%a8%a1%e5%9d%97 aria-label="2 Ansible 安装和常见模块">2 Ansible 安装和常见模块</a><ul><li><a href=#21-ansible-%e5%ae%89%e8%a3%85 aria-label="2.1 Ansible 安装">2.1 Ansible 安装</a></li><li><a href=#22-ansible-%e7%9b%b8%e5%85%b3%e6%96%87%e4%bb%b6 aria-label="2.2 Ansible 相关文件">2.2 Ansible 相关文件</a><ul><li><a href=#221-ansible-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e5%88%97%e8%a1%a8 aria-label="2.2.1 Ansible 配置文件列表">2.2.1 Ansible 配置文件列表</a></li><li><a href=#222-ansible-%e4%b8%bb%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-label="2.2.2 Ansible 主配置文件">2.2.2 Ansible 主配置文件</a></li><li><a href=#223-inventory-%e4%b8%bb%e6%9c%ba%e6%b8%85%e5%8d%95%e6%96%87%e4%bb%b6 aria-label="2.2.3 Inventory 主机清单文件">2.2.3 Inventory 主机清单文件</a></li></ul></li><li><a href=#23-ansible-%e7%9b%b8%e5%85%b3%e5%b7%a5%e5%85%b7 aria-label="2.3 Ansible 相关工具">2.3 Ansible 相关工具</a><ul><li><a href=#231-ansible-doc aria-label="2.3.1 Ansible-doc">2.3.1 Ansible-doc</a></li><li><a href=#232-ansible aria-label="2.3.2 Ansible">2.3.2 Ansible</a><ul><li><a href=#2321-ansible-ad-hoc aria-label="2.3.2.1 Ansible Ad-Hoc">2.3.2.1 Ansible Ad-Hoc</a></li><li><a href=#2322-ansible-%e5%91%bd%e4%bb%a4%e7%94%a8%e6%b3%95 aria-label="2.3.2.2 Ansible 命令用法">2.3.2.2 Ansible 命令用法</a></li><li><a href=#2323-ansible-%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e8%bf%87%e7%a8%8b aria-label="2.3.2.3 Ansible 命令执行过程">2.3.2.3 Ansible 命令执行过程</a></li><li><a href=#2324-ansible-%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e7%8a%b6%e6%80%81 aria-label="2.3.2.4 Ansible 命令执行状态">2.3.2.4 Ansible 命令执行状态</a></li></ul></li><li><a href=#233-ansible-console aria-label="2.3.3 ansible-console">2.3.3 ansible-console</a></li><li><a href=#234-ansible-playbook aria-label="2.3.4 ansible-playbook">2.3.4 ansible-playbook</a></li><li><a href=#235-ansible-vault aria-label="2.3.5 ansible-vault">2.3.5 ansible-vault</a></li><li><a href=#236-ansible-galaxy aria-label="2.3.6 ansible-galaxy">2.3.6 ansible-galaxy</a></li></ul></li><li><a href=#24-ansible-%e5%b8%b8%e7%94%a8%e6%a8%a1%e5%9d%97 aria-label="2.4 Ansible 常用模块">2.4 Ansible 常用模块</a><ul><li><a href=#241-command-%e6%a8%a1%e5%9d%97 aria-label="2.4.1 command 模块">2.4.1 command 模块</a></li><li><a href=#242-shell-%e6%a8%a1%e5%9d%97 aria-label="2.4.2 shell 模块">2.4.2 shell 模块</a></li><li><a href=#243-script-%e6%a8%a1%e5%9d%97 aria-label="2.4.3 script 模块">2.4.3 script 模块</a></li><li><a href=#244-copy-%e6%a8%a1%e5%9d%97 aria-label="2.4.4 copy 模块">2.4.4 copy 模块</a></li><li><a href=#245-get_url-%e6%a8%a1%e5%9d%97 aria-label="2.4.5 get_url 模块">2.4.5 get_url 模块</a></li><li><a href=#246-fetch-%e6%a8%a1%e5%9d%97 aria-label="2.4.6 fetch 模块">2.4.6 fetch 模块</a></li><li><a href=#247-file-%e6%a8%a1%e5%9d%97 aria-label="2.4.7 file 模块">2.4.7 file 模块</a></li><li><a href=#248-stat-%e6%a8%a1%e5%9d%97 aria-label="2.4.8 stat 模块">2.4.8 stat 模块</a></li><li><a href=#249-unarchive-%e6%a8%a1%e5%9d%97 aria-label="2.4.9 unarchive 模块">2.4.9 unarchive 模块</a></li><li><a href=#2410-archive-%e6%a8%a1%e5%9d%97 aria-label="2.4.10 archive 模块">2.4.10 archive 模块</a></li><li><a href=#2411-hostname-%e6%a8%a1%e5%9d%97 aria-label="2.4.11 hostname 模块">2.4.11 hostname 模块</a></li><li><a href=#2412-cron-%e6%a8%a1%e5%9d%97 aria-label="2.4.12 cron 模块">2.4.12 cron 模块</a></li><li><a href=#2413-yum-%e5%92%8c-apt-%e6%a8%a1%e5%9d%97 aria-label="2.4.13 yum 和 apt 模块">2.4.13 yum 和 apt 模块</a></li><li><a href=#2414-yum_repository aria-label="2.4.14 yum_repository">2.4.14 yum_repository</a></li><li><a href=#2415-service-%e6%a8%a1%e5%9d%97 aria-label="2.4.15 service 模块">2.4.15 service 模块</a></li><li><a href=#2416-user-%e6%a8%a1%e5%9d%97 aria-label="2.4.16 user 模块">2.4.16 user 模块</a></li><li><a href=#2417-group-%e6%a8%a1%e5%9d%97 aria-label="2.4.17 group 模块">2.4.17 group 模块</a></li><li><a href=#2418-lineinfile-%e6%a8%a1%e5%9d%97 aria-label="2.4.18 lineinfile 模块">2.4.18 lineinfile 模块</a></li><li><a href=#2419-replace-%e6%a8%a1%e5%9d%97 aria-label="2.4.19 replace 模块">2.4.19 replace 模块</a></li><li><a href=#2420-selinux-%e6%a8%a1%e5%9d%97 aria-label="2.4.20 selinux 模块">2.4.20 selinux 模块</a></li><li><a href=#2421-reboot-%e6%a8%a1%e5%9d%97 aria-label="2.4.21 reboot 模块">2.4.21 reboot 模块</a></li><li><a href=#2422-mount-%e6%a8%a1%e5%9d%97 aria-label="2.4.22 mount 模块">2.4.22 mount 模块</a></li><li><a href=#2423-setup-%e6%a8%a1%e5%9d%97 aria-label="2.4.23 setup 模块">2.4.23 setup 模块</a></li><li><a href=#2424-debug-%e6%a8%a1%e5%9d%97 aria-label="2.4.24 debug 模块">2.4.24 debug 模块</a></li><li><a href=#2425-sysctl-%e6%a8%a1%e5%9d%97 aria-label="2.4.25 sysctl 模块">2.4.25 sysctl 模块</a></li><li><a href=#2426-pam_limits-%e6%a8%a1%e5%9d%97 aria-label="2.4.26 pam_limits 模块">2.4.26 pam_limits 模块</a></li></ul></li></ul></li><li><a href=#3-ansible-playbook aria-label="3 Ansible Playbook">3 Ansible Playbook</a><ul><li><a href=#31-playbook-%e7%ae%80%e4%bb%8b aria-label="3.1 Playbook 简介">3.1 Playbook 简介</a><ul><li><a href=#311-playbook-%e7%bb%84%e6%88%90 aria-label="3.1.1 Playbook 组成">3.1.1 Playbook 组成</a></li><li><a href=#212-playbook-%e5%92%8c-ad-hoc-%e5%af%b9%e6%af%94 aria-label="2.1.2 Playbook 和 Ad-Hoc 对比">2.1.2 Playbook 和 Ad-Hoc 对比</a></li></ul></li><li><a href=#32-plabook-%e6%a0%b8%e5%bf%83%e7%bb%84%e4%bb%b6 aria-label="3.2 Plabook 核心组件">3.2 Plabook 核心组件</a></li><li><a href=#33--playbook-%e5%91%bd%e4%bb%a4 aria-label="3.3  Playbook 命令">3.3 Playbook 命令</a></li><li><a href=#34-ignore_errors aria-label="3.4 ignore_errors">3.4 ignore_errors</a></li><li><a href=#35-handlers-%e5%92%8c-notify aria-label="3.5 handlers 和 notify">3.5 handlers 和 notify</a></li><li><a href=#36-playbook-%e4%b8%ad%e4%bd%bf%e7%94%a8-tags aria-label="3.6 Playbook 中使用 tags">3.6 Playbook 中使用 tags</a></li><li><a href=#37-playbook-%e4%b8%ad%e4%bd%bf%e7%94%a8%e5%8f%98%e9%87%8f aria-label="3.7 Playbook 中使用变量">3.7 Playbook 中使用变量</a><ul><li><a href=#371-%e4%bd%bf%e7%94%a8-setup-%e6%a8%a1%e5%9d%97%e4%b8%ad%e7%9a%84%e5%8f%98%e9%87%8f aria-label="3.7.1 使用 setup 模块中的变量">3.7.1 使用 setup 模块中的变量</a><ul><li><a href=#3711-%e4%bd%bf%e7%94%a8-facts-%e5%8f%98%e9%87%8f aria-label="3.7.1.1 使用 facts 变量">3.7.1.1 使用 facts 变量</a></li><li><a href=#3712-%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96 aria-label="3.7.1.2 性能优化">3.7.1.2 性能优化</a></li></ul></li><li><a href=#372-%e5%91%bd%e4%bb%a4%e8%a1%8c%e4%b8%ad%e7%bb%99-playbook-%e4%bc%a0%e9%80%92%e5%8f%98%e9%87%8f aria-label="3.7.2 命令行中给 playbook 传递变量">3.7.2 命令行中给 playbook 传递变量</a></li><li><a href=#373-%e5%9c%a8-playbook-%e6%96%87%e4%bb%b6%e4%b8%ad%e5%ae%9a%e4%b9%89%e5%8f%98%e9%87%8f aria-label="3.7.3 在 playbook 文件中定义变量">3.7.3 在 playbook 文件中定义变量</a></li><li><a href=#374-%e5%9c%a8%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e6%96%87%e4%bb%b6%e4%b8%ad%e5%ae%9a%e4%b9%89%e5%8f%98%e9%87%8f aria-label="3.7.4 在外部变量文件中定义变量：">3.7.4 在外部变量文件中定义变量：</a></li><li><a href=#375-%e5%9c%a8%e4%b8%bb%e6%9c%ba%e6%b8%85%e5%8d%95%e4%b8%ad%e5%ae%9a%e4%b9%89%e5%8f%98%e9%87%8f aria-label="3.7.5 在主机清单中定义变量">3.7.5 在主机清单中定义变量</a></li><li><a href=#376-host_vars-%e5%92%8c-group_vars aria-label="3.7.6 host_vars 和 group_vars">3.7.6 host_vars 和 group_vars</a></li><li><a href=#377-register aria-label="3.7.7 register">3.7.7 register</a></li></ul></li><li><a href=#38-jinja2-%e6%a8%a1%e6%9d%bf%e7%9a%84%e4%bb%8b%e7%bb%8d%e5%92%8c%e4%bd%bf%e7%94%a8 aria-label="3.8 Jinja2 模板的介绍和使用">3.8 Jinja2 模板的介绍和使用</a></li><li><a href=#39-%e5%be%aa%e7%8e%af%e5%92%8c%e8%bf%ad%e4%bb%a3 aria-label="3.9 循环和迭代">3.9 循环和迭代</a><ul><li><a href=#378-loop aria-label="3.7.8 loop">3.7.8 loop</a></li><li><a href=#379-until aria-label="3.7.9 until">3.7.9 until</a></li><li><a href=#3710-with_lines aria-label="3.7.10 with_lines">3.7.10 with_lines</a></li></ul></li><li><a href=#310-%e6%9d%a1%e4%bb%b6%e5%88%a4%e6%96%ad-when aria-label="3.10 条件判断 when">3.10 条件判断 when</a></li><li><a href=#311-%e5%88%86%e7%bb%84-block aria-label="3.11 分组 block">3.11 分组 block</a></li><li><a href=#312-changed_when aria-label="3.12 changed_when">3.12 changed_when</a></li><li><a href=#313-%e6%bb%9a%e5%8a%a8%e6%89%a7%e8%a1%8c-serial aria-label="3.13 滚动执行 serial">3.13 滚动执行 serial</a></li><li><a href=#314-delegate_to aria-label="3.14 delegate_to">3.14 delegate_to</a></li><li><a href=#315-run_onece aria-label="3.15 run_onece">3.15 run_onece</a></li><li><a href=#316-%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f-environment aria-label="3.16 环境变量 environment">3.16 环境变量 environment</a></li><li><a href=#317-include-%e5%92%8c-import aria-label="3.17 include 和 import">3.17 include 和 import</a></li></ul></li><li><a href=#4-ansible-roles aria-label="4 Ansible Roles">4 Ansible Roles</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=1-ansible-简介>1 Ansible 简介<a hidden class=anchor aria-hidden=true href=#1-ansible-简介>#</a></h2><h3 id=11-ansible-发展史>1.1 Ansible 发展史<a hidden class=anchor aria-hidden=true href=#11-ansible-发展史>#</a></h3><p>作者：Michael DeHaan（ Cobbler 与 Func 作者）</p><p>Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离，远程实时控制前线的舰队战斗。</p><p>2012-03-09，发布0.0.1版，2015-10-17，Red Hat宣布1.5亿美元收购Ansible。</p><p><a href=https://cn-ansibledoc.readthedocs.io/zh_CN/latest/#>Ansible「2.9」 中文官方文档 — Ansible Documentation (cn-ansibledoc.readthedocs.io)</a></p><h3 id=12-ansible-功能>1.2 Ansible 功能<a hidden class=anchor aria-hidden=true href=#12-ansible-功能>#</a></h3><ul><li>批量远程执行命令、安装和配置各种服务</li><li>利用 Playbook 和 Role 编排企业级的复杂的 IT 架构任务</li><li>提供自动化运维工具的开发 API，如 JumpServer 就是基于 Ansible 实现自动化管理功能</li></ul><h3 id=13-ansible-特点>1.3 Ansible 特点<a hidden class=anchor aria-hidden=true href=#13-ansible-特点>#</a></h3><h4 id=131-优点>1.3.1 优点<a hidden class=anchor aria-hidden=true href=#131-优点>#</a></h4><ul><li>功能丰富：模块数量达数千个，且支持自定义模块和多数编程语言</li><li>简单易用：Ansible 不使用 C/S 架构管理节点，即没有 Agent，去中心化管理方式</li><li>安全：基于 OpenSSH 协议实现安全通讯，无需专用协议</li><li>幂等性：可以重复多次执行，对系统不会产生影响</li><li>使用 YAML 格式的配置文件，简单易读</li><li>Playbook 和 Role 支持编排复杂任务，增强代码复用性</li><li>Python 语言实现, 基于 Paramiko（ python 对 ssh 的实现），PyYAML，Jinja2（模板语言）三个关
键模块</li></ul><h4 id=132-缺点>1.3.2 缺点<a hidden class=anchor aria-hidden=true href=#132-缺点>#</a></h4><ul><li>管理主机较多时，执行效率不如 saltstack</li><li>当前还不支持像 MySQL 数据库类似的事务回滚</li></ul><h4 id=133-注意事项>1.3.3 注意事项<a hidden class=anchor aria-hidden=true href=#133-注意事项>#</a></h4><ul><li><p>安装了 ansible 的主机官方称之为管理机，工作中也常称之为：中控、主控、master 或者堡垒机</p></li><li><p>被管理的主机一般称之为受管理节点，被控端，受控端</p></li><li><p>管理机 Python 版本需要 2.6 及以上</p></li><li><p>受管理节点 Python 版本低于 2.4 ，需要安装 python-simplejson</p></li><li><p>受管理节点如果启用 SELinux ，需要安装 libselinux-python</p></li><li><p>Windows 不能做为管理机，只能是受管理节点</p></li></ul><h2 id=2-ansible-安装和常见模块>2 Ansible 安装和常见模块<a hidden class=anchor aria-hidden=true href=#2-ansible-安装和常见模块>#</a></h2><h3 id=21-ansible-安装>2.1 Ansible 安装<a hidden class=anchor aria-hidden=true href=#21-ansible-安装>#</a></h3><blockquote><p>中文文档：<a href=https://cn-ansibledoc.readthedocs.io/zh_CN/latest/installation_guide/intro_installation.html>安装 Ansible — Ansible Documentation (cn-ansibledoc.readthedocs.io)</a></p><p>英文文档：<a href=https://docs.ansible.com/ansible/latest/index.html>Ansible Documentation — Ansible Documentation</a></p></blockquote><p>CentOS 安装:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>yum install -y ansible
</span></span></code></pre></div><p>Ubuntu 安装：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>apt install -y ansible
</span></span></code></pre></div><p>pip 安装（不推荐）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install ansible
</span></span></code></pre></div><p>查看已安装的 ansible 版本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ansible --version
</span></span></code></pre></div><h3 id=22-ansible-相关文件>2.2 Ansible 相关文件<a hidden class=anchor aria-hidden=true href=#22-ansible-相关文件>#</a></h3><h4 id=221-ansible-配置文件列表>2.2.1 Ansible 配置文件列表<a hidden class=anchor aria-hidden=true href=#221-ansible-配置文件列表>#</a></h4><ul><li>/etc/ansible/ansible.cfg 主配置文件，如果需要，可以为每个项目创建独有的 ansible.cfg 文件。</li><li>/etc/ansible/hosts 主机清单文件，包含所有受管理节点的 IP 及其他相关信息</li><li>/etc/ansible/roles 存放各个角色的目录</li></ul><h4 id=222-ansible-主配置文件>2.2.2 Ansible 主配置文件<a hidden class=anchor aria-hidden=true href=#222-ansible-主配置文件>#</a></h4><p>Ansible 的配置文件可以有多个来源，优先级从高到低顺序如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ANSIBLE_CONFIG 	<span style=color:#75715e>#环境变量</span>
</span></span><span style=display:flex><span>./ansible.cfg	
</span></span><span style=display:flex><span>~/.ansible.cfg
</span></span><span style=display:flex><span>/etc/ansible/ansible.cfg	<span style=color:#75715e>#系统默认配置</span>
</span></span></code></pre></div><p>Ansible 的默认配置文件 <code>/etc/ansible/ansible.cfg</code> ，其中大部分注释内容即为默认值，没有特殊需要，可以不用修改。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[defaults]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># some basic default values...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#inventory      = /etc/ansible/hosts</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#library        = /usr/share/my_modules/</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#module_utils   = /usr/share/my_module_utils/</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#remote_tmp     = ~/.ansible/tmp</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#local_tmp      = ~/.ansible/tmp</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#plugin_filters_cfg = /etc/ansible/plugin_filters.yml</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#forks          = 5</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#poll_interval  = 15</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo_user      = root</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#ask_sudo_pass = True</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#ask_pass      = True</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#transport      = smart</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#remote_port    = 22</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#module_lang    = C</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#module_set_locale = False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># plays will gather facts by default, which contain information about</span>
</span></span></code></pre></div><p>范例：通过环境变量 ANSIBLE_CONFIG 指定 ansible 配置文件路径</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ll /data/ansible.cfg # 并不存在的配置文件</span>
</span></span><span style=display:flex><span>ls: cannot access /data/ansible.cfg: No such file or directory
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># export ANSIBLE_CONFIG=/data/ansible.cfg</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible --version</span>
</span></span><span style=display:flex><span>ansible 2.9.27
</span></span><span style=display:flex><span>  config file <span style=color:#f92672>=</span> /etc/ansible/ansible.cfg <span style=color:#75715e># 还是默认配置文件</span>
</span></span><span style=display:flex><span>  configured module search path <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>u<span style=color:#e6db74>&#39;/root/.ansible/plugins/modules&#39;</span>, u<span style=color:#e6db74>&#39;/usr/share/ansible/plugins/modules&#39;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  ansible python module location <span style=color:#f92672>=</span> /usr/lib/python2.7/site-packages/ansible
</span></span><span style=display:flex><span>  executable location <span style=color:#f92672>=</span> /usr/bin/ansible
</span></span><span style=display:flex><span>  python version <span style=color:#f92672>=</span> 2.7.5 <span style=color:#f92672>(</span>default, Oct <span style=color:#ae81ff>30</span> 2018, 23:45:53<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>GCC 4.8.5 <span style=color:#ae81ff>20150623</span> <span style=color:#f92672>(</span>Red Hat 4.8.5-36<span style=color:#f92672>)]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># touch /data/ansible.cfg #创建此文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible --version</span>
</span></span><span style=display:flex><span>ansible 2.9.27
</span></span><span style=display:flex><span>  config file <span style=color:#f92672>=</span> /data/ansible.cfg <span style=color:#75715e># 成功指定</span>
</span></span><span style=display:flex><span>  configured module search path <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>u<span style=color:#e6db74>&#39;/root/.ansible/plugins/modules&#39;</span>, u<span style=color:#e6db74>&#39;/usr/share/ansible/plugins/modules&#39;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  ansible python module location <span style=color:#f92672>=</span> /usr/lib/python2.7/site-packages/ansible
</span></span><span style=display:flex><span>  executable location <span style=color:#f92672>=</span> /usr/bin/ansible
</span></span><span style=display:flex><span>  python version <span style=color:#f92672>=</span> 2.7.5 <span style=color:#f92672>(</span>default, Oct <span style=color:#ae81ff>30</span> 2018, 23:45:53<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>GCC 4.8.5 <span style=color:#ae81ff>20150623</span> <span style=color:#f92672>(</span>Red Hat 4.8.5-36<span style=color:#f92672>)]</span>
</span></span></code></pre></div><h4 id=223-inventory-主机清单文件>2.2.3 Inventory 主机清单文件<a hidden class=anchor aria-hidden=true href=#223-inventory-主机清单文件>#</a></h4><p>ansible 的主要功能在于批量管理主机，这些被管理的主机就使用 inventory 文件来指定。</p><p>生产环境可以为每个项目创建独有的 ansible.cfg 文件和 hosts 文件，实现项目之前的隔离管理。</p><p>官方文档：https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html</p><p><strong>主机清单文件格式</strong></p><p>inventory 文件遵循 INI 文件风格，可以对主机进行分组管理，且可以针对每个主机指定非默认的端口和账号等信息</p><p><strong>常用 Inventory 参数说明</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ansible_ssh_host <span style=color:#75715e># 远程主机名与想要设定的主机的别名不同的话，可通过此变量设置。</span>
</span></span><span style=display:flex><span>ansible_ssh_port <span style=color:#75715e># ssh 端口号，如果不是默认的端口号，通过此变量设置。或者ip:端口的形式指定 192.168.1.100:2222</span>
</span></span><span style=display:flex><span>ansible_ssh_user <span style=color:#75715e># ssh 用户名</span>
</span></span><span style=display:flex><span>ansible_ssh_pass <span style=color:#75715e># ssh 密码(这种方式并不安全，强烈建议使用 --ask-pass 或者配置 ssh 免密)</span>
</span></span><span style=display:flex><span>ansible_sudo_pass <span style=color:#75715e># sudo 密码(这种方式并不安全，强烈建议使用 --ask-sudo-pass)</span>
</span></span><span style=display:flex><span>ansible_sudo_exe <span style=color:#f92672>(</span>new in version 1.8<span style=color:#f92672>)</span> <span style=color:#75715e># sudo 命令路径(适用于1.8及以上版本)</span>
</span></span><span style=display:flex><span>ansible_connection <span style=color:#75715e># 与主机的连接类型.比如:local, ssh 或者 paramiko。 Ansible 1.2 以前默认使用 paramiko。1.2 以后默认使用 &#39;smart&#39;，&#39;smart&#39; 方式会根据是否支持 ControlPersist, 来判断&#39;ssh&#39; 方式是否可行。</span>
</span></span><span style=display:flex><span>ansible_ssh_private_key_file <span style=color:#75715e># ssh 使用的私钥文件，适用于有多个密钥，而你不想使用 ssh 代理的情况。</span>
</span></span><span style=display:flex><span>ansible_shell_type <span style=color:#75715e># 目标系统的 shell 类型。默认情况下，命令的执行使用 &#39;sh&#39; 语法, 可设置为&#39;csh&#39; 或 &#39;fish&#39;。</span>
</span></span><span style=display:flex><span>ansible_python_interpreter <span style=color:#75715e># 目标主机的 python 路径，适用于的情况: 系统中有多个 Python, 或者命令路径不是&#34;/usr/bin/python&#34;，比如 \*BSD, 或者 /usr/bin/python 不是 2.X 版本的Python。之所以不使用 &#34;/usr/bin/env&#34; 机制，因为这要求远程用户的路径设置正确，且要求 &#34;python&#34; 可执行程序名不可为 python 以外的名字(实际有可能名为python26)</span>
</span></span></code></pre></div><p>范例：主机和组嵌套</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-INI data-lang=INI><span style=display:flex><span><span style=color:#a6e22e>ntp.time.org</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[databases]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>www.db1.org:2222</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>www.db2.org</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[web]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>www.web1.com</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>www.web2.com</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[proxy]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pro[1:3].test.com</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pro-db[a:f].test.com</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># server 组成员：web, proxy</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>[server:children] # children 是内置变量</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>web</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>proxy</span>
</span></span></code></pre></div><p>范例：基于用户名和密码连接</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[test]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>10.0.0.1 ansible_connection</span><span style=color:#f92672>=</span><span style=color:#e6db74>local #指定本地连接方式，如：ssh localhost</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>10.0.0.2 ansible_connection</span><span style=color:#f92672>=</span><span style=color:#e6db74>ssh ansible_ssh_port=2222 ansible_ssh_user=user ansible_ssh_password=passwd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>10.0.0.3 ansible_ssh_user</span><span style=color:#f92672>=</span><span style=color:#e6db74>test ansible_ssh_password=test</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[web]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>web01 ansible_ssh_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>10.0.0.5 # web01 为别名</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>web02 ansible_ssh_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>10.0.0.6</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>[web:vars] # vars 是内置变量，这里为 web 组内的成员定义了一个组变量</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ansible_ssh_password</span><span style=color:#f92672>=</span><span style=color:#e6db74>test</span>
</span></span></code></pre></div><h3 id=23-ansible-相关工具>2.3 Ansible 相关工具<a hidden class=anchor aria-hidden=true href=#23-ansible-相关工具>#</a></h3><ul><li>/usr/bin/ansible 主程序，临时命令执行工具</li><li>/usr/bin/ansible-doc 查看配置文档，模块功能查看工具,相当于man</li><li>/usr/bin/ansible-playbook 定制自动化任务，编排剧本工具,相当于脚本</li><li>/usr/bin/ansible-pull 远程执行命令的工具</li><li>/usr/bin/ansible-vault 文件加密工具</li><li>/usr/bin/ansible-console 基于Console界面与用户交互的执行工具</li><li>/usr/bin/ansible-galaxy 下载/上传优秀代码或Roles模块的官网平台</li></ul><p><strong>利用 ansible 实现管理的主要方式：</strong></p><ul><li>Ansible Ad-Hoc 主要用于命令行执行命令，适合于简单任务</li><li>Ansible playbook 主要用于长期规划好的，大型项目场景</li></ul><p><strong>ansible 使用前准备：</strong></p><p>ansible 大部分工具使用 ssh 协议来进行远程主机管理，因此在使用此工具前需要配置好密钥认证，如果使用密码验证会很麻烦，而且并不安全。</p><p>在首次 ssh 某台主机时，会有一个是否信任主机的提示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ssh localhost</span>
</span></span><span style=display:flex><span>The authenticity of host <span style=color:#e6db74>&#39;localhost (::1)&#39;</span> can<span style=color:#960050;background-color:#1e0010>&#39;</span>t be established.
</span></span><span style=display:flex><span>ECDSA key fingerprint is SHA256:kFbXYFVk/H+j5h1JTkIf9HAw+zXbWQIHqG03FutZJ3E.
</span></span><span style=display:flex><span>ECDSA key fingerprint is MD5:7b:d4:06:49:45:fa:58:b0💿de:ef:bc:1e:14:09:f3.
</span></span><span style=display:flex><span>Are you sure you want to <span style=color:#66d9ef>continue</span> connecting <span style=color:#f92672>(</span>yes/no<span style=color:#f92672>)</span>? 
</span></span></code></pre></div><p>可以修改 <code>/etc/ssh/ssh_config</code>的配置来避免该提示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>StrictHostKeyChecking no</span>
</span></span></code></pre></div><p>以下准备了一个脚本来实现 ssh 免密登录：</p><p>准备一个清单文件，写入相应的IP</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># cat hosts.txt </span>
</span></span><span style=display:flex><span>10.0.0.1
</span></span><span style=display:flex><span>10.0.0.2
</span></span><span style=display:flex><span>10.0.0.3
</span></span></code></pre></div><p>脚本内容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># 需要修改的参数</span>
</span></span><span style=display:flex><span><span style=color:#75715e>###################</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 读取主机列表文件</span>
</span></span><span style=display:flex><span>hosts_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hosts.txt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 远程用户名</span>
</span></span><span style=display:flex><span>remote_user<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;your_username&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 并发任务数量</span>
</span></span><span style=display:flex><span>concurrency<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># SSH 密码</span>
</span></span><span style=display:flex><span>export ssh_password<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;your_password&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##########################</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 颜色定义</span>
</span></span><span style=display:flex><span>RED<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;\033[0;31m&#39;</span>
</span></span><span style=display:flex><span>GREEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;\033[0;32m&#39;</span>
</span></span><span style=display:flex><span>NC<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;\033[0m&#39;</span> <span style=color:#75715e># No Color</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 打印带颜色的消息</span>
</span></span><span style=display:flex><span>print_message<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  local message<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  local color<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$2<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  echo -e <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>color<span style=color:#e6db74>}</span>$message<span style=color:#e6db74>${</span>NC<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查主机列表文件是否存在</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -f <span style=color:#e6db74>&#34;</span>$hosts_file<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>  echo -e <span style=color:#e6db74>&#34;\033[31mHosts file not found: </span>$hosts_file<span style=color:#e6db74>\033[0m&#34;</span>
</span></span><span style=display:flex><span>  exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安装 sshpass</span>
</span></span><span style=display:flex><span>rpm -q sshpass &amp;&gt; /dev/null <span style=color:#f92672>||</span> yum install -y sshpass
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安装 parallel</span>
</span></span><span style=display:flex><span>rpm -qi parallel &amp;&gt; /dev/null <span style=color:#f92672>||</span> yum install -y parallel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成 id_rsa 密钥</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> -f /root/.ssh/id_rsa <span style=color:#f92672>]</span> <span style=color:#f92672>||</span> ssh-keygen -f /root/.ssh/id_rsa -P <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># mkfifo 创建命名管道</span>
</span></span><span style=display:flex><span>tempfifo<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/tmp/</span>$$<span style=color:#e6db74>.fifo&#34;</span>
</span></span><span style=display:flex><span>mkfifo <span style=color:#e6db74>${</span>tempfifo<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 关联fifo文件和fd6，使文件描述符为非阻塞式</span>
</span></span><span style=display:flex><span>exec 6&lt;&gt;<span style=color:#e6db74>${</span>tempfifo<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>rm -f <span style=color:#e6db74>${</span>tempfifo<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 为文件描述符创建占位信息</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#f92672>((</span>i<span style=color:#f92672>=</span>1;i&lt;<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>concurrency<span style=color:#e6db74>}</span>;i++<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;&#34;</span> &gt;&amp;<span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>  
</span></span><span style=display:flex><span><span style=color:#75715e># 逐行读取主机列表文件并执行任务</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> IFS<span style=color:#f92672>=</span> read -r host; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  read -u6   <span style=color:#75715e>## read -u6命令执行一次，相当于尝试从fd6中获取一行，如果获取不到，则阻塞获取到了           </span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>## 一行后，fd6就少了一行了，开始处理子进程，子进程放在后台执行</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    sshpass -p <span style=color:#e6db74>&#34;</span>$ssh_password<span style=color:#e6db74>&#34;</span> ssh-copy-id -o StrictHostKeyChecking<span style=color:#f92672>=</span>no <span style=color:#e6db74>&#34;</span>$remote_user<span style=color:#e6db74>@</span>$host<span style=color:#e6db74>&#34;</span> &amp;&gt;/dev/null;
</span></span><span style=display:flex><span>    exit_code<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $exit_code -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>      print_message <span style=color:#e6db74>&#34;成功免密主机: </span>$host<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$GREEN<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>      print_message <span style=color:#e6db74>&#34;失败免密主机: </span>$host<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$RED<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;&#34;</span> &gt;&amp;<span style=color:#ae81ff>6</span>   <span style=color:#75715e># 完成后再补充一个空值到fd6中，释放一个锁</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> &amp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span> &lt; <span style=color:#e6db74>&#34;</span>$hosts_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>wait
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 关闭fd6管道</span>
</span></span><span style=display:flex><span>exec 6&gt;&amp;-
</span></span></code></pre></div><h4 id=231-ansible-doc>2.3.1 Ansible-doc<a hidden class=anchor aria-hidden=true href=#231-ansible-doc>#</a></h4><p>此工具用于显示模块帮助文档，类似 man</p><p>使用格式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ansible-doc <span style=color:#f92672>[</span>options<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>module...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>-l, --list       <span style=color:#75715e># 列出可用模块</span>
</span></span><span style=display:flex><span>-s, --snippet 	 <span style=color:#75715e># 显示指定模块的playbook片段</span>
</span></span></code></pre></div><p>常用选项：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 列出所有模块</span>
</span></span><span style=display:flex><span>ansible-doc -l
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看指定模块帮助用法</span>
</span></span><span style=display:flex><span>ansible-doc ping
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看常用playbook选项</span>
</span></span><span style=display:flex><span>ansible-doc -s ping
</span></span></code></pre></div><p>查看模块相关的插件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># connection 模块相关组件</span>
</span></span><span style=display:flex><span>ansible-doc -t connection -l  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># lookup 模块相关组件</span>
</span></span><span style=display:flex><span>ansible-doc -t lookup -l
</span></span></code></pre></div><h4 id=232-ansible>2.3.2 Ansible<a hidden class=anchor aria-hidden=true href=#232-ansible>#</a></h4><h5 id=2321-ansible-ad-hoc>2.3.2.1 Ansible Ad-Hoc<a hidden class=anchor aria-hidden=true href=#2321-ansible-ad-hoc>#</a></h5><p>Ansible Ad-Hoc 主要就是使用ansible主程序</p><p>通常用来执行一次性任务，不会保存命令执行的信息，常用于测试场景</p><h5 id=2322-ansible-命令用法>2.3.2.2 Ansible 命令用法<a hidden class=anchor aria-hidden=true href=#2322-ansible-命令用法>#</a></h5><p>格式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ansible &lt;host-pattern&gt; <span style=color:#f92672>[</span>-m module_name<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-a args<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>常用选项：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>--version			<span style=color:#75715e># 查看 ansible 版本和配置文件路径</span>
</span></span><span style=display:flex><span>-m &lt;module_name&gt;	<span style=color:#75715e># 指定使用的模块，不指定默认为 command</span>
</span></span><span style=display:flex><span>-v 					<span style=color:#75715e># 用于 debug，-vv  -vvv 可显示更详细命令执行过程的日志</span>
</span></span><span style=display:flex><span>--list-hosts		<span style=color:#75715e># 显示清单文件中的主机列表</span>
</span></span><span style=display:flex><span>-C, --check			<span style=color:#75715e># 模拟执行，并不对目标主机做实际改动，可以用来检查语法</span>
</span></span><span style=display:flex><span>-T, --timeout<span style=color:#f92672>=</span>TIMEOUT  		<span style=color:#75715e># 指定命令执行超时时间</span>
</span></span><span style=display:flex><span>-k, --ask-pass 		<span style=color:#75715e># 提示输入 ssh 密码，使用密码验证，默认使用 key 验证</span>
</span></span><span style=display:flex><span>-u, --user<span style=color:#f92672>=</span>USERNAME <span style=color:#75715e># 指定 sudo 用户，默认为 root</span>
</span></span><span style=display:flex><span>-b, --become 		<span style=color:#75715e># 使用 sudo 机制</span>
</span></span><span style=display:flex><span>--become-user<span style=color:#f92672>=</span>USERNAME 	<span style=color:#75715e># 指定 sudo 的目标用户，默认为 root</span>
</span></span><span style=display:flex><span>-K, --ask-become-pass	<span style=color:#75715e># 提示输入 sudo 密码</span>
</span></span><span style=display:flex><span>-f &lt;forks_num&gt;, --FORKS <span style=color:#75715e># 指定并发数</span>
</span></span></code></pre></div><p>范例：使用 localhost 走本地协议，并不需要密码（包括 sudo 密码）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 以test 用户执行操作，</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m  ping -u test</span>
</span></span><span style=display:flex><span>localhost | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ping&#34;</span>: <span style=color:#e6db74>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 指定了用户为 test，但并未生效</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m shell -a &#34;whoami&#34; -u test </span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>root
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 以 test 用户使用 sudo 机制执行命令</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m shell -a &#34;whoami&#34; -u test -b -become-user=root </span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>root
</span></span></code></pre></div><p>范例：使用 IP连接，可观测到 ansible 的相关特性</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 本机IP</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># hostname -I</span>
</span></span><span style=display:flex><span>192.168.0.133 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 将本机IP加入清单文件（localhost不需要显式加入）</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># grep $(hostname -I) /etc/ansible/hosts</span>
</span></span><span style=display:flex><span>192.168.0.133
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 没有输入密码提示权限不足</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.0.133 -m shell -a &#34;whoami&#34; -u test  </span>
</span></span><span style=display:flex><span>192.168.0.133 | UNREACHABLE! <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;Failed to connect to the host via ssh: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;unreachable&#34;</span>: true
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 加入 -k 选项输入密码，成功执行</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.0.133 -m shell -a &#34;whoami&#34; -u test -k</span>
</span></span><span style=display:flex><span>SSH password: 
</span></span><span style=display:flex><span>192.168.0.133 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># sudo 也是同样的情况，不输入密码会报错</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.0.133 -m shell -a &#34;whoami&#34; -u test -k -b </span>
</span></span><span style=display:flex><span>SSH password: 
</span></span><span style=display:flex><span>192.168.0.133 | FAILED | rc<span style=color:#f92672>=</span>-1 &gt;&gt;
</span></span><span style=display:flex><span>Missing sudo password
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 输入密码后成功执行</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.0.133 -m shell -a &#34;whoami&#34; -u test -k -b -K</span>
</span></span><span style=display:flex><span>SSH password: 
</span></span><span style=display:flex><span>BECOME password<span style=color:#f92672>[</span>defaults to SSH password<span style=color:#f92672>]</span>: 
</span></span><span style=display:flex><span>192.168.0.133 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>root
</span></span></code></pre></div><p>范例：并发执行控制</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 分别执行一下以下两个命令观察运行效果，可以发现执行的之间基本一致</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -a &#39;sleep 3&#39; -f 1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -a &#39;sleep 3&#39; -f 10</span>
</span></span></code></pre></div><p>范例：使用普通用户进行远程管理</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 在所有控制端和被控制端创建普通账号并修改密码（本次示例为均为192.168.0.133）</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># useradd test</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># echo test:test | chpasswd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 添加sudo授权</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># visudo  # 添加一行</span>
</span></span><span style=display:flex><span>test	ALL<span style=color:#f92672>=(</span>ALL<span style=color:#f92672>)</span> 	ALL
</span></span><span style=display:flex><span><span style=color:#75715e># 校验配置无误</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># visudo -c</span>
</span></span><span style=display:flex><span>/etc/sudoers: parsed OK
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 切换到普通用户</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># su - test</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成密钥对</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>test@ansible ~<span style=color:#f92672>]</span>$ ssh-keygen -f ~/.ssh/id_rsa -P <span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 将公钥拷贝到目标主机
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[test@ansible ~] ssh-copy-id  -o &#34;StrictHostKeyChecking=no&#34; test@192.168.0.133
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 验证免密登录成功
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[test@ansible ~]$ ssh test@192.168.0.133
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Last login: Mon Jun 12 09:50:05 2023
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 使用ansible进行远程控制，提示权限不足
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[test@ansible ~]$ ansible 192.168.0.133 -m shell -a &#39;</span>ls /root/<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>192.168.0.133 | FAILED | rc=2 &gt;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ls: cannot open directory /root/: Permission deniednon-zero return code
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 使用 sudo 提权后执行成功
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[test@ansible ~]$ ansible 192.168.0.133 -m shell -a &#39;</span>ls /root/<span style=color:#960050;background-color:#1e0010>&#39;</span> -b -K
</span></span><span style=display:flex><span>BECOME password: 
</span></span><span style=display:flex><span>192.168.0.133 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>ansible.cfg
</span></span></code></pre></div><p>**注意：**在上面的示例中，ansible 远控时并未指定远程的用户名，当没有用 -u 指定远程用户名时，默认使用当前的本机用户名进行远程</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.0.133 -m shell -a &#39;whoami&#39;</span>
</span></span><span style=display:flex><span>192.168.0.133 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>root
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># su - test</span>
</span></span><span style=display:flex><span>Last login: Mon Jun <span style=color:#ae81ff>12</span> 10:03:04 CST <span style=color:#ae81ff>2023</span> from 192.168.0.133 on pts/3
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>test@ansible ~<span style=color:#f92672>]</span>$ ansible 192.168.0.133 -m shell -a <span style=color:#e6db74>&#39;whoami&#39;</span>
</span></span><span style=display:flex><span>192.168.0.133 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>test
</span></span><span style=display:flex><span><span style=color:#75715e># 通过 -u 显式指明远程用户名</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>test@ansible ~<span style=color:#f92672>]</span>$ ansible 192.168.0.133 -m shell -a <span style=color:#e6db74>&#39;whoami&#39;</span> -u root -k
</span></span><span style=display:flex><span>SSH password: 
</span></span><span style=display:flex><span>192.168.0.133 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>root
</span></span></code></pre></div><p><strong>ansible Host-pattern</strong></p><p>用于匹配主机清单中的主机</p><p>准备主机清单文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /etc/ansible/hosts</span>
</span></span><span style=display:flex><span>192.168.0.133
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>hello<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>192.168.0.1
</span></span><span style=display:flex><span>172.31.5.1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>world<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>10.0.0.1
</span></span><span style=display:flex><span>172.31.5.1
</span></span></code></pre></div><p>all : 内置变量，表示所有主机</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible all --list-hosts</span>
</span></span><span style=display:flex><span>  hosts <span style=color:#f92672>(</span>4<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>    192.168.0.133
</span></span><span style=display:flex><span>    10.0.0.1
</span></span><span style=display:flex><span>    172.31.5.1
</span></span><span style=display:flex><span>    192.168.0.1
</span></span></code></pre></div><p>*<strong>: 通配符</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible &#34;*&#34; --list-hosts</span>
</span></span><span style=display:flex><span>  hosts <span style=color:#f92672>(</span>4<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>    192.168.0.133
</span></span><span style=display:flex><span>    10.0.0.1
</span></span><span style=display:flex><span>    172.31.5.1
</span></span><span style=display:flex><span>    192.168.0.1
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible &#34;192.168.0.*&#34; --list-hosts</span>
</span></span><span style=display:flex><span>  hosts <span style=color:#f92672>(</span>2<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>    192.168.0.1
</span></span><span style=display:flex><span>    192.168.0.133
</span></span></code></pre></div><p><strong>逻辑或</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible &#34;hello:world&#34; --list-hosts</span>
</span></span><span style=display:flex><span>  hosts <span style=color:#f92672>(</span>3<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>    192.168.0.1
</span></span><span style=display:flex><span>    172.31.5.1
</span></span><span style=display:flex><span>    10.0.0.1
</span></span></code></pre></div><p><strong>逻辑与</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible &#34;hello:&amp;world&#34; --list-hosts</span>
</span></span><span style=display:flex><span>  hosts <span style=color:#f92672>(</span>1<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>    172.31.5.1
</span></span></code></pre></div><p><strong>逻辑非</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 引用!号时,不要用双引号,而使用单引号</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 在Ansible中，单引号用于指定字面值模式，以确保其中的内容被视为普通字符，而不进行变量展开或转义字符处理。</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible &#39;all:!hello:!world&#39; --list-hosts</span>
</span></span><span style=display:flex><span>  hosts <span style=color:#f92672>(</span>1<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>    192.168.0.133
</span></span></code></pre></div><p><strong>正则表达式</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ansible <span style=color:#e6db74>&#34;~(web|db).*\.test\.com&#34;</span> -m ping
</span></span></code></pre></div><p><code>"~(web|db).*\.test\.com"</code>是用于选择目标主机的模式（pattern）。让我们逐步解释这个模式：</p><ul><li><code>~</code>是Ansible中用于匹配正则表达式的运算符。</li><li><code>(web|db)</code>表示选择以"web"或"db"开头的字符串。在这种情况下，模式将匹配"web"或"db"之后的任意字符。</li><li><code>.*</code>表示匹配零个或多个任意字符。</li><li><code>\.test\.com</code>表示匹配字符串".test.com"。</li></ul><p>因此，整个模式<code>~(web|db).*\.test\.com</code>将匹配以"web"或"db"开头，然后是任意字符（零个或多个），最后以".test.com"结尾的字符串。</p><p>使用该模式，<code>ansible</code>命令将选择符合该模式的远程主机，并对它们执行Ping操作。Ping操作旨在检查与目标主机的连通性，并确定是否可以与之通信。</p><p>综上所述，<code>ansible "~(web|db).*\.test\.com" -m ping</code>命令将使用Ansible选择以"web"或"db"开头，然后是任意字符，最后以".test.com"结尾的主机，并对它们执行Ping操作。</p><h5 id=2323-ansible-命令执行过程>2.3.2.3 Ansible 命令执行过程<a hidden class=anchor aria-hidden=true href=#2323-ansible-命令执行过程>#</a></h5><ol><li>加载配置文件，默认为 <code>/etc/ansible/ansible.cfg</code></li><li>匹配主机清单中对应的主机或者主机组</li><li>加载对应的模块文件，如：shell</li><li>通过 ansible 将模块或命令生成临时 py 文件，并将该文件传输至受控节点：<code>$HOME/.ansible/tmp/ansible-tmp-数字/XXX.PY文件</code></li><li>赋予 <code>xxx.py</code> 文件执行权限：<code>+x</code></li><li>执行并返回结果</li><li>删除 <code>xxx.py</code> 文件，结束</li></ol><h5 id=2324-ansible-命令执行状态>2.3.2.4 Ansible 命令执行状态<a hidden class=anchor aria-hidden=true href=#2324-ansible-命令执行状态>#</a></h5><p>每种状态对应了一个颜色标识</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># grep -A 14 &#39;\[colors\]&#39; /etc/ansible/ansible.cfg</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>colors<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#highlight = white</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#verbose = blue</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#warn = bright purple</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#error = red</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#debug = dark gray</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#deprecate = purple</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#skip = cyan</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#unreachable = red</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#ok = green</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#changed = yellow</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#diff_add = green</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#diff_remove = red</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#diff_lines = cyan</span>
</span></span></code></pre></div><p>常见的三种颜色标识：</p><ul><li><p><strong>绿色</strong>：表示任务成功完成。当任务在远程主机上成功执行并返回正确的结果时，该任务将以绿色显示。</p></li><li><p>**黄色：**表示任务已更改。当任务在远程主机上执行并导致一些更改时，但不会破坏系统或引发错误时，该任务将以黄色显示。例如，如果某个配置文件的某行已更改，但该更改不会导致问题或错误，任务状态将显示为黄色。</p></li><li><p>**红色：**表示任务失败。当任务在远程主机上执行时发生错误或返回错误结果时，该任务将以红色显示。这可能是由于连接问题、权限问题、语法错误或其他原因导致的失败。</p></li></ul><h4 id=233-ansible-console>2.3.3 ansible-console<a hidden class=anchor aria-hidden=true href=#233-ansible-console>#</a></h4><p>此工具主要用于交互式执行命令，支持命令补全，ansible 2.0+ 版本新增</p><p>提示符格式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>远程用户@目标主机组（组中的主机数量）<span style=color:#f92672>[</span>f:并发数<span style=color:#f92672>]</span>$
</span></span></code></pre></div><p>常用命令：</p><ul><li><p>设置并发数：forks <number></p></li><li><p>切换组：cd [group_name]</p></li><li><p>查看当前组中的主机：list</p></li><li><p>查看所有的内置命令：？或 help</p></li><li><p>退出：exit 或者 Ctrl+ D</p></li></ul><p>示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible-console</span>
</span></span><span style=display:flex><span>Welcome to the ansible console.
</span></span><span style=display:flex><span>Type help or ? to list commands.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@all <span style=color:#f92672>(</span>4<span style=color:#f92672>)[</span>f:5<span style=color:#f92672>]</span>$ forks <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>root@all <span style=color:#f92672>(</span>4<span style=color:#f92672>)[</span>f:6<span style=color:#f92672>]</span>$ cd hello
</span></span><span style=display:flex><span>root@hello <span style=color:#f92672>(</span>2<span style=color:#f92672>)[</span>f:6<span style=color:#f92672>]</span>$ exit
</span></span></code></pre></div><h4 id=234-ansible-playbook>2.3.4 ansible-playbook<a hidden class=anchor aria-hidden=true href=#234-ansible-playbook>#</a></h4><p>此工具主要用于执行编写好的 playbook 任务</p><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat hello.yaml # playbook 任务，打印 hello world</span>
</span></span><span style=display:flex><span>- hosts: localhost
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: hello world
</span></span><span style=display:flex><span>      shell: wall <span style=color:#e6db74>&#34;hello world&#34;</span> <span style=color:#75715e># 向所有已登录用户广播消息</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook hello.yaml # 执行 playbook 任务</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>localhost<span style=color:#f92672>]</span> ***************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>hello world<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Broadcast message from root@ansible.localdomain <span style=color:#f92672>(</span>Mon Jun <span style=color:#ae81ff>19</span> 09:15:36 2023<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hello world
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>localhost<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>localhost                  : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span></code></pre></div><h4 id=235-ansible-vault>2.3.5 ansible-vault<a hidden class=anchor aria-hidden=true href=#235-ansible-vault>#</a></h4><p>此工具用于加密，解密 yaml 文件</p><p>格式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ansible-vault <span style=color:#f92672>[</span>create,decrypt,edit,view,encrypt,encrypt_string,rekey<span style=color:#f92672>]</span> &lt;*.yaml&gt;
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-vault encrypt hello.yaml # 加密文件</span>
</span></span><span style=display:flex><span>New Vault password: 
</span></span><span style=display:flex><span>Confirm New Vault password: 
</span></span><span style=display:flex><span>Encryption successful
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-vault view hello.yaml # 查看加密文件内容，需要输入正确的密码</span>
</span></span><span style=display:flex><span>Vault password: 
</span></span><span style=display:flex><span>- hosts: localhost
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: hello world
</span></span><span style=display:flex><span>      shell: wall <span style=color:#e6db74>&#34;hello world&#34;</span>
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat hello.yaml # 正常查看，只能看到密文</span>
</span></span><span style=display:flex><span>$ANSIBLE_VAULT;1.1;AES256
</span></span><span style=display:flex><span><span style=color:#ae81ff>62623561653235343235613763393365396164323430366161363731646339303965316136333964</span>
</span></span><span style=display:flex><span>6662366334363161363465636630646532616334666538640a383037313035646537613264306130
</span></span><span style=display:flex><span><span style=color:#ae81ff>62323438653861613736336339353037373537633066396566366136373832666332636364336362</span>
</span></span><span style=display:flex><span>6130363834346566630a343765303630616631643436373036353966356663366537343863653535
</span></span><span style=display:flex><span><span style=color:#ae81ff>65653565653765363961313738386266336538353336376664643330316633303636333337336237</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>35653162313461383436643237623034363436373430363237346334663062306638386566313738</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>36346165643437643230396664346564383039623434346332313961303331383331313761663939</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>63313665306463356433393731663965366131353336666135343530613062306433623234623666</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>39633764623862353238613139333264343735303330626432363831646331653666313361316565</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3034363863323531393761316363626263653838313734343134</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook hello.yaml # 不能直接执行已加密的 playbook </span>
</span></span><span style=display:flex><span>ERROR! Attempting to decrypt but no vault secrets found
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook --ask-vault-pass hello.yaml # 加入选项，输入密码后执行</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat pass.txt # 准备密码文件，存放密码</span>
</span></span><span style=display:flex><span>dd
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook --vault-password-file pass.txt hello.yaml # 从文件中读取密码</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># grep vault_password_file /etc/ansible/ansible.cfg # 修改配置文件中的该项，指定密码文件路径</span>
</span></span><span style=display:flex><span>vault_password_file <span style=color:#f92672>=</span> /etc/ansible/pass.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook hello.yaml # 可以正常执行 playbook</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-vault edit hello.yaml # 编辑加密文件，需要输入正确的密码</span>
</span></span><span style=display:flex><span>Vault password: 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-vault decrypt hello.yaml # 解密文件</span>
</span></span><span style=display:flex><span>Vault password: 
</span></span><span style=display:flex><span>Decryption successful
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat hello.yaml # 可以看到未加密的原文</span>
</span></span><span style=display:flex><span>- hosts: localhost
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: hello world
</span></span><span style=display:flex><span>      shell: wall <span style=color:#e6db74>&#34;hello world +++&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-vault create new.yaml # 可以直接创建一个加密文件</span>
</span></span><span style=display:flex><span>New Vault password: 
</span></span><span style=display:flex><span>Confirm New Vault password: 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-vault rekey new.yaml # 输入旧密码后，可以更改密码</span>
</span></span><span style=display:flex><span>Vault password: 
</span></span><span style=display:flex><span>New Vault password: 
</span></span><span style=display:flex><span>Confirm New Vault password: 
</span></span><span style=display:flex><span>Rekey successful
</span></span></code></pre></div><h4 id=236-ansible-galaxy>2.3.6 ansible-galaxy<a hidden class=anchor aria-hidden=true href=#236-ansible-galaxy>#</a></h4><p>Galaxy 是一个免费网站, 类似于github网站, 网站上发布了很多的共享的roles角色。</p><p>Ansible 提供了ansible-galaxy命令行工具连接 <a href=https://galaxy.ansible.com>https://galaxy.ansible.com</a> 网站下载相应的roles，进行</p><p>init (初始化)、search ( 查拘)、install (安装)、 remove(移除)等操作。</p><p><code>ansible-galaxy</code>是一个与Ansible配置管理工具相关的命令行工具。它用于管理和扩展Ansible角色和集合。</p><p>使用<code>ansible-galaxy</code>，可以执行以下操作：</p><ol><li><p><strong>安装角色和集合</strong>：可以使用<code>ansible-galaxy install</code>命令安装其他人编写的Ansible角色或集合。例如，要安装一个名为<code>myrole</code>的角色，可以运行以下命令（默认下载到~/.ansible/roles下）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-galaxy install myrole
</span></span></code></pre></div></li><li><p><strong>创建角色</strong>：使用<code>ansible-galaxy init</code>命令可以创建一个新的Ansible角色结构。该命令将生成一个包含目录和文件的目录结构，用于组织角色的任务、变量、模板等内容。例如，要创建一个名为<code>myrole</code>的角色，可以运行以下命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-galaxy init myrole
</span></span></code></pre></div></li><li><p><strong>列出已安装的角色和集合</strong>：使用<code>ansible-galaxy list</code>命令可以列出已经安装在系统上的角色和集合。这将显示已安装的角色和集合的名称、版本号和其他详细信息。</p></li><li><p><strong>删除角色和集合</strong>：可以使用<code>ansible-galaxy remove</code>命令从系统中删除已安装的角色和集合。例如，要删除一个名为<code>myrole</code>的角色，可以运行以下命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-galaxy remove myrole
</span></span></code></pre></div></li></ol><p>这些只是<code>ansible-galaxy</code>命令的一些常见用法示例。有关更多详细信息和选项，请查阅Ansible官方文档或运行<code>ansible-galaxy --help</code>命令来获取帮助。</p><h3 id=24-ansible-常用模块>2.4 Ansible 常用模块<a hidden class=anchor aria-hidden=true href=#24-ansible-常用模块>#</a></h3><p>2015年12月只270多个模块</p><p>2016年12年26日ansible 1.9.2 有540个模块</p><p>2018年01月12日ansible 2.3.8 有1378个模块</p><p>2018年05月28日ansible 2.5.3 有1562个模块</p><p>2018年07月15日ansible 2.6.3 有1852个模块</p><p>2018年11月19日ansible 2.7.2 有2080个模块</p><p>2020年03月02日ansible 2.9.5 有3387个模块</p><p>2021年12月22日ansible 2.11.8 有6141个模块</p><p>2022年06月04日ansible 2.12.6 有6763个模块</p><p>虽然模块众多，但最常用的模块约30个左右，针对特定业务学习需要的模块即可</p><p>常用模块帮助文档参考：</p><p><a href=https://docs.ansible.com/ansible/2.9/modules/modules_by_category.html>Module Index — Ansible Documentation</a></p><p><a href=https://docs.ansible.com/ansible/2.9/modules/list_of_all_modules.html>All modules — Ansible Documentation</a></p><p><strong>本章节内容以此主机清单进行演示，ansible 为管理节点，remote 为受控节点</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># hostname -I</span>
</span></span><span style=display:flex><span>192.168.0.133
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /etc/ansible/hosts</span>
</span></span><span style=display:flex><span>remote ansible_ssh_host<span style=color:#f92672>=</span>192.168.0.134
</span></span><span style=display:flex><span>remote2 ansible_ssh_host<span style=color:#f92672>=</span>192.168.0.135
</span></span></code></pre></div><h4 id=241-command-模块>2.4.1 command 模块<a hidden class=anchor aria-hidden=true href=#241-command-模块>#</a></h4><blockquote><p>默认模块。在远程主机执行命令，执行命令时不加 -m 则默认使用此模块</p><p>此命令不支持 <code>&lt;</code>, <code>></code>, <code>|</code>, <code>;</code> and <code>&</code> 等高级特性或运算符</p><p><strong>此模块不具备幂等性</strong></p></blockquote><p>常用选项：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>chdir=DIR		# 切换目录</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>creates=FILE	# 当 FILE 不存在时，执行操作</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>removes=FILE	# 当 FILE 存在时，执行操作	</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 切换目录，查看系统版本</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -a &#39;chdir=/etc cat centos-release&#39;</span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>CentOS Linux release 7.6.1810 <span style=color:#f92672>(</span>Core<span style=color:#f92672>)</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 当 /tmp/tmp.txt 存在时，打印 hello</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -a &#39;chdir=/etc creates=/tmp/tmp.txt echo hello&#39;</span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>hello
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 当 /tmp/tmp.txt 存在时，打印 hell，这里条件不满足，任务直接被跳过</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -a &#39;chdir=/etc removes=/tmp/tmp.txt echo hello&#39;</span>
</span></span><span style=display:flex><span>localhost | SUCCESS | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>skipped, since /tmp/tmp.txt does not exist
</span></span></code></pre></div><p>不支持的高级特性：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建 hello.txt, 命令执行成功</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -a &#39;chdir=/tmp echo hello &gt; hello.txt&#39; </span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>hello &gt; hello.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 实际上文件并不存在</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -a &#39;chdir=/tmp ll hello.txt&#39; </span>
</span></span><span style=display:flex><span>localhost | FAILED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Errno 2<span style=color:#f92672>]</span> No such file or directory
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ll /tmp/hello.txt</span>
</span></span><span style=display:flex><span>ls: cannot access /tmp/hello.txt: No such file or directory
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 不支持 &amp;&amp;  ; | 等符号（尽管执行不报错）</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -a &#39;chdir=/tmp echo hello &gt; hello.txt &amp;&amp; echo world&#39;</span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>hello &gt; hello.txt <span style=color:#f92672>&amp;&amp;</span> echo world
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -a &#39;chdir=/tmp echo hello &gt; hello.txt ; echo world&#39;</span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>hello &gt; hello.txt ; echo world
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m command -a &#34;echo test | passwd --stdin pass&#34;</span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>test | passwd --stdin pass
</span></span></code></pre></div><h4 id=242-shell-模块>2.4.2 shell 模块<a hidden class=anchor aria-hidden=true href=#242-shell-模块>#</a></h4><blockquote><p>此模块功能与 command 几乎一致，但是功能会更强。Command 模块不支持的重定向，管道符等运算符在 Shell 模块中都是支持的（尽管如此，实际使用时尽量避免使用过于复杂或特殊的符号），除非有使用高级特性的需求，否则官方更推荐使用 command 模块（更加安全和稳定）。</p><p><strong>此模块不具备幂等性</strong></p></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>chdir<span style=color:#f92672>=</span>DIR		<span style=color:#75715e># 切换目录</span>
</span></span><span style=display:flex><span>creates<span style=color:#f92672>=</span>FILE	<span style=color:#75715e># 当 FILE 不存在时，执行操作</span>
</span></span><span style=display:flex><span>removes<span style=color:#f92672>=</span>FILE	<span style=color:#75715e># 当 FILE 存在时，执行操作</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 打印变量</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m shell -a &#34;echo $HOSTNAME&#34;</span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>localhost.localdomain
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 修改账号密码</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m shell -a &#34;echo pass | passwd --stdin test&#34;</span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>Changing password <span style=color:#66d9ef>for</span> user test.
</span></span><span style=display:flex><span>passwd: all authentication tokens updated successfully.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 使用重定向生成文件，并输出内容</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m shell -a &#34;echo hello &gt; /tmp/hello.txt &amp;&amp; ls /tmp/hello.txt &amp;&amp; cat /tmp/hello.txt&#34;</span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/hello.txt
</span></span><span style=display:flex><span>hello
</span></span></code></pre></div><blockquote><p>注意：类似 cat /tmp/test.md | awk -F&rsquo;|&rsquo; &lsquo;{print $1,$2}&rsquo; &> /tmp/example.txt 的复杂命令，即使使用Shell模块也可能会失败。可以考虑将命令写成 shell 脚本，再通过 Script 模块进行调用</p></blockquote><p><strong>Ansible 命令所使用的默认模块是 command，可以通过修改配置项重新指定为别的模块：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># grep module_name /etc/ansible/ansible.cfg</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#module_name = command</span>
</span></span></code></pre></div><h4 id=243-script-模块>2.4.3 script 模块<a hidden class=anchor aria-hidden=true href=#243-script-模块>#</a></h4><blockquote><p>此模块可以在远程主机执行 Ansible 主机上的脚本（脚本不需要执行权限）</p><p><strong>此模块不具备幂等性</strong></p></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chdir<span style=color:#f92672>=</span>DIR		<span style=color:#75715e># 切换目录</span>
</span></span><span style=display:flex><span>creates<span style=color:#f92672>=</span>FILE	<span style=color:#75715e># 当 FILE 不存在时，执行操作</span>
</span></span><span style=display:flex><span>removes<span style=color:#f92672>=</span>FILE	<span style=color:#75715e># 当 FILE 存在时，执行操作	</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 准备一个脚本文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># cat test.sh </span>
</span></span><span style=display:flex><span>echo hello
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 该文件无执行权限</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ll test.sh </span>
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>11</span> Jun <span style=color:#ae81ff>20</span> 15:44 test.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 通过 script模块 在目标主机执行该脚本</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m script -a &#39;test.sh&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;rc&#34;</span>: 0, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;Shared connection to 192.168.0.134 closed.\r\n&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Shared connection to 192.168.0.134 closed.&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;hello\r\n&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;hello&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=244-copy-模块>2.4.4 copy 模块<a hidden class=anchor aria-hidden=true href=#244-copy-模块>#</a></h4><blockquote><p>此模块用于文件拷贝，有两种用法：</p><ul><li>将 ansible 主机上的文件拷贝到受控节点</li><li>将受控节点的文件拷贝到受控节点的其他路径</li></ul></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>src      <span style=color:#75715e># 控制端的源文件路径</span>
</span></span><span style=display:flex><span>dest     <span style=color:#75715e># 被控端的文件路径</span>
</span></span><span style=display:flex><span>owner    <span style=color:#75715e># 属主</span>
</span></span><span style=display:flex><span>group    <span style=color:#75715e># 属组</span>
</span></span><span style=display:flex><span>mode     <span style=color:#75715e># 权限</span>
</span></span><span style=display:flex><span>backup   <span style=color:#75715e># 是否备份</span>
</span></span><span style=display:flex><span>validate <span style=color:#75715e># 验证成功才会执行copy</span>
</span></span><span style=display:flex><span>remote_src  <span style=color:#75715e># no 是默认值, 表示 src 文件在 ansible 主机, yes表示 src 文件在远程主机</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建local.txt 并将其拷贝到 remote 主机上</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># touch local.txt</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m copy -a &#39;src=local.txt dest=/tmp/remote.txt owner=test mode=600&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 成功拷贝到 remote 主机</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;ls /tmp/remote.txt&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/remote.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 修改local.txt 文件内容，再次执行拷贝操作</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># echo hello &gt;&gt; local.txt </span>
</span></span><span style=display:flex><span><span style=color:#75715e># 当文件内容变化，且 backup=yes 时，会在拷贝操作执行前，在目标主机生成一个以时间戳为后缀的备份文件，如：remote.txt.9235.2023-06-20@16:52:58~</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#34;ls /tmp&#34;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>ansible_command_payload_QQiJzZ
</span></span><span style=display:flex><span>remote.txt
</span></span><span style=display:flex><span>remote.txt.9235.2023-06-20@16:52:58~
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 拷贝 remote 主机的文件到指定路径，remote_src 表示源文件在目标主机上</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m copy -a &#34;src=/tmp/remote.txt dest=/tmp/local.txt owner=test mode=600 remote_src=yes&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 成功在 remote 主机的 /tmp 目录下 复制了一个 local.txt 文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#34;ls /tmp/local.txt&#34;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/local.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 直接指定文件内容，生成文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m copy -a &#39;content=&#34;hello\nworld\n&#34; dest=/tmp/hello.txt&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;cat /tmp/hello.txt&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>hello
</span></span><span style=display:flex><span>world
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#### 拷贝整个文件夹 /tmp 到 remote 主机。注意：是 /tmp 而非 /tmp/</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m copy -a &#39;src=/tmp dest=/tmp/&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;ls -d /tmp/tmp&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/tmp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>### 拷贝/tmp 文件夹下的文件到目标主机</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 提前在目标主机新建一个空文件夹用于存放 /tmp 目录下的文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@remote ~<span style=color:#f92672>]</span><span style=color:#75715e># ls -d /test/</span>
</span></span><span style=display:flex><span>/test/
</span></span><span style=display:flex><span><span style=color:#75715e># 在 /tmp 文件夹下有一个 test.txt 文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ls /tmp/test.txt </span>
</span></span><span style=display:flex><span>/tmp/test.txt
</span></span><span style=display:flex><span><span style=color:#75715e># 执行拷贝操作，观察到成功拷贝 /tmp 文件夹下的文件到目标主机</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m copy -a &#39;src=/tmp/ dest=/test&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;ls /test&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>test.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 复制文件并执行校验命令，注意：%s 是一个占位符，将在命令执行时被替换为源文件的路径。</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m copy -a &#34;src=/etc/sudoers dest=/etc/sudoers.bak remote_src=yes validate=&#39;/usr/sbin/visudo -csf %s&#39;&#34;</span>
</span></span></code></pre></div><h4 id=245-get_url-模块>2.4.5 get_url 模块<a hidden class=anchor aria-hidden=true href=#245-get_url-模块>#</a></h4><blockquote><p>此模块使用 http、https 或 ftp 协议下载文件</p></blockquote><p>常用参数：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>url   <span style=color:#75715e># 下载文件的URL,支持 HTTP，HTTPS 或 FTP 协议</span>
</span></span><span style=display:flex><span>dest  <span style=color:#75715e># 下载到目标路径（绝对路径），如果目标是一个目录，就用原文件名，如果目标设置了名称就用目标设置的名称</span>
</span></span><span style=display:flex><span>owner <span style=color:#75715e># 指定属主</span>
</span></span><span style=display:flex><span>group <span style=color:#75715e># 指定属组</span>
</span></span><span style=display:flex><span>mode  <span style=color:#75715e># 指定权限</span>
</span></span><span style=display:flex><span>force <span style=color:#75715e># 如果 yes，dest 不是目录，将每次下载文件，如果内容改变替换文件。如果 no，则只有在目标不存在时才会下载，默认：no</span>
</span></span><span style=display:flex><span>checksum  <span style=color:#75715e># 对目标文件在下载后计算摘要，以确保其完整性</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># 示例: </span>
</span></span><span style=display:flex><span>             <span style=color:#75715e>#    checksum=&#34;sha256:D98291AC[...]B6DC7B97&#34;,</span>
</span></span><span style=display:flex><span>             <span style=color:#75715e>#    checksum=&#34;sha256:http://example.com/path/sha256sum.txt&#34;</span>
</span></span><span style=display:flex><span>url_username <span style=color:#75715e># 用于HTTP基本认证的用户名。 对于允许空密码的站点，此参数可以不使用</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>`</span>url_password<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>url_password # 用于HTTP基本认证的密码。 如果未指定`url_username&#39;</span>参数，则不生效
</span></span><span style=display:flex><span><span style=color:#e6db74>`</span>url_password<span style=color:#960050;background-color:#1e0010>&#39;</span>参数
</span></span><span style=display:flex><span>validate_certs <span style=color:#75715e># 如果“no”，SSL证书将不会被验证。 适用于自签名证书在私有网站上使用</span>
</span></span><span style=display:flex><span>timeout  <span style=color:#75715e># URL请求的超时时间,秒为单位</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 下载 nginx 至 remote 主机，并校验 md5 值 </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m get_url -a &#39;url=http://nginx.org/download/nginx-1.18.0.tar.gz dest=/usr/local/src checksum=&#34;md5:b2d33d24d89b8b1f87ff5d251aa27eb8&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 下载成功</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;ls /usr/local/src/&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>nginx-1.18.0.tar.gz
</span></span></code></pre></div><h4 id=246-fetch-模块>2.4.6 fetch 模块<a hidden class=anchor aria-hidden=true href=#246-fetch-模块>#</a></h4><blockquote><p>此模块可以将受控节点的文件拉取至 ansible 主控端，和 copy 模块功能相反，目前不支持拉取目录</p></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>src 	<span style=color:#75715e># 受控节点源文件路径</span>
</span></span><span style=display:flex><span>dest 	<span style=color:#75715e># ansible 主控端目录路径</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 如果同时拉取多台主机的同一文件，ansible 会为每台主机建立单独的文件夹来存放拉取的文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible all --list-hosts</span>
</span></span><span style=display:flex><span>  hosts <span style=color:#f92672>(</span>2<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>    remote
</span></span><span style=display:flex><span>    remote2
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#75715e># 将远程主机的redhat-release 文件拉取至 ansible 主机的 /tmp/os目录下（目录会自动创建）</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible all -m fetch -a &#39;src=/etc/redhat-release dest=/tmp/os/&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># tree /tmp/os/</span>
</span></span><span style=display:flex><span>/tmp/os/
</span></span><span style=display:flex><span>├── remote
</span></span><span style=display:flex><span>│   └── etc
</span></span><span style=display:flex><span>│       └── redhat-release
</span></span><span style=display:flex><span>└── remote2
</span></span><span style=display:flex><span>    └── etc
</span></span><span style=display:flex><span>        └── redhat-release
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span> directories, <span style=color:#ae81ff>2</span> files
</span></span></code></pre></div><h4 id=247-file-模块>2.4.7 file 模块<a hidden class=anchor aria-hidden=true href=#247-file-模块>#</a></h4><blockquote><p>此模块用于创建，删除文件，目录和软连接以及修改相关属性</p></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>path 	<span style=color:#75715e># 在被控端创建的路径</span>
</span></span><span style=display:flex><span>owner 	<span style=color:#75715e># 属主</span>
</span></span><span style=display:flex><span>group 	<span style=color:#75715e># 属组</span>
</span></span><span style=display:flex><span>mode 	<span style=color:#75715e># 权限</span>
</span></span><span style=display:flex><span>state 	<span style=color:#75715e># 状态</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>touch    	<span style=color:#75715e># 创建文件</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>directory 	<span style=color:#75715e># 创建目录</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>link 	<span style=color:#75715e># 软链接</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>hard     <span style=color:#75715e># 硬链接</span>
</span></span><span style=display:flex><span>recurse     <span style=color:#75715e># yes 表示递归授权</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建文件并修改属主</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m file -a &#39;path=/tmp/file.txt state=touch owner=test mode=755&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 删除文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m file -a &#39;path=/tmp/file.txt state=absent&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建软连接，其中 dest 还可以替换为[ path | name ]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m file -a &#39;src=/etc/redhat-release dest=/tmp/release-link state=link&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;cat /tmp/release-link&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>CentOS Linux release 7.6.1810 <span style=color:#f92672>(</span>Core<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建目录</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m file -a &#39;path=/tmp/dir state=directory&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 递归修改文件属性</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m file -a &#39;path=/tmp  owner=test group=test recurse=yes&#39;</span>
</span></span></code></pre></div><h4 id=248-stat-模块>2.4.8 stat 模块<a hidden class=anchor aria-hidden=true href=#248-stat-模块>#</a></h4><blockquote><p>此模块用于检查文件或文件系统状态</p></blockquote><p><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/stat_module.html#ansible-collections-ansible-builtin-stat-module>ansible.builtin.stat module – Retrieve file or file system status — Ansible Documentation</a></p><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>path  	<span style=color:#75715e># 文件或对象的完整路径（必须）</span>
</span></span></code></pre></div><p>常见返回值：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>attributes：# 返回指定文件的属性。
</span></span><span style=display:flex><span>executable：# 如果调用的用户在目标路径上有执行权限，则返回 true。
</span></span><span style=display:flex><span>exists：	<span style=color:#75715e># 如果指定的路径存在，返回真。</span>
</span></span><span style=display:flex><span>gr_name：# 返回文件所有者的组的名称。
</span></span><span style=display:flex><span>islbk：	<span style=color:#75715e># 如果指定的文件是一个块状设备，则返回true。</span>
</span></span><span style=display:flex><span>ischr： 	<span style=color:#75715e># 如果指定的文件是一个字符文件，则返回真。</span>
</span></span><span style=display:flex><span>isreg：	<span style=color:#75715e># 如果指定的文件是一个常规文件，则返回真。</span>
</span></span><span style=display:flex><span>isdir：	<span style=color:#75715e># 如果指定的文件是一个目录，则返回真。</span>
</span></span><span style=display:flex><span>islnk：	<span style=color:#75715e># 如果目标文件是一个链接，则返回真。</span>
</span></span><span style=display:flex><span>mode：	<span style=color:#75715e># 以八进制符号返回文件权限。</span>
</span></span><span style=display:flex><span>isuid： 	<span style=color:#75715e># isuid 表示 &#34;is setuid&#34;，用于判断文件是否具有设置用户 ID (Set User ID，SUID) 权限。</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@remote ~<span style=color:#f92672>]</span><span style=color:#75715e># chmod a+s /etc/centos-release</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@remote ~<span style=color:#f92672>]</span><span style=color:#75715e># ll /etc/centos-release</span>
</span></span><span style=display:flex><span>-rwSr-Sr--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>38</span> Nov <span style=color:#ae81ff>23</span>  <span style=color:#ae81ff>2018</span> /etc/centos-release
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m stat -a &#39;path=/etc/centos-release&#39;</span>
</span></span><span style=display:flex><span>remote | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;stat&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;atime&#34;</span>: 1687316675.220694, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;attr_flags&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;attributes&#34;</span>: <span style=color:#f92672>[]</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;block_size&#34;</span>: 4096, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;blocks&#34;</span>: 8, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;charset&#34;</span>: <span style=color:#e6db74>&#34;us-ascii&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;checksum&#34;</span>: <span style=color:#e6db74>&#34;dd9a53b0d396d3ab190cfbc08dca572d3e741a03&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ctime&#34;</span>: 1687316666.4736364, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;dev&#34;</span>: 64768, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;device_type&#34;</span>: 0, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;executable&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;exists&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;gid&#34;</span>: 0, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;gr_name&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;inode&#34;</span>: 67184137, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isblk&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ischr&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isdir&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isfifo&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isgid&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;islnk&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isreg&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;issock&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isuid&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;mimetype&#34;</span>: <span style=color:#e6db74>&#34;text/plain&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;mode&#34;</span>: <span style=color:#e6db74>&#34;6644&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;mtime&#34;</span>: 1542979018.0, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;nlink&#34;</span>: 1, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;/etc/centos-release&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;pw_name&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;readable&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;rgrp&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;roth&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;rusr&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;size&#34;</span>: 38, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;uid&#34;</span>: 0, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;815093836&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;wgrp&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;woth&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;writeable&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;wusr&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;xgrp&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;xoth&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;xusr&#34;</span>: false
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=249-unarchive-模块>2.4.9 unarchive 模块<a hidden class=anchor aria-hidden=true href=#249-unarchive-模块>#</a></h4><blockquote><p>此模块用于解包和解压缩，有两种用法：</p><ul><li>将 ansible 主机上的压缩文件解压至受控节点的指定路径下</li><li>将非 ansible 的其他主机的压缩文件解压到受控节点的指定路径下</li></ul></blockquote><p>常见参数：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>remote_src 	<span style=color:#75715e># yes 表示源文件在远程被控主机或非 ansible 的其它主机上，no 表示文件在ansible主机上, 默认值为 no, 此选项代替copy选项（已废弃）</span>
</span></span><span style=display:flex><span>src <span style=color:#75715e>#源路径，可以是 ansible 主机上的路径，也可以是远程主机(被管理端或者第三方主机)上的路径，如果是远程主机上的路径，则需要设置 remote_src=yes</span>
</span></span><span style=display:flex><span>dest 	<span style=color:#75715e># 远程主机上的目标路径</span>
</span></span><span style=display:flex><span>mode 	<span style=color:#75715e># 设置解压缩后的文件权限</span>
</span></span><span style=display:flex><span>creates<span style=color:#f92672>=</span>PATH <span style=color:#75715e># 当PATH不存在时才会执行</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 解压本地文件到受控节点的指定目录（目标目录不存在会报错，不会自动创建）</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m unarchive -a &#39;src=/tmp/test.tar.gz dest=/tmp/&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 解压其他主机的压缩包到受控节点</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m unarchive -a &#39;src=https://releases.ansible.com/ansible/ansible-2.1.6.0-0.1.rc1.tar.gz dest=/tmp remote_src=yes&#39;</span>
</span></span></code></pre></div><h4 id=2410-archive-模块>2.4.10 archive 模块<a hidden class=anchor aria-hidden=true href=#2410-archive-模块>#</a></h4><blockquote><p>此模块用于在受控节点打包压缩文件</p></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>path   <span style=color:#75715e># 压缩的文件或目录</span>
</span></span><span style=display:flex><span>dest   <span style=color:#75715e># 压缩后的文件</span>
</span></span><span style=display:flex><span>format <span style=color:#75715e># 压缩格式,支持gz,bz2,xz,tar,zip</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible tmp<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m archive -a &#39;path=/etc/redhat-release dest=/tmp/log.tar.gz format=gz&#39;</span>
</span></span></code></pre></div><h4 id=2411-hostname-模块>2.4.11 hostname 模块<a hidden class=anchor aria-hidden=true href=#2411-hostname-模块>#</a></h4><blockquote><p>此模块用于修改主机名</p></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>name 	<span style=color:#75715e># 要修改的目标主机名</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m hostname -a &#39;name=test&#39;</span>
</span></span></code></pre></div><h4 id=2412-cron-模块>2.4.12 cron 模块<a hidden class=anchor aria-hidden=true href=#2412-cron-模块>#</a></h4><blockquote><p>此模块用于创建计划任务</p></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>name 		<span style=color:#75715e># 任务名称，可以根据此名称删除对应的计划任务</span>
</span></span><span style=display:flex><span>minute    	<span style=color:#75715e># 分钟</span>
</span></span><span style=display:flex><span>hour 		<span style=color:#75715e># 小时</span>
</span></span><span style=display:flex><span>weekday    	<span style=color:#75715e># 周</span>
</span></span><span style=display:flex><span>user		<span style=color:#75715e># 任务由哪个用户运行；默认root</span>
</span></span><span style=display:flex><span>job 		<span style=color:#75715e># 任务</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建一个计划任务，命名为 test</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m cron -a &#39;minute=0 hour=2 weekday=1-5 job=&#34;echo test&#34; name=hello&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看创建结果</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;crontab -l&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#75715e>#Ansible: hello</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> <span style=color:#ae81ff>2</span> * * 1-5 echo test
</span></span></code></pre></div><h4 id=2413-yum-和-apt-模块>2.4.13 yum 和 apt 模块<a hidden class=anchor aria-hidden=true href=#2413-yum-和-apt-模块>#</a></h4><blockquote><p>此模块用于管理软件包</p></blockquote><ul><li>yum：适用于RHEL，CentoOS，Fedora 等系统</li><li>apt：适用于Debian，Ubuntu 等系统</li></ul><p>yum 模块常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>name 		<span style=color:#75715e># 软件包名称</span>
</span></span><span style=display:flex><span>state 		<span style=color:#75715e># 状态</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>present 	<span style=color:#75715e># 安装, 此为默认值</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>absent 	<span style=color:#75715e># 删除</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>latest 	<span style=color:#75715e># 最新版</span>
</span></span><span style=display:flex><span>list        <span style=color:#75715e># 列出指定包</span>
</span></span><span style=display:flex><span>enablerepo 	<span style=color:#75715e># 启用仓库xx</span>
</span></span><span style=display:flex><span>disablerepo <span style=color:#75715e># 禁用仓库xx</span>
</span></span><span style=display:flex><span>exclude 	<span style=color:#75715e># 排除指定的包</span>
</span></span><span style=display:flex><span>validate    <span style=color:#75715e># 是否检验, 默认为 yes</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 安装 httpd</span>
</span></span><span style=display:flex><span>ansible remote -m yum -a <span style=color:#e6db74>&#39;name=httpd state=present&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 删除 httpd</span>
</span></span><span style=display:flex><span>ansible remote -m yum -a <span style=color:#e6db74>&#39;name=httpd state=absent&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 从网络源安装 zabbix （由于缺少其他依赖包，该命令可能执行失败）</span>
</span></span><span style=display:flex><span>ansible remote -m yum -a <span style=color:#e6db74>&#39;name=https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/8/x86_64/zabbix-agent2-5.0.24-1.el8.x86_64.rpm state=present validate_certs=no&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 启用 epel 源安装 nginx</span>
</span></span><span style=display:flex><span>ansible remote -m yum -a <span style=color:#e6db74>&#39;name=nginx state=present enablerepo=epel&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 明确禁用 epel 源会导致安装失败（找不到 nginx 包）</span>
</span></span><span style=display:flex><span>ansible remote -m yum -a <span style=color:#e6db74>&#39;name=nginx state=present disablerepo=epel&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安装除了 kernel* 和 foo* 匹配到的其余所有包（测试使用，谨慎执行）</span>
</span></span><span style=display:flex><span>ansible remote -m yum -a <span style=color:#e6db74>&#39;name=* state=latest exclude=kerner*,foo*&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 列出所有版本的包</span>
</span></span><span style=display:flex><span>ansible remote -m yum -a <span style=color:#e6db74>&#39;list=tree&#39;</span>
</span></span></code></pre></div><h4 id=2414-yum_repository>2.4.14 yum_repository<a hidden class=anchor aria-hidden=true href=#2414-yum_repository>#</a></h4><blockquote><p>此模块用于 yum 仓库的配置管理</p></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>name 		<span style=color:#75715e># 仓库id，也是配置文件名</span>
</span></span><span style=display:flex><span>description <span style=color:#75715e># 仓库描述名称,对应配置文件中的name=</span>
</span></span><span style=display:flex><span>baseurl 	<span style=color:#75715e># 仓库的地址</span>
</span></span><span style=display:flex><span>gpgcheck 	<span style=color:#75715e># 开启密钥验证</span>
</span></span><span style=display:flex><span>gpgkey      <span style=color:#75715e># 仓库公钥路径</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 添加 nginx 仓库</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m yum_repository -a &#39;name=nginx-repo description=&#34;nginx repo&#34; baseurl=&#34;http://nginx.org/packages/centos/$releasever/$basearch/&#34; gpgcheck=yes gpgkey=&#34;https://nginx.org/keys/nginx_signing.key&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看添加结果</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;cat /etc/yum.repos.d/nginx-repo.repo&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>nginx-repo<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>baseurl <span style=color:#f92672>=</span> http://nginx.org/packages/centos/$releasever/$basearch/
</span></span><span style=display:flex><span>gpgcheck <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>gpgkey <span style=color:#f92672>=</span> https://nginx.org/keys/nginx_signing.key
</span></span><span style=display:flex><span>name <span style=color:#f92672>=</span> nginx repo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 删除 nginx 仓库</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m yum_repository -a &#39;name=nginx-repo state=absent&#39;</span>
</span></span></code></pre></div><h4 id=2415-service-模块>2.4.15 service 模块<a hidden class=anchor aria-hidden=true href=#2415-service-模块>#</a></h4><blockquote><p>此模块和 systemd 的功能类似，用于管理系统服务</p></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>name 	<span style=color:#75715e># 服务名称</span>
</span></span><span style=display:flex><span>state 	<span style=color:#75715e># 服务状态</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>=</span>started 	<span style=color:#75715e># 启动</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>=</span>stopped 	<span style=color:#75715e># 停止</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>=</span>restarted  <span style=color:#75715e># 重启</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>=</span>reloaded   <span style=color:#75715e># 重载</span>
</span></span><span style=display:flex><span>enabled 		<span style=color:#75715e># 开启自启动</span>
</span></span><span style=display:flex><span>daemon_reload   <span style=color:#75715e># 加载新的配置文件,适用于systemd模块</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 启动并设置 httpd 服务开机自启动</span>
</span></span><span style=display:flex><span>ansible remote -m service -a <span style=color:#e6db74>&#39;name=httpd state=started enabled=yes&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 关闭 httpd 服务，并关闭开机自启</span>
</span></span><span style=display:flex><span>ansible remote -m service -a <span style=color:#e6db74>&#39;name=httpd state=stopped enabled=no&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重启指定网卡服务</span>
</span></span><span style=display:flex><span>ansible remote -m service -a <span style=color:#e6db74>&#39;name=network state=restarted args=ens33&#39;</span>
</span></span></code></pre></div><h4 id=2416-user-模块>2.4.16 user 模块<a hidden class=anchor aria-hidden=true href=#2416-user-模块>#</a></h4><blockquote><p>此模块用于用户管理</p></blockquote><p>常用选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>name 			<span style=color:#75715e># 创建的名称</span>
</span></span><span style=display:flex><span>uid 			<span style=color:#75715e># 指定 uid</span>
</span></span><span style=display:flex><span>group 			<span style=color:#75715e># 指定基本组</span>
</span></span><span style=display:flex><span>shell 			<span style=color:#75715e># 登录 shell 类型默认 /bin/bash</span>
</span></span><span style=display:flex><span>create_home 	<span style=color:#75715e># 是否创建家目录</span>
</span></span><span style=display:flex><span>password 		<span style=color:#75715e># 设定对应的密码，必须是加密后的字符串才行，否则不生效</span>
</span></span><span style=display:flex><span>system 			<span style=color:#75715e># yes 表示系统用户</span>
</span></span><span style=display:flex><span>groups      	<span style=color:#75715e># 附加组</span>
</span></span><span style=display:flex><span>append 			<span style=color:#75715e># 追加附加组使用, yes 表示增加新的附加组</span>
</span></span><span style=display:flex><span>state    		<span style=color:#75715e># absent 删除</span>
</span></span><span style=display:flex><span>remove 			<span style=color:#75715e># yes 表示删除用户时将家目录一起删除</span>
</span></span><span style=display:flex><span>generate_ssh_key <span style=color:#75715e># 创建私钥</span>
</span></span><span style=display:flex><span>ssh_keyu_bits    <span style=color:#75715e># 私钥位数</span>
</span></span><span style=display:flex><span>ssh_key_file     <span style=color:#75715e># 私钥文件路径</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建用户并指定相关属性（家目录会自动创建）</span>
</span></span><span style=display:flex><span>ansible remote -m user -a <span style=color:#e6db74>&#39;name=test uid=1001  home=/app/test shell=/bin/sh&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建系统用户（uid &lt; 1000）</span>
</span></span><span style=display:flex><span>ansible remote -m user -a <span style=color:#e6db74>&#39;name=test1  home=/app/test1 shell=/bin/bash system=yes&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 利用 debug 模块生成加密密码</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m debug -a &#39;msg={{ &#34;123456&#34; | password_hash(&#34;sha512&#34;,&#34;salt&#34;) }}&#39;</span>
</span></span><span style=display:flex><span>localhost | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;</span>$6$salt$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w<span style=color:#e6db74>.igcOo1R7vBYR65JquIQ/7siC7VRpmteKvZmfSkNc69.&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建用户并指定密码（如果直接指定明文密码，执行虽然成功，但是登录时会报密码错误）</span>
</span></span><span style=display:flex><span>ansible remote -m user -a <span style=color:#e6db74>&#39;name=test2 shell=/bin/bash password=$6$salt$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w.igcOo1R7vBYR65JquIQ/7siC7VRpmteKvZmfSkNc69.&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建用户并生成 2048 bit 的用户私钥</span>
</span></span><span style=display:flex><span>ansible remote -m user -a <span style=color:#e6db74>&#39;name=test3 generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=.ssh/id_rsa&#39;</span> 
</span></span></code></pre></div><h4 id=2417-group-模块>2.4.17 group 模块<a hidden class=anchor aria-hidden=true href=#2417-group-模块>#</a></h4><blockquote><p>此模块用于管理用户组</p></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>name        <span style=color:#75715e># 指定组名称</span>
</span></span><span style=display:flex><span>gid         <span style=color:#75715e># 指定gid</span>
</span></span><span style=display:flex><span>state 
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>present  <span style=color:#75715e># 创建, 默认</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>absent   <span style=color:#75715e># 删除</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建系统用户组</span>
</span></span><span style=display:flex><span>ansible remote -m group -a <span style=color:#e6db74>&#39;name=test system=yes&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 删除组</span>
</span></span><span style=display:flex><span>ansible remote -m group -a <span style=color:#e6db74>&#39;name=test state=absent&#39;</span>
</span></span></code></pre></div><p>2.4.18 lineinfile 模块</p><blockquote><p>此模块相当于 sed ，用于对文本进行单行替换。之所以不用 sed ，是因为 ansible 对特殊符号的支持不强，实际操作时可能无法替换，且需要对符号进行转义，比较麻烦。</p></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>path 		<span style=color:#75715e># 被控端文件的路径</span>
</span></span><span style=display:flex><span>regexp 		<span style=color:#75715e># 正则匹配字符串</span>
</span></span><span style=display:flex><span>line 		<span style=color:#75715e># 替换的目标内容</span>
</span></span><span style=display:flex><span>state 		<span style=color:#75715e># absent 表示删除</span>
</span></span><span style=display:flex><span>insertafter     <span style=color:#75715e># 插入到匹配行前</span>
</span></span><span style=display:flex><span>insertbefore    <span style=color:#75715e># 插入到匹配行后</span>
</span></span><span style=display:flex><span>backrefs        <span style=color:#75715e># 是否支持后向引用</span>
</span></span><span style=display:flex><span>backup          <span style=color:#75715e># 修改前先备份</span>
</span></span><span style=display:flex><span>create          <span style=color:#75715e># 如果文件不存在, 则创建, 默认不存在会出错</span>
</span></span><span style=display:flex><span>mode            <span style=color:#75715e># 指定权限</span>
</span></span><span style=display:flex><span>owner           <span style=color:#75715e># 指定用户</span>
</span></span><span style=display:flex><span>group           <span style=color:#75715e># 指定组</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 注意</span>
</span></span><span style=display:flex><span><span style=color:#75715e># regexp参数：使用正则表达式匹配对应的行，当替换文本时，如果匹配到了多行，只有最后一个匹配行会被替换。当删除文本时，所有匹配到的行都会被删除。</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 修改 httpd 服务的监听端口</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#39;path=/etc/httpd/conf/httpd.conf regexp=&#34;^Listen&#34; line=&#34;Listen 8080&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 禁用 selinux</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#39;path=/etc/selinux/config regexp=&#34;^SELINUX=&#34; line=&#34;SELINUX=disabled&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 添加网关</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=&#34;GATEWAY=10.0.0.254&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 在最后一行添加网关配置</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=&#34;GATEWAY=10.0.0.254&#34;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证添加结果</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;tail -n1 /etc/sysconfig/network-scripts/ifcfg-ens33&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>GATEWAY<span style=color:#f92672>=</span>10.0.0.254
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 删除添加的网关配置</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=&#34;GATEWAY=10.0.0.254&#34; state=absent&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 添加一个网关，在 &#34;NAME=&#34; 该行前添加</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=&#34;GATEWAY=10.0.0.254&#34; insertbefore=&#34;^NAME=&#34;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看添加结果</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;grep -i gateway /etc/sysconfig/network-scripts/ifcfg-ens33 -A 1&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>GATEWAY<span style=color:#f92672>=</span>10.0.0.254
</span></span><span style=display:flex><span>NAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ens33&#34;</span>
</span></span></code></pre></div><h4 id=2418-lineinfile-模块>2.4.18 lineinfile 模块<a hidden class=anchor aria-hidden=true href=#2418-lineinfile-模块>#</a></h4><blockquote><p>此模块主要用于基于正则的单行文本匹配和替换</p></blockquote><p>ansible 对特殊符号的支持不是很好，如果用 sed 进行复杂字符替换很可能出现问题，因此在进行文本替换时，最好用该模块而非sed</p><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>path 			<span style=color:#75715e>#被控端文件的路径</span>
</span></span><span style=display:flex><span>regexp 			<span style=color:#75715e>#正则匹配语法格式,表示被替换的内容</span>
</span></span><span style=display:flex><span>line 			<span style=color:#75715e>#替换为的内容</span>
</span></span><span style=display:flex><span>state 			<span style=color:#75715e>#absent表示删除</span>
</span></span><span style=display:flex><span>insertafter     <span style=color:#75715e>#插入匹配行后</span>
</span></span><span style=display:flex><span>insertbefore    <span style=color:#75715e>#插入匹配行前</span>
</span></span><span style=display:flex><span>backrefs        <span style=color:#75715e>#支持后向引用, yes 和 no</span>
</span></span><span style=display:flex><span>backup          <span style=color:#75715e>#修改前先备份</span>
</span></span><span style=display:flex><span>create          <span style=color:#75715e>#如果文件不存在, 则创建, 默认不存在会出错</span>
</span></span><span style=display:flex><span>mode            <span style=color:#75715e>#指定权限</span>
</span></span><span style=display:flex><span>owner           <span style=color:#75715e>#指定用户</span>
</span></span><span style=display:flex><span>group           <span style=color:#75715e>#指定组</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#注意</span>
</span></span><span style=display:flex><span>regexp 参数：使用正则表达式匹配对应的行，有两种处理方式
</span></span><span style=display:flex><span>	当替换文本时，如果有多个匹配行，则只会对最后一行进行替换
</span></span><span style=display:flex><span>	当删除文本时，如果有多行文本都能被匹配，这么这些行都会被删除。
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 关闭 selinux</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#34;path=/etc/selinux/config regexp=&#39;^SELINUX=&#39; line=&#39;SELINUX=disabled&#39;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 添加 DNS 配置（最后一行）</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=&#34;DNS1=8.8.8.8&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 添加 DNS 配置（匹配行下添加）</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 insertafter=&#34;^NAME&#34; line=&#34;DNS1=8.8.8.8&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 删除一行</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33  line=&#34;DNS1=8.8.8.8&#34; state=&#34;absent&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 删除注释行</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile  -a <span style=color:#e6db74>&#39;dest=/etc/fstab state=absent regexp=&#34;^#&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>### 多行相同文本，只替换最后一行</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;cat /root/test.txt&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m lineinfile -a &#34;path=/root/test.txt regexp=&#39;a&#39; line=&#39;b&#39;&#34;</span>
</span></span><span style=display:flex><span>remote | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;backup&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;line replaced&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;cat /root/test.txt&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span>b
</span></span></code></pre></div><h4 id=2419-replace-模块>2.4.19 replace 模块<a hidden class=anchor aria-hidden=true href=#2419-replace-模块>#</a></h4><blockquote><p>该模块与 sed 类似，主要用于基于正则的多行文本匹配和替换</p></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>path            <span style=color:#75715e># 被控端文件的路径</span>
</span></span><span style=display:flex><span>regexp          <span style=color:#75715e># 正则匹配语法格式</span>
</span></span><span style=display:flex><span>replace         <span style=color:#75715e># 目标替换内容</span>
</span></span><span style=display:flex><span>after           <span style=color:#75715e># 插入匹配行后</span>
</span></span><span style=display:flex><span>before          <span style=color:#75715e># 插入匹配行前</span>
</span></span><span style=display:flex><span>backup          <span style=color:#75715e># 修改前先备份</span>
</span></span><span style=display:flex><span>mode            <span style=color:#75715e># 指定权限</span>
</span></span><span style=display:flex><span>owner           <span style=color:#75715e># 指定用户</span>
</span></span><span style=display:flex><span>group           <span style=color:#75715e># 指定组</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ansible remote -m replace -a <span style=color:#e6db74>&#34;path=/etc/fstab regexp=&#39;^(UUID.*)&#39; replace=&#39;#\1&#39;&#34;</span>  
</span></span><span style=display:flex><span>ansible remote -m replace -a <span style=color:#e6db74>&#34;path=/etc/fstab regexp=&#39;^#(UUID.*)&#39; replace=&#39;\1&#39;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>### 多行匹配替换</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;cat /root/test.txt&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>b
</span></span><span style=display:flex><span>b
</span></span><span style=display:flex><span>b
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m replace -a &#34;path=/root/test.txt regexp=&#39;b&#39; replace=&#39;a&#39;&#34;</span>
</span></span><span style=display:flex><span>remote | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;2 replacements made&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;cat /root/test.txt&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span>a
</span></span></code></pre></div><h4 id=2420-selinux-模块>2.4.20 selinux 模块<a hidden class=anchor aria-hidden=true href=#2420-selinux-模块>#</a></h4><blockquote><p>该模块用来管理 selinux 策略。根据国内使用习惯，这里主要演示如何关闭 selinux</p></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>policy     <span style=color:#75715e># 指定SELINUXTYPE=targeted</span>
</span></span><span style=display:flex><span>state      <span style=color:#75715e># 指定SELINUX=disabled</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m selinux -a &#39;state=disabled&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>WARNING<span style=color:#f92672>]</span>: SELinux state temporarily changed from <span style=color:#e6db74>&#39;enforcing&#39;</span> to <span style=color:#e6db74>&#39;permissive&#39;</span>. State change will take effect next reboot.
</span></span><span style=display:flex><span>remote | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;configfile&#34;</span>: <span style=color:#e6db74>&#34;/etc/selinux/config&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;policy&#34;</span>: <span style=color:#e6db74>&#34;targeted&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;reboot_required&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;state&#34;</span>: <span style=color:#e6db74>&#34;disabled&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#34;grep -v &#39;#&#39; /etc/selinux/config&#34;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SELINUX<span style=color:#f92672>=</span>disabled
</span></span><span style=display:flex><span>SELINUXTYPE<span style=color:#f92672>=</span>targeted 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#34;getenforce&#34;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>Permissive
</span></span></code></pre></div><h4 id=2421-reboot-模块>2.4.21 reboot 模块<a hidden class=anchor aria-hidden=true href=#2421-reboot-模块>#</a></h4><blockquote><p>用于重启目标机器</p></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>msg               <span style=color:#75715e># 重启提示内容</span>
</span></span><span style=display:flex><span>pre_reboot_delay  <span style=color:#75715e># 重启前的延迟时间，单位：s</span>
</span></span><span style=display:flex><span>post_reboot_delay <span style=color:#75715e># 重启后经过多少时间再验证系统功能是否正常，单位：s</span>
</span></span><span style=display:flex><span>reboot_timeout    <span style=color:#75715e>#重启后延迟时间再执行测试成功与否的命令</span>
</span></span><span style=display:flex><span>test_command      <span style=color:#75715e>#执行测试成功与否的命令</span>
</span></span></code></pre></div><p>范例：重启系统，会阻塞等待重启完成才会返回执行结果</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m reboot -a &#34;msg=&#39;host will be reboot&#39;&#34;</span>
</span></span><span style=display:flex><span>remote | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;elapsed&#34;</span>: 17, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;rebooted&#34;</span>: true
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=2422-mount-模块>2.4.22 mount 模块<a hidden class=anchor aria-hidden=true href=#2422-mount-模块>#</a></h4><blockquote><p>用于文件系统的管理</p></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>src    <span style=color:#75715e>#源设备路径，或网络地址</span>
</span></span><span style=display:flex><span>path   <span style=color:#75715e>#挂载至本地哪个路径下</span>
</span></span><span style=display:flex><span>fstype <span style=color:#75715e>#设备类型</span>
</span></span><span style=display:flex><span>opts   <span style=color:#75715e>#挂载的选项</span>
</span></span><span style=display:flex><span>state  <span style=color:#75715e>#挂载还是卸载</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>present <span style=color:#75715e>#永久挂载，但没有立即生效</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>absent  <span style=color:#75715e>#卸载临时挂载,并删除永久挂载</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>mounted <span style=color:#75715e>#临时挂载</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>unmounted <span style=color:#75715e>#临时卸载</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 永久卸载</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m mount -a &#39;src=/dev/sdb path=/app state=absent&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 永久挂载，不会立即生效，仅修改/etc/fstab 文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m mount -a &#39;src=/dev/sdb path=/app state=absent&#39; fstype=xfs opts=noatime path=swap state=present&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 临时挂载</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m mount -a &#39;src=/dev/sdb path=/app fstype=xfs opts=default state=mounted&#39;  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 临时卸载</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m mount -a &#39;src=/dev/sdb path=/app fstype=xfs opts=default state=unmounted&#39;  </span>
</span></span></code></pre></div><blockquote><p><code>opts=noatime</code>：<code>opts</code>是传递给mount命令的额外选项，这里使用的是<code>noatime</code>，表示在读取文件时，不更新文件的最后访问时间。这可以提高文件系统的性能。默认是 <code>default</code></p></blockquote><h4 id=2423-setup-模块>2.4.23 setup 模块<a hidden class=anchor aria-hidden=true href=#2423-setup-模块>#</a></h4><blockquote><p>该模块用于收集目标主机的系统信息，在使用 ansible 时，是默认启用的。该模块收集到的信息可以通过变量引用，但是通常情况下，它会影响执行速度。如果不需要，可以显式关闭以提高执行效率。</p></blockquote><p>可以使用 <code>gather_facts: no</code> 来禁止 Ansible 收集 facts 信息</p><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>filter  <span style=color:#75715e># 指定过滤条件</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible remote -m setup
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_nodename&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_hostname&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_domain&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_memtotal_mb&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_memory_mb&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_memfree_mb&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_os_family&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_distribution&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_distribution_major_version&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_distribution_version&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_processor_vcpus&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_remote_ipv4_addresses&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_architecture&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_uptime_seconds&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_processor*&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#39;filter=ansible_env&#39;</span>
</span></span></code></pre></div><h4 id=2424-debug-模块>2.4.24 debug 模块<a hidden class=anchor aria-hidden=true href=#2424-debug-模块>#</a></h4><blockquote><p>此模块用于打印相关信息，类似于 <code>print</code> 和 <code>echo</code></p></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>msg		<span style=color:#75715e># 打印内容</span>
</span></span><span style=display:flex><span>var		<span style=color:#75715e># 设置变量并赋值</span>
</span></span><span style=display:flex><span>verbosity <span style=color:#75715e># 详细级别</span>
</span></span></code></pre></div><p>范例：未指定msg，默认打印 hello world</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m debug </span>
</span></span><span style=display:flex><span>remote | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;Hello world!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>范例：打印变量值</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat debug.yaml </span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- hosts: remote
</span></span><span style=display:flex><span>  gather_facts: yes
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: print value of variable
</span></span><span style=display:flex><span>      debug: 
</span></span><span style=display:flex><span>        msg: host <span style=color:#e6db74>&#34;{{ ansible_nodename }}&#34;</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook debug.yaml </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> ***************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> ******************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>print value of variable<span style=color:#f92672>]</span> **********************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;host \&#34;remote\&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP ******************************************************************************************
</span></span><span style=display:flex><span>remote                     : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> 
</span></span></code></pre></div><p>范例：通过下标打印指定对应字符</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat debug.yaml </span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- hosts: remote
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  vars: 
</span></span><span style=display:flex><span>    str: <span style=color:#e6db74>&#34;01234&#34;</span>
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>  - debug: 
</span></span><span style=display:flex><span>      msg: 
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;{{ str[0] }}&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;{{ str[1] }}&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;{{ str[2] }}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook debug.yaml </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> ***************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>debug<span style=color:#f92672>]</span> ****************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;0&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;1&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;2&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP ******************************************************************************************
</span></span><span style=display:flex><span>remote                     : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h4 id=2425-sysctl-模块>2.4.25 sysctl 模块<a hidden class=anchor aria-hidden=true href=#2425-sysctl-模块>#</a></h4><blockquote><p>此模块用于修改内核参数</p></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>name  	<span style=color:#75715e># 内核参数名</span>
</span></span><span style=display:flex><span>value 	<span style=color:#75715e># 指定值</span>
</span></span><span style=display:flex><span>state 	<span style=color:#75715e># 是否保存在sysctl.conf文件中，默认present</span>
</span></span><span style=display:flex><span>sysctl_set 	<span style=color:#75715e>#使用sysctl -w 验证值生效</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m sysctl -a &#39;name=net.ipv4.ip_forward value=1 state=present&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;grep forward /etc/sysctl.conf&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>net.ipv4.ip_forward<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>其他示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>remote</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Change Port Range</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sysctl</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>net.ipv4.ip_local_port_range</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;1024 65000&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sysctl_set</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Enabled Forward</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sysctl</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>net.ipv4.ip_forward</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;1&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sysctl_set</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Enabled tcp_reuse</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sysctl</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>net.ipv4.tcp_tw_reuse</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;1&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sysctl_set</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Chanage tcp tw_buckets</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sysctl</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>net.ipv4.tcp_max_tw_buckets</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;5000&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sysctl_set</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Chanage tcp_syncookies</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sysctl</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>net.ipv4.tcp_syncookies</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;1&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sysctl_set</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Chanage tcp max_syn_backlog</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sysctl</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>net.ipv4.tcp_max_syn_backlog</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;8192&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sysctl_set</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Chanage tcp Established Maxconn</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sysctl</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>net.core.somaxconn</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;32768&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sysctl_set</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Chanage tcp_syn_retries</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sysctl</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>net.ipv4.tcp_syn_retries</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;2&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sysctl_set</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Chanage net.ipv4.tcp_synack_retries</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sysctl</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>net.ipv4.tcp_synack_retries</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;2&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sysctl_set</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span></code></pre></div><h4 id=2426-pam_limits-模块>2.4.26 pam_limits 模块<a hidden class=anchor aria-hidden=true href=#2426-pam_limits-模块>#</a></h4><blockquote><p>此模块用于修改内核资源限制</p></blockquote><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>name	<span style=color:#75715e># 内核参数</span>
</span></span><span style=display:flex><span>value	<span style=color:#75715e># 指定值</span>
</span></span><span style=display:flex><span>state	<span style=color:#75715e># 是否保存在 sysctl.conf 文件中，默认保存</span>
</span></span><span style=display:flex><span>sysctl_set <span style=color:#75715e># 使 sysctl -w 验证值生效</span>
</span></span></code></pre></div><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible remote -m sysctl -a <span style=color:#e6db74>&#39;name=net.ipv4.ip_forward value=1 state=present&#39;</span>
</span></span></code></pre></div><p>范例内核参数优化：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>---
</span></span><span style=display:flex><span>- hosts: remote
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  vars:
</span></span><span style=display:flex><span>    limits_conf_dest: <span style=color:#e6db74>&#39;/etc/security/limits.conf&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: Modify <span style=color:#f92672>{{</span> limits_conf_dest <span style=color:#f92672>}}</span>
</span></span><span style=display:flex><span>      pam_limits:
</span></span><span style=display:flex><span>        dest: <span style=color:#e6db74>&#34;{{ limits_conf_dest }}&#34;</span>
</span></span><span style=display:flex><span>        domain: <span style=color:#e6db74>&#39;*&#39;</span>
</span></span><span style=display:flex><span>        limit_type: <span style=color:#e6db74>&#34;{{ item.limit_type }}&#34;</span>
</span></span><span style=display:flex><span>        limit_item: <span style=color:#e6db74>&#34;{{ item.limit_item }}&#34;</span>
</span></span><span style=display:flex><span>        value: <span style=color:#e6db74>&#34;{{ item.value }}&#34;</span>
</span></span><span style=display:flex><span>      loop:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>{</span> limit_type: <span style=color:#e6db74>&#39;soft&#39;</span>, limit_item: <span style=color:#e6db74>&#39;nofile&#39;</span>, value: <span style=color:#e6db74>&#39;655350&#39;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>{</span> limit_type: <span style=color:#e6db74>&#39;hard&#39;</span>, limit_item: <span style=color:#e6db74>&#39;nofile&#39;</span>, value: <span style=color:#e6db74>&#39;655350&#39;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>{</span> limit_type: <span style=color:#e6db74>&#39;soft&#39;</span>, limit_item: <span style=color:#e6db74>&#39;nproc&#39;</span>, value: <span style=color:#e6db74>&#39;655350&#39;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>{</span> limit_type: <span style=color:#e6db74>&#39;hard&#39;</span>, limit_item: <span style=color:#e6db74>&#39;nproc&#39;</span>, value: <span style=color:#e6db74>&#39;655350&#39;</span> <span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=3-ansible-playbook>3 Ansible Playbook<a hidden class=anchor aria-hidden=true href=#3-ansible-playbook>#</a></h2><h3 id=31-playbook-简介>3.1 Playbook 简介<a hidden class=anchor aria-hidden=true href=#31-playbook-简介>#</a></h3><p>官网：<a href=https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_intro.html>Ansible playbooks — Ansible Documentation</a></p><p>Playbook 是 Ansible 中用于定义自动化任务的文本文件。它是一种声明性的描述方式，用于指定一系列步骤和配置，以便 Ansible 可以在远程主机上执行这些步骤。Playbook 可以用于配置服务器、部署应用程序、管理系统等一系列自动化任务。</p><p>以下是 Playbook 的一些重要特点和组成部分：</p><ol><li><p><strong>声明性描述</strong>: Playbook 采用声明性的方式描述了你要执行的任务，而不需要详细说明每个步骤的执行过程。</p></li><li><p><strong>YAML 格式</strong>: Playbook 是用 YAML（Yet Another Markup Language）格式编写的。YAML 格式具有良好的可读性，使得 Playbook 更易于理解和编写。</p></li><li><p><strong>主机清单</strong>: 在 Playbook 中，你可以指定要执行任务的目标主机。这通常通过清单文件来实现，清单文件列出了要执行任务的远程主机。</p></li><li><p><strong>任务</strong>: Playbook 由一个或多个任务组成，每个任务描述了一个特定的操作，如运行命令、复制文件、安装软件等。</p></li><li><p><strong>模块</strong>: 任务使用模块来执行实际的操作。模块是 Ansible 功能的构建块，它们封装了各种不同类型的任务，例如远程执行命令、文件操作、软件包管理等。</p></li><li><p><strong>变量</strong>: 你可以在 Playbook 中使用变量来存储数据，如主机名、IP 地址、配置选项等。变量可以提高可维护性和可重用性。</p></li><li><p><strong>条件和循环</strong>: Playbook 支持条件语句和循环，允许你在特定情况下执行不同的操作，或者在多个主机上重复执行任务。</p></li><li><p><strong>角色</strong>: 角色是一种组织和复用 Playbook 的方式，可以将相关任务和变量组织到一个结构化的目录中，以便更好地管理和维护。</p></li></ol><p>总之，Playbook 是 Ansible 中定义和管理自动化任务的核心部分，它使你能够以可维护且可扩展的方式管理远程主机上的配置和操作。</p><h4 id=311-playbook-组成>3.1.1 Playbook 组成<a hidden class=anchor aria-hidden=true href=#311-playbook-组成>#</a></h4><ul><li>一个 playbook(剧本)文件是一个YAML语言编写的文本文件</li><li>通常一个playbook只包括一个play</li><li>一个 play的主要包括两部分: 主机和tasks. 即实现在指定一组主机上执行一个tasks定义好的任务列表。</li><li>一个tasks中可以有一个或多个task任务</li><li>每一个Task本质上就是调用ansible的一个module</li><li>在复杂场景中,一个playbook中也可以包括多个play，实现对多组不同的主机执行不同的任务</li></ul><p>以下是一个示例 Playbook，展示了如何通过多个 play 执行不同任务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#75715e># 这是一个 Ansible Playbook 示例，用于展示多个 play 的用法</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 第一个 play：配置 Web 服务器</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>配置 Web 服务器</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>web_servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>安装 Apache</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>yum</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>httpd</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>启动 Apache 服务</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>httpd</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>started</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 第二个 play：配置数据库服务器</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>配置数据库服务器</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>db_servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>安装 MySQL</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>yum</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mysql-server</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>启动 MySQL 服务</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mysqld</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>started</span>
</span></span></code></pre></div><p>在上面的示例中，我们有两个 play：</p><ol><li><p><strong>第一个 play</strong>:</p><ul><li>名称：配置 Web 服务器</li><li>主机：<code>web_servers</code> 主机组</li><li>任务：<ul><li>安装 Apache 软件包</li><li>启动 Apache 服务</li></ul></li></ul></li><li><p><strong>第二个 play</strong>:</p><ul><li>名称：配置数据库服务器</li><li>主机：<code>db_servers</code> 主机组</li><li>任务：<ul><li>安装 MySQL 软件包</li><li>启动 MySQL 服务</li></ul></li></ul></li></ol><p>每个 play 都独立执行，并且可以在不同的主机组上执行不同的任务。在复杂的场景中，这种结构可以让你更有效地管理和组织自动化任务。注释中提供了每个 play 所涉及的步骤和任务的描述，以帮助你理解 Playbook 的结构和功能。</p><h4 id=212-playbook-和-ad-hoc-对比>2.1.2 Playbook 和 Ad-Hoc 对比<a hidden class=anchor aria-hidden=true href=#212-playbook-和-ad-hoc-对比>#</a></h4><p>Ansible 提供了两种主要的操作方式：Playbook 和 Ad-Hoc 命令，用于在远程主机上执行任务。下面是它们之间的详细对比：</p><p><strong>Playbook:</strong></p><ol><li><p><strong>描述性操作</strong>：Playbook 是用 YAML 文件编写的，以声明性的方式描述了要执行的任务和配置。它更适合用于复杂的、长期的自动化任务。</p></li><li><p><strong>复杂性</strong>：Playbook 支持多个主机、多个任务、变量、循环和条件等复杂的操作。它适合管理全面的配置和部署。</p></li><li><p><strong>结构化组织</strong>：Playbook 允许将任务组织成逻辑的 play，每个 play 都可以在特定的主机组上执行。这使得任务更加模块化和可扩展。</p></li><li><p><strong>可维护性</strong>：由于它是文本文件，Playbook 可以轻松地进行版本控制、文档化和共享。适合长期维护和团队协作。</p></li><li><p><strong>变量和模板</strong>：Playbook 支持定义变量和使用 Jinja2 模板生成配置文件，从而实现更高度的可定制性。</p></li></ol><p><strong>Ad-Hoc 命令:</strong></p><ol><li><p><strong>即时性操作</strong>：Ad-Hoc 命令是直接在命令行中执行的，适用于即时需要的、单次性的任务。</p></li><li><p><strong>命令行操作</strong>：Ad-Hoc 命令更适合临时操作，无需编写或保存文件，直接在命令行中执行。</p></li><li><p><strong>简单任务</strong>：它适合执行简单的、快速的任务，如查看系统状态、执行一次性命令等。</p></li><li><p><strong>命令模块</strong>：Ad-Hoc 命令使用命令模块来执行任务，它们比 Playbook 的模块少，功能相对有限。</p></li><li><p><strong>难以维护</strong>：由于命令直接在命令行中执行，Ad-Hoc 命令的可读性差，不适合长期维护和跟踪。</p></li><li><p><strong>不支持复杂逻辑</strong>：Ad-Hoc 命令不支持像 Playbook 中的复杂逻辑、条件判断和循环。</p></li></ol><p><strong>选择适用场景：</strong></p><ul><li>如果你需要执行复杂的多步骤任务、配置管理和自动化流程，应优先使用 Playbook。</li><li>如果你需要快速执行一次性的任务，例如系统诊断、快速检查等，可以使用 Ad-Hoc 命令。</li></ul><p>最终，选择 Playbook 还是 Ad-Hoc 命令取决于你的任务需求、复杂性和长期维护的要求。</p><h3 id=32-plabook-核心组件>3.2 Plabook 核心组件<a hidden class=anchor aria-hidden=true href=#32-plabook-核心组件>#</a></h3><p>当涉及 Ansible Playbook 的组件时，以下是每个组件的简单示例说明：</p><ol><li><strong>主机清单（Inventory）示例：</strong></li></ol><p>主机清单文件列出了 Ansible 将要管理的主机和主机组。这是一个简单的主机清单示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[web_servers]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>web1 ansible_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.1.10</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>web2 ansible_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.1.11</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[db_servers]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>db1 ansible_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.1.20</span>
</span></span></code></pre></div><ol start=2><li><strong>变量（Variables）示例：</strong></li></ol><p>你可以在 Playbook 中使用变量来设置不同的值，以便在不同的环境中重用配置。这是一个简单的变量示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Playbook with Variables</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>web_servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>http_port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Display HTTP Port</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;HTTP port is {{ http_port }}&#34;</span>
</span></span></code></pre></div><ol start=3><li><strong>任务（Tasks）示例：</strong></li></ol><p>任务是 Playbook 中的操作单元，由模块组成。这是一个简单的任务示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Task</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>web_servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ensure Apache is installed</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>yum</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>httpd</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span></code></pre></div><ol start=4><li><strong>处理配置（Handlers）示例：</strong></li></ol><p>处理配置用于在任务执行后触发一些操作，通常用于重新启动服务或重新加载配置。这是一个简单的处理配置示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Playbook with Handlers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>web_servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ensure Apache is installed</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>yum</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>httpd</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>notify</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>Restart Apache</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>handlers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Restart Apache</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>httpd</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>restarted</span>
</span></span></code></pre></div><ol start=5><li><strong>剧本（Play）示例：</strong></li></ol><p>剧本由一个或多个任务组成，用于在一组主机上执行操作。这是一个包含多个任务的剧本示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Play</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>web_servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ensure Apache is installed</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>yum</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>httpd</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Copy index.html</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>copy</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>src</span>: <span style=color:#ae81ff>/path/to/index.html</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>dest</span>: <span style=color:#ae81ff>/var/www/html/</span>
</span></span></code></pre></div><p>在每个示例中，我提供了一个基本的演示，说明了每个组件的用法和作用。这应该有助于你更好地理解 Ansible Playbook 的不同组件以及它们是如何一起工作的。</p><h3 id=33--playbook-命令>3.3 Playbook 命令<a hidden class=anchor aria-hidden=true href=#33--playbook-命令>#</a></h3><p>命令格式</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook &lt;filename.yml&gt; ... <span style=color:#f92672>[</span>options<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>常见选项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>--syntax,--syntax-check      <span style=color:#75715e># 语法检查,功能相当于bash -n </span>
</span></span><span style=display:flex><span>-C --check 		<span style=color:#75715e># 模拟执行 dry run ，只检测可能会发生的改变，但不真正执行操作</span>
</span></span><span style=display:flex><span>--list-hosts    <span style=color:#75715e># 列出运行任务的主机</span>
</span></span><span style=display:flex><span>--list-tags 	<span style=color:#75715e># 列出 tag</span>
</span></span><span style=display:flex><span>--list-tasks 	<span style=color:#75715e># 列出 task</span>
</span></span><span style=display:flex><span>--limit HOST_NAME  <span style=color:#75715e># 只针对主机列表中的特定主机执行</span>
</span></span><span style=display:flex><span>-i INVENTORY_PATH, --inventory INVENTORY_PATH  <span style=color:#75715e># 指定主机清单文件, 通常一个项对应一个主机清单文件</span>
</span></span><span style=display:flex><span>--start-at-task START_AT_TASK <span style=color:#75715e># 从指定 task 开始执行, 而非从头开始, START_AT_TASK为任务的</span>
</span></span><span style=display:flex><span>name
</span></span><span style=display:flex><span>-v -vv  -vvv 	<span style=color:#75715e># 显示过程</span>
</span></span></code></pre></div><p>范例：打印 hello world</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat hello.yaml </span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- hosts: remote
</span></span><span style=display:flex><span>  gather_facts: no <span style=color:#75715e># 不收集目标主机信息，加快执行速度</span>
</span></span><span style=display:flex><span>  tasks: 
</span></span><span style=display:flex><span>    - name: hello
</span></span><span style=display:flex><span>      command: echo <span style=color:#e6db74>&#34;hello world!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook hello.yaml </span>
</span></span></code></pre></div><p>示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 列出 playbook 中的主机</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook hello.yaml --list-hosts</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>playbook: hello.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  play <span style=color:#75715e>#1 (remote): remote	TAGS: []</span>
</span></span><span style=display:flex><span>    pattern: <span style=color:#f92672>[</span>u<span style=color:#e6db74>&#39;remote&#39;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    hosts <span style=color:#f92672>(</span>1<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>      remote
</span></span><span style=display:flex><span><span style=color:#75715e># 列出 playbook 中的任务</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook hello.yaml --list-tasks</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>playbook: hello.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  play <span style=color:#75715e>#1 (remote): remote	TAGS: []</span>
</span></span><span style=display:flex><span>    tasks:
</span></span><span style=display:flex><span>      hello	TAGS: <span style=color:#f92672>[]</span>
</span></span></code></pre></div><h3 id=34-ignore_errors>3.4 ignore_errors<a hidden class=anchor aria-hidden=true href=#34-ignore_errors>#</a></h3><p>在 playbook 执行时，如果某个 task 出错，则后续任务不会再执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat test_ignore.yaml </span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- hosts: remote
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>  tasks: 
</span></span><span style=display:flex><span>    - name: task1
</span></span><span style=display:flex><span>      command: /bin/false
</span></span><span style=display:flex><span>      ignore_errors: yes  <span style=color:#75715e># 忽略该task的报错，继续执行后续任务</span>
</span></span><span style=display:flex><span>    - name: task2
</span></span><span style=display:flex><span>      command: echo <span style=color:#e6db74>&#34;hello world!&#34;</span>
</span></span><span style=display:flex><span>- hosts: remote
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: task3
</span></span><span style=display:flex><span>      command: /bin/false <span style=color:#75715e># 此步骤报错，不再执行后续任务</span>
</span></span><span style=display:flex><span>    - name: task4
</span></span><span style=display:flex><span>      command: echo <span style=color:#e6db74>&#34;END---&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#实际运行效果：task4不会执行</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook test_ignore.yaml </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> ***********************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task1<span style=color:#f92672>]</span> ************************************************************************
</span></span><span style=display:flex><span>fatal: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span>: FAILED! <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span><span style=color:#f92672>}</span>, <span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/bin/false&#34;</span><span style=color:#f92672>]</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.272950&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2023-08-23 16:10:01.027320&#34;</span>, <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;non-zero return code&#34;</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 1, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2023-08-23 16:10:00.754370&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[]}</span>
</span></span><span style=display:flex><span>...ignoring
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task2<span style=color:#f92672>]</span> ************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> ***********************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task3<span style=color:#f92672>]</span> ************************************************************************
</span></span><span style=display:flex><span>fatal: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span>: FAILED! <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/bin/false&#34;</span><span style=color:#f92672>]</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.276205&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2023-08-23 16:10:02.161360&#34;</span>, <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;non-zero return code&#34;</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 1, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2023-08-23 16:10:01.885155&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[]}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP **************************************************************************
</span></span><span style=display:flex><span>remote                     : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span></code></pre></div><h3 id=35-handlers-和-notify>3.5 handlers 和 notify<a hidden class=anchor aria-hidden=true href=#35-handlers-和-notify>#</a></h3><p>Handlers 本质是 task list ，类似于 MySQL 中的触发器触发的行为，其中的 task 与前述的 task 并没有本质上的不同，只有在关注的资源发生变化时，才会采取一定的操作。</p><p>Notify 对应的 action 在所有 task 都执行完才会最后被触发，这样可避免多个 task 多次改变发生时每次都触发执行指定的操作，Handlers 仅在所有的变化发生完成后一次性地执行指定操作。</p><p>在 notify 中列出的操作称为 handler ，也即 notify 中调用 handler 中定义的操作</p><p><strong>注意:</strong></p><ul><li>如果多个 task 通知了相同的handlers， 此handlers仅会在所有task结束后运行一 次。</li><li>只有 notify 对应的 task 发生改变了才会通知 handlers，没有改变则不会触发handlers</li><li>handlers 是在所有前面的 tasks 都成功执行才会执行，如果前面任何一个 task 失败，会导致 handler 跳过执行</li></ul><p>示例：执行两个 handle</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>remote</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>command</span>: <span style=color:#ae81ff>/bin/true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>notify</span>:   <span style=color:#75715e># 触发 handlers 中的任务执行</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>get up</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>go to school</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>handlers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>get up</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Get it&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>go to school</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;I am going to school&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>root@ansible playbooks]# ansible-playbook test.yaml </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>PLAY [remote] ******************************************************************</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>TASK [task1] *******************************************************************</span>
</span></span><span style=display:flex><span><span style=color:#f92672>changed</span>: [<span style=color:#ae81ff>remote]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>RUNNING HANDLER [get up] *******************************************************</span>
</span></span><span style=display:flex><span><span style=color:#f92672>ok</span>: [<span style=color:#ae81ff>remote] =&gt; {</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;msg&#34;: </span><span style=color:#e6db74>&#34;Get it&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>RUNNING HANDLER [go to school] *************************************************</span>
</span></span><span style=display:flex><span><span style=color:#f92672>ok</span>: [<span style=color:#ae81ff>remote] =&gt; {</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;msg&#34;: </span><span style=color:#e6db74>&#34;I am going to school&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>PLAY RECAP *********************************************************************</span>
</span></span><span style=display:flex><span><span style=color:#f92672>remote                     </span>: <span style=color:#ae81ff>ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 </span>
</span></span></code></pre></div><p>如果有任意一个task 执行失败，handlers 中的任务不会执行（即使加了<code>ignore_errors</code>），此时可以加上<code>force_handlers: yes</code>来强制执行 handlers</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>---
</span></span><span style=display:flex><span>- hosts: remote
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>  force_handlers: yes <span style=color:#75715e># 忽略任一 task 执行报错，继续其他 task 及其 handler</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: task1
</span></span><span style=display:flex><span>      command: /bin/true
</span></span><span style=display:flex><span>      notify:   <span style=color:#75715e># 触发 handlers 中的任务执行</span>
</span></span><span style=display:flex><span>        - get up
</span></span><span style=display:flex><span>    - name: task2
</span></span><span style=display:flex><span>      command: /bin/false 
</span></span><span style=display:flex><span>      notify:
</span></span><span style=display:flex><span>        - go to school	<span style=color:#75715e># 由于task2 报错，不会通知相应的handler执行</span>
</span></span><span style=display:flex><span>  handlers:
</span></span><span style=display:flex><span>    - name: get up
</span></span><span style=display:flex><span>      debug:
</span></span><span style=display:flex><span>        msg: <span style=color:#e6db74>&#34;Get it&#34;</span>
</span></span><span style=display:flex><span>    - name: go to school
</span></span><span style=display:flex><span>      debug:
</span></span><span style=display:flex><span>        msg: <span style=color:#e6db74>&#34;I am going to school&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook test.yaml </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> ******************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task1<span style=color:#f92672>]</span> *******************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task2<span style=color:#f92672>]</span> *******************************************************************
</span></span><span style=display:flex><span>fatal: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span>: FAILED! <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/bin/false&#34;</span><span style=color:#f92672>]</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.273631&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2023-08-24 08:52:38.649403&#34;</span>, <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;non-zero return code&#34;</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 1, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2023-08-24 08:52:38.375772&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[]}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUNNING HANDLER <span style=color:#f92672>[</span>get up<span style=color:#f92672>]</span> *******************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;Get it&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************
</span></span><span style=display:flex><span>remote                     : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> 
</span></span></code></pre></div><h3 id=36-playbook-中使用-tags>3.6 Playbook 中使用 tags<a hidden class=anchor aria-hidden=true href=#36-playbook-中使用-tags>#</a></h3><p><a href=https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_tags.html>Tags — Ansible Documentation</a></p><p>默认情况下，ansible 会执行 playbook 中的所有任务。根据需要，可以给指定的 task 指定标签，即 tag，而后在执行 playbook 时，带上对应的 tag 以运行指定的 task。</p><ul><li>一个 task 可以有多个 tag</li><li>内置的 tag 有： tagged，untagged 和 all，它们分别是仅运行有tag，没有tag的任务和所有任务。</li></ul><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat test_tags.yml </span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- hosts: remote
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: task1
</span></span><span style=display:flex><span>      debug:
</span></span><span style=display:flex><span>        msg: <span style=color:#e6db74>&#34;task1&#34;</span>
</span></span><span style=display:flex><span>      tags:
</span></span><span style=display:flex><span>        - tag1
</span></span><span style=display:flex><span>        - tag_one
</span></span><span style=display:flex><span>    - name: task2
</span></span><span style=display:flex><span>      debug:
</span></span><span style=display:flex><span>        msg: <span style=color:#e6db74>&#34;task2&#34;</span>
</span></span><span style=display:flex><span>    - name: task3
</span></span><span style=display:flex><span>      debug:
</span></span><span style=display:flex><span>        msg: <span style=color:#e6db74>&#34;task3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 列出所有 tag</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook test_tags.yml --list-tags</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>playbook: test_tags.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  play <span style=color:#75715e>#1 (remote): remote	TAGS: []</span>
</span></span><span style=display:flex><span>      TASK TAGS: <span style=color:#f92672>[</span>tag1, tag_one<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 只运行带有 tag1 的 task</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook test_tags.yml -t tag1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> ******************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task1<span style=color:#f92672>]</span> *******************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;task1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************
</span></span><span style=display:flex><span>remote                     : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 只运行没有 tag 的 task</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook test_tags.yml -t untagged</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> ******************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task2<span style=color:#f92672>]</span> *******************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;task2&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task3<span style=color:#f92672>]</span> *******************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;task3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************
</span></span><span style=display:flex><span>remote                     : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 不执行有特定 tag 的 task</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook test_tags.yml --skip-tags tag_one</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 不执行没有 tag 的 task</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook test_tags.yml --skip-tags untagged</span>
</span></span></code></pre></div><h3 id=37-playbook-中使用变量>3.7 Playbook 中使用变量<a hidden class=anchor aria-hidden=true href=#37-playbook-中使用变量>#</a></h3><blockquote><p>在 Ansible 中，<code>setup</code> 模块用于收集有关远程主机的各种信息，这些信息被称为 &ldquo;facts&rdquo;。这些 facts 包括有关操作系统、硬件、网络、内存、CPU 等的信息，可以用于编写更加灵活和动态的剧本。使用 <code>setup</code> 模块可以通过 Ansible 收集远程主机的 facts。调用 playbook 时默认调用此模块，可通过 <code>gather_facts: no</code> 来禁止。</p></blockquote><p><strong>变量命令规则</strong>：由字母，数字，下划线组成且只能以字母开头</p><p><strong>变量调用方式</strong>：通过 {{ VARIBLE_NAME }} 调用变量，建议变量名前后加空格，且有时需要以双引号包裹 ”{{ VARIBLE_NAME }}“ （如：debug 模块中）</p><p><strong>变量来源：</strong></p><ul><li><p>ansible 的 setup 模块收集的 facts 变量</p></li><li><p>通过命令行指定变量，优先级最高</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook my_playbook.yml -e <span style=color:#e6db74>&#34;my_variable=value&#34;</span>
</span></span></code></pre></div></li><li><p>在 playbook 中定义</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Playbook</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>my_var</span>: <span style=color:#e6db74>&#34;Hello, Ansible!&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Display variable</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>my_var</span>
</span></span></code></pre></div></li><li><p>在独立的YAML文件中定义，然后通过关键字 <code>vars_files</code> 引入</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>remote</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars_fiels</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>my_vars.yml </span>
</span></span></code></pre></div></li><li><p>在主机清单文件中定义</p><ul><li><p><strong>主机变量：</strong> 在主机清单（Inventory）中定义的变量，优先级高于组变量</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>[<span style=color:#ae81ff>my_hosts]</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>host1 my_variable=host_value</span>
</span></span></code></pre></div></li><li><p><strong>组变量：</strong> 在主机清单中的组级别定义的变量。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>[<span style=color:#ae81ff>my_group:vars]</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>my_variable=group_value</span>
</span></span></code></pre></div></li></ul></li><li><p>在项目中针对主机和主机组定义</p><p>在项目目录下创建 host_vars 和 group_vars 目录，在其中新建 YAML 文件定义变量</p></li><li><p>在 role （角色）中定义</p><p>在 Ansible 角色中，变量也有优先级，类似于 Ansible 的其他变量。角色内的变量可以分为几个不同的级别，优先级从高到低排列如下：</p><ol><li><p><strong>角色任务变量（Role Task Variables）</strong>：这些变量在角色内的任务中定义，并且只在特定任务中生效。这些变量的优先级最高，会覆盖其他级别的变量。</p><p>在角色任务中定义的变量，通常存储在任务中的 <code>vars</code> 部分：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example role task</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;This is a task with a role-level variable&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>task_variable</span>: <span style=color:#ae81ff>value</span>
</span></span></code></pre></div></li><li><p><strong>角色默认变量（Role Default Variables）</strong>：角色的默认变量存储在角色的 <code>defaults</code> 目录下。这些变量在角色内部被认为是默认设置，除非被其他级别的变量覆盖。</p><p>角色默认变量存储在 <code>roles/role_name/defaults/main.yml</code> 文件中。</p></li><li><p><strong>角色变量（Role Variables）</strong>：在使用角色时，可以在主剧本中为角色设置变量。这些变量可以影响角色中的任务和默认变量。</p><p>在主剧本中为角色设置变量的方式如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Playbook using a role</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>target_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>roles</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>role</span>: <span style=color:#ae81ff>role_name</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>role_var</span>: <span style=color:#ae81ff>value</span>
</span></span></code></pre></div></li><li><p><strong>主机清单中的变量（Inventory Variables）</strong>：在主机清单中为主机或主机组定义的变量。这些变量在角色内也可以使用，但是其优先级较低。</p><p>在主机清单中为主机定义变量的方式如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[target_hosts]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>host1 ansible_ssh_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.1.1 role_var=value</span>
</span></span></code></pre></div></li></ol></li></ul><p><strong>变量优先级从高到低如下：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>1. 命令行 -e 传递的变量 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>2. playbook 中 
</span></span><span style=display:flex><span>   2.1 vars_files 引入的变量
</span></span><span style=display:flex><span>   2.1 playbook 中 vars 变量定义 
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>3. host_vars/主机名文件 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>4. 主机清单中的主机变量 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>5. group_vars
</span></span><span style=display:flex><span>   5.1 主机组名文件
</span></span><span style=display:flex><span>   5.2 all.yml
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>6. 主机清单中的组变量
</span></span></code></pre></div><blockquote><p>总的来说，变量定义方式多而杂，实际使用时应避免在多个地方定义同一个变量，降低复杂度，从而降低维护成本，减少出错的可能性。</p></blockquote><h4 id=371-使用-setup-模块中的变量>3.7.1 使用 setup 模块中的变量<a hidden class=anchor aria-hidden=true href=#371-使用-setup-模块中的变量>#</a></h4><h5 id=3711-使用-facts-变量>3.7.1.1 使用 facts 变量<a hidden class=anchor aria-hidden=true href=#3711-使用-facts-变量>#</a></h5><p>本模块自动在playbook调用，生成的系统状态信息, 并将之存放在facts变量中</p><p>facts 包括的信息很多,如: 主机名, IP, CPU, 内存, 网卡等</p><p><strong>facts 变量的实际使用场景案例</strong></p><ul><li><p>通过facts变量获取被控端CPU的个数信息，从而生成不同的Nginx配置文件</p></li><li><p>通过facts变量获取被控端内存大小信息，从而生成不同的memcached的配置文件</p></li><li><p>通过facts变量获取被控端主机名称信息，从而生成不同的Zabbix配置文件</p></li><li><p>通过facts变量获取被控端网卡信息，从而生成不同的主机名</p><p>&mldr;&mldr;</p></li></ul><p>范例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 获取网卡信息</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m setup -a &#39;filter=&#34;ansible_default_ipv4&#34;&#39;</span>
</span></span><span style=display:flex><span>localhost | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ansible_default_ipv4&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;192.168.146.128&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;alias&#34;</span>: <span style=color:#e6db74>&#34;ens33&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;broadcast&#34;</span>: <span style=color:#e6db74>&#34;192.168.146.255&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;gateway&#34;</span>: <span style=color:#e6db74>&#34;192.168.146.254&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;interface&#34;</span>: <span style=color:#e6db74>&#34;ens33&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;macaddress&#34;</span>: <span style=color:#e6db74>&#34;00:0c:29:c6:1a:98&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;mtu&#34;</span>: 1500, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;netmask&#34;</span>: <span style=color:#e6db74>&#34;255.255.255.0&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;network&#34;</span>: <span style=color:#e6db74>&#34;192.168.146.0&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;ether&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看主机名</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m setup -a &#39;filter=&#34;ansible_nodename&#34;&#39;</span>
</span></span><span style=display:flex><span>localhost | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ansible_nodename&#34;</span>: <span style=color:#e6db74>&#34;ansible&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 根据主机名生成日志文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># vim touch_host_log.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook touch_host_log.yaml </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;ls /tmp/remote.log&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/remote.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取网卡地址</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat show_ip_of_eth0.yaml </span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- hosts: remote
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tasks: 
</span></span><span style=display:flex><span>    - name: show ens33 ip address of <span style=color:#f92672>{{</span> ansible_facts<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;eth0&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;ipv4&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;address&#34;</span><span style=color:#f92672>]</span> <span style=color:#f92672>}}</span>
</span></span><span style=display:flex><span>      debug:
</span></span><span style=display:flex><span>        msg: Ip address <span style=color:#f92672>{{</span> ansible_facts.ens33.ipv4.address <span style=color:#f92672>}}</span>
</span></span><span style=display:flex><span>    - name: another way
</span></span><span style=display:flex><span>      debug: Ip address <span style=color:#f92672>{{</span> ansible_facts<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;ens33&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;ipv4&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;address&#34;</span><span style=color:#f92672>]</span> <span style=color:#f92672>}}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook show_ip_of_eth0.yaml </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> ******************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>show ens33 ip address of <span style=color:#f92672>{{</span> ansible_facts<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;eth0&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;ipv4&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;address&#34;</span><span style=color:#f92672>]</span> <span style=color:#f92672>}}]</span> ***
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;Ip address 192.168.146.129&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>another way<span style=color:#f92672>]</span> *************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;Hello world!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************
</span></span><span style=display:flex><span>remote                     : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span></code></pre></div><h5 id=3712-性能优化>3.7.1.2 性能优化<a hidden class=anchor aria-hidden=true href=#3712-性能优化>#</a></h5><p>执行 playbook 时，默认启用 setup 模块收集目标主机的 facts 变量，会耗费一定时间。可选则以下两种方式进行配置</p><ul><li><p>如果不需要使用到目标主机的变量信息，可以通过 <code>gather_facts: no</code> 选项来关闭此行为</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>all</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span></code></pre></div></li><li><p>在 Ansible 中，&ldquo;facts 缓存&rdquo; 是指将主机的事实数据（例如主机名、操作系统信息、IP 地址等）缓存起来，以便在后续的 Ansible 运行中重用这些数据，从而减少系统资源的使用和提高执行效率。</p><p>要启用 Ansible 的 Facts 缓存功能，你可以在 Ansible 配置文件中进行设置。默认情况下，Ansible 将事实数据存储在内存中，但你也可以选择将其存储在磁盘上以实现持久性。</p><p>以下是启用 Ansible Facts 缓存的配置示例：</p><ol><li><strong>存储在内存中</strong>：</li></ol><p>在 Ansible 配置文件中（通常是 <code>/etc/ansible/ansible.cfg</code> 或 <code>~/.ansible.cfg</code>），添加以下配置行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[defaults]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>gathering</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>smart</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fact_caching</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>memory</span>
</span></span></code></pre></div><ol start=2><li><strong>存储在磁盘上</strong>：</li></ol><p>要将 Facts 存储在磁盘上，你需要选择一个目录来保存缓存数据。在 Ansible 配置文件中添加以下配置行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[defaults]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>gathering</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>smart</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fact_caching</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>jsonfile</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fact_caching_connection</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/path/to/cache_directory</span>
</span></span></code></pre></div><p>将 <code>/path/to/cache_directory</code> 替换为你想要存储 Facts 缓存数据的实际目录路径。</p><p>完成配置后，重新运行 Ansible 命令，它将使用 Facts 缓存来加速执行过程。</p><p>请注意，以上配置示例适用于 Ansible 版本较新的情况。在特定的 Ansible 版本中，配置选项可能会有所不同。在使用前，请确保查阅与你所使用的 Ansible 版本相匹配的官方文档或手册。</p></li></ul><h4 id=372-命令行中给-playbook-传递变量>3.7.2 命令行中给 playbook 传递变量<a hidden class=anchor aria-hidden=true href=#372-命令行中给-playbook-传递变量>#</a></h4><p>在 Ansible 的 <code>ansible-playbook</code> 命令行中，可以使用 <code>-e</code> 选项来传递额外的变量给 playbook。这可以让你在运行 playbook 时动态地指定变量的值，而不必修改 playbook 文件本身。以下是传递变量的几种方式：</p><ol><li><p><strong>传递单个变量</strong>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook -e <span style=color:#e6db74>&#34;variable_name=variable_value&#34;</span> playbook.yml
</span></span></code></pre></div></li><li><p><strong>传递多个变量</strong>：</p><p>如果你想传递多个变量，可以使用多个 <code>-e</code> 选项或者将多个变量放在一个引号中，用空格或逗号分隔。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook -e <span style=color:#e6db74>&#34;variable1=value1 variable2=value2&#34;</span> playbook.yml
</span></span></code></pre></div><p>或者：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook -e <span style=color:#e6db74>&#34;variable1=value1&#34;</span> -e <span style=color:#e6db74>&#34;variable2=value2&#34;</span> playbook.yml
</span></span></code></pre></div></li><li><p><strong>传递 yaml 变量文件</strong></p><p>假设你的 YAML 文件 <code>vars.yml</code> 如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e>#vars.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>my_variable</span>: <span style=color:#e6db74>&#34;Hello, Ansible!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>database_host</span>: <span style=color:#e6db74>&#34;db.example.com&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>database_port</span>: <span style=color:#ae81ff>3306</span>
</span></span></code></pre></div><p>通过 -e 选项传递此文件中的变量</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>ansible-playbook -e @vars.yaml playbook.yml</span>
</span></span></code></pre></div></li><li><p><strong>传递 JSON 文件</strong>：</p><p>你也可以将变量保存在一个 JSON 格式的文件中，然后使用 <code>-e</code> 选项传递文件路径。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook -e @variables.json playbook.yml
</span></span></code></pre></div><p>其中，<code>variables.json</code> 是一个包含变量的 JSON 文件。</p></li></ol><p>无论你选择哪种方式，传递的变量都可以在 playbook 中使用，例如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>[<span style=color:#ae81ff>root@ansible playbooks]# cat playbook.yml </span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Playbook</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>remote</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>my_variable </span>
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>root@ansible playbooks]# ansible-playbook -e @vars.yaml playbook.yml </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>PLAY [Example Playbook] ********************************************************</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>TASK [debug] *******************************************************************</span>
</span></span><span style=display:flex><span><span style=color:#f92672>ok</span>: [<span style=color:#ae81ff>remote] =&gt; {</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;my_variable&#34;: </span><span style=color:#e6db74>&#34;Hello, Ansible!&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>PLAY RECAP *********************************************************************</span>
</span></span><span style=display:flex><span><span style=color:#f92672>remote                     </span>: <span style=color:#ae81ff>ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 </span>
</span></span></code></pre></div><p>在这个例子中，<code>my_variable</code> 变量的值将根据在命令行中传递的值进行设定。</p><h4 id=373-在-playbook-文件中定义变量>3.7.3 在 playbook 文件中定义变量<a hidden class=anchor aria-hidden=true href=#373-在-playbook-文件中定义变量>#</a></h4><p><strong>在Playbook级别定义变量：</strong></p><p>在Playbook中，你可以使用<code>vars</code>关键字来定义变量。这些变量将在整个Playbook中可用。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Playbook</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>my_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>variable_name</span>: <span style=color:#ae81ff>variable_value</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task using variable</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>variable_name</span>
</span></span></code></pre></div><p><strong>变量之间相互引用:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Playbook</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>localhost</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>remote_ip</span>: <span style=color:#e6db74>&#34;{{ ansible_default_ipv4.address }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task using variable</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>remote_ip</span>
</span></span></code></pre></div><h4 id=374-在外部变量文件中定义变量>3.7.4 在外部变量文件中定义变量：<a hidden class=anchor aria-hidden=true href=#374-在外部变量文件中定义变量>#</a></h4><blockquote><p><code>vars_files</code> 中的文件路径是相对于当前工作目录的。如果变量文件位于 Playbook 文件的同一目录中，你可以直接提供文件名，如 <code>vars_files: vars.yml</code>。如果在其他目录中，就需要提供完整的相对或绝对路径。</p></blockquote><p>将变量存储在外部文件中，然后在Playbook中导入这些变量。这在需要共享变量的多个Playbook之间很有用。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Playbook</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>my_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars_files</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>vars.yml</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task using variable</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>variable_name</span>
</span></span></code></pre></div><p>外部变量文件 <code>vars.yml</code> 的内容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>variable_name</span>: <span style=color:#ae81ff>variable_value</span>
</span></span></code></pre></div><h4 id=375-在主机清单中定义变量>3.7.5 在主机清单中定义变量<a hidden class=anchor aria-hidden=true href=#375-在主机清单中定义变量>#</a></h4><p>在Ansible中，你可以为主机和主机组定义变量，以便在Playbooks中使用这些变量来控制任务的行为。这有助于实现更灵活的配置和动态性。下面是关于如何在Ansible中为主机和主机组定义变量的详细信息：</p><ol><li><p><strong>主机变量：</strong></p><p>你可以为每个具体的主机定义变量，这些变量只适用于该主机。在Ansible的Inventory文件（通常是INI格式或YAML格式）中，你可以像这样为主机定义变量：</p><p><strong>INI格式：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[my_hosts]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>host1 ansible_ssh_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.1.1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[my_hosts:vars]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>some_variable</span><span style=color:#f92672>=</span><span style=color:#e6db74>some_value</span>
</span></span></code></pre></div><p><strong>YAML格式：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>my_hosts</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>host1</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible_ssh_host</span>: <span style=color:#ae81ff>192.168.1.1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>some_variable</span>: <span style=color:#ae81ff>some_value</span>
</span></span></code></pre></div></li><li><p><strong>主机组变量：</strong></p><p>你可以为主机组定义变量，这些变量将应用于该主机组中的所有主机。同样，在Inventory文件中，你可以为主机组定义变量：</p><p><strong>INI格式：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[my_hosts]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>host1 ansible_ssh_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.1.1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>host2 ansible_ssh_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.1.2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[my_hosts:vars]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>some_variable</span><span style=color:#f92672>=</span><span style=color:#e6db74>some_value</span>
</span></span></code></pre></div><p><strong>YAML格式：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>my_hosts</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>host1</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible_ssh_host</span>: <span style=color:#ae81ff>192.168.1.1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>host2</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible_ssh_host</span>: <span style=color:#ae81ff>192.168.1.2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>some_variable</span>: <span style=color:#ae81ff>some_value</span>
</span></span></code></pre></div></li><li><p><strong>使用变量：</strong></p><p>在Playbook中，你可以使用定义的主机变量和主机组变量。例如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Playbook</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>my_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task using host variable</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>hostvars[inventory_hostname][&#39;some_variable&#39;]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task using host group variable</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>groupvars[&#39;my_hosts&#39;][&#39;some_variable&#39;]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>normal use</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>some_variable</span>
</span></span></code></pre></div></li></ol><p>上述代码中，<code>hostvars[inventory_hostname]['some_variable']</code> 用于访问特定主机的变量，而 <code>groupvars['my_hosts']['some_variable']</code> 用于访问主机组的变量。</p><p>通过这些方法，你可以在Ansible中为主机和主机组定义变量，从而实现更加动态和可配置的Playbooks。</p><h4 id=376-host_vars-和-group_vars>3.7.6 host_vars 和 group_vars<a hidden class=anchor aria-hidden=true href=#376-host_vars-和-group_vars>#</a></h4><p>在 Ansible 中，<code>host_vars</code> 和 <code>group_vars</code> 是用于管理主机和主机组变量的特殊目录。这些目录允许你在不同的级别为主机和主机组定义变量，以便在你的 Ansible 任务中使用。这样，你可以根据需要为不同的主机或主机组配置特定的变量值，而不必在每个任务中都手动指定这些值。</p><p>以下是关于 <code>host_vars</code> 和 <code>group_vars</code> 的更详细介绍和使用方法：</p><p><strong>1. host_vars：</strong>
<code>host_vars</code> 目录用于为单个主机定义变量。在这个目录下，你可以为每个主机创建一个单独的 YAML 文件，文件名与主机的名称匹配。这些变量将仅应用于特定的主机。</p><p>目录结构示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── inventory.ini
</span></span><span style=display:flex><span>├── host_vars
</span></span><span style=display:flex><span>│   ├── server1.yml
</span></span><span style=display:flex><span>│   ├── server2.yml
</span></span><span style=display:flex><span>│   └── ...
</span></span><span style=display:flex><span>└── group_vars
</span></span><span style=display:flex><span>    ├── group1.yml
</span></span><span style=display:flex><span>    ├── group2.yml
</span></span><span style=display:flex><span>    └── ...
</span></span></code></pre></div><p><strong>2. group_vars：</strong>
<code>group_vars</code> 目录用于为主机组定义变量。主机组是在 Ansible 主机清单文件（通常是 <code>inventory.ini</code>）中定义的。你可以为每个主机组创建一个单独的 YAML 文件，文件名与主机组的名称匹配。这些变量将应用于主机组中的所有主机。</p><p><strong>使用方法：</strong></p><ol><li><p>在你的 Ansible 项目目录中创建 <code>host_vars</code> 和 <code>group_vars</code> 目录。</p></li><li><p>在 <code>host_vars</code> 目录中创建一个或多个 YAML 文件，每个文件对应一个主机，并在其中定义你希望在这些主机上使用的变量。</p></li><li><p>在 <code>group_vars</code> 目录中创建一个或多个 YAML 文件，每个文件对应一个主机组，并在其中定义你希望在这些主机组上使用的变量。</p></li><li><p>在 Ansible 主机清单文件（通常是 <code>inventory.ini</code>）中，将主机分配给相应的主机组。</p></li><li><p>在你的 Ansible 任务中，你可以直接使用这些变量，Ansible 会自动加载它们。</p></li></ol><p>示例：</p><p>假设你有两台主机：<code>webserver1</code> 和 <code>webserver2</code>，你还有一个主机组：<code>webservers</code>。你想要为每个主机和主机组定义一些变量。</p><p><strong>host_vars/webserver1.yml:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># host_vars/webserver1.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>app_port</span>: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span><span style=color:#f92672>app_env</span>: <span style=color:#ae81ff>production</span>
</span></span></code></pre></div><p><strong>host_vars/webserver2.yml:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># host_vars/webserver2.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>app_port</span>: <span style=color:#ae81ff>8000</span>
</span></span><span style=display:flex><span><span style=color:#f92672>app_env</span>: <span style=color:#ae81ff>staging</span>
</span></span></code></pre></div><p><strong>group_vars/webservers.yml:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># group_vars/webservers.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>app_user</span>: <span style=color:#ae81ff>webuser</span>
</span></span><span style=display:flex><span><span style=color:#f92672>app_path</span>: <span style=color:#ae81ff>/var/www/app</span>
</span></span></code></pre></div><p><strong>inventory.ini:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>[<span style=color:#ae81ff>webservers]</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>webserver1</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>webserver2</span>
</span></span></code></pre></div><p><strong>playbook.yml:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Configure web servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>webservers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Display app settings</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;App running on port {{ app_port }} with environment {{ app_env }}. User: {{ app_user }} Path: {{ app_path }}&#34;</span>
</span></span></code></pre></div><p>在这个示例中，<code>webserver1</code> 和 <code>webserver2</code> 分别有各自的变量，而 <code>webservers</code> 主机组共享了相同的变量。在任务中，你可以直接使用这些变量，Ansible 会将它们与相应的主机或主机组关联起来。</p><p>使用 <code>host_vars</code> 和 <code>group_vars</code> 可以使你的 Ansible 项目更有结构，更易于维护，因为你可以将变量与主机和主机组关联起来，而不必在每个任务中都重复定义。</p><h4 id=377-register>3.7.7 register<a hidden class=anchor aria-hidden=true href=#377-register>#</a></h4><p>在 Ansible 中，<code>register</code> 是一个用于捕获任务执行结果的关键字。通过使用 <code>register</code>，你可以将任务的输出、返回值或其他信息保存到一个变量中，以便后续任务可以使用这些信息。这在处理任务的输出、错误处理和条件执行方面非常有用。</p><p><strong>使用方法：</strong></p><p>在 Ansible playbook 的任务中，你可以使用 <code>register</code> 来捕获任务的输出。以下是一个基本的用法示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Execute a command</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>myhosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run a command and capture the output</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>command</span>: <span style=color:#ae81ff>echo &#34;Hello, Ansible!&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>register</span>: <span style=color:#ae81ff>command_output</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Display the captured output</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>command_output.stdout</span>
</span></span></code></pre></div><p>在这个示例中，<code>register: command_output</code> 将捕获 <code>echo</code> 命令的输出，并将其保存在 <code>command_output</code> 变量中。接下来的任务使用 <code>debug</code> 模块来显示这个变量的值。</p><p><code>register</code> 变量对象中包含多个属性，你可以根据需要使用它们。一些常用的属性包括：</p><ul><li><code>stdout</code>：捕获任务的标准输出内容。</li><li><code>stderr</code>：捕获任务的标准错误输出内容。</li><li><code>rc</code>：捕获任务的返回代码（退出状态码）。</li><li><code>changed</code>：指示任务是否导致了变化（True 或 False）。</li></ul><p>以下是一个更复杂的示例，演示如何根据 <code>register</code> 变量的值来执行不同的任务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Check if a file exists</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>myhosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Check file existence</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>stat</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/path/to/file.txt</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>register</span>: <span style=color:#ae81ff>file_status</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Display file status</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;File exists: {{ file_status.stat.exists }}&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>when</span>: <span style=color:#ae81ff>file_status.stat.exists</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Create the file if it doesn&#39;t exist</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/path/to/file.txt</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>touch</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>when</span>: <span style=color:#ae81ff>not file_status.stat.exists</span>
</span></span></code></pre></div><p>在这个示例中，首先使用 <code>stat</code> 模块检查文件是否存在，并将结果保存在 <code>file_status</code> 变量中。接下来的两个任务根据 <code>file_status</code> 的值来执行不同的操作：如果文件存在，则显示一条消息；如果文件不存在，则创建文件。</p><p>总之，<code>register</code> 是 Ansible 中非常有用的功能，可以捕获任务的输出和状态，并在 playbook 中进行进一步的处理、判断和控制流程。</p><h3 id=38-jinja2-模板的介绍和使用>3.8 Jinja2 模板的介绍和使用<a hidden class=anchor aria-hidden=true href=#38-jinja2-模板的介绍和使用>#</a></h3><p>Jinja2 是一种模板引擎，广泛用于将动态内容嵌入静态文本中，例如在配置文件、报告生成和文档自动生成等领域。在 Ansible 中，Jinja2 用于处理变量、条件语句和循环，以生成动态的配置文件和任务。</p><p><strong>基本概念：</strong></p><p>Jinja2 模板引擎基于 Python，它允许你在文本中插入动态值、执行条件判断和循环操作。模板使用双大括号 <code>{{ }}</code> 来表示变量，<code>{% %}</code> 来表示控制语句，如条件和循环。</p><p><strong>使用方法：</strong></p><p>以下是一些常见的 Jinja2 模板用法示例：</p><p><strong>1. 插入变量：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Hello, {{ name }}!
</span></span></code></pre></div><p>这将会将 <code>name</code> 变量的值插入到文本中。</p><p><strong>2. 使用条件语句：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>{% if age &gt; 18 %}
</span></span><span style=display:flex><span>You are an adult.
</span></span><span style=display:flex><span>{% else %}
</span></span><span style=display:flex><span>You are not yet an adult.
</span></span><span style=display:flex><span>{% endif %}
</span></span></code></pre></div><p>根据条件判断来显示不同的文本。</p><p><strong>3. 循环：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>{% for item in items %}
</span></span><span style=display:flex><span>- {{ item }}
</span></span><span style=display:flex><span>{% endfor %}
</span></span></code></pre></div><p>在循环中遍历列表 <code>items</code> 并为每个项目生成文本。</p><p><strong>4. 过滤器：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>{{ text | upper }}
</span></span></code></pre></div><p>使用过滤器将文本转换为大写。</p><p><strong>在 Ansible 中的应用：</strong></p><p>在 Ansible Playbooks 和模板中，你可以使用 Jinja2 来动态生成配置文件、任务和变量。例如，你可以在配置文件模板中插入主机和变量信息，然后使用 Ansible 将模板渲染为实际的配置文件。</p><p><strong>示例：</strong></p><p>假设你有一个 <code>web_servers</code> 主机组，并且你想为每台主机生成一个 Nginx 配置文件，其中包含主机的 IP 和端口信息。</p><p><strong>nginx.conf.j2 模板文件：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>server {
</span></span><span style=display:flex><span>    listen {{ nginx_port }};
</span></span><span style=display:flex><span>    server_name {{ ansible_host }};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    location / {
</span></span><span style=display:flex><span>        proxy_pass http://{{ ansible_host }}:{{ app_port }};
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>playbook.yml 文件：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Generate Nginx configs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>web_servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Render Nginx config</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>src</span>: <span style=color:#ae81ff>nginx.conf.j2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>dest</span>: <span style=color:#ae81ff>/etc/nginx/sites-available/{{ ansible_host }}</span>
</span></span></code></pre></div><p>在这个示例中，<code>nginx.conf.j2</code> 是一个 Jinja2 模板文件，使用了变量和控制语句来动态生成 Nginx 配置文件。<code>template</code> 模块会将模板渲染为实际的配置文件，放置在 <code>/etc/nginx/sites-available</code> 目录下，文件名与主机名相同。</p><p><strong>总结：</strong></p><p>Jinja2 是一个强大的模板引擎，可以在 Ansible 中用于生成动态内容，从而提高配置管理和自动化部署的灵活性和效率。通过使用 Jinja2，你可以根据需要将变量、条件和循环嵌入到文本中，生成符合要求的配置和任务。</p><h3 id=39-循环和迭代>3.9 循环和迭代<a hidden class=anchor aria-hidden=true href=#39-循环和迭代>#</a></h3><h4 id=378-loop>3.7.8 loop<a hidden class=anchor aria-hidden=true href=#378-loop>#</a></h4><p>在 Ansible 中，迭代和循环是非常重要的概念，它们允许你对一组主机或一组数据执行相同的操作。Ansible 提供了多种方法来实现迭代和循环，其中最常用的方法是使用 <code>loop</code> 关键字或 <code>with_*</code> 关键字系列。</p><p>以下是 Ansible 中实现迭代和循环的一些方法：</p><ol><li><p>使用 <code>loop</code> 关键字：
<code>loop</code> 关键字允许你在任务级别循环执行任务。你可以将其与 <code>items</code> 参数结合使用，传递一个列表或字典，然后在每次迭代中访问该列表或字典的元素。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Loop example</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Item: {{ item }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>loop</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>item1</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>item2</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>item3</span>
</span></span></code></pre></div></li><li><p>使用 <code>with_items</code>：
在旧版本的 Ansible 中，你可能会看到 <code>with_items</code> 关键字，它在较新版本中已被 <code>loop</code> 替代（ansible 2.5+），但在一些旧代码中仍然可能会使用。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Loop example (with_items)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Item: {{ item }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with_items</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>item1</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>item2</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>item3</span>
</span></span></code></pre></div></li><li><p>使用其他 <code>with_*</code> 关键字：
Ansible 提供了多个 <code>with_*</code> 关键字，例如 <code>with_dict</code>、<code>with_fileglob</code>、<code>with_sequence</code> 等，用于在不同情况下进行循环操作。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Looping with a dictionary</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Key: {{ item.key }}, Value: {{ item.value }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with_dict</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>key1</span>: <span style=color:#ae81ff>value1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>key2</span>: <span style=color:#ae81ff>value2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>key3</span>: <span style=color:#ae81ff>value3</span>
</span></span></code></pre></div></li></ol><p>这些示例只是介绍了 Ansible 中迭代和循环的基本概念。你可以根据自己的需要，结合 Ansible 的模块和功能，更复杂地实现迭代和循环操作。无论你是在处理主机还是数据集，迭代和循环都能帮助你更高效地管理和配置系统。</p><h4 id=379-until>3.7.9 until<a hidden class=anchor aria-hidden=true href=#379-until>#</a></h4><p>在Ansible中，&ldquo;until&rdquo; 是一个用于控制循环执行任务的关键字。它通常与 &ldquo;register&rdquo;（用于存储任务执行结果）和一些条件一起使用，以便在满足特定条件之前重复执行某个任务。&ldquo;until&rdquo; 的主要作用是允许任务在达到预期状态之前重试，直到满足特定条件为止。</p><p>以下是 &ldquo;until&rdquo; 关键字的基本语法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Retry a task until a condition is met</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>some_module</span>:           <span style=color:#75715e># Replace with the actual module you&#39;re using</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>register</span>: <span style=color:#ae81ff>result      </span> <span style=color:#75715e># Store the task execution result in the &#39;result&#39; variable</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>until</span>: <span style=color:#ae81ff>result is success  </span> <span style=color:#75715e># The condition to check, can be customized based on the task result</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>retries</span>: <span style=color:#ae81ff>10</span>                <span style=color:#75715e># Number of times to retry the task</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>delay</span>: <span style=color:#ae81ff>10</span>                  <span style=color:#75715e># Time (in seconds) to wait between retries</span>
</span></span></code></pre></div><p>在上面的示例中，&ldquo;some_module&rdquo; 是要执行的任务模块，&ldquo;result&rdquo; 是用于存储任务执行结果的变量。通过 &ldquo;until&rdquo; 关键字，你可以指定一个条件来检查任务执行结果是否满足预期。如果条件不满足，任务将在 &ldquo;retries&rdquo; 次数内重复执行，每次重试之间会等待 &ldquo;delay&rdquo; 秒。</p><p>这是一个更具体的示例，假设你要等待某个服务启动成功后才继续执行后续任务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Start the service</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>systemd</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-service</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>state</span>: <span style=color:#ae81ff>started</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>register</span>: <span style=color:#ae81ff>service_result</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Wait for the service to be up</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>wait_for</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>host</span>: <span style=color:#ae81ff>localhost</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>until</span>: <span style=color:#ae81ff>service_result is success</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>retries</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>delay</span>: <span style=color:#ae81ff>5</span>
</span></span></code></pre></div><p>在这个示例中，首先使用 &ldquo;systemd&rdquo; 模块启动了一个名为 &ldquo;my-service&rdquo; 的服务，并将结果存储在 &ldquo;service_result&rdquo; 变量中。接下来，使用 &ldquo;wait_for&rdquo; 模块等待 localhost 的 8080 端口开放，直到 &ldquo;service_result&rdquo; 变量的值变为 &ldquo;success&rdquo;，或者达到最大重试次数为止。</p><p>请注意，&ldquo;until&rdquo; 并不是所有Ansible模块都支持的参数，只有部分模块（如 &ldquo;wait_for&rdquo;、&ldquo;command&rdquo; 等）允许在任务级别使用 &ldquo;until&rdquo; 来执行条件判断和循环操作。</p><h4 id=3710-with_lines>3.7.10 with_lines<a hidden class=anchor aria-hidden=true href=#3710-with_lines>#</a></h4><p>在 Ansible 中，<code>with_lines</code> 是一个用于在任务中遍历文本行的循环构造。它允许你将每一行作为一个迭代项，以便在每次迭代中执行任务。</p><p>以下是 <code>with_lines</code> 的基本语法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Perform tasks with each line of a file</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>some_module</span>:    <span style=color:#75715e># Replace with the actual module you&#39;re using</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with_lines</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>/path/to/file.txt  </span> <span style=color:#75715e># Path to the file containing lines to iterate over</span>
</span></span></code></pre></div><p>在上述示例中，<code>some_module</code> 是要执行的任务模块，<code>/path/to/file.txt</code> 是包含要迭代的文本行的文件的路径。</p><p>这是一个更具体的示例，假设你有一个文本文件，其中包含一些IP地址，你想使用 <code>ping</code> 命令对每个IP地址执行网络连接测试：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ping each IP address from a file</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ping</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>with_lines</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>/path/to/ip_addresses.txt</span>
</span></span></code></pre></div><p>在这个示例中，<code>ping</code> 模块将会对文件 <code>/path/to/ip_addresses.txt</code> 中的每个IP地址执行网络连接测试。Ansible会将文件的每一行作为一个迭代项传递给 <code>ping</code> 模块。</p><p>需要注意的是，<code>with_lines</code> 在处理大型文件时可能会导致性能问题，因为它需要一次性读取整个文件并将其加载到内存中。如果文件较大，你可能需要考虑使用更适合的方法，例如将文件内容存储在变量中，然后使用循环结构遍历变量。</p><p>另外，从 Ansible 2.5 版本开始，<code>with_lines</code> 已被弃用，建议使用 <code>loop</code> 构造代替。以下是如何使用 <code>loop</code> 来完成上述示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ping each IP address from a file</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ping</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>loop</span>: <span style=color:#e6db74>&#34;{{ lookup(&#39;file&#39;, &#39;/path/to/ip_addresses.txt&#39;).splitlines() }}&#34;</span>
</span></span></code></pre></div><p>在这个示例中，<code>lookup('file', '/path/to/ip_addresses.txt').splitlines()</code> 将会读取文件中的内容，并使用换行符将其拆分为行的列表，然后使用 <code>loop</code> 对每个IP地址执行 <code>ping</code> 模块。这种方法更为灵活且不会一次性加载整个文件。</p><h3 id=310-条件判断-when>3.10 条件判断 when<a hidden class=anchor aria-hidden=true href=#310-条件判断-when>#</a></h3><p>在 Ansible 中，<code>when</code> 是一个条件语句，它允许你在任务执行之前指定一个条件，只有当条件满足时，任务才会被执行。这可以用于根据不同的情况来决定是否跳过或执行某个任务。</p><p>以下是 <code>when</code> 的基本语法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Perform a task conditionally</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>some_module</span>:     <span style=color:#75715e># Replace with the actual module you&#39;re using</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>condition </span> <span style=color:#75715e># The condition to check before executing the task</span>
</span></span></code></pre></div><p>在上述示例中，<code>some_module</code> 是要执行的任务模块，<code>condition</code> 是一个表达式，只有在表达式评估为 <code>true</code> 时，任务才会被执行。</p><p>这是一个更具体的示例，假设你只想在操作系统是 Ubuntu 时才执行特定的任务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install a package only on Ubuntu</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>apt</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>some-package</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>ansible_distribution == &#39;Ubuntu&#39;</span>
</span></span></code></pre></div><p>在这个示例中，<code>apt</code> 模块用于安装软件包，但是只有当 Ansible 变量 <code>ansible_distribution</code> 的值为 &lsquo;Ubuntu&rsquo; 时，任务才会被执行。</p><p><code>when</code> 表达式可以是 Ansible 变量、事实（facts）、比较操作、逻辑运算等。你可以根据需要来创建复杂的条件来决定任务是否应该被执行。例如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Perform a task only if a certain variable is true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>some_module</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>my_variable == true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Perform a task only if a file exists</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>some_module</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>ansible_facts[&#39;file_exists&#39;] == true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Perform a task only if multiple conditions are true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>some_module</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>ansible_os_family == &#39;Debian&#39; and ansible_distribution_version | version_compare(&#39;9&#39;, &#39;&gt;=&#39;)</span>
</span></span></code></pre></div><p>请注意，<code>when</code> 是一个在任务级别使用的参数，它适用于单个任务。如果你希望在剧本（playbook）级别上设置条件，可以在每个任务中使用 <code>block</code> 结构，然后在 <code>block</code> 结构上使用 <code>when</code> 条件。</p><h3 id=311-分组-block>3.11 分组 block<a hidden class=anchor aria-hidden=true href=#311-分组-block>#</a></h3><p>在 Ansible 中，<code>block</code> 是一个用于创建任务块的结构。它允许你将多个相关的任务组织在一起，以便在其中应用共同的条件、处理错误以及设置通用的参数。<code>block</code> 可以与 <code>rescue</code> 和 <code>always</code> 配合使用，以提供更丰富的任务控制和错误处理能力。</p><p>以下是 <code>block</code> 结构的基本语法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>A playbook with a block</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>target_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>block</span>:         <span style=color:#75715e># Start of the block</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task 1</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>some_module</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task 2</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>some_module</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>rescue</span>:        <span style=color:#75715e># Optional, tasks to run if an error occurs within the block</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Rescue task</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>some_module</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>always</span>:        <span style=color:#75715e># Optional, tasks to run regardless of success or failure</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Always task</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>some_module</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># module arguments...</span>
</span></span></code></pre></div><p>在上述示例中，<code>block</code> 结构内包含两个任务（Task 1 和 Task 2）。如果 <code>block</code> 结构内的任务中的任何一个失败，那么 <code>rescue</code> 部分的任务将会被执行。无论 <code>block</code> 结构内的任务成功与否，<code>always</code> 部分的任务都会被执行。</p><p>以下是一个更具体的示例，展示了 <code>block</code> 结构如何与错误处理和条件一起使用：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install a package with error handling</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>target_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>block</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install the package</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>apt</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>some-package</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>rescue</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Handle error</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;An error occurred while installing the package.&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>always</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Clean up</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>apt</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>some-package</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>state</span>: <span style=color:#ae81ff>absent</span>
</span></span></code></pre></div><p>在这个示例中，<code>block</code> 结构内的任务尝试安装一个软件包。如果安装过程中出现错误，<code>rescue</code> 部分的任务会被执行，显示一条错误消息。无论是否出现错误，<code>always</code> 部分的任务都会被执行，确保最终将软件包从系统中移除。</p><p>使用 <code>block</code> 结构可以使剧本更具可读性，减少冗余代码，并提供更好的错误处理机制，因为你可以集中管理错误的处理方式。</p><h3 id=312-changed_when>3.12 changed_when<a hidden class=anchor aria-hidden=true href=#312-changed_when>#</a></h3><blockquote><p>当确定某个 task 不会对被控制端做修改时但执行结果却显示是黄色的 changed 状态, 可以通过<code>changed_when: false</code> 关闭 changed 状态</p></blockquote><p>在 Ansible 中，<code>changed_when</code> 是一个用于控制任务是否被标记为已更改（changed）的选项。默认情况下，如果任务执行导致了任何状态更改，该任务将被标记为已更改。然而，通过使用 <code>changed_when</code>，你可以自定义标记任务是否已更改的条件，而不仅仅依赖于默认的状态变化检测。</p><p><code>changed_when</code> 允许你在任务级别设置一个条件表达式。如果该表达式评估为 <code>true</code>，那么任务将被标记为已更改。如果该表达式评估为 <code>false</code>，那么任务将被标记为未更改。</p><p>以下是 <code>changed_when</code> 的基本语法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task with custom change condition</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>some_module</span>:    <span style=color:#75715e># Replace with the actual module you&#39;re using</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>changed_when</span>: <span style=color:#ae81ff>condition_expression</span>
</span></span></code></pre></div><p>在上述示例中，<code>some_module</code> 是要执行的任务模块，<code>condition_expression</code> 是一个自定义条件表达式，用于判断是否将任务标记为已更改。</p><p>这是一个示例，展示如何使用 <code>changed_when</code> 控制任务是否被标记为已更改：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run a command and control changed status</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>command</span>: <span style=color:#ae81ff>echo &#34;Hello, world!&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>register</span>: <span style=color:#ae81ff>command_output</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>changed_when</span>: <span style=color:#e6db74>&#34;command_output.stdout != &#39;Hello, world!\n&#39;&#34;</span>
</span></span></code></pre></div><p>在这个示例中，<code>command</code> 模块执行一个命令来输出 &ldquo;Hello, world!"，并将输出结果存储在 <code>command_output</code> 变量中。通过使用 <code>changed_when</code>，我们指定了一个条件表达式，只有当命令的输出不等于 &ldquo;Hello, world!\n&rdquo; 时，该任务才会被标记为已更改。</p><p>通过使用 <code>changed_when</code>，你可以更精确地控制任务的更改状态，而不受默认状态变化检测的限制。这在某些情况下很有用，特别是当任务的状态变化可能不直接与输出结果相关时。</p><h3 id=313-滚动执行-serial>3.13 滚动执行 serial<a hidden class=anchor aria-hidden=true href=#313-滚动执行-serial>#</a></h3><p>滚动执行（Rolling Deployment）是一种软件部署策略，用于将新版本的软件逐步部署到生产环境，而不是一次性将所有实例都更新为新版本。这种部署策略旨在减少风险，确保系统的可用性和稳定性，因为如果在全面部署新版本后出现问题，可能会影响整个系统。</p><p>在滚动执行中，新版本的软件会首先部署到一小部分服务器（通常是一组）上，然后进行测试和验证。一旦新版本在这些服务器上得到确认，就会逐步将新版本应用于其他服务器，逐步增加服务器数量，直到所有服务器都完成了升级。</p><p>在 Ansible 中，你可以通过编写适当的剧本（playbook）和任务，以及使用 <code>serial</code> 参数来实现滚动执行。<code>serial</code> 参数允许你指定每次在多少个目标主机上运行任务。这使得你可以控制在一次部署中逐步更新多少台主机。</p><p>以下是使用 Ansible 实现滚动执行的示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Rolling deployment with Ansible</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>target_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>serial</span>: <span style=color:#ae81ff>2</span>  <span style=color:#75715e># Number of hosts to update simultaneously in each batch</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Deploy new version</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>some_module</span>:   <span style=color:#75715e># Replace with the actual module you&#39;re using</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># module arguments...</span>
</span></span></code></pre></div><p>在上述示例中，<code>serial: 2</code> 表示每次将同时在两台目标主机上运行任务。这会使得每次部署只更新两台主机，然后逐步增加更新数量，直到所有目标主机都完成升级。</p><p>请注意，实际的滚动执行策略可能因组织的需求和应用程序的特性而有所不同。你可以根据实际情况来调整 <code>serial</code> 参数的值以及部署任务的其他参数，以满足你的部署策略和可用性要求。</p><h3 id=314-delegate_to>3.14 delegate_to<a hidden class=anchor aria-hidden=true href=#314-delegate_to>#</a></h3><p>在 Ansible 中，<code>delegate_to</code> 是一个用于指定任务应该在哪个远程主机上执行的参数。通过使用 <code>delegate_to</code>，你可以将任务委托给一个特定的主机执行，而不是默认在目标主机上执行。</p><p>这是一个示例，展示如何使用 <code>delegate_to</code> 将任务委托给另一个主机执行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run a task on a specific host</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>command</span>: <span style=color:#ae81ff>echo &#34;This task runs on a different host&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>delegate_to</span>: <span style=color:#ae81ff>specific_host</span>
</span></span></code></pre></div><p>在这个示例中，<code>command</code> 模块将执行 <code>echo</code> 命令，但是任务会被委托给 <code>specific_host</code> 执行，而不是默认的目标主机。</p><p>需要注意的是，<code>delegate_to</code> 参数通常用于特定的情况，例如需要在特定主机上执行一些配置管理任务、收集信息或执行某些故障排除操作时。在大多数情况下，任务将在目标主机上执行，而不需要使用 <code>delegate_to</code>。</p><h3 id=315-run_onece>3.15 run_onece<a hidden class=anchor aria-hidden=true href=#315-run_onece>#</a></h3><p>在 Ansible 中，<code>run_once</code> 是一个用于控制任务是否仅在一个主机上运行的参数。通常情况下，Ansible 会在目标主机上的每个主机上运行任务。但是，有时你可能只希望在所有目标主机中的一个上运行任务，而不是在每个主机上都运行。</p><p>这是一个示例，展示如何使用 <code>run_once</code> 使任务只在一个主机上运行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run a task only once</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>command</span>: <span style=color:#ae81ff>echo &#34;This task runs only once&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>run_once</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>在这个示例中，<code>command</code> 模块会执行 <code>echo</code> 命令，但是该任务只会在目标主机中的一个主机上运行。</p><p>使用 <code>run_once</code> 参数通常用于一些只需在整个剧本中执行一次的任务，例如收集汇总信息或配置初始化。注意，<code>run_once</code> 并不会影响其他任务的执行方式，其他任务仍然会在每个目标主机上运行。</p><h3 id=316-环境变量-environment>3.16 环境变量 environment<a hidden class=anchor aria-hidden=true href=#316-环境变量-environment>#</a></h3><p>在 Ansible 中，<code>environment</code> 是一个参数，用于在任务级别设置环境变量。通过使用 <code>environment</code> 参数，你可以为任务设置特定的环境变量，这些变量将在任务执行期间对命令、脚本等操作产生影响。</p><p>这是一个示例，展示如何使用 <code>environment</code> 参数设置环境变量：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run a task with custom environment variables</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>command</span>: <span style=color:#ae81ff>echo &#34;VAR1 is $VAR1, VAR2 is $VAR2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>VAR1</span>: <span style=color:#ae81ff>value1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>VAR2</span>: <span style=color:#ae81ff>value2</span>
</span></span></code></pre></div><p>在这个示例中，<code>command</code> 模块会执行 <code>echo</code> 命令，打印出由 <code>environment</code> 参数指定的环境变量值。</p><p>使用 <code>environment</code> 参数可以让你在任务执行过程中设置临时环境变量，这对于定制任务行为、传递配置信息或设置执行环境非常有用。这些环境变量只会在任务执行期间生效，不会影响到其他任务或目标主机的状态。</p><h3 id=317-include-和-import>3.17 include 和 import<a hidden class=anchor aria-hidden=true href=#317-include-和-import>#</a></h3><p>在 Ansible 中，你可以使用 <code>include</code> 和 <code>import</code> 语句来实现 YAML 文件之间的相互调用和重用。这可以帮助你组织和管理大型的 Ansible 剧本，使其更加模块化和易于维护。</p><p>以下是一个示例，演示了如何使用 <code>include</code> 和 <code>import_playbook</code> 来实现 YAML 文件之间的相互调用和重用。</p><p>假设我们有以下文件结构：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>ansible_project/
</span></span><span style=display:flex><span>├── main_playbook.yml
</span></span><span style=display:flex><span>├── tasks/
</span></span><span style=display:flex><span>│   ├── common_tasks.yml
</span></span><span style=display:flex><span>│   ├── task1.yml
</span></span><span style=display:flex><span>│   └── task2.yml
</span></span><span style=display:flex><span>└── playbooks/
</span></span><span style=display:flex><span>    └── other_playbook.yml
</span></span></code></pre></div><ol><li><code>main_playbook.yml</code> 是主剧本文件，它引入了其他文件并定义了一些任务。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Main Playbook</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>target_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>include</span>: <span style=color:#ae81ff>tasks/common_tasks.yml</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>include</span>: <span style=color:#ae81ff>tasks/task1.yml</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>include</span>: <span style=color:#ae81ff>tasks/task2.yml</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>import_playbook</span>: <span style=color:#ae81ff>playbooks/other_playbook.yml</span>
</span></span></code></pre></div><ol start=2><li><code>common_tasks.yml</code> 文件包含一些公共任务，这些任务可以被多个剧本重用。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Common Task 1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;This is a common task.&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Common Task 2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Another common task.&#34;</span>
</span></span></code></pre></div><ol start=3><li><code>task1.yml</code> 文件包含特定的任务。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task 1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Task 1 is executed.&#34;</span>
</span></span></code></pre></div><ol start=4><li><code>task2.yml</code> 文件也包含特定的任务。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task 2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Task 2 is executed.&#34;</span>
</span></span></code></pre></div><ol start=5><li><code>other_playbook.yml</code> 是另一个独立的剧本。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Other Playbook</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>other_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task in Other Playbook</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;This task is from another playbook.&#34;</span>
</span></span></code></pre></div><p>在这个示例中，<code>main_playbook.yml</code> 引入了多个文件并定义了一系列任务。<code>common_tasks.yml</code> 包含了一些公共任务，这些任务可以在主剧本和其他剧本中重用。<code>task1.yml</code> 和 <code>task2.yml</code> 分别包含特定的任务。<code>other_playbook.yml</code> 是另一个独立的剧本，它可以被导入到主剧本中。</p><p>通过这种方式，你可以将 Ansible 代码模块化，提高可维护性，并根据需要重用任务和剧本。</p><h2 id=4-ansible-roles>4 Ansible Roles<a hidden class=anchor aria-hidden=true href=#4-ansible-roles>#</a></h2><p>Ansible 角色是一种用于组织和重用 Ansible 代码的结构化方式。角色允许你将任务、变量、模板和处理逻辑组织成一个可独立调用的单元，使得你能够更好地管理复杂的剧本和部署。</p><p>角色的组织结构如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>my_role/
</span></span><span style=display:flex><span>├── tasks/
</span></span><span style=display:flex><span>│   ├── main.yml
</span></span><span style=display:flex><span>│   ├── task1.yml
</span></span><span style=display:flex><span>│   └── task2.yml
</span></span><span style=display:flex><span>├── vars/
</span></span><span style=display:flex><span>│   └── main.yml
</span></span><span style=display:flex><span>├── templates/
</span></span><span style=display:flex><span>│   ├── template1.j2
</span></span><span style=display:flex><span>│   └── template2.j2
</span></span><span style=display:flex><span>└── meta/
</span></span><span style=display:flex><span>    └── main.yml
</span></span></code></pre></div><ul><li><code>tasks/</code> 目录包含主任务文件 <code>main.yml</code>，以及其他任务文件如 <code>task1.yml</code> 和 <code>task2.yml</code>，这些文件包含要执行的任务。</li><li><code>vars/</code> 目录包含变量文件 <code>main.yml</code>，这些变量可以在角色中使用。</li><li><code>templates/</code> 目录包含模板文件，这些文件可以在角色中使用作为配置文件模板。</li><li><code>meta/</code> 目录包含角色元数据文件 <code>main.yml</code>，其中包含有关角色的信息，如作者、依赖等。</li></ul><p>以下是一个示例，展示如何创建和使用 Ansible 角色。</p><ol><li>创建一个名为 <code>my_role</code> 的角色目录结构：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>ansible_project/
</span></span><span style=display:flex><span>└── roles/
</span></span><span style=display:flex><span>    └── my_role/
</span></span><span style=display:flex><span>        ├── tasks/
</span></span><span style=display:flex><span>        │   └── main.yml
</span></span><span style=display:flex><span>        ├── vars/
</span></span><span style=display:flex><span>        │   └── main.yml
</span></span><span style=display:flex><span>        ├── templates/
</span></span><span style=display:flex><span>        │   └── template1.j2
</span></span><span style=display:flex><span>        └── meta/
</span></span><span style=display:flex><span>            └── main.yml
</span></span></code></pre></div><ol start=2><li>编辑 <code>my_role/tasks/main.yml</code> 文件，定义要执行的任务：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task 1 in Role</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Task 1 of my_role is executed.&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task 2 in Role</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Task 2 of my_role is executed.&#34;</span>
</span></span></code></pre></div><ol start=3><li>编辑 <code>my_role/vars/main.yml</code> 文件，定义角色变量：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>role_var1</span>: <span style=color:#ae81ff>value1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>role_var2</span>: <span style=color:#ae81ff>value2</span>
</span></span></code></pre></div><ol start=4><li>编辑 <code>my_role/templates/template1.j2</code> 文件，创建一个配置文件模板：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[Section]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>var1</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>{{ role_var1 }}</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>var2</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>{{ role_var2 }}</span>
</span></span></code></pre></div><ol start=5><li>编辑 <code>my_role/meta/main.yml</code> 文件，定义角色元数据：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>galaxy_info</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>author</span>: <span style=color:#ae81ff>Your Name</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>description</span>: <span style=color:#ae81ff>A sample Ansible role</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>license</span>: <span style=color:#ae81ff>MIT</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>min_ansible_version</span>: <span style=color:#ae81ff>2.9</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>platforms</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Fedora</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>versions</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>all</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ubuntu</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>versions</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>all</span>
</span></span></code></pre></div><ol start=6><li>在主剧本中使用角色：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Playbook using the role</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>target_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>roles</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>my_role</span>
</span></span></code></pre></div><p>在这个示例中，<code>my_role</code> 角色被定义为一个独立的目录，其中包含了任务、变量、模板和元数据。主剧本通过 <code>roles</code> 部分引用了这个角色，并在目标主机上执行了角色中的任务和操作。</p><p>使用角色可以使 Ansible 代码更加模块化、易于维护和重用，特别是在处理多个项目、环境或应用程序时。</p></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://senmer.github.io/static/img/wechat_pay.png alt=wechat_pay></a><p>微信</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://senmer.github.io/static/img/alipay.png alt=alipay></a><p>支付宝</p></div></div><button id=rewardButton onclick='var qr=document.getElementById("QR");qr.style.opacity==="0"?qr.style.opacity="1":qr.style.opacity="0"'>
<span>🧧 鼓励</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://senmer.github.io/zh/posts/tech/zookeeper/zookeeper/><span class=title>« 上一页</span><br><span>Zookeeper</span></a>
<a class=next href=https://senmer.github.io/zh/posts/tech/java/java-%E9%9B%86%E5%90%88/><span class=title>下一页 »</span><br><span>java-集合</span></a></nav></footer></div><style>.comments_details summary::marker{font-size:20px;content:'👉展开评论';color:var(--content)}.comments_details[open] summary::marker{font-size:20px;content:'👇关闭评论';color:var(--content)}</style><div><details class=comments_details open><summary style=display:none></summary><div id=tcomment></div></details><script src=https://cdn.staticfile.org/twikoo/1.6.16/twikoo.all.min.js></script><script>twikoo.init({envId:"https://hugo-api-khaki.vercel.app/# 填写自己的twikoo id",el:"#tcomment",lang:"zh-CN",region:null,path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><span>Copyright
&copy;
2020-2023
<a href=https://senmer.github.io/zh/ style=color:#939393>WZ's Blog</a>
All Rights Reserved</span>
<a href=https://beian.miit.gov.cn/ target=_blank style=color:#939393></a>&nbsp;
<span><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null" style=display:inline-block;text-decoration:none;height:20px;color:#939393><img src style="float:left;margin:0 5px 0 0"></a></span>
<span id=busuanzi_container><span class="fa fa-user"></span> <span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye"></span> <span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span></span></a>
<script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>200||document.documentElement.scrollTop>200?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{(function(){document.cookie="change-themes="+escape("false")})(),document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.body.addEventListener("copy",function(e){if(window.getSelection().toString()&&window.getSelection().toString().length>50){let t=e.clipboardData||window.clipboardData;if(t){e.preventDefault();let n=window.getSelection().toString()+`

————————————————
版权声明：本文为「WZ's Blog」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：`+location.href,s=window.getSelection().toString()+`

————————————————
版权声明：本文为「WZ's Blog」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：`+location.href;t.setData("text/html",n),t.setData("text/plain",s)}}})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="复制";function i(){t.innerText="已复制！",setTimeout(()=>{t.innerText="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){let t=e.textContent+`
————————————————
版权声明：本文为「WZ's Blog」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：`+location.href;navigator.clipboard.writeText(t),i();return}const n=document.createRange();n.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(n);try{document.execCommand("copy"),i()}catch{}s.removeRange(n)});let l=e.className.replaceAll("language-",""),n=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),o=document.createElement("div");o.innerText=l,n.setAttribute("class","mac-tool"),a.setAttribute("class","mac bb1"),r.setAttribute("class","mac bb2"),c.setAttribute("class","mac bb3"),o.setAttribute("class","language-type"),n.appendChild(a),n.appendChild(r),n.appendChild(c),n.appendChild(o),s.classList.contains("highlight")?(s.appendChild(t),s.appendChild(n)):s.parentNode.firstChild==s||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?(e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t),s.appendChild(n)):(e.parentNode.appendChild(t),s.appendChild(n)))})</script></body></html>