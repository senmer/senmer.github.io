<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Ansible | WZ's Blog</title><meta name=keywords content><meta name=description content="1 Ansible ç®€ä»‹ 1.1 Ansible å‘å±•å² ä½œè€…ï¼šMichael DeHaanï¼ˆ Cobbler ä¸ Func ä½œè€…ï¼‰ Ansible çš„åç§°æ¥è‡ªç§‘å¹»å°è¯´ã€Šå®‰å¾·çš„æ¸¸æˆã€‹ä¸­è·¨è¶Šæ—¶ç©ºçš„å³æ—¶é€šä¿¡å·¥å…·ï¼Œä½¿ç”¨å®ƒå¯ä»¥åœ¨ç›¸è·æ•°å…‰å¹´çš„è·ç¦»ï¼Œè¿œç¨‹å®æ—¶æ§åˆ¶å‰çº¿çš„èˆ°é˜Ÿæˆ˜æ–—ã€‚ 2012-03-09ï¼Œå‘å¸ƒ0.0.1ç‰ˆï¼Œ2015-10-17ï¼ŒRed Hatå®£å¸ƒ1.5äº¿ç¾å…ƒæ”¶è´­An"><meta name=author content="wz"><link rel=canonical href=https://senmer.github.io/zh/posts/tech/ansible/ansible/><link crossorigin=anonymous href=/assets/css/stylesheet.5a2b6d77cc78ad18bcb4914c5c639c7ce5ab55e956c461d4310747892b3f50c2.css integrity="sha256-Wittd8x4rRi8tJFMXGOcfOWrVelWxGHUMQdHiSs/UMI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://senmer.github.io/img/Q.gif><link rel=icon type=image/png sizes=16x16 href=https://senmer.github.io/img/Q.gif><link rel=icon type=image/png sizes=32x32 href=https://senmer.github.io/img/Q.gif><link rel=apple-touch-icon href=https://senmer.github.io/img/Q.gif><link rel=mask-icon href=https://senmer.github.io/img/Q.gif><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer src=https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js></script>
<script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?4d7c4710a089d70b71310f0e1ec7681b",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="Ansible"><meta property="og:description" content="1 Ansible ç®€ä»‹ 1.1 Ansible å‘å±•å² ä½œè€…ï¼šMichael DeHaanï¼ˆ Cobbler ä¸ Func ä½œè€…ï¼‰ Ansible çš„åç§°æ¥è‡ªç§‘å¹»å°è¯´ã€Šå®‰å¾·çš„æ¸¸æˆã€‹ä¸­è·¨è¶Šæ—¶ç©ºçš„å³æ—¶é€šä¿¡å·¥å…·ï¼Œä½¿ç”¨å®ƒå¯ä»¥åœ¨ç›¸è·æ•°å…‰å¹´çš„è·ç¦»ï¼Œè¿œç¨‹å®æ—¶æ§åˆ¶å‰çº¿çš„èˆ°é˜Ÿæˆ˜æ–—ã€‚ 2012-03-09ï¼Œå‘å¸ƒ0.0.1ç‰ˆï¼Œ2015-10-17ï¼ŒRed Hatå®£å¸ƒ1.5äº¿ç¾å…ƒæ”¶è´­An"><meta property="og:type" content="article"><meta property="og:url" content="https://senmer.github.io/zh/posts/tech/ansible/ansible/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-28T15:39:37+08:00"><meta property="article:modified_time" content="2023-08-28T15:39:37+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Ansible"><meta name=twitter:description content="1 Ansible ç®€ä»‹ 1.1 Ansible å‘å±•å² ä½œè€…ï¼šMichael DeHaanï¼ˆ Cobbler ä¸ Func ä½œè€…ï¼‰ Ansible çš„åç§°æ¥è‡ªç§‘å¹»å°è¯´ã€Šå®‰å¾·çš„æ¸¸æˆã€‹ä¸­è·¨è¶Šæ—¶ç©ºçš„å³æ—¶é€šä¿¡å·¥å…·ï¼Œä½¿ç”¨å®ƒå¯ä»¥åœ¨ç›¸è·æ•°å…‰å¹´çš„è·ç¦»ï¼Œè¿œç¨‹å®æ—¶æ§åˆ¶å‰çº¿çš„èˆ°é˜Ÿæˆ˜æ–—ã€‚ 2012-03-09ï¼Œå‘å¸ƒ0.0.1ç‰ˆï¼Œ2015-10-17ï¼ŒRed Hatå®£å¸ƒ1.5äº¿ç¾å…ƒæ”¶è´­An"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"ğŸ“šæ–‡ç« ","item":"https://senmer.github.io/zh/posts/"},{"@type":"ListItem","position":2,"name":"ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯","item":"https://senmer.github.io/zh/posts/tech/"},{"@type":"ListItem","position":3,"name":"Ansible","item":"https://senmer.github.io/zh/posts/tech/ansible/ansible/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Ansible","name":"Ansible","description":"1 Ansible ç®€ä»‹ 1.1 Ansible å‘å±•å² ä½œè€…ï¼šMichael DeHaanï¼ˆ Cobbler ä¸ Func ä½œè€…ï¼‰ Ansible çš„åç§°æ¥è‡ªç§‘å¹»å°è¯´ã€Šå®‰å¾·çš„æ¸¸æˆã€‹ä¸­è·¨è¶Šæ—¶ç©ºçš„å³æ—¶é€šä¿¡å·¥å…·ï¼Œä½¿ç”¨å®ƒå¯ä»¥åœ¨ç›¸è·æ•°å…‰å¹´çš„è·ç¦»ï¼Œè¿œç¨‹å®æ—¶æ§åˆ¶å‰çº¿çš„èˆ°é˜Ÿæˆ˜æ–—ã€‚ 2012-03-09ï¼Œå‘å¸ƒ0.0.1ç‰ˆï¼Œ2015-10-17ï¼ŒRed Hatå®£å¸ƒ1.5äº¿ç¾å…ƒæ”¶è´­An","keywords":[""],"articleBody":"1 Ansible ç®€ä»‹ 1.1 Ansible å‘å±•å² ä½œè€…ï¼šMichael DeHaanï¼ˆ Cobbler ä¸ Func ä½œè€…ï¼‰\nAnsible çš„åç§°æ¥è‡ªç§‘å¹»å°è¯´ã€Šå®‰å¾·çš„æ¸¸æˆã€‹ä¸­è·¨è¶Šæ—¶ç©ºçš„å³æ—¶é€šä¿¡å·¥å…·ï¼Œä½¿ç”¨å®ƒå¯ä»¥åœ¨ç›¸è·æ•°å…‰å¹´çš„è·ç¦»ï¼Œè¿œç¨‹å®æ—¶æ§åˆ¶å‰çº¿çš„èˆ°é˜Ÿæˆ˜æ–—ã€‚\n2012-03-09ï¼Œå‘å¸ƒ0.0.1ç‰ˆï¼Œ2015-10-17ï¼ŒRed Hatå®£å¸ƒ1.5äº¿ç¾å…ƒæ”¶è´­Ansibleã€‚\nAnsibleã€Œ2.9ã€ ä¸­æ–‡å®˜æ–¹æ–‡æ¡£ â€” Ansible Documentation (cn-ansibledoc.readthedocs.io)\n1.2 Ansible åŠŸèƒ½ æ‰¹é‡è¿œç¨‹æ‰§è¡Œå‘½ä»¤ã€å®‰è£…å’Œé…ç½®å„ç§æœåŠ¡ åˆ©ç”¨ Playbook å’Œ Role ç¼–æ’ä¼ä¸šçº§çš„å¤æ‚çš„ IT æ¶æ„ä»»åŠ¡ æä¾›è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·çš„å¼€å‘ APIï¼Œå¦‚ JumpServer å°±æ˜¯åŸºäº Ansible å®ç°è‡ªåŠ¨åŒ–ç®¡ç†åŠŸèƒ½ 1.3 Ansible ç‰¹ç‚¹ 1.3.1 ä¼˜ç‚¹ åŠŸèƒ½ä¸°å¯Œï¼šæ¨¡å—æ•°é‡è¾¾æ•°åƒä¸ªï¼Œä¸”æ”¯æŒè‡ªå®šä¹‰æ¨¡å—å’Œå¤šæ•°ç¼–ç¨‹è¯­è¨€ ç®€å•æ˜“ç”¨ï¼šAnsible ä¸ä½¿ç”¨ C/S æ¶æ„ç®¡ç†èŠ‚ç‚¹ï¼Œå³æ²¡æœ‰ Agentï¼Œå»ä¸­å¿ƒåŒ–ç®¡ç†æ–¹å¼ å®‰å…¨ï¼šåŸºäº OpenSSH åè®®å®ç°å®‰å…¨é€šè®¯ï¼Œæ— éœ€ä¸“ç”¨åè®® å¹‚ç­‰æ€§ï¼šå¯ä»¥é‡å¤å¤šæ¬¡æ‰§è¡Œï¼Œå¯¹ç³»ç»Ÿä¸ä¼šäº§ç”Ÿå½±å“ ä½¿ç”¨ YAML æ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œç®€å•æ˜“è¯» Playbook å’Œ Role æ”¯æŒç¼–æ’å¤æ‚ä»»åŠ¡ï¼Œå¢å¼ºä»£ç å¤ç”¨æ€§ Python è¯­è¨€å®ç°, åŸºäº Paramikoï¼ˆ python å¯¹ ssh çš„å®ç°ï¼‰ï¼ŒPyYAMLï¼ŒJinja2ï¼ˆæ¨¡æ¿è¯­è¨€ï¼‰ä¸‰ä¸ªå…³ é”®æ¨¡å— 1.3.2 ç¼ºç‚¹ ç®¡ç†ä¸»æœºè¾ƒå¤šæ—¶ï¼Œæ‰§è¡Œæ•ˆç‡ä¸å¦‚ saltstack å½“å‰è¿˜ä¸æ”¯æŒåƒ MySQL æ•°æ®åº“ç±»ä¼¼çš„äº‹åŠ¡å›æ»š 1.3.3 æ³¨æ„äº‹é¡¹ å®‰è£…äº† ansible çš„ä¸»æœºå®˜æ–¹ç§°ä¹‹ä¸ºç®¡ç†æœºï¼Œå·¥ä½œä¸­ä¹Ÿå¸¸ç§°ä¹‹ä¸ºï¼šä¸­æ§ã€ä¸»æ§ã€master æˆ–è€…å ¡å’æœº\nè¢«ç®¡ç†çš„ä¸»æœºä¸€èˆ¬ç§°ä¹‹ä¸ºå—ç®¡ç†èŠ‚ç‚¹ï¼Œè¢«æ§ç«¯ï¼Œå—æ§ç«¯\nç®¡ç†æœº Python ç‰ˆæœ¬éœ€è¦ 2.6 åŠä»¥ä¸Š\nå—ç®¡ç†èŠ‚ç‚¹ Python ç‰ˆæœ¬ä½äº 2.4 ï¼Œéœ€è¦å®‰è£… python-simplejson\nå—ç®¡ç†èŠ‚ç‚¹å¦‚æœå¯ç”¨ SELinux ï¼Œéœ€è¦å®‰è£… libselinux-python\nWindows ä¸èƒ½åšä¸ºç®¡ç†æœºï¼Œåªèƒ½æ˜¯å—ç®¡ç†èŠ‚ç‚¹\n2 Ansible å®‰è£…å’Œå¸¸è§æ¨¡å— 2.1 Ansible å®‰è£… ä¸­æ–‡æ–‡æ¡£ï¼šå®‰è£… Ansible â€” Ansible Documentation (cn-ansibledoc.readthedocs.io)\nè‹±æ–‡æ–‡æ¡£ï¼šAnsible Documentation â€” Ansible Documentation\nCentOS å®‰è£…:\nyum install -y ansible Ubuntu å®‰è£…ï¼š\napt install -y ansible pip å®‰è£…ï¼ˆä¸æ¨èï¼‰ï¼š\npip install ansible æŸ¥çœ‹å·²å®‰è£…çš„ ansible ç‰ˆæœ¬\nansible --version 2.2 Ansible ç›¸å…³æ–‡ä»¶ 2.2.1 Ansible é…ç½®æ–‡ä»¶åˆ—è¡¨ /etc/ansible/ansible.cfg ä¸»é…ç½®æ–‡ä»¶ï¼Œå¦‚æœéœ€è¦ï¼Œå¯ä»¥ä¸ºæ¯ä¸ªé¡¹ç›®åˆ›å»ºç‹¬æœ‰çš„ ansible.cfg æ–‡ä»¶ã€‚ /etc/ansible/hosts ä¸»æœºæ¸…å•æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰å—ç®¡ç†èŠ‚ç‚¹çš„ IP åŠå…¶ä»–ç›¸å…³ä¿¡æ¯ /etc/ansible/roles å­˜æ”¾å„ä¸ªè§’è‰²çš„ç›®å½• 2.2.2 Ansible ä¸»é…ç½®æ–‡ä»¶ Ansible çš„é…ç½®æ–‡ä»¶å¯ä»¥æœ‰å¤šä¸ªæ¥æºï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°ä½é¡ºåºå¦‚ä¸‹ï¼š\nANSIBLE_CONFIG #ç¯å¢ƒå˜é‡ ./ansible.cfg\t~/.ansible.cfg /etc/ansible/ansible.cfg\t#ç³»ç»Ÿé»˜è®¤é…ç½® Ansible çš„é»˜è®¤é…ç½®æ–‡ä»¶ /etc/ansible/ansible.cfg ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†æ³¨é‡Šå†…å®¹å³ä¸ºé»˜è®¤å€¼ï¼Œæ²¡æœ‰ç‰¹æ®Šéœ€è¦ï¼Œå¯ä»¥ä¸ç”¨ä¿®æ”¹ã€‚\n[defaults] # some basic default values... #inventory = /etc/ansible/hosts #library = /usr/share/my_modules/ #module_utils = /usr/share/my_module_utils/ #remote_tmp = ~/.ansible/tmp #local_tmp = ~/.ansible/tmp #plugin_filters_cfg = /etc/ansible/plugin_filters.yml #forks = 5 #poll_interval = 15 #sudo_user = root #ask_sudo_pass = True #ask_pass = True #transport = smart #remote_port = 22 #module_lang = C #module_set_locale = False # plays will gather facts by default, which contain information about èŒƒä¾‹ï¼šé€šè¿‡ç¯å¢ƒå˜é‡ ANSIBLE_CONFIG æŒ‡å®š ansible é…ç½®æ–‡ä»¶è·¯å¾„\n[root@ansible ~]# ll /data/ansible.cfg # å¹¶ä¸å­˜åœ¨çš„é…ç½®æ–‡ä»¶ ls: cannot access /data/ansible.cfg: No such file or directory [root@ansible ~]# export ANSIBLE_CONFIG=/data/ansible.cfg [root@ansible ~]# ansible --version ansible 2.9.27 config file = /etc/ansible/ansible.cfg # è¿˜æ˜¯é»˜è®¤é…ç½®æ–‡ä»¶ configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python2.7/site-packages/ansible executable location = /usr/bin/ansible python version = 2.7.5 (default, Oct 30 2018, 23:45:53) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)] [root@ansible ~]# touch /data/ansible.cfg #åˆ›å»ºæ­¤æ–‡ä»¶ [root@ansible ~]# ansible --version ansible 2.9.27 config file = /data/ansible.cfg # æˆåŠŸæŒ‡å®š configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python2.7/site-packages/ansible executable location = /usr/bin/ansible python version = 2.7.5 (default, Oct 30 2018, 23:45:53) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)] 2.2.3 Inventory ä¸»æœºæ¸…å•æ–‡ä»¶ ansible çš„ä¸»è¦åŠŸèƒ½åœ¨äºæ‰¹é‡ç®¡ç†ä¸»æœºï¼Œè¿™äº›è¢«ç®¡ç†çš„ä¸»æœºå°±ä½¿ç”¨ inventory æ–‡ä»¶æ¥æŒ‡å®šã€‚\nç”Ÿäº§ç¯å¢ƒå¯ä»¥ä¸ºæ¯ä¸ªé¡¹ç›®åˆ›å»ºç‹¬æœ‰çš„ ansible.cfg æ–‡ä»¶å’Œ hosts æ–‡ä»¶ï¼Œå®ç°é¡¹ç›®ä¹‹å‰çš„éš”ç¦»ç®¡ç†ã€‚\nå®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html\nä¸»æœºæ¸…å•æ–‡ä»¶æ ¼å¼\ninventory æ–‡ä»¶éµå¾ª INI æ–‡ä»¶é£æ ¼ï¼Œå¯ä»¥å¯¹ä¸»æœºè¿›è¡Œåˆ†ç»„ç®¡ç†ï¼Œä¸”å¯ä»¥é’ˆå¯¹æ¯ä¸ªä¸»æœºæŒ‡å®šéé»˜è®¤çš„ç«¯å£å’Œè´¦å·ç­‰ä¿¡æ¯\nå¸¸ç”¨ Inventory å‚æ•°è¯´æ˜\nansible_ssh_host # è¿œç¨‹ä¸»æœºåä¸æƒ³è¦è®¾å®šçš„ä¸»æœºçš„åˆ«åä¸åŒçš„è¯ï¼Œå¯é€šè¿‡æ­¤å˜é‡è®¾ç½®ã€‚ ansible_ssh_port # ssh ç«¯å£å·ï¼Œå¦‚æœä¸æ˜¯é»˜è®¤çš„ç«¯å£å·ï¼Œé€šè¿‡æ­¤å˜é‡è®¾ç½®ã€‚æˆ–è€…ip:ç«¯å£çš„å½¢å¼æŒ‡å®š 192.168.1.100:2222 ansible_ssh_user # ssh ç”¨æˆ·å ansible_ssh_pass # ssh å¯†ç (è¿™ç§æ–¹å¼å¹¶ä¸å®‰å…¨ï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨ --ask-pass æˆ–è€…é…ç½® ssh å…å¯†) ansible_sudo_pass # sudo å¯†ç (è¿™ç§æ–¹å¼å¹¶ä¸å®‰å…¨ï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨ --ask-sudo-pass) ansible_sudo_exe (new in version 1.8) # sudo å‘½ä»¤è·¯å¾„(é€‚ç”¨äº1.8åŠä»¥ä¸Šç‰ˆæœ¬) ansible_connection # ä¸ä¸»æœºçš„è¿æ¥ç±»å‹.æ¯”å¦‚:local, ssh æˆ–è€… paramikoã€‚ Ansible 1.2 ä»¥å‰é»˜è®¤ä½¿ç”¨ paramikoã€‚1.2 ä»¥åé»˜è®¤ä½¿ç”¨ 'smart'ï¼Œ'smart' æ–¹å¼ä¼šæ ¹æ®æ˜¯å¦æ”¯æŒ ControlPersist, æ¥åˆ¤æ–­'ssh' æ–¹å¼æ˜¯å¦å¯è¡Œã€‚ ansible_ssh_private_key_file # ssh ä½¿ç”¨çš„ç§é’¥æ–‡ä»¶ï¼Œé€‚ç”¨äºæœ‰å¤šä¸ªå¯†é’¥ï¼Œè€Œä½ ä¸æƒ³ä½¿ç”¨ ssh ä»£ç†çš„æƒ…å†µã€‚ ansible_shell_type # ç›®æ ‡ç³»ç»Ÿçš„ shell ç±»å‹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘½ä»¤çš„æ‰§è¡Œä½¿ç”¨ 'sh' è¯­æ³•, å¯è®¾ç½®ä¸º'csh' æˆ– 'fish'ã€‚ ansible_python_interpreter # ç›®æ ‡ä¸»æœºçš„ python è·¯å¾„ï¼Œé€‚ç”¨äºçš„æƒ…å†µ: ç³»ç»Ÿä¸­æœ‰å¤šä¸ª Python, æˆ–è€…å‘½ä»¤è·¯å¾„ä¸æ˜¯\"/usr/bin/python\"ï¼Œæ¯”å¦‚ \\*BSD, æˆ–è€… /usr/bin/python ä¸æ˜¯ 2.X ç‰ˆæœ¬çš„Pythonã€‚ä¹‹æ‰€ä»¥ä¸ä½¿ç”¨ \"/usr/bin/env\" æœºåˆ¶ï¼Œå› ä¸ºè¿™è¦æ±‚è¿œç¨‹ç”¨æˆ·çš„è·¯å¾„è®¾ç½®æ­£ç¡®ï¼Œä¸”è¦æ±‚ \"python\" å¯æ‰§è¡Œç¨‹åºåä¸å¯ä¸º python ä»¥å¤–çš„åå­—(å®é™…æœ‰å¯èƒ½åä¸ºpython26) èŒƒä¾‹ï¼šä¸»æœºå’Œç»„åµŒå¥—\nntp.time.org [databases] www.db1.org:2222 www.db2.org [web] www.web1.com www.web2.com [proxy] pro[1:3].test.com pro-db[a:f].test.com # server ç»„æˆå‘˜ï¼šweb, proxy [server:children] # children æ˜¯å†…ç½®å˜é‡ web proxy èŒƒä¾‹ï¼šåŸºäºç”¨æˆ·åå’Œå¯†ç è¿æ¥\n[test] 10.0.0.1 ansible_connection=local #æŒ‡å®šæœ¬åœ°è¿æ¥æ–¹å¼ï¼Œå¦‚ï¼šssh localhost 10.0.0.2 ansible_connection=ssh ansible_ssh_port=2222 ansible_ssh_user=user ansible_ssh_password=passwd 10.0.0.3 ansible_ssh_user=test ansible_ssh_password=test [web] web01 ansible_ssh_host=10.0.0.5 # web01 ä¸ºåˆ«å web02 ansible_ssh_host=10.0.0.6 [web:vars] # vars æ˜¯å†…ç½®å˜é‡ï¼Œè¿™é‡Œä¸º web ç»„å†…çš„æˆå‘˜å®šä¹‰äº†ä¸€ä¸ªç»„å˜é‡ ansible_ssh_password=test 2.3 Ansible ç›¸å…³å·¥å…· /usr/bin/ansible ä¸»ç¨‹åºï¼Œä¸´æ—¶å‘½ä»¤æ‰§è¡Œå·¥å…· /usr/bin/ansible-doc æŸ¥çœ‹é…ç½®æ–‡æ¡£ï¼Œæ¨¡å—åŠŸèƒ½æŸ¥çœ‹å·¥å…·,ç›¸å½“äºman /usr/bin/ansible-playbook å®šåˆ¶è‡ªåŠ¨åŒ–ä»»åŠ¡ï¼Œç¼–æ’å‰§æœ¬å·¥å…·,ç›¸å½“äºè„šæœ¬ /usr/bin/ansible-pull è¿œç¨‹æ‰§è¡Œå‘½ä»¤çš„å·¥å…· /usr/bin/ansible-vault æ–‡ä»¶åŠ å¯†å·¥å…· /usr/bin/ansible-console åŸºäºConsoleç•Œé¢ä¸ç”¨æˆ·äº¤äº’çš„æ‰§è¡Œå·¥å…· /usr/bin/ansible-galaxy ä¸‹è½½/ä¸Šä¼ ä¼˜ç§€ä»£ç æˆ–Rolesæ¨¡å—çš„å®˜ç½‘å¹³å° åˆ©ç”¨ ansible å®ç°ç®¡ç†çš„ä¸»è¦æ–¹å¼ï¼š\nAnsible Ad-Hoc ä¸»è¦ç”¨äºå‘½ä»¤è¡Œæ‰§è¡Œå‘½ä»¤ï¼Œé€‚åˆäºç®€å•ä»»åŠ¡ Ansible playbook ä¸»è¦ç”¨äºé•¿æœŸè§„åˆ’å¥½çš„ï¼Œå¤§å‹é¡¹ç›®åœºæ™¯ ansible ä½¿ç”¨å‰å‡†å¤‡ï¼š\nansible å¤§éƒ¨åˆ†å·¥å…·ä½¿ç”¨ ssh åè®®æ¥è¿›è¡Œè¿œç¨‹ä¸»æœºç®¡ç†ï¼Œå› æ­¤åœ¨ä½¿ç”¨æ­¤å·¥å…·å‰éœ€è¦é…ç½®å¥½å¯†é’¥è®¤è¯ï¼Œå¦‚æœä½¿ç”¨å¯†ç éªŒè¯ä¼šå¾ˆéº»çƒ¦ï¼Œè€Œä¸”å¹¶ä¸å®‰å…¨ã€‚\nåœ¨é¦–æ¬¡ ssh æŸå°ä¸»æœºæ—¶ï¼Œä¼šæœ‰ä¸€ä¸ªæ˜¯å¦ä¿¡ä»»ä¸»æœºçš„æç¤ºï¼š\n[root@ansible ~]# ssh localhost The authenticity of host 'localhost (::1)' can't be established. ECDSA key fingerprint is SHA256:kFbXYFVk/H+j5h1JTkIf9HAw+zXbWQIHqG03FutZJ3E. ECDSA key fingerprint is MD5:7b:d4:06:49:45:fa:58:b0ğŸ’¿de:ef:bc:1e:14:09:f3. Are you sure you want to continue connecting (yes/no)? å¯ä»¥ä¿®æ”¹ /etc/ssh/ssh_configçš„é…ç½®æ¥é¿å…è¯¥æç¤ºï¼š\nStrictHostKeyChecking no ä»¥ä¸‹å‡†å¤‡äº†ä¸€ä¸ªè„šæœ¬æ¥å®ç° ssh å…å¯†ç™»å½•ï¼š\nå‡†å¤‡ä¸€ä¸ªæ¸…å•æ–‡ä»¶ï¼Œå†™å…¥ç›¸åº”çš„IP\n[root@ansible ~]# cat hosts.txt 10.0.0.1 10.0.0.2 10.0.0.3 è„šæœ¬å†…å®¹ï¼š\n#!/bin/bash # éœ€è¦ä¿®æ”¹çš„å‚æ•° ################### # è¯»å–ä¸»æœºåˆ—è¡¨æ–‡ä»¶ hosts_file=\"hosts.txt\" # è¿œç¨‹ç”¨æˆ·å remote_user=\"your_username\" # å¹¶å‘ä»»åŠ¡æ•°é‡ concurrency=10 # SSH å¯†ç  export ssh_password=\"your_password\" ########################## # é¢œè‰²å®šä¹‰ RED='\\033[0;31m' GREEN='\\033[0;32m' NC='\\033[0m' # No Color # æ‰“å°å¸¦é¢œè‰²çš„æ¶ˆæ¯ print_message() { local message=\"$1\" local color=\"$2\" echo -e \"${color}$message${NC}\" } # æ£€æŸ¥ä¸»æœºåˆ—è¡¨æ–‡ä»¶æ˜¯å¦å­˜åœ¨ if [ ! -f \"$hosts_file\" ]; then echo -e \"\\033[31mHosts file not found: $hosts_file\\033[0m\" exit 1 fi # å®‰è£… sshpass rpm -q sshpass \u0026\u003e /dev/null || yum install -y sshpass # å®‰è£… parallel rpm -qi parallel \u0026\u003e /dev/null || yum install -y parallel # ç”Ÿæˆ id_rsa å¯†é’¥ [ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa -P '' # mkfifo åˆ›å»ºå‘½åç®¡é“ tempfifo=\"/tmp/$$.fifo\" mkfifo ${tempfifo} # å…³è”fifoæ–‡ä»¶å’Œfd6ï¼Œä½¿æ–‡ä»¶æè¿°ç¬¦ä¸ºéé˜»å¡å¼ exec 6\u003c\u003e${tempfifo} rm -f ${tempfifo} # ä¸ºæ–‡ä»¶æè¿°ç¬¦åˆ›å»ºå ä½ä¿¡æ¯ for ((i=1;i\u003c=${concurrency};i++)) do { echo \"\" \u003e\u00266 } done # é€è¡Œè¯»å–ä¸»æœºåˆ—è¡¨æ–‡ä»¶å¹¶æ‰§è¡Œä»»åŠ¡ while IFS= read -r host; do read -u6 ## read -u6å‘½ä»¤æ‰§è¡Œä¸€æ¬¡ï¼Œç›¸å½“äºå°è¯•ä»fd6ä¸­è·å–ä¸€è¡Œï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™é˜»å¡è·å–åˆ°äº† ## ä¸€è¡Œåï¼Œfd6å°±å°‘äº†ä¸€è¡Œäº†ï¼Œå¼€å§‹å¤„ç†å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹æ”¾åœ¨åå°æ‰§è¡Œ { sshpass -p \"$ssh_password\" ssh-copy-id -o StrictHostKeyChecking=no \"$remote_user@$host\" \u0026\u003e/dev/null; exit_code=$? if [ $exit_code -eq 0 ]; then print_message \"æˆåŠŸå…å¯†ä¸»æœº: $host\" \"$GREEN\" else print_message \"å¤±è´¥å…å¯†ä¸»æœº: $host\" \"$RED\" fi echo \"\" \u003e\u00266 # å®Œæˆåå†è¡¥å……ä¸€ä¸ªç©ºå€¼åˆ°fd6ä¸­ï¼Œé‡Šæ”¾ä¸€ä¸ªé” } \u0026 done \u003c \"$hosts_file\" wait # å…³é—­fd6ç®¡é“ exec 6\u003e\u0026- 2.3.1 Ansible-doc æ­¤å·¥å…·ç”¨äºæ˜¾ç¤ºæ¨¡å—å¸®åŠ©æ–‡æ¡£ï¼Œç±»ä¼¼ man\nä½¿ç”¨æ ¼å¼ï¼š\nansible-doc [options] [module...] -l, --list # åˆ—å‡ºå¯ç”¨æ¨¡å— -s, --snippet # æ˜¾ç¤ºæŒ‡å®šæ¨¡å—çš„playbookç‰‡æ®µ å¸¸ç”¨é€‰é¡¹ï¼š\n# åˆ—å‡ºæ‰€æœ‰æ¨¡å— ansible-doc -l # æŸ¥çœ‹æŒ‡å®šæ¨¡å—å¸®åŠ©ç”¨æ³• ansible-doc ping # æŸ¥çœ‹å¸¸ç”¨playbooké€‰é¡¹ ansible-doc -s ping æŸ¥çœ‹æ¨¡å—ç›¸å…³çš„æ’ä»¶\n# connection æ¨¡å—ç›¸å…³ç»„ä»¶ ansible-doc -t connection -l # lookup æ¨¡å—ç›¸å…³ç»„ä»¶ ansible-doc -t lookup -l 2.3.2 Ansible 2.3.2.1 Ansible Ad-Hoc Ansible Ad-Hoc ä¸»è¦å°±æ˜¯ä½¿ç”¨ansibleä¸»ç¨‹åº\né€šå¸¸ç”¨æ¥æ‰§è¡Œä¸€æ¬¡æ€§ä»»åŠ¡ï¼Œä¸ä¼šä¿å­˜å‘½ä»¤æ‰§è¡Œçš„ä¿¡æ¯ï¼Œå¸¸ç”¨äºæµ‹è¯•åœºæ™¯\n2.3.2.2 Ansible å‘½ä»¤ç”¨æ³• æ ¼å¼ï¼š\nansible [-m module_name] [-a args] å¸¸ç”¨é€‰é¡¹ï¼š\n--version\t# æŸ¥çœ‹ ansible ç‰ˆæœ¬å’Œé…ç½®æ–‡ä»¶è·¯å¾„ -m # æŒ‡å®šä½¿ç”¨çš„æ¨¡å—ï¼Œä¸æŒ‡å®šé»˜è®¤ä¸º command -v # ç”¨äº debugï¼Œ-vv -vvv å¯æ˜¾ç¤ºæ›´è¯¦ç»†å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹çš„æ—¥å¿— --list-hosts\t# æ˜¾ç¤ºæ¸…å•æ–‡ä»¶ä¸­çš„ä¸»æœºåˆ—è¡¨ -C, --check\t# æ¨¡æ‹Ÿæ‰§è¡Œï¼Œå¹¶ä¸å¯¹ç›®æ ‡ä¸»æœºåšå®é™…æ”¹åŠ¨ï¼Œå¯ä»¥ç”¨æ¥æ£€æŸ¥è¯­æ³• -T, --timeout=TIMEOUT # æŒ‡å®šå‘½ä»¤æ‰§è¡Œè¶…æ—¶æ—¶é—´ -k, --ask-pass # æç¤ºè¾“å…¥ ssh å¯†ç ï¼Œä½¿ç”¨å¯†ç éªŒè¯ï¼Œé»˜è®¤ä½¿ç”¨ key éªŒè¯ -u, --user=USERNAME # æŒ‡å®š sudo ç”¨æˆ·ï¼Œé»˜è®¤ä¸º root -b, --become # ä½¿ç”¨ sudo æœºåˆ¶ --become-user=USERNAME # æŒ‡å®š sudo çš„ç›®æ ‡ç”¨æˆ·ï¼Œé»˜è®¤ä¸º root -K, --ask-become-pass\t# æç¤ºè¾“å…¥ sudo å¯†ç  -f , --FORKS # æŒ‡å®šå¹¶å‘æ•° èŒƒä¾‹ï¼šä½¿ç”¨ localhost èµ°æœ¬åœ°åè®®ï¼Œå¹¶ä¸éœ€è¦å¯†ç ï¼ˆåŒ…æ‹¬ sudo å¯†ç ï¼‰ï¼š\n# ä»¥test ç”¨æˆ·æ‰§è¡Œæ“ä½œï¼Œ [root@ansible ~]# ansible localhost -m ping -u test localhost | SUCCESS =\u003e { \"changed\": false, \"ping\": \"pong\" } # æŒ‡å®šäº†ç”¨æˆ·ä¸º testï¼Œä½†å¹¶æœªç”Ÿæ•ˆ [root@ansible ~]# ansible localhost -m shell -a \"whoami\" -u test localhost | CHANGED | rc=0 \u003e\u003e root # ä»¥ test ç”¨æˆ·ä½¿ç”¨ sudo æœºåˆ¶æ‰§è¡Œå‘½ä»¤ [root@ansible ~]# [root@ansible ~]# ansible localhost -m shell -a \"whoami\" -u test -b -become-user=root localhost | CHANGED | rc=0 \u003e\u003e root èŒƒä¾‹ï¼šä½¿ç”¨ IPè¿æ¥ï¼Œå¯è§‚æµ‹åˆ° ansible çš„ç›¸å…³ç‰¹æ€§\n# æœ¬æœºIP [root@ansible ~]# hostname -I 192.168.0.133 # å°†æœ¬æœºIPåŠ å…¥æ¸…å•æ–‡ä»¶ï¼ˆlocalhostä¸éœ€è¦æ˜¾å¼åŠ å…¥ï¼‰ [root@ansible ~]# grep $(hostname -I) /etc/ansible/hosts 192.168.0.133 # æ²¡æœ‰è¾“å…¥å¯†ç æç¤ºæƒé™ä¸è¶³ [root@ansible ~]# ansible 192.168.0.133 -m shell -a \"whoami\" -u test 192.168.0.133 | UNREACHABLE! =\u003e { \"changed\": false, \"msg\": \"Failed to connect to the host via ssh: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).\", \"unreachable\": true } # åŠ å…¥ -k é€‰é¡¹è¾“å…¥å¯†ç ï¼ŒæˆåŠŸæ‰§è¡Œ [root@ansible ~]# ansible 192.168.0.133 -m shell -a \"whoami\" -u test -k SSH password: 192.168.0.133 | CHANGED | rc=0 \u003e\u003e test # sudo ä¹Ÿæ˜¯åŒæ ·çš„æƒ…å†µï¼Œä¸è¾“å…¥å¯†ç ä¼šæŠ¥é”™ [root@ansible ~]# ansible 192.168.0.133 -m shell -a \"whoami\" -u test -k -b SSH password: 192.168.0.133 | FAILED | rc=-1 \u003e\u003e Missing sudo password # è¾“å…¥å¯†ç åæˆåŠŸæ‰§è¡Œ [root@ansible ~]# ansible 192.168.0.133 -m shell -a \"whoami\" -u test -k -b -K SSH password: BECOME password[defaults to SSH password]: 192.168.0.133 | CHANGED | rc=0 \u003e\u003e root èŒƒä¾‹ï¼šå¹¶å‘æ‰§è¡Œæ§åˆ¶\n# åˆ†åˆ«æ‰§è¡Œä¸€ä¸‹ä»¥ä¸‹ä¸¤ä¸ªå‘½ä»¤è§‚å¯Ÿè¿è¡Œæ•ˆæœï¼Œå¯ä»¥å‘ç°æ‰§è¡Œçš„ä¹‹é—´åŸºæœ¬ä¸€è‡´ [root@ansible ~]# ansible localhost -a 'sleep 3' -f 1 [root@ansible ~]# ansible localhost -a 'sleep 3' -f 10 èŒƒä¾‹ï¼šä½¿ç”¨æ™®é€šç”¨æˆ·è¿›è¡Œè¿œç¨‹ç®¡ç†\n# åœ¨æ‰€æœ‰æ§åˆ¶ç«¯å’Œè¢«æ§åˆ¶ç«¯åˆ›å»ºæ™®é€šè´¦å·å¹¶ä¿®æ”¹å¯†ç ï¼ˆæœ¬æ¬¡ç¤ºä¾‹ä¸ºå‡ä¸º192.168.0.133ï¼‰ [root@ansible ~]# useradd test [root@ansible ~]# echo test:test | chpasswd # æ·»åŠ sudoæˆæƒ [root@ansible ~]# visudo # æ·»åŠ ä¸€è¡Œ test\tALL=(ALL) ALL # æ ¡éªŒé…ç½®æ— è¯¯ [root@ansible ~]# visudo -c /etc/sudoers: parsed OK # åˆ‡æ¢åˆ°æ™®é€šç”¨æˆ· [root@ansible ~]# su - test # ç”Ÿæˆå¯†é’¥å¯¹ [test@ansible ~]$ ssh-keygen -f ~/.ssh/id_rsa -P ' # å°†å…¬é’¥æ‹·è´åˆ°ç›®æ ‡ä¸»æœº [test@ansible ~] ssh-copy-id -o \"StrictHostKeyChecking=no\" test@192.168.0.133 # éªŒè¯å…å¯†ç™»å½•æˆåŠŸ [test@ansible ~]$ ssh test@192.168.0.133 Last login: Mon Jun 12 09:50:05 2023 # ä½¿ç”¨ansibleè¿›è¡Œè¿œç¨‹æ§åˆ¶ï¼Œæç¤ºæƒé™ä¸è¶³ [test@ansible ~]$ ansible 192.168.0.133 -m shell -a 'ls /root/' 192.168.0.133 | FAILED | rc=2 \u003e\u003e ls: cannot open directory /root/: Permission deniednon-zero return code # ä½¿ç”¨ sudo ææƒåæ‰§è¡ŒæˆåŠŸ [test@ansible ~]$ ansible 192.168.0.133 -m shell -a 'ls /root/' -b -K BECOME password: 192.168.0.133 | CHANGED | rc=0 \u003e\u003e ansible.cfg **æ³¨æ„ï¼š**åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œansible è¿œæ§æ—¶å¹¶æœªæŒ‡å®šè¿œç¨‹çš„ç”¨æˆ·åï¼Œå½“æ²¡æœ‰ç”¨ -u æŒ‡å®šè¿œç¨‹ç”¨æˆ·åæ—¶ï¼Œé»˜è®¤ä½¿ç”¨å½“å‰çš„æœ¬æœºç”¨æˆ·åè¿›è¡Œè¿œç¨‹\n[root@ansible ~]# ansible 192.168.0.133 -m shell -a 'whoami' 192.168.0.133 | CHANGED | rc=0 \u003e\u003e root [root@ansible ~]# su - test Last login: Mon Jun 12 10:03:04 CST 2023 from 192.168.0.133 on pts/3 [test@ansible ~]$ ansible 192.168.0.133 -m shell -a 'whoami' 192.168.0.133 | CHANGED | rc=0 \u003e\u003e test # é€šè¿‡ -u æ˜¾å¼æŒ‡æ˜è¿œç¨‹ç”¨æˆ·å [test@ansible ~]$ ansible 192.168.0.133 -m shell -a 'whoami' -u root -k SSH password: 192.168.0.133 | CHANGED | rc=0 \u003e\u003e root ansible Host-pattern\nç”¨äºåŒ¹é…ä¸»æœºæ¸…å•ä¸­çš„ä¸»æœº\nå‡†å¤‡ä¸»æœºæ¸…å•æ–‡ä»¶ï¼š\n[root@ansible ~]# cat /etc/ansible/hosts 192.168.0.133 [hello] 192.168.0.1 172.31.5.1 [world] 10.0.0.1 172.31.5.1 all : å†…ç½®å˜é‡ï¼Œè¡¨ç¤ºæ‰€æœ‰ä¸»æœº\n[root@ansible ~]# ansible all --list-hosts hosts (4): 192.168.0.133 10.0.0.1 172.31.5.1 192.168.0.1 *: é€šé…ç¬¦\n[root@ansible ~]# ansible \"*\" --list-hosts hosts (4): 192.168.0.133 10.0.0.1 172.31.5.1 192.168.0.1 [root@ansible ~]# ansible \"192.168.0.*\" --list-hosts hosts (2): 192.168.0.1 192.168.0.133 é€»è¾‘æˆ–\n[root@ansible ~]# ansible \"hello:world\" --list-hosts hosts (3): 192.168.0.1 172.31.5.1 10.0.0.1 é€»è¾‘ä¸\n[root@ansible ~]# ansible \"hello:\u0026world\" --list-hosts hosts (1): 172.31.5.1 é€»è¾‘é\n# å¼•ç”¨!å·æ—¶,ä¸è¦ç”¨åŒå¼•å·,è€Œä½¿ç”¨å•å¼•å· # åœ¨Ansibleä¸­ï¼Œå•å¼•å·ç”¨äºæŒ‡å®šå­—é¢å€¼æ¨¡å¼ï¼Œä»¥ç¡®ä¿å…¶ä¸­çš„å†…å®¹è¢«è§†ä¸ºæ™®é€šå­—ç¬¦ï¼Œè€Œä¸è¿›è¡Œå˜é‡å±•å¼€æˆ–è½¬ä¹‰å­—ç¬¦å¤„ç†ã€‚ [root@ansible ~]# ansible 'all:!hello:!world' --list-hosts hosts (1): 192.168.0.133 æ­£åˆ™è¡¨è¾¾å¼\nansible \"~(web|db).*\\.test\\.com\" -m ping \"~(web|db).*\\.test\\.com\"æ˜¯ç”¨äºé€‰æ‹©ç›®æ ‡ä¸»æœºçš„æ¨¡å¼ï¼ˆpatternï¼‰ã€‚è®©æˆ‘ä»¬é€æ­¥è§£é‡Šè¿™ä¸ªæ¨¡å¼ï¼š\n~æ˜¯Ansibleä¸­ç”¨äºåŒ¹é…æ­£åˆ™è¡¨è¾¾å¼çš„è¿ç®—ç¬¦ã€‚ (web|db)è¡¨ç¤ºé€‰æ‹©ä»¥\"web\"æˆ–\"db\"å¼€å¤´çš„å­—ç¬¦ä¸²ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¨¡å¼å°†åŒ¹é…\"web\"æˆ–\"db\"ä¹‹åçš„ä»»æ„å­—ç¬¦ã€‚ .*è¡¨ç¤ºåŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªä»»æ„å­—ç¬¦ã€‚ \\.test\\.comè¡¨ç¤ºåŒ¹é…å­—ç¬¦ä¸²\".test.com\"ã€‚ å› æ­¤ï¼Œæ•´ä¸ªæ¨¡å¼~(web|db).*\\.test\\.comå°†åŒ¹é…ä»¥\"web\"æˆ–\"db\"å¼€å¤´ï¼Œç„¶åæ˜¯ä»»æ„å­—ç¬¦ï¼ˆé›¶ä¸ªæˆ–å¤šä¸ªï¼‰ï¼Œæœ€åä»¥\".test.com\"ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚\nä½¿ç”¨è¯¥æ¨¡å¼ï¼Œansibleå‘½ä»¤å°†é€‰æ‹©ç¬¦åˆè¯¥æ¨¡å¼çš„è¿œç¨‹ä¸»æœºï¼Œå¹¶å¯¹å®ƒä»¬æ‰§è¡ŒPingæ“ä½œã€‚Pingæ“ä½œæ—¨åœ¨æ£€æŸ¥ä¸ç›®æ ‡ä¸»æœºçš„è¿é€šæ€§ï¼Œå¹¶ç¡®å®šæ˜¯å¦å¯ä»¥ä¸ä¹‹é€šä¿¡ã€‚\nç»¼ä¸Šæ‰€è¿°ï¼Œansible \"~(web|db).*\\.test\\.com\" -m pingå‘½ä»¤å°†ä½¿ç”¨Ansibleé€‰æ‹©ä»¥\"web\"æˆ–\"db\"å¼€å¤´ï¼Œç„¶åæ˜¯ä»»æ„å­—ç¬¦ï¼Œæœ€åä»¥\".test.com\"ç»“å°¾çš„ä¸»æœºï¼Œå¹¶å¯¹å®ƒä»¬æ‰§è¡ŒPingæ“ä½œã€‚\n2.3.2.3 Ansible å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹ åŠ è½½é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤ä¸º /etc/ansible/ansible.cfg åŒ¹é…ä¸»æœºæ¸…å•ä¸­å¯¹åº”çš„ä¸»æœºæˆ–è€…ä¸»æœºç»„ åŠ è½½å¯¹åº”çš„æ¨¡å—æ–‡ä»¶ï¼Œå¦‚ï¼šshell é€šè¿‡ ansible å°†æ¨¡å—æˆ–å‘½ä»¤ç”Ÿæˆä¸´æ—¶ py æ–‡ä»¶ï¼Œå¹¶å°†è¯¥æ–‡ä»¶ä¼ è¾“è‡³å—æ§èŠ‚ç‚¹ï¼š$HOME/.ansible/tmp/ansible-tmp-æ•°å­—/XXX.PYæ–‡ä»¶ èµ‹äºˆ xxx.py æ–‡ä»¶æ‰§è¡Œæƒé™ï¼š+x æ‰§è¡Œå¹¶è¿”å›ç»“æœ åˆ é™¤ xxx.py æ–‡ä»¶ï¼Œç»“æŸ 2.3.2.4 Ansible å‘½ä»¤æ‰§è¡ŒçŠ¶æ€ æ¯ç§çŠ¶æ€å¯¹åº”äº†ä¸€ä¸ªé¢œè‰²æ ‡è¯†\n[root@ansible ~]# grep -A 14 '\\[colors\\]' /etc/ansible/ansible.cfg [colors] #highlight = white #verbose = blue #warn = bright purple #error = red #debug = dark gray #deprecate = purple #skip = cyan #unreachable = red #ok = green #changed = yellow #diff_add = green #diff_remove = red #diff_lines = cyan å¸¸è§çš„ä¸‰ç§é¢œè‰²æ ‡è¯†ï¼š\nç»¿è‰²ï¼šè¡¨ç¤ºä»»åŠ¡æˆåŠŸå®Œæˆã€‚å½“ä»»åŠ¡åœ¨è¿œç¨‹ä¸»æœºä¸ŠæˆåŠŸæ‰§è¡Œå¹¶è¿”å›æ­£ç¡®çš„ç»“æœæ—¶ï¼Œè¯¥ä»»åŠ¡å°†ä»¥ç»¿è‰²æ˜¾ç¤ºã€‚\n**é»„è‰²ï¼š**è¡¨ç¤ºä»»åŠ¡å·²æ›´æ”¹ã€‚å½“ä»»åŠ¡åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œå¹¶å¯¼è‡´ä¸€äº›æ›´æ”¹æ—¶ï¼Œä½†ä¸ä¼šç ´åç³»ç»Ÿæˆ–å¼•å‘é”™è¯¯æ—¶ï¼Œè¯¥ä»»åŠ¡å°†ä»¥é»„è‰²æ˜¾ç¤ºã€‚ä¾‹å¦‚ï¼Œå¦‚æœæŸä¸ªé…ç½®æ–‡ä»¶çš„æŸè¡Œå·²æ›´æ”¹ï¼Œä½†è¯¥æ›´æ”¹ä¸ä¼šå¯¼è‡´é—®é¢˜æˆ–é”™è¯¯ï¼Œä»»åŠ¡çŠ¶æ€å°†æ˜¾ç¤ºä¸ºé»„è‰²ã€‚\n**çº¢è‰²ï¼š**è¡¨ç¤ºä»»åŠ¡å¤±è´¥ã€‚å½“ä»»åŠ¡åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œæ—¶å‘ç”Ÿé”™è¯¯æˆ–è¿”å›é”™è¯¯ç»“æœæ—¶ï¼Œè¯¥ä»»åŠ¡å°†ä»¥çº¢è‰²æ˜¾ç¤ºã€‚è¿™å¯èƒ½æ˜¯ç”±äºè¿æ¥é—®é¢˜ã€æƒé™é—®é¢˜ã€è¯­æ³•é”™è¯¯æˆ–å…¶ä»–åŸå› å¯¼è‡´çš„å¤±è´¥ã€‚\n2.3.3 ansible-console æ­¤å·¥å…·ä¸»è¦ç”¨äºäº¤äº’å¼æ‰§è¡Œå‘½ä»¤ï¼Œæ”¯æŒå‘½ä»¤è¡¥å…¨ï¼Œansible 2.0+ ç‰ˆæœ¬æ–°å¢\næç¤ºç¬¦æ ¼å¼ï¼š\nè¿œç¨‹ç”¨æˆ·@ç›®æ ‡ä¸»æœºç»„ï¼ˆç»„ä¸­çš„ä¸»æœºæ•°é‡ï¼‰[f:å¹¶å‘æ•°]$ å¸¸ç”¨å‘½ä»¤ï¼š\nè®¾ç½®å¹¶å‘æ•°ï¼šforks åˆ‡æ¢ç»„ï¼šcd [group_name]\næŸ¥çœ‹å½“å‰ç»„ä¸­çš„ä¸»æœºï¼šlist\næŸ¥çœ‹æ‰€æœ‰çš„å†…ç½®å‘½ä»¤ï¼šï¼Ÿæˆ– help\né€€å‡ºï¼šexit æˆ–è€… Ctrl+ D\nç¤ºä¾‹ï¼š\n[root@ansible ~]# ansible-console Welcome to the ansible console. Type help or ? to list commands. root@all (4)[f:5]$ forks 6 root@all (4)[f:6]$ cd hello root@hello (2)[f:6]$ exit 2.3.4 ansible-playbook æ­¤å·¥å…·ä¸»è¦ç”¨äºæ‰§è¡Œç¼–å†™å¥½çš„ playbook ä»»åŠ¡\nèŒƒä¾‹ï¼š\n[root@ansible playbooks]# cat hello.yaml # playbook ä»»åŠ¡ï¼Œæ‰“å° hello world - hosts: localhost remote_user: root gather_facts: no tasks: - name: hello world shell: wall \"hello world\" # å‘æ‰€æœ‰å·²ç™»å½•ç”¨æˆ·å¹¿æ’­æ¶ˆæ¯ [root@ansible playbooks]# ansible-playbook hello.yaml # æ‰§è¡Œ playbook ä»»åŠ¡ PLAY [localhost] *************************************************************************************************************************************** TASK [hello world] ************************************************************************************************************************************* Broadcast message from root@ansible.localdomain (Mon Jun 19 09:15:36 2023): hello world changed: [localhost] PLAY RECAP ********************************************************************************************************************************************* localhost : ok=1 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 2.3.5 ansible-vault æ­¤å·¥å…·ç”¨äºåŠ å¯†ï¼Œè§£å¯† yaml æ–‡ä»¶\næ ¼å¼ï¼š\nansible-vault [create,decrypt,edit,view,encrypt,encrypt_string,rekey] \u003c*.yaml\u003e èŒƒä¾‹ï¼š\n[root@ansible playbooks]# ansible-vault encrypt hello.yaml # åŠ å¯†æ–‡ä»¶ New Vault password: Confirm New Vault password: Encryption successful [root@ansible playbooks]# ansible-vault view hello.yaml # æŸ¥çœ‹åŠ å¯†æ–‡ä»¶å†…å®¹ï¼Œéœ€è¦è¾“å…¥æ­£ç¡®çš„å¯†ç  Vault password: - hosts: localhost remote_user: root gather_facts: no tasks: - name: hello world shell: wall \"hello world\" [root@ansible playbooks]# cat hello.yaml # æ­£å¸¸æŸ¥çœ‹ï¼Œåªèƒ½çœ‹åˆ°å¯†æ–‡ $ANSIBLE_VAULT;1.1;AES256 62623561653235343235613763393365396164323430366161363731646339303965316136333964 6662366334363161363465636630646532616334666538640a383037313035646537613264306130 62323438653861613736336339353037373537633066396566366136373832666332636364336362 6130363834346566630a343765303630616631643436373036353966356663366537343863653535 65653565653765363961313738386266336538353336376664643330316633303636333337336237 35653162313461383436643237623034363436373430363237346334663062306638386566313738 36346165643437643230396664346564383039623434346332313961303331383331313761663939 63313665306463356433393731663965366131353336666135343530613062306433623234623666 39633764623862353238613139333264343735303330626432363831646331653666313361316565 3034363863323531393761316363626263653838313734343134 [root@ansible playbooks]# ansible-playbook hello.yaml # ä¸èƒ½ç›´æ¥æ‰§è¡Œå·²åŠ å¯†çš„ playbook ERROR! Attempting to decrypt but no vault secrets found [root@ansible playbooks]# ansible-playbook --ask-vault-pass hello.yaml # åŠ å…¥é€‰é¡¹ï¼Œè¾“å…¥å¯†ç åæ‰§è¡Œ [root@ansible playbooks]# cat pass.txt # å‡†å¤‡å¯†ç æ–‡ä»¶ï¼Œå­˜æ”¾å¯†ç  dd [root@ansible playbooks]# ansible-playbook --vault-password-file pass.txt hello.yaml # ä»æ–‡ä»¶ä¸­è¯»å–å¯†ç  [root@ansible playbooks]# grep vault_password_file /etc/ansible/ansible.cfg # ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„è¯¥é¡¹ï¼ŒæŒ‡å®šå¯†ç æ–‡ä»¶è·¯å¾„ vault_password_file = /etc/ansible/pass.txt [root@ansible playbooks]# ansible-playbook hello.yaml # å¯ä»¥æ­£å¸¸æ‰§è¡Œ playbook [root@ansible playbooks]# ansible-vault edit hello.yaml # ç¼–è¾‘åŠ å¯†æ–‡ä»¶ï¼Œéœ€è¦è¾“å…¥æ­£ç¡®çš„å¯†ç  Vault password: [root@ansible playbooks]# ansible-vault decrypt hello.yaml # è§£å¯†æ–‡ä»¶ Vault password: Decryption successful [root@ansible playbooks]# cat hello.yaml # å¯ä»¥çœ‹åˆ°æœªåŠ å¯†çš„åŸæ–‡ - hosts: localhost remote_user: root gather_facts: no tasks: - name: hello world shell: wall \"hello world +++\" [root@ansible playbooks]# ansible-vault create new.yaml # å¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ªåŠ å¯†æ–‡ä»¶ New Vault password: Confirm New Vault password: [root@ansible playbooks]# ansible-vault rekey new.yaml # è¾“å…¥æ—§å¯†ç åï¼Œå¯ä»¥æ›´æ”¹å¯†ç  Vault password: New Vault password: Confirm New Vault password: Rekey successful 2.3.6 ansible-galaxy Galaxy æ˜¯ä¸€ä¸ªå…è´¹ç½‘ç«™, ç±»ä¼¼äºgithubç½‘ç«™, ç½‘ç«™ä¸Šå‘å¸ƒäº†å¾ˆå¤šçš„å…±äº«çš„rolesè§’è‰²ã€‚\nAnsible æä¾›äº†ansible-galaxyå‘½ä»¤è¡Œå·¥å…·è¿æ¥ https://galaxy.ansible.com ç½‘ç«™ä¸‹è½½ç›¸åº”çš„rolesï¼Œè¿›è¡Œ\ninit (åˆå§‹åŒ–)ã€search ( æŸ¥æ‹˜)ã€install (å®‰è£…)ã€ remove(ç§»é™¤)ç­‰æ“ä½œã€‚\nansible-galaxyæ˜¯ä¸€ä¸ªä¸Ansibleé…ç½®ç®¡ç†å·¥å…·ç›¸å…³çš„å‘½ä»¤è¡Œå·¥å…·ã€‚å®ƒç”¨äºç®¡ç†å’Œæ‰©å±•Ansibleè§’è‰²å’Œé›†åˆã€‚\nä½¿ç”¨ansible-galaxyï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\nå®‰è£…è§’è‰²å’Œé›†åˆï¼šå¯ä»¥ä½¿ç”¨ansible-galaxy installå‘½ä»¤å®‰è£…å…¶ä»–äººç¼–å†™çš„Ansibleè§’è‰²æˆ–é›†åˆã€‚ä¾‹å¦‚ï¼Œè¦å®‰è£…ä¸€ä¸ªåä¸ºmyroleçš„è§’è‰²ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆé»˜è®¤ä¸‹è½½åˆ°~/.ansible/rolesä¸‹ï¼‰ï¼š\nansible-galaxy install myrole åˆ›å»ºè§’è‰²ï¼šä½¿ç”¨ansible-galaxy initå‘½ä»¤å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„Ansibleè§’è‰²ç»“æ„ã€‚è¯¥å‘½ä»¤å°†ç”Ÿæˆä¸€ä¸ªåŒ…å«ç›®å½•å’Œæ–‡ä»¶çš„ç›®å½•ç»“æ„ï¼Œç”¨äºç»„ç»‡è§’è‰²çš„ä»»åŠ¡ã€å˜é‡ã€æ¨¡æ¿ç­‰å†…å®¹ã€‚ä¾‹å¦‚ï¼Œè¦åˆ›å»ºä¸€ä¸ªåä¸ºmyroleçš„è§’è‰²ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\nansible-galaxy init myrole åˆ—å‡ºå·²å®‰è£…çš„è§’è‰²å’Œé›†åˆï¼šä½¿ç”¨ansible-galaxy listå‘½ä»¤å¯ä»¥åˆ—å‡ºå·²ç»å®‰è£…åœ¨ç³»ç»Ÿä¸Šçš„è§’è‰²å’Œé›†åˆã€‚è¿™å°†æ˜¾ç¤ºå·²å®‰è£…çš„è§’è‰²å’Œé›†åˆçš„åç§°ã€ç‰ˆæœ¬å·å’Œå…¶ä»–è¯¦ç»†ä¿¡æ¯ã€‚\nåˆ é™¤è§’è‰²å’Œé›†åˆï¼šå¯ä»¥ä½¿ç”¨ansible-galaxy removeå‘½ä»¤ä»ç³»ç»Ÿä¸­åˆ é™¤å·²å®‰è£…çš„è§’è‰²å’Œé›†åˆã€‚ä¾‹å¦‚ï¼Œè¦åˆ é™¤ä¸€ä¸ªåä¸ºmyroleçš„è§’è‰²ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\nansible-galaxy remove myrole è¿™äº›åªæ˜¯ansible-galaxyå‘½ä»¤çš„ä¸€äº›å¸¸è§ç”¨æ³•ç¤ºä¾‹ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯å’Œé€‰é¡¹ï¼Œè¯·æŸ¥é˜…Ansibleå®˜æ–¹æ–‡æ¡£æˆ–è¿è¡Œansible-galaxy --helpå‘½ä»¤æ¥è·å–å¸®åŠ©ã€‚\n2.4 Ansible å¸¸ç”¨æ¨¡å— 2015å¹´12æœˆåª270å¤šä¸ªæ¨¡å—\n2016å¹´12å¹´26æ—¥ansible 1.9.2 æœ‰540ä¸ªæ¨¡å—\n2018å¹´01æœˆ12æ—¥ansible 2.3.8 æœ‰1378ä¸ªæ¨¡å—\n2018å¹´05æœˆ28æ—¥ansible 2.5.3 æœ‰1562ä¸ªæ¨¡å—\n2018å¹´07æœˆ15æ—¥ansible 2.6.3 æœ‰1852ä¸ªæ¨¡å—\n2018å¹´11æœˆ19æ—¥ansible 2.7.2 æœ‰2080ä¸ªæ¨¡å—\n2020å¹´03æœˆ02æ—¥ansible 2.9.5 æœ‰3387ä¸ªæ¨¡å—\n2021å¹´12æœˆ22æ—¥ansible 2.11.8 æœ‰6141ä¸ªæ¨¡å—\n2022å¹´06æœˆ04æ—¥ansible 2.12.6 æœ‰6763ä¸ªæ¨¡å—\nè™½ç„¶æ¨¡å—ä¼—å¤šï¼Œä½†æœ€å¸¸ç”¨çš„æ¨¡å—çº¦30ä¸ªå·¦å³ï¼Œé’ˆå¯¹ç‰¹å®šä¸šåŠ¡å­¦ä¹ éœ€è¦çš„æ¨¡å—å³å¯\nå¸¸ç”¨æ¨¡å—å¸®åŠ©æ–‡æ¡£å‚è€ƒï¼š\nModule Index â€” Ansible Documentation\nAll modules â€” Ansible Documentation\næœ¬ç« èŠ‚å†…å®¹ä»¥æ­¤ä¸»æœºæ¸…å•è¿›è¡Œæ¼”ç¤ºï¼Œansible ä¸ºç®¡ç†èŠ‚ç‚¹ï¼Œremote ä¸ºå—æ§èŠ‚ç‚¹\n[root@ansible ~]# hostname -I 192.168.0.133 [root@ansible ~]# cat /etc/ansible/hosts remote ansible_ssh_host=192.168.0.134 remote2 ansible_ssh_host=192.168.0.135 2.4.1 command æ¨¡å— é»˜è®¤æ¨¡å—ã€‚åœ¨è¿œç¨‹ä¸»æœºæ‰§è¡Œå‘½ä»¤ï¼Œæ‰§è¡Œå‘½ä»¤æ—¶ä¸åŠ  -m åˆ™é»˜è®¤ä½¿ç”¨æ­¤æ¨¡å—\næ­¤å‘½ä»¤ä¸æ”¯æŒ \u003c, \u003e, |, ; and \u0026 ç­‰é«˜çº§ç‰¹æ€§æˆ–è¿ç®—ç¬¦\næ­¤æ¨¡å—ä¸å…·å¤‡å¹‚ç­‰æ€§\nå¸¸ç”¨é€‰é¡¹ï¼š\nchdir=DIR\t# åˆ‡æ¢ç›®å½• creates=FILE\t# å½“ FILE ä¸å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œæ“ä½œ removes=FILE\t# å½“ FILE å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œæ“ä½œ\tèŒƒä¾‹ï¼š\n# åˆ‡æ¢ç›®å½•ï¼ŒæŸ¥çœ‹ç³»ç»Ÿç‰ˆæœ¬ [root@ansible ~]# ansible localhost -a 'chdir=/etc cat centos-release' localhost | CHANGED | rc=0 \u003e\u003e CentOS Linux release 7.6.1810 (Core) # å½“ /tmp/tmp.txt å­˜åœ¨æ—¶ï¼Œæ‰“å° hello [root@ansible ~]# ansible localhost -a 'chdir=/etc creates=/tmp/tmp.txt echo hello' localhost | CHANGED | rc=0 \u003e\u003e hello # å½“ /tmp/tmp.txt å­˜åœ¨æ—¶ï¼Œæ‰“å° hellï¼Œè¿™é‡Œæ¡ä»¶ä¸æ»¡è¶³ï¼Œä»»åŠ¡ç›´æ¥è¢«è·³è¿‡ [root@ansible ~]# ansible localhost -a 'chdir=/etc removes=/tmp/tmp.txt echo hello' localhost | SUCCESS | rc=0 \u003e\u003e skipped, since /tmp/tmp.txt does not exist ä¸æ”¯æŒçš„é«˜çº§ç‰¹æ€§ï¼š\n# åˆ›å»º hello.txt, å‘½ä»¤æ‰§è¡ŒæˆåŠŸ [root@ansible ~]# ansible localhost -a 'chdir=/tmp echo hello \u003e hello.txt' localhost | CHANGED | rc=0 \u003e\u003e hello \u003e hello.txt # å®é™…ä¸Šæ–‡ä»¶å¹¶ä¸å­˜åœ¨ [root@ansible ~]# ansible localhost -a 'chdir=/tmp ll hello.txt' localhost | FAILED | rc=2 \u003e\u003e [Errno 2] No such file or directory [root@ansible ~]# ll /tmp/hello.txt ls: cannot access /tmp/hello.txt: No such file or directory # ä¸æ”¯æŒ \u0026\u0026 ; | ç­‰ç¬¦å·ï¼ˆå°½ç®¡æ‰§è¡Œä¸æŠ¥é”™ï¼‰ [root@ansible ~]# ansible localhost -a 'chdir=/tmp echo hello \u003e hello.txt \u0026\u0026 echo world' localhost | CHANGED | rc=0 \u003e\u003e hello \u003e hello.txt \u0026\u0026 echo world [root@ansible ~]# ansible localhost -a 'chdir=/tmp echo hello \u003e hello.txt ; echo world' localhost | CHANGED | rc=0 \u003e\u003e hello \u003e hello.txt ; echo world [root@ansible ~]# ansible localhost -m command -a \"echo test | passwd --stdin pass\" localhost | CHANGED | rc=0 \u003e\u003e test | passwd --stdin pass 2.4.2 shell æ¨¡å— æ­¤æ¨¡å—åŠŸèƒ½ä¸ command å‡ ä¹ä¸€è‡´ï¼Œä½†æ˜¯åŠŸèƒ½ä¼šæ›´å¼ºã€‚Command æ¨¡å—ä¸æ”¯æŒçš„é‡å®šå‘ï¼Œç®¡é“ç¬¦ç­‰è¿ç®—ç¬¦åœ¨ Shell æ¨¡å—ä¸­éƒ½æ˜¯æ”¯æŒçš„ï¼ˆå°½ç®¡å¦‚æ­¤ï¼Œå®é™…ä½¿ç”¨æ—¶å°½é‡é¿å…ä½¿ç”¨è¿‡äºå¤æ‚æˆ–ç‰¹æ®Šçš„ç¬¦å·ï¼‰ï¼Œé™¤éæœ‰ä½¿ç”¨é«˜çº§ç‰¹æ€§çš„éœ€æ±‚ï¼Œå¦åˆ™å®˜æ–¹æ›´æ¨èä½¿ç”¨ command æ¨¡å—ï¼ˆæ›´åŠ å®‰å…¨å’Œç¨³å®šï¼‰ã€‚\næ­¤æ¨¡å—ä¸å…·å¤‡å¹‚ç­‰æ€§\nå¸¸è§é€‰é¡¹\nchdir=DIR\t# åˆ‡æ¢ç›®å½• creates=FILE\t# å½“ FILE ä¸å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œæ“ä½œ removes=FILE\t# å½“ FILE å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œæ“ä½œ èŒƒä¾‹ï¼š\n# æ‰“å°å˜é‡ [root@ansible ~]# ansible localhost -m shell -a \"echo $HOSTNAME\" localhost | CHANGED | rc=0 \u003e\u003e localhost.localdomain # ä¿®æ”¹è´¦å·å¯†ç  [root@ansible ~]# ansible localhost -m shell -a \"echo pass | passwd --stdin test\" localhost | CHANGED | rc=0 \u003e\u003e Changing password for user test. passwd: all authentication tokens updated successfully. # ä½¿ç”¨é‡å®šå‘ç”Ÿæˆæ–‡ä»¶ï¼Œå¹¶è¾“å‡ºå†…å®¹ [root@ansible ~]# ansible localhost -m shell -a \"echo hello \u003e /tmp/hello.txt \u0026\u0026 ls /tmp/hello.txt \u0026\u0026 cat /tmp/hello.txt\" localhost | CHANGED | rc=0 \u003e\u003e /tmp/hello.txt hello æ³¨æ„ï¼šç±»ä¼¼ cat /tmp/test.md | awk -Fâ€™|â€™ â€˜{print $1,$2}â€™ \u0026\u003e /tmp/example.txt çš„å¤æ‚å‘½ä»¤ï¼Œå³ä½¿ä½¿ç”¨Shellæ¨¡å—ä¹Ÿå¯èƒ½ä¼šå¤±è´¥ã€‚å¯ä»¥è€ƒè™‘å°†å‘½ä»¤å†™æˆ shell è„šæœ¬ï¼Œå†é€šè¿‡ Script æ¨¡å—è¿›è¡Œè°ƒç”¨\nAnsible å‘½ä»¤æ‰€ä½¿ç”¨çš„é»˜è®¤æ¨¡å—æ˜¯ commandï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®é¡¹é‡æ–°æŒ‡å®šä¸ºåˆ«çš„æ¨¡å—ï¼š\n[root@ansible ~]# grep module_name /etc/ansible/ansible.cfg #module_name = command 2.4.3 script æ¨¡å— æ­¤æ¨¡å—å¯ä»¥åœ¨è¿œç¨‹ä¸»æœºæ‰§è¡Œ Ansible ä¸»æœºä¸Šçš„è„šæœ¬ï¼ˆè„šæœ¬ä¸éœ€è¦æ‰§è¡Œæƒé™ï¼‰\næ­¤æ¨¡å—ä¸å…·å¤‡å¹‚ç­‰æ€§\nå¸¸è§é€‰é¡¹\nchdir=DIR\t# åˆ‡æ¢ç›®å½• creates=FILE\t# å½“ FILE ä¸å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œæ“ä½œ removes=FILE\t# å½“ FILE å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œæ“ä½œ\tèŒƒä¾‹ï¼š\n# å‡†å¤‡ä¸€ä¸ªè„šæœ¬æ–‡ä»¶ [root@ansible ~]# cat test.sh echo hello # è¯¥æ–‡ä»¶æ— æ‰§è¡Œæƒé™ [root@ansible ~]# ll test.sh -rw-r--r--. 1 root root 11 Jun 20 15:44 test.sh # é€šè¿‡ scriptæ¨¡å— åœ¨ç›®æ ‡ä¸»æœºæ‰§è¡Œè¯¥è„šæœ¬ [root@ansible ~]# ansible remote -m script -a 'test.sh' remote | CHANGED =\u003e { \"changed\": true, \"rc\": 0, \"stderr\": \"Shared connection to 192.168.0.134 closed.\\r\\n\", \"stderr_lines\": [ \"Shared connection to 192.168.0.134 closed.\" ], \"stdout\": \"hello\\r\\n\", \"stdout_lines\": [ \"hello\" ] } 2.4.4 copy æ¨¡å— æ­¤æ¨¡å—ç”¨äºæ–‡ä»¶æ‹·è´ï¼Œæœ‰ä¸¤ç§ç”¨æ³•ï¼š\nå°† ansible ä¸»æœºä¸Šçš„æ–‡ä»¶æ‹·è´åˆ°å—æ§èŠ‚ç‚¹ å°†å—æ§èŠ‚ç‚¹çš„æ–‡ä»¶æ‹·è´åˆ°å—æ§èŠ‚ç‚¹çš„å…¶ä»–è·¯å¾„ å¸¸è§é€‰é¡¹\nsrc # æ§åˆ¶ç«¯çš„æºæ–‡ä»¶è·¯å¾„ dest # è¢«æ§ç«¯çš„æ–‡ä»¶è·¯å¾„ owner # å±ä¸» group # å±ç»„ mode # æƒé™ backup # æ˜¯å¦å¤‡ä»½ validate # éªŒè¯æˆåŠŸæ‰ä¼šæ‰§è¡Œcopy remote_src # no æ˜¯é»˜è®¤å€¼, è¡¨ç¤º src æ–‡ä»¶åœ¨ ansible ä¸»æœº, yesè¡¨ç¤º src æ–‡ä»¶åœ¨è¿œç¨‹ä¸»æœº èŒƒä¾‹ï¼š\n# åˆ›å»ºlocal.txt å¹¶å°†å…¶æ‹·è´åˆ° remote ä¸»æœºä¸Š [root@ansible ~]# touch local.txt [root@ansible ~]# ansible remote -m copy -a 'src=local.txt dest=/tmp/remote.txt owner=test mode=600' # æˆåŠŸæ‹·è´åˆ° remote ä¸»æœº [root@ansible ~]# ansible remote -a 'ls /tmp/remote.txt' remote | CHANGED | rc=0 \u003e\u003e /tmp/remote.txt # ä¿®æ”¹local.txt æ–‡ä»¶å†…å®¹ï¼Œå†æ¬¡æ‰§è¡Œæ‹·è´æ“ä½œ [root@ansible ~]# echo hello \u003e\u003e local.txt # å½“æ–‡ä»¶å†…å®¹å˜åŒ–ï¼Œä¸” backup=yes æ—¶ï¼Œä¼šåœ¨æ‹·è´æ“ä½œæ‰§è¡Œå‰ï¼Œåœ¨ç›®æ ‡ä¸»æœºç”Ÿæˆä¸€ä¸ªä»¥æ—¶é—´æˆ³ä¸ºåç¼€çš„å¤‡ä»½æ–‡ä»¶ï¼Œå¦‚ï¼šremote.txt.9235.2023-06-20@16:52:58~ [root@ansible ~]# ansible remote -a \"ls /tmp\" remote | CHANGED | rc=0 \u003e\u003e ansible_command_payload_QQiJzZ remote.txt remote.txt.9235.2023-06-20@16:52:58~ # æ‹·è´ remote ä¸»æœºçš„æ–‡ä»¶åˆ°æŒ‡å®šè·¯å¾„ï¼Œremote_src è¡¨ç¤ºæºæ–‡ä»¶åœ¨ç›®æ ‡ä¸»æœºä¸Š [root@ansible ~]# ansible remote -m copy -a \"src=/tmp/remote.txt dest=/tmp/local.txt owner=test mode=600 remote_src=yes\" # æˆåŠŸåœ¨ remote ä¸»æœºçš„ /tmp ç›®å½•ä¸‹ å¤åˆ¶äº†ä¸€ä¸ª local.txt æ–‡ä»¶ [root@ansible ~]# ansible remote -a \"ls /tmp/local.txt\" remote | CHANGED | rc=0 \u003e\u003e /tmp/local.txt # ç›´æ¥æŒ‡å®šæ–‡ä»¶å†…å®¹ï¼Œç”Ÿæˆæ–‡ä»¶ [root@ansible ~]# ansible remote -m copy -a 'content=\"hello\\nworld\\n\" dest=/tmp/hello.txt' [root@ansible ~]# ansible remote -a 'cat /tmp/hello.txt' remote | CHANGED | rc=0 \u003e\u003e hello world #### æ‹·è´æ•´ä¸ªæ–‡ä»¶å¤¹ /tmp åˆ° remote ä¸»æœºã€‚æ³¨æ„ï¼šæ˜¯ /tmp è€Œé /tmp/ [root@ansible ~]# ansible remote -m copy -a 'src=/tmp dest=/tmp/' [root@ansible ~]# ansible remote -a 'ls -d /tmp/tmp' remote | CHANGED | rc=0 \u003e\u003e /tmp/tmp ### æ‹·è´/tmp æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶åˆ°ç›®æ ‡ä¸»æœº # æå‰åœ¨ç›®æ ‡ä¸»æœºæ–°å»ºä¸€ä¸ªç©ºæ–‡ä»¶å¤¹ç”¨äºå­˜æ”¾ /tmp ç›®å½•ä¸‹çš„æ–‡ä»¶ [root@remote ~]# ls -d /test/ /test/ # åœ¨ /tmp æ–‡ä»¶å¤¹ä¸‹æœ‰ä¸€ä¸ª test.txt æ–‡ä»¶ [root@ansible ~]# ls /tmp/test.txt /tmp/test.txt # æ‰§è¡Œæ‹·è´æ“ä½œï¼Œè§‚å¯Ÿåˆ°æˆåŠŸæ‹·è´ /tmp æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶åˆ°ç›®æ ‡ä¸»æœº [root@ansible ~]# ansible remote -m copy -a 'src=/tmp/ dest=/test' [root@ansible ~]# ansible remote -a 'ls /test' remote | CHANGED | rc=0 \u003e\u003e test.txt # å¤åˆ¶æ–‡ä»¶å¹¶æ‰§è¡Œæ ¡éªŒå‘½ä»¤ï¼Œæ³¨æ„ï¼š%s æ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œå°†åœ¨å‘½ä»¤æ‰§è¡Œæ—¶è¢«æ›¿æ¢ä¸ºæºæ–‡ä»¶çš„è·¯å¾„ã€‚ [root@ansible ~]# ansible remote -m copy -a \"src=/etc/sudoers dest=/etc/sudoers.bak remote_src=yes validate='/usr/sbin/visudo -csf %s'\" 2.4.5 get_url æ¨¡å— æ­¤æ¨¡å—ä½¿ç”¨ httpã€https æˆ– ftp åè®®ä¸‹è½½æ–‡ä»¶\nå¸¸ç”¨å‚æ•°ï¼š\nurl # ä¸‹è½½æ–‡ä»¶çš„URL,æ”¯æŒ HTTPï¼ŒHTTPS æˆ– FTP åè®® dest # ä¸‹è½½åˆ°ç›®æ ‡è·¯å¾„ï¼ˆç»å¯¹è·¯å¾„ï¼‰ï¼Œå¦‚æœç›®æ ‡æ˜¯ä¸€ä¸ªç›®å½•ï¼Œå°±ç”¨åŸæ–‡ä»¶åï¼Œå¦‚æœç›®æ ‡è®¾ç½®äº†åç§°å°±ç”¨ç›®æ ‡è®¾ç½®çš„åç§° owner # æŒ‡å®šå±ä¸» group # æŒ‡å®šå±ç»„ mode # æŒ‡å®šæƒé™ force # å¦‚æœ yesï¼Œdest ä¸æ˜¯ç›®å½•ï¼Œå°†æ¯æ¬¡ä¸‹è½½æ–‡ä»¶ï¼Œå¦‚æœå†…å®¹æ”¹å˜æ›¿æ¢æ–‡ä»¶ã€‚å¦‚æœ noï¼Œåˆ™åªæœ‰åœ¨ç›®æ ‡ä¸å­˜åœ¨æ—¶æ‰ä¼šä¸‹è½½ï¼Œé»˜è®¤ï¼šno checksum # å¯¹ç›®æ ‡æ–‡ä»¶åœ¨ä¸‹è½½åè®¡ç®—æ‘˜è¦ï¼Œä»¥ç¡®ä¿å…¶å®Œæ•´æ€§ # ç¤ºä¾‹: # checksum=\"sha256:D98291AC[...]B6DC7B97\", # checksum=\"sha256:http://example.com/path/sha256sum.txt\" url_username # ç”¨äºHTTPåŸºæœ¬è®¤è¯çš„ç”¨æˆ·åã€‚ å¯¹äºå…è®¸ç©ºå¯†ç çš„ç«™ç‚¹ï¼Œæ­¤å‚æ•°å¯ä»¥ä¸ä½¿ç”¨ `url_password' url_password # ç”¨äºHTTPåŸºæœ¬è®¤è¯çš„å¯†ç ã€‚ å¦‚æœæœªæŒ‡å®š`url_username'å‚æ•°ï¼Œåˆ™ä¸ç”Ÿæ•ˆ `url_password'å‚æ•° validate_certs # å¦‚æœâ€œnoâ€ï¼ŒSSLè¯ä¹¦å°†ä¸ä¼šè¢«éªŒè¯ã€‚ é€‚ç”¨äºè‡ªç­¾åè¯ä¹¦åœ¨ç§æœ‰ç½‘ç«™ä¸Šä½¿ç”¨ timeout # URLè¯·æ±‚çš„è¶…æ—¶æ—¶é—´,ç§’ä¸ºå•ä½ èŒƒä¾‹ï¼š\n# ä¸‹è½½ nginx è‡³ remote ä¸»æœºï¼Œå¹¶æ ¡éªŒ md5 å€¼ [root@ansible ~]# ansible remote -m get_url -a 'url=http://nginx.org/download/nginx-1.18.0.tar.gz dest=/usr/local/src checksum=\"md5:b2d33d24d89b8b1f87ff5d251aa27eb8\"' # ä¸‹è½½æˆåŠŸ [root@ansible ~]# ansible remote -a 'ls /usr/local/src/' remote | CHANGED | rc=0 \u003e\u003e nginx-1.18.0.tar.gz 2.4.6 fetch æ¨¡å— æ­¤æ¨¡å—å¯ä»¥å°†å—æ§èŠ‚ç‚¹çš„æ–‡ä»¶æ‹‰å–è‡³ ansible ä¸»æ§ç«¯ï¼Œå’Œ copy æ¨¡å—åŠŸèƒ½ç›¸åï¼Œç›®å‰ä¸æ”¯æŒæ‹‰å–ç›®å½•\nå¸¸è§é€‰é¡¹\nsrc # å—æ§èŠ‚ç‚¹æºæ–‡ä»¶è·¯å¾„ dest # ansible ä¸»æ§ç«¯ç›®å½•è·¯å¾„ èŒƒä¾‹ï¼š\n# å¦‚æœåŒæ—¶æ‹‰å–å¤šå°ä¸»æœºçš„åŒä¸€æ–‡ä»¶ï¼Œansible ä¼šä¸ºæ¯å°ä¸»æœºå»ºç«‹å•ç‹¬çš„æ–‡ä»¶å¤¹æ¥å­˜æ”¾æ‹‰å–çš„æ–‡ä»¶ [root@ansible ~]# ansible all --list-hosts hosts (2): remote remote2 # å°†è¿œç¨‹ä¸»æœºçš„redhat-release æ–‡ä»¶æ‹‰å–è‡³ ansible ä¸»æœºçš„ /tmp/osç›®å½•ä¸‹ï¼ˆç›®å½•ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰ [root@ansible ~]# ansible all -m fetch -a 'src=/etc/redhat-release dest=/tmp/os/' [root@ansible ~]# tree /tmp/os/ /tmp/os/ â”œâ”€â”€ remote â”‚ â””â”€â”€ etc â”‚ â””â”€â”€ redhat-release â””â”€â”€ remote2 â””â”€â”€ etc â””â”€â”€ redhat-release 4 directories, 2 files 2.4.7 file æ¨¡å— æ­¤æ¨¡å—ç”¨äºåˆ›å»ºï¼Œåˆ é™¤æ–‡ä»¶ï¼Œç›®å½•å’Œè½¯è¿æ¥ä»¥åŠä¿®æ”¹ç›¸å…³å±æ€§\nå¸¸è§é€‰é¡¹\npath # åœ¨è¢«æ§ç«¯åˆ›å»ºçš„è·¯å¾„ owner # å±ä¸» group # å±ç»„ mode # æƒé™ state # çŠ¶æ€ =touch # åˆ›å»ºæ–‡ä»¶ =directory # åˆ›å»ºç›®å½• =link # è½¯é“¾æ¥ =hard # ç¡¬é“¾æ¥ recurse # yes è¡¨ç¤ºé€’å½’æˆæƒ èŒƒä¾‹ï¼š\n# åˆ›å»ºæ–‡ä»¶å¹¶ä¿®æ”¹å±ä¸» [root@ansible ~]# ansible remote -m file -a 'path=/tmp/file.txt state=touch owner=test mode=755' # åˆ é™¤æ–‡ä»¶ [root@ansible ~]# ansible remote -m file -a 'path=/tmp/file.txt state=absent' # åˆ›å»ºè½¯è¿æ¥ï¼Œå…¶ä¸­ dest è¿˜å¯ä»¥æ›¿æ¢ä¸º[ path | name ] [root@ansible ~]# ansible remote -m file -a 'src=/etc/redhat-release dest=/tmp/release-link state=link' [root@ansible ~]# ansible remote -a 'cat /tmp/release-link' remote | CHANGED | rc=0 \u003e\u003e CentOS Linux release 7.6.1810 (Core) # åˆ›å»ºç›®å½• [root@ansible ~]# ansible remote -m file -a 'path=/tmp/dir state=directory' # é€’å½’ä¿®æ”¹æ–‡ä»¶å±æ€§ [root@ansible ~]# ansible remote -m file -a 'path=/tmp owner=test group=test recurse=yes' 2.4.8 stat æ¨¡å— æ­¤æ¨¡å—ç”¨äºæ£€æŸ¥æ–‡ä»¶æˆ–æ–‡ä»¶ç³»ç»ŸçŠ¶æ€\nansible.builtin.stat module â€“ Retrieve file or file system status â€” Ansible Documentation\nå¸¸è§é€‰é¡¹\npath # æ–‡ä»¶æˆ–å¯¹è±¡çš„å®Œæ•´è·¯å¾„ï¼ˆå¿…é¡»ï¼‰ å¸¸è§è¿”å›å€¼ï¼š\nattributesï¼š# è¿”å›æŒ‡å®šæ–‡ä»¶çš„å±æ€§ã€‚ executableï¼š# å¦‚æœè°ƒç”¨çš„ç”¨æˆ·åœ¨ç›®æ ‡è·¯å¾„ä¸Šæœ‰æ‰§è¡Œæƒé™ï¼Œåˆ™è¿”å› trueã€‚ existsï¼š\t# å¦‚æœæŒ‡å®šçš„è·¯å¾„å­˜åœ¨ï¼Œè¿”å›çœŸã€‚ gr_nameï¼š# è¿”å›æ–‡ä»¶æ‰€æœ‰è€…çš„ç»„çš„åç§°ã€‚ islbkï¼š\t# å¦‚æœæŒ‡å®šçš„æ–‡ä»¶æ˜¯ä¸€ä¸ªå—çŠ¶è®¾å¤‡ï¼Œåˆ™è¿”å›trueã€‚ ischrï¼š # å¦‚æœæŒ‡å®šçš„æ–‡ä»¶æ˜¯ä¸€ä¸ªå­—ç¬¦æ–‡ä»¶ï¼Œåˆ™è¿”å›çœŸã€‚ isregï¼š\t# å¦‚æœæŒ‡å®šçš„æ–‡ä»¶æ˜¯ä¸€ä¸ªå¸¸è§„æ–‡ä»¶ï¼Œåˆ™è¿”å›çœŸã€‚ isdirï¼š\t# å¦‚æœæŒ‡å®šçš„æ–‡ä»¶æ˜¯ä¸€ä¸ªç›®å½•ï¼Œåˆ™è¿”å›çœŸã€‚ islnkï¼š\t# å¦‚æœç›®æ ‡æ–‡ä»¶æ˜¯ä¸€ä¸ªé“¾æ¥ï¼Œåˆ™è¿”å›çœŸã€‚ modeï¼š\t# ä»¥å…«è¿›åˆ¶ç¬¦å·è¿”å›æ–‡ä»¶æƒé™ã€‚ isuidï¼š # isuid è¡¨ç¤º \"is setuid\"ï¼Œç”¨äºåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å…·æœ‰è®¾ç½®ç”¨æˆ· ID (Set User IDï¼ŒSUID) æƒé™ã€‚ èŒƒä¾‹ï¼š\n[root@remote ~]# chmod a+s /etc/centos-release [root@remote ~]# ll /etc/centos-release -rwSr-Sr--. 1 root root 38 Nov 23 2018 /etc/centos-release [root@ansible ~]# ansible remote -m stat -a 'path=/etc/centos-release' remote | SUCCESS =\u003e { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python\" }, \"changed\": false, \"stat\": { \"atime\": 1687316675.220694, \"attr_flags\": \"\", \"attributes\": [], \"block_size\": 4096, \"blocks\": 8, \"charset\": \"us-ascii\", \"checksum\": \"dd9a53b0d396d3ab190cfbc08dca572d3e741a03\", \"ctime\": 1687316666.4736364, \"dev\": 64768, \"device_type\": 0, \"executable\": false, \"exists\": true, \"gid\": 0, \"gr_name\": \"root\", \"inode\": 67184137, \"isblk\": false, \"ischr\": false, \"isdir\": false, \"isfifo\": false, \"isgid\": true, \"islnk\": false, \"isreg\": true, \"issock\": false, \"isuid\": true, \"mimetype\": \"text/plain\", \"mode\": \"6644\", \"mtime\": 1542979018.0, \"nlink\": 1, \"path\": \"/etc/centos-release\", \"pw_name\": \"root\", \"readable\": true, \"rgrp\": true, \"roth\": true, \"rusr\": true, \"size\": 38, \"uid\": 0, \"version\": \"815093836\", \"wgrp\": false, \"woth\": false, \"writeable\": true, \"wusr\": true, \"xgrp\": false, \"xoth\": false, \"xusr\": false } } 2.4.9 unarchive æ¨¡å— æ­¤æ¨¡å—ç”¨äºè§£åŒ…å’Œè§£å‹ç¼©ï¼Œæœ‰ä¸¤ç§ç”¨æ³•ï¼š\nå°† ansible ä¸»æœºä¸Šçš„å‹ç¼©æ–‡ä»¶è§£å‹è‡³å—æ§èŠ‚ç‚¹çš„æŒ‡å®šè·¯å¾„ä¸‹ å°†é ansible çš„å…¶ä»–ä¸»æœºçš„å‹ç¼©æ–‡ä»¶è§£å‹åˆ°å—æ§èŠ‚ç‚¹çš„æŒ‡å®šè·¯å¾„ä¸‹ å¸¸è§å‚æ•°ï¼š\nremote_src # yes è¡¨ç¤ºæºæ–‡ä»¶åœ¨è¿œç¨‹è¢«æ§ä¸»æœºæˆ–é ansible çš„å…¶å®ƒä¸»æœºä¸Šï¼Œno è¡¨ç¤ºæ–‡ä»¶åœ¨ansibleä¸»æœºä¸Š, é»˜è®¤å€¼ä¸º no, æ­¤é€‰é¡¹ä»£æ›¿copyé€‰é¡¹ï¼ˆå·²åºŸå¼ƒï¼‰ src #æºè·¯å¾„ï¼Œå¯ä»¥æ˜¯ ansible ä¸»æœºä¸Šçš„è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯è¿œç¨‹ä¸»æœº(è¢«ç®¡ç†ç«¯æˆ–è€…ç¬¬ä¸‰æ–¹ä¸»æœº)ä¸Šçš„è·¯å¾„ï¼Œå¦‚æœæ˜¯è¿œç¨‹ä¸»æœºä¸Šçš„è·¯å¾„ï¼Œåˆ™éœ€è¦è®¾ç½® remote_src=yes dest # è¿œç¨‹ä¸»æœºä¸Šçš„ç›®æ ‡è·¯å¾„ mode # è®¾ç½®è§£å‹ç¼©åçš„æ–‡ä»¶æƒé™ creates=PATH # å½“PATHä¸å­˜åœ¨æ—¶æ‰ä¼šæ‰§è¡Œ èŒƒä¾‹ï¼š\n# è§£å‹æœ¬åœ°æ–‡ä»¶åˆ°å—æ§èŠ‚ç‚¹çš„æŒ‡å®šç›®å½•ï¼ˆç›®æ ‡ç›®å½•ä¸å­˜åœ¨ä¼šæŠ¥é”™ï¼Œä¸ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰ [root@ansible ~]# ansible remote -m unarchive -a 'src=/tmp/test.tar.gz dest=/tmp/' # è§£å‹å…¶ä»–ä¸»æœºçš„å‹ç¼©åŒ…åˆ°å—æ§èŠ‚ç‚¹ [root@ansible ~]# ansible remote -m unarchive -a 'src=https://releases.ansible.com/ansible/ansible-2.1.6.0-0.1.rc1.tar.gz dest=/tmp remote_src=yes' 2.4.10 archive æ¨¡å— æ­¤æ¨¡å—ç”¨äºåœ¨å—æ§èŠ‚ç‚¹æ‰“åŒ…å‹ç¼©æ–‡ä»¶\nå¸¸è§é€‰é¡¹\npath # å‹ç¼©çš„æ–‡ä»¶æˆ–ç›®å½• dest # å‹ç¼©åçš„æ–‡ä»¶ format # å‹ç¼©æ ¼å¼,æ”¯æŒgz,bz2,xz,tar,zip èŒƒä¾‹ï¼š\n[root@ansible tmp]# ansible remote -m archive -a 'path=/etc/redhat-release dest=/tmp/log.tar.gz format=gz' 2.4.11 hostname æ¨¡å— æ­¤æ¨¡å—ç”¨äºä¿®æ”¹ä¸»æœºå\nå¸¸è§é€‰é¡¹\nname # è¦ä¿®æ”¹çš„ç›®æ ‡ä¸»æœºå èŒƒä¾‹ï¼š\n[root@ansible ~]# ansible remote -m hostname -a 'name=test' 2.4.12 cron æ¨¡å— æ­¤æ¨¡å—ç”¨äºåˆ›å»ºè®¡åˆ’ä»»åŠ¡\nå¸¸è§é€‰é¡¹\nname # ä»»åŠ¡åç§°ï¼Œå¯ä»¥æ ¹æ®æ­¤åç§°åˆ é™¤å¯¹åº”çš„è®¡åˆ’ä»»åŠ¡ minute # åˆ†é’Ÿ hour # å°æ—¶ weekday # å‘¨ user\t# ä»»åŠ¡ç”±å“ªä¸ªç”¨æˆ·è¿è¡Œï¼›é»˜è®¤root job # ä»»åŠ¡ èŒƒä¾‹ï¼š\n# åˆ›å»ºä¸€ä¸ªè®¡åˆ’ä»»åŠ¡ï¼Œå‘½åä¸º test [root@ansible ~]# ansible remote -m cron -a 'minute=0 hour=2 weekday=1-5 job=\"echo test\" name=hello' # æŸ¥çœ‹åˆ›å»ºç»“æœ [root@ansible ~]# ansible remote -a 'crontab -l' remote | CHANGED | rc=0 \u003e\u003e #Ansible: hello 0 2 * * 1-5 echo test 2.4.13 yum å’Œ apt æ¨¡å— æ­¤æ¨¡å—ç”¨äºç®¡ç†è½¯ä»¶åŒ…\nyumï¼šé€‚ç”¨äºRHELï¼ŒCentoOSï¼ŒFedora ç­‰ç³»ç»Ÿ aptï¼šé€‚ç”¨äºDebianï¼ŒUbuntu ç­‰ç³»ç»Ÿ yum æ¨¡å—å¸¸è§é€‰é¡¹\nname # è½¯ä»¶åŒ…åç§° state # çŠ¶æ€ =present # å®‰è£…, æ­¤ä¸ºé»˜è®¤å€¼ =absent # åˆ é™¤ =latest # æœ€æ–°ç‰ˆ list # åˆ—å‡ºæŒ‡å®šåŒ… enablerepo # å¯ç”¨ä»“åº“xx disablerepo # ç¦ç”¨ä»“åº“xx exclude # æ’é™¤æŒ‡å®šçš„åŒ… validate # æ˜¯å¦æ£€éªŒ, é»˜è®¤ä¸º yes èŒƒä¾‹ï¼š\n# å®‰è£… httpd ansible remote -m yum -a 'name=httpd state=present' # åˆ é™¤ httpd ansible remote -m yum -a 'name=httpd state=absent' # ä»ç½‘ç»œæºå®‰è£… zabbix ï¼ˆç”±äºç¼ºå°‘å…¶ä»–ä¾èµ–åŒ…ï¼Œè¯¥å‘½ä»¤å¯èƒ½æ‰§è¡Œå¤±è´¥ï¼‰ ansible remote -m yum -a 'name=https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/8/x86_64/zabbix-agent2-5.0.24-1.el8.x86_64.rpm state=present validate_certs=no' # å¯ç”¨ epel æºå®‰è£… nginx ansible remote -m yum -a 'name=nginx state=present enablerepo=epel' # æ˜ç¡®ç¦ç”¨ epel æºä¼šå¯¼è‡´å®‰è£…å¤±è´¥ï¼ˆæ‰¾ä¸åˆ° nginx åŒ…ï¼‰ ansible remote -m yum -a 'name=nginx state=present disablerepo=epel' # å®‰è£…é™¤äº† kernel* å’Œ foo* åŒ¹é…åˆ°çš„å…¶ä½™æ‰€æœ‰åŒ…ï¼ˆæµ‹è¯•ä½¿ç”¨ï¼Œè°¨æ…æ‰§è¡Œï¼‰ ansible remote -m yum -a 'name=* state=latest exclude=kerner*,foo*' # åˆ—å‡ºæ‰€æœ‰ç‰ˆæœ¬çš„åŒ… ansible remote -m yum -a 'list=tree' 2.4.14 yum_repository æ­¤æ¨¡å—ç”¨äº yum ä»“åº“çš„é…ç½®ç®¡ç†\nå¸¸è§é€‰é¡¹\nname # ä»“åº“idï¼Œä¹Ÿæ˜¯é…ç½®æ–‡ä»¶å description # ä»“åº“æè¿°åç§°,å¯¹åº”é…ç½®æ–‡ä»¶ä¸­çš„name= baseurl # ä»“åº“çš„åœ°å€ gpgcheck # å¼€å¯å¯†é’¥éªŒè¯ gpgkey # ä»“åº“å…¬é’¥è·¯å¾„ èŒƒä¾‹ï¼š\n# æ·»åŠ  nginx ä»“åº“ [root@ansible ~]# ansible remote -m yum_repository -a 'name=nginx-repo description=\"nginx repo\" baseurl=\"http://nginx.org/packages/centos/$releasever/$basearch/\" gpgcheck=yes gpgkey=\"https://nginx.org/keys/nginx_signing.key\"' # æŸ¥çœ‹æ·»åŠ ç»“æœ [root@ansible ~]# ansible remote -a 'cat /etc/yum.repos.d/nginx-repo.repo' remote | CHANGED | rc=0 \u003e\u003e [nginx-repo] baseurl = http://nginx.org/packages/centos/$releasever/$basearch/ gpgcheck = 1 gpgkey = https://nginx.org/keys/nginx_signing.key name = nginx repo # åˆ é™¤ nginx ä»“åº“ [root@ansible ~]# ansible remote -m yum_repository -a 'name=nginx-repo state=absent' 2.4.15 service æ¨¡å— æ­¤æ¨¡å—å’Œ systemd çš„åŠŸèƒ½ç±»ä¼¼ï¼Œç”¨äºç®¡ç†ç³»ç»ŸæœåŠ¡\nå¸¸è§é€‰é¡¹\nname # æœåŠ¡åç§° state # æœåŠ¡çŠ¶æ€ =started # å¯åŠ¨ =stopped # åœæ­¢ =restarted # é‡å¯ =reloaded # é‡è½½ enabled # å¼€å¯è‡ªå¯åŠ¨ daemon_reload # åŠ è½½æ–°çš„é…ç½®æ–‡ä»¶,é€‚ç”¨äºsystemdæ¨¡å— èŒƒä¾‹ï¼š\n# å¯åŠ¨å¹¶è®¾ç½® httpd æœåŠ¡å¼€æœºè‡ªå¯åŠ¨ ansible remote -m service -a 'name=httpd state=started enabled=yes' # å…³é—­ httpd æœåŠ¡ï¼Œå¹¶å…³é—­å¼€æœºè‡ªå¯ ansible remote -m service -a 'name=httpd state=stopped enabled=no' # é‡å¯æŒ‡å®šç½‘å¡æœåŠ¡ ansible remote -m service -a 'name=network state=restarted args=ens33' 2.4.16 user æ¨¡å— æ­¤æ¨¡å—ç”¨äºç”¨æˆ·ç®¡ç†\nå¸¸ç”¨é€‰é¡¹\nname # åˆ›å»ºçš„åç§° uid # æŒ‡å®š uid group # æŒ‡å®šåŸºæœ¬ç»„ shell # ç™»å½• shell ç±»å‹é»˜è®¤ /bin/bash create_home # æ˜¯å¦åˆ›å»ºå®¶ç›®å½• password # è®¾å®šå¯¹åº”çš„å¯†ç ï¼Œå¿…é¡»æ˜¯åŠ å¯†åçš„å­—ç¬¦ä¸²æ‰è¡Œï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆ system # yes è¡¨ç¤ºç³»ç»Ÿç”¨æˆ· groups # é™„åŠ ç»„ append # è¿½åŠ é™„åŠ ç»„ä½¿ç”¨, yes è¡¨ç¤ºå¢åŠ æ–°çš„é™„åŠ ç»„ state # absent åˆ é™¤ remove # yes è¡¨ç¤ºåˆ é™¤ç”¨æˆ·æ—¶å°†å®¶ç›®å½•ä¸€èµ·åˆ é™¤ generate_ssh_key # åˆ›å»ºç§é’¥ ssh_keyu_bits # ç§é’¥ä½æ•° ssh_key_file # ç§é’¥æ–‡ä»¶è·¯å¾„ èŒƒä¾‹ï¼š\n# åˆ›å»ºç”¨æˆ·å¹¶æŒ‡å®šç›¸å…³å±æ€§ï¼ˆå®¶ç›®å½•ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰ ansible remote -m user -a 'name=test uid=1001 home=/app/test shell=/bin/sh' # åˆ›å»ºç³»ç»Ÿç”¨æˆ·ï¼ˆuid \u003c 1000ï¼‰ ansible remote -m user -a 'name=test1 home=/app/test1 shell=/bin/bash system=yes' # åˆ©ç”¨ debug æ¨¡å—ç”ŸæˆåŠ å¯†å¯†ç  [root@ansible ~]# ansible localhost -m debug -a 'msg={{ \"123456\" | password_hash(\"sha512\",\"salt\") }}' localhost | SUCCESS =\u003e { \"msg\": \"$6$salt$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w.igcOo1R7vBYR65JquIQ/7siC7VRpmteKvZmfSkNc69.\" } # åˆ›å»ºç”¨æˆ·å¹¶æŒ‡å®šå¯†ç ï¼ˆå¦‚æœç›´æ¥æŒ‡å®šæ˜æ–‡å¯†ç ï¼Œæ‰§è¡Œè™½ç„¶æˆåŠŸï¼Œä½†æ˜¯ç™»å½•æ—¶ä¼šæŠ¥å¯†ç é”™è¯¯ï¼‰ ansible remote -m user -a 'name=test2 shell=/bin/bash password=$6$salt$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w.igcOo1R7vBYR65JquIQ/7siC7VRpmteKvZmfSkNc69.' # åˆ›å»ºç”¨æˆ·å¹¶ç”Ÿæˆ 2048 bit çš„ç”¨æˆ·ç§é’¥ ansible remote -m user -a 'name=test3 generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=.ssh/id_rsa' 2.4.17 group æ¨¡å— æ­¤æ¨¡å—ç”¨äºç®¡ç†ç”¨æˆ·ç»„\nå¸¸è§é€‰é¡¹\nname # æŒ‡å®šç»„åç§° gid # æŒ‡å®šgid state =present # åˆ›å»º, é»˜è®¤ =absent # åˆ é™¤ èŒƒä¾‹ï¼š\n# åˆ›å»ºç³»ç»Ÿç”¨æˆ·ç»„ ansible remote -m group -a 'name=test system=yes' # åˆ é™¤ç»„ ansible remote -m group -a 'name=test state=absent' 2.4.18 lineinfile æ¨¡å—\næ­¤æ¨¡å—ç›¸å½“äº sed ï¼Œç”¨äºå¯¹æ–‡æœ¬è¿›è¡Œå•è¡Œæ›¿æ¢ã€‚ä¹‹æ‰€ä»¥ä¸ç”¨ sed ï¼Œæ˜¯å› ä¸º ansible å¯¹ç‰¹æ®Šç¬¦å·çš„æ”¯æŒä¸å¼ºï¼Œå®é™…æ“ä½œæ—¶å¯èƒ½æ— æ³•æ›¿æ¢ï¼Œä¸”éœ€è¦å¯¹ç¬¦å·è¿›è¡Œè½¬ä¹‰ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚\nå¸¸è§é€‰é¡¹\npath # è¢«æ§ç«¯æ–‡ä»¶çš„è·¯å¾„ regexp # æ­£åˆ™åŒ¹é…å­—ç¬¦ä¸² line # æ›¿æ¢çš„ç›®æ ‡å†…å®¹ state # absent è¡¨ç¤ºåˆ é™¤ insertafter # æ’å…¥åˆ°åŒ¹é…è¡Œå‰ insertbefore # æ’å…¥åˆ°åŒ¹é…è¡Œå backrefs # æ˜¯å¦æ”¯æŒåå‘å¼•ç”¨ backup # ä¿®æ”¹å‰å…ˆå¤‡ä»½ create # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨, åˆ™åˆ›å»º, é»˜è®¤ä¸å­˜åœ¨ä¼šå‡ºé”™ mode # æŒ‡å®šæƒé™ owner # æŒ‡å®šç”¨æˆ· group # æŒ‡å®šç»„ # æ³¨æ„ # regexpå‚æ•°ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å¯¹åº”çš„è¡Œï¼Œå½“æ›¿æ¢æ–‡æœ¬æ—¶ï¼Œå¦‚æœåŒ¹é…åˆ°äº†å¤šè¡Œï¼Œåªæœ‰æœ€åä¸€ä¸ªåŒ¹é…è¡Œä¼šè¢«æ›¿æ¢ã€‚å½“åˆ é™¤æ–‡æœ¬æ—¶ï¼Œæ‰€æœ‰åŒ¹é…åˆ°çš„è¡Œéƒ½ä¼šè¢«åˆ é™¤ã€‚ èŒƒä¾‹ï¼š\n# ä¿®æ”¹ httpd æœåŠ¡çš„ç›‘å¬ç«¯å£ ansible remote -m lineinfile -a 'path=/etc/httpd/conf/httpd.conf regexp=\"^Listen\" line=\"Listen 8080\"' # ç¦ç”¨ selinux ansible remote -m lineinfile -a 'path=/etc/selinux/config regexp=\"^SELINUX=\" line=\"SELINUX=disabled\"' # æ·»åŠ ç½‘å…³ ansible remote -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=\"GATEWAY=10.0.0.254\"' # åœ¨æœ€åä¸€è¡Œæ·»åŠ ç½‘å…³é…ç½® ansible remote -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=\"GATEWAY=10.0.0.254\"' # éªŒè¯æ·»åŠ ç»“æœ [root@ansible ~]# ansible remote -a 'tail -n1 /etc/sysconfig/network-scripts/ifcfg-ens33' remote | CHANGED | rc=0 \u003e\u003e GATEWAY=10.0.0.254 # åˆ é™¤æ·»åŠ çš„ç½‘å…³é…ç½® ansible remote -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=\"GATEWAY=10.0.0.254\" state=absent' # æ·»åŠ ä¸€ä¸ªç½‘å…³ï¼Œåœ¨ \"NAME=\" è¯¥è¡Œå‰æ·»åŠ  ansible remote -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=\"GATEWAY=10.0.0.254\" insertbefore=\"^NAME=\"' # æŸ¥çœ‹æ·»åŠ ç»“æœ [root@ansible ~]# ansible remote -a 'grep -i gateway /etc/sysconfig/network-scripts/ifcfg-ens33 -A 1' remote | CHANGED | rc=0 \u003e\u003e GATEWAY=10.0.0.254 NAME=\"ens33\" 2.4.18 lineinfile æ¨¡å— æ­¤æ¨¡å—ä¸»è¦ç”¨äºåŸºäºæ­£åˆ™çš„å•è¡Œæ–‡æœ¬åŒ¹é…å’Œæ›¿æ¢\nansible å¯¹ç‰¹æ®Šç¬¦å·çš„æ”¯æŒä¸æ˜¯å¾ˆå¥½ï¼Œå¦‚æœç”¨ sed è¿›è¡Œå¤æ‚å­—ç¬¦æ›¿æ¢å¾ˆå¯èƒ½å‡ºç°é—®é¢˜ï¼Œå› æ­¤åœ¨è¿›è¡Œæ–‡æœ¬æ›¿æ¢æ—¶ï¼Œæœ€å¥½ç”¨è¯¥æ¨¡å—è€Œésed\nå¸¸è§é€‰é¡¹\npath #è¢«æ§ç«¯æ–‡ä»¶çš„è·¯å¾„ regexp #æ­£åˆ™åŒ¹é…è¯­æ³•æ ¼å¼,è¡¨ç¤ºè¢«æ›¿æ¢çš„å†…å®¹ line #æ›¿æ¢ä¸ºçš„å†…å®¹ state #absentè¡¨ç¤ºåˆ é™¤ insertafter #æ’å…¥åŒ¹é…è¡Œå insertbefore #æ’å…¥åŒ¹é…è¡Œå‰ backrefs #æ”¯æŒåå‘å¼•ç”¨, yes å’Œ no backup #ä¿®æ”¹å‰å…ˆå¤‡ä»½ create #å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨, åˆ™åˆ›å»º, é»˜è®¤ä¸å­˜åœ¨ä¼šå‡ºé”™ mode #æŒ‡å®šæƒé™ owner #æŒ‡å®šç”¨æˆ· group #æŒ‡å®šç»„ #æ³¨æ„ regexp å‚æ•°ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å¯¹åº”çš„è¡Œï¼Œæœ‰ä¸¤ç§å¤„ç†æ–¹å¼ å½“æ›¿æ¢æ–‡æœ¬æ—¶ï¼Œå¦‚æœæœ‰å¤šä¸ªåŒ¹é…è¡Œï¼Œåˆ™åªä¼šå¯¹æœ€åä¸€è¡Œè¿›è¡Œæ›¿æ¢ å½“åˆ é™¤æ–‡æœ¬æ—¶ï¼Œå¦‚æœæœ‰å¤šè¡Œæ–‡æœ¬éƒ½èƒ½è¢«åŒ¹é…ï¼Œè¿™ä¹ˆè¿™äº›è¡Œéƒ½ä¼šè¢«åˆ é™¤ã€‚ èŒƒä¾‹ï¼š\n# å…³é—­ selinux ansible remote -m lineinfile -a \"path=/etc/selinux/config regexp='^SELINUX=' line='SELINUX=disabled'\" # æ·»åŠ  DNS é…ç½®ï¼ˆæœ€åä¸€è¡Œï¼‰ ansible remote -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=\"DNS1=8.8.8.8\"' # æ·»åŠ  DNS é…ç½®ï¼ˆåŒ¹é…è¡Œä¸‹æ·»åŠ ï¼‰ ansible remote -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-ens33 insertafter=\"^NAME\" line=\"DNS1=8.8.8.8\"' # åˆ é™¤ä¸€è¡Œ ansible remote -m lineinfile -a 'path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=\"DNS1=8.8.8.8\" state=\"absent\"' # åˆ é™¤æ³¨é‡Šè¡Œ ansible remote -m lineinfile -a 'dest=/etc/fstab state=absent regexp=\"^#\"' ### å¤šè¡Œç›¸åŒæ–‡æœ¬ï¼Œåªæ›¿æ¢æœ€åä¸€è¡Œ [root@ansible ~]# ansible remote -a 'cat /root/test.txt' remote | CHANGED | rc=0 \u003e\u003e a a a [root@ansible ~]# ansible remote -m lineinfile -a \"path=/root/test.txt regexp='a' line='b'\" remote | CHANGED =\u003e { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python\" }, \"backup\": \"\", \"changed\": true, \"msg\": \"line replaced\" } [root@ansible ~]# ansible remote -a 'cat /root/test.txt' remote | CHANGED | rc=0 \u003e\u003e a a b 2.4.19 replace æ¨¡å— è¯¥æ¨¡å—ä¸ sed ç±»ä¼¼ï¼Œä¸»è¦ç”¨äºåŸºäºæ­£åˆ™çš„å¤šè¡Œæ–‡æœ¬åŒ¹é…å’Œæ›¿æ¢\nå¸¸è§é€‰é¡¹\npath # è¢«æ§ç«¯æ–‡ä»¶çš„è·¯å¾„ regexp # æ­£åˆ™åŒ¹é…è¯­æ³•æ ¼å¼ replace # ç›®æ ‡æ›¿æ¢å†…å®¹ after # æ’å…¥åŒ¹é…è¡Œå before # æ’å…¥åŒ¹é…è¡Œå‰ backup # ä¿®æ”¹å‰å…ˆå¤‡ä»½ mode # æŒ‡å®šæƒé™ owner # æŒ‡å®šç”¨æˆ· group # æŒ‡å®šç»„ èŒƒä¾‹ï¼š\nansible remote -m replace -a \"path=/etc/fstab regexp='^(UUID.*)' replace='#\\1'\" ansible remote -m replace -a \"path=/etc/fstab regexp='^#(UUID.*)' replace='\\1'\" ### å¤šè¡ŒåŒ¹é…æ›¿æ¢ [root@ansible ~]# ansible remote -a 'cat /root/test.txt' remote | CHANGED | rc=0 \u003e\u003e b b b [root@ansible ~]# ansible remote -m replace -a \"path=/root/test.txt regexp='b' replace='a'\" remote | CHANGED =\u003e { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python\" }, \"changed\": true, \"msg\": \"2 replacements made\" } [root@ansible ~]# ansible remote -a 'cat /root/test.txt' remote | CHANGED | rc=0 \u003e\u003e a a a 2.4.20 selinux æ¨¡å— è¯¥æ¨¡å—ç”¨æ¥ç®¡ç† selinux ç­–ç•¥ã€‚æ ¹æ®å›½å†…ä½¿ç”¨ä¹ æƒ¯ï¼Œè¿™é‡Œä¸»è¦æ¼”ç¤ºå¦‚ä½•å…³é—­ selinux\nå¸¸è§é€‰é¡¹\npolicy # æŒ‡å®šSELINUXTYPE=targeted state # æŒ‡å®šSELINUX=disabled èŒƒä¾‹ï¼š\n[root@ansible ~]# ansible remote -m selinux -a 'state=disabled' [WARNING]: SELinux state temporarily changed from 'enforcing' to 'permissive'. State change will take effect next reboot. remote | CHANGED =\u003e { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python\" }, \"changed\": true, \"configfile\": \"/etc/selinux/config\", \"msg\": \"\", \"policy\": \"targeted\", \"reboot_required\": true, \"state\": \"disabled\" } [root@ansible ~]# ansible remote -a \"grep -v '#' /etc/selinux/config\" remote | CHANGED | rc=0 \u003e\u003e SELINUX=disabled SELINUXTYPE=targeted [root@ansible ~]# ansible remote -a \"getenforce\" remote | CHANGED | rc=0 \u003e\u003e Permissive 2.4.21 reboot æ¨¡å— ç”¨äºé‡å¯ç›®æ ‡æœºå™¨\nå¸¸è§é€‰é¡¹\nmsg # é‡å¯æç¤ºå†…å®¹ pre_reboot_delay # é‡å¯å‰çš„å»¶è¿Ÿæ—¶é—´ï¼Œå•ä½ï¼šs post_reboot_delay # é‡å¯åç»è¿‡å¤šå°‘æ—¶é—´å†éªŒè¯ç³»ç»ŸåŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼Œå•ä½ï¼šs reboot_timeout #é‡å¯åå»¶è¿Ÿæ—¶é—´å†æ‰§è¡Œæµ‹è¯•æˆåŠŸä¸å¦çš„å‘½ä»¤ test_command #æ‰§è¡Œæµ‹è¯•æˆåŠŸä¸å¦çš„å‘½ä»¤ èŒƒä¾‹ï¼šé‡å¯ç³»ç»Ÿï¼Œä¼šé˜»å¡ç­‰å¾…é‡å¯å®Œæˆæ‰ä¼šè¿”å›æ‰§è¡Œç»“æœ\n[root@ansible ~]# ansible remote -m reboot -a \"msg='host will be reboot'\" remote | CHANGED =\u003e { \"changed\": true, \"elapsed\": 17, \"rebooted\": true } 2.4.22 mount æ¨¡å— ç”¨äºæ–‡ä»¶ç³»ç»Ÿçš„ç®¡ç†\nå¸¸è§é€‰é¡¹\nsrc #æºè®¾å¤‡è·¯å¾„ï¼Œæˆ–ç½‘ç»œåœ°å€ path #æŒ‚è½½è‡³æœ¬åœ°å“ªä¸ªè·¯å¾„ä¸‹ fstype #è®¾å¤‡ç±»å‹ opts #æŒ‚è½½çš„é€‰é¡¹ state #æŒ‚è½½è¿˜æ˜¯å¸è½½ =present #æ°¸ä¹…æŒ‚è½½ï¼Œä½†æ²¡æœ‰ç«‹å³ç”Ÿæ•ˆ =absent #å¸è½½ä¸´æ—¶æŒ‚è½½,å¹¶åˆ é™¤æ°¸ä¹…æŒ‚è½½ =mounted #ä¸´æ—¶æŒ‚è½½ =unmounted #ä¸´æ—¶å¸è½½ èŒƒä¾‹ï¼š\n# æ°¸ä¹…å¸è½½ [root@ansible ~]# ansible remote -m mount -a 'src=/dev/sdb path=/app state=absent' # æ°¸ä¹…æŒ‚è½½ï¼Œä¸ä¼šç«‹å³ç”Ÿæ•ˆï¼Œä»…ä¿®æ”¹/etc/fstab æ–‡ä»¶ [root@ansible ~]# ansible remote -m mount -a 'src=/dev/sdb path=/app state=absent' fstype=xfs opts=noatime path=swap state=present' # ä¸´æ—¶æŒ‚è½½ [root@ansible ~]# ansible remote -m mount -a 'src=/dev/sdb path=/app fstype=xfs opts=default state=mounted' # ä¸´æ—¶å¸è½½ [root@ansible ~]# ansible remote -m mount -a 'src=/dev/sdb path=/app fstype=xfs opts=default state=unmounted' opts=noatimeï¼šoptsæ˜¯ä¼ é€’ç»™mountå‘½ä»¤çš„é¢å¤–é€‰é¡¹ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯noatimeï¼Œè¡¨ç¤ºåœ¨è¯»å–æ–‡ä»¶æ—¶ï¼Œä¸æ›´æ–°æ–‡ä»¶çš„æœ€åè®¿é—®æ—¶é—´ã€‚è¿™å¯ä»¥æé«˜æ–‡ä»¶ç³»ç»Ÿçš„æ€§èƒ½ã€‚é»˜è®¤æ˜¯ default\n2.4.23 setup æ¨¡å— è¯¥æ¨¡å—ç”¨äºæ”¶é›†ç›®æ ‡ä¸»æœºçš„ç³»ç»Ÿä¿¡æ¯ï¼Œåœ¨ä½¿ç”¨ ansible æ—¶ï¼Œæ˜¯é»˜è®¤å¯ç”¨çš„ã€‚è¯¥æ¨¡å—æ”¶é›†åˆ°çš„ä¿¡æ¯å¯ä»¥é€šè¿‡å˜é‡å¼•ç”¨ï¼Œä½†æ˜¯é€šå¸¸æƒ…å†µä¸‹ï¼Œå®ƒä¼šå½±å“æ‰§è¡Œé€Ÿåº¦ã€‚å¦‚æœä¸éœ€è¦ï¼Œå¯ä»¥æ˜¾å¼å…³é—­ä»¥æé«˜æ‰§è¡Œæ•ˆç‡ã€‚\nå¯ä»¥ä½¿ç”¨ gather_facts: no æ¥ç¦æ­¢ Ansible æ”¶é›† facts ä¿¡æ¯\nå¸¸è§é€‰é¡¹\nfilter # æŒ‡å®šè¿‡æ»¤æ¡ä»¶ èŒƒä¾‹ï¼š\nansible remote -m setup ansible remote -m setup -a \"filter=ansible_nodename\" ansible remote -m setup -a \"filter=ansible_hostname\" ansible remote -m setup -a \"filter=ansible_domain\" ansible remote -m setup -a \"filter=ansible_memtotal_mb\" ansible remote -m setup -a \"filter=ansible_memory_mb\" ansible remote -m setup -a \"filter=ansible_memfree_mb\" ansible remote -m setup -a \"filter=ansible_os_family\" ansible remote -m setup -a \"filter=ansible_distribution\" ansible remote -m setup -a \"filter=ansible_distribution_major_version\" ansible remote -m setup -a \"filter=ansible_distribution_version\" ansible remote -m setup -a \"filter=ansible_processor_vcpus\" ansible remote -m setup -a \"filter=ansible_remote_ipv4_addresses\" ansible remote -m setup -a \"filter=ansible_architecture\" ansible remote -m setup -a \"filter=ansible_uptime_seconds\" ansible remote -m setup -a \"filter=ansible_processor*\" ansible remote -m setup -a 'filter=ansible_env' 2.4.24 debug æ¨¡å— æ­¤æ¨¡å—ç”¨äºæ‰“å°ç›¸å…³ä¿¡æ¯ï¼Œç±»ä¼¼äº print å’Œ echo\nå¸¸è§é€‰é¡¹\nmsg\t# æ‰“å°å†…å®¹ var\t# è®¾ç½®å˜é‡å¹¶èµ‹å€¼ verbosity # è¯¦ç»†çº§åˆ« èŒƒä¾‹ï¼šæœªæŒ‡å®šmsgï¼Œé»˜è®¤æ‰“å° hello world\n[root@ansible ~]# ansible remote -m debug remote | SUCCESS =\u003e { \"msg\": \"Hello world!\" } èŒƒä¾‹ï¼šæ‰“å°å˜é‡å€¼\n[root@ansible playbooks]# cat debug.yaml --- - hosts: remote gather_facts: yes tasks: - name: print value of variable debug: msg: host \"{{ ansible_nodename }}\" [root@ansible playbooks]# ansible-playbook debug.yaml PLAY [remote] *************************************************************************************** TASK [Gathering Facts] ****************************************************************************** ok: [remote] TASK [print value of variable] ********************************************************************** ok: [remote] =\u003e { \"msg\": \"host \\\"remote\\\"\" } PLAY RECAP ****************************************************************************************** remote : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 èŒƒä¾‹ï¼šé€šè¿‡ä¸‹æ ‡æ‰“å°æŒ‡å®šå¯¹åº”å­—ç¬¦\n[root@ansible playbooks]# cat debug.yaml --- - hosts: remote gather_facts: no vars: str: \"01234\" tasks: - debug: msg: - \"{{ str[0] }}\" - \"{{ str[1] }}\" - \"{{ str[2] }}\" [root@ansible playbooks]# ansible-playbook debug.yaml PLAY [remote] *************************************************************************************** TASK [debug] **************************************************************************************** ok: [remote] =\u003e { \"msg\": [ \"0\", \"1\", \"2\" ] } PLAY RECAP ****************************************************************************************** remote : ok=1 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 2.4.25 sysctl æ¨¡å— æ­¤æ¨¡å—ç”¨äºä¿®æ”¹å†…æ ¸å‚æ•°\nå¸¸è§é€‰é¡¹\nname # å†…æ ¸å‚æ•°å value # æŒ‡å®šå€¼ state # æ˜¯å¦ä¿å­˜åœ¨sysctl.confæ–‡ä»¶ä¸­ï¼Œé»˜è®¤present sysctl_set #ä½¿ç”¨sysctl -w éªŒè¯å€¼ç”Ÿæ•ˆ èŒƒä¾‹ï¼š\n[root@ansible playbooks]# ansible remote -m sysctl -a 'name=net.ipv4.ip_forward value=1 state=present' remote | CHANGED =\u003e { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python\" }, \"changed\": true } [root@ansible playbooks]# ansible remote -a 'grep forward /etc/sysctl.conf' remote | CHANGED | rc=0 \u003e\u003e net.ipv4.ip_forward=1 å…¶ä»–ç¤ºä¾‹ï¼š\n--- - hosts: remote gather_facts: no tasks: - name: Change Port Range sysctl: name: net.ipv4.ip_local_port_range value: '1024 65000' sysctl_set: yes - name: Enabled Forward sysctl: name: net.ipv4.ip_forward value: '1' sysctl_set: yes - name: Enabled tcp_reuse sysctl: name: net.ipv4.tcp_tw_reuse value: '1' sysctl_set: yes - name: Chanage tcp tw_buckets sysctl: name: net.ipv4.tcp_max_tw_buckets value: '5000' sysctl_set: yes - name: Chanage tcp_syncookies sysctl: name: net.ipv4.tcp_syncookies value: '1' sysctl_set: yes - name: Chanage tcp max_syn_backlog sysctl: name: net.ipv4.tcp_max_syn_backlog value: '8192' sysctl_set: yes - name: Chanage tcp Established Maxconn sysctl: name: net.core.somaxconn value: '32768' sysctl_set: yes state: present - name: Chanage tcp_syn_retries sysctl: name: net.ipv4.tcp_syn_retries value: '2' sysctl_set: yes state: present - name: Chanage net.ipv4.tcp_synack_retries sysctl: name: net.ipv4.tcp_synack_retries value: '2' sysctl_set: yes state: present 2.4.26 pam_limits æ¨¡å— æ­¤æ¨¡å—ç”¨äºä¿®æ”¹å†…æ ¸èµ„æºé™åˆ¶\nå¸¸è§é€‰é¡¹\nname\t# å†…æ ¸å‚æ•° value\t# æŒ‡å®šå€¼ state\t# æ˜¯å¦ä¿å­˜åœ¨ sysctl.conf æ–‡ä»¶ä¸­ï¼Œé»˜è®¤ä¿å­˜ sysctl_set # ä½¿ sysctl -w éªŒè¯å€¼ç”Ÿæ•ˆ èŒƒä¾‹ï¼š\nansible remote -m sysctl -a 'name=net.ipv4.ip_forward value=1 state=present' èŒƒä¾‹å†…æ ¸å‚æ•°ä¼˜åŒ–ï¼š\n--- - hosts: remote gather_facts: no vars: limits_conf_dest: '/etc/security/limits.conf' tasks: - name: Modify {{ limits_conf_dest }} pam_limits: dest: \"{{ limits_conf_dest }}\" domain: '*' limit_type: \"{{ item.limit_type }}\" limit_item: \"{{ item.limit_item }}\" value: \"{{ item.value }}\" loop: - { limit_type: 'soft', limit_item: 'nofile', value: '655350' } - { limit_type: 'hard', limit_item: 'nofile', value: '655350' } - { limit_type: 'soft', limit_item: 'nproc', value: '655350' } - { limit_type: 'hard', limit_item: 'nproc', value: '655350' } 3 Ansible Playbook 3.1 Playbook ç®€ä»‹ å®˜ç½‘ï¼šAnsible playbooks â€” Ansible Documentation\nPlaybook æ˜¯ Ansible ä¸­ç”¨äºå®šä¹‰è‡ªåŠ¨åŒ–ä»»åŠ¡çš„æ–‡æœ¬æ–‡ä»¶ã€‚å®ƒæ˜¯ä¸€ç§å£°æ˜æ€§çš„æè¿°æ–¹å¼ï¼Œç”¨äºæŒ‡å®šä¸€ç³»åˆ—æ­¥éª¤å’Œé…ç½®ï¼Œä»¥ä¾¿ Ansible å¯ä»¥åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œè¿™äº›æ­¥éª¤ã€‚Playbook å¯ä»¥ç”¨äºé…ç½®æœåŠ¡å™¨ã€éƒ¨ç½²åº”ç”¨ç¨‹åºã€ç®¡ç†ç³»ç»Ÿç­‰ä¸€ç³»åˆ—è‡ªåŠ¨åŒ–ä»»åŠ¡ã€‚\nä»¥ä¸‹æ˜¯ Playbook çš„ä¸€äº›é‡è¦ç‰¹ç‚¹å’Œç»„æˆéƒ¨åˆ†ï¼š\nå£°æ˜æ€§æè¿°: Playbook é‡‡ç”¨å£°æ˜æ€§çš„æ–¹å¼æè¿°äº†ä½ è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè€Œä¸éœ€è¦è¯¦ç»†è¯´æ˜æ¯ä¸ªæ­¥éª¤çš„æ‰§è¡Œè¿‡ç¨‹ã€‚\nYAML æ ¼å¼: Playbook æ˜¯ç”¨ YAMLï¼ˆYet Another Markup Languageï¼‰æ ¼å¼ç¼–å†™çš„ã€‚YAML æ ¼å¼å…·æœ‰è‰¯å¥½çš„å¯è¯»æ€§ï¼Œä½¿å¾— Playbook æ›´æ˜“äºç†è§£å’Œç¼–å†™ã€‚\nä¸»æœºæ¸…å•: åœ¨ Playbook ä¸­ï¼Œä½ å¯ä»¥æŒ‡å®šè¦æ‰§è¡Œä»»åŠ¡çš„ç›®æ ‡ä¸»æœºã€‚è¿™é€šå¸¸é€šè¿‡æ¸…å•æ–‡ä»¶æ¥å®ç°ï¼Œæ¸…å•æ–‡ä»¶åˆ—å‡ºäº†è¦æ‰§è¡Œä»»åŠ¡çš„è¿œç¨‹ä¸»æœºã€‚\nä»»åŠ¡: Playbook ç”±ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡ç»„æˆï¼Œæ¯ä¸ªä»»åŠ¡æè¿°äº†ä¸€ä¸ªç‰¹å®šçš„æ“ä½œï¼Œå¦‚è¿è¡Œå‘½ä»¤ã€å¤åˆ¶æ–‡ä»¶ã€å®‰è£…è½¯ä»¶ç­‰ã€‚\næ¨¡å—: ä»»åŠ¡ä½¿ç”¨æ¨¡å—æ¥æ‰§è¡Œå®é™…çš„æ“ä½œã€‚æ¨¡å—æ˜¯ Ansible åŠŸèƒ½çš„æ„å»ºå—ï¼Œå®ƒä»¬å°è£…äº†å„ç§ä¸åŒç±»å‹çš„ä»»åŠ¡ï¼Œä¾‹å¦‚è¿œç¨‹æ‰§è¡Œå‘½ä»¤ã€æ–‡ä»¶æ“ä½œã€è½¯ä»¶åŒ…ç®¡ç†ç­‰ã€‚\nå˜é‡: ä½ å¯ä»¥åœ¨ Playbook ä¸­ä½¿ç”¨å˜é‡æ¥å­˜å‚¨æ•°æ®ï¼Œå¦‚ä¸»æœºåã€IP åœ°å€ã€é…ç½®é€‰é¡¹ç­‰ã€‚å˜é‡å¯ä»¥æé«˜å¯ç»´æŠ¤æ€§å’Œå¯é‡ç”¨æ€§ã€‚\næ¡ä»¶å’Œå¾ªç¯: Playbook æ”¯æŒæ¡ä»¶è¯­å¥å’Œå¾ªç¯ï¼Œå…è®¸ä½ åœ¨ç‰¹å®šæƒ…å†µä¸‹æ‰§è¡Œä¸åŒçš„æ“ä½œï¼Œæˆ–è€…åœ¨å¤šä¸ªä¸»æœºä¸Šé‡å¤æ‰§è¡Œä»»åŠ¡ã€‚\nè§’è‰²: è§’è‰²æ˜¯ä¸€ç§ç»„ç»‡å’Œå¤ç”¨ Playbook çš„æ–¹å¼ï¼Œå¯ä»¥å°†ç›¸å…³ä»»åŠ¡å’Œå˜é‡ç»„ç»‡åˆ°ä¸€ä¸ªç»“æ„åŒ–çš„ç›®å½•ä¸­ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç®¡ç†å’Œç»´æŠ¤ã€‚\næ€»ä¹‹ï¼ŒPlaybook æ˜¯ Ansible ä¸­å®šä¹‰å’Œç®¡ç†è‡ªåŠ¨åŒ–ä»»åŠ¡çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒä½¿ä½ èƒ½å¤Ÿä»¥å¯ç»´æŠ¤ä¸”å¯æ‰©å±•çš„æ–¹å¼ç®¡ç†è¿œç¨‹ä¸»æœºä¸Šçš„é…ç½®å’Œæ“ä½œã€‚\n3.1.1 Playbook ç»„æˆ ä¸€ä¸ª playbook(å‰§æœ¬)æ–‡ä»¶æ˜¯ä¸€ä¸ªYAMLè¯­è¨€ç¼–å†™çš„æ–‡æœ¬æ–‡ä»¶ é€šå¸¸ä¸€ä¸ªplaybookåªåŒ…æ‹¬ä¸€ä¸ªplay ä¸€ä¸ª playçš„ä¸»è¦åŒ…æ‹¬ä¸¤éƒ¨åˆ†: ä¸»æœºå’Œtasks. å³å®ç°åœ¨æŒ‡å®šä¸€ç»„ä¸»æœºä¸Šæ‰§è¡Œä¸€ä¸ªtaskså®šä¹‰å¥½çš„ä»»åŠ¡åˆ—è¡¨ã€‚ ä¸€ä¸ªtasksä¸­å¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªtaskä»»åŠ¡ æ¯ä¸€ä¸ªTaskæœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨ansibleçš„ä¸€ä¸ªmodule åœ¨å¤æ‚åœºæ™¯ä¸­,ä¸€ä¸ªplaybookä¸­ä¹Ÿå¯ä»¥åŒ…æ‹¬å¤šä¸ªplayï¼Œå®ç°å¯¹å¤šç»„ä¸åŒçš„ä¸»æœºæ‰§è¡Œä¸åŒçš„ä»»åŠ¡ ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ Playbookï¼Œå±•ç¤ºäº†å¦‚ä½•é€šè¿‡å¤šä¸ª play æ‰§è¡Œä¸åŒä»»åŠ¡ï¼š\n--- # è¿™æ˜¯ä¸€ä¸ª Ansible Playbook ç¤ºä¾‹ï¼Œç”¨äºå±•ç¤ºå¤šä¸ª play çš„ç”¨æ³• # ç¬¬ä¸€ä¸ª playï¼šé…ç½® Web æœåŠ¡å™¨ - name: é…ç½® Web æœåŠ¡å™¨ hosts: web_servers tasks: - name: å®‰è£… Apache yum: name: httpd state: present - name: å¯åŠ¨ Apache æœåŠ¡ service: name: httpd state: started # ç¬¬äºŒä¸ª playï¼šé…ç½®æ•°æ®åº“æœåŠ¡å™¨ - name: é…ç½®æ•°æ®åº“æœåŠ¡å™¨ hosts: db_servers tasks: - name: å®‰è£… MySQL yum: name: mysql-server state: present - name: å¯åŠ¨ MySQL æœåŠ¡ service: name: mysqld state: started åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ª playï¼š\nç¬¬ä¸€ä¸ª play:\nåç§°ï¼šé…ç½® Web æœåŠ¡å™¨ ä¸»æœºï¼šweb_servers ä¸»æœºç»„ ä»»åŠ¡ï¼š å®‰è£… Apache è½¯ä»¶åŒ… å¯åŠ¨ Apache æœåŠ¡ ç¬¬äºŒä¸ª play:\nåç§°ï¼šé…ç½®æ•°æ®åº“æœåŠ¡å™¨ ä¸»æœºï¼šdb_servers ä¸»æœºç»„ ä»»åŠ¡ï¼š å®‰è£… MySQL è½¯ä»¶åŒ… å¯åŠ¨ MySQL æœåŠ¡ æ¯ä¸ª play éƒ½ç‹¬ç«‹æ‰§è¡Œï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä¸åŒçš„ä¸»æœºç»„ä¸Šæ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚åœ¨å¤æ‚çš„åœºæ™¯ä¸­ï¼Œè¿™ç§ç»“æ„å¯ä»¥è®©ä½ æ›´æœ‰æ•ˆåœ°ç®¡ç†å’Œç»„ç»‡è‡ªåŠ¨åŒ–ä»»åŠ¡ã€‚æ³¨é‡Šä¸­æä¾›äº†æ¯ä¸ª play æ‰€æ¶‰åŠçš„æ­¥éª¤å’Œä»»åŠ¡çš„æè¿°ï¼Œä»¥å¸®åŠ©ä½ ç†è§£ Playbook çš„ç»“æ„å’ŒåŠŸèƒ½ã€‚\n2.1.2 Playbook å’Œ Ad-Hoc å¯¹æ¯” Ansible æä¾›äº†ä¸¤ç§ä¸»è¦çš„æ“ä½œæ–¹å¼ï¼šPlaybook å’Œ Ad-Hoc å‘½ä»¤ï¼Œç”¨äºåœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œä»»åŠ¡ã€‚ä¸‹é¢æ˜¯å®ƒä»¬ä¹‹é—´çš„è¯¦ç»†å¯¹æ¯”ï¼š\nPlaybook:\næè¿°æ€§æ“ä½œï¼šPlaybook æ˜¯ç”¨ YAML æ–‡ä»¶ç¼–å†™çš„ï¼Œä»¥å£°æ˜æ€§çš„æ–¹å¼æè¿°äº†è¦æ‰§è¡Œçš„ä»»åŠ¡å’Œé…ç½®ã€‚å®ƒæ›´é€‚åˆç”¨äºå¤æ‚çš„ã€é•¿æœŸçš„è‡ªåŠ¨åŒ–ä»»åŠ¡ã€‚\nå¤æ‚æ€§ï¼šPlaybook æ”¯æŒå¤šä¸ªä¸»æœºã€å¤šä¸ªä»»åŠ¡ã€å˜é‡ã€å¾ªç¯å’Œæ¡ä»¶ç­‰å¤æ‚çš„æ“ä½œã€‚å®ƒé€‚åˆç®¡ç†å…¨é¢çš„é…ç½®å’Œéƒ¨ç½²ã€‚\nç»“æ„åŒ–ç»„ç»‡ï¼šPlaybook å…è®¸å°†ä»»åŠ¡ç»„ç»‡æˆé€»è¾‘çš„ playï¼Œæ¯ä¸ª play éƒ½å¯ä»¥åœ¨ç‰¹å®šçš„ä¸»æœºç»„ä¸Šæ‰§è¡Œã€‚è¿™ä½¿å¾—ä»»åŠ¡æ›´åŠ æ¨¡å—åŒ–å’Œå¯æ‰©å±•ã€‚\nå¯ç»´æŠ¤æ€§ï¼šç”±äºå®ƒæ˜¯æ–‡æœ¬æ–‡ä»¶ï¼ŒPlaybook å¯ä»¥è½»æ¾åœ°è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ã€æ–‡æ¡£åŒ–å’Œå…±äº«ã€‚é€‚åˆé•¿æœŸç»´æŠ¤å’Œå›¢é˜Ÿåä½œã€‚\nå˜é‡å’Œæ¨¡æ¿ï¼šPlaybook æ”¯æŒå®šä¹‰å˜é‡å’Œä½¿ç”¨ Jinja2 æ¨¡æ¿ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œä»è€Œå®ç°æ›´é«˜åº¦çš„å¯å®šåˆ¶æ€§ã€‚\nAd-Hoc å‘½ä»¤:\nå³æ—¶æ€§æ“ä½œï¼šAd-Hoc å‘½ä»¤æ˜¯ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œçš„ï¼Œé€‚ç”¨äºå³æ—¶éœ€è¦çš„ã€å•æ¬¡æ€§çš„ä»»åŠ¡ã€‚\nå‘½ä»¤è¡Œæ“ä½œï¼šAd-Hoc å‘½ä»¤æ›´é€‚åˆä¸´æ—¶æ“ä½œï¼Œæ— éœ€ç¼–å†™æˆ–ä¿å­˜æ–‡ä»¶ï¼Œç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œã€‚\nç®€å•ä»»åŠ¡ï¼šå®ƒé€‚åˆæ‰§è¡Œç®€å•çš„ã€å¿«é€Ÿçš„ä»»åŠ¡ï¼Œå¦‚æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€ã€æ‰§è¡Œä¸€æ¬¡æ€§å‘½ä»¤ç­‰ã€‚\nå‘½ä»¤æ¨¡å—ï¼šAd-Hoc å‘½ä»¤ä½¿ç”¨å‘½ä»¤æ¨¡å—æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå®ƒä»¬æ¯” Playbook çš„æ¨¡å—å°‘ï¼ŒåŠŸèƒ½ç›¸å¯¹æœ‰é™ã€‚\néš¾ä»¥ç»´æŠ¤ï¼šç”±äºå‘½ä»¤ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œï¼ŒAd-Hoc å‘½ä»¤çš„å¯è¯»æ€§å·®ï¼Œä¸é€‚åˆé•¿æœŸç»´æŠ¤å’Œè·Ÿè¸ªã€‚\nä¸æ”¯æŒå¤æ‚é€»è¾‘ï¼šAd-Hoc å‘½ä»¤ä¸æ”¯æŒåƒ Playbook ä¸­çš„å¤æ‚é€»è¾‘ã€æ¡ä»¶åˆ¤æ–­å’Œå¾ªç¯ã€‚\né€‰æ‹©é€‚ç”¨åœºæ™¯ï¼š\nå¦‚æœä½ éœ€è¦æ‰§è¡Œå¤æ‚çš„å¤šæ­¥éª¤ä»»åŠ¡ã€é…ç½®ç®¡ç†å’Œè‡ªåŠ¨åŒ–æµç¨‹ï¼Œåº”ä¼˜å…ˆä½¿ç”¨ Playbookã€‚ å¦‚æœä½ éœ€è¦å¿«é€Ÿæ‰§è¡Œä¸€æ¬¡æ€§çš„ä»»åŠ¡ï¼Œä¾‹å¦‚ç³»ç»Ÿè¯Šæ–­ã€å¿«é€Ÿæ£€æŸ¥ç­‰ï¼Œå¯ä»¥ä½¿ç”¨ Ad-Hoc å‘½ä»¤ã€‚ æœ€ç»ˆï¼Œé€‰æ‹© Playbook è¿˜æ˜¯ Ad-Hoc å‘½ä»¤å–å†³äºä½ çš„ä»»åŠ¡éœ€æ±‚ã€å¤æ‚æ€§å’Œé•¿æœŸç»´æŠ¤çš„è¦æ±‚ã€‚\n3.2 Plabook æ ¸å¿ƒç»„ä»¶ å½“æ¶‰åŠ Ansible Playbook çš„ç»„ä»¶æ—¶ï¼Œä»¥ä¸‹æ˜¯æ¯ä¸ªç»„ä»¶çš„ç®€å•ç¤ºä¾‹è¯´æ˜ï¼š\nä¸»æœºæ¸…å•ï¼ˆInventoryï¼‰ç¤ºä¾‹ï¼š ä¸»æœºæ¸…å•æ–‡ä»¶åˆ—å‡ºäº† Ansible å°†è¦ç®¡ç†çš„ä¸»æœºå’Œä¸»æœºç»„ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä¸»æœºæ¸…å•ç¤ºä¾‹ï¼š\n[web_servers] web1 ansible_host=192.168.1.10 web2 ansible_host=192.168.1.11 [db_servers] db1 ansible_host=192.168.1.20 å˜é‡ï¼ˆVariablesï¼‰ç¤ºä¾‹ï¼š ä½ å¯ä»¥åœ¨ Playbook ä¸­ä½¿ç”¨å˜é‡æ¥è®¾ç½®ä¸åŒçš„å€¼ï¼Œä»¥ä¾¿åœ¨ä¸åŒçš„ç¯å¢ƒä¸­é‡ç”¨é…ç½®ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å˜é‡ç¤ºä¾‹ï¼š\n--- - name: Example Playbook with Variables hosts: web_servers vars: http_port: 80 tasks: - name: Display HTTP Port debug: msg: \"HTTP port is {{ http_port }}\" ä»»åŠ¡ï¼ˆTasksï¼‰ç¤ºä¾‹ï¼š ä»»åŠ¡æ˜¯ Playbook ä¸­çš„æ“ä½œå•å…ƒï¼Œç”±æ¨¡å—ç»„æˆã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä»»åŠ¡ç¤ºä¾‹ï¼š\n--- - name: Example Task hosts: web_servers tasks: - name: Ensure Apache is installed yum: name: httpd state: present å¤„ç†é…ç½®ï¼ˆHandlersï¼‰ç¤ºä¾‹ï¼š å¤„ç†é…ç½®ç”¨äºåœ¨ä»»åŠ¡æ‰§è¡Œåè§¦å‘ä¸€äº›æ“ä½œï¼Œé€šå¸¸ç”¨äºé‡æ–°å¯åŠ¨æœåŠ¡æˆ–é‡æ–°åŠ è½½é…ç½®ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å¤„ç†é…ç½®ç¤ºä¾‹ï¼š\n--- - name: Example Playbook with Handlers hosts: web_servers tasks: - name: Ensure Apache is installed yum: name: httpd state: present notify: - Restart Apache handlers: - name: Restart Apache service: name: httpd state: restarted å‰§æœ¬ï¼ˆPlayï¼‰ç¤ºä¾‹ï¼š å‰§æœ¬ç”±ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡ç»„æˆï¼Œç”¨äºåœ¨ä¸€ç»„ä¸»æœºä¸Šæ‰§è¡Œæ“ä½œã€‚è¿™æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªä»»åŠ¡çš„å‰§æœ¬ç¤ºä¾‹ï¼š\n--- - name: Example Play hosts: web_servers tasks: - name: Ensure Apache is installed yum: name: httpd state: present - name: Copy index.html copy: src: /path/to/index.html dest: /var/www/html/ åœ¨æ¯ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘æä¾›äº†ä¸€ä¸ªåŸºæœ¬çš„æ¼”ç¤ºï¼Œè¯´æ˜äº†æ¯ä¸ªç»„ä»¶çš„ç”¨æ³•å’Œä½œç”¨ã€‚è¿™åº”è¯¥æœ‰åŠ©äºä½ æ›´å¥½åœ°ç†è§£ Ansible Playbook çš„ä¸åŒç»„ä»¶ä»¥åŠå®ƒä»¬æ˜¯å¦‚ä½•ä¸€èµ·å·¥ä½œçš„ã€‚\n3.3 Playbook å‘½ä»¤ å‘½ä»¤æ ¼å¼\nansible-playbook ... [options] å¸¸è§é€‰é¡¹\n--syntax,--syntax-check # è¯­æ³•æ£€æŸ¥,åŠŸèƒ½ç›¸å½“äºbash -n -C --check # æ¨¡æ‹Ÿæ‰§è¡Œ dry run ï¼Œåªæ£€æµ‹å¯èƒ½ä¼šå‘ç”Ÿçš„æ”¹å˜ï¼Œä½†ä¸çœŸæ­£æ‰§è¡Œæ“ä½œ --list-hosts # åˆ—å‡ºè¿è¡Œä»»åŠ¡çš„ä¸»æœº --list-tags # åˆ—å‡º tag --list-tasks # åˆ—å‡º task --limit HOST_NAME # åªé’ˆå¯¹ä¸»æœºåˆ—è¡¨ä¸­çš„ç‰¹å®šä¸»æœºæ‰§è¡Œ -i INVENTORY_PATH, --inventory INVENTORY_PATH # æŒ‡å®šä¸»æœºæ¸…å•æ–‡ä»¶, é€šå¸¸ä¸€ä¸ªé¡¹å¯¹åº”ä¸€ä¸ªä¸»æœºæ¸…å•æ–‡ä»¶ --start-at-task START_AT_TASK # ä»æŒ‡å®š task å¼€å§‹æ‰§è¡Œ, è€Œéä»å¤´å¼€å§‹, START_AT_TASKä¸ºä»»åŠ¡çš„ name -v -vv -vvv # æ˜¾ç¤ºè¿‡ç¨‹ èŒƒä¾‹ï¼šæ‰“å° hello world\n[root@ansible playbooks]# cat hello.yaml --- - hosts: remote gather_facts: no # ä¸æ”¶é›†ç›®æ ‡ä¸»æœºä¿¡æ¯ï¼ŒåŠ å¿«æ‰§è¡Œé€Ÿåº¦ tasks: - name: hello command: echo \"hello world!\" [root@ansible playbooks]# ansible-playbook hello.yaml ç¤ºä¾‹ï¼š\n# åˆ—å‡º playbook ä¸­çš„ä¸»æœº [root@ansible playbooks]# ansible-playbook hello.yaml --list-hosts playbook: hello.yaml play #1 (remote): remote\tTAGS: [] pattern: [u'remote'] hosts (1): remote # åˆ—å‡º playbook ä¸­çš„ä»»åŠ¡ [root@ansible playbooks]# ansible-playbook hello.yaml --list-tasks playbook: hello.yaml play #1 (remote): remote\tTAGS: [] tasks: hello\tTAGS: [] 3.4 ignore_errors åœ¨ playbook æ‰§è¡Œæ—¶ï¼Œå¦‚æœæŸä¸ª task å‡ºé”™ï¼Œåˆ™åç»­ä»»åŠ¡ä¸ä¼šå†æ‰§è¡Œ\n[root@ansible playbooks]# cat test_ignore.yaml --- - hosts: remote gather_facts: no tasks: - name: task1 command: /bin/false ignore_errors: yes # å¿½ç•¥è¯¥taskçš„æŠ¥é”™ï¼Œç»§ç»­æ‰§è¡Œåç»­ä»»åŠ¡ - name: task2 command: echo \"hello world!\" - hosts: remote gather_facts: no tasks: - name: task3 command: /bin/false # æ­¤æ­¥éª¤æŠ¥é”™ï¼Œä¸å†æ‰§è¡Œåç»­ä»»åŠ¡ - name: task4 command: echo \"END---\" #å®é™…è¿è¡Œæ•ˆæœï¼štask4ä¸ä¼šæ‰§è¡Œ [root@ansible playbooks]# ansible-playbook test_ignore.yaml PLAY [remote] *********************************************************************** TASK [task1] ************************************************************************ fatal: [remote]: FAILED! =\u003e {\"ansible_facts\": {\"discovered_interpreter_python\": \"/usr/bin/python\"}, \"changed\": true, \"cmd\": [\"/bin/false\"], \"delta\": \"0:00:00.272950\", \"end\": \"2023-08-23 16:10:01.027320\", \"msg\": \"non-zero return code\", \"rc\": 1, \"start\": \"2023-08-23 16:10:00.754370\", \"stderr\": \"\", \"stderr_lines\": [], \"stdout\": \"\", \"stdout_lines\": []} ...ignoring TASK [task2] ************************************************************************ changed: [remote] PLAY [remote] *********************************************************************** TASK [task3] ************************************************************************ fatal: [remote]: FAILED! =\u003e {\"changed\": true, \"cmd\": [\"/bin/false\"], \"delta\": \"0:00:00.276205\", \"end\": \"2023-08-23 16:10:02.161360\", \"msg\": \"non-zero return code\", \"rc\": 1, \"start\": \"2023-08-23 16:10:01.885155\", \"stderr\": \"\", \"stderr_lines\": [], \"stdout\": \"\", \"stdout_lines\": []} PLAY RECAP ************************************************************************** remote : ok=2 changed=2 unreachable=0 failed=1 skipped=0 rescued=0 ignored=1 3.5 handlers å’Œ notify Handlers æœ¬è´¨æ˜¯ task list ï¼Œç±»ä¼¼äº MySQL ä¸­çš„è§¦å‘å™¨è§¦å‘çš„è¡Œä¸ºï¼Œå…¶ä¸­çš„ task ä¸å‰è¿°çš„ task å¹¶æ²¡æœ‰æœ¬è´¨ä¸Šçš„ä¸åŒï¼Œåªæœ‰åœ¨å…³æ³¨çš„èµ„æºå‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡‡å–ä¸€å®šçš„æ“ä½œã€‚\nNotify å¯¹åº”çš„ action åœ¨æ‰€æœ‰ task éƒ½æ‰§è¡Œå®Œæ‰ä¼šæœ€åè¢«è§¦å‘ï¼Œè¿™æ ·å¯é¿å…å¤šä¸ª task å¤šæ¬¡æ”¹å˜å‘ç”Ÿæ—¶æ¯æ¬¡éƒ½è§¦å‘æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œï¼ŒHandlers ä»…åœ¨æ‰€æœ‰çš„å˜åŒ–å‘ç”Ÿå®Œæˆåä¸€æ¬¡æ€§åœ°æ‰§è¡ŒæŒ‡å®šæ“ä½œã€‚\nåœ¨ notify ä¸­åˆ—å‡ºçš„æ“ä½œç§°ä¸º handler ï¼Œä¹Ÿå³ notify ä¸­è°ƒç”¨ handler ä¸­å®šä¹‰çš„æ“ä½œ\næ³¨æ„:\nå¦‚æœå¤šä¸ª task é€šçŸ¥äº†ç›¸åŒçš„handlersï¼Œ æ­¤handlersä»…ä¼šåœ¨æ‰€æœ‰taskç»“æŸåè¿è¡Œä¸€ æ¬¡ã€‚ åªæœ‰ notify å¯¹åº”çš„ task å‘ç”Ÿæ”¹å˜äº†æ‰ä¼šé€šçŸ¥ handlersï¼Œæ²¡æœ‰æ”¹å˜åˆ™ä¸ä¼šè§¦å‘handlers handlers æ˜¯åœ¨æ‰€æœ‰å‰é¢çš„ tasks éƒ½æˆåŠŸæ‰§è¡Œæ‰ä¼šæ‰§è¡Œï¼Œå¦‚æœå‰é¢ä»»ä½•ä¸€ä¸ª task å¤±è´¥ï¼Œä¼šå¯¼è‡´ handler è·³è¿‡æ‰§è¡Œ ç¤ºä¾‹ï¼šæ‰§è¡Œä¸¤ä¸ª handle\n--- - hosts: remote gather_facts: no tasks: - name: task1 command: /bin/true notify: # è§¦å‘ handlers ä¸­çš„ä»»åŠ¡æ‰§è¡Œ - get up - go to school handlers: - name: get up debug: msg: \"Get it\" - name: go to school debug: msg: \"I am going to school\" [root@ansible playbooks]# ansible-playbook test.yaml PLAY [remote] ****************************************************************** TASK [task1] ******************************************************************* changed: [remote] RUNNING HANDLER [get up] ******************************************************* ok: [remote] =\u003e { \"msg\": \"Get it\" } RUNNING HANDLER [go to school] ************************************************* ok: [remote] =\u003e { \"msg\": \"I am going to school\" } PLAY RECAP ********************************************************************* remote : ok=3 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 å¦‚æœæœ‰ä»»æ„ä¸€ä¸ªtask æ‰§è¡Œå¤±è´¥ï¼Œhandlers ä¸­çš„ä»»åŠ¡ä¸ä¼šæ‰§è¡Œï¼ˆå³ä½¿åŠ äº†ignore_errorsï¼‰ï¼Œæ­¤æ—¶å¯ä»¥åŠ ä¸Šforce_handlers: yesæ¥å¼ºåˆ¶æ‰§è¡Œ handlers\n--- - hosts: remote gather_facts: no force_handlers: yes # å¿½ç•¥ä»»ä¸€ task æ‰§è¡ŒæŠ¥é”™ï¼Œç»§ç»­å…¶ä»– task åŠå…¶ handler tasks: - name: task1 command: /bin/true notify: # è§¦å‘ handlers ä¸­çš„ä»»åŠ¡æ‰§è¡Œ - get up - name: task2 command: /bin/false notify: - go to school\t# ç”±äºtask2 æŠ¥é”™ï¼Œä¸ä¼šé€šçŸ¥ç›¸åº”çš„handleræ‰§è¡Œ handlers: - name: get up debug: msg: \"Get it\" - name: go to school debug: msg: \"I am going to school\" [root@ansible playbooks]# ansible-playbook test.yaml PLAY [remote] ****************************************************************** TASK [task1] ******************************************************************* changed: [remote] TASK [task2] ******************************************************************* fatal: [remote]: FAILED! =\u003e {\"changed\": true, \"cmd\": [\"/bin/false\"], \"delta\": \"0:00:00.273631\", \"end\": \"2023-08-24 08:52:38.649403\", \"msg\": \"non-zero return code\", \"rc\": 1, \"start\": \"2023-08-24 08:52:38.375772\", \"stderr\": \"\", \"stderr_lines\": [], \"stdout\": \"\", \"stdout_lines\": []} RUNNING HANDLER [get up] ******************************************************* ok: [remote] =\u003e { \"msg\": \"Get it\" } PLAY RECAP ********************************************************************* remote : ok=2 changed=1 unreachable=0 failed=1 skipped=0 rescued=0 ignored=0 3.6 Playbook ä¸­ä½¿ç”¨ tags Tags â€” Ansible Documentation\né»˜è®¤æƒ…å†µä¸‹ï¼Œansible ä¼šæ‰§è¡Œ playbook ä¸­çš„æ‰€æœ‰ä»»åŠ¡ã€‚æ ¹æ®éœ€è¦ï¼Œå¯ä»¥ç»™æŒ‡å®šçš„ task æŒ‡å®šæ ‡ç­¾ï¼Œå³ tagï¼Œè€Œååœ¨æ‰§è¡Œ playbook æ—¶ï¼Œå¸¦ä¸Šå¯¹åº”çš„ tag ä»¥è¿è¡ŒæŒ‡å®šçš„ taskã€‚\nä¸€ä¸ª task å¯ä»¥æœ‰å¤šä¸ª tag å†…ç½®çš„ tag æœ‰ï¼š taggedï¼Œuntagged å’Œ allï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ä»…è¿è¡Œæœ‰tagï¼Œæ²¡æœ‰tagçš„ä»»åŠ¡å’Œæ‰€æœ‰ä»»åŠ¡ã€‚ èŒƒä¾‹ï¼š\n[root@ansible playbooks]# cat test_tags.yml --- - hosts: remote remote_user: root gather_facts: no tasks: - name: task1 debug: msg: \"task1\" tags: - tag1 - tag_one - name: task2 debug: msg: \"task2\" - name: task3 debug: msg: \"task3\" # åˆ—å‡ºæ‰€æœ‰ tag [root@ansible playbooks]# ansible-playbook test_tags.yml --list-tags playbook: test_tags.yml play #1 (remote): remote\tTAGS: [] TASK TAGS: [tag1, tag_one] # åªè¿è¡Œå¸¦æœ‰ tag1 çš„ task [root@ansible playbooks]# ansible-playbook test_tags.yml -t tag1 PLAY [remote] ****************************************************************** TASK [task1] ******************************************************************* ok: [remote] =\u003e { \"msg\": \"task1\" } PLAY RECAP ********************************************************************* remote : ok=1 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 # åªè¿è¡Œæ²¡æœ‰ tag çš„ task [root@ansible playbooks]# ansible-playbook test_tags.yml -t untagged PLAY [remote] ****************************************************************** TASK [task2] ******************************************************************* ok: [remote] =\u003e { \"msg\": \"task2\" } TASK [task3] ******************************************************************* ok: [remote] =\u003e { \"msg\": \"task3\" } PLAY RECAP ********************************************************************* remote : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 # ä¸æ‰§è¡Œæœ‰ç‰¹å®š tag çš„ task [root@ansible playbooks]# ansible-playbook test_tags.yml --skip-tags tag_one # ä¸æ‰§è¡Œæ²¡æœ‰ tag çš„ task [root@ansible playbooks]# ansible-playbook test_tags.yml --skip-tags untagged 3.7 Playbook ä¸­ä½¿ç”¨å˜é‡ åœ¨ Ansible ä¸­ï¼Œsetup æ¨¡å—ç”¨äºæ”¶é›†æœ‰å…³è¿œç¨‹ä¸»æœºçš„å„ç§ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯è¢«ç§°ä¸º â€œfactsâ€ã€‚è¿™äº› facts åŒ…æ‹¬æœ‰å…³æ“ä½œç³»ç»Ÿã€ç¡¬ä»¶ã€ç½‘ç»œã€å†…å­˜ã€CPU ç­‰çš„ä¿¡æ¯ï¼Œå¯ä»¥ç”¨äºç¼–å†™æ›´åŠ çµæ´»å’ŒåŠ¨æ€çš„å‰§æœ¬ã€‚ä½¿ç”¨ setup æ¨¡å—å¯ä»¥é€šè¿‡ Ansible æ”¶é›†è¿œç¨‹ä¸»æœºçš„ factsã€‚è°ƒç”¨ playbook æ—¶é»˜è®¤è°ƒç”¨æ­¤æ¨¡å—ï¼Œå¯é€šè¿‡ gather_facts: no æ¥ç¦æ­¢ã€‚\nå˜é‡å‘½ä»¤è§„åˆ™ï¼šç”±å­—æ¯ï¼Œæ•°å­—ï¼Œä¸‹åˆ’çº¿ç»„æˆä¸”åªèƒ½ä»¥å­—æ¯å¼€å¤´\nå˜é‡è°ƒç”¨æ–¹å¼ï¼šé€šè¿‡ {{ VARIBLE_NAME }} è°ƒç”¨å˜é‡ï¼Œå»ºè®®å˜é‡åå‰ååŠ ç©ºæ ¼ï¼Œä¸”æœ‰æ—¶éœ€è¦ä»¥åŒå¼•å·åŒ…è£¹ â€{{ VARIBLE_NAME }}â€œ ï¼ˆå¦‚ï¼šdebug æ¨¡å—ä¸­ï¼‰\nå˜é‡æ¥æºï¼š\nansible çš„ setup æ¨¡å—æ”¶é›†çš„ facts å˜é‡\né€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šå˜é‡ï¼Œä¼˜å…ˆçº§æœ€é«˜\nansible-playbook my_playbook.yml -e \"my_variable=value\" åœ¨ playbook ä¸­å®šä¹‰\n- name: Example Playbook hosts: servers vars: my_var: \"Hello, Ansible!\" tasks: - name: Display variable debug: var: my_var åœ¨ç‹¬ç«‹çš„YAMLæ–‡ä»¶ä¸­å®šä¹‰ï¼Œç„¶åé€šè¿‡å…³é”®å­— vars_files å¼•å…¥\n- hosts: remote vars_fiels: - my_vars.yml åœ¨ä¸»æœºæ¸…å•æ–‡ä»¶ä¸­å®šä¹‰\nä¸»æœºå˜é‡ï¼š åœ¨ä¸»æœºæ¸…å•ï¼ˆInventoryï¼‰ä¸­å®šä¹‰çš„å˜é‡ï¼Œä¼˜å…ˆçº§é«˜äºç»„å˜é‡\n[my_hosts] host1 my_variable=host_value ç»„å˜é‡ï¼š åœ¨ä¸»æœºæ¸…å•ä¸­çš„ç»„çº§åˆ«å®šä¹‰çš„å˜é‡ã€‚\n[my_group:vars] my_variable=group_value åœ¨é¡¹ç›®ä¸­é’ˆå¯¹ä¸»æœºå’Œä¸»æœºç»„å®šä¹‰\nåœ¨é¡¹ç›®ç›®å½•ä¸‹åˆ›å»º host_vars å’Œ group_vars ç›®å½•ï¼Œåœ¨å…¶ä¸­æ–°å»º YAML æ–‡ä»¶å®šä¹‰å˜é‡\nåœ¨ role ï¼ˆè§’è‰²ï¼‰ä¸­å®šä¹‰\nåœ¨ Ansible è§’è‰²ä¸­ï¼Œå˜é‡ä¹Ÿæœ‰ä¼˜å…ˆçº§ï¼Œç±»ä¼¼äº Ansible çš„å…¶ä»–å˜é‡ã€‚è§’è‰²å†…çš„å˜é‡å¯ä»¥åˆ†ä¸ºå‡ ä¸ªä¸åŒçš„çº§åˆ«ï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°ä½æ’åˆ—å¦‚ä¸‹ï¼š\nè§’è‰²ä»»åŠ¡å˜é‡ï¼ˆRole Task Variablesï¼‰ï¼šè¿™äº›å˜é‡åœ¨è§’è‰²å†…çš„ä»»åŠ¡ä¸­å®šä¹‰ï¼Œå¹¶ä¸”åªåœ¨ç‰¹å®šä»»åŠ¡ä¸­ç”Ÿæ•ˆã€‚è¿™äº›å˜é‡çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œä¼šè¦†ç›–å…¶ä»–çº§åˆ«çš„å˜é‡ã€‚\nåœ¨è§’è‰²ä»»åŠ¡ä¸­å®šä¹‰çš„å˜é‡ï¼Œé€šå¸¸å­˜å‚¨åœ¨ä»»åŠ¡ä¸­çš„ vars éƒ¨åˆ†ï¼š\n- name: Example role task debug: msg: \"This is a task with a role-level variable\" vars: task_variable: value è§’è‰²é»˜è®¤å˜é‡ï¼ˆRole Default Variablesï¼‰ï¼šè§’è‰²çš„é»˜è®¤å˜é‡å­˜å‚¨åœ¨è§’è‰²çš„ defaults ç›®å½•ä¸‹ã€‚è¿™äº›å˜é‡åœ¨è§’è‰²å†…éƒ¨è¢«è®¤ä¸ºæ˜¯é»˜è®¤è®¾ç½®ï¼Œé™¤éè¢«å…¶ä»–çº§åˆ«çš„å˜é‡è¦†ç›–ã€‚\nè§’è‰²é»˜è®¤å˜é‡å­˜å‚¨åœ¨ roles/role_name/defaults/main.yml æ–‡ä»¶ä¸­ã€‚\nè§’è‰²å˜é‡ï¼ˆRole Variablesï¼‰ï¼šåœ¨ä½¿ç”¨è§’è‰²æ—¶ï¼Œå¯ä»¥åœ¨ä¸»å‰§æœ¬ä¸­ä¸ºè§’è‰²è®¾ç½®å˜é‡ã€‚è¿™äº›å˜é‡å¯ä»¥å½±å“è§’è‰²ä¸­çš„ä»»åŠ¡å’Œé»˜è®¤å˜é‡ã€‚\nåœ¨ä¸»å‰§æœ¬ä¸­ä¸ºè§’è‰²è®¾ç½®å˜é‡çš„æ–¹å¼å¦‚ä¸‹ï¼š\n- name: Playbook using a role hosts: target_hosts roles: - role: role_name vars: role_var: value ä¸»æœºæ¸…å•ä¸­çš„å˜é‡ï¼ˆInventory Variablesï¼‰ï¼šåœ¨ä¸»æœºæ¸…å•ä¸­ä¸ºä¸»æœºæˆ–ä¸»æœºç»„å®šä¹‰çš„å˜é‡ã€‚è¿™äº›å˜é‡åœ¨è§’è‰²å†…ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯å…¶ä¼˜å…ˆçº§è¾ƒä½ã€‚\nåœ¨ä¸»æœºæ¸…å•ä¸­ä¸ºä¸»æœºå®šä¹‰å˜é‡çš„æ–¹å¼å¦‚ä¸‹ï¼š\n[target_hosts] host1 ansible_ssh_host=192.168.1.1 role_var=value å˜é‡ä¼˜å…ˆçº§ä»é«˜åˆ°ä½å¦‚ä¸‹ï¼š\n1. å‘½ä»¤è¡Œ -e ä¼ é€’çš„å˜é‡ 2. playbook ä¸­ 2.1 vars_files å¼•å…¥çš„å˜é‡ 2.1 playbook ä¸­ vars å˜é‡å®šä¹‰ 3. host_vars/ä¸»æœºåæ–‡ä»¶ 4. ä¸»æœºæ¸…å•ä¸­çš„ä¸»æœºå˜é‡ 5. group_vars 5.1 ä¸»æœºç»„åæ–‡ä»¶ 5.2 all.yml 6. ä¸»æœºæ¸…å•ä¸­çš„ç»„å˜é‡ æ€»çš„æ¥è¯´ï¼Œå˜é‡å®šä¹‰æ–¹å¼å¤šè€Œæ‚ï¼Œå®é™…ä½¿ç”¨æ—¶åº”é¿å…åœ¨å¤šä¸ªåœ°æ–¹å®šä¹‰åŒä¸€ä¸ªå˜é‡ï¼Œé™ä½å¤æ‚åº¦ï¼Œä»è€Œé™ä½ç»´æŠ¤æˆæœ¬ï¼Œå‡å°‘å‡ºé”™çš„å¯èƒ½æ€§ã€‚\n3.7.1 ä½¿ç”¨ setup æ¨¡å—ä¸­çš„å˜é‡ 3.7.1.1 ä½¿ç”¨ facts å˜é‡ æœ¬æ¨¡å—è‡ªåŠ¨åœ¨playbookè°ƒç”¨ï¼Œç”Ÿæˆçš„ç³»ç»ŸçŠ¶æ€ä¿¡æ¯, å¹¶å°†ä¹‹å­˜æ”¾åœ¨factså˜é‡ä¸­\nfacts åŒ…æ‹¬çš„ä¿¡æ¯å¾ˆå¤š,å¦‚: ä¸»æœºå, IP, CPU, å†…å­˜, ç½‘å¡ç­‰\nfacts å˜é‡çš„å®é™…ä½¿ç”¨åœºæ™¯æ¡ˆä¾‹\né€šè¿‡factså˜é‡è·å–è¢«æ§ç«¯CPUçš„ä¸ªæ•°ä¿¡æ¯ï¼Œä»è€Œç”Ÿæˆä¸åŒçš„Nginxé…ç½®æ–‡ä»¶\né€šè¿‡factså˜é‡è·å–è¢«æ§ç«¯å†…å­˜å¤§å°ä¿¡æ¯ï¼Œä»è€Œç”Ÿæˆä¸åŒçš„memcachedçš„é…ç½®æ–‡ä»¶\né€šè¿‡factså˜é‡è·å–è¢«æ§ç«¯ä¸»æœºåç§°ä¿¡æ¯ï¼Œä»è€Œç”Ÿæˆä¸åŒçš„Zabbixé…ç½®æ–‡ä»¶\né€šè¿‡factså˜é‡è·å–è¢«æ§ç«¯ç½‘å¡ä¿¡æ¯ï¼Œä»è€Œç”Ÿæˆä¸åŒçš„ä¸»æœºå\nâ€¦â€¦\nèŒƒä¾‹ï¼š\n# è·å–ç½‘å¡ä¿¡æ¯ [root@ansible playbooks]# ansible localhost -m setup -a 'filter=\"ansible_default_ipv4\"' localhost | SUCCESS =\u003e { \"ansible_facts\": { \"ansible_default_ipv4\": { \"address\": \"192.168.146.128\", \"alias\": \"ens33\", \"broadcast\": \"192.168.146.255\", \"gateway\": \"192.168.146.254\", \"interface\": \"ens33\", \"macaddress\": \"00:0c:29:c6:1a:98\", \"mtu\": 1500, \"netmask\": \"255.255.255.0\", \"network\": \"192.168.146.0\", \"type\": \"ether\" } }, \"changed\": false } # æŸ¥çœ‹ä¸»æœºå [root@ansible playbooks]# ansible localhost -m setup -a 'filter=\"ansible_nodename\"' localhost | SUCCESS =\u003e { \"ansible_facts\": { \"ansible_nodename\": \"ansible\" }, \"changed\": false } # æ ¹æ®ä¸»æœºåç”Ÿæˆæ—¥å¿—æ–‡ä»¶ [root@ansible playbooks]# vim touch_host_log.yaml [root@ansible playbooks]# ansible-playbook touch_host_log.yaml [root@ansible playbooks]# ansible remote -a 'ls /tmp/remote.log' remote | CHANGED | rc=0 \u003e\u003e /tmp/remote.log # è·å–ç½‘å¡åœ°å€ [root@ansible playbooks]# cat show_ip_of_eth0.yaml --- - hosts: remote tasks: - name: show ens33 ip address of {{ ansible_facts[\"eth0\"][\"ipv4\"][\"address\"] }} debug: msg: Ip address {{ ansible_facts.ens33.ipv4.address }} - name: another way debug: Ip address {{ ansible_facts[\"ens33\"][\"ipv4\"][\"address\"] }} [root@ansible playbooks]# ansible-playbook show_ip_of_eth0.yaml PLAY [remote] ****************************************************************** TASK [Gathering Facts] ********************************************************* ok: [remote] TASK [show ens33 ip address of {{ ansible_facts[\"eth0\"][\"ipv4\"][\"address\"] }}] *** ok: [remote] =\u003e { \"msg\": \"Ip address 192.168.146.129\" } TASK [another way] ************************************************************* ok: [remote] =\u003e { \"msg\": \"Hello world!\" } PLAY RECAP ********************************************************************* remote : ok=3 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 3.7.1.2 æ€§èƒ½ä¼˜åŒ– æ‰§è¡Œ playbook æ—¶ï¼Œé»˜è®¤å¯ç”¨ setup æ¨¡å—æ”¶é›†ç›®æ ‡ä¸»æœºçš„ facts å˜é‡ï¼Œä¼šè€—è´¹ä¸€å®šæ—¶é—´ã€‚å¯é€‰åˆ™ä»¥ä¸‹ä¸¤ç§æ–¹å¼è¿›è¡Œé…ç½®\nå¦‚æœä¸éœ€è¦ä½¿ç”¨åˆ°ç›®æ ‡ä¸»æœºçš„å˜é‡ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ gather_facts: no é€‰é¡¹æ¥å…³é—­æ­¤è¡Œä¸º\n--- - hosts: all gather_facts: no åœ¨ Ansible ä¸­ï¼Œâ€œfacts ç¼“å­˜â€ æ˜¯æŒ‡å°†ä¸»æœºçš„äº‹å®æ•°æ®ï¼ˆä¾‹å¦‚ä¸»æœºåã€æ“ä½œç³»ç»Ÿä¿¡æ¯ã€IP åœ°å€ç­‰ï¼‰ç¼“å­˜èµ·æ¥ï¼Œä»¥ä¾¿åœ¨åç»­çš„ Ansible è¿è¡Œä¸­é‡ç”¨è¿™äº›æ•°æ®ï¼Œä»è€Œå‡å°‘ç³»ç»Ÿèµ„æºçš„ä½¿ç”¨å’Œæé«˜æ‰§è¡Œæ•ˆç‡ã€‚\nè¦å¯ç”¨ Ansible çš„ Facts ç¼“å­˜åŠŸèƒ½ï¼Œä½ å¯ä»¥åœ¨ Ansible é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œè®¾ç½®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒAnsible å°†äº‹å®æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä½†ä½ ä¹Ÿå¯ä»¥é€‰æ‹©å°†å…¶å­˜å‚¨åœ¨ç£ç›˜ä¸Šä»¥å®ç°æŒä¹…æ€§ã€‚\nä»¥ä¸‹æ˜¯å¯ç”¨ Ansible Facts ç¼“å­˜çš„é…ç½®ç¤ºä¾‹ï¼š\nå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼š åœ¨ Ansible é…ç½®æ–‡ä»¶ä¸­ï¼ˆé€šå¸¸æ˜¯ /etc/ansible/ansible.cfg æˆ– ~/.ansible.cfgï¼‰ï¼Œæ·»åŠ ä»¥ä¸‹é…ç½®è¡Œï¼š\n[defaults] gathering = smart fact_caching = memory å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼š è¦å°† Facts å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œä½ éœ€è¦é€‰æ‹©ä¸€ä¸ªç›®å½•æ¥ä¿å­˜ç¼“å­˜æ•°æ®ã€‚åœ¨ Ansible é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®è¡Œï¼š\n[defaults] gathering = smart fact_caching = jsonfile fact_caching_connection = /path/to/cache_directory å°† /path/to/cache_directory æ›¿æ¢ä¸ºä½ æƒ³è¦å­˜å‚¨ Facts ç¼“å­˜æ•°æ®çš„å®é™…ç›®å½•è·¯å¾„ã€‚\nå®Œæˆé…ç½®åï¼Œé‡æ–°è¿è¡Œ Ansible å‘½ä»¤ï¼Œå®ƒå°†ä½¿ç”¨ Facts ç¼“å­˜æ¥åŠ é€Ÿæ‰§è¡Œè¿‡ç¨‹ã€‚\nè¯·æ³¨æ„ï¼Œä»¥ä¸Šé…ç½®ç¤ºä¾‹é€‚ç”¨äº Ansible ç‰ˆæœ¬è¾ƒæ–°çš„æƒ…å†µã€‚åœ¨ç‰¹å®šçš„ Ansible ç‰ˆæœ¬ä¸­ï¼Œé…ç½®é€‰é¡¹å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚åœ¨ä½¿ç”¨å‰ï¼Œè¯·ç¡®ä¿æŸ¥é˜…ä¸ä½ æ‰€ä½¿ç”¨çš„ Ansible ç‰ˆæœ¬ç›¸åŒ¹é…çš„å®˜æ–¹æ–‡æ¡£æˆ–æ‰‹å†Œã€‚\n3.7.2 å‘½ä»¤è¡Œä¸­ç»™ playbook ä¼ é€’å˜é‡ åœ¨ Ansible çš„ ansible-playbook å‘½ä»¤è¡Œä¸­ï¼Œå¯ä»¥ä½¿ç”¨ -e é€‰é¡¹æ¥ä¼ é€’é¢å¤–çš„å˜é‡ç»™ playbookã€‚è¿™å¯ä»¥è®©ä½ åœ¨è¿è¡Œ playbook æ—¶åŠ¨æ€åœ°æŒ‡å®šå˜é‡çš„å€¼ï¼Œè€Œä¸å¿…ä¿®æ”¹ playbook æ–‡ä»¶æœ¬èº«ã€‚ä»¥ä¸‹æ˜¯ä¼ é€’å˜é‡çš„å‡ ç§æ–¹å¼ï¼š\nä¼ é€’å•ä¸ªå˜é‡ï¼š\nansible-playbook -e \"variable_name=variable_value\" playbook.yml ä¼ é€’å¤šä¸ªå˜é‡ï¼š\nå¦‚æœä½ æƒ³ä¼ é€’å¤šä¸ªå˜é‡ï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ª -e é€‰é¡¹æˆ–è€…å°†å¤šä¸ªå˜é‡æ”¾åœ¨ä¸€ä¸ªå¼•å·ä¸­ï¼Œç”¨ç©ºæ ¼æˆ–é€—å·åˆ†éš”ã€‚\nansible-playbook -e \"variable1=value1 variable2=value2\" playbook.yml æˆ–è€…ï¼š\nansible-playbook -e \"variable1=value1\" -e \"variable2=value2\" playbook.yml ä¼ é€’ yaml å˜é‡æ–‡ä»¶\nå‡è®¾ä½ çš„ YAML æ–‡ä»¶ vars.yml å¦‚ä¸‹ï¼š\n#vars.yml my_variable: \"Hello, Ansible!\" database_host: \"db.example.com\" database_port: 3306 é€šè¿‡ -e é€‰é¡¹ä¼ é€’æ­¤æ–‡ä»¶ä¸­çš„å˜é‡\nansible-playbook -e @vars.yaml playbook.yml ä¼ é€’ JSON æ–‡ä»¶ï¼š\nä½ ä¹Ÿå¯ä»¥å°†å˜é‡ä¿å­˜åœ¨ä¸€ä¸ª JSON æ ¼å¼çš„æ–‡ä»¶ä¸­ï¼Œç„¶åä½¿ç”¨ -e é€‰é¡¹ä¼ é€’æ–‡ä»¶è·¯å¾„ã€‚\nansible-playbook -e @variables.json playbook.yml å…¶ä¸­ï¼Œvariables.json æ˜¯ä¸€ä¸ªåŒ…å«å˜é‡çš„ JSON æ–‡ä»¶ã€‚\næ— è®ºä½ é€‰æ‹©å“ªç§æ–¹å¼ï¼Œä¼ é€’çš„å˜é‡éƒ½å¯ä»¥åœ¨ playbook ä¸­ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š\n[root@ansible playbooks]# cat playbook.yml --- - name: Example Playbook gather_facts: no hosts: remote tasks: - debug: var: my_variable [root@ansible playbooks]# ansible-playbook -e @vars.yaml playbook.yml PLAY [Example Playbook] ******************************************************** TASK [debug] ******************************************************************* ok: [remote] =\u003e { \"my_variable\": \"Hello, Ansible!\" } PLAY RECAP ********************************************************************* remote : ok=1 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œmy_variable å˜é‡çš„å€¼å°†æ ¹æ®åœ¨å‘½ä»¤è¡Œä¸­ä¼ é€’çš„å€¼è¿›è¡Œè®¾å®šã€‚\n3.7.3 åœ¨ playbook æ–‡ä»¶ä¸­å®šä¹‰å˜é‡ åœ¨Playbookçº§åˆ«å®šä¹‰å˜é‡ï¼š\nåœ¨Playbookä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨varså…³é”®å­—æ¥å®šä¹‰å˜é‡ã€‚è¿™äº›å˜é‡å°†åœ¨æ•´ä¸ªPlaybookä¸­å¯ç”¨ã€‚\n--- - name: Example Playbook hosts: my_hosts vars: variable_name: variable_value tasks: - name: Task using variable debug: var: variable_name å˜é‡ä¹‹é—´ç›¸äº’å¼•ç”¨:\n--- - name: Example Playbook hosts: localhost vars: remote_ip: \"{{ ansible_default_ipv4.address }}\" tasks: - name: Task using variable debug: var: remote_ip 3.7.4 åœ¨å¤–éƒ¨å˜é‡æ–‡ä»¶ä¸­å®šä¹‰å˜é‡ï¼š vars_files ä¸­çš„æ–‡ä»¶è·¯å¾„æ˜¯ç›¸å¯¹äºå½“å‰å·¥ä½œç›®å½•çš„ã€‚å¦‚æœå˜é‡æ–‡ä»¶ä½äº Playbook æ–‡ä»¶çš„åŒä¸€ç›®å½•ä¸­ï¼Œä½ å¯ä»¥ç›´æ¥æä¾›æ–‡ä»¶åï¼Œå¦‚ vars_files: vars.ymlã€‚å¦‚æœåœ¨å…¶ä»–ç›®å½•ä¸­ï¼Œå°±éœ€è¦æä¾›å®Œæ•´çš„ç›¸å¯¹æˆ–ç»å¯¹è·¯å¾„ã€‚\nå°†å˜é‡å­˜å‚¨åœ¨å¤–éƒ¨æ–‡ä»¶ä¸­ï¼Œç„¶ååœ¨Playbookä¸­å¯¼å…¥è¿™äº›å˜é‡ã€‚è¿™åœ¨éœ€è¦å…±äº«å˜é‡çš„å¤šä¸ªPlaybookä¹‹é—´å¾ˆæœ‰ç”¨ã€‚\n--- - name: Example Playbook hosts: my_hosts vars_files: - vars.yml tasks: - name: Task using variable debug: var: variable_name å¤–éƒ¨å˜é‡æ–‡ä»¶ vars.yml çš„å†…å®¹ï¼š\nvariable_name: variable_value 3.7.5 åœ¨ä¸»æœºæ¸…å•ä¸­å®šä¹‰å˜é‡ åœ¨Ansibleä¸­ï¼Œä½ å¯ä»¥ä¸ºä¸»æœºå’Œä¸»æœºç»„å®šä¹‰å˜é‡ï¼Œä»¥ä¾¿åœ¨Playbooksä¸­ä½¿ç”¨è¿™äº›å˜é‡æ¥æ§åˆ¶ä»»åŠ¡çš„è¡Œä¸ºã€‚è¿™æœ‰åŠ©äºå®ç°æ›´çµæ´»çš„é…ç½®å’ŒåŠ¨æ€æ€§ã€‚ä¸‹é¢æ˜¯å…³äºå¦‚ä½•åœ¨Ansibleä¸­ä¸ºä¸»æœºå’Œä¸»æœºç»„å®šä¹‰å˜é‡çš„è¯¦ç»†ä¿¡æ¯ï¼š\nä¸»æœºå˜é‡ï¼š\nä½ å¯ä»¥ä¸ºæ¯ä¸ªå…·ä½“çš„ä¸»æœºå®šä¹‰å˜é‡ï¼Œè¿™äº›å˜é‡åªé€‚ç”¨äºè¯¥ä¸»æœºã€‚åœ¨Ansibleçš„Inventoryæ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯INIæ ¼å¼æˆ–YAMLæ ¼å¼ï¼‰ä¸­ï¼Œä½ å¯ä»¥åƒè¿™æ ·ä¸ºä¸»æœºå®šä¹‰å˜é‡ï¼š\nINIæ ¼å¼ï¼š\n[my_hosts] host1 ansible_ssh_host=192.168.1.1 [my_hosts:vars] some_variable=some_value YAMLæ ¼å¼ï¼š\nmy_hosts: hosts: host1: ansible_ssh_host: 192.168.1.1 vars: some_variable: some_value ä¸»æœºç»„å˜é‡ï¼š\nä½ å¯ä»¥ä¸ºä¸»æœºç»„å®šä¹‰å˜é‡ï¼Œè¿™äº›å˜é‡å°†åº”ç”¨äºè¯¥ä¸»æœºç»„ä¸­çš„æ‰€æœ‰ä¸»æœºã€‚åŒæ ·ï¼Œåœ¨Inventoryæ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥ä¸ºä¸»æœºç»„å®šä¹‰å˜é‡ï¼š\nINIæ ¼å¼ï¼š\n[my_hosts] host1 ansible_ssh_host=192.168.1.1 host2 ansible_ssh_host=192.168.1.2 [my_hosts:vars] some_variable=some_value YAMLæ ¼å¼ï¼š\nmy_hosts: hosts: host1: ansible_ssh_host: 192.168.1.1 host2: ansible_ssh_host: 192.168.1.2 vars: some_variable: some_value ä½¿ç”¨å˜é‡ï¼š\nåœ¨Playbookä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨å®šä¹‰çš„ä¸»æœºå˜é‡å’Œä¸»æœºç»„å˜é‡ã€‚ä¾‹å¦‚ï¼š\n--- - name: Example Playbook hosts: my_hosts tasks: - name: Task using host variable debug: var: hostvars[inventory_hostname]['some_variable'] - name: Task using host group variable debug: var: groupvars['my_hosts']['some_variable'] - name: normal use debug: var: some_variable ä¸Šè¿°ä»£ç ä¸­ï¼Œhostvars[inventory_hostname]['some_variable'] ç”¨äºè®¿é—®ç‰¹å®šä¸»æœºçš„å˜é‡ï¼Œè€Œ groupvars['my_hosts']['some_variable'] ç”¨äºè®¿é—®ä¸»æœºç»„çš„å˜é‡ã€‚\né€šè¿‡è¿™äº›æ–¹æ³•ï¼Œä½ å¯ä»¥åœ¨Ansibleä¸­ä¸ºä¸»æœºå’Œä¸»æœºç»„å®šä¹‰å˜é‡ï¼Œä»è€Œå®ç°æ›´åŠ åŠ¨æ€å’Œå¯é…ç½®çš„Playbooksã€‚\n3.7.6 host_vars å’Œ group_vars åœ¨ Ansible ä¸­ï¼Œhost_vars å’Œ group_vars æ˜¯ç”¨äºç®¡ç†ä¸»æœºå’Œä¸»æœºç»„å˜é‡çš„ç‰¹æ®Šç›®å½•ã€‚è¿™äº›ç›®å½•å…è®¸ä½ åœ¨ä¸åŒçš„çº§åˆ«ä¸ºä¸»æœºå’Œä¸»æœºç»„å®šä¹‰å˜é‡ï¼Œä»¥ä¾¿åœ¨ä½ çš„ Ansible ä»»åŠ¡ä¸­ä½¿ç”¨ã€‚è¿™æ ·ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦ä¸ºä¸åŒçš„ä¸»æœºæˆ–ä¸»æœºç»„é…ç½®ç‰¹å®šçš„å˜é‡å€¼ï¼Œè€Œä¸å¿…åœ¨æ¯ä¸ªä»»åŠ¡ä¸­éƒ½æ‰‹åŠ¨æŒ‡å®šè¿™äº›å€¼ã€‚\nä»¥ä¸‹æ˜¯å…³äº host_vars å’Œ group_vars çš„æ›´è¯¦ç»†ä»‹ç»å’Œä½¿ç”¨æ–¹æ³•ï¼š\n1. host_varsï¼š host_vars ç›®å½•ç”¨äºä¸ºå•ä¸ªä¸»æœºå®šä¹‰å˜é‡ã€‚åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼Œä½ å¯ä»¥ä¸ºæ¯ä¸ªä¸»æœºåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ YAML æ–‡ä»¶ï¼Œæ–‡ä»¶åä¸ä¸»æœºçš„åç§°åŒ¹é…ã€‚è¿™äº›å˜é‡å°†ä»…åº”ç”¨äºç‰¹å®šçš„ä¸»æœºã€‚\nç›®å½•ç»“æ„ç¤ºä¾‹ï¼š\n. â”œâ”€â”€ inventory.ini â”œâ”€â”€ host_vars â”‚ â”œâ”€â”€ server1.yml â”‚ â”œâ”€â”€ server2.yml â”‚ â””â”€â”€ ... â””â”€â”€ group_vars â”œâ”€â”€ group1.yml â”œâ”€â”€ group2.yml â””â”€â”€ ... 2. group_varsï¼š group_vars ç›®å½•ç”¨äºä¸ºä¸»æœºç»„å®šä¹‰å˜é‡ã€‚ä¸»æœºç»„æ˜¯åœ¨ Ansible ä¸»æœºæ¸…å•æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯ inventory.iniï¼‰ä¸­å®šä¹‰çš„ã€‚ä½ å¯ä»¥ä¸ºæ¯ä¸ªä¸»æœºç»„åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ YAML æ–‡ä»¶ï¼Œæ–‡ä»¶åä¸ä¸»æœºç»„çš„åç§°åŒ¹é…ã€‚è¿™äº›å˜é‡å°†åº”ç”¨äºä¸»æœºç»„ä¸­çš„æ‰€æœ‰ä¸»æœºã€‚\nä½¿ç”¨æ–¹æ³•ï¼š\nåœ¨ä½ çš„ Ansible é¡¹ç›®ç›®å½•ä¸­åˆ›å»º host_vars å’Œ group_vars ç›®å½•ã€‚\nåœ¨ host_vars ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ª YAML æ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶å¯¹åº”ä¸€ä¸ªä¸»æœºï¼Œå¹¶åœ¨å…¶ä¸­å®šä¹‰ä½ å¸Œæœ›åœ¨è¿™äº›ä¸»æœºä¸Šä½¿ç”¨çš„å˜é‡ã€‚\nåœ¨ group_vars ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ª YAML æ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶å¯¹åº”ä¸€ä¸ªä¸»æœºç»„ï¼Œå¹¶åœ¨å…¶ä¸­å®šä¹‰ä½ å¸Œæœ›åœ¨è¿™äº›ä¸»æœºç»„ä¸Šä½¿ç”¨çš„å˜é‡ã€‚\nåœ¨ Ansible ä¸»æœºæ¸…å•æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯ inventory.iniï¼‰ä¸­ï¼Œå°†ä¸»æœºåˆ†é…ç»™ç›¸åº”çš„ä¸»æœºç»„ã€‚\nåœ¨ä½ çš„ Ansible ä»»åŠ¡ä¸­ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›å˜é‡ï¼ŒAnsible ä¼šè‡ªåŠ¨åŠ è½½å®ƒä»¬ã€‚\nç¤ºä¾‹ï¼š\nå‡è®¾ä½ æœ‰ä¸¤å°ä¸»æœºï¼šwebserver1 å’Œ webserver2ï¼Œä½ è¿˜æœ‰ä¸€ä¸ªä¸»æœºç»„ï¼šwebserversã€‚ä½ æƒ³è¦ä¸ºæ¯ä¸ªä¸»æœºå’Œä¸»æœºç»„å®šä¹‰ä¸€äº›å˜é‡ã€‚\nhost_vars/webserver1.yml:\n# host_vars/webserver1.yml app_port: 8080 app_env: production host_vars/webserver2.yml:\n# host_vars/webserver2.yml app_port: 8000 app_env: staging group_vars/webservers.yml:\n# group_vars/webservers.yml app_user: webuser app_path: /var/www/app inventory.ini:\n[webservers] webserver1 webserver2 playbook.yml:\n--- - name: Configure web servers hosts: webservers tasks: - name: Display app settings debug: msg: \"App running on port {{ app_port }} with environment {{ app_env }}. User: {{ app_user }} Path: {{ app_path }}\" åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œwebserver1 å’Œ webserver2 åˆ†åˆ«æœ‰å„è‡ªçš„å˜é‡ï¼Œè€Œ webservers ä¸»æœºç»„å…±äº«äº†ç›¸åŒçš„å˜é‡ã€‚åœ¨ä»»åŠ¡ä¸­ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›å˜é‡ï¼ŒAnsible ä¼šå°†å®ƒä»¬ä¸ç›¸åº”çš„ä¸»æœºæˆ–ä¸»æœºç»„å…³è”èµ·æ¥ã€‚\nä½¿ç”¨ host_vars å’Œ group_vars å¯ä»¥ä½¿ä½ çš„ Ansible é¡¹ç›®æ›´æœ‰ç»“æ„ï¼Œæ›´æ˜“äºç»´æŠ¤ï¼Œå› ä¸ºä½ å¯ä»¥å°†å˜é‡ä¸ä¸»æœºå’Œä¸»æœºç»„å…³è”èµ·æ¥ï¼Œè€Œä¸å¿…åœ¨æ¯ä¸ªä»»åŠ¡ä¸­éƒ½é‡å¤å®šä¹‰ã€‚\n3.7.7 register åœ¨ Ansible ä¸­ï¼Œregister æ˜¯ä¸€ä¸ªç”¨äºæ•è·ä»»åŠ¡æ‰§è¡Œç»“æœçš„å…³é”®å­—ã€‚é€šè¿‡ä½¿ç”¨ registerï¼Œä½ å¯ä»¥å°†ä»»åŠ¡çš„è¾“å‡ºã€è¿”å›å€¼æˆ–å…¶ä»–ä¿¡æ¯ä¿å­˜åˆ°ä¸€ä¸ªå˜é‡ä¸­ï¼Œä»¥ä¾¿åç»­ä»»åŠ¡å¯ä»¥ä½¿ç”¨è¿™äº›ä¿¡æ¯ã€‚è¿™åœ¨å¤„ç†ä»»åŠ¡çš„è¾“å‡ºã€é”™è¯¯å¤„ç†å’Œæ¡ä»¶æ‰§è¡Œæ–¹é¢éå¸¸æœ‰ç”¨ã€‚\nä½¿ç”¨æ–¹æ³•ï¼š\nåœ¨ Ansible playbook çš„ä»»åŠ¡ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ register æ¥æ•è·ä»»åŠ¡çš„è¾“å‡ºã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªåŸºæœ¬çš„ç”¨æ³•ç¤ºä¾‹ï¼š\n--- - name: Execute a command hosts: myhosts tasks: - name: Run a command and capture the output command: echo \"Hello, Ansible!\" register: command_output - name: Display the captured output debug: var: command_output.stdout åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œregister: command_output å°†æ•è· echo å‘½ä»¤çš„è¾“å‡ºï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨ command_output å˜é‡ä¸­ã€‚æ¥ä¸‹æ¥çš„ä»»åŠ¡ä½¿ç”¨ debug æ¨¡å—æ¥æ˜¾ç¤ºè¿™ä¸ªå˜é‡çš„å€¼ã€‚\nregister å˜é‡å¯¹è±¡ä¸­åŒ…å«å¤šä¸ªå±æ€§ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦ä½¿ç”¨å®ƒä»¬ã€‚ä¸€äº›å¸¸ç”¨çš„å±æ€§åŒ…æ‹¬ï¼š\nstdoutï¼šæ•è·ä»»åŠ¡çš„æ ‡å‡†è¾“å‡ºå†…å®¹ã€‚ stderrï¼šæ•è·ä»»åŠ¡çš„æ ‡å‡†é”™è¯¯è¾“å‡ºå†…å®¹ã€‚ rcï¼šæ•è·ä»»åŠ¡çš„è¿”å›ä»£ç ï¼ˆé€€å‡ºçŠ¶æ€ç ï¼‰ã€‚ changedï¼šæŒ‡ç¤ºä»»åŠ¡æ˜¯å¦å¯¼è‡´äº†å˜åŒ–ï¼ˆTrue æˆ– Falseï¼‰ã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ›´å¤æ‚çš„ç¤ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•æ ¹æ® register å˜é‡çš„å€¼æ¥æ‰§è¡Œä¸åŒçš„ä»»åŠ¡ï¼š\n--- - name: Check if a file exists hosts: myhosts tasks: - name: Check file existence stat: path: /path/to/file.txt register: file_status - name: Display file status debug: msg: \"File exists: {{ file_status.stat.exists }}\" when: file_status.stat.exists - name: Create the file if it doesn't exist file: path: /path/to/file.txt state: touch when: not file_status.stat.exists åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œé¦–å…ˆä½¿ç”¨ stat æ¨¡å—æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¹¶å°†ç»“æœä¿å­˜åœ¨ file_status å˜é‡ä¸­ã€‚æ¥ä¸‹æ¥çš„ä¸¤ä¸ªä»»åŠ¡æ ¹æ® file_status çš„å€¼æ¥æ‰§è¡Œä¸åŒçš„æ“ä½œï¼šå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œåˆ™æ˜¾ç¤ºä¸€æ¡æ¶ˆæ¯ï¼›å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–‡ä»¶ã€‚\næ€»ä¹‹ï¼Œregister æ˜¯ Ansible ä¸­éå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå¯ä»¥æ•è·ä»»åŠ¡çš„è¾“å‡ºå’ŒçŠ¶æ€ï¼Œå¹¶åœ¨ playbook ä¸­è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ã€åˆ¤æ–­å’Œæ§åˆ¶æµç¨‹ã€‚\n3.8 Jinja2 æ¨¡æ¿çš„ä»‹ç»å’Œä½¿ç”¨ Jinja2 æ˜¯ä¸€ç§æ¨¡æ¿å¼•æ“ï¼Œå¹¿æ³›ç”¨äºå°†åŠ¨æ€å†…å®¹åµŒå…¥é™æ€æ–‡æœ¬ä¸­ï¼Œä¾‹å¦‚åœ¨é…ç½®æ–‡ä»¶ã€æŠ¥å‘Šç”Ÿæˆå’Œæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆç­‰é¢†åŸŸã€‚åœ¨ Ansible ä¸­ï¼ŒJinja2 ç”¨äºå¤„ç†å˜é‡ã€æ¡ä»¶è¯­å¥å’Œå¾ªç¯ï¼Œä»¥ç”ŸæˆåŠ¨æ€çš„é…ç½®æ–‡ä»¶å’Œä»»åŠ¡ã€‚\nåŸºæœ¬æ¦‚å¿µï¼š\nJinja2 æ¨¡æ¿å¼•æ“åŸºäº Pythonï¼Œå®ƒå…è®¸ä½ åœ¨æ–‡æœ¬ä¸­æ’å…¥åŠ¨æ€å€¼ã€æ‰§è¡Œæ¡ä»¶åˆ¤æ–­å’Œå¾ªç¯æ“ä½œã€‚æ¨¡æ¿ä½¿ç”¨åŒå¤§æ‹¬å· {{ }} æ¥è¡¨ç¤ºå˜é‡ï¼Œ{% %} æ¥è¡¨ç¤ºæ§åˆ¶è¯­å¥ï¼Œå¦‚æ¡ä»¶å’Œå¾ªç¯ã€‚\nä½¿ç”¨æ–¹æ³•ï¼š\nä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ Jinja2 æ¨¡æ¿ç”¨æ³•ç¤ºä¾‹ï¼š\n1. æ’å…¥å˜é‡ï¼š\nHello, {{ name }}! è¿™å°†ä¼šå°† name å˜é‡çš„å€¼æ’å…¥åˆ°æ–‡æœ¬ä¸­ã€‚\n2. ä½¿ç”¨æ¡ä»¶è¯­å¥ï¼š\n{% if age \u003e 18 %} You are an adult. {% else %} You are not yet an adult. {% endif %} æ ¹æ®æ¡ä»¶åˆ¤æ–­æ¥æ˜¾ç¤ºä¸åŒçš„æ–‡æœ¬ã€‚\n3. å¾ªç¯ï¼š\n{% for item in items %} - {{ item }} {% endfor %} åœ¨å¾ªç¯ä¸­éå†åˆ—è¡¨ items å¹¶ä¸ºæ¯ä¸ªé¡¹ç›®ç”Ÿæˆæ–‡æœ¬ã€‚\n4. è¿‡æ»¤å™¨ï¼š\n{{ text | upper }} ä½¿ç”¨è¿‡æ»¤å™¨å°†æ–‡æœ¬è½¬æ¢ä¸ºå¤§å†™ã€‚\nåœ¨ Ansible ä¸­çš„åº”ç”¨ï¼š\nåœ¨ Ansible Playbooks å’Œæ¨¡æ¿ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ Jinja2 æ¥åŠ¨æ€ç”Ÿæˆé…ç½®æ–‡ä»¶ã€ä»»åŠ¡å’Œå˜é‡ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥åœ¨é…ç½®æ–‡ä»¶æ¨¡æ¿ä¸­æ’å…¥ä¸»æœºå’Œå˜é‡ä¿¡æ¯ï¼Œç„¶åä½¿ç”¨ Ansible å°†æ¨¡æ¿æ¸²æŸ“ä¸ºå®é™…çš„é…ç½®æ–‡ä»¶ã€‚\nç¤ºä¾‹ï¼š\nå‡è®¾ä½ æœ‰ä¸€ä¸ª web_servers ä¸»æœºç»„ï¼Œå¹¶ä¸”ä½ æƒ³ä¸ºæ¯å°ä¸»æœºç”Ÿæˆä¸€ä¸ª Nginx é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«ä¸»æœºçš„ IP å’Œç«¯å£ä¿¡æ¯ã€‚\nnginx.conf.j2 æ¨¡æ¿æ–‡ä»¶ï¼š\nserver { listen {{ nginx_port }}; server_name {{ ansible_host }}; location / { proxy_pass http://{{ ansible_host }}:{{ app_port }}; } } playbook.yml æ–‡ä»¶ï¼š\n--- - name: Generate Nginx configs hosts: web_servers tasks: - name: Render Nginx config template: src: nginx.conf.j2 dest: /etc/nginx/sites-available/{{ ansible_host }} åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œnginx.conf.j2 æ˜¯ä¸€ä¸ª Jinja2 æ¨¡æ¿æ–‡ä»¶ï¼Œä½¿ç”¨äº†å˜é‡å’Œæ§åˆ¶è¯­å¥æ¥åŠ¨æ€ç”Ÿæˆ Nginx é…ç½®æ–‡ä»¶ã€‚template æ¨¡å—ä¼šå°†æ¨¡æ¿æ¸²æŸ“ä¸ºå®é™…çš„é…ç½®æ–‡ä»¶ï¼Œæ”¾ç½®åœ¨ /etc/nginx/sites-available ç›®å½•ä¸‹ï¼Œæ–‡ä»¶åä¸ä¸»æœºåç›¸åŒã€‚\næ€»ç»“ï¼š\nJinja2 æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ¨¡æ¿å¼•æ“ï¼Œå¯ä»¥åœ¨ Ansible ä¸­ç”¨äºç”ŸæˆåŠ¨æ€å†…å®¹ï¼Œä»è€Œæé«˜é…ç½®ç®¡ç†å’Œè‡ªåŠ¨åŒ–éƒ¨ç½²çš„çµæ´»æ€§å’Œæ•ˆç‡ã€‚é€šè¿‡ä½¿ç”¨ Jinja2ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦å°†å˜é‡ã€æ¡ä»¶å’Œå¾ªç¯åµŒå…¥åˆ°æ–‡æœ¬ä¸­ï¼Œç”Ÿæˆç¬¦åˆè¦æ±‚çš„é…ç½®å’Œä»»åŠ¡ã€‚\n3.9 å¾ªç¯å’Œè¿­ä»£ 3.7.8 loop åœ¨ Ansible ä¸­ï¼Œè¿­ä»£å’Œå¾ªç¯æ˜¯éå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå®ƒä»¬å…è®¸ä½ å¯¹ä¸€ç»„ä¸»æœºæˆ–ä¸€ç»„æ•°æ®æ‰§è¡Œç›¸åŒçš„æ“ä½œã€‚Ansible æä¾›äº†å¤šç§æ–¹æ³•æ¥å®ç°è¿­ä»£å’Œå¾ªç¯ï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„æ–¹æ³•æ˜¯ä½¿ç”¨ loop å…³é”®å­—æˆ– with_* å…³é”®å­—ç³»åˆ—ã€‚\nä»¥ä¸‹æ˜¯ Ansible ä¸­å®ç°è¿­ä»£å’Œå¾ªç¯çš„ä¸€äº›æ–¹æ³•ï¼š\nä½¿ç”¨ loop å…³é”®å­—ï¼š loop å…³é”®å­—å…è®¸ä½ åœ¨ä»»åŠ¡çº§åˆ«å¾ªç¯æ‰§è¡Œä»»åŠ¡ã€‚ä½ å¯ä»¥å°†å…¶ä¸ items å‚æ•°ç»“åˆä½¿ç”¨ï¼Œä¼ é€’ä¸€ä¸ªåˆ—è¡¨æˆ–å­—å…¸ï¼Œç„¶ååœ¨æ¯æ¬¡è¿­ä»£ä¸­è®¿é—®è¯¥åˆ—è¡¨æˆ–å­—å…¸çš„å…ƒç´ ã€‚\n- name: Loop example debug: msg: \"Item: {{ item }}\" loop: - item1 - item2 - item3 ä½¿ç”¨ with_itemsï¼š åœ¨æ—§ç‰ˆæœ¬çš„ Ansible ä¸­ï¼Œä½ å¯èƒ½ä¼šçœ‹åˆ° with_items å…³é”®å­—ï¼Œå®ƒåœ¨è¾ƒæ–°ç‰ˆæœ¬ä¸­å·²è¢« loop æ›¿ä»£ï¼ˆansible 2.5+ï¼‰ï¼Œä½†åœ¨ä¸€äº›æ—§ä»£ç ä¸­ä»ç„¶å¯èƒ½ä¼šä½¿ç”¨ã€‚\n- name: Loop example (with_items) debug: msg: \"Item: {{ item }}\" with_items: - item1 - item2 - item3 ä½¿ç”¨å…¶ä»– with_* å…³é”®å­—ï¼š Ansible æä¾›äº†å¤šä¸ª with_* å…³é”®å­—ï¼Œä¾‹å¦‚ with_dictã€with_fileglobã€with_sequence ç­‰ï¼Œç”¨äºåœ¨ä¸åŒæƒ…å†µä¸‹è¿›è¡Œå¾ªç¯æ“ä½œã€‚\n- name: Looping with a dictionary debug: msg: \"Key: {{ item.key }}, Value: {{ item.value }}\" with_dict: key1: value1 key2: value2 key3: value3 è¿™äº›ç¤ºä¾‹åªæ˜¯ä»‹ç»äº† Ansible ä¸­è¿­ä»£å’Œå¾ªç¯çš„åŸºæœ¬æ¦‚å¿µã€‚ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦ï¼Œç»“åˆ Ansible çš„æ¨¡å—å’ŒåŠŸèƒ½ï¼Œæ›´å¤æ‚åœ°å®ç°è¿­ä»£å’Œå¾ªç¯æ“ä½œã€‚æ— è®ºä½ æ˜¯åœ¨å¤„ç†ä¸»æœºè¿˜æ˜¯æ•°æ®é›†ï¼Œè¿­ä»£å’Œå¾ªç¯éƒ½èƒ½å¸®åŠ©ä½ æ›´é«˜æ•ˆåœ°ç®¡ç†å’Œé…ç½®ç³»ç»Ÿã€‚\n3.7.9 until åœ¨Ansibleä¸­ï¼Œâ€œuntilâ€ æ˜¯ä¸€ä¸ªç”¨äºæ§åˆ¶å¾ªç¯æ‰§è¡Œä»»åŠ¡çš„å…³é”®å­—ã€‚å®ƒé€šå¸¸ä¸ â€œregisterâ€ï¼ˆç”¨äºå­˜å‚¨ä»»åŠ¡æ‰§è¡Œç»“æœï¼‰å’Œä¸€äº›æ¡ä»¶ä¸€èµ·ä½¿ç”¨ï¼Œä»¥ä¾¿åœ¨æ»¡è¶³ç‰¹å®šæ¡ä»¶ä¹‹å‰é‡å¤æ‰§è¡ŒæŸä¸ªä»»åŠ¡ã€‚â€œuntilâ€ çš„ä¸»è¦ä½œç”¨æ˜¯å…è®¸ä»»åŠ¡åœ¨è¾¾åˆ°é¢„æœŸçŠ¶æ€ä¹‹å‰é‡è¯•ï¼Œç›´åˆ°æ»¡è¶³ç‰¹å®šæ¡ä»¶ä¸ºæ­¢ã€‚\nä»¥ä¸‹æ˜¯ â€œuntilâ€ å…³é”®å­—çš„åŸºæœ¬è¯­æ³•ï¼š\n- name: Retry a task until a condition is met some_module: # Replace with the actual module you're using # module arguments... register: result # Store the task execution result in the 'result' variable until: result is success # The condition to check, can be customized based on the task result retries: 10 # Number of times to retry the task delay: 10 # Time (in seconds) to wait between retries åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œâ€œsome_moduleâ€ æ˜¯è¦æ‰§è¡Œçš„ä»»åŠ¡æ¨¡å—ï¼Œâ€œresultâ€ æ˜¯ç”¨äºå­˜å‚¨ä»»åŠ¡æ‰§è¡Œç»“æœçš„å˜é‡ã€‚é€šè¿‡ â€œuntilâ€ å…³é”®å­—ï¼Œä½ å¯ä»¥æŒ‡å®šä¸€ä¸ªæ¡ä»¶æ¥æ£€æŸ¥ä»»åŠ¡æ‰§è¡Œç»“æœæ˜¯å¦æ»¡è¶³é¢„æœŸã€‚å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œä»»åŠ¡å°†åœ¨ â€œretriesâ€ æ¬¡æ•°å†…é‡å¤æ‰§è¡Œï¼Œæ¯æ¬¡é‡è¯•ä¹‹é—´ä¼šç­‰å¾… â€œdelayâ€ ç§’ã€‚\nè¿™æ˜¯ä¸€ä¸ªæ›´å…·ä½“çš„ç¤ºä¾‹ï¼Œå‡è®¾ä½ è¦ç­‰å¾…æŸä¸ªæœåŠ¡å¯åŠ¨æˆåŠŸåæ‰ç»§ç»­æ‰§è¡Œåç»­ä»»åŠ¡ï¼š\n- name: Start the service systemd: name: my-service state: started register: service_result - name: Wait for the service to be up wait_for: host: localhost port: 8080 until: service_result is success retries: 10 delay: 5 åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œé¦–å…ˆä½¿ç”¨ â€œsystemdâ€ æ¨¡å—å¯åŠ¨äº†ä¸€ä¸ªåä¸º â€œmy-serviceâ€ çš„æœåŠ¡ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ â€œservice_resultâ€ å˜é‡ä¸­ã€‚æ¥ä¸‹æ¥ï¼Œä½¿ç”¨ â€œwait_forâ€ æ¨¡å—ç­‰å¾… localhost çš„ 8080 ç«¯å£å¼€æ”¾ï¼Œç›´åˆ° â€œservice_resultâ€ å˜é‡çš„å€¼å˜ä¸º â€œsuccessâ€ï¼Œæˆ–è€…è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ä¸ºæ­¢ã€‚\nè¯·æ³¨æ„ï¼Œâ€œuntilâ€ å¹¶ä¸æ˜¯æ‰€æœ‰Ansibleæ¨¡å—éƒ½æ”¯æŒçš„å‚æ•°ï¼Œåªæœ‰éƒ¨åˆ†æ¨¡å—ï¼ˆå¦‚ â€œwait_forâ€ã€â€œcommandâ€ ç­‰ï¼‰å…è®¸åœ¨ä»»åŠ¡çº§åˆ«ä½¿ç”¨ â€œuntilâ€ æ¥æ‰§è¡Œæ¡ä»¶åˆ¤æ–­å’Œå¾ªç¯æ“ä½œã€‚\n3.7.10 with_lines åœ¨ Ansible ä¸­ï¼Œwith_lines æ˜¯ä¸€ä¸ªç”¨äºåœ¨ä»»åŠ¡ä¸­éå†æ–‡æœ¬è¡Œçš„å¾ªç¯æ„é€ ã€‚å®ƒå…è®¸ä½ å°†æ¯ä¸€è¡Œä½œä¸ºä¸€ä¸ªè¿­ä»£é¡¹ï¼Œä»¥ä¾¿åœ¨æ¯æ¬¡è¿­ä»£ä¸­æ‰§è¡Œä»»åŠ¡ã€‚\nä»¥ä¸‹æ˜¯ with_lines çš„åŸºæœ¬è¯­æ³•ï¼š\n- name: Perform tasks with each line of a file some_module: # Replace with the actual module you're using # module arguments... with_lines: - /path/to/file.txt # Path to the file containing lines to iterate over åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œsome_module æ˜¯è¦æ‰§è¡Œçš„ä»»åŠ¡æ¨¡å—ï¼Œ/path/to/file.txt æ˜¯åŒ…å«è¦è¿­ä»£çš„æ–‡æœ¬è¡Œçš„æ–‡ä»¶çš„è·¯å¾„ã€‚\nè¿™æ˜¯ä¸€ä¸ªæ›´å…·ä½“çš„ç¤ºä¾‹ï¼Œå‡è®¾ä½ æœ‰ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«ä¸€äº›IPåœ°å€ï¼Œä½ æƒ³ä½¿ç”¨ ping å‘½ä»¤å¯¹æ¯ä¸ªIPåœ°å€æ‰§è¡Œç½‘ç»œè¿æ¥æµ‹è¯•ï¼š\n- name: Ping each IP address from a file ping: with_lines: - /path/to/ip_addresses.txt åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œping æ¨¡å—å°†ä¼šå¯¹æ–‡ä»¶ /path/to/ip_addresses.txt ä¸­çš„æ¯ä¸ªIPåœ°å€æ‰§è¡Œç½‘ç»œè¿æ¥æµ‹è¯•ã€‚Ansibleä¼šå°†æ–‡ä»¶çš„æ¯ä¸€è¡Œä½œä¸ºä¸€ä¸ªè¿­ä»£é¡¹ä¼ é€’ç»™ ping æ¨¡å—ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œwith_lines åœ¨å¤„ç†å¤§å‹æ–‡ä»¶æ—¶å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºå®ƒéœ€è¦ä¸€æ¬¡æ€§è¯»å–æ•´ä¸ªæ–‡ä»¶å¹¶å°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚å¦‚æœæ–‡ä»¶è¾ƒå¤§ï¼Œä½ å¯èƒ½éœ€è¦è€ƒè™‘ä½¿ç”¨æ›´é€‚åˆçš„æ–¹æ³•ï¼Œä¾‹å¦‚å°†æ–‡ä»¶å†…å®¹å­˜å‚¨åœ¨å˜é‡ä¸­ï¼Œç„¶åä½¿ç”¨å¾ªç¯ç»“æ„éå†å˜é‡ã€‚\nå¦å¤–ï¼Œä» Ansible 2.5 ç‰ˆæœ¬å¼€å§‹ï¼Œwith_lines å·²è¢«å¼ƒç”¨ï¼Œå»ºè®®ä½¿ç”¨ loop æ„é€ ä»£æ›¿ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ loop æ¥å®Œæˆä¸Šè¿°ç¤ºä¾‹ï¼š\n- name: Ping each IP address from a file ping: loop: \"{{ lookup('file', '/path/to/ip_addresses.txt').splitlines() }}\" åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œlookup('file', '/path/to/ip_addresses.txt').splitlines() å°†ä¼šè¯»å–æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œå¹¶ä½¿ç”¨æ¢è¡Œç¬¦å°†å…¶æ‹†åˆ†ä¸ºè¡Œçš„åˆ—è¡¨ï¼Œç„¶åä½¿ç”¨ loop å¯¹æ¯ä¸ªIPåœ°å€æ‰§è¡Œ ping æ¨¡å—ã€‚è¿™ç§æ–¹æ³•æ›´ä¸ºçµæ´»ä¸”ä¸ä¼šä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ªæ–‡ä»¶ã€‚\n3.10 æ¡ä»¶åˆ¤æ–­ when åœ¨ Ansible ä¸­ï¼Œwhen æ˜¯ä¸€ä¸ªæ¡ä»¶è¯­å¥ï¼Œå®ƒå…è®¸ä½ åœ¨ä»»åŠ¡æ‰§è¡Œä¹‹å‰æŒ‡å®šä¸€ä¸ªæ¡ä»¶ï¼Œåªæœ‰å½“æ¡ä»¶æ»¡è¶³æ—¶ï¼Œä»»åŠ¡æ‰ä¼šè¢«æ‰§è¡Œã€‚è¿™å¯ä»¥ç”¨äºæ ¹æ®ä¸åŒçš„æƒ…å†µæ¥å†³å®šæ˜¯å¦è·³è¿‡æˆ–æ‰§è¡ŒæŸä¸ªä»»åŠ¡ã€‚\nä»¥ä¸‹æ˜¯ when çš„åŸºæœ¬è¯­æ³•ï¼š\n- name: Perform a task conditionally some_module: # Replace with the actual module you're using # module arguments... when: condition # The condition to check before executing the task åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œsome_module æ˜¯è¦æ‰§è¡Œçš„ä»»åŠ¡æ¨¡å—ï¼Œcondition æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œåªæœ‰åœ¨è¡¨è¾¾å¼è¯„ä¼°ä¸º true æ—¶ï¼Œä»»åŠ¡æ‰ä¼šè¢«æ‰§è¡Œã€‚\nè¿™æ˜¯ä¸€ä¸ªæ›´å…·ä½“çš„ç¤ºä¾‹ï¼Œå‡è®¾ä½ åªæƒ³åœ¨æ“ä½œç³»ç»Ÿæ˜¯ Ubuntu æ—¶æ‰æ‰§è¡Œç‰¹å®šçš„ä»»åŠ¡ï¼š\n- name: Install a package only on Ubuntu apt: name: some-package state: present when: ansible_distribution == 'Ubuntu' åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œapt æ¨¡å—ç”¨äºå®‰è£…è½¯ä»¶åŒ…ï¼Œä½†æ˜¯åªæœ‰å½“ Ansible å˜é‡ ansible_distribution çš„å€¼ä¸º â€˜Ubuntuâ€™ æ—¶ï¼Œä»»åŠ¡æ‰ä¼šè¢«æ‰§è¡Œã€‚\nwhen è¡¨è¾¾å¼å¯ä»¥æ˜¯ Ansible å˜é‡ã€äº‹å®ï¼ˆfactsï¼‰ã€æ¯”è¾ƒæ“ä½œã€é€»è¾‘è¿ç®—ç­‰ã€‚ä½ å¯ä»¥æ ¹æ®éœ€è¦æ¥åˆ›å»ºå¤æ‚çš„æ¡ä»¶æ¥å†³å®šä»»åŠ¡æ˜¯å¦åº”è¯¥è¢«æ‰§è¡Œã€‚ä¾‹å¦‚ï¼š\n- name: Perform a task only if a certain variable is true some_module: # module arguments... when: my_variable == true - name: Perform a task only if a file exists some_module: # module arguments... when: ansible_facts['file_exists'] == true - name: Perform a task only if multiple conditions are true some_module: # module arguments... when: ansible_os_family == 'Debian' and ansible_distribution_version | version_compare('9', '\u003e=') è¯·æ³¨æ„ï¼Œwhen æ˜¯ä¸€ä¸ªåœ¨ä»»åŠ¡çº§åˆ«ä½¿ç”¨çš„å‚æ•°ï¼Œå®ƒé€‚ç”¨äºå•ä¸ªä»»åŠ¡ã€‚å¦‚æœä½ å¸Œæœ›åœ¨å‰§æœ¬ï¼ˆplaybookï¼‰çº§åˆ«ä¸Šè®¾ç½®æ¡ä»¶ï¼Œå¯ä»¥åœ¨æ¯ä¸ªä»»åŠ¡ä¸­ä½¿ç”¨ block ç»“æ„ï¼Œç„¶ååœ¨ block ç»“æ„ä¸Šä½¿ç”¨ when æ¡ä»¶ã€‚\n3.11 åˆ†ç»„ block åœ¨ Ansible ä¸­ï¼Œblock æ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºä»»åŠ¡å—çš„ç»“æ„ã€‚å®ƒå…è®¸ä½ å°†å¤šä¸ªç›¸å…³çš„ä»»åŠ¡ç»„ç»‡åœ¨ä¸€èµ·ï¼Œä»¥ä¾¿åœ¨å…¶ä¸­åº”ç”¨å…±åŒçš„æ¡ä»¶ã€å¤„ç†é”™è¯¯ä»¥åŠè®¾ç½®é€šç”¨çš„å‚æ•°ã€‚block å¯ä»¥ä¸ rescue å’Œ always é…åˆä½¿ç”¨ï¼Œä»¥æä¾›æ›´ä¸°å¯Œçš„ä»»åŠ¡æ§åˆ¶å’Œé”™è¯¯å¤„ç†èƒ½åŠ›ã€‚\nä»¥ä¸‹æ˜¯ block ç»“æ„çš„åŸºæœ¬è¯­æ³•ï¼š\n- name: A playbook with a block hosts: target_hosts tasks: - block: # Start of the block - name: Task 1 some_module: # module arguments... - name: Task 2 some_module: # module arguments... rescue: # Optional, tasks to run if an error occurs within the block - name: Rescue task some_module: # module arguments... always: # Optional, tasks to run regardless of success or failure - name: Always task some_module: # module arguments... åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œblock ç»“æ„å†…åŒ…å«ä¸¤ä¸ªä»»åŠ¡ï¼ˆTask 1 å’Œ Task 2ï¼‰ã€‚å¦‚æœ block ç»“æ„å†…çš„ä»»åŠ¡ä¸­çš„ä»»ä½•ä¸€ä¸ªå¤±è´¥ï¼Œé‚£ä¹ˆ rescue éƒ¨åˆ†çš„ä»»åŠ¡å°†ä¼šè¢«æ‰§è¡Œã€‚æ— è®º block ç»“æ„å†…çš„ä»»åŠ¡æˆåŠŸä¸å¦ï¼Œalways éƒ¨åˆ†çš„ä»»åŠ¡éƒ½ä¼šè¢«æ‰§è¡Œã€‚\nä»¥ä¸‹æ˜¯ä¸€ä¸ªæ›´å…·ä½“çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº† block ç»“æ„å¦‚ä½•ä¸é”™è¯¯å¤„ç†å’Œæ¡ä»¶ä¸€èµ·ä½¿ç”¨ï¼š\n- name: Install a package with error handling hosts: target_hosts tasks: - block: - name: Install the package apt: name: some-package state: present rescue: - name: Handle error debug: msg: \"An error occurred while installing the package.\" always: - name: Clean up apt: name: some-package state: absent åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œblock ç»“æ„å†…çš„ä»»åŠ¡å°è¯•å®‰è£…ä¸€ä¸ªè½¯ä»¶åŒ…ã€‚å¦‚æœå®‰è£…è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œrescue éƒ¨åˆ†çš„ä»»åŠ¡ä¼šè¢«æ‰§è¡Œï¼Œæ˜¾ç¤ºä¸€æ¡é”™è¯¯æ¶ˆæ¯ã€‚æ— è®ºæ˜¯å¦å‡ºç°é”™è¯¯ï¼Œalways éƒ¨åˆ†çš„ä»»åŠ¡éƒ½ä¼šè¢«æ‰§è¡Œï¼Œç¡®ä¿æœ€ç»ˆå°†è½¯ä»¶åŒ…ä»ç³»ç»Ÿä¸­ç§»é™¤ã€‚\nä½¿ç”¨ block ç»“æ„å¯ä»¥ä½¿å‰§æœ¬æ›´å…·å¯è¯»æ€§ï¼Œå‡å°‘å†—ä½™ä»£ç ï¼Œå¹¶æä¾›æ›´å¥½çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œå› ä¸ºä½ å¯ä»¥é›†ä¸­ç®¡ç†é”™è¯¯çš„å¤„ç†æ–¹å¼ã€‚\n3.12 changed_when å½“ç¡®å®šæŸä¸ª task ä¸ä¼šå¯¹è¢«æ§åˆ¶ç«¯åšä¿®æ”¹æ—¶ä½†æ‰§è¡Œç»“æœå´æ˜¾ç¤ºæ˜¯é»„è‰²çš„ changed çŠ¶æ€, å¯ä»¥é€šè¿‡changed_when: false å…³é—­ changed çŠ¶æ€\nåœ¨ Ansible ä¸­ï¼Œchanged_when æ˜¯ä¸€ä¸ªç”¨äºæ§åˆ¶ä»»åŠ¡æ˜¯å¦è¢«æ ‡è®°ä¸ºå·²æ›´æ”¹ï¼ˆchangedï¼‰çš„é€‰é¡¹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä»»åŠ¡æ‰§è¡Œå¯¼è‡´äº†ä»»ä½•çŠ¶æ€æ›´æ”¹ï¼Œè¯¥ä»»åŠ¡å°†è¢«æ ‡è®°ä¸ºå·²æ›´æ”¹ã€‚ç„¶è€Œï¼Œé€šè¿‡ä½¿ç”¨ changed_whenï¼Œä½ å¯ä»¥è‡ªå®šä¹‰æ ‡è®°ä»»åŠ¡æ˜¯å¦å·²æ›´æ”¹çš„æ¡ä»¶ï¼Œè€Œä¸ä»…ä»…ä¾èµ–äºé»˜è®¤çš„çŠ¶æ€å˜åŒ–æ£€æµ‹ã€‚\nchanged_when å…è®¸ä½ åœ¨ä»»åŠ¡çº§åˆ«è®¾ç½®ä¸€ä¸ªæ¡ä»¶è¡¨è¾¾å¼ã€‚å¦‚æœè¯¥è¡¨è¾¾å¼è¯„ä¼°ä¸º trueï¼Œé‚£ä¹ˆä»»åŠ¡å°†è¢«æ ‡è®°ä¸ºå·²æ›´æ”¹ã€‚å¦‚æœè¯¥è¡¨è¾¾å¼è¯„ä¼°ä¸º falseï¼Œé‚£ä¹ˆä»»åŠ¡å°†è¢«æ ‡è®°ä¸ºæœªæ›´æ”¹ã€‚\nä»¥ä¸‹æ˜¯ changed_when çš„åŸºæœ¬è¯­æ³•ï¼š\n- name: Task with custom change condition some_module: # Replace with the actual module you're using # module arguments... changed_when: condition_expression åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œsome_module æ˜¯è¦æ‰§è¡Œçš„ä»»åŠ¡æ¨¡å—ï¼Œcondition_expression æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰æ¡ä»¶è¡¨è¾¾å¼ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦å°†ä»»åŠ¡æ ‡è®°ä¸ºå·²æ›´æ”¹ã€‚\nè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ changed_when æ§åˆ¶ä»»åŠ¡æ˜¯å¦è¢«æ ‡è®°ä¸ºå·²æ›´æ”¹ï¼š\n- name: Run a command and control changed status command: echo \"Hello, world!\" register: command_output changed_when: \"command_output.stdout != 'Hello, world!\\n'\" åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œcommand æ¨¡å—æ‰§è¡Œä¸€ä¸ªå‘½ä»¤æ¥è¾“å‡º â€œHello, world!\"ï¼Œå¹¶å°†è¾“å‡ºç»“æœå­˜å‚¨åœ¨ command_output å˜é‡ä¸­ã€‚é€šè¿‡ä½¿ç”¨ changed_whenï¼Œæˆ‘ä»¬æŒ‡å®šäº†ä¸€ä¸ªæ¡ä»¶è¡¨è¾¾å¼ï¼Œåªæœ‰å½“å‘½ä»¤çš„è¾“å‡ºä¸ç­‰äº â€œHello, world!\\nâ€ æ—¶ï¼Œè¯¥ä»»åŠ¡æ‰ä¼šè¢«æ ‡è®°ä¸ºå·²æ›´æ”¹ã€‚\né€šè¿‡ä½¿ç”¨ changed_whenï¼Œä½ å¯ä»¥æ›´ç²¾ç¡®åœ°æ§åˆ¶ä»»åŠ¡çš„æ›´æ”¹çŠ¶æ€ï¼Œè€Œä¸å—é»˜è®¤çŠ¶æ€å˜åŒ–æ£€æµ‹çš„é™åˆ¶ã€‚è¿™åœ¨æŸäº›æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ï¼Œç‰¹åˆ«æ˜¯å½“ä»»åŠ¡çš„çŠ¶æ€å˜åŒ–å¯èƒ½ä¸ç›´æ¥ä¸è¾“å‡ºç»“æœç›¸å…³æ—¶ã€‚\n3.13 æ»šåŠ¨æ‰§è¡Œ serial æ»šåŠ¨æ‰§è¡Œï¼ˆRolling Deploymentï¼‰æ˜¯ä¸€ç§è½¯ä»¶éƒ¨ç½²ç­–ç•¥ï¼Œç”¨äºå°†æ–°ç‰ˆæœ¬çš„è½¯ä»¶é€æ­¥éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å°†æ‰€æœ‰å®ä¾‹éƒ½æ›´æ–°ä¸ºæ–°ç‰ˆæœ¬ã€‚è¿™ç§éƒ¨ç½²ç­–ç•¥æ—¨åœ¨å‡å°‘é£é™©ï¼Œç¡®ä¿ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œç¨³å®šæ€§ï¼Œå› ä¸ºå¦‚æœåœ¨å…¨é¢éƒ¨ç½²æ–°ç‰ˆæœ¬åå‡ºç°é—®é¢˜ï¼Œå¯èƒ½ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿã€‚\nåœ¨æ»šåŠ¨æ‰§è¡Œä¸­ï¼Œæ–°ç‰ˆæœ¬çš„è½¯ä»¶ä¼šé¦–å…ˆéƒ¨ç½²åˆ°ä¸€å°éƒ¨åˆ†æœåŠ¡å™¨ï¼ˆé€šå¸¸æ˜¯ä¸€ç»„ï¼‰ä¸Šï¼Œç„¶åè¿›è¡Œæµ‹è¯•å’ŒéªŒè¯ã€‚ä¸€æ—¦æ–°ç‰ˆæœ¬åœ¨è¿™äº›æœåŠ¡å™¨ä¸Šå¾—åˆ°ç¡®è®¤ï¼Œå°±ä¼šé€æ­¥å°†æ–°ç‰ˆæœ¬åº”ç”¨äºå…¶ä»–æœåŠ¡å™¨ï¼Œé€æ­¥å¢åŠ æœåŠ¡å™¨æ•°é‡ï¼Œç›´åˆ°æ‰€æœ‰æœåŠ¡å™¨éƒ½å®Œæˆäº†å‡çº§ã€‚\nåœ¨ Ansible ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ç¼–å†™é€‚å½“çš„å‰§æœ¬ï¼ˆplaybookï¼‰å’Œä»»åŠ¡ï¼Œä»¥åŠä½¿ç”¨ serial å‚æ•°æ¥å®ç°æ»šåŠ¨æ‰§è¡Œã€‚serial å‚æ•°å…è®¸ä½ æŒ‡å®šæ¯æ¬¡åœ¨å¤šå°‘ä¸ªç›®æ ‡ä¸»æœºä¸Šè¿è¡Œä»»åŠ¡ã€‚è¿™ä½¿å¾—ä½ å¯ä»¥æ§åˆ¶åœ¨ä¸€æ¬¡éƒ¨ç½²ä¸­é€æ­¥æ›´æ–°å¤šå°‘å°ä¸»æœºã€‚\nä»¥ä¸‹æ˜¯ä½¿ç”¨ Ansible å®ç°æ»šåŠ¨æ‰§è¡Œçš„ç¤ºä¾‹ï¼š\n- name: Rolling deployment with Ansible hosts: target_hosts serial: 2 # Number of hosts to update simultaneously in each batch tasks: - name: Deploy new version some_module: # Replace with the actual module you're using # module arguments... åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œserial: 2 è¡¨ç¤ºæ¯æ¬¡å°†åŒæ—¶åœ¨ä¸¤å°ç›®æ ‡ä¸»æœºä¸Šè¿è¡Œä»»åŠ¡ã€‚è¿™ä¼šä½¿å¾—æ¯æ¬¡éƒ¨ç½²åªæ›´æ–°ä¸¤å°ä¸»æœºï¼Œç„¶åé€æ­¥å¢åŠ æ›´æ–°æ•°é‡ï¼Œç›´åˆ°æ‰€æœ‰ç›®æ ‡ä¸»æœºéƒ½å®Œæˆå‡çº§ã€‚\nè¯·æ³¨æ„ï¼Œå®é™…çš„æ»šåŠ¨æ‰§è¡Œç­–ç•¥å¯èƒ½å› ç»„ç»‡çš„éœ€æ±‚å’Œåº”ç”¨ç¨‹åºçš„ç‰¹æ€§è€Œæœ‰æ‰€ä¸åŒã€‚ä½ å¯ä»¥æ ¹æ®å®é™…æƒ…å†µæ¥è°ƒæ•´ serial å‚æ•°çš„å€¼ä»¥åŠéƒ¨ç½²ä»»åŠ¡çš„å…¶ä»–å‚æ•°ï¼Œä»¥æ»¡è¶³ä½ çš„éƒ¨ç½²ç­–ç•¥å’Œå¯ç”¨æ€§è¦æ±‚ã€‚\n3.14 delegate_to åœ¨ Ansible ä¸­ï¼Œdelegate_to æ˜¯ä¸€ä¸ªç”¨äºæŒ‡å®šä»»åŠ¡åº”è¯¥åœ¨å“ªä¸ªè¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œçš„å‚æ•°ã€‚é€šè¿‡ä½¿ç”¨ delegate_toï¼Œä½ å¯ä»¥å°†ä»»åŠ¡å§”æ‰˜ç»™ä¸€ä¸ªç‰¹å®šçš„ä¸»æœºæ‰§è¡Œï¼Œè€Œä¸æ˜¯é»˜è®¤åœ¨ç›®æ ‡ä¸»æœºä¸Šæ‰§è¡Œã€‚\nè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ delegate_to å°†ä»»åŠ¡å§”æ‰˜ç»™å¦ä¸€ä¸ªä¸»æœºæ‰§è¡Œï¼š\n- name: Run a task on a specific host command: echo \"This task runs on a different host\" delegate_to: specific_host åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œcommand æ¨¡å—å°†æ‰§è¡Œ echo å‘½ä»¤ï¼Œä½†æ˜¯ä»»åŠ¡ä¼šè¢«å§”æ‰˜ç»™ specific_host æ‰§è¡Œï¼Œè€Œä¸æ˜¯é»˜è®¤çš„ç›®æ ‡ä¸»æœºã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œdelegate_to å‚æ•°é€šå¸¸ç”¨äºç‰¹å®šçš„æƒ…å†µï¼Œä¾‹å¦‚éœ€è¦åœ¨ç‰¹å®šä¸»æœºä¸Šæ‰§è¡Œä¸€äº›é…ç½®ç®¡ç†ä»»åŠ¡ã€æ”¶é›†ä¿¡æ¯æˆ–æ‰§è¡ŒæŸäº›æ•…éšœæ’é™¤æ“ä½œæ—¶ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä»»åŠ¡å°†åœ¨ç›®æ ‡ä¸»æœºä¸Šæ‰§è¡Œï¼Œè€Œä¸éœ€è¦ä½¿ç”¨ delegate_toã€‚\n3.15 run_onece åœ¨ Ansible ä¸­ï¼Œrun_once æ˜¯ä¸€ä¸ªç”¨äºæ§åˆ¶ä»»åŠ¡æ˜¯å¦ä»…åœ¨ä¸€ä¸ªä¸»æœºä¸Šè¿è¡Œçš„å‚æ•°ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒAnsible ä¼šåœ¨ç›®æ ‡ä¸»æœºä¸Šçš„æ¯ä¸ªä¸»æœºä¸Šè¿è¡Œä»»åŠ¡ã€‚ä½†æ˜¯ï¼Œæœ‰æ—¶ä½ å¯èƒ½åªå¸Œæœ›åœ¨æ‰€æœ‰ç›®æ ‡ä¸»æœºä¸­çš„ä¸€ä¸ªä¸Šè¿è¡Œä»»åŠ¡ï¼Œè€Œä¸æ˜¯åœ¨æ¯ä¸ªä¸»æœºä¸Šéƒ½è¿è¡Œã€‚\nè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ run_once ä½¿ä»»åŠ¡åªåœ¨ä¸€ä¸ªä¸»æœºä¸Šè¿è¡Œï¼š\n- name: Run a task only once command: echo \"This task runs only once\" run_once: true åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œcommand æ¨¡å—ä¼šæ‰§è¡Œ echo å‘½ä»¤ï¼Œä½†æ˜¯è¯¥ä»»åŠ¡åªä¼šåœ¨ç›®æ ‡ä¸»æœºä¸­çš„ä¸€ä¸ªä¸»æœºä¸Šè¿è¡Œã€‚\nä½¿ç”¨ run_once å‚æ•°é€šå¸¸ç”¨äºä¸€äº›åªéœ€åœ¨æ•´ä¸ªå‰§æœ¬ä¸­æ‰§è¡Œä¸€æ¬¡çš„ä»»åŠ¡ï¼Œä¾‹å¦‚æ”¶é›†æ±‡æ€»ä¿¡æ¯æˆ–é…ç½®åˆå§‹åŒ–ã€‚æ³¨æ„ï¼Œrun_once å¹¶ä¸ä¼šå½±å“å…¶ä»–ä»»åŠ¡çš„æ‰§è¡Œæ–¹å¼ï¼Œå…¶ä»–ä»»åŠ¡ä»ç„¶ä¼šåœ¨æ¯ä¸ªç›®æ ‡ä¸»æœºä¸Šè¿è¡Œã€‚\n3.16 ç¯å¢ƒå˜é‡ environment åœ¨ Ansible ä¸­ï¼Œenvironment æ˜¯ä¸€ä¸ªå‚æ•°ï¼Œç”¨äºåœ¨ä»»åŠ¡çº§åˆ«è®¾ç½®ç¯å¢ƒå˜é‡ã€‚é€šè¿‡ä½¿ç”¨ environment å‚æ•°ï¼Œä½ å¯ä»¥ä¸ºä»»åŠ¡è®¾ç½®ç‰¹å®šçš„ç¯å¢ƒå˜é‡ï¼Œè¿™äº›å˜é‡å°†åœ¨ä»»åŠ¡æ‰§è¡ŒæœŸé—´å¯¹å‘½ä»¤ã€è„šæœ¬ç­‰æ“ä½œäº§ç”Ÿå½±å“ã€‚\nè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ environment å‚æ•°è®¾ç½®ç¯å¢ƒå˜é‡ï¼š\n- name: Run a task with custom environment variables command: echo \"VAR1 is $VAR1, VAR2 is $VAR2\" environment: VAR1: value1 VAR2: value2 åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œcommand æ¨¡å—ä¼šæ‰§è¡Œ echo å‘½ä»¤ï¼Œæ‰“å°å‡ºç”± environment å‚æ•°æŒ‡å®šçš„ç¯å¢ƒå˜é‡å€¼ã€‚\nä½¿ç”¨ environment å‚æ•°å¯ä»¥è®©ä½ åœ¨ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­è®¾ç½®ä¸´æ—¶ç¯å¢ƒå˜é‡ï¼Œè¿™å¯¹äºå®šåˆ¶ä»»åŠ¡è¡Œä¸ºã€ä¼ é€’é…ç½®ä¿¡æ¯æˆ–è®¾ç½®æ‰§è¡Œç¯å¢ƒéå¸¸æœ‰ç”¨ã€‚è¿™äº›ç¯å¢ƒå˜é‡åªä¼šåœ¨ä»»åŠ¡æ‰§è¡ŒæœŸé—´ç”Ÿæ•ˆï¼Œä¸ä¼šå½±å“åˆ°å…¶ä»–ä»»åŠ¡æˆ–ç›®æ ‡ä¸»æœºçš„çŠ¶æ€ã€‚\n3.17 include å’Œ import åœ¨ Ansible ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ include å’Œ import è¯­å¥æ¥å®ç° YAML æ–‡ä»¶ä¹‹é—´çš„ç›¸äº’è°ƒç”¨å’Œé‡ç”¨ã€‚è¿™å¯ä»¥å¸®åŠ©ä½ ç»„ç»‡å’Œç®¡ç†å¤§å‹çš„ Ansible å‰§æœ¬ï¼Œä½¿å…¶æ›´åŠ æ¨¡å—åŒ–å’Œæ˜“äºç»´æŠ¤ã€‚\nä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œæ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ include å’Œ import_playbook æ¥å®ç° YAML æ–‡ä»¶ä¹‹é—´çš„ç›¸äº’è°ƒç”¨å’Œé‡ç”¨ã€‚\nå‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹æ–‡ä»¶ç»“æ„ï¼š\nansible_project/ â”œâ”€â”€ main_playbook.yml â”œâ”€â”€ tasks/ â”‚ â”œâ”€â”€ common_tasks.yml â”‚ â”œâ”€â”€ task1.yml â”‚ â””â”€â”€ task2.yml â””â”€â”€ playbooks/ â””â”€â”€ other_playbook.yml main_playbook.yml æ˜¯ä¸»å‰§æœ¬æ–‡ä»¶ï¼Œå®ƒå¼•å…¥äº†å…¶ä»–æ–‡ä»¶å¹¶å®šä¹‰äº†ä¸€äº›ä»»åŠ¡ã€‚ - name: Main Playbook hosts: target_hosts tasks: - include: tasks/common_tasks.yml - include: tasks/task1.yml - include: tasks/task2.yml - import_playbook: playbooks/other_playbook.yml common_tasks.yml æ–‡ä»¶åŒ…å«ä¸€äº›å…¬å…±ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡å¯ä»¥è¢«å¤šä¸ªå‰§æœ¬é‡ç”¨ã€‚ - name: Common Task 1 debug: msg: \"This is a common task.\" - name: Common Task 2 debug: msg: \"Another common task.\" task1.yml æ–‡ä»¶åŒ…å«ç‰¹å®šçš„ä»»åŠ¡ã€‚ - name: Task 1 debug: msg: \"Task 1 is executed.\" task2.yml æ–‡ä»¶ä¹ŸåŒ…å«ç‰¹å®šçš„ä»»åŠ¡ã€‚ - name: Task 2 debug: msg: \"Task 2 is executed.\" other_playbook.yml æ˜¯å¦ä¸€ä¸ªç‹¬ç«‹çš„å‰§æœ¬ã€‚ - name: Other Playbook hosts: other_hosts tasks: - name: Task in Other Playbook debug: msg: \"This task is from another playbook.\" åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œmain_playbook.yml å¼•å…¥äº†å¤šä¸ªæ–‡ä»¶å¹¶å®šä¹‰äº†ä¸€ç³»åˆ—ä»»åŠ¡ã€‚common_tasks.yml åŒ…å«äº†ä¸€äº›å…¬å…±ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡å¯ä»¥åœ¨ä¸»å‰§æœ¬å’Œå…¶ä»–å‰§æœ¬ä¸­é‡ç”¨ã€‚task1.yml å’Œ task2.yml åˆ†åˆ«åŒ…å«ç‰¹å®šçš„ä»»åŠ¡ã€‚other_playbook.yml æ˜¯å¦ä¸€ä¸ªç‹¬ç«‹çš„å‰§æœ¬ï¼Œå®ƒå¯ä»¥è¢«å¯¼å…¥åˆ°ä¸»å‰§æœ¬ä¸­ã€‚\né€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥å°† Ansible ä»£ç æ¨¡å—åŒ–ï¼Œæé«˜å¯ç»´æŠ¤æ€§ï¼Œå¹¶æ ¹æ®éœ€è¦é‡ç”¨ä»»åŠ¡å’Œå‰§æœ¬ã€‚\n4 Ansible Roles Ansible è§’è‰²æ˜¯ä¸€ç§ç”¨äºç»„ç»‡å’Œé‡ç”¨ Ansible ä»£ç çš„ç»“æ„åŒ–æ–¹å¼ã€‚è§’è‰²å…è®¸ä½ å°†ä»»åŠ¡ã€å˜é‡ã€æ¨¡æ¿å’Œå¤„ç†é€»è¾‘ç»„ç»‡æˆä¸€ä¸ªå¯ç‹¬ç«‹è°ƒç”¨çš„å•å…ƒï¼Œä½¿å¾—ä½ èƒ½å¤Ÿæ›´å¥½åœ°ç®¡ç†å¤æ‚çš„å‰§æœ¬å’Œéƒ¨ç½²ã€‚\nè§’è‰²çš„ç»„ç»‡ç»“æ„å¦‚ä¸‹ï¼š\nmy_role/ â”œâ”€â”€ tasks/ â”‚ â”œâ”€â”€ main.yml â”‚ â”œâ”€â”€ task1.yml â”‚ â””â”€â”€ task2.yml â”œâ”€â”€ vars/ â”‚ â””â”€â”€ main.yml â”œâ”€â”€ templates/ â”‚ â”œâ”€â”€ template1.j2 â”‚ â””â”€â”€ template2.j2 â””â”€â”€ meta/ â””â”€â”€ main.yml tasks/ ç›®å½•åŒ…å«ä¸»ä»»åŠ¡æ–‡ä»¶ main.ymlï¼Œä»¥åŠå…¶ä»–ä»»åŠ¡æ–‡ä»¶å¦‚ task1.yml å’Œ task2.ymlï¼Œè¿™äº›æ–‡ä»¶åŒ…å«è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚ vars/ ç›®å½•åŒ…å«å˜é‡æ–‡ä»¶ main.ymlï¼Œè¿™äº›å˜é‡å¯ä»¥åœ¨è§’è‰²ä¸­ä½¿ç”¨ã€‚ templates/ ç›®å½•åŒ…å«æ¨¡æ¿æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶å¯ä»¥åœ¨è§’è‰²ä¸­ä½¿ç”¨ä½œä¸ºé…ç½®æ–‡ä»¶æ¨¡æ¿ã€‚ meta/ ç›®å½•åŒ…å«è§’è‰²å…ƒæ•°æ®æ–‡ä»¶ main.ymlï¼Œå…¶ä¸­åŒ…å«æœ‰å…³è§’è‰²çš„ä¿¡æ¯ï¼Œå¦‚ä½œè€…ã€ä¾èµ–ç­‰ã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•åˆ›å»ºå’Œä½¿ç”¨ Ansible è§’è‰²ã€‚\nåˆ›å»ºä¸€ä¸ªåä¸º my_role çš„è§’è‰²ç›®å½•ç»“æ„ï¼š ansible_project/ â””â”€â”€ roles/ â””â”€â”€ my_role/ â”œâ”€â”€ tasks/ â”‚ â””â”€â”€ main.yml â”œâ”€â”€ vars/ â”‚ â””â”€â”€ main.yml â”œâ”€â”€ templates/ â”‚ â””â”€â”€ template1.j2 â””â”€â”€ meta/ â””â”€â”€ main.yml ç¼–è¾‘ my_role/tasks/main.yml æ–‡ä»¶ï¼Œå®šä¹‰è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼š - name: Task 1 in Role debug: msg: \"Task 1 of my_role is executed.\" - name: Task 2 in Role debug: msg: \"Task 2 of my_role is executed.\" ç¼–è¾‘ my_role/vars/main.yml æ–‡ä»¶ï¼Œå®šä¹‰è§’è‰²å˜é‡ï¼š role_var1: value1 role_var2: value2 ç¼–è¾‘ my_role/templates/template1.j2 æ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶æ¨¡æ¿ï¼š [Section] var1 = {{ role_var1 }} var2 = {{ role_var2 }} ç¼–è¾‘ my_role/meta/main.yml æ–‡ä»¶ï¼Œå®šä¹‰è§’è‰²å…ƒæ•°æ®ï¼š galaxy_info: author: Your Name description: A sample Ansible role license: MIT min_ansible_version: 2.9 platforms: - name: Fedora versions: - all - name: Ubuntu versions: - all åœ¨ä¸»å‰§æœ¬ä¸­ä½¿ç”¨è§’è‰²ï¼š - name: Playbook using the role hosts: target_hosts roles: - my_role åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œmy_role è§’è‰²è¢«å®šä¹‰ä¸ºä¸€ä¸ªç‹¬ç«‹çš„ç›®å½•ï¼Œå…¶ä¸­åŒ…å«äº†ä»»åŠ¡ã€å˜é‡ã€æ¨¡æ¿å’Œå…ƒæ•°æ®ã€‚ä¸»å‰§æœ¬é€šè¿‡ roles éƒ¨åˆ†å¼•ç”¨äº†è¿™ä¸ªè§’è‰²ï¼Œå¹¶åœ¨ç›®æ ‡ä¸»æœºä¸Šæ‰§è¡Œäº†è§’è‰²ä¸­çš„ä»»åŠ¡å’Œæ“ä½œã€‚\nä½¿ç”¨è§’è‰²å¯ä»¥ä½¿ Ansible ä»£ç æ›´åŠ æ¨¡å—åŒ–ã€æ˜“äºç»´æŠ¤å’Œé‡ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤šä¸ªé¡¹ç›®ã€ç¯å¢ƒæˆ–åº”ç”¨ç¨‹åºæ—¶ã€‚\n","wordCount":"29021","inLanguage":"zh","datePublished":"2023-08-28T15:39:37+08:00","dateModified":"2023-08-28T15:39:37+08:00","author":[{"@type":"Person","name":"wz"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://senmer.github.io/zh/posts/tech/ansible/ansible/"},"publisher":{"@type":"Organization","name":"WZ's Blog","logo":{"@type":"ImageObject","url":"https://senmer.github.io/img/Q.gif"}}}</script></head><body id=top><script>(function(){let e,t=new RegExp("(^| )change-themes=([^;]*)(;|$)");(e=document.cookie.match(t))||((new Date).getHours()>=19||(new Date).getHours()<6?(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark")):(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")))})(),localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://senmer.github.io/zh/ accesskey=h title="WZ's Blog (Alt + H)"><img src=https://senmer.github.io/img/Q.gif alt=logo aria-label=logo height=35>WZ's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://senmer.github.io/zh/search title="ğŸ” æœç´¢ (Alt + /)" accesskey=/><span>ğŸ” æœç´¢</span></a></li><li><a href=https://senmer.github.io/zh/ title="ğŸ  ä¸»é¡µ"><span>ğŸ  ä¸»é¡µ</span></a></li><li><a href=https://senmer.github.io/zh/posts/tech title="ğŸ“š æ–‡ç« "><span>ğŸ“š æ–‡ç« </span></a></li><li><a href=https://senmer.github.io/zh/categories/ title="ğŸ§© åˆ†ç±»"><span>ğŸ§© åˆ†ç±»</span></a></li><li><a href=https://senmer.github.io/zh/archives/ title="â±ï¸ æ—¶é—´è½´"><span>â±ï¸ æ—¶é—´è½´</span></a></li><li><a href=https://senmer.github.io/zh/about title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº"><span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span></a></li><li><a href=https://senmer.github.io/zh/links title="ğŸ¤ å‹é“¾"><span>ğŸ¤ å‹é“¾</span></a></li></ul></nav></header><main class="main page"><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}</style><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://senmer.github.io/zh/>ğŸ  ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://senmer.github.io/zh/posts/>ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href=https://senmer.github.io/zh/posts/tech/>ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div><h1 class=post-title>Ansible</h1><div class=post-meta><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}.parent-post-meta{display:flex;flex-wrap:wrap;opacity:.8}</style><span class=parent-post-meta><span id=post_meta_style_1><span class="fa fa-calendar-check-o"></span>
<span>2023-08-28
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_3><span class="fa fa-file-word-o"></span>
<span>29021å­—
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_4><span class="fa fa-clock-o"></span>
<span>58åˆ†é’Ÿ
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_5><span class="fa fa-user-o"></span>
<span>wz
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_6><span class="fa fa-tags" style=opacity:.8></span>
<span><span class=post-tags-meta></span></span></span></span><span style=opacity:.8><span id=post_meta_style_7>&nbsp;&nbsp;
<span class="fa fa-eye"></span>
<span><span id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv></span></span>
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_8><span class="fa fa-commenting-o"></span>
<span><script src=https://cdn.staticfile.org/twikoo/1.6.16/twikoo.all.min.js></script>
<script>let url=document.documentURI,dnsUrl="https://senmer.github.io/",urlSplit=url.split(dnsUrl),finalUrl=urlSplit[1];finalUrl[0]!=="/"&&(finalUrl="/"+finalUrl),twikoo.getCommentsCount({envId:"https://hugo-api-khaki.vercel.app/# å¡«å†™è‡ªå·±çš„twikoo id",region:null,urls:[finalUrl],includeReply:!1}).then(function(e){let t=e[0].count;const n=document.getElementById("comment_count");n.innerText=t}).catch(function(e){console.error(e)})</script><span id=comment_count></span></span></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#1-ansible-%e7%ae%80%e4%bb%8b aria-label="1 Ansible ç®€ä»‹">1 Ansible ç®€ä»‹</a><ul><li><a href=#11-ansible-%e5%8f%91%e5%b1%95%e5%8f%b2 aria-label="1.1 Ansible å‘å±•å²">1.1 Ansible å‘å±•å²</a></li><li><a href=#12-ansible-%e5%8a%9f%e8%83%bd aria-label="1.2 Ansible åŠŸèƒ½">1.2 Ansible åŠŸèƒ½</a></li><li><a href=#13-ansible-%e7%89%b9%e7%82%b9 aria-label="1.3 Ansible ç‰¹ç‚¹">1.3 Ansible ç‰¹ç‚¹</a><ul><li><a href=#131-%e4%bc%98%e7%82%b9 aria-label="1.3.1 ä¼˜ç‚¹">1.3.1 ä¼˜ç‚¹</a></li><li><a href=#132-%e7%bc%ba%e7%82%b9 aria-label="1.3.2 ç¼ºç‚¹">1.3.2 ç¼ºç‚¹</a></li><li><a href=#133-%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9 aria-label="1.3.3 æ³¨æ„äº‹é¡¹">1.3.3 æ³¨æ„äº‹é¡¹</a></li></ul></li></ul></li><li><a href=#2-ansible-%e5%ae%89%e8%a3%85%e5%92%8c%e5%b8%b8%e8%a7%81%e6%a8%a1%e5%9d%97 aria-label="2 Ansible å®‰è£…å’Œå¸¸è§æ¨¡å—">2 Ansible å®‰è£…å’Œå¸¸è§æ¨¡å—</a><ul><li><a href=#21-ansible-%e5%ae%89%e8%a3%85 aria-label="2.1 Ansible å®‰è£…">2.1 Ansible å®‰è£…</a></li><li><a href=#22-ansible-%e7%9b%b8%e5%85%b3%e6%96%87%e4%bb%b6 aria-label="2.2 Ansible ç›¸å…³æ–‡ä»¶">2.2 Ansible ç›¸å…³æ–‡ä»¶</a><ul><li><a href=#221-ansible-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e5%88%97%e8%a1%a8 aria-label="2.2.1 Ansible é…ç½®æ–‡ä»¶åˆ—è¡¨">2.2.1 Ansible é…ç½®æ–‡ä»¶åˆ—è¡¨</a></li><li><a href=#222-ansible-%e4%b8%bb%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-label="2.2.2 Ansible ä¸»é…ç½®æ–‡ä»¶">2.2.2 Ansible ä¸»é…ç½®æ–‡ä»¶</a></li><li><a href=#223-inventory-%e4%b8%bb%e6%9c%ba%e6%b8%85%e5%8d%95%e6%96%87%e4%bb%b6 aria-label="2.2.3 Inventory ä¸»æœºæ¸…å•æ–‡ä»¶">2.2.3 Inventory ä¸»æœºæ¸…å•æ–‡ä»¶</a></li></ul></li><li><a href=#23-ansible-%e7%9b%b8%e5%85%b3%e5%b7%a5%e5%85%b7 aria-label="2.3 Ansible ç›¸å…³å·¥å…·">2.3 Ansible ç›¸å…³å·¥å…·</a><ul><li><a href=#231-ansible-doc aria-label="2.3.1 Ansible-doc">2.3.1 Ansible-doc</a></li><li><a href=#232-ansible aria-label="2.3.2 Ansible">2.3.2 Ansible</a><ul><li><a href=#2321-ansible-ad-hoc aria-label="2.3.2.1 Ansible Ad-Hoc">2.3.2.1 Ansible Ad-Hoc</a></li><li><a href=#2322-ansible-%e5%91%bd%e4%bb%a4%e7%94%a8%e6%b3%95 aria-label="2.3.2.2 Ansible å‘½ä»¤ç”¨æ³•">2.3.2.2 Ansible å‘½ä»¤ç”¨æ³•</a></li><li><a href=#2323-ansible-%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e8%bf%87%e7%a8%8b aria-label="2.3.2.3 Ansible å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹">2.3.2.3 Ansible å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹</a></li><li><a href=#2324-ansible-%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e7%8a%b6%e6%80%81 aria-label="2.3.2.4 Ansible å‘½ä»¤æ‰§è¡ŒçŠ¶æ€">2.3.2.4 Ansible å‘½ä»¤æ‰§è¡ŒçŠ¶æ€</a></li></ul></li><li><a href=#233-ansible-console aria-label="2.3.3 ansible-console">2.3.3 ansible-console</a></li><li><a href=#234-ansible-playbook aria-label="2.3.4 ansible-playbook">2.3.4 ansible-playbook</a></li><li><a href=#235-ansible-vault aria-label="2.3.5 ansible-vault">2.3.5 ansible-vault</a></li><li><a href=#236-ansible-galaxy aria-label="2.3.6 ansible-galaxy">2.3.6 ansible-galaxy</a></li></ul></li><li><a href=#24-ansible-%e5%b8%b8%e7%94%a8%e6%a8%a1%e5%9d%97 aria-label="2.4 Ansible å¸¸ç”¨æ¨¡å—">2.4 Ansible å¸¸ç”¨æ¨¡å—</a><ul><li><a href=#241-command-%e6%a8%a1%e5%9d%97 aria-label="2.4.1 command æ¨¡å—">2.4.1 command æ¨¡å—</a></li><li><a href=#242-shell-%e6%a8%a1%e5%9d%97 aria-label="2.4.2 shell æ¨¡å—">2.4.2 shell æ¨¡å—</a></li><li><a href=#243-script-%e6%a8%a1%e5%9d%97 aria-label="2.4.3 script æ¨¡å—">2.4.3 script æ¨¡å—</a></li><li><a href=#244-copy-%e6%a8%a1%e5%9d%97 aria-label="2.4.4 copy æ¨¡å—">2.4.4 copy æ¨¡å—</a></li><li><a href=#245-get_url-%e6%a8%a1%e5%9d%97 aria-label="2.4.5 get_url æ¨¡å—">2.4.5 get_url æ¨¡å—</a></li><li><a href=#246-fetch-%e6%a8%a1%e5%9d%97 aria-label="2.4.6 fetch æ¨¡å—">2.4.6 fetch æ¨¡å—</a></li><li><a href=#247-file-%e6%a8%a1%e5%9d%97 aria-label="2.4.7 file æ¨¡å—">2.4.7 file æ¨¡å—</a></li><li><a href=#248-stat-%e6%a8%a1%e5%9d%97 aria-label="2.4.8 stat æ¨¡å—">2.4.8 stat æ¨¡å—</a></li><li><a href=#249-unarchive-%e6%a8%a1%e5%9d%97 aria-label="2.4.9 unarchive æ¨¡å—">2.4.9 unarchive æ¨¡å—</a></li><li><a href=#2410-archive-%e6%a8%a1%e5%9d%97 aria-label="2.4.10 archive æ¨¡å—">2.4.10 archive æ¨¡å—</a></li><li><a href=#2411-hostname-%e6%a8%a1%e5%9d%97 aria-label="2.4.11 hostname æ¨¡å—">2.4.11 hostname æ¨¡å—</a></li><li><a href=#2412-cron-%e6%a8%a1%e5%9d%97 aria-label="2.4.12 cron æ¨¡å—">2.4.12 cron æ¨¡å—</a></li><li><a href=#2413-yum-%e5%92%8c-apt-%e6%a8%a1%e5%9d%97 aria-label="2.4.13 yum å’Œ apt æ¨¡å—">2.4.13 yum å’Œ apt æ¨¡å—</a></li><li><a href=#2414-yum_repository aria-label="2.4.14 yum_repository">2.4.14 yum_repository</a></li><li><a href=#2415-service-%e6%a8%a1%e5%9d%97 aria-label="2.4.15 service æ¨¡å—">2.4.15 service æ¨¡å—</a></li><li><a href=#2416-user-%e6%a8%a1%e5%9d%97 aria-label="2.4.16 user æ¨¡å—">2.4.16 user æ¨¡å—</a></li><li><a href=#2417-group-%e6%a8%a1%e5%9d%97 aria-label="2.4.17 group æ¨¡å—">2.4.17 group æ¨¡å—</a></li><li><a href=#2418-lineinfile-%e6%a8%a1%e5%9d%97 aria-label="2.4.18 lineinfile æ¨¡å—">2.4.18 lineinfile æ¨¡å—</a></li><li><a href=#2419-replace-%e6%a8%a1%e5%9d%97 aria-label="2.4.19 replace æ¨¡å—">2.4.19 replace æ¨¡å—</a></li><li><a href=#2420-selinux-%e6%a8%a1%e5%9d%97 aria-label="2.4.20 selinux æ¨¡å—">2.4.20 selinux æ¨¡å—</a></li><li><a href=#2421-reboot-%e6%a8%a1%e5%9d%97 aria-label="2.4.21 reboot æ¨¡å—">2.4.21 reboot æ¨¡å—</a></li><li><a href=#2422-mount-%e6%a8%a1%e5%9d%97 aria-label="2.4.22 mount æ¨¡å—">2.4.22 mount æ¨¡å—</a></li><li><a href=#2423-setup-%e6%a8%a1%e5%9d%97 aria-label="2.4.23 setup æ¨¡å—">2.4.23 setup æ¨¡å—</a></li><li><a href=#2424-debug-%e6%a8%a1%e5%9d%97 aria-label="2.4.24 debug æ¨¡å—">2.4.24 debug æ¨¡å—</a></li><li><a href=#2425-sysctl-%e6%a8%a1%e5%9d%97 aria-label="2.4.25 sysctl æ¨¡å—">2.4.25 sysctl æ¨¡å—</a></li><li><a href=#2426-pam_limits-%e6%a8%a1%e5%9d%97 aria-label="2.4.26 pam_limits æ¨¡å—">2.4.26 pam_limits æ¨¡å—</a></li></ul></li></ul></li><li><a href=#3-ansible-playbook aria-label="3 Ansible Playbook">3 Ansible Playbook</a><ul><li><a href=#31-playbook-%e7%ae%80%e4%bb%8b aria-label="3.1 Playbook ç®€ä»‹">3.1 Playbook ç®€ä»‹</a><ul><li><a href=#311-playbook-%e7%bb%84%e6%88%90 aria-label="3.1.1 Playbook ç»„æˆ">3.1.1 Playbook ç»„æˆ</a></li><li><a href=#212-playbook-%e5%92%8c-ad-hoc-%e5%af%b9%e6%af%94 aria-label="2.1.2 Playbook å’Œ Ad-Hoc å¯¹æ¯”">2.1.2 Playbook å’Œ Ad-Hoc å¯¹æ¯”</a></li></ul></li><li><a href=#32-plabook-%e6%a0%b8%e5%bf%83%e7%bb%84%e4%bb%b6 aria-label="3.2 Plabook æ ¸å¿ƒç»„ä»¶">3.2 Plabook æ ¸å¿ƒç»„ä»¶</a></li><li><a href=#33--playbook-%e5%91%bd%e4%bb%a4 aria-label="3.3  Playbook å‘½ä»¤">3.3 Playbook å‘½ä»¤</a></li><li><a href=#34-ignore_errors aria-label="3.4 ignore_errors">3.4 ignore_errors</a></li><li><a href=#35-handlers-%e5%92%8c-notify aria-label="3.5 handlers å’Œ notify">3.5 handlers å’Œ notify</a></li><li><a href=#36-playbook-%e4%b8%ad%e4%bd%bf%e7%94%a8-tags aria-label="3.6 Playbook ä¸­ä½¿ç”¨ tags">3.6 Playbook ä¸­ä½¿ç”¨ tags</a></li><li><a href=#37-playbook-%e4%b8%ad%e4%bd%bf%e7%94%a8%e5%8f%98%e9%87%8f aria-label="3.7 Playbook ä¸­ä½¿ç”¨å˜é‡">3.7 Playbook ä¸­ä½¿ç”¨å˜é‡</a><ul><li><a href=#371-%e4%bd%bf%e7%94%a8-setup-%e6%a8%a1%e5%9d%97%e4%b8%ad%e7%9a%84%e5%8f%98%e9%87%8f aria-label="3.7.1 ä½¿ç”¨ setup æ¨¡å—ä¸­çš„å˜é‡">3.7.1 ä½¿ç”¨ setup æ¨¡å—ä¸­çš„å˜é‡</a><ul><li><a href=#3711-%e4%bd%bf%e7%94%a8-facts-%e5%8f%98%e9%87%8f aria-label="3.7.1.1 ä½¿ç”¨ facts å˜é‡">3.7.1.1 ä½¿ç”¨ facts å˜é‡</a></li><li><a href=#3712-%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96 aria-label="3.7.1.2 æ€§èƒ½ä¼˜åŒ–">3.7.1.2 æ€§èƒ½ä¼˜åŒ–</a></li></ul></li><li><a href=#372-%e5%91%bd%e4%bb%a4%e8%a1%8c%e4%b8%ad%e7%bb%99-playbook-%e4%bc%a0%e9%80%92%e5%8f%98%e9%87%8f aria-label="3.7.2 å‘½ä»¤è¡Œä¸­ç»™ playbook ä¼ é€’å˜é‡">3.7.2 å‘½ä»¤è¡Œä¸­ç»™ playbook ä¼ é€’å˜é‡</a></li><li><a href=#373-%e5%9c%a8-playbook-%e6%96%87%e4%bb%b6%e4%b8%ad%e5%ae%9a%e4%b9%89%e5%8f%98%e9%87%8f aria-label="3.7.3 åœ¨ playbook æ–‡ä»¶ä¸­å®šä¹‰å˜é‡">3.7.3 åœ¨ playbook æ–‡ä»¶ä¸­å®šä¹‰å˜é‡</a></li><li><a href=#374-%e5%9c%a8%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e6%96%87%e4%bb%b6%e4%b8%ad%e5%ae%9a%e4%b9%89%e5%8f%98%e9%87%8f aria-label="3.7.4 åœ¨å¤–éƒ¨å˜é‡æ–‡ä»¶ä¸­å®šä¹‰å˜é‡ï¼š">3.7.4 åœ¨å¤–éƒ¨å˜é‡æ–‡ä»¶ä¸­å®šä¹‰å˜é‡ï¼š</a></li><li><a href=#375-%e5%9c%a8%e4%b8%bb%e6%9c%ba%e6%b8%85%e5%8d%95%e4%b8%ad%e5%ae%9a%e4%b9%89%e5%8f%98%e9%87%8f aria-label="3.7.5 åœ¨ä¸»æœºæ¸…å•ä¸­å®šä¹‰å˜é‡">3.7.5 åœ¨ä¸»æœºæ¸…å•ä¸­å®šä¹‰å˜é‡</a></li><li><a href=#376-host_vars-%e5%92%8c-group_vars aria-label="3.7.6 host_vars å’Œ group_vars">3.7.6 host_vars å’Œ group_vars</a></li><li><a href=#377-register aria-label="3.7.7 register">3.7.7 register</a></li></ul></li><li><a href=#38-jinja2-%e6%a8%a1%e6%9d%bf%e7%9a%84%e4%bb%8b%e7%bb%8d%e5%92%8c%e4%bd%bf%e7%94%a8 aria-label="3.8 Jinja2 æ¨¡æ¿çš„ä»‹ç»å’Œä½¿ç”¨">3.8 Jinja2 æ¨¡æ¿çš„ä»‹ç»å’Œä½¿ç”¨</a></li><li><a href=#39-%e5%be%aa%e7%8e%af%e5%92%8c%e8%bf%ad%e4%bb%a3 aria-label="3.9 å¾ªç¯å’Œè¿­ä»£">3.9 å¾ªç¯å’Œè¿­ä»£</a><ul><li><a href=#378-loop aria-label="3.7.8 loop">3.7.8 loop</a></li><li><a href=#379-until aria-label="3.7.9 until">3.7.9 until</a></li><li><a href=#3710-with_lines aria-label="3.7.10 with_lines">3.7.10 with_lines</a></li></ul></li><li><a href=#310-%e6%9d%a1%e4%bb%b6%e5%88%a4%e6%96%ad-when aria-label="3.10 æ¡ä»¶åˆ¤æ–­ when">3.10 æ¡ä»¶åˆ¤æ–­ when</a></li><li><a href=#311-%e5%88%86%e7%bb%84-block aria-label="3.11 åˆ†ç»„ block">3.11 åˆ†ç»„ block</a></li><li><a href=#312-changed_when aria-label="3.12 changed_when">3.12 changed_when</a></li><li><a href=#313-%e6%bb%9a%e5%8a%a8%e6%89%a7%e8%a1%8c-serial aria-label="3.13 æ»šåŠ¨æ‰§è¡Œ serial">3.13 æ»šåŠ¨æ‰§è¡Œ serial</a></li><li><a href=#314-delegate_to aria-label="3.14 delegate_to">3.14 delegate_to</a></li><li><a href=#315-run_onece aria-label="3.15 run_onece">3.15 run_onece</a></li><li><a href=#316-%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f-environment aria-label="3.16 ç¯å¢ƒå˜é‡ environment">3.16 ç¯å¢ƒå˜é‡ environment</a></li><li><a href=#317-include-%e5%92%8c-import aria-label="3.17 include å’Œ import">3.17 include å’Œ import</a></li></ul></li><li><a href=#4-ansible-roles aria-label="4 Ansible Roles">4 Ansible Roles</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=1-ansible-ç®€ä»‹>1 Ansible ç®€ä»‹<a hidden class=anchor aria-hidden=true href=#1-ansible-ç®€ä»‹>#</a></h2><h3 id=11-ansible-å‘å±•å²>1.1 Ansible å‘å±•å²<a hidden class=anchor aria-hidden=true href=#11-ansible-å‘å±•å²>#</a></h3><p>ä½œè€…ï¼šMichael DeHaanï¼ˆ Cobbler ä¸ Func ä½œè€…ï¼‰</p><p>Ansible çš„åç§°æ¥è‡ªç§‘å¹»å°è¯´ã€Šå®‰å¾·çš„æ¸¸æˆã€‹ä¸­è·¨è¶Šæ—¶ç©ºçš„å³æ—¶é€šä¿¡å·¥å…·ï¼Œä½¿ç”¨å®ƒå¯ä»¥åœ¨ç›¸è·æ•°å…‰å¹´çš„è·ç¦»ï¼Œè¿œç¨‹å®æ—¶æ§åˆ¶å‰çº¿çš„èˆ°é˜Ÿæˆ˜æ–—ã€‚</p><p>2012-03-09ï¼Œå‘å¸ƒ0.0.1ç‰ˆï¼Œ2015-10-17ï¼ŒRed Hatå®£å¸ƒ1.5äº¿ç¾å…ƒæ”¶è´­Ansibleã€‚</p><p><a href=https://cn-ansibledoc.readthedocs.io/zh_CN/latest/#>Ansibleã€Œ2.9ã€ ä¸­æ–‡å®˜æ–¹æ–‡æ¡£ â€” Ansible Documentation (cn-ansibledoc.readthedocs.io)</a></p><h3 id=12-ansible-åŠŸèƒ½>1.2 Ansible åŠŸèƒ½<a hidden class=anchor aria-hidden=true href=#12-ansible-åŠŸèƒ½>#</a></h3><ul><li>æ‰¹é‡è¿œç¨‹æ‰§è¡Œå‘½ä»¤ã€å®‰è£…å’Œé…ç½®å„ç§æœåŠ¡</li><li>åˆ©ç”¨ Playbook å’Œ Role ç¼–æ’ä¼ä¸šçº§çš„å¤æ‚çš„ IT æ¶æ„ä»»åŠ¡</li><li>æä¾›è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·çš„å¼€å‘ APIï¼Œå¦‚ JumpServer å°±æ˜¯åŸºäº Ansible å®ç°è‡ªåŠ¨åŒ–ç®¡ç†åŠŸèƒ½</li></ul><h3 id=13-ansible-ç‰¹ç‚¹>1.3 Ansible ç‰¹ç‚¹<a hidden class=anchor aria-hidden=true href=#13-ansible-ç‰¹ç‚¹>#</a></h3><h4 id=131-ä¼˜ç‚¹>1.3.1 ä¼˜ç‚¹<a hidden class=anchor aria-hidden=true href=#131-ä¼˜ç‚¹>#</a></h4><ul><li>åŠŸèƒ½ä¸°å¯Œï¼šæ¨¡å—æ•°é‡è¾¾æ•°åƒä¸ªï¼Œä¸”æ”¯æŒè‡ªå®šä¹‰æ¨¡å—å’Œå¤šæ•°ç¼–ç¨‹è¯­è¨€</li><li>ç®€å•æ˜“ç”¨ï¼šAnsible ä¸ä½¿ç”¨ C/S æ¶æ„ç®¡ç†èŠ‚ç‚¹ï¼Œå³æ²¡æœ‰ Agentï¼Œå»ä¸­å¿ƒåŒ–ç®¡ç†æ–¹å¼</li><li>å®‰å…¨ï¼šåŸºäº OpenSSH åè®®å®ç°å®‰å…¨é€šè®¯ï¼Œæ— éœ€ä¸“ç”¨åè®®</li><li>å¹‚ç­‰æ€§ï¼šå¯ä»¥é‡å¤å¤šæ¬¡æ‰§è¡Œï¼Œå¯¹ç³»ç»Ÿä¸ä¼šäº§ç”Ÿå½±å“</li><li>ä½¿ç”¨ YAML æ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œç®€å•æ˜“è¯»</li><li>Playbook å’Œ Role æ”¯æŒç¼–æ’å¤æ‚ä»»åŠ¡ï¼Œå¢å¼ºä»£ç å¤ç”¨æ€§</li><li>Python è¯­è¨€å®ç°, åŸºäº Paramikoï¼ˆ python å¯¹ ssh çš„å®ç°ï¼‰ï¼ŒPyYAMLï¼ŒJinja2ï¼ˆæ¨¡æ¿è¯­è¨€ï¼‰ä¸‰ä¸ªå…³
é”®æ¨¡å—</li></ul><h4 id=132-ç¼ºç‚¹>1.3.2 ç¼ºç‚¹<a hidden class=anchor aria-hidden=true href=#132-ç¼ºç‚¹>#</a></h4><ul><li>ç®¡ç†ä¸»æœºè¾ƒå¤šæ—¶ï¼Œæ‰§è¡Œæ•ˆç‡ä¸å¦‚ saltstack</li><li>å½“å‰è¿˜ä¸æ”¯æŒåƒ MySQL æ•°æ®åº“ç±»ä¼¼çš„äº‹åŠ¡å›æ»š</li></ul><h4 id=133-æ³¨æ„äº‹é¡¹>1.3.3 æ³¨æ„äº‹é¡¹<a hidden class=anchor aria-hidden=true href=#133-æ³¨æ„äº‹é¡¹>#</a></h4><ul><li><p>å®‰è£…äº† ansible çš„ä¸»æœºå®˜æ–¹ç§°ä¹‹ä¸ºç®¡ç†æœºï¼Œå·¥ä½œä¸­ä¹Ÿå¸¸ç§°ä¹‹ä¸ºï¼šä¸­æ§ã€ä¸»æ§ã€master æˆ–è€…å ¡å’æœº</p></li><li><p>è¢«ç®¡ç†çš„ä¸»æœºä¸€èˆ¬ç§°ä¹‹ä¸ºå—ç®¡ç†èŠ‚ç‚¹ï¼Œè¢«æ§ç«¯ï¼Œå—æ§ç«¯</p></li><li><p>ç®¡ç†æœº Python ç‰ˆæœ¬éœ€è¦ 2.6 åŠä»¥ä¸Š</p></li><li><p>å—ç®¡ç†èŠ‚ç‚¹ Python ç‰ˆæœ¬ä½äº 2.4 ï¼Œéœ€è¦å®‰è£… python-simplejson</p></li><li><p>å—ç®¡ç†èŠ‚ç‚¹å¦‚æœå¯ç”¨ SELinux ï¼Œéœ€è¦å®‰è£… libselinux-python</p></li><li><p>Windows ä¸èƒ½åšä¸ºç®¡ç†æœºï¼Œåªèƒ½æ˜¯å—ç®¡ç†èŠ‚ç‚¹</p></li></ul><h2 id=2-ansible-å®‰è£…å’Œå¸¸è§æ¨¡å—>2 Ansible å®‰è£…å’Œå¸¸è§æ¨¡å—<a hidden class=anchor aria-hidden=true href=#2-ansible-å®‰è£…å’Œå¸¸è§æ¨¡å—>#</a></h2><h3 id=21-ansible-å®‰è£…>2.1 Ansible å®‰è£…<a hidden class=anchor aria-hidden=true href=#21-ansible-å®‰è£…>#</a></h3><blockquote><p>ä¸­æ–‡æ–‡æ¡£ï¼š<a href=https://cn-ansibledoc.readthedocs.io/zh_CN/latest/installation_guide/intro_installation.html>å®‰è£… Ansible â€” Ansible Documentation (cn-ansibledoc.readthedocs.io)</a></p><p>è‹±æ–‡æ–‡æ¡£ï¼š<a href=https://docs.ansible.com/ansible/latest/index.html>Ansible Documentation â€” Ansible Documentation</a></p></blockquote><p>CentOS å®‰è£…:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>yum install -y ansible
</span></span></code></pre></div><p>Ubuntu å®‰è£…ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>apt install -y ansible
</span></span></code></pre></div><p>pip å®‰è£…ï¼ˆä¸æ¨èï¼‰ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install ansible
</span></span></code></pre></div><p>æŸ¥çœ‹å·²å®‰è£…çš„ ansible ç‰ˆæœ¬</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ansible --version
</span></span></code></pre></div><h3 id=22-ansible-ç›¸å…³æ–‡ä»¶>2.2 Ansible ç›¸å…³æ–‡ä»¶<a hidden class=anchor aria-hidden=true href=#22-ansible-ç›¸å…³æ–‡ä»¶>#</a></h3><h4 id=221-ansible-é…ç½®æ–‡ä»¶åˆ—è¡¨>2.2.1 Ansible é…ç½®æ–‡ä»¶åˆ—è¡¨<a hidden class=anchor aria-hidden=true href=#221-ansible-é…ç½®æ–‡ä»¶åˆ—è¡¨>#</a></h4><ul><li>/etc/ansible/ansible.cfg ä¸»é…ç½®æ–‡ä»¶ï¼Œå¦‚æœéœ€è¦ï¼Œå¯ä»¥ä¸ºæ¯ä¸ªé¡¹ç›®åˆ›å»ºç‹¬æœ‰çš„ ansible.cfg æ–‡ä»¶ã€‚</li><li>/etc/ansible/hosts ä¸»æœºæ¸…å•æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰å—ç®¡ç†èŠ‚ç‚¹çš„ IP åŠå…¶ä»–ç›¸å…³ä¿¡æ¯</li><li>/etc/ansible/roles å­˜æ”¾å„ä¸ªè§’è‰²çš„ç›®å½•</li></ul><h4 id=222-ansible-ä¸»é…ç½®æ–‡ä»¶>2.2.2 Ansible ä¸»é…ç½®æ–‡ä»¶<a hidden class=anchor aria-hidden=true href=#222-ansible-ä¸»é…ç½®æ–‡ä»¶>#</a></h4><p>Ansible çš„é…ç½®æ–‡ä»¶å¯ä»¥æœ‰å¤šä¸ªæ¥æºï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°ä½é¡ºåºå¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ANSIBLE_CONFIG 	<span style=color:#75715e>#ç¯å¢ƒå˜é‡</span>
</span></span><span style=display:flex><span>./ansible.cfg	
</span></span><span style=display:flex><span>~/.ansible.cfg
</span></span><span style=display:flex><span>/etc/ansible/ansible.cfg	<span style=color:#75715e>#ç³»ç»Ÿé»˜è®¤é…ç½®</span>
</span></span></code></pre></div><p>Ansible çš„é»˜è®¤é…ç½®æ–‡ä»¶ <code>/etc/ansible/ansible.cfg</code> ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†æ³¨é‡Šå†…å®¹å³ä¸ºé»˜è®¤å€¼ï¼Œæ²¡æœ‰ç‰¹æ®Šéœ€è¦ï¼Œå¯ä»¥ä¸ç”¨ä¿®æ”¹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[defaults]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># some basic default values...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#inventory      = /etc/ansible/hosts</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#library        = /usr/share/my_modules/</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#module_utils   = /usr/share/my_module_utils/</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#remote_tmp     = ~/.ansible/tmp</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#local_tmp      = ~/.ansible/tmp</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#plugin_filters_cfg = /etc/ansible/plugin_filters.yml</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#forks          = 5</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#poll_interval  = 15</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sudo_user      = root</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#ask_sudo_pass = True</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#ask_pass      = True</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#transport      = smart</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#remote_port    = 22</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#module_lang    = C</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#module_set_locale = False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># plays will gather facts by default, which contain information about</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼šé€šè¿‡ç¯å¢ƒå˜é‡ ANSIBLE_CONFIG æŒ‡å®š ansible é…ç½®æ–‡ä»¶è·¯å¾„</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ll /data/ansible.cfg # å¹¶ä¸å­˜åœ¨çš„é…ç½®æ–‡ä»¶</span>
</span></span><span style=display:flex><span>ls: cannot access /data/ansible.cfg: No such file or directory
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># export ANSIBLE_CONFIG=/data/ansible.cfg</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible --version</span>
</span></span><span style=display:flex><span>ansible 2.9.27
</span></span><span style=display:flex><span>  config file <span style=color:#f92672>=</span> /etc/ansible/ansible.cfg <span style=color:#75715e># è¿˜æ˜¯é»˜è®¤é…ç½®æ–‡ä»¶</span>
</span></span><span style=display:flex><span>  configured module search path <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>u<span style=color:#e6db74>&#39;/root/.ansible/plugins/modules&#39;</span>, u<span style=color:#e6db74>&#39;/usr/share/ansible/plugins/modules&#39;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  ansible python module location <span style=color:#f92672>=</span> /usr/lib/python2.7/site-packages/ansible
</span></span><span style=display:flex><span>  executable location <span style=color:#f92672>=</span> /usr/bin/ansible
</span></span><span style=display:flex><span>  python version <span style=color:#f92672>=</span> 2.7.5 <span style=color:#f92672>(</span>default, Oct <span style=color:#ae81ff>30</span> 2018, 23:45:53<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>GCC 4.8.5 <span style=color:#ae81ff>20150623</span> <span style=color:#f92672>(</span>Red Hat 4.8.5-36<span style=color:#f92672>)]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># touch /data/ansible.cfg #åˆ›å»ºæ­¤æ–‡ä»¶</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible --version</span>
</span></span><span style=display:flex><span>ansible 2.9.27
</span></span><span style=display:flex><span>  config file <span style=color:#f92672>=</span> /data/ansible.cfg <span style=color:#75715e># æˆåŠŸæŒ‡å®š</span>
</span></span><span style=display:flex><span>  configured module search path <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>u<span style=color:#e6db74>&#39;/root/.ansible/plugins/modules&#39;</span>, u<span style=color:#e6db74>&#39;/usr/share/ansible/plugins/modules&#39;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  ansible python module location <span style=color:#f92672>=</span> /usr/lib/python2.7/site-packages/ansible
</span></span><span style=display:flex><span>  executable location <span style=color:#f92672>=</span> /usr/bin/ansible
</span></span><span style=display:flex><span>  python version <span style=color:#f92672>=</span> 2.7.5 <span style=color:#f92672>(</span>default, Oct <span style=color:#ae81ff>30</span> 2018, 23:45:53<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>GCC 4.8.5 <span style=color:#ae81ff>20150623</span> <span style=color:#f92672>(</span>Red Hat 4.8.5-36<span style=color:#f92672>)]</span>
</span></span></code></pre></div><h4 id=223-inventory-ä¸»æœºæ¸…å•æ–‡ä»¶>2.2.3 Inventory ä¸»æœºæ¸…å•æ–‡ä»¶<a hidden class=anchor aria-hidden=true href=#223-inventory-ä¸»æœºæ¸…å•æ–‡ä»¶>#</a></h4><p>ansible çš„ä¸»è¦åŠŸèƒ½åœ¨äºæ‰¹é‡ç®¡ç†ä¸»æœºï¼Œè¿™äº›è¢«ç®¡ç†çš„ä¸»æœºå°±ä½¿ç”¨ inventory æ–‡ä»¶æ¥æŒ‡å®šã€‚</p><p>ç”Ÿäº§ç¯å¢ƒå¯ä»¥ä¸ºæ¯ä¸ªé¡¹ç›®åˆ›å»ºç‹¬æœ‰çš„ ansible.cfg æ–‡ä»¶å’Œ hosts æ–‡ä»¶ï¼Œå®ç°é¡¹ç›®ä¹‹å‰çš„éš”ç¦»ç®¡ç†ã€‚</p><p>å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html</p><p><strong>ä¸»æœºæ¸…å•æ–‡ä»¶æ ¼å¼</strong></p><p>inventory æ–‡ä»¶éµå¾ª INI æ–‡ä»¶é£æ ¼ï¼Œå¯ä»¥å¯¹ä¸»æœºè¿›è¡Œåˆ†ç»„ç®¡ç†ï¼Œä¸”å¯ä»¥é’ˆå¯¹æ¯ä¸ªä¸»æœºæŒ‡å®šéé»˜è®¤çš„ç«¯å£å’Œè´¦å·ç­‰ä¿¡æ¯</p><p><strong>å¸¸ç”¨ Inventory å‚æ•°è¯´æ˜</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ansible_ssh_host <span style=color:#75715e># è¿œç¨‹ä¸»æœºåä¸æƒ³è¦è®¾å®šçš„ä¸»æœºçš„åˆ«åä¸åŒçš„è¯ï¼Œå¯é€šè¿‡æ­¤å˜é‡è®¾ç½®ã€‚</span>
</span></span><span style=display:flex><span>ansible_ssh_port <span style=color:#75715e># ssh ç«¯å£å·ï¼Œå¦‚æœä¸æ˜¯é»˜è®¤çš„ç«¯å£å·ï¼Œé€šè¿‡æ­¤å˜é‡è®¾ç½®ã€‚æˆ–è€…ip:ç«¯å£çš„å½¢å¼æŒ‡å®š 192.168.1.100:2222</span>
</span></span><span style=display:flex><span>ansible_ssh_user <span style=color:#75715e># ssh ç”¨æˆ·å</span>
</span></span><span style=display:flex><span>ansible_ssh_pass <span style=color:#75715e># ssh å¯†ç (è¿™ç§æ–¹å¼å¹¶ä¸å®‰å…¨ï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨ --ask-pass æˆ–è€…é…ç½® ssh å…å¯†)</span>
</span></span><span style=display:flex><span>ansible_sudo_pass <span style=color:#75715e># sudo å¯†ç (è¿™ç§æ–¹å¼å¹¶ä¸å®‰å…¨ï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨ --ask-sudo-pass)</span>
</span></span><span style=display:flex><span>ansible_sudo_exe <span style=color:#f92672>(</span>new in version 1.8<span style=color:#f92672>)</span> <span style=color:#75715e># sudo å‘½ä»¤è·¯å¾„(é€‚ç”¨äº1.8åŠä»¥ä¸Šç‰ˆæœ¬)</span>
</span></span><span style=display:flex><span>ansible_connection <span style=color:#75715e># ä¸ä¸»æœºçš„è¿æ¥ç±»å‹.æ¯”å¦‚:local, ssh æˆ–è€… paramikoã€‚ Ansible 1.2 ä»¥å‰é»˜è®¤ä½¿ç”¨ paramikoã€‚1.2 ä»¥åé»˜è®¤ä½¿ç”¨ &#39;smart&#39;ï¼Œ&#39;smart&#39; æ–¹å¼ä¼šæ ¹æ®æ˜¯å¦æ”¯æŒ ControlPersist, æ¥åˆ¤æ–­&#39;ssh&#39; æ–¹å¼æ˜¯å¦å¯è¡Œã€‚</span>
</span></span><span style=display:flex><span>ansible_ssh_private_key_file <span style=color:#75715e># ssh ä½¿ç”¨çš„ç§é’¥æ–‡ä»¶ï¼Œé€‚ç”¨äºæœ‰å¤šä¸ªå¯†é’¥ï¼Œè€Œä½ ä¸æƒ³ä½¿ç”¨ ssh ä»£ç†çš„æƒ…å†µã€‚</span>
</span></span><span style=display:flex><span>ansible_shell_type <span style=color:#75715e># ç›®æ ‡ç³»ç»Ÿçš„ shell ç±»å‹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘½ä»¤çš„æ‰§è¡Œä½¿ç”¨ &#39;sh&#39; è¯­æ³•, å¯è®¾ç½®ä¸º&#39;csh&#39; æˆ– &#39;fish&#39;ã€‚</span>
</span></span><span style=display:flex><span>ansible_python_interpreter <span style=color:#75715e># ç›®æ ‡ä¸»æœºçš„ python è·¯å¾„ï¼Œé€‚ç”¨äºçš„æƒ…å†µ: ç³»ç»Ÿä¸­æœ‰å¤šä¸ª Python, æˆ–è€…å‘½ä»¤è·¯å¾„ä¸æ˜¯&#34;/usr/bin/python&#34;ï¼Œæ¯”å¦‚ \*BSD, æˆ–è€… /usr/bin/python ä¸æ˜¯ 2.X ç‰ˆæœ¬çš„Pythonã€‚ä¹‹æ‰€ä»¥ä¸ä½¿ç”¨ &#34;/usr/bin/env&#34; æœºåˆ¶ï¼Œå› ä¸ºè¿™è¦æ±‚è¿œç¨‹ç”¨æˆ·çš„è·¯å¾„è®¾ç½®æ­£ç¡®ï¼Œä¸”è¦æ±‚ &#34;python&#34; å¯æ‰§è¡Œç¨‹åºåä¸å¯ä¸º python ä»¥å¤–çš„åå­—(å®é™…æœ‰å¯èƒ½åä¸ºpython26)</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼šä¸»æœºå’Œç»„åµŒå¥—</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-INI data-lang=INI><span style=display:flex><span><span style=color:#a6e22e>ntp.time.org</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[databases]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>www.db1.org:2222</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>www.db2.org</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[web]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>www.web1.com</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>www.web2.com</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[proxy]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pro[1:3].test.com</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pro-db[a:f].test.com</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># server ç»„æˆå‘˜ï¼šweb, proxy</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>[server:children] # children æ˜¯å†…ç½®å˜é‡</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>web</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>proxy</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼šåŸºäºç”¨æˆ·åå’Œå¯†ç è¿æ¥</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[test]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>10.0.0.1 ansible_connection</span><span style=color:#f92672>=</span><span style=color:#e6db74>local #æŒ‡å®šæœ¬åœ°è¿æ¥æ–¹å¼ï¼Œå¦‚ï¼šssh localhost</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>10.0.0.2 ansible_connection</span><span style=color:#f92672>=</span><span style=color:#e6db74>ssh ansible_ssh_port=2222 ansible_ssh_user=user ansible_ssh_password=passwd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>10.0.0.3 ansible_ssh_user</span><span style=color:#f92672>=</span><span style=color:#e6db74>test ansible_ssh_password=test</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[web]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>web01 ansible_ssh_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>10.0.0.5 # web01 ä¸ºåˆ«å</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>web02 ansible_ssh_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>10.0.0.6</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>[web:vars] # vars æ˜¯å†…ç½®å˜é‡ï¼Œè¿™é‡Œä¸º web ç»„å†…çš„æˆå‘˜å®šä¹‰äº†ä¸€ä¸ªç»„å˜é‡</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ansible_ssh_password</span><span style=color:#f92672>=</span><span style=color:#e6db74>test</span>
</span></span></code></pre></div><h3 id=23-ansible-ç›¸å…³å·¥å…·>2.3 Ansible ç›¸å…³å·¥å…·<a hidden class=anchor aria-hidden=true href=#23-ansible-ç›¸å…³å·¥å…·>#</a></h3><ul><li>/usr/bin/ansible ä¸»ç¨‹åºï¼Œä¸´æ—¶å‘½ä»¤æ‰§è¡Œå·¥å…·</li><li>/usr/bin/ansible-doc æŸ¥çœ‹é…ç½®æ–‡æ¡£ï¼Œæ¨¡å—åŠŸèƒ½æŸ¥çœ‹å·¥å…·,ç›¸å½“äºman</li><li>/usr/bin/ansible-playbook å®šåˆ¶è‡ªåŠ¨åŒ–ä»»åŠ¡ï¼Œç¼–æ’å‰§æœ¬å·¥å…·,ç›¸å½“äºè„šæœ¬</li><li>/usr/bin/ansible-pull è¿œç¨‹æ‰§è¡Œå‘½ä»¤çš„å·¥å…·</li><li>/usr/bin/ansible-vault æ–‡ä»¶åŠ å¯†å·¥å…·</li><li>/usr/bin/ansible-console åŸºäºConsoleç•Œé¢ä¸ç”¨æˆ·äº¤äº’çš„æ‰§è¡Œå·¥å…·</li><li>/usr/bin/ansible-galaxy ä¸‹è½½/ä¸Šä¼ ä¼˜ç§€ä»£ç æˆ–Rolesæ¨¡å—çš„å®˜ç½‘å¹³å°</li></ul><p><strong>åˆ©ç”¨ ansible å®ç°ç®¡ç†çš„ä¸»è¦æ–¹å¼ï¼š</strong></p><ul><li>Ansible Ad-Hoc ä¸»è¦ç”¨äºå‘½ä»¤è¡Œæ‰§è¡Œå‘½ä»¤ï¼Œé€‚åˆäºç®€å•ä»»åŠ¡</li><li>Ansible playbook ä¸»è¦ç”¨äºé•¿æœŸè§„åˆ’å¥½çš„ï¼Œå¤§å‹é¡¹ç›®åœºæ™¯</li></ul><p><strong>ansible ä½¿ç”¨å‰å‡†å¤‡ï¼š</strong></p><p>ansible å¤§éƒ¨åˆ†å·¥å…·ä½¿ç”¨ ssh åè®®æ¥è¿›è¡Œè¿œç¨‹ä¸»æœºç®¡ç†ï¼Œå› æ­¤åœ¨ä½¿ç”¨æ­¤å·¥å…·å‰éœ€è¦é…ç½®å¥½å¯†é’¥è®¤è¯ï¼Œå¦‚æœä½¿ç”¨å¯†ç éªŒè¯ä¼šå¾ˆéº»çƒ¦ï¼Œè€Œä¸”å¹¶ä¸å®‰å…¨ã€‚</p><p>åœ¨é¦–æ¬¡ ssh æŸå°ä¸»æœºæ—¶ï¼Œä¼šæœ‰ä¸€ä¸ªæ˜¯å¦ä¿¡ä»»ä¸»æœºçš„æç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ssh localhost</span>
</span></span><span style=display:flex><span>The authenticity of host <span style=color:#e6db74>&#39;localhost (::1)&#39;</span> can<span style=color:#960050;background-color:#1e0010>&#39;</span>t be established.
</span></span><span style=display:flex><span>ECDSA key fingerprint is SHA256:kFbXYFVk/H+j5h1JTkIf9HAw+zXbWQIHqG03FutZJ3E.
</span></span><span style=display:flex><span>ECDSA key fingerprint is MD5:7b:d4:06:49:45:fa:58:b0ğŸ’¿de:ef:bc:1e:14:09:f3.
</span></span><span style=display:flex><span>Are you sure you want to <span style=color:#66d9ef>continue</span> connecting <span style=color:#f92672>(</span>yes/no<span style=color:#f92672>)</span>? 
</span></span></code></pre></div><p>å¯ä»¥ä¿®æ”¹ <code>/etc/ssh/ssh_config</code>çš„é…ç½®æ¥é¿å…è¯¥æç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>StrictHostKeyChecking no</span>
</span></span></code></pre></div><p>ä»¥ä¸‹å‡†å¤‡äº†ä¸€ä¸ªè„šæœ¬æ¥å®ç° ssh å…å¯†ç™»å½•ï¼š</p><p>å‡†å¤‡ä¸€ä¸ªæ¸…å•æ–‡ä»¶ï¼Œå†™å…¥ç›¸åº”çš„IP</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># cat hosts.txt </span>
</span></span><span style=display:flex><span>10.0.0.1
</span></span><span style=display:flex><span>10.0.0.2
</span></span><span style=display:flex><span>10.0.0.3
</span></span></code></pre></div><p>è„šæœ¬å†…å®¹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># éœ€è¦ä¿®æ”¹çš„å‚æ•°</span>
</span></span><span style=display:flex><span><span style=color:#75715e>###################</span>
</span></span><span style=display:flex><span><span style=color:#75715e># è¯»å–ä¸»æœºåˆ—è¡¨æ–‡ä»¶</span>
</span></span><span style=display:flex><span>hosts_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hosts.txt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># è¿œç¨‹ç”¨æˆ·å</span>
</span></span><span style=display:flex><span>remote_user<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;your_username&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å¹¶å‘ä»»åŠ¡æ•°é‡</span>
</span></span><span style=display:flex><span>concurrency<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># SSH å¯†ç </span>
</span></span><span style=display:flex><span>export ssh_password<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;your_password&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##########################</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># é¢œè‰²å®šä¹‰</span>
</span></span><span style=display:flex><span>RED<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;\033[0;31m&#39;</span>
</span></span><span style=display:flex><span>GREEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;\033[0;32m&#39;</span>
</span></span><span style=display:flex><span>NC<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;\033[0m&#39;</span> <span style=color:#75715e># No Color</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ‰“å°å¸¦é¢œè‰²çš„æ¶ˆæ¯</span>
</span></span><span style=display:flex><span>print_message<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  local message<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  local color<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$2<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  echo -e <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>color<span style=color:#e6db74>}</span>$message<span style=color:#e6db74>${</span>NC<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ£€æŸ¥ä¸»æœºåˆ—è¡¨æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -f <span style=color:#e6db74>&#34;</span>$hosts_file<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>  echo -e <span style=color:#e6db74>&#34;\033[31mHosts file not found: </span>$hosts_file<span style=color:#e6db74>\033[0m&#34;</span>
</span></span><span style=display:flex><span>  exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å®‰è£… sshpass</span>
</span></span><span style=display:flex><span>rpm -q sshpass &amp;&gt; /dev/null <span style=color:#f92672>||</span> yum install -y sshpass
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å®‰è£… parallel</span>
</span></span><span style=display:flex><span>rpm -qi parallel &amp;&gt; /dev/null <span style=color:#f92672>||</span> yum install -y parallel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ç”Ÿæˆ id_rsa å¯†é’¥</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> -f /root/.ssh/id_rsa <span style=color:#f92672>]</span> <span style=color:#f92672>||</span> ssh-keygen -f /root/.ssh/id_rsa -P <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># mkfifo åˆ›å»ºå‘½åç®¡é“</span>
</span></span><span style=display:flex><span>tempfifo<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/tmp/</span>$$<span style=color:#e6db74>.fifo&#34;</span>
</span></span><span style=display:flex><span>mkfifo <span style=color:#e6db74>${</span>tempfifo<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å…³è”fifoæ–‡ä»¶å’Œfd6ï¼Œä½¿æ–‡ä»¶æè¿°ç¬¦ä¸ºéé˜»å¡å¼</span>
</span></span><span style=display:flex><span>exec 6&lt;&gt;<span style=color:#e6db74>${</span>tempfifo<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>rm -f <span style=color:#e6db74>${</span>tempfifo<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ä¸ºæ–‡ä»¶æè¿°ç¬¦åˆ›å»ºå ä½ä¿¡æ¯</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#f92672>((</span>i<span style=color:#f92672>=</span>1;i&lt;<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>concurrency<span style=color:#e6db74>}</span>;i++<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;&#34;</span> &gt;&amp;<span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>  
</span></span><span style=display:flex><span><span style=color:#75715e># é€è¡Œè¯»å–ä¸»æœºåˆ—è¡¨æ–‡ä»¶å¹¶æ‰§è¡Œä»»åŠ¡</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> IFS<span style=color:#f92672>=</span> read -r host; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  read -u6   <span style=color:#75715e>## read -u6å‘½ä»¤æ‰§è¡Œä¸€æ¬¡ï¼Œç›¸å½“äºå°è¯•ä»fd6ä¸­è·å–ä¸€è¡Œï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™é˜»å¡è·å–åˆ°äº†           </span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>## ä¸€è¡Œåï¼Œfd6å°±å°‘äº†ä¸€è¡Œäº†ï¼Œå¼€å§‹å¤„ç†å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹æ”¾åœ¨åå°æ‰§è¡Œ</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    sshpass -p <span style=color:#e6db74>&#34;</span>$ssh_password<span style=color:#e6db74>&#34;</span> ssh-copy-id -o StrictHostKeyChecking<span style=color:#f92672>=</span>no <span style=color:#e6db74>&#34;</span>$remote_user<span style=color:#e6db74>@</span>$host<span style=color:#e6db74>&#34;</span> &amp;&gt;/dev/null;
</span></span><span style=display:flex><span>    exit_code<span style=color:#f92672>=</span>$?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $exit_code -eq <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>      print_message <span style=color:#e6db74>&#34;æˆåŠŸå…å¯†ä¸»æœº: </span>$host<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$GREEN<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>      print_message <span style=color:#e6db74>&#34;å¤±è´¥å…å¯†ä¸»æœº: </span>$host<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$RED<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;&#34;</span> &gt;&amp;<span style=color:#ae81ff>6</span>   <span style=color:#75715e># å®Œæˆåå†è¡¥å……ä¸€ä¸ªç©ºå€¼åˆ°fd6ä¸­ï¼Œé‡Šæ”¾ä¸€ä¸ªé”</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> &amp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span> &lt; <span style=color:#e6db74>&#34;</span>$hosts_file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>wait
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å…³é—­fd6ç®¡é“</span>
</span></span><span style=display:flex><span>exec 6&gt;&amp;-
</span></span></code></pre></div><h4 id=231-ansible-doc>2.3.1 Ansible-doc<a hidden class=anchor aria-hidden=true href=#231-ansible-doc>#</a></h4><p>æ­¤å·¥å…·ç”¨äºæ˜¾ç¤ºæ¨¡å—å¸®åŠ©æ–‡æ¡£ï¼Œç±»ä¼¼ man</p><p>ä½¿ç”¨æ ¼å¼ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ansible-doc <span style=color:#f92672>[</span>options<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>module...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>-l, --list       <span style=color:#75715e># åˆ—å‡ºå¯ç”¨æ¨¡å—</span>
</span></span><span style=display:flex><span>-s, --snippet 	 <span style=color:#75715e># æ˜¾ç¤ºæŒ‡å®šæ¨¡å—çš„playbookç‰‡æ®µ</span>
</span></span></code></pre></div><p>å¸¸ç”¨é€‰é¡¹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># åˆ—å‡ºæ‰€æœ‰æ¨¡å—</span>
</span></span><span style=display:flex><span>ansible-doc -l
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹æŒ‡å®šæ¨¡å—å¸®åŠ©ç”¨æ³•</span>
</span></span><span style=display:flex><span>ansible-doc ping
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹å¸¸ç”¨playbooké€‰é¡¹</span>
</span></span><span style=display:flex><span>ansible-doc -s ping
</span></span></code></pre></div><p>æŸ¥çœ‹æ¨¡å—ç›¸å…³çš„æ’ä»¶</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># connection æ¨¡å—ç›¸å…³ç»„ä»¶</span>
</span></span><span style=display:flex><span>ansible-doc -t connection -l  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># lookup æ¨¡å—ç›¸å…³ç»„ä»¶</span>
</span></span><span style=display:flex><span>ansible-doc -t lookup -l
</span></span></code></pre></div><h4 id=232-ansible>2.3.2 Ansible<a hidden class=anchor aria-hidden=true href=#232-ansible>#</a></h4><h5 id=2321-ansible-ad-hoc>2.3.2.1 Ansible Ad-Hoc<a hidden class=anchor aria-hidden=true href=#2321-ansible-ad-hoc>#</a></h5><p>Ansible Ad-Hoc ä¸»è¦å°±æ˜¯ä½¿ç”¨ansibleä¸»ç¨‹åº</p><p>é€šå¸¸ç”¨æ¥æ‰§è¡Œä¸€æ¬¡æ€§ä»»åŠ¡ï¼Œä¸ä¼šä¿å­˜å‘½ä»¤æ‰§è¡Œçš„ä¿¡æ¯ï¼Œå¸¸ç”¨äºæµ‹è¯•åœºæ™¯</p><h5 id=2322-ansible-å‘½ä»¤ç”¨æ³•>2.3.2.2 Ansible å‘½ä»¤ç”¨æ³•<a hidden class=anchor aria-hidden=true href=#2322-ansible-å‘½ä»¤ç”¨æ³•>#</a></h5><p>æ ¼å¼ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ansible &lt;host-pattern&gt; <span style=color:#f92672>[</span>-m module_name<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-a args<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>å¸¸ç”¨é€‰é¡¹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>--version			<span style=color:#75715e># æŸ¥çœ‹ ansible ç‰ˆæœ¬å’Œé…ç½®æ–‡ä»¶è·¯å¾„</span>
</span></span><span style=display:flex><span>-m &lt;module_name&gt;	<span style=color:#75715e># æŒ‡å®šä½¿ç”¨çš„æ¨¡å—ï¼Œä¸æŒ‡å®šé»˜è®¤ä¸º command</span>
</span></span><span style=display:flex><span>-v 					<span style=color:#75715e># ç”¨äº debugï¼Œ-vv  -vvv å¯æ˜¾ç¤ºæ›´è¯¦ç»†å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹çš„æ—¥å¿—</span>
</span></span><span style=display:flex><span>--list-hosts		<span style=color:#75715e># æ˜¾ç¤ºæ¸…å•æ–‡ä»¶ä¸­çš„ä¸»æœºåˆ—è¡¨</span>
</span></span><span style=display:flex><span>-C, --check			<span style=color:#75715e># æ¨¡æ‹Ÿæ‰§è¡Œï¼Œå¹¶ä¸å¯¹ç›®æ ‡ä¸»æœºåšå®é™…æ”¹åŠ¨ï¼Œå¯ä»¥ç”¨æ¥æ£€æŸ¥è¯­æ³•</span>
</span></span><span style=display:flex><span>-T, --timeout<span style=color:#f92672>=</span>TIMEOUT  		<span style=color:#75715e># æŒ‡å®šå‘½ä»¤æ‰§è¡Œè¶…æ—¶æ—¶é—´</span>
</span></span><span style=display:flex><span>-k, --ask-pass 		<span style=color:#75715e># æç¤ºè¾“å…¥ ssh å¯†ç ï¼Œä½¿ç”¨å¯†ç éªŒè¯ï¼Œé»˜è®¤ä½¿ç”¨ key éªŒè¯</span>
</span></span><span style=display:flex><span>-u, --user<span style=color:#f92672>=</span>USERNAME <span style=color:#75715e># æŒ‡å®š sudo ç”¨æˆ·ï¼Œé»˜è®¤ä¸º root</span>
</span></span><span style=display:flex><span>-b, --become 		<span style=color:#75715e># ä½¿ç”¨ sudo æœºåˆ¶</span>
</span></span><span style=display:flex><span>--become-user<span style=color:#f92672>=</span>USERNAME 	<span style=color:#75715e># æŒ‡å®š sudo çš„ç›®æ ‡ç”¨æˆ·ï¼Œé»˜è®¤ä¸º root</span>
</span></span><span style=display:flex><span>-K, --ask-become-pass	<span style=color:#75715e># æç¤ºè¾“å…¥ sudo å¯†ç </span>
</span></span><span style=display:flex><span>-f &lt;forks_num&gt;, --FORKS <span style=color:#75715e># æŒ‡å®šå¹¶å‘æ•°</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼šä½¿ç”¨ localhost èµ°æœ¬åœ°åè®®ï¼Œå¹¶ä¸éœ€è¦å¯†ç ï¼ˆåŒ…æ‹¬ sudo å¯†ç ï¼‰ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># ä»¥test ç”¨æˆ·æ‰§è¡Œæ“ä½œï¼Œ</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m  ping -u test</span>
</span></span><span style=display:flex><span>localhost | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ping&#34;</span>: <span style=color:#e6db74>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŒ‡å®šäº†ç”¨æˆ·ä¸º testï¼Œä½†å¹¶æœªç”Ÿæ•ˆ</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m shell -a &#34;whoami&#34; -u test </span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>root
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ä»¥ test ç”¨æˆ·ä½¿ç”¨ sudo æœºåˆ¶æ‰§è¡Œå‘½ä»¤</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m shell -a &#34;whoami&#34; -u test -b -become-user=root </span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>root
</span></span></code></pre></div><p>èŒƒä¾‹ï¼šä½¿ç”¨ IPè¿æ¥ï¼Œå¯è§‚æµ‹åˆ° ansible çš„ç›¸å…³ç‰¹æ€§</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># æœ¬æœºIP</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># hostname -I</span>
</span></span><span style=display:flex><span>192.168.0.133 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å°†æœ¬æœºIPåŠ å…¥æ¸…å•æ–‡ä»¶ï¼ˆlocalhostä¸éœ€è¦æ˜¾å¼åŠ å…¥ï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># grep $(hostname -I) /etc/ansible/hosts</span>
</span></span><span style=display:flex><span>192.168.0.133
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ²¡æœ‰è¾“å…¥å¯†ç æç¤ºæƒé™ä¸è¶³</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.0.133 -m shell -a &#34;whoami&#34; -u test  </span>
</span></span><span style=display:flex><span>192.168.0.133 | UNREACHABLE! <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;Failed to connect to the host via ssh: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;unreachable&#34;</span>: true
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åŠ å…¥ -k é€‰é¡¹è¾“å…¥å¯†ç ï¼ŒæˆåŠŸæ‰§è¡Œ</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.0.133 -m shell -a &#34;whoami&#34; -u test -k</span>
</span></span><span style=display:flex><span>SSH password: 
</span></span><span style=display:flex><span>192.168.0.133 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># sudo ä¹Ÿæ˜¯åŒæ ·çš„æƒ…å†µï¼Œä¸è¾“å…¥å¯†ç ä¼šæŠ¥é”™</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.0.133 -m shell -a &#34;whoami&#34; -u test -k -b </span>
</span></span><span style=display:flex><span>SSH password: 
</span></span><span style=display:flex><span>192.168.0.133 | FAILED | rc<span style=color:#f92672>=</span>-1 &gt;&gt;
</span></span><span style=display:flex><span>Missing sudo password
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># è¾“å…¥å¯†ç åæˆåŠŸæ‰§è¡Œ</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.0.133 -m shell -a &#34;whoami&#34; -u test -k -b -K</span>
</span></span><span style=display:flex><span>SSH password: 
</span></span><span style=display:flex><span>BECOME password<span style=color:#f92672>[</span>defaults to SSH password<span style=color:#f92672>]</span>: 
</span></span><span style=display:flex><span>192.168.0.133 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>root
</span></span></code></pre></div><p>èŒƒä¾‹ï¼šå¹¶å‘æ‰§è¡Œæ§åˆ¶</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># åˆ†åˆ«æ‰§è¡Œä¸€ä¸‹ä»¥ä¸‹ä¸¤ä¸ªå‘½ä»¤è§‚å¯Ÿè¿è¡Œæ•ˆæœï¼Œå¯ä»¥å‘ç°æ‰§è¡Œçš„ä¹‹é—´åŸºæœ¬ä¸€è‡´</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -a &#39;sleep 3&#39; -f 1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -a &#39;sleep 3&#39; -f 10</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼šä½¿ç”¨æ™®é€šç”¨æˆ·è¿›è¡Œè¿œç¨‹ç®¡ç†</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># åœ¨æ‰€æœ‰æ§åˆ¶ç«¯å’Œè¢«æ§åˆ¶ç«¯åˆ›å»ºæ™®é€šè´¦å·å¹¶ä¿®æ”¹å¯†ç ï¼ˆæœ¬æ¬¡ç¤ºä¾‹ä¸ºå‡ä¸º192.168.0.133ï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># useradd test</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># echo test:test | chpasswd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ·»åŠ sudoæˆæƒ</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># visudo  # æ·»åŠ ä¸€è¡Œ</span>
</span></span><span style=display:flex><span>test	ALL<span style=color:#f92672>=(</span>ALL<span style=color:#f92672>)</span> 	ALL
</span></span><span style=display:flex><span><span style=color:#75715e># æ ¡éªŒé…ç½®æ— è¯¯</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># visudo -c</span>
</span></span><span style=display:flex><span>/etc/sudoers: parsed OK
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ‡æ¢åˆ°æ™®é€šç”¨æˆ·</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># su - test</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ç”Ÿæˆå¯†é’¥å¯¹</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>test@ansible ~<span style=color:#f92672>]</span>$ ssh-keygen -f ~/.ssh/id_rsa -P <span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74># å°†å…¬é’¥æ‹·è´åˆ°ç›®æ ‡ä¸»æœº
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[test@ansible ~] ssh-copy-id  -o &#34;StrictHostKeyChecking=no&#34; test@192.168.0.133
</span></span></span><span style=display:flex><span><span style=color:#e6db74># éªŒè¯å…å¯†ç™»å½•æˆåŠŸ
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[test@ansible ~]$ ssh test@192.168.0.133
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Last login: Mon Jun 12 09:50:05 2023
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># ä½¿ç”¨ansibleè¿›è¡Œè¿œç¨‹æ§åˆ¶ï¼Œæç¤ºæƒé™ä¸è¶³
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[test@ansible ~]$ ansible 192.168.0.133 -m shell -a &#39;</span>ls /root/<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>192.168.0.133 | FAILED | rc=2 &gt;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ls: cannot open directory /root/: Permission deniednon-zero return code
</span></span></span><span style=display:flex><span><span style=color:#e6db74># ä½¿ç”¨ sudo ææƒåæ‰§è¡ŒæˆåŠŸ
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[test@ansible ~]$ ansible 192.168.0.133 -m shell -a &#39;</span>ls /root/<span style=color:#960050;background-color:#1e0010>&#39;</span> -b -K
</span></span><span style=display:flex><span>BECOME password: 
</span></span><span style=display:flex><span>192.168.0.133 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>ansible.cfg
</span></span></code></pre></div><p>**æ³¨æ„ï¼š**åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œansible è¿œæ§æ—¶å¹¶æœªæŒ‡å®šè¿œç¨‹çš„ç”¨æˆ·åï¼Œå½“æ²¡æœ‰ç”¨ -u æŒ‡å®šè¿œç¨‹ç”¨æˆ·åæ—¶ï¼Œé»˜è®¤ä½¿ç”¨å½“å‰çš„æœ¬æœºç”¨æˆ·åè¿›è¡Œè¿œç¨‹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible 192.168.0.133 -m shell -a &#39;whoami&#39;</span>
</span></span><span style=display:flex><span>192.168.0.133 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>root
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># su - test</span>
</span></span><span style=display:flex><span>Last login: Mon Jun <span style=color:#ae81ff>12</span> 10:03:04 CST <span style=color:#ae81ff>2023</span> from 192.168.0.133 on pts/3
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>test@ansible ~<span style=color:#f92672>]</span>$ ansible 192.168.0.133 -m shell -a <span style=color:#e6db74>&#39;whoami&#39;</span>
</span></span><span style=display:flex><span>192.168.0.133 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>test
</span></span><span style=display:flex><span><span style=color:#75715e># é€šè¿‡ -u æ˜¾å¼æŒ‡æ˜è¿œç¨‹ç”¨æˆ·å</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>test@ansible ~<span style=color:#f92672>]</span>$ ansible 192.168.0.133 -m shell -a <span style=color:#e6db74>&#39;whoami&#39;</span> -u root -k
</span></span><span style=display:flex><span>SSH password: 
</span></span><span style=display:flex><span>192.168.0.133 | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>root
</span></span></code></pre></div><p><strong>ansible Host-pattern</strong></p><p>ç”¨äºåŒ¹é…ä¸»æœºæ¸…å•ä¸­çš„ä¸»æœº</p><p>å‡†å¤‡ä¸»æœºæ¸…å•æ–‡ä»¶ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /etc/ansible/hosts</span>
</span></span><span style=display:flex><span>192.168.0.133
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>hello<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>192.168.0.1
</span></span><span style=display:flex><span>172.31.5.1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>world<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>10.0.0.1
</span></span><span style=display:flex><span>172.31.5.1
</span></span></code></pre></div><p>all : å†…ç½®å˜é‡ï¼Œè¡¨ç¤ºæ‰€æœ‰ä¸»æœº</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible all --list-hosts</span>
</span></span><span style=display:flex><span>  hosts <span style=color:#f92672>(</span>4<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>    192.168.0.133
</span></span><span style=display:flex><span>    10.0.0.1
</span></span><span style=display:flex><span>    172.31.5.1
</span></span><span style=display:flex><span>    192.168.0.1
</span></span></code></pre></div><p>*<strong>: é€šé…ç¬¦</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible &#34;*&#34; --list-hosts</span>
</span></span><span style=display:flex><span>  hosts <span style=color:#f92672>(</span>4<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>    192.168.0.133
</span></span><span style=display:flex><span>    10.0.0.1
</span></span><span style=display:flex><span>    172.31.5.1
</span></span><span style=display:flex><span>    192.168.0.1
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible &#34;192.168.0.*&#34; --list-hosts</span>
</span></span><span style=display:flex><span>  hosts <span style=color:#f92672>(</span>2<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>    192.168.0.1
</span></span><span style=display:flex><span>    192.168.0.133
</span></span></code></pre></div><p><strong>é€»è¾‘æˆ–</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible &#34;hello:world&#34; --list-hosts</span>
</span></span><span style=display:flex><span>  hosts <span style=color:#f92672>(</span>3<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>    192.168.0.1
</span></span><span style=display:flex><span>    172.31.5.1
</span></span><span style=display:flex><span>    10.0.0.1
</span></span></code></pre></div><p><strong>é€»è¾‘ä¸</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible &#34;hello:&amp;world&#34; --list-hosts</span>
</span></span><span style=display:flex><span>  hosts <span style=color:#f92672>(</span>1<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>    172.31.5.1
</span></span></code></pre></div><p><strong>é€»è¾‘é</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># å¼•ç”¨!å·æ—¶,ä¸è¦ç”¨åŒå¼•å·,è€Œä½¿ç”¨å•å¼•å·</span>
</span></span><span style=display:flex><span><span style=color:#75715e># åœ¨Ansibleä¸­ï¼Œå•å¼•å·ç”¨äºæŒ‡å®šå­—é¢å€¼æ¨¡å¼ï¼Œä»¥ç¡®ä¿å…¶ä¸­çš„å†…å®¹è¢«è§†ä¸ºæ™®é€šå­—ç¬¦ï¼Œè€Œä¸è¿›è¡Œå˜é‡å±•å¼€æˆ–è½¬ä¹‰å­—ç¬¦å¤„ç†ã€‚</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible &#39;all:!hello:!world&#39; --list-hosts</span>
</span></span><span style=display:flex><span>  hosts <span style=color:#f92672>(</span>1<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>    192.168.0.133
</span></span></code></pre></div><p><strong>æ­£åˆ™è¡¨è¾¾å¼</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ansible <span style=color:#e6db74>&#34;~(web|db).*\.test\.com&#34;</span> -m ping
</span></span></code></pre></div><p><code>"~(web|db).*\.test\.com"</code>æ˜¯ç”¨äºé€‰æ‹©ç›®æ ‡ä¸»æœºçš„æ¨¡å¼ï¼ˆpatternï¼‰ã€‚è®©æˆ‘ä»¬é€æ­¥è§£é‡Šè¿™ä¸ªæ¨¡å¼ï¼š</p><ul><li><code>~</code>æ˜¯Ansibleä¸­ç”¨äºåŒ¹é…æ­£åˆ™è¡¨è¾¾å¼çš„è¿ç®—ç¬¦ã€‚</li><li><code>(web|db)</code>è¡¨ç¤ºé€‰æ‹©ä»¥"web"æˆ–"db"å¼€å¤´çš„å­—ç¬¦ä¸²ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¨¡å¼å°†åŒ¹é…"web"æˆ–"db"ä¹‹åçš„ä»»æ„å­—ç¬¦ã€‚</li><li><code>.*</code>è¡¨ç¤ºåŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªä»»æ„å­—ç¬¦ã€‚</li><li><code>\.test\.com</code>è¡¨ç¤ºåŒ¹é…å­—ç¬¦ä¸²".test.com"ã€‚</li></ul><p>å› æ­¤ï¼Œæ•´ä¸ªæ¨¡å¼<code>~(web|db).*\.test\.com</code>å°†åŒ¹é…ä»¥"web"æˆ–"db"å¼€å¤´ï¼Œç„¶åæ˜¯ä»»æ„å­—ç¬¦ï¼ˆé›¶ä¸ªæˆ–å¤šä¸ªï¼‰ï¼Œæœ€åä»¥".test.com"ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚</p><p>ä½¿ç”¨è¯¥æ¨¡å¼ï¼Œ<code>ansible</code>å‘½ä»¤å°†é€‰æ‹©ç¬¦åˆè¯¥æ¨¡å¼çš„è¿œç¨‹ä¸»æœºï¼Œå¹¶å¯¹å®ƒä»¬æ‰§è¡ŒPingæ“ä½œã€‚Pingæ“ä½œæ—¨åœ¨æ£€æŸ¥ä¸ç›®æ ‡ä¸»æœºçš„è¿é€šæ€§ï¼Œå¹¶ç¡®å®šæ˜¯å¦å¯ä»¥ä¸ä¹‹é€šä¿¡ã€‚</p><p>ç»¼ä¸Šæ‰€è¿°ï¼Œ<code>ansible "~(web|db).*\.test\.com" -m ping</code>å‘½ä»¤å°†ä½¿ç”¨Ansibleé€‰æ‹©ä»¥"web"æˆ–"db"å¼€å¤´ï¼Œç„¶åæ˜¯ä»»æ„å­—ç¬¦ï¼Œæœ€åä»¥".test.com"ç»“å°¾çš„ä¸»æœºï¼Œå¹¶å¯¹å®ƒä»¬æ‰§è¡ŒPingæ“ä½œã€‚</p><h5 id=2323-ansible-å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹>2.3.2.3 Ansible å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹<a hidden class=anchor aria-hidden=true href=#2323-ansible-å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹>#</a></h5><ol><li>åŠ è½½é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤ä¸º <code>/etc/ansible/ansible.cfg</code></li><li>åŒ¹é…ä¸»æœºæ¸…å•ä¸­å¯¹åº”çš„ä¸»æœºæˆ–è€…ä¸»æœºç»„</li><li>åŠ è½½å¯¹åº”çš„æ¨¡å—æ–‡ä»¶ï¼Œå¦‚ï¼šshell</li><li>é€šè¿‡ ansible å°†æ¨¡å—æˆ–å‘½ä»¤ç”Ÿæˆä¸´æ—¶ py æ–‡ä»¶ï¼Œå¹¶å°†è¯¥æ–‡ä»¶ä¼ è¾“è‡³å—æ§èŠ‚ç‚¹ï¼š<code>$HOME/.ansible/tmp/ansible-tmp-æ•°å­—/XXX.PYæ–‡ä»¶</code></li><li>èµ‹äºˆ <code>xxx.py</code> æ–‡ä»¶æ‰§è¡Œæƒé™ï¼š<code>+x</code></li><li>æ‰§è¡Œå¹¶è¿”å›ç»“æœ</li><li>åˆ é™¤ <code>xxx.py</code> æ–‡ä»¶ï¼Œç»“æŸ</li></ol><h5 id=2324-ansible-å‘½ä»¤æ‰§è¡ŒçŠ¶æ€>2.3.2.4 Ansible å‘½ä»¤æ‰§è¡ŒçŠ¶æ€<a hidden class=anchor aria-hidden=true href=#2324-ansible-å‘½ä»¤æ‰§è¡ŒçŠ¶æ€>#</a></h5><p>æ¯ç§çŠ¶æ€å¯¹åº”äº†ä¸€ä¸ªé¢œè‰²æ ‡è¯†</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># grep -A 14 &#39;\[colors\]&#39; /etc/ansible/ansible.cfg</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>colors<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#highlight = white</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#verbose = blue</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#warn = bright purple</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#error = red</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#debug = dark gray</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#deprecate = purple</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#skip = cyan</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#unreachable = red</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#ok = green</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#changed = yellow</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#diff_add = green</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#diff_remove = red</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#diff_lines = cyan</span>
</span></span></code></pre></div><p>å¸¸è§çš„ä¸‰ç§é¢œè‰²æ ‡è¯†ï¼š</p><ul><li><p><strong>ç»¿è‰²</strong>ï¼šè¡¨ç¤ºä»»åŠ¡æˆåŠŸå®Œæˆã€‚å½“ä»»åŠ¡åœ¨è¿œç¨‹ä¸»æœºä¸ŠæˆåŠŸæ‰§è¡Œå¹¶è¿”å›æ­£ç¡®çš„ç»“æœæ—¶ï¼Œè¯¥ä»»åŠ¡å°†ä»¥ç»¿è‰²æ˜¾ç¤ºã€‚</p></li><li><p>**é»„è‰²ï¼š**è¡¨ç¤ºä»»åŠ¡å·²æ›´æ”¹ã€‚å½“ä»»åŠ¡åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œå¹¶å¯¼è‡´ä¸€äº›æ›´æ”¹æ—¶ï¼Œä½†ä¸ä¼šç ´åç³»ç»Ÿæˆ–å¼•å‘é”™è¯¯æ—¶ï¼Œè¯¥ä»»åŠ¡å°†ä»¥é»„è‰²æ˜¾ç¤ºã€‚ä¾‹å¦‚ï¼Œå¦‚æœæŸä¸ªé…ç½®æ–‡ä»¶çš„æŸè¡Œå·²æ›´æ”¹ï¼Œä½†è¯¥æ›´æ”¹ä¸ä¼šå¯¼è‡´é—®é¢˜æˆ–é”™è¯¯ï¼Œä»»åŠ¡çŠ¶æ€å°†æ˜¾ç¤ºä¸ºé»„è‰²ã€‚</p></li><li><p>**çº¢è‰²ï¼š**è¡¨ç¤ºä»»åŠ¡å¤±è´¥ã€‚å½“ä»»åŠ¡åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œæ—¶å‘ç”Ÿé”™è¯¯æˆ–è¿”å›é”™è¯¯ç»“æœæ—¶ï¼Œè¯¥ä»»åŠ¡å°†ä»¥çº¢è‰²æ˜¾ç¤ºã€‚è¿™å¯èƒ½æ˜¯ç”±äºè¿æ¥é—®é¢˜ã€æƒé™é—®é¢˜ã€è¯­æ³•é”™è¯¯æˆ–å…¶ä»–åŸå› å¯¼è‡´çš„å¤±è´¥ã€‚</p></li></ul><h4 id=233-ansible-console>2.3.3 ansible-console<a hidden class=anchor aria-hidden=true href=#233-ansible-console>#</a></h4><p>æ­¤å·¥å…·ä¸»è¦ç”¨äºäº¤äº’å¼æ‰§è¡Œå‘½ä»¤ï¼Œæ”¯æŒå‘½ä»¤è¡¥å…¨ï¼Œansible 2.0+ ç‰ˆæœ¬æ–°å¢</p><p>æç¤ºç¬¦æ ¼å¼ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>è¿œç¨‹ç”¨æˆ·@ç›®æ ‡ä¸»æœºç»„ï¼ˆç»„ä¸­çš„ä¸»æœºæ•°é‡ï¼‰<span style=color:#f92672>[</span>f:å¹¶å‘æ•°<span style=color:#f92672>]</span>$
</span></span></code></pre></div><p>å¸¸ç”¨å‘½ä»¤ï¼š</p><ul><li><p>è®¾ç½®å¹¶å‘æ•°ï¼šforks <number></p></li><li><p>åˆ‡æ¢ç»„ï¼šcd [group_name]</p></li><li><p>æŸ¥çœ‹å½“å‰ç»„ä¸­çš„ä¸»æœºï¼šlist</p></li><li><p>æŸ¥çœ‹æ‰€æœ‰çš„å†…ç½®å‘½ä»¤ï¼šï¼Ÿæˆ– help</p></li><li><p>é€€å‡ºï¼šexit æˆ–è€… Ctrl+ D</p></li></ul><p>ç¤ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible-console</span>
</span></span><span style=display:flex><span>Welcome to the ansible console.
</span></span><span style=display:flex><span>Type help or ? to list commands.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@all <span style=color:#f92672>(</span>4<span style=color:#f92672>)[</span>f:5<span style=color:#f92672>]</span>$ forks <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>root@all <span style=color:#f92672>(</span>4<span style=color:#f92672>)[</span>f:6<span style=color:#f92672>]</span>$ cd hello
</span></span><span style=display:flex><span>root@hello <span style=color:#f92672>(</span>2<span style=color:#f92672>)[</span>f:6<span style=color:#f92672>]</span>$ exit
</span></span></code></pre></div><h4 id=234-ansible-playbook>2.3.4 ansible-playbook<a hidden class=anchor aria-hidden=true href=#234-ansible-playbook>#</a></h4><p>æ­¤å·¥å…·ä¸»è¦ç”¨äºæ‰§è¡Œç¼–å†™å¥½çš„ playbook ä»»åŠ¡</p><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat hello.yaml # playbook ä»»åŠ¡ï¼Œæ‰“å° hello world</span>
</span></span><span style=display:flex><span>- hosts: localhost
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: hello world
</span></span><span style=display:flex><span>      shell: wall <span style=color:#e6db74>&#34;hello world&#34;</span> <span style=color:#75715e># å‘æ‰€æœ‰å·²ç™»å½•ç”¨æˆ·å¹¿æ’­æ¶ˆæ¯</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook hello.yaml # æ‰§è¡Œ playbook ä»»åŠ¡</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>localhost<span style=color:#f92672>]</span> ***************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>hello world<span style=color:#f92672>]</span> *************************************************************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Broadcast message from root@ansible.localdomain <span style=color:#f92672>(</span>Mon Jun <span style=color:#ae81ff>19</span> 09:15:36 2023<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hello world
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>localhost<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************************************************************************************
</span></span><span style=display:flex><span>localhost                  : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span></code></pre></div><h4 id=235-ansible-vault>2.3.5 ansible-vault<a hidden class=anchor aria-hidden=true href=#235-ansible-vault>#</a></h4><p>æ­¤å·¥å…·ç”¨äºåŠ å¯†ï¼Œè§£å¯† yaml æ–‡ä»¶</p><p>æ ¼å¼ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ansible-vault <span style=color:#f92672>[</span>create,decrypt,edit,view,encrypt,encrypt_string,rekey<span style=color:#f92672>]</span> &lt;*.yaml&gt;
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-vault encrypt hello.yaml # åŠ å¯†æ–‡ä»¶</span>
</span></span><span style=display:flex><span>New Vault password: 
</span></span><span style=display:flex><span>Confirm New Vault password: 
</span></span><span style=display:flex><span>Encryption successful
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-vault view hello.yaml # æŸ¥çœ‹åŠ å¯†æ–‡ä»¶å†…å®¹ï¼Œéœ€è¦è¾“å…¥æ­£ç¡®çš„å¯†ç </span>
</span></span><span style=display:flex><span>Vault password: 
</span></span><span style=display:flex><span>- hosts: localhost
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: hello world
</span></span><span style=display:flex><span>      shell: wall <span style=color:#e6db74>&#34;hello world&#34;</span>
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat hello.yaml # æ­£å¸¸æŸ¥çœ‹ï¼Œåªèƒ½çœ‹åˆ°å¯†æ–‡</span>
</span></span><span style=display:flex><span>$ANSIBLE_VAULT;1.1;AES256
</span></span><span style=display:flex><span><span style=color:#ae81ff>62623561653235343235613763393365396164323430366161363731646339303965316136333964</span>
</span></span><span style=display:flex><span>6662366334363161363465636630646532616334666538640a383037313035646537613264306130
</span></span><span style=display:flex><span><span style=color:#ae81ff>62323438653861613736336339353037373537633066396566366136373832666332636364336362</span>
</span></span><span style=display:flex><span>6130363834346566630a343765303630616631643436373036353966356663366537343863653535
</span></span><span style=display:flex><span><span style=color:#ae81ff>65653565653765363961313738386266336538353336376664643330316633303636333337336237</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>35653162313461383436643237623034363436373430363237346334663062306638386566313738</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>36346165643437643230396664346564383039623434346332313961303331383331313761663939</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>63313665306463356433393731663965366131353336666135343530613062306433623234623666</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>39633764623862353238613139333264343735303330626432363831646331653666313361316565</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3034363863323531393761316363626263653838313734343134</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook hello.yaml # ä¸èƒ½ç›´æ¥æ‰§è¡Œå·²åŠ å¯†çš„ playbook </span>
</span></span><span style=display:flex><span>ERROR! Attempting to decrypt but no vault secrets found
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook --ask-vault-pass hello.yaml # åŠ å…¥é€‰é¡¹ï¼Œè¾“å…¥å¯†ç åæ‰§è¡Œ</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat pass.txt # å‡†å¤‡å¯†ç æ–‡ä»¶ï¼Œå­˜æ”¾å¯†ç </span>
</span></span><span style=display:flex><span>dd
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook --vault-password-file pass.txt hello.yaml # ä»æ–‡ä»¶ä¸­è¯»å–å¯†ç </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># grep vault_password_file /etc/ansible/ansible.cfg # ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„è¯¥é¡¹ï¼ŒæŒ‡å®šå¯†ç æ–‡ä»¶è·¯å¾„</span>
</span></span><span style=display:flex><span>vault_password_file <span style=color:#f92672>=</span> /etc/ansible/pass.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook hello.yaml # å¯ä»¥æ­£å¸¸æ‰§è¡Œ playbook</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-vault edit hello.yaml # ç¼–è¾‘åŠ å¯†æ–‡ä»¶ï¼Œéœ€è¦è¾“å…¥æ­£ç¡®çš„å¯†ç </span>
</span></span><span style=display:flex><span>Vault password: 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-vault decrypt hello.yaml # è§£å¯†æ–‡ä»¶</span>
</span></span><span style=display:flex><span>Vault password: 
</span></span><span style=display:flex><span>Decryption successful
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat hello.yaml # å¯ä»¥çœ‹åˆ°æœªåŠ å¯†çš„åŸæ–‡</span>
</span></span><span style=display:flex><span>- hosts: localhost
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: hello world
</span></span><span style=display:flex><span>      shell: wall <span style=color:#e6db74>&#34;hello world +++&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-vault create new.yaml # å¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ªåŠ å¯†æ–‡ä»¶</span>
</span></span><span style=display:flex><span>New Vault password: 
</span></span><span style=display:flex><span>Confirm New Vault password: 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-vault rekey new.yaml # è¾“å…¥æ—§å¯†ç åï¼Œå¯ä»¥æ›´æ”¹å¯†ç </span>
</span></span><span style=display:flex><span>Vault password: 
</span></span><span style=display:flex><span>New Vault password: 
</span></span><span style=display:flex><span>Confirm New Vault password: 
</span></span><span style=display:flex><span>Rekey successful
</span></span></code></pre></div><h4 id=236-ansible-galaxy>2.3.6 ansible-galaxy<a hidden class=anchor aria-hidden=true href=#236-ansible-galaxy>#</a></h4><p>Galaxy æ˜¯ä¸€ä¸ªå…è´¹ç½‘ç«™, ç±»ä¼¼äºgithubç½‘ç«™, ç½‘ç«™ä¸Šå‘å¸ƒäº†å¾ˆå¤šçš„å…±äº«çš„rolesè§’è‰²ã€‚</p><p>Ansible æä¾›äº†ansible-galaxyå‘½ä»¤è¡Œå·¥å…·è¿æ¥ <a href=https://galaxy.ansible.com>https://galaxy.ansible.com</a> ç½‘ç«™ä¸‹è½½ç›¸åº”çš„rolesï¼Œè¿›è¡Œ</p><p>init (åˆå§‹åŒ–)ã€search ( æŸ¥æ‹˜)ã€install (å®‰è£…)ã€ remove(ç§»é™¤)ç­‰æ“ä½œã€‚</p><p><code>ansible-galaxy</code>æ˜¯ä¸€ä¸ªä¸Ansibleé…ç½®ç®¡ç†å·¥å…·ç›¸å…³çš„å‘½ä»¤è¡Œå·¥å…·ã€‚å®ƒç”¨äºç®¡ç†å’Œæ‰©å±•Ansibleè§’è‰²å’Œé›†åˆã€‚</p><p>ä½¿ç”¨<code>ansible-galaxy</code>ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ol><li><p><strong>å®‰è£…è§’è‰²å’Œé›†åˆ</strong>ï¼šå¯ä»¥ä½¿ç”¨<code>ansible-galaxy install</code>å‘½ä»¤å®‰è£…å…¶ä»–äººç¼–å†™çš„Ansibleè§’è‰²æˆ–é›†åˆã€‚ä¾‹å¦‚ï¼Œè¦å®‰è£…ä¸€ä¸ªåä¸º<code>myrole</code>çš„è§’è‰²ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆé»˜è®¤ä¸‹è½½åˆ°~/.ansible/rolesä¸‹ï¼‰ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-galaxy install myrole
</span></span></code></pre></div></li><li><p><strong>åˆ›å»ºè§’è‰²</strong>ï¼šä½¿ç”¨<code>ansible-galaxy init</code>å‘½ä»¤å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„Ansibleè§’è‰²ç»“æ„ã€‚è¯¥å‘½ä»¤å°†ç”Ÿæˆä¸€ä¸ªåŒ…å«ç›®å½•å’Œæ–‡ä»¶çš„ç›®å½•ç»“æ„ï¼Œç”¨äºç»„ç»‡è§’è‰²çš„ä»»åŠ¡ã€å˜é‡ã€æ¨¡æ¿ç­‰å†…å®¹ã€‚ä¾‹å¦‚ï¼Œè¦åˆ›å»ºä¸€ä¸ªåä¸º<code>myrole</code>çš„è§’è‰²ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-galaxy init myrole
</span></span></code></pre></div></li><li><p><strong>åˆ—å‡ºå·²å®‰è£…çš„è§’è‰²å’Œé›†åˆ</strong>ï¼šä½¿ç”¨<code>ansible-galaxy list</code>å‘½ä»¤å¯ä»¥åˆ—å‡ºå·²ç»å®‰è£…åœ¨ç³»ç»Ÿä¸Šçš„è§’è‰²å’Œé›†åˆã€‚è¿™å°†æ˜¾ç¤ºå·²å®‰è£…çš„è§’è‰²å’Œé›†åˆçš„åç§°ã€ç‰ˆæœ¬å·å’Œå…¶ä»–è¯¦ç»†ä¿¡æ¯ã€‚</p></li><li><p><strong>åˆ é™¤è§’è‰²å’Œé›†åˆ</strong>ï¼šå¯ä»¥ä½¿ç”¨<code>ansible-galaxy remove</code>å‘½ä»¤ä»ç³»ç»Ÿä¸­åˆ é™¤å·²å®‰è£…çš„è§’è‰²å’Œé›†åˆã€‚ä¾‹å¦‚ï¼Œè¦åˆ é™¤ä¸€ä¸ªåä¸º<code>myrole</code>çš„è§’è‰²ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-galaxy remove myrole
</span></span></code></pre></div></li></ol><p>è¿™äº›åªæ˜¯<code>ansible-galaxy</code>å‘½ä»¤çš„ä¸€äº›å¸¸è§ç”¨æ³•ç¤ºä¾‹ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯å’Œé€‰é¡¹ï¼Œè¯·æŸ¥é˜…Ansibleå®˜æ–¹æ–‡æ¡£æˆ–è¿è¡Œ<code>ansible-galaxy --help</code>å‘½ä»¤æ¥è·å–å¸®åŠ©ã€‚</p><h3 id=24-ansible-å¸¸ç”¨æ¨¡å—>2.4 Ansible å¸¸ç”¨æ¨¡å—<a hidden class=anchor aria-hidden=true href=#24-ansible-å¸¸ç”¨æ¨¡å—>#</a></h3><p>2015å¹´12æœˆåª270å¤šä¸ªæ¨¡å—</p><p>2016å¹´12å¹´26æ—¥ansible 1.9.2 æœ‰540ä¸ªæ¨¡å—</p><p>2018å¹´01æœˆ12æ—¥ansible 2.3.8 æœ‰1378ä¸ªæ¨¡å—</p><p>2018å¹´05æœˆ28æ—¥ansible 2.5.3 æœ‰1562ä¸ªæ¨¡å—</p><p>2018å¹´07æœˆ15æ—¥ansible 2.6.3 æœ‰1852ä¸ªæ¨¡å—</p><p>2018å¹´11æœˆ19æ—¥ansible 2.7.2 æœ‰2080ä¸ªæ¨¡å—</p><p>2020å¹´03æœˆ02æ—¥ansible 2.9.5 æœ‰3387ä¸ªæ¨¡å—</p><p>2021å¹´12æœˆ22æ—¥ansible 2.11.8 æœ‰6141ä¸ªæ¨¡å—</p><p>2022å¹´06æœˆ04æ—¥ansible 2.12.6 æœ‰6763ä¸ªæ¨¡å—</p><p>è™½ç„¶æ¨¡å—ä¼—å¤šï¼Œä½†æœ€å¸¸ç”¨çš„æ¨¡å—çº¦30ä¸ªå·¦å³ï¼Œé’ˆå¯¹ç‰¹å®šä¸šåŠ¡å­¦ä¹ éœ€è¦çš„æ¨¡å—å³å¯</p><p>å¸¸ç”¨æ¨¡å—å¸®åŠ©æ–‡æ¡£å‚è€ƒï¼š</p><p><a href=https://docs.ansible.com/ansible/2.9/modules/modules_by_category.html>Module Index â€” Ansible Documentation</a></p><p><a href=https://docs.ansible.com/ansible/2.9/modules/list_of_all_modules.html>All modules â€” Ansible Documentation</a></p><p><strong>æœ¬ç« èŠ‚å†…å®¹ä»¥æ­¤ä¸»æœºæ¸…å•è¿›è¡Œæ¼”ç¤ºï¼Œansible ä¸ºç®¡ç†èŠ‚ç‚¹ï¼Œremote ä¸ºå—æ§èŠ‚ç‚¹</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># hostname -I</span>
</span></span><span style=display:flex><span>192.168.0.133
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># cat /etc/ansible/hosts</span>
</span></span><span style=display:flex><span>remote ansible_ssh_host<span style=color:#f92672>=</span>192.168.0.134
</span></span><span style=display:flex><span>remote2 ansible_ssh_host<span style=color:#f92672>=</span>192.168.0.135
</span></span></code></pre></div><h4 id=241-command-æ¨¡å—>2.4.1 command æ¨¡å—<a hidden class=anchor aria-hidden=true href=#241-command-æ¨¡å—>#</a></h4><blockquote><p>é»˜è®¤æ¨¡å—ã€‚åœ¨è¿œç¨‹ä¸»æœºæ‰§è¡Œå‘½ä»¤ï¼Œæ‰§è¡Œå‘½ä»¤æ—¶ä¸åŠ  -m åˆ™é»˜è®¤ä½¿ç”¨æ­¤æ¨¡å—</p><p>æ­¤å‘½ä»¤ä¸æ”¯æŒ <code>&lt;</code>, <code>></code>, <code>|</code>, <code>;</code> and <code>&</code> ç­‰é«˜çº§ç‰¹æ€§æˆ–è¿ç®—ç¬¦</p><p><strong>æ­¤æ¨¡å—ä¸å…·å¤‡å¹‚ç­‰æ€§</strong></p></blockquote><p>å¸¸ç”¨é€‰é¡¹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>chdir=DIR		# åˆ‡æ¢ç›®å½•</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>creates=FILE	# å½“ FILE ä¸å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œæ“ä½œ</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>removes=FILE	# å½“ FILE å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œæ“ä½œ	</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># åˆ‡æ¢ç›®å½•ï¼ŒæŸ¥çœ‹ç³»ç»Ÿç‰ˆæœ¬</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -a &#39;chdir=/etc cat centos-release&#39;</span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>CentOS Linux release 7.6.1810 <span style=color:#f92672>(</span>Core<span style=color:#f92672>)</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å½“ /tmp/tmp.txt å­˜åœ¨æ—¶ï¼Œæ‰“å° hello</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -a &#39;chdir=/etc creates=/tmp/tmp.txt echo hello&#39;</span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>hello
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å½“ /tmp/tmp.txt å­˜åœ¨æ—¶ï¼Œæ‰“å° hellï¼Œè¿™é‡Œæ¡ä»¶ä¸æ»¡è¶³ï¼Œä»»åŠ¡ç›´æ¥è¢«è·³è¿‡</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -a &#39;chdir=/etc removes=/tmp/tmp.txt echo hello&#39;</span>
</span></span><span style=display:flex><span>localhost | SUCCESS | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>skipped, since /tmp/tmp.txt does not exist
</span></span></code></pre></div><p>ä¸æ”¯æŒçš„é«˜çº§ç‰¹æ€§ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># åˆ›å»º hello.txt, å‘½ä»¤æ‰§è¡ŒæˆåŠŸ</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -a &#39;chdir=/tmp echo hello &gt; hello.txt&#39; </span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>hello &gt; hello.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å®é™…ä¸Šæ–‡ä»¶å¹¶ä¸å­˜åœ¨</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -a &#39;chdir=/tmp ll hello.txt&#39; </span>
</span></span><span style=display:flex><span>localhost | FAILED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Errno 2<span style=color:#f92672>]</span> No such file or directory
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ll /tmp/hello.txt</span>
</span></span><span style=display:flex><span>ls: cannot access /tmp/hello.txt: No such file or directory
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ä¸æ”¯æŒ &amp;&amp;  ; | ç­‰ç¬¦å·ï¼ˆå°½ç®¡æ‰§è¡Œä¸æŠ¥é”™ï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -a &#39;chdir=/tmp echo hello &gt; hello.txt &amp;&amp; echo world&#39;</span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>hello &gt; hello.txt <span style=color:#f92672>&amp;&amp;</span> echo world
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -a &#39;chdir=/tmp echo hello &gt; hello.txt ; echo world&#39;</span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>hello &gt; hello.txt ; echo world
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m command -a &#34;echo test | passwd --stdin pass&#34;</span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>test | passwd --stdin pass
</span></span></code></pre></div><h4 id=242-shell-æ¨¡å—>2.4.2 shell æ¨¡å—<a hidden class=anchor aria-hidden=true href=#242-shell-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—åŠŸèƒ½ä¸ command å‡ ä¹ä¸€è‡´ï¼Œä½†æ˜¯åŠŸèƒ½ä¼šæ›´å¼ºã€‚Command æ¨¡å—ä¸æ”¯æŒçš„é‡å®šå‘ï¼Œç®¡é“ç¬¦ç­‰è¿ç®—ç¬¦åœ¨ Shell æ¨¡å—ä¸­éƒ½æ˜¯æ”¯æŒçš„ï¼ˆå°½ç®¡å¦‚æ­¤ï¼Œå®é™…ä½¿ç”¨æ—¶å°½é‡é¿å…ä½¿ç”¨è¿‡äºå¤æ‚æˆ–ç‰¹æ®Šçš„ç¬¦å·ï¼‰ï¼Œé™¤éæœ‰ä½¿ç”¨é«˜çº§ç‰¹æ€§çš„éœ€æ±‚ï¼Œå¦åˆ™å®˜æ–¹æ›´æ¨èä½¿ç”¨ command æ¨¡å—ï¼ˆæ›´åŠ å®‰å…¨å’Œç¨³å®šï¼‰ã€‚</p><p><strong>æ­¤æ¨¡å—ä¸å…·å¤‡å¹‚ç­‰æ€§</strong></p></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>chdir<span style=color:#f92672>=</span>DIR		<span style=color:#75715e># åˆ‡æ¢ç›®å½•</span>
</span></span><span style=display:flex><span>creates<span style=color:#f92672>=</span>FILE	<span style=color:#75715e># å½“ FILE ä¸å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œæ“ä½œ</span>
</span></span><span style=display:flex><span>removes<span style=color:#f92672>=</span>FILE	<span style=color:#75715e># å½“ FILE å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œæ“ä½œ</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># æ‰“å°å˜é‡</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m shell -a &#34;echo $HOSTNAME&#34;</span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>localhost.localdomain
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ä¿®æ”¹è´¦å·å¯†ç </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m shell -a &#34;echo pass | passwd --stdin test&#34;</span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>Changing password <span style=color:#66d9ef>for</span> user test.
</span></span><span style=display:flex><span>passwd: all authentication tokens updated successfully.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ä½¿ç”¨é‡å®šå‘ç”Ÿæˆæ–‡ä»¶ï¼Œå¹¶è¾“å‡ºå†…å®¹</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m shell -a &#34;echo hello &gt; /tmp/hello.txt &amp;&amp; ls /tmp/hello.txt &amp;&amp; cat /tmp/hello.txt&#34;</span>
</span></span><span style=display:flex><span>localhost | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/hello.txt
</span></span><span style=display:flex><span>hello
</span></span></code></pre></div><blockquote><p>æ³¨æ„ï¼šç±»ä¼¼ cat /tmp/test.md | awk -F&rsquo;|&rsquo; &lsquo;{print $1,$2}&rsquo; &> /tmp/example.txt çš„å¤æ‚å‘½ä»¤ï¼Œå³ä½¿ä½¿ç”¨Shellæ¨¡å—ä¹Ÿå¯èƒ½ä¼šå¤±è´¥ã€‚å¯ä»¥è€ƒè™‘å°†å‘½ä»¤å†™æˆ shell è„šæœ¬ï¼Œå†é€šè¿‡ Script æ¨¡å—è¿›è¡Œè°ƒç”¨</p></blockquote><p><strong>Ansible å‘½ä»¤æ‰€ä½¿ç”¨çš„é»˜è®¤æ¨¡å—æ˜¯ commandï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®é¡¹é‡æ–°æŒ‡å®šä¸ºåˆ«çš„æ¨¡å—ï¼š</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># grep module_name /etc/ansible/ansible.cfg</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#module_name = command</span>
</span></span></code></pre></div><h4 id=243-script-æ¨¡å—>2.4.3 script æ¨¡å—<a hidden class=anchor aria-hidden=true href=#243-script-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—å¯ä»¥åœ¨è¿œç¨‹ä¸»æœºæ‰§è¡Œ Ansible ä¸»æœºä¸Šçš„è„šæœ¬ï¼ˆè„šæœ¬ä¸éœ€è¦æ‰§è¡Œæƒé™ï¼‰</p><p><strong>æ­¤æ¨¡å—ä¸å…·å¤‡å¹‚ç­‰æ€§</strong></p></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chdir<span style=color:#f92672>=</span>DIR		<span style=color:#75715e># åˆ‡æ¢ç›®å½•</span>
</span></span><span style=display:flex><span>creates<span style=color:#f92672>=</span>FILE	<span style=color:#75715e># å½“ FILE ä¸å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œæ“ä½œ</span>
</span></span><span style=display:flex><span>removes<span style=color:#f92672>=</span>FILE	<span style=color:#75715e># å½“ FILE å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œæ“ä½œ	</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># å‡†å¤‡ä¸€ä¸ªè„šæœ¬æ–‡ä»¶</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># cat test.sh </span>
</span></span><span style=display:flex><span>echo hello
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># è¯¥æ–‡ä»¶æ— æ‰§è¡Œæƒé™</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ll test.sh </span>
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>11</span> Jun <span style=color:#ae81ff>20</span> 15:44 test.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># é€šè¿‡ scriptæ¨¡å— åœ¨ç›®æ ‡ä¸»æœºæ‰§è¡Œè¯¥è„šæœ¬</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m script -a &#39;test.sh&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;rc&#34;</span>: 0, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;Shared connection to 192.168.0.134 closed.\r\n&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Shared connection to 192.168.0.134 closed.&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;hello\r\n&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;hello&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=244-copy-æ¨¡å—>2.4.4 copy æ¨¡å—<a hidden class=anchor aria-hidden=true href=#244-copy-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—ç”¨äºæ–‡ä»¶æ‹·è´ï¼Œæœ‰ä¸¤ç§ç”¨æ³•ï¼š</p><ul><li>å°† ansible ä¸»æœºä¸Šçš„æ–‡ä»¶æ‹·è´åˆ°å—æ§èŠ‚ç‚¹</li><li>å°†å—æ§èŠ‚ç‚¹çš„æ–‡ä»¶æ‹·è´åˆ°å—æ§èŠ‚ç‚¹çš„å…¶ä»–è·¯å¾„</li></ul></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>src      <span style=color:#75715e># æ§åˆ¶ç«¯çš„æºæ–‡ä»¶è·¯å¾„</span>
</span></span><span style=display:flex><span>dest     <span style=color:#75715e># è¢«æ§ç«¯çš„æ–‡ä»¶è·¯å¾„</span>
</span></span><span style=display:flex><span>owner    <span style=color:#75715e># å±ä¸»</span>
</span></span><span style=display:flex><span>group    <span style=color:#75715e># å±ç»„</span>
</span></span><span style=display:flex><span>mode     <span style=color:#75715e># æƒé™</span>
</span></span><span style=display:flex><span>backup   <span style=color:#75715e># æ˜¯å¦å¤‡ä»½</span>
</span></span><span style=display:flex><span>validate <span style=color:#75715e># éªŒè¯æˆåŠŸæ‰ä¼šæ‰§è¡Œcopy</span>
</span></span><span style=display:flex><span>remote_src  <span style=color:#75715e># no æ˜¯é»˜è®¤å€¼, è¡¨ç¤º src æ–‡ä»¶åœ¨ ansible ä¸»æœº, yesè¡¨ç¤º src æ–‡ä»¶åœ¨è¿œç¨‹ä¸»æœº</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºlocal.txt å¹¶å°†å…¶æ‹·è´åˆ° remote ä¸»æœºä¸Š</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># touch local.txt</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m copy -a &#39;src=local.txt dest=/tmp/remote.txt owner=test mode=600&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æˆåŠŸæ‹·è´åˆ° remote ä¸»æœº</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;ls /tmp/remote.txt&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/remote.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ä¿®æ”¹local.txt æ–‡ä»¶å†…å®¹ï¼Œå†æ¬¡æ‰§è¡Œæ‹·è´æ“ä½œ</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># echo hello &gt;&gt; local.txt </span>
</span></span><span style=display:flex><span><span style=color:#75715e># å½“æ–‡ä»¶å†…å®¹å˜åŒ–ï¼Œä¸” backup=yes æ—¶ï¼Œä¼šåœ¨æ‹·è´æ“ä½œæ‰§è¡Œå‰ï¼Œåœ¨ç›®æ ‡ä¸»æœºç”Ÿæˆä¸€ä¸ªä»¥æ—¶é—´æˆ³ä¸ºåç¼€çš„å¤‡ä»½æ–‡ä»¶ï¼Œå¦‚ï¼šremote.txt.9235.2023-06-20@16:52:58~</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#34;ls /tmp&#34;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>ansible_command_payload_QQiJzZ
</span></span><span style=display:flex><span>remote.txt
</span></span><span style=display:flex><span>remote.txt.9235.2023-06-20@16:52:58~
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ‹·è´ remote ä¸»æœºçš„æ–‡ä»¶åˆ°æŒ‡å®šè·¯å¾„ï¼Œremote_src è¡¨ç¤ºæºæ–‡ä»¶åœ¨ç›®æ ‡ä¸»æœºä¸Š</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m copy -a &#34;src=/tmp/remote.txt dest=/tmp/local.txt owner=test mode=600 remote_src=yes&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æˆåŠŸåœ¨ remote ä¸»æœºçš„ /tmp ç›®å½•ä¸‹ å¤åˆ¶äº†ä¸€ä¸ª local.txt æ–‡ä»¶</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#34;ls /tmp/local.txt&#34;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/local.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ç›´æ¥æŒ‡å®šæ–‡ä»¶å†…å®¹ï¼Œç”Ÿæˆæ–‡ä»¶</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m copy -a &#39;content=&#34;hello\nworld\n&#34; dest=/tmp/hello.txt&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;cat /tmp/hello.txt&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>hello
</span></span><span style=display:flex><span>world
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#### æ‹·è´æ•´ä¸ªæ–‡ä»¶å¤¹ /tmp åˆ° remote ä¸»æœºã€‚æ³¨æ„ï¼šæ˜¯ /tmp è€Œé /tmp/</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m copy -a &#39;src=/tmp dest=/tmp/&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;ls -d /tmp/tmp&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/tmp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>### æ‹·è´/tmp æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶åˆ°ç›®æ ‡ä¸»æœº</span>
</span></span><span style=display:flex><span><span style=color:#75715e># æå‰åœ¨ç›®æ ‡ä¸»æœºæ–°å»ºä¸€ä¸ªç©ºæ–‡ä»¶å¤¹ç”¨äºå­˜æ”¾ /tmp ç›®å½•ä¸‹çš„æ–‡ä»¶</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@remote ~<span style=color:#f92672>]</span><span style=color:#75715e># ls -d /test/</span>
</span></span><span style=display:flex><span>/test/
</span></span><span style=display:flex><span><span style=color:#75715e># åœ¨ /tmp æ–‡ä»¶å¤¹ä¸‹æœ‰ä¸€ä¸ª test.txt æ–‡ä»¶</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ls /tmp/test.txt </span>
</span></span><span style=display:flex><span>/tmp/test.txt
</span></span><span style=display:flex><span><span style=color:#75715e># æ‰§è¡Œæ‹·è´æ“ä½œï¼Œè§‚å¯Ÿåˆ°æˆåŠŸæ‹·è´ /tmp æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶åˆ°ç›®æ ‡ä¸»æœº</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m copy -a &#39;src=/tmp/ dest=/test&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;ls /test&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>test.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å¤åˆ¶æ–‡ä»¶å¹¶æ‰§è¡Œæ ¡éªŒå‘½ä»¤ï¼Œæ³¨æ„ï¼š%s æ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œå°†åœ¨å‘½ä»¤æ‰§è¡Œæ—¶è¢«æ›¿æ¢ä¸ºæºæ–‡ä»¶çš„è·¯å¾„ã€‚</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m copy -a &#34;src=/etc/sudoers dest=/etc/sudoers.bak remote_src=yes validate=&#39;/usr/sbin/visudo -csf %s&#39;&#34;</span>
</span></span></code></pre></div><h4 id=245-get_url-æ¨¡å—>2.4.5 get_url æ¨¡å—<a hidden class=anchor aria-hidden=true href=#245-get_url-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—ä½¿ç”¨ httpã€https æˆ– ftp åè®®ä¸‹è½½æ–‡ä»¶</p></blockquote><p>å¸¸ç”¨å‚æ•°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>url   <span style=color:#75715e># ä¸‹è½½æ–‡ä»¶çš„URL,æ”¯æŒ HTTPï¼ŒHTTPS æˆ– FTP åè®®</span>
</span></span><span style=display:flex><span>dest  <span style=color:#75715e># ä¸‹è½½åˆ°ç›®æ ‡è·¯å¾„ï¼ˆç»å¯¹è·¯å¾„ï¼‰ï¼Œå¦‚æœç›®æ ‡æ˜¯ä¸€ä¸ªç›®å½•ï¼Œå°±ç”¨åŸæ–‡ä»¶åï¼Œå¦‚æœç›®æ ‡è®¾ç½®äº†åç§°å°±ç”¨ç›®æ ‡è®¾ç½®çš„åç§°</span>
</span></span><span style=display:flex><span>owner <span style=color:#75715e># æŒ‡å®šå±ä¸»</span>
</span></span><span style=display:flex><span>group <span style=color:#75715e># æŒ‡å®šå±ç»„</span>
</span></span><span style=display:flex><span>mode  <span style=color:#75715e># æŒ‡å®šæƒé™</span>
</span></span><span style=display:flex><span>force <span style=color:#75715e># å¦‚æœ yesï¼Œdest ä¸æ˜¯ç›®å½•ï¼Œå°†æ¯æ¬¡ä¸‹è½½æ–‡ä»¶ï¼Œå¦‚æœå†…å®¹æ”¹å˜æ›¿æ¢æ–‡ä»¶ã€‚å¦‚æœ noï¼Œåˆ™åªæœ‰åœ¨ç›®æ ‡ä¸å­˜åœ¨æ—¶æ‰ä¼šä¸‹è½½ï¼Œé»˜è®¤ï¼šno</span>
</span></span><span style=display:flex><span>checksum  <span style=color:#75715e># å¯¹ç›®æ ‡æ–‡ä»¶åœ¨ä¸‹è½½åè®¡ç®—æ‘˜è¦ï¼Œä»¥ç¡®ä¿å…¶å®Œæ•´æ€§</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># ç¤ºä¾‹: </span>
</span></span><span style=display:flex><span>             <span style=color:#75715e>#    checksum=&#34;sha256:D98291AC[...]B6DC7B97&#34;,</span>
</span></span><span style=display:flex><span>             <span style=color:#75715e>#    checksum=&#34;sha256:http://example.com/path/sha256sum.txt&#34;</span>
</span></span><span style=display:flex><span>url_username <span style=color:#75715e># ç”¨äºHTTPåŸºæœ¬è®¤è¯çš„ç”¨æˆ·åã€‚ å¯¹äºå…è®¸ç©ºå¯†ç çš„ç«™ç‚¹ï¼Œæ­¤å‚æ•°å¯ä»¥ä¸ä½¿ç”¨</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>`</span>url_password<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>url_password # ç”¨äºHTTPåŸºæœ¬è®¤è¯çš„å¯†ç ã€‚ å¦‚æœæœªæŒ‡å®š`url_username&#39;</span>å‚æ•°ï¼Œåˆ™ä¸ç”Ÿæ•ˆ
</span></span><span style=display:flex><span><span style=color:#e6db74>`</span>url_password<span style=color:#960050;background-color:#1e0010>&#39;</span>å‚æ•°
</span></span><span style=display:flex><span>validate_certs <span style=color:#75715e># å¦‚æœâ€œnoâ€ï¼ŒSSLè¯ä¹¦å°†ä¸ä¼šè¢«éªŒè¯ã€‚ é€‚ç”¨äºè‡ªç­¾åè¯ä¹¦åœ¨ç§æœ‰ç½‘ç«™ä¸Šä½¿ç”¨</span>
</span></span><span style=display:flex><span>timeout  <span style=color:#75715e># URLè¯·æ±‚çš„è¶…æ—¶æ—¶é—´,ç§’ä¸ºå•ä½</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># ä¸‹è½½ nginx è‡³ remote ä¸»æœºï¼Œå¹¶æ ¡éªŒ md5 å€¼ </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m get_url -a &#39;url=http://nginx.org/download/nginx-1.18.0.tar.gz dest=/usr/local/src checksum=&#34;md5:b2d33d24d89b8b1f87ff5d251aa27eb8&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ä¸‹è½½æˆåŠŸ</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;ls /usr/local/src/&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>nginx-1.18.0.tar.gz
</span></span></code></pre></div><h4 id=246-fetch-æ¨¡å—>2.4.6 fetch æ¨¡å—<a hidden class=anchor aria-hidden=true href=#246-fetch-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—å¯ä»¥å°†å—æ§èŠ‚ç‚¹çš„æ–‡ä»¶æ‹‰å–è‡³ ansible ä¸»æ§ç«¯ï¼Œå’Œ copy æ¨¡å—åŠŸèƒ½ç›¸åï¼Œç›®å‰ä¸æ”¯æŒæ‹‰å–ç›®å½•</p></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>src 	<span style=color:#75715e># å—æ§èŠ‚ç‚¹æºæ–‡ä»¶è·¯å¾„</span>
</span></span><span style=display:flex><span>dest 	<span style=color:#75715e># ansible ä¸»æ§ç«¯ç›®å½•è·¯å¾„</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># å¦‚æœåŒæ—¶æ‹‰å–å¤šå°ä¸»æœºçš„åŒä¸€æ–‡ä»¶ï¼Œansible ä¼šä¸ºæ¯å°ä¸»æœºå»ºç«‹å•ç‹¬çš„æ–‡ä»¶å¤¹æ¥å­˜æ”¾æ‹‰å–çš„æ–‡ä»¶</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible all --list-hosts</span>
</span></span><span style=display:flex><span>  hosts <span style=color:#f92672>(</span>2<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>    remote
</span></span><span style=display:flex><span>    remote2
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#75715e># å°†è¿œç¨‹ä¸»æœºçš„redhat-release æ–‡ä»¶æ‹‰å–è‡³ ansible ä¸»æœºçš„ /tmp/osç›®å½•ä¸‹ï¼ˆç›®å½•ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible all -m fetch -a &#39;src=/etc/redhat-release dest=/tmp/os/&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># tree /tmp/os/</span>
</span></span><span style=display:flex><span>/tmp/os/
</span></span><span style=display:flex><span>â”œâ”€â”€ remote
</span></span><span style=display:flex><span>â”‚   â””â”€â”€ etc
</span></span><span style=display:flex><span>â”‚       â””â”€â”€ redhat-release
</span></span><span style=display:flex><span>â””â”€â”€ remote2
</span></span><span style=display:flex><span>    â””â”€â”€ etc
</span></span><span style=display:flex><span>        â””â”€â”€ redhat-release
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span> directories, <span style=color:#ae81ff>2</span> files
</span></span></code></pre></div><h4 id=247-file-æ¨¡å—>2.4.7 file æ¨¡å—<a hidden class=anchor aria-hidden=true href=#247-file-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—ç”¨äºåˆ›å»ºï¼Œåˆ é™¤æ–‡ä»¶ï¼Œç›®å½•å’Œè½¯è¿æ¥ä»¥åŠä¿®æ”¹ç›¸å…³å±æ€§</p></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>path 	<span style=color:#75715e># åœ¨è¢«æ§ç«¯åˆ›å»ºçš„è·¯å¾„</span>
</span></span><span style=display:flex><span>owner 	<span style=color:#75715e># å±ä¸»</span>
</span></span><span style=display:flex><span>group 	<span style=color:#75715e># å±ç»„</span>
</span></span><span style=display:flex><span>mode 	<span style=color:#75715e># æƒé™</span>
</span></span><span style=display:flex><span>state 	<span style=color:#75715e># çŠ¶æ€</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>touch    	<span style=color:#75715e># åˆ›å»ºæ–‡ä»¶</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>directory 	<span style=color:#75715e># åˆ›å»ºç›®å½•</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>link 	<span style=color:#75715e># è½¯é“¾æ¥</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>hard     <span style=color:#75715e># ç¡¬é“¾æ¥</span>
</span></span><span style=display:flex><span>recurse     <span style=color:#75715e># yes è¡¨ç¤ºé€’å½’æˆæƒ</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºæ–‡ä»¶å¹¶ä¿®æ”¹å±ä¸»</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m file -a &#39;path=/tmp/file.txt state=touch owner=test mode=755&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ é™¤æ–‡ä»¶</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m file -a &#39;path=/tmp/file.txt state=absent&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºè½¯è¿æ¥ï¼Œå…¶ä¸­ dest è¿˜å¯ä»¥æ›¿æ¢ä¸º[ path | name ]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m file -a &#39;src=/etc/redhat-release dest=/tmp/release-link state=link&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;cat /tmp/release-link&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>CentOS Linux release 7.6.1810 <span style=color:#f92672>(</span>Core<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºç›®å½•</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m file -a &#39;path=/tmp/dir state=directory&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># é€’å½’ä¿®æ”¹æ–‡ä»¶å±æ€§</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m file -a &#39;path=/tmp  owner=test group=test recurse=yes&#39;</span>
</span></span></code></pre></div><h4 id=248-stat-æ¨¡å—>2.4.8 stat æ¨¡å—<a hidden class=anchor aria-hidden=true href=#248-stat-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—ç”¨äºæ£€æŸ¥æ–‡ä»¶æˆ–æ–‡ä»¶ç³»ç»ŸçŠ¶æ€</p></blockquote><p><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/stat_module.html#ansible-collections-ansible-builtin-stat-module>ansible.builtin.stat module â€“ Retrieve file or file system status â€” Ansible Documentation</a></p><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>path  	<span style=color:#75715e># æ–‡ä»¶æˆ–å¯¹è±¡çš„å®Œæ•´è·¯å¾„ï¼ˆå¿…é¡»ï¼‰</span>
</span></span></code></pre></div><p>å¸¸è§è¿”å›å€¼ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>attributesï¼š# è¿”å›æŒ‡å®šæ–‡ä»¶çš„å±æ€§ã€‚
</span></span><span style=display:flex><span>executableï¼š# å¦‚æœè°ƒç”¨çš„ç”¨æˆ·åœ¨ç›®æ ‡è·¯å¾„ä¸Šæœ‰æ‰§è¡Œæƒé™ï¼Œåˆ™è¿”å› trueã€‚
</span></span><span style=display:flex><span>existsï¼š	<span style=color:#75715e># å¦‚æœæŒ‡å®šçš„è·¯å¾„å­˜åœ¨ï¼Œè¿”å›çœŸã€‚</span>
</span></span><span style=display:flex><span>gr_nameï¼š# è¿”å›æ–‡ä»¶æ‰€æœ‰è€…çš„ç»„çš„åç§°ã€‚
</span></span><span style=display:flex><span>islbkï¼š	<span style=color:#75715e># å¦‚æœæŒ‡å®šçš„æ–‡ä»¶æ˜¯ä¸€ä¸ªå—çŠ¶è®¾å¤‡ï¼Œåˆ™è¿”å›trueã€‚</span>
</span></span><span style=display:flex><span>ischrï¼š 	<span style=color:#75715e># å¦‚æœæŒ‡å®šçš„æ–‡ä»¶æ˜¯ä¸€ä¸ªå­—ç¬¦æ–‡ä»¶ï¼Œåˆ™è¿”å›çœŸã€‚</span>
</span></span><span style=display:flex><span>isregï¼š	<span style=color:#75715e># å¦‚æœæŒ‡å®šçš„æ–‡ä»¶æ˜¯ä¸€ä¸ªå¸¸è§„æ–‡ä»¶ï¼Œåˆ™è¿”å›çœŸã€‚</span>
</span></span><span style=display:flex><span>isdirï¼š	<span style=color:#75715e># å¦‚æœæŒ‡å®šçš„æ–‡ä»¶æ˜¯ä¸€ä¸ªç›®å½•ï¼Œåˆ™è¿”å›çœŸã€‚</span>
</span></span><span style=display:flex><span>islnkï¼š	<span style=color:#75715e># å¦‚æœç›®æ ‡æ–‡ä»¶æ˜¯ä¸€ä¸ªé“¾æ¥ï¼Œåˆ™è¿”å›çœŸã€‚</span>
</span></span><span style=display:flex><span>modeï¼š	<span style=color:#75715e># ä»¥å…«è¿›åˆ¶ç¬¦å·è¿”å›æ–‡ä»¶æƒé™ã€‚</span>
</span></span><span style=display:flex><span>isuidï¼š 	<span style=color:#75715e># isuid è¡¨ç¤º &#34;is setuid&#34;ï¼Œç”¨äºåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å…·æœ‰è®¾ç½®ç”¨æˆ· ID (Set User IDï¼ŒSUID) æƒé™ã€‚</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@remote ~<span style=color:#f92672>]</span><span style=color:#75715e># chmod a+s /etc/centos-release</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@remote ~<span style=color:#f92672>]</span><span style=color:#75715e># ll /etc/centos-release</span>
</span></span><span style=display:flex><span>-rwSr-Sr--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>38</span> Nov <span style=color:#ae81ff>23</span>  <span style=color:#ae81ff>2018</span> /etc/centos-release
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m stat -a &#39;path=/etc/centos-release&#39;</span>
</span></span><span style=display:flex><span>remote | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;stat&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;atime&#34;</span>: 1687316675.220694, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;attr_flags&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;attributes&#34;</span>: <span style=color:#f92672>[]</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;block_size&#34;</span>: 4096, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;blocks&#34;</span>: 8, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;charset&#34;</span>: <span style=color:#e6db74>&#34;us-ascii&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;checksum&#34;</span>: <span style=color:#e6db74>&#34;dd9a53b0d396d3ab190cfbc08dca572d3e741a03&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ctime&#34;</span>: 1687316666.4736364, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;dev&#34;</span>: 64768, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;device_type&#34;</span>: 0, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;executable&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;exists&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;gid&#34;</span>: 0, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;gr_name&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;inode&#34;</span>: 67184137, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isblk&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ischr&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isdir&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isfifo&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isgid&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;islnk&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isreg&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;issock&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;isuid&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;mimetype&#34;</span>: <span style=color:#e6db74>&#34;text/plain&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;mode&#34;</span>: <span style=color:#e6db74>&#34;6644&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;mtime&#34;</span>: 1542979018.0, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;nlink&#34;</span>: 1, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;path&#34;</span>: <span style=color:#e6db74>&#34;/etc/centos-release&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;pw_name&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;readable&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;rgrp&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;roth&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;rusr&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;size&#34;</span>: 38, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;uid&#34;</span>: 0, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;815093836&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;wgrp&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;woth&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;writeable&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;wusr&#34;</span>: true, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;xgrp&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;xoth&#34;</span>: false, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;xusr&#34;</span>: false
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=249-unarchive-æ¨¡å—>2.4.9 unarchive æ¨¡å—<a hidden class=anchor aria-hidden=true href=#249-unarchive-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—ç”¨äºè§£åŒ…å’Œè§£å‹ç¼©ï¼Œæœ‰ä¸¤ç§ç”¨æ³•ï¼š</p><ul><li>å°† ansible ä¸»æœºä¸Šçš„å‹ç¼©æ–‡ä»¶è§£å‹è‡³å—æ§èŠ‚ç‚¹çš„æŒ‡å®šè·¯å¾„ä¸‹</li><li>å°†é ansible çš„å…¶ä»–ä¸»æœºçš„å‹ç¼©æ–‡ä»¶è§£å‹åˆ°å—æ§èŠ‚ç‚¹çš„æŒ‡å®šè·¯å¾„ä¸‹</li></ul></blockquote><p>å¸¸è§å‚æ•°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>remote_src 	<span style=color:#75715e># yes è¡¨ç¤ºæºæ–‡ä»¶åœ¨è¿œç¨‹è¢«æ§ä¸»æœºæˆ–é ansible çš„å…¶å®ƒä¸»æœºä¸Šï¼Œno è¡¨ç¤ºæ–‡ä»¶åœ¨ansibleä¸»æœºä¸Š, é»˜è®¤å€¼ä¸º no, æ­¤é€‰é¡¹ä»£æ›¿copyé€‰é¡¹ï¼ˆå·²åºŸå¼ƒï¼‰</span>
</span></span><span style=display:flex><span>src <span style=color:#75715e>#æºè·¯å¾„ï¼Œå¯ä»¥æ˜¯ ansible ä¸»æœºä¸Šçš„è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯è¿œç¨‹ä¸»æœº(è¢«ç®¡ç†ç«¯æˆ–è€…ç¬¬ä¸‰æ–¹ä¸»æœº)ä¸Šçš„è·¯å¾„ï¼Œå¦‚æœæ˜¯è¿œç¨‹ä¸»æœºä¸Šçš„è·¯å¾„ï¼Œåˆ™éœ€è¦è®¾ç½® remote_src=yes</span>
</span></span><span style=display:flex><span>dest 	<span style=color:#75715e># è¿œç¨‹ä¸»æœºä¸Šçš„ç›®æ ‡è·¯å¾„</span>
</span></span><span style=display:flex><span>mode 	<span style=color:#75715e># è®¾ç½®è§£å‹ç¼©åçš„æ–‡ä»¶æƒé™</span>
</span></span><span style=display:flex><span>creates<span style=color:#f92672>=</span>PATH <span style=color:#75715e># å½“PATHä¸å­˜åœ¨æ—¶æ‰ä¼šæ‰§è¡Œ</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># è§£å‹æœ¬åœ°æ–‡ä»¶åˆ°å—æ§èŠ‚ç‚¹çš„æŒ‡å®šç›®å½•ï¼ˆç›®æ ‡ç›®å½•ä¸å­˜åœ¨ä¼šæŠ¥é”™ï¼Œä¸ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m unarchive -a &#39;src=/tmp/test.tar.gz dest=/tmp/&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># è§£å‹å…¶ä»–ä¸»æœºçš„å‹ç¼©åŒ…åˆ°å—æ§èŠ‚ç‚¹</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m unarchive -a &#39;src=https://releases.ansible.com/ansible/ansible-2.1.6.0-0.1.rc1.tar.gz dest=/tmp remote_src=yes&#39;</span>
</span></span></code></pre></div><h4 id=2410-archive-æ¨¡å—>2.4.10 archive æ¨¡å—<a hidden class=anchor aria-hidden=true href=#2410-archive-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—ç”¨äºåœ¨å—æ§èŠ‚ç‚¹æ‰“åŒ…å‹ç¼©æ–‡ä»¶</p></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>path   <span style=color:#75715e># å‹ç¼©çš„æ–‡ä»¶æˆ–ç›®å½•</span>
</span></span><span style=display:flex><span>dest   <span style=color:#75715e># å‹ç¼©åçš„æ–‡ä»¶</span>
</span></span><span style=display:flex><span>format <span style=color:#75715e># å‹ç¼©æ ¼å¼,æ”¯æŒgz,bz2,xz,tar,zip</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible tmp<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m archive -a &#39;path=/etc/redhat-release dest=/tmp/log.tar.gz format=gz&#39;</span>
</span></span></code></pre></div><h4 id=2411-hostname-æ¨¡å—>2.4.11 hostname æ¨¡å—<a hidden class=anchor aria-hidden=true href=#2411-hostname-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—ç”¨äºä¿®æ”¹ä¸»æœºå</p></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>name 	<span style=color:#75715e># è¦ä¿®æ”¹çš„ç›®æ ‡ä¸»æœºå</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m hostname -a &#39;name=test&#39;</span>
</span></span></code></pre></div><h4 id=2412-cron-æ¨¡å—>2.4.12 cron æ¨¡å—<a hidden class=anchor aria-hidden=true href=#2412-cron-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—ç”¨äºåˆ›å»ºè®¡åˆ’ä»»åŠ¡</p></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>name 		<span style=color:#75715e># ä»»åŠ¡åç§°ï¼Œå¯ä»¥æ ¹æ®æ­¤åç§°åˆ é™¤å¯¹åº”çš„è®¡åˆ’ä»»åŠ¡</span>
</span></span><span style=display:flex><span>minute    	<span style=color:#75715e># åˆ†é’Ÿ</span>
</span></span><span style=display:flex><span>hour 		<span style=color:#75715e># å°æ—¶</span>
</span></span><span style=display:flex><span>weekday    	<span style=color:#75715e># å‘¨</span>
</span></span><span style=display:flex><span>user		<span style=color:#75715e># ä»»åŠ¡ç”±å“ªä¸ªç”¨æˆ·è¿è¡Œï¼›é»˜è®¤root</span>
</span></span><span style=display:flex><span>job 		<span style=color:#75715e># ä»»åŠ¡</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºä¸€ä¸ªè®¡åˆ’ä»»åŠ¡ï¼Œå‘½åä¸º test</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m cron -a &#39;minute=0 hour=2 weekday=1-5 job=&#34;echo test&#34; name=hello&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹åˆ›å»ºç»“æœ</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;crontab -l&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#75715e>#Ansible: hello</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> <span style=color:#ae81ff>2</span> * * 1-5 echo test
</span></span></code></pre></div><h4 id=2413-yum-å’Œ-apt-æ¨¡å—>2.4.13 yum å’Œ apt æ¨¡å—<a hidden class=anchor aria-hidden=true href=#2413-yum-å’Œ-apt-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—ç”¨äºç®¡ç†è½¯ä»¶åŒ…</p></blockquote><ul><li>yumï¼šé€‚ç”¨äºRHELï¼ŒCentoOSï¼ŒFedora ç­‰ç³»ç»Ÿ</li><li>aptï¼šé€‚ç”¨äºDebianï¼ŒUbuntu ç­‰ç³»ç»Ÿ</li></ul><p>yum æ¨¡å—å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>name 		<span style=color:#75715e># è½¯ä»¶åŒ…åç§°</span>
</span></span><span style=display:flex><span>state 		<span style=color:#75715e># çŠ¶æ€</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>present 	<span style=color:#75715e># å®‰è£…, æ­¤ä¸ºé»˜è®¤å€¼</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>absent 	<span style=color:#75715e># åˆ é™¤</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>latest 	<span style=color:#75715e># æœ€æ–°ç‰ˆ</span>
</span></span><span style=display:flex><span>list        <span style=color:#75715e># åˆ—å‡ºæŒ‡å®šåŒ…</span>
</span></span><span style=display:flex><span>enablerepo 	<span style=color:#75715e># å¯ç”¨ä»“åº“xx</span>
</span></span><span style=display:flex><span>disablerepo <span style=color:#75715e># ç¦ç”¨ä»“åº“xx</span>
</span></span><span style=display:flex><span>exclude 	<span style=color:#75715e># æ’é™¤æŒ‡å®šçš„åŒ…</span>
</span></span><span style=display:flex><span>validate    <span style=color:#75715e># æ˜¯å¦æ£€éªŒ, é»˜è®¤ä¸º yes</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># å®‰è£… httpd</span>
</span></span><span style=display:flex><span>ansible remote -m yum -a <span style=color:#e6db74>&#39;name=httpd state=present&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ é™¤ httpd</span>
</span></span><span style=display:flex><span>ansible remote -m yum -a <span style=color:#e6db74>&#39;name=httpd state=absent&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ä»ç½‘ç»œæºå®‰è£… zabbix ï¼ˆç”±äºç¼ºå°‘å…¶ä»–ä¾èµ–åŒ…ï¼Œè¯¥å‘½ä»¤å¯èƒ½æ‰§è¡Œå¤±è´¥ï¼‰</span>
</span></span><span style=display:flex><span>ansible remote -m yum -a <span style=color:#e6db74>&#39;name=https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/8/x86_64/zabbix-agent2-5.0.24-1.el8.x86_64.rpm state=present validate_certs=no&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å¯ç”¨ epel æºå®‰è£… nginx</span>
</span></span><span style=display:flex><span>ansible remote -m yum -a <span style=color:#e6db74>&#39;name=nginx state=present enablerepo=epel&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ˜ç¡®ç¦ç”¨ epel æºä¼šå¯¼è‡´å®‰è£…å¤±è´¥ï¼ˆæ‰¾ä¸åˆ° nginx åŒ…ï¼‰</span>
</span></span><span style=display:flex><span>ansible remote -m yum -a <span style=color:#e6db74>&#39;name=nginx state=present disablerepo=epel&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å®‰è£…é™¤äº† kernel* å’Œ foo* åŒ¹é…åˆ°çš„å…¶ä½™æ‰€æœ‰åŒ…ï¼ˆæµ‹è¯•ä½¿ç”¨ï¼Œè°¨æ…æ‰§è¡Œï¼‰</span>
</span></span><span style=display:flex><span>ansible remote -m yum -a <span style=color:#e6db74>&#39;name=* state=latest exclude=kerner*,foo*&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ—å‡ºæ‰€æœ‰ç‰ˆæœ¬çš„åŒ…</span>
</span></span><span style=display:flex><span>ansible remote -m yum -a <span style=color:#e6db74>&#39;list=tree&#39;</span>
</span></span></code></pre></div><h4 id=2414-yum_repository>2.4.14 yum_repository<a hidden class=anchor aria-hidden=true href=#2414-yum_repository>#</a></h4><blockquote><p>æ­¤æ¨¡å—ç”¨äº yum ä»“åº“çš„é…ç½®ç®¡ç†</p></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>name 		<span style=color:#75715e># ä»“åº“idï¼Œä¹Ÿæ˜¯é…ç½®æ–‡ä»¶å</span>
</span></span><span style=display:flex><span>description <span style=color:#75715e># ä»“åº“æè¿°åç§°,å¯¹åº”é…ç½®æ–‡ä»¶ä¸­çš„name=</span>
</span></span><span style=display:flex><span>baseurl 	<span style=color:#75715e># ä»“åº“çš„åœ°å€</span>
</span></span><span style=display:flex><span>gpgcheck 	<span style=color:#75715e># å¼€å¯å¯†é’¥éªŒè¯</span>
</span></span><span style=display:flex><span>gpgkey      <span style=color:#75715e># ä»“åº“å…¬é’¥è·¯å¾„</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># æ·»åŠ  nginx ä»“åº“</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m yum_repository -a &#39;name=nginx-repo description=&#34;nginx repo&#34; baseurl=&#34;http://nginx.org/packages/centos/$releasever/$basearch/&#34; gpgcheck=yes gpgkey=&#34;https://nginx.org/keys/nginx_signing.key&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹æ·»åŠ ç»“æœ</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;cat /etc/yum.repos.d/nginx-repo.repo&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>nginx-repo<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>baseurl <span style=color:#f92672>=</span> http://nginx.org/packages/centos/$releasever/$basearch/
</span></span><span style=display:flex><span>gpgcheck <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>gpgkey <span style=color:#f92672>=</span> https://nginx.org/keys/nginx_signing.key
</span></span><span style=display:flex><span>name <span style=color:#f92672>=</span> nginx repo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ é™¤ nginx ä»“åº“</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m yum_repository -a &#39;name=nginx-repo state=absent&#39;</span>
</span></span></code></pre></div><h4 id=2415-service-æ¨¡å—>2.4.15 service æ¨¡å—<a hidden class=anchor aria-hidden=true href=#2415-service-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—å’Œ systemd çš„åŠŸèƒ½ç±»ä¼¼ï¼Œç”¨äºç®¡ç†ç³»ç»ŸæœåŠ¡</p></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>name 	<span style=color:#75715e># æœåŠ¡åç§°</span>
</span></span><span style=display:flex><span>state 	<span style=color:#75715e># æœåŠ¡çŠ¶æ€</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>=</span>started 	<span style=color:#75715e># å¯åŠ¨</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>=</span>stopped 	<span style=color:#75715e># åœæ­¢</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>=</span>restarted  <span style=color:#75715e># é‡å¯</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>=</span>reloaded   <span style=color:#75715e># é‡è½½</span>
</span></span><span style=display:flex><span>enabled 		<span style=color:#75715e># å¼€å¯è‡ªå¯åŠ¨</span>
</span></span><span style=display:flex><span>daemon_reload   <span style=color:#75715e># åŠ è½½æ–°çš„é…ç½®æ–‡ä»¶,é€‚ç”¨äºsystemdæ¨¡å—</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># å¯åŠ¨å¹¶è®¾ç½® httpd æœåŠ¡å¼€æœºè‡ªå¯åŠ¨</span>
</span></span><span style=display:flex><span>ansible remote -m service -a <span style=color:#e6db74>&#39;name=httpd state=started enabled=yes&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å…³é—­ httpd æœåŠ¡ï¼Œå¹¶å…³é—­å¼€æœºè‡ªå¯</span>
</span></span><span style=display:flex><span>ansible remote -m service -a <span style=color:#e6db74>&#39;name=httpd state=stopped enabled=no&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># é‡å¯æŒ‡å®šç½‘å¡æœåŠ¡</span>
</span></span><span style=display:flex><span>ansible remote -m service -a <span style=color:#e6db74>&#39;name=network state=restarted args=ens33&#39;</span>
</span></span></code></pre></div><h4 id=2416-user-æ¨¡å—>2.4.16 user æ¨¡å—<a hidden class=anchor aria-hidden=true href=#2416-user-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—ç”¨äºç”¨æˆ·ç®¡ç†</p></blockquote><p>å¸¸ç”¨é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>name 			<span style=color:#75715e># åˆ›å»ºçš„åç§°</span>
</span></span><span style=display:flex><span>uid 			<span style=color:#75715e># æŒ‡å®š uid</span>
</span></span><span style=display:flex><span>group 			<span style=color:#75715e># æŒ‡å®šåŸºæœ¬ç»„</span>
</span></span><span style=display:flex><span>shell 			<span style=color:#75715e># ç™»å½• shell ç±»å‹é»˜è®¤ /bin/bash</span>
</span></span><span style=display:flex><span>create_home 	<span style=color:#75715e># æ˜¯å¦åˆ›å»ºå®¶ç›®å½•</span>
</span></span><span style=display:flex><span>password 		<span style=color:#75715e># è®¾å®šå¯¹åº”çš„å¯†ç ï¼Œå¿…é¡»æ˜¯åŠ å¯†åçš„å­—ç¬¦ä¸²æ‰è¡Œï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆ</span>
</span></span><span style=display:flex><span>system 			<span style=color:#75715e># yes è¡¨ç¤ºç³»ç»Ÿç”¨æˆ·</span>
</span></span><span style=display:flex><span>groups      	<span style=color:#75715e># é™„åŠ ç»„</span>
</span></span><span style=display:flex><span>append 			<span style=color:#75715e># è¿½åŠ é™„åŠ ç»„ä½¿ç”¨, yes è¡¨ç¤ºå¢åŠ æ–°çš„é™„åŠ ç»„</span>
</span></span><span style=display:flex><span>state    		<span style=color:#75715e># absent åˆ é™¤</span>
</span></span><span style=display:flex><span>remove 			<span style=color:#75715e># yes è¡¨ç¤ºåˆ é™¤ç”¨æˆ·æ—¶å°†å®¶ç›®å½•ä¸€èµ·åˆ é™¤</span>
</span></span><span style=display:flex><span>generate_ssh_key <span style=color:#75715e># åˆ›å»ºç§é’¥</span>
</span></span><span style=display:flex><span>ssh_keyu_bits    <span style=color:#75715e># ç§é’¥ä½æ•°</span>
</span></span><span style=display:flex><span>ssh_key_file     <span style=color:#75715e># ç§é’¥æ–‡ä»¶è·¯å¾„</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºç”¨æˆ·å¹¶æŒ‡å®šç›¸å…³å±æ€§ï¼ˆå®¶ç›®å½•ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰</span>
</span></span><span style=display:flex><span>ansible remote -m user -a <span style=color:#e6db74>&#39;name=test uid=1001  home=/app/test shell=/bin/sh&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºç³»ç»Ÿç”¨æˆ·ï¼ˆuid &lt; 1000ï¼‰</span>
</span></span><span style=display:flex><span>ansible remote -m user -a <span style=color:#e6db74>&#39;name=test1  home=/app/test1 shell=/bin/bash system=yes&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ©ç”¨ debug æ¨¡å—ç”ŸæˆåŠ å¯†å¯†ç </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m debug -a &#39;msg={{ &#34;123456&#34; | password_hash(&#34;sha512&#34;,&#34;salt&#34;) }}&#39;</span>
</span></span><span style=display:flex><span>localhost | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;</span>$6$salt$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w<span style=color:#e6db74>.igcOo1R7vBYR65JquIQ/7siC7VRpmteKvZmfSkNc69.&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºç”¨æˆ·å¹¶æŒ‡å®šå¯†ç ï¼ˆå¦‚æœç›´æ¥æŒ‡å®šæ˜æ–‡å¯†ç ï¼Œæ‰§è¡Œè™½ç„¶æˆåŠŸï¼Œä½†æ˜¯ç™»å½•æ—¶ä¼šæŠ¥å¯†ç é”™è¯¯ï¼‰</span>
</span></span><span style=display:flex><span>ansible remote -m user -a <span style=color:#e6db74>&#39;name=test2 shell=/bin/bash password=$6$salt$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w.igcOo1R7vBYR65JquIQ/7siC7VRpmteKvZmfSkNc69.&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºç”¨æˆ·å¹¶ç”Ÿæˆ 2048 bit çš„ç”¨æˆ·ç§é’¥</span>
</span></span><span style=display:flex><span>ansible remote -m user -a <span style=color:#e6db74>&#39;name=test3 generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=.ssh/id_rsa&#39;</span> 
</span></span></code></pre></div><h4 id=2417-group-æ¨¡å—>2.4.17 group æ¨¡å—<a hidden class=anchor aria-hidden=true href=#2417-group-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—ç”¨äºç®¡ç†ç”¨æˆ·ç»„</p></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>name        <span style=color:#75715e># æŒ‡å®šç»„åç§°</span>
</span></span><span style=display:flex><span>gid         <span style=color:#75715e># æŒ‡å®šgid</span>
</span></span><span style=display:flex><span>state 
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>present  <span style=color:#75715e># åˆ›å»º, é»˜è®¤</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>absent   <span style=color:#75715e># åˆ é™¤</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºç³»ç»Ÿç”¨æˆ·ç»„</span>
</span></span><span style=display:flex><span>ansible remote -m group -a <span style=color:#e6db74>&#39;name=test system=yes&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ é™¤ç»„</span>
</span></span><span style=display:flex><span>ansible remote -m group -a <span style=color:#e6db74>&#39;name=test state=absent&#39;</span>
</span></span></code></pre></div><p>2.4.18 lineinfile æ¨¡å—</p><blockquote><p>æ­¤æ¨¡å—ç›¸å½“äº sed ï¼Œç”¨äºå¯¹æ–‡æœ¬è¿›è¡Œå•è¡Œæ›¿æ¢ã€‚ä¹‹æ‰€ä»¥ä¸ç”¨ sed ï¼Œæ˜¯å› ä¸º ansible å¯¹ç‰¹æ®Šç¬¦å·çš„æ”¯æŒä¸å¼ºï¼Œå®é™…æ“ä½œæ—¶å¯èƒ½æ— æ³•æ›¿æ¢ï¼Œä¸”éœ€è¦å¯¹ç¬¦å·è¿›è¡Œè½¬ä¹‰ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚</p></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>path 		<span style=color:#75715e># è¢«æ§ç«¯æ–‡ä»¶çš„è·¯å¾„</span>
</span></span><span style=display:flex><span>regexp 		<span style=color:#75715e># æ­£åˆ™åŒ¹é…å­—ç¬¦ä¸²</span>
</span></span><span style=display:flex><span>line 		<span style=color:#75715e># æ›¿æ¢çš„ç›®æ ‡å†…å®¹</span>
</span></span><span style=display:flex><span>state 		<span style=color:#75715e># absent è¡¨ç¤ºåˆ é™¤</span>
</span></span><span style=display:flex><span>insertafter     <span style=color:#75715e># æ’å…¥åˆ°åŒ¹é…è¡Œå‰</span>
</span></span><span style=display:flex><span>insertbefore    <span style=color:#75715e># æ’å…¥åˆ°åŒ¹é…è¡Œå</span>
</span></span><span style=display:flex><span>backrefs        <span style=color:#75715e># æ˜¯å¦æ”¯æŒåå‘å¼•ç”¨</span>
</span></span><span style=display:flex><span>backup          <span style=color:#75715e># ä¿®æ”¹å‰å…ˆå¤‡ä»½</span>
</span></span><span style=display:flex><span>create          <span style=color:#75715e># å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨, åˆ™åˆ›å»º, é»˜è®¤ä¸å­˜åœ¨ä¼šå‡ºé”™</span>
</span></span><span style=display:flex><span>mode            <span style=color:#75715e># æŒ‡å®šæƒé™</span>
</span></span><span style=display:flex><span>owner           <span style=color:#75715e># æŒ‡å®šç”¨æˆ·</span>
</span></span><span style=display:flex><span>group           <span style=color:#75715e># æŒ‡å®šç»„</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ³¨æ„</span>
</span></span><span style=display:flex><span><span style=color:#75715e># regexpå‚æ•°ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å¯¹åº”çš„è¡Œï¼Œå½“æ›¿æ¢æ–‡æœ¬æ—¶ï¼Œå¦‚æœåŒ¹é…åˆ°äº†å¤šè¡Œï¼Œåªæœ‰æœ€åä¸€ä¸ªåŒ¹é…è¡Œä¼šè¢«æ›¿æ¢ã€‚å½“åˆ é™¤æ–‡æœ¬æ—¶ï¼Œæ‰€æœ‰åŒ¹é…åˆ°çš„è¡Œéƒ½ä¼šè¢«åˆ é™¤ã€‚</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># ä¿®æ”¹ httpd æœåŠ¡çš„ç›‘å¬ç«¯å£</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#39;path=/etc/httpd/conf/httpd.conf regexp=&#34;^Listen&#34; line=&#34;Listen 8080&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ç¦ç”¨ selinux</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#39;path=/etc/selinux/config regexp=&#34;^SELINUX=&#34; line=&#34;SELINUX=disabled&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ·»åŠ ç½‘å…³</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=&#34;GATEWAY=10.0.0.254&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åœ¨æœ€åä¸€è¡Œæ·»åŠ ç½‘å…³é…ç½®</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=&#34;GATEWAY=10.0.0.254&#34;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># éªŒè¯æ·»åŠ ç»“æœ</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;tail -n1 /etc/sysconfig/network-scripts/ifcfg-ens33&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>GATEWAY<span style=color:#f92672>=</span>10.0.0.254
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ é™¤æ·»åŠ çš„ç½‘å…³é…ç½®</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=&#34;GATEWAY=10.0.0.254&#34; state=absent&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ·»åŠ ä¸€ä¸ªç½‘å…³ï¼Œåœ¨ &#34;NAME=&#34; è¯¥è¡Œå‰æ·»åŠ </span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=&#34;GATEWAY=10.0.0.254&#34; insertbefore=&#34;^NAME=&#34;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹æ·»åŠ ç»“æœ</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;grep -i gateway /etc/sysconfig/network-scripts/ifcfg-ens33 -A 1&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>GATEWAY<span style=color:#f92672>=</span>10.0.0.254
</span></span><span style=display:flex><span>NAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ens33&#34;</span>
</span></span></code></pre></div><h4 id=2418-lineinfile-æ¨¡å—>2.4.18 lineinfile æ¨¡å—<a hidden class=anchor aria-hidden=true href=#2418-lineinfile-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—ä¸»è¦ç”¨äºåŸºäºæ­£åˆ™çš„å•è¡Œæ–‡æœ¬åŒ¹é…å’Œæ›¿æ¢</p></blockquote><p>ansible å¯¹ç‰¹æ®Šç¬¦å·çš„æ”¯æŒä¸æ˜¯å¾ˆå¥½ï¼Œå¦‚æœç”¨ sed è¿›è¡Œå¤æ‚å­—ç¬¦æ›¿æ¢å¾ˆå¯èƒ½å‡ºç°é—®é¢˜ï¼Œå› æ­¤åœ¨è¿›è¡Œæ–‡æœ¬æ›¿æ¢æ—¶ï¼Œæœ€å¥½ç”¨è¯¥æ¨¡å—è€Œésed</p><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>path 			<span style=color:#75715e>#è¢«æ§ç«¯æ–‡ä»¶çš„è·¯å¾„</span>
</span></span><span style=display:flex><span>regexp 			<span style=color:#75715e>#æ­£åˆ™åŒ¹é…è¯­æ³•æ ¼å¼,è¡¨ç¤ºè¢«æ›¿æ¢çš„å†…å®¹</span>
</span></span><span style=display:flex><span>line 			<span style=color:#75715e>#æ›¿æ¢ä¸ºçš„å†…å®¹</span>
</span></span><span style=display:flex><span>state 			<span style=color:#75715e>#absentè¡¨ç¤ºåˆ é™¤</span>
</span></span><span style=display:flex><span>insertafter     <span style=color:#75715e>#æ’å…¥åŒ¹é…è¡Œå</span>
</span></span><span style=display:flex><span>insertbefore    <span style=color:#75715e>#æ’å…¥åŒ¹é…è¡Œå‰</span>
</span></span><span style=display:flex><span>backrefs        <span style=color:#75715e>#æ”¯æŒåå‘å¼•ç”¨, yes å’Œ no</span>
</span></span><span style=display:flex><span>backup          <span style=color:#75715e>#ä¿®æ”¹å‰å…ˆå¤‡ä»½</span>
</span></span><span style=display:flex><span>create          <span style=color:#75715e>#å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨, åˆ™åˆ›å»º, é»˜è®¤ä¸å­˜åœ¨ä¼šå‡ºé”™</span>
</span></span><span style=display:flex><span>mode            <span style=color:#75715e>#æŒ‡å®šæƒé™</span>
</span></span><span style=display:flex><span>owner           <span style=color:#75715e>#æŒ‡å®šç”¨æˆ·</span>
</span></span><span style=display:flex><span>group           <span style=color:#75715e>#æŒ‡å®šç»„</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#æ³¨æ„</span>
</span></span><span style=display:flex><span>regexp å‚æ•°ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å¯¹åº”çš„è¡Œï¼Œæœ‰ä¸¤ç§å¤„ç†æ–¹å¼
</span></span><span style=display:flex><span>	å½“æ›¿æ¢æ–‡æœ¬æ—¶ï¼Œå¦‚æœæœ‰å¤šä¸ªåŒ¹é…è¡Œï¼Œåˆ™åªä¼šå¯¹æœ€åä¸€è¡Œè¿›è¡Œæ›¿æ¢
</span></span><span style=display:flex><span>	å½“åˆ é™¤æ–‡æœ¬æ—¶ï¼Œå¦‚æœæœ‰å¤šè¡Œæ–‡æœ¬éƒ½èƒ½è¢«åŒ¹é…ï¼Œè¿™ä¹ˆè¿™äº›è¡Œéƒ½ä¼šè¢«åˆ é™¤ã€‚
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># å…³é—­ selinux</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#34;path=/etc/selinux/config regexp=&#39;^SELINUX=&#39; line=&#39;SELINUX=disabled&#39;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ·»åŠ  DNS é…ç½®ï¼ˆæœ€åä¸€è¡Œï¼‰</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 line=&#34;DNS1=8.8.8.8&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ·»åŠ  DNS é…ç½®ï¼ˆåŒ¹é…è¡Œä¸‹æ·»åŠ ï¼‰</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33 insertafter=&#34;^NAME&#34; line=&#34;DNS1=8.8.8.8&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ é™¤ä¸€è¡Œ</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile -a <span style=color:#e6db74>&#39;path=/etc/sysconfig/network-scripts/ifcfg-ens33  line=&#34;DNS1=8.8.8.8&#34; state=&#34;absent&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ é™¤æ³¨é‡Šè¡Œ</span>
</span></span><span style=display:flex><span>ansible remote -m lineinfile  -a <span style=color:#e6db74>&#39;dest=/etc/fstab state=absent regexp=&#34;^#&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>### å¤šè¡Œç›¸åŒæ–‡æœ¬ï¼Œåªæ›¿æ¢æœ€åä¸€è¡Œ</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;cat /root/test.txt&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m lineinfile -a &#34;path=/root/test.txt regexp=&#39;a&#39; line=&#39;b&#39;&#34;</span>
</span></span><span style=display:flex><span>remote | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;backup&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;line replaced&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;cat /root/test.txt&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span>b
</span></span></code></pre></div><h4 id=2419-replace-æ¨¡å—>2.4.19 replace æ¨¡å—<a hidden class=anchor aria-hidden=true href=#2419-replace-æ¨¡å—>#</a></h4><blockquote><p>è¯¥æ¨¡å—ä¸ sed ç±»ä¼¼ï¼Œä¸»è¦ç”¨äºåŸºäºæ­£åˆ™çš„å¤šè¡Œæ–‡æœ¬åŒ¹é…å’Œæ›¿æ¢</p></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>path            <span style=color:#75715e># è¢«æ§ç«¯æ–‡ä»¶çš„è·¯å¾„</span>
</span></span><span style=display:flex><span>regexp          <span style=color:#75715e># æ­£åˆ™åŒ¹é…è¯­æ³•æ ¼å¼</span>
</span></span><span style=display:flex><span>replace         <span style=color:#75715e># ç›®æ ‡æ›¿æ¢å†…å®¹</span>
</span></span><span style=display:flex><span>after           <span style=color:#75715e># æ’å…¥åŒ¹é…è¡Œå</span>
</span></span><span style=display:flex><span>before          <span style=color:#75715e># æ’å…¥åŒ¹é…è¡Œå‰</span>
</span></span><span style=display:flex><span>backup          <span style=color:#75715e># ä¿®æ”¹å‰å…ˆå¤‡ä»½</span>
</span></span><span style=display:flex><span>mode            <span style=color:#75715e># æŒ‡å®šæƒé™</span>
</span></span><span style=display:flex><span>owner           <span style=color:#75715e># æŒ‡å®šç”¨æˆ·</span>
</span></span><span style=display:flex><span>group           <span style=color:#75715e># æŒ‡å®šç»„</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ansible remote -m replace -a <span style=color:#e6db74>&#34;path=/etc/fstab regexp=&#39;^(UUID.*)&#39; replace=&#39;#\1&#39;&#34;</span>  
</span></span><span style=display:flex><span>ansible remote -m replace -a <span style=color:#e6db74>&#34;path=/etc/fstab regexp=&#39;^#(UUID.*)&#39; replace=&#39;\1&#39;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>### å¤šè¡ŒåŒ¹é…æ›¿æ¢</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;cat /root/test.txt&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>b
</span></span><span style=display:flex><span>b
</span></span><span style=display:flex><span>b
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m replace -a &#34;path=/root/test.txt regexp=&#39;b&#39; replace=&#39;a&#39;&#34;</span>
</span></span><span style=display:flex><span>remote | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;2 replacements made&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;cat /root/test.txt&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span>a
</span></span><span style=display:flex><span>a
</span></span></code></pre></div><h4 id=2420-selinux-æ¨¡å—>2.4.20 selinux æ¨¡å—<a hidden class=anchor aria-hidden=true href=#2420-selinux-æ¨¡å—>#</a></h4><blockquote><p>è¯¥æ¨¡å—ç”¨æ¥ç®¡ç† selinux ç­–ç•¥ã€‚æ ¹æ®å›½å†…ä½¿ç”¨ä¹ æƒ¯ï¼Œè¿™é‡Œä¸»è¦æ¼”ç¤ºå¦‚ä½•å…³é—­ selinux</p></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>policy     <span style=color:#75715e># æŒ‡å®šSELINUXTYPE=targeted</span>
</span></span><span style=display:flex><span>state      <span style=color:#75715e># æŒ‡å®šSELINUX=disabled</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m selinux -a &#39;state=disabled&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>WARNING<span style=color:#f92672>]</span>: SELinux state temporarily changed from <span style=color:#e6db74>&#39;enforcing&#39;</span> to <span style=color:#e6db74>&#39;permissive&#39;</span>. State change will take effect next reboot.
</span></span><span style=display:flex><span>remote | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;configfile&#34;</span>: <span style=color:#e6db74>&#34;/etc/selinux/config&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;policy&#34;</span>: <span style=color:#e6db74>&#34;targeted&#34;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;reboot_required&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;state&#34;</span>: <span style=color:#e6db74>&#34;disabled&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#34;grep -v &#39;#&#39; /etc/selinux/config&#34;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SELINUX<span style=color:#f92672>=</span>disabled
</span></span><span style=display:flex><span>SELINUXTYPE<span style=color:#f92672>=</span>targeted 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#34;getenforce&#34;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>Permissive
</span></span></code></pre></div><h4 id=2421-reboot-æ¨¡å—>2.4.21 reboot æ¨¡å—<a hidden class=anchor aria-hidden=true href=#2421-reboot-æ¨¡å—>#</a></h4><blockquote><p>ç”¨äºé‡å¯ç›®æ ‡æœºå™¨</p></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>msg               <span style=color:#75715e># é‡å¯æç¤ºå†…å®¹</span>
</span></span><span style=display:flex><span>pre_reboot_delay  <span style=color:#75715e># é‡å¯å‰çš„å»¶è¿Ÿæ—¶é—´ï¼Œå•ä½ï¼šs</span>
</span></span><span style=display:flex><span>post_reboot_delay <span style=color:#75715e># é‡å¯åç»è¿‡å¤šå°‘æ—¶é—´å†éªŒè¯ç³»ç»ŸåŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼Œå•ä½ï¼šs</span>
</span></span><span style=display:flex><span>reboot_timeout    <span style=color:#75715e>#é‡å¯åå»¶è¿Ÿæ—¶é—´å†æ‰§è¡Œæµ‹è¯•æˆåŠŸä¸å¦çš„å‘½ä»¤</span>
</span></span><span style=display:flex><span>test_command      <span style=color:#75715e>#æ‰§è¡Œæµ‹è¯•æˆåŠŸä¸å¦çš„å‘½ä»¤</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼šé‡å¯ç³»ç»Ÿï¼Œä¼šé˜»å¡ç­‰å¾…é‡å¯å®Œæˆæ‰ä¼šè¿”å›æ‰§è¡Œç»“æœ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m reboot -a &#34;msg=&#39;host will be reboot&#39;&#34;</span>
</span></span><span style=display:flex><span>remote | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;elapsed&#34;</span>: 17, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;rebooted&#34;</span>: true
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=2422-mount-æ¨¡å—>2.4.22 mount æ¨¡å—<a hidden class=anchor aria-hidden=true href=#2422-mount-æ¨¡å—>#</a></h4><blockquote><p>ç”¨äºæ–‡ä»¶ç³»ç»Ÿçš„ç®¡ç†</p></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>src    <span style=color:#75715e>#æºè®¾å¤‡è·¯å¾„ï¼Œæˆ–ç½‘ç»œåœ°å€</span>
</span></span><span style=display:flex><span>path   <span style=color:#75715e>#æŒ‚è½½è‡³æœ¬åœ°å“ªä¸ªè·¯å¾„ä¸‹</span>
</span></span><span style=display:flex><span>fstype <span style=color:#75715e>#è®¾å¤‡ç±»å‹</span>
</span></span><span style=display:flex><span>opts   <span style=color:#75715e>#æŒ‚è½½çš„é€‰é¡¹</span>
</span></span><span style=display:flex><span>state  <span style=color:#75715e>#æŒ‚è½½è¿˜æ˜¯å¸è½½</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>present <span style=color:#75715e>#æ°¸ä¹…æŒ‚è½½ï¼Œä½†æ²¡æœ‰ç«‹å³ç”Ÿæ•ˆ</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>absent  <span style=color:#75715e>#å¸è½½ä¸´æ—¶æŒ‚è½½,å¹¶åˆ é™¤æ°¸ä¹…æŒ‚è½½</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>mounted <span style=color:#75715e>#ä¸´æ—¶æŒ‚è½½</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span>unmounted <span style=color:#75715e>#ä¸´æ—¶å¸è½½</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># æ°¸ä¹…å¸è½½</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m mount -a &#39;src=/dev/sdb path=/app state=absent&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ°¸ä¹…æŒ‚è½½ï¼Œä¸ä¼šç«‹å³ç”Ÿæ•ˆï¼Œä»…ä¿®æ”¹/etc/fstab æ–‡ä»¶</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m mount -a &#39;src=/dev/sdb path=/app state=absent&#39; fstype=xfs opts=noatime path=swap state=present&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ä¸´æ—¶æŒ‚è½½</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m mount -a &#39;src=/dev/sdb path=/app fstype=xfs opts=default state=mounted&#39;  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ä¸´æ—¶å¸è½½</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m mount -a &#39;src=/dev/sdb path=/app fstype=xfs opts=default state=unmounted&#39;  </span>
</span></span></code></pre></div><blockquote><p><code>opts=noatime</code>ï¼š<code>opts</code>æ˜¯ä¼ é€’ç»™mountå‘½ä»¤çš„é¢å¤–é€‰é¡¹ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯<code>noatime</code>ï¼Œè¡¨ç¤ºåœ¨è¯»å–æ–‡ä»¶æ—¶ï¼Œä¸æ›´æ–°æ–‡ä»¶çš„æœ€åè®¿é—®æ—¶é—´ã€‚è¿™å¯ä»¥æé«˜æ–‡ä»¶ç³»ç»Ÿçš„æ€§èƒ½ã€‚é»˜è®¤æ˜¯ <code>default</code></p></blockquote><h4 id=2423-setup-æ¨¡å—>2.4.23 setup æ¨¡å—<a hidden class=anchor aria-hidden=true href=#2423-setup-æ¨¡å—>#</a></h4><blockquote><p>è¯¥æ¨¡å—ç”¨äºæ”¶é›†ç›®æ ‡ä¸»æœºçš„ç³»ç»Ÿä¿¡æ¯ï¼Œåœ¨ä½¿ç”¨ ansible æ—¶ï¼Œæ˜¯é»˜è®¤å¯ç”¨çš„ã€‚è¯¥æ¨¡å—æ”¶é›†åˆ°çš„ä¿¡æ¯å¯ä»¥é€šè¿‡å˜é‡å¼•ç”¨ï¼Œä½†æ˜¯é€šå¸¸æƒ…å†µä¸‹ï¼Œå®ƒä¼šå½±å“æ‰§è¡Œé€Ÿåº¦ã€‚å¦‚æœä¸éœ€è¦ï¼Œå¯ä»¥æ˜¾å¼å…³é—­ä»¥æé«˜æ‰§è¡Œæ•ˆç‡ã€‚</p></blockquote><p>å¯ä»¥ä½¿ç”¨ <code>gather_facts: no</code> æ¥ç¦æ­¢ Ansible æ”¶é›† facts ä¿¡æ¯</p><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>filter  <span style=color:#75715e># æŒ‡å®šè¿‡æ»¤æ¡ä»¶</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible remote -m setup
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_nodename&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_hostname&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_domain&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_memtotal_mb&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_memory_mb&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_memfree_mb&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_os_family&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_distribution&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_distribution_major_version&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_distribution_version&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_processor_vcpus&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_remote_ipv4_addresses&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_architecture&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_uptime_seconds&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#34;filter=ansible_processor*&#34;</span>
</span></span><span style=display:flex><span>ansible remote -m setup -a <span style=color:#e6db74>&#39;filter=ansible_env&#39;</span>
</span></span></code></pre></div><h4 id=2424-debug-æ¨¡å—>2.4.24 debug æ¨¡å—<a hidden class=anchor aria-hidden=true href=#2424-debug-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—ç”¨äºæ‰“å°ç›¸å…³ä¿¡æ¯ï¼Œç±»ä¼¼äº <code>print</code> å’Œ <code>echo</code></p></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>msg		<span style=color:#75715e># æ‰“å°å†…å®¹</span>
</span></span><span style=display:flex><span>var		<span style=color:#75715e># è®¾ç½®å˜é‡å¹¶èµ‹å€¼</span>
</span></span><span style=display:flex><span>verbosity <span style=color:#75715e># è¯¦ç»†çº§åˆ«</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼šæœªæŒ‡å®šmsgï¼Œé»˜è®¤æ‰“å° hello world</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible ~<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m debug </span>
</span></span><span style=display:flex><span>remote | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;Hello world!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼šæ‰“å°å˜é‡å€¼</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat debug.yaml </span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- hosts: remote
</span></span><span style=display:flex><span>  gather_facts: yes
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: print value of variable
</span></span><span style=display:flex><span>      debug: 
</span></span><span style=display:flex><span>        msg: host <span style=color:#e6db74>&#34;{{ ansible_nodename }}&#34;</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook debug.yaml </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> ***************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> ******************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>print value of variable<span style=color:#f92672>]</span> **********************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;host \&#34;remote\&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP ******************************************************************************************
</span></span><span style=display:flex><span>remote                     : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> 
</span></span></code></pre></div><p>èŒƒä¾‹ï¼šé€šè¿‡ä¸‹æ ‡æ‰“å°æŒ‡å®šå¯¹åº”å­—ç¬¦</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat debug.yaml </span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- hosts: remote
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  vars: 
</span></span><span style=display:flex><span>    str: <span style=color:#e6db74>&#34;01234&#34;</span>
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>  - debug: 
</span></span><span style=display:flex><span>      msg: 
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;{{ str[0] }}&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;{{ str[1] }}&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;{{ str[2] }}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook debug.yaml </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> ***************************************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>debug<span style=color:#f92672>]</span> ****************************************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;0&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;1&#34;</span>, 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;2&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP ******************************************************************************************
</span></span><span style=display:flex><span>remote                     : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h4 id=2425-sysctl-æ¨¡å—>2.4.25 sysctl æ¨¡å—<a hidden class=anchor aria-hidden=true href=#2425-sysctl-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—ç”¨äºä¿®æ”¹å†…æ ¸å‚æ•°</p></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>name  	<span style=color:#75715e># å†…æ ¸å‚æ•°å</span>
</span></span><span style=display:flex><span>value 	<span style=color:#75715e># æŒ‡å®šå€¼</span>
</span></span><span style=display:flex><span>state 	<span style=color:#75715e># æ˜¯å¦ä¿å­˜åœ¨sysctl.confæ–‡ä»¶ä¸­ï¼Œé»˜è®¤present</span>
</span></span><span style=display:flex><span>sysctl_set 	<span style=color:#75715e>#ä½¿ç”¨sysctl -w éªŒè¯å€¼ç”Ÿæ•ˆ</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -m sysctl -a &#39;name=net.ipv4.ip_forward value=1 state=present&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: true
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;grep forward /etc/sysctl.conf&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>net.ipv4.ip_forward<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>å…¶ä»–ç¤ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>remote</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Change Port Range</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sysctl</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>net.ipv4.ip_local_port_range</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;1024 65000&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sysctl_set</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Enabled Forward</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sysctl</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>net.ipv4.ip_forward</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;1&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sysctl_set</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Enabled tcp_reuse</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sysctl</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>net.ipv4.tcp_tw_reuse</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;1&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sysctl_set</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Chanage tcp tw_buckets</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sysctl</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>net.ipv4.tcp_max_tw_buckets</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;5000&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sysctl_set</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Chanage tcp_syncookies</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sysctl</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>net.ipv4.tcp_syncookies</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;1&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sysctl_set</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Chanage tcp max_syn_backlog</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sysctl</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>net.ipv4.tcp_max_syn_backlog</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;8192&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sysctl_set</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Chanage tcp Established Maxconn</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sysctl</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>net.core.somaxconn</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;32768&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sysctl_set</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Chanage tcp_syn_retries</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sysctl</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>net.ipv4.tcp_syn_retries</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;2&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sysctl_set</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Chanage net.ipv4.tcp_synack_retries</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>sysctl</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>net.ipv4.tcp_synack_retries</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;2&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sysctl_set</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span></code></pre></div><h4 id=2426-pam_limits-æ¨¡å—>2.4.26 pam_limits æ¨¡å—<a hidden class=anchor aria-hidden=true href=#2426-pam_limits-æ¨¡å—>#</a></h4><blockquote><p>æ­¤æ¨¡å—ç”¨äºä¿®æ”¹å†…æ ¸èµ„æºé™åˆ¶</p></blockquote><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>name	<span style=color:#75715e># å†…æ ¸å‚æ•°</span>
</span></span><span style=display:flex><span>value	<span style=color:#75715e># æŒ‡å®šå€¼</span>
</span></span><span style=display:flex><span>state	<span style=color:#75715e># æ˜¯å¦ä¿å­˜åœ¨ sysctl.conf æ–‡ä»¶ä¸­ï¼Œé»˜è®¤ä¿å­˜</span>
</span></span><span style=display:flex><span>sysctl_set <span style=color:#75715e># ä½¿ sysctl -w éªŒè¯å€¼ç”Ÿæ•ˆ</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible remote -m sysctl -a <span style=color:#e6db74>&#39;name=net.ipv4.ip_forward value=1 state=present&#39;</span>
</span></span></code></pre></div><p>èŒƒä¾‹å†…æ ¸å‚æ•°ä¼˜åŒ–ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>---
</span></span><span style=display:flex><span>- hosts: remote
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  vars:
</span></span><span style=display:flex><span>    limits_conf_dest: <span style=color:#e6db74>&#39;/etc/security/limits.conf&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: Modify <span style=color:#f92672>{{</span> limits_conf_dest <span style=color:#f92672>}}</span>
</span></span><span style=display:flex><span>      pam_limits:
</span></span><span style=display:flex><span>        dest: <span style=color:#e6db74>&#34;{{ limits_conf_dest }}&#34;</span>
</span></span><span style=display:flex><span>        domain: <span style=color:#e6db74>&#39;*&#39;</span>
</span></span><span style=display:flex><span>        limit_type: <span style=color:#e6db74>&#34;{{ item.limit_type }}&#34;</span>
</span></span><span style=display:flex><span>        limit_item: <span style=color:#e6db74>&#34;{{ item.limit_item }}&#34;</span>
</span></span><span style=display:flex><span>        value: <span style=color:#e6db74>&#34;{{ item.value }}&#34;</span>
</span></span><span style=display:flex><span>      loop:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>{</span> limit_type: <span style=color:#e6db74>&#39;soft&#39;</span>, limit_item: <span style=color:#e6db74>&#39;nofile&#39;</span>, value: <span style=color:#e6db74>&#39;655350&#39;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>{</span> limit_type: <span style=color:#e6db74>&#39;hard&#39;</span>, limit_item: <span style=color:#e6db74>&#39;nofile&#39;</span>, value: <span style=color:#e6db74>&#39;655350&#39;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>{</span> limit_type: <span style=color:#e6db74>&#39;soft&#39;</span>, limit_item: <span style=color:#e6db74>&#39;nproc&#39;</span>, value: <span style=color:#e6db74>&#39;655350&#39;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>{</span> limit_type: <span style=color:#e6db74>&#39;hard&#39;</span>, limit_item: <span style=color:#e6db74>&#39;nproc&#39;</span>, value: <span style=color:#e6db74>&#39;655350&#39;</span> <span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=3-ansible-playbook>3 Ansible Playbook<a hidden class=anchor aria-hidden=true href=#3-ansible-playbook>#</a></h2><h3 id=31-playbook-ç®€ä»‹>3.1 Playbook ç®€ä»‹<a hidden class=anchor aria-hidden=true href=#31-playbook-ç®€ä»‹>#</a></h3><p>å®˜ç½‘ï¼š<a href=https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_intro.html>Ansible playbooks â€” Ansible Documentation</a></p><p>Playbook æ˜¯ Ansible ä¸­ç”¨äºå®šä¹‰è‡ªåŠ¨åŒ–ä»»åŠ¡çš„æ–‡æœ¬æ–‡ä»¶ã€‚å®ƒæ˜¯ä¸€ç§å£°æ˜æ€§çš„æè¿°æ–¹å¼ï¼Œç”¨äºæŒ‡å®šä¸€ç³»åˆ—æ­¥éª¤å’Œé…ç½®ï¼Œä»¥ä¾¿ Ansible å¯ä»¥åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œè¿™äº›æ­¥éª¤ã€‚Playbook å¯ä»¥ç”¨äºé…ç½®æœåŠ¡å™¨ã€éƒ¨ç½²åº”ç”¨ç¨‹åºã€ç®¡ç†ç³»ç»Ÿç­‰ä¸€ç³»åˆ—è‡ªåŠ¨åŒ–ä»»åŠ¡ã€‚</p><p>ä»¥ä¸‹æ˜¯ Playbook çš„ä¸€äº›é‡è¦ç‰¹ç‚¹å’Œç»„æˆéƒ¨åˆ†ï¼š</p><ol><li><p><strong>å£°æ˜æ€§æè¿°</strong>: Playbook é‡‡ç”¨å£°æ˜æ€§çš„æ–¹å¼æè¿°äº†ä½ è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè€Œä¸éœ€è¦è¯¦ç»†è¯´æ˜æ¯ä¸ªæ­¥éª¤çš„æ‰§è¡Œè¿‡ç¨‹ã€‚</p></li><li><p><strong>YAML æ ¼å¼</strong>: Playbook æ˜¯ç”¨ YAMLï¼ˆYet Another Markup Languageï¼‰æ ¼å¼ç¼–å†™çš„ã€‚YAML æ ¼å¼å…·æœ‰è‰¯å¥½çš„å¯è¯»æ€§ï¼Œä½¿å¾— Playbook æ›´æ˜“äºç†è§£å’Œç¼–å†™ã€‚</p></li><li><p><strong>ä¸»æœºæ¸…å•</strong>: åœ¨ Playbook ä¸­ï¼Œä½ å¯ä»¥æŒ‡å®šè¦æ‰§è¡Œä»»åŠ¡çš„ç›®æ ‡ä¸»æœºã€‚è¿™é€šå¸¸é€šè¿‡æ¸…å•æ–‡ä»¶æ¥å®ç°ï¼Œæ¸…å•æ–‡ä»¶åˆ—å‡ºäº†è¦æ‰§è¡Œä»»åŠ¡çš„è¿œç¨‹ä¸»æœºã€‚</p></li><li><p><strong>ä»»åŠ¡</strong>: Playbook ç”±ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡ç»„æˆï¼Œæ¯ä¸ªä»»åŠ¡æè¿°äº†ä¸€ä¸ªç‰¹å®šçš„æ“ä½œï¼Œå¦‚è¿è¡Œå‘½ä»¤ã€å¤åˆ¶æ–‡ä»¶ã€å®‰è£…è½¯ä»¶ç­‰ã€‚</p></li><li><p><strong>æ¨¡å—</strong>: ä»»åŠ¡ä½¿ç”¨æ¨¡å—æ¥æ‰§è¡Œå®é™…çš„æ“ä½œã€‚æ¨¡å—æ˜¯ Ansible åŠŸèƒ½çš„æ„å»ºå—ï¼Œå®ƒä»¬å°è£…äº†å„ç§ä¸åŒç±»å‹çš„ä»»åŠ¡ï¼Œä¾‹å¦‚è¿œç¨‹æ‰§è¡Œå‘½ä»¤ã€æ–‡ä»¶æ“ä½œã€è½¯ä»¶åŒ…ç®¡ç†ç­‰ã€‚</p></li><li><p><strong>å˜é‡</strong>: ä½ å¯ä»¥åœ¨ Playbook ä¸­ä½¿ç”¨å˜é‡æ¥å­˜å‚¨æ•°æ®ï¼Œå¦‚ä¸»æœºåã€IP åœ°å€ã€é…ç½®é€‰é¡¹ç­‰ã€‚å˜é‡å¯ä»¥æé«˜å¯ç»´æŠ¤æ€§å’Œå¯é‡ç”¨æ€§ã€‚</p></li><li><p><strong>æ¡ä»¶å’Œå¾ªç¯</strong>: Playbook æ”¯æŒæ¡ä»¶è¯­å¥å’Œå¾ªç¯ï¼Œå…è®¸ä½ åœ¨ç‰¹å®šæƒ…å†µä¸‹æ‰§è¡Œä¸åŒçš„æ“ä½œï¼Œæˆ–è€…åœ¨å¤šä¸ªä¸»æœºä¸Šé‡å¤æ‰§è¡Œä»»åŠ¡ã€‚</p></li><li><p><strong>è§’è‰²</strong>: è§’è‰²æ˜¯ä¸€ç§ç»„ç»‡å’Œå¤ç”¨ Playbook çš„æ–¹å¼ï¼Œå¯ä»¥å°†ç›¸å…³ä»»åŠ¡å’Œå˜é‡ç»„ç»‡åˆ°ä¸€ä¸ªç»“æ„åŒ–çš„ç›®å½•ä¸­ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç®¡ç†å’Œç»´æŠ¤ã€‚</p></li></ol><p>æ€»ä¹‹ï¼ŒPlaybook æ˜¯ Ansible ä¸­å®šä¹‰å’Œç®¡ç†è‡ªåŠ¨åŒ–ä»»åŠ¡çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒä½¿ä½ èƒ½å¤Ÿä»¥å¯ç»´æŠ¤ä¸”å¯æ‰©å±•çš„æ–¹å¼ç®¡ç†è¿œç¨‹ä¸»æœºä¸Šçš„é…ç½®å’Œæ“ä½œã€‚</p><h4 id=311-playbook-ç»„æˆ>3.1.1 Playbook ç»„æˆ<a hidden class=anchor aria-hidden=true href=#311-playbook-ç»„æˆ>#</a></h4><ul><li>ä¸€ä¸ª playbook(å‰§æœ¬)æ–‡ä»¶æ˜¯ä¸€ä¸ªYAMLè¯­è¨€ç¼–å†™çš„æ–‡æœ¬æ–‡ä»¶</li><li>é€šå¸¸ä¸€ä¸ªplaybookåªåŒ…æ‹¬ä¸€ä¸ªplay</li><li>ä¸€ä¸ª playçš„ä¸»è¦åŒ…æ‹¬ä¸¤éƒ¨åˆ†: ä¸»æœºå’Œtasks. å³å®ç°åœ¨æŒ‡å®šä¸€ç»„ä¸»æœºä¸Šæ‰§è¡Œä¸€ä¸ªtaskså®šä¹‰å¥½çš„ä»»åŠ¡åˆ—è¡¨ã€‚</li><li>ä¸€ä¸ªtasksä¸­å¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªtaskä»»åŠ¡</li><li>æ¯ä¸€ä¸ªTaskæœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨ansibleçš„ä¸€ä¸ªmodule</li><li>åœ¨å¤æ‚åœºæ™¯ä¸­,ä¸€ä¸ªplaybookä¸­ä¹Ÿå¯ä»¥åŒ…æ‹¬å¤šä¸ªplayï¼Œå®ç°å¯¹å¤šç»„ä¸åŒçš„ä¸»æœºæ‰§è¡Œä¸åŒçš„ä»»åŠ¡</li></ul><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ Playbookï¼Œå±•ç¤ºäº†å¦‚ä½•é€šè¿‡å¤šä¸ª play æ‰§è¡Œä¸åŒä»»åŠ¡ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#75715e># è¿™æ˜¯ä¸€ä¸ª Ansible Playbook ç¤ºä¾‹ï¼Œç”¨äºå±•ç¤ºå¤šä¸ª play çš„ç”¨æ³•</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ç¬¬ä¸€ä¸ª playï¼šé…ç½® Web æœåŠ¡å™¨</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>é…ç½® Web æœåŠ¡å™¨</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>web_servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>å®‰è£… Apache</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>yum</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>httpd</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>å¯åŠ¨ Apache æœåŠ¡</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>httpd</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>started</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ç¬¬äºŒä¸ª playï¼šé…ç½®æ•°æ®åº“æœåŠ¡å™¨</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>é…ç½®æ•°æ®åº“æœåŠ¡å™¨</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>db_servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>å®‰è£… MySQL</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>yum</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mysql-server</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>å¯åŠ¨ MySQL æœåŠ¡</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mysqld</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>started</span>
</span></span></code></pre></div><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ª playï¼š</p><ol><li><p><strong>ç¬¬ä¸€ä¸ª play</strong>:</p><ul><li>åç§°ï¼šé…ç½® Web æœåŠ¡å™¨</li><li>ä¸»æœºï¼š<code>web_servers</code> ä¸»æœºç»„</li><li>ä»»åŠ¡ï¼š<ul><li>å®‰è£… Apache è½¯ä»¶åŒ…</li><li>å¯åŠ¨ Apache æœåŠ¡</li></ul></li></ul></li><li><p><strong>ç¬¬äºŒä¸ª play</strong>:</p><ul><li>åç§°ï¼šé…ç½®æ•°æ®åº“æœåŠ¡å™¨</li><li>ä¸»æœºï¼š<code>db_servers</code> ä¸»æœºç»„</li><li>ä»»åŠ¡ï¼š<ul><li>å®‰è£… MySQL è½¯ä»¶åŒ…</li><li>å¯åŠ¨ MySQL æœåŠ¡</li></ul></li></ul></li></ol><p>æ¯ä¸ª play éƒ½ç‹¬ç«‹æ‰§è¡Œï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä¸åŒçš„ä¸»æœºç»„ä¸Šæ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚åœ¨å¤æ‚çš„åœºæ™¯ä¸­ï¼Œè¿™ç§ç»“æ„å¯ä»¥è®©ä½ æ›´æœ‰æ•ˆåœ°ç®¡ç†å’Œç»„ç»‡è‡ªåŠ¨åŒ–ä»»åŠ¡ã€‚æ³¨é‡Šä¸­æä¾›äº†æ¯ä¸ª play æ‰€æ¶‰åŠçš„æ­¥éª¤å’Œä»»åŠ¡çš„æè¿°ï¼Œä»¥å¸®åŠ©ä½ ç†è§£ Playbook çš„ç»“æ„å’ŒåŠŸèƒ½ã€‚</p><h4 id=212-playbook-å’Œ-ad-hoc-å¯¹æ¯”>2.1.2 Playbook å’Œ Ad-Hoc å¯¹æ¯”<a hidden class=anchor aria-hidden=true href=#212-playbook-å’Œ-ad-hoc-å¯¹æ¯”>#</a></h4><p>Ansible æä¾›äº†ä¸¤ç§ä¸»è¦çš„æ“ä½œæ–¹å¼ï¼šPlaybook å’Œ Ad-Hoc å‘½ä»¤ï¼Œç”¨äºåœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œä»»åŠ¡ã€‚ä¸‹é¢æ˜¯å®ƒä»¬ä¹‹é—´çš„è¯¦ç»†å¯¹æ¯”ï¼š</p><p><strong>Playbook:</strong></p><ol><li><p><strong>æè¿°æ€§æ“ä½œ</strong>ï¼šPlaybook æ˜¯ç”¨ YAML æ–‡ä»¶ç¼–å†™çš„ï¼Œä»¥å£°æ˜æ€§çš„æ–¹å¼æè¿°äº†è¦æ‰§è¡Œçš„ä»»åŠ¡å’Œé…ç½®ã€‚å®ƒæ›´é€‚åˆç”¨äºå¤æ‚çš„ã€é•¿æœŸçš„è‡ªåŠ¨åŒ–ä»»åŠ¡ã€‚</p></li><li><p><strong>å¤æ‚æ€§</strong>ï¼šPlaybook æ”¯æŒå¤šä¸ªä¸»æœºã€å¤šä¸ªä»»åŠ¡ã€å˜é‡ã€å¾ªç¯å’Œæ¡ä»¶ç­‰å¤æ‚çš„æ“ä½œã€‚å®ƒé€‚åˆç®¡ç†å…¨é¢çš„é…ç½®å’Œéƒ¨ç½²ã€‚</p></li><li><p><strong>ç»“æ„åŒ–ç»„ç»‡</strong>ï¼šPlaybook å…è®¸å°†ä»»åŠ¡ç»„ç»‡æˆé€»è¾‘çš„ playï¼Œæ¯ä¸ª play éƒ½å¯ä»¥åœ¨ç‰¹å®šçš„ä¸»æœºç»„ä¸Šæ‰§è¡Œã€‚è¿™ä½¿å¾—ä»»åŠ¡æ›´åŠ æ¨¡å—åŒ–å’Œå¯æ‰©å±•ã€‚</p></li><li><p><strong>å¯ç»´æŠ¤æ€§</strong>ï¼šç”±äºå®ƒæ˜¯æ–‡æœ¬æ–‡ä»¶ï¼ŒPlaybook å¯ä»¥è½»æ¾åœ°è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ã€æ–‡æ¡£åŒ–å’Œå…±äº«ã€‚é€‚åˆé•¿æœŸç»´æŠ¤å’Œå›¢é˜Ÿåä½œã€‚</p></li><li><p><strong>å˜é‡å’Œæ¨¡æ¿</strong>ï¼šPlaybook æ”¯æŒå®šä¹‰å˜é‡å’Œä½¿ç”¨ Jinja2 æ¨¡æ¿ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œä»è€Œå®ç°æ›´é«˜åº¦çš„å¯å®šåˆ¶æ€§ã€‚</p></li></ol><p><strong>Ad-Hoc å‘½ä»¤:</strong></p><ol><li><p><strong>å³æ—¶æ€§æ“ä½œ</strong>ï¼šAd-Hoc å‘½ä»¤æ˜¯ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œçš„ï¼Œé€‚ç”¨äºå³æ—¶éœ€è¦çš„ã€å•æ¬¡æ€§çš„ä»»åŠ¡ã€‚</p></li><li><p><strong>å‘½ä»¤è¡Œæ“ä½œ</strong>ï¼šAd-Hoc å‘½ä»¤æ›´é€‚åˆä¸´æ—¶æ“ä½œï¼Œæ— éœ€ç¼–å†™æˆ–ä¿å­˜æ–‡ä»¶ï¼Œç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œã€‚</p></li><li><p><strong>ç®€å•ä»»åŠ¡</strong>ï¼šå®ƒé€‚åˆæ‰§è¡Œç®€å•çš„ã€å¿«é€Ÿçš„ä»»åŠ¡ï¼Œå¦‚æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€ã€æ‰§è¡Œä¸€æ¬¡æ€§å‘½ä»¤ç­‰ã€‚</p></li><li><p><strong>å‘½ä»¤æ¨¡å—</strong>ï¼šAd-Hoc å‘½ä»¤ä½¿ç”¨å‘½ä»¤æ¨¡å—æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå®ƒä»¬æ¯” Playbook çš„æ¨¡å—å°‘ï¼ŒåŠŸèƒ½ç›¸å¯¹æœ‰é™ã€‚</p></li><li><p><strong>éš¾ä»¥ç»´æŠ¤</strong>ï¼šç”±äºå‘½ä»¤ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œï¼ŒAd-Hoc å‘½ä»¤çš„å¯è¯»æ€§å·®ï¼Œä¸é€‚åˆé•¿æœŸç»´æŠ¤å’Œè·Ÿè¸ªã€‚</p></li><li><p><strong>ä¸æ”¯æŒå¤æ‚é€»è¾‘</strong>ï¼šAd-Hoc å‘½ä»¤ä¸æ”¯æŒåƒ Playbook ä¸­çš„å¤æ‚é€»è¾‘ã€æ¡ä»¶åˆ¤æ–­å’Œå¾ªç¯ã€‚</p></li></ol><p><strong>é€‰æ‹©é€‚ç”¨åœºæ™¯ï¼š</strong></p><ul><li>å¦‚æœä½ éœ€è¦æ‰§è¡Œå¤æ‚çš„å¤šæ­¥éª¤ä»»åŠ¡ã€é…ç½®ç®¡ç†å’Œè‡ªåŠ¨åŒ–æµç¨‹ï¼Œåº”ä¼˜å…ˆä½¿ç”¨ Playbookã€‚</li><li>å¦‚æœä½ éœ€è¦å¿«é€Ÿæ‰§è¡Œä¸€æ¬¡æ€§çš„ä»»åŠ¡ï¼Œä¾‹å¦‚ç³»ç»Ÿè¯Šæ–­ã€å¿«é€Ÿæ£€æŸ¥ç­‰ï¼Œå¯ä»¥ä½¿ç”¨ Ad-Hoc å‘½ä»¤ã€‚</li></ul><p>æœ€ç»ˆï¼Œé€‰æ‹© Playbook è¿˜æ˜¯ Ad-Hoc å‘½ä»¤å–å†³äºä½ çš„ä»»åŠ¡éœ€æ±‚ã€å¤æ‚æ€§å’Œé•¿æœŸç»´æŠ¤çš„è¦æ±‚ã€‚</p><h3 id=32-plabook-æ ¸å¿ƒç»„ä»¶>3.2 Plabook æ ¸å¿ƒç»„ä»¶<a hidden class=anchor aria-hidden=true href=#32-plabook-æ ¸å¿ƒç»„ä»¶>#</a></h3><p>å½“æ¶‰åŠ Ansible Playbook çš„ç»„ä»¶æ—¶ï¼Œä»¥ä¸‹æ˜¯æ¯ä¸ªç»„ä»¶çš„ç®€å•ç¤ºä¾‹è¯´æ˜ï¼š</p><ol><li><strong>ä¸»æœºæ¸…å•ï¼ˆInventoryï¼‰ç¤ºä¾‹ï¼š</strong></li></ol><p>ä¸»æœºæ¸…å•æ–‡ä»¶åˆ—å‡ºäº† Ansible å°†è¦ç®¡ç†çš„ä¸»æœºå’Œä¸»æœºç»„ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä¸»æœºæ¸…å•ç¤ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[web_servers]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>web1 ansible_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.1.10</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>web2 ansible_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.1.11</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[db_servers]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>db1 ansible_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.1.20</span>
</span></span></code></pre></div><ol start=2><li><strong>å˜é‡ï¼ˆVariablesï¼‰ç¤ºä¾‹ï¼š</strong></li></ol><p>ä½ å¯ä»¥åœ¨ Playbook ä¸­ä½¿ç”¨å˜é‡æ¥è®¾ç½®ä¸åŒçš„å€¼ï¼Œä»¥ä¾¿åœ¨ä¸åŒçš„ç¯å¢ƒä¸­é‡ç”¨é…ç½®ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å˜é‡ç¤ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Playbook with Variables</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>web_servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>http_port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Display HTTP Port</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;HTTP port is {{ http_port }}&#34;</span>
</span></span></code></pre></div><ol start=3><li><strong>ä»»åŠ¡ï¼ˆTasksï¼‰ç¤ºä¾‹ï¼š</strong></li></ol><p>ä»»åŠ¡æ˜¯ Playbook ä¸­çš„æ“ä½œå•å…ƒï¼Œç”±æ¨¡å—ç»„æˆã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä»»åŠ¡ç¤ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Task</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>web_servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ensure Apache is installed</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>yum</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>httpd</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span></code></pre></div><ol start=4><li><strong>å¤„ç†é…ç½®ï¼ˆHandlersï¼‰ç¤ºä¾‹ï¼š</strong></li></ol><p>å¤„ç†é…ç½®ç”¨äºåœ¨ä»»åŠ¡æ‰§è¡Œåè§¦å‘ä¸€äº›æ“ä½œï¼Œé€šå¸¸ç”¨äºé‡æ–°å¯åŠ¨æœåŠ¡æˆ–é‡æ–°åŠ è½½é…ç½®ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å¤„ç†é…ç½®ç¤ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Playbook with Handlers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>web_servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ensure Apache is installed</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>yum</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>httpd</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>notify</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>Restart Apache</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>handlers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Restart Apache</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>httpd</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>restarted</span>
</span></span></code></pre></div><ol start=5><li><strong>å‰§æœ¬ï¼ˆPlayï¼‰ç¤ºä¾‹ï¼š</strong></li></ol><p>å‰§æœ¬ç”±ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡ç»„æˆï¼Œç”¨äºåœ¨ä¸€ç»„ä¸»æœºä¸Šæ‰§è¡Œæ“ä½œã€‚è¿™æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªä»»åŠ¡çš„å‰§æœ¬ç¤ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Play</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>web_servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ensure Apache is installed</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>yum</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>httpd</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Copy index.html</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>copy</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>src</span>: <span style=color:#ae81ff>/path/to/index.html</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>dest</span>: <span style=color:#ae81ff>/var/www/html/</span>
</span></span></code></pre></div><p>åœ¨æ¯ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘æä¾›äº†ä¸€ä¸ªåŸºæœ¬çš„æ¼”ç¤ºï¼Œè¯´æ˜äº†æ¯ä¸ªç»„ä»¶çš„ç”¨æ³•å’Œä½œç”¨ã€‚è¿™åº”è¯¥æœ‰åŠ©äºä½ æ›´å¥½åœ°ç†è§£ Ansible Playbook çš„ä¸åŒç»„ä»¶ä»¥åŠå®ƒä»¬æ˜¯å¦‚ä½•ä¸€èµ·å·¥ä½œçš„ã€‚</p><h3 id=33--playbook-å‘½ä»¤>3.3 Playbook å‘½ä»¤<a hidden class=anchor aria-hidden=true href=#33--playbook-å‘½ä»¤>#</a></h3><p>å‘½ä»¤æ ¼å¼</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook &lt;filename.yml&gt; ... <span style=color:#f92672>[</span>options<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>å¸¸è§é€‰é¡¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>--syntax,--syntax-check      <span style=color:#75715e># è¯­æ³•æ£€æŸ¥,åŠŸèƒ½ç›¸å½“äºbash -n </span>
</span></span><span style=display:flex><span>-C --check 		<span style=color:#75715e># æ¨¡æ‹Ÿæ‰§è¡Œ dry run ï¼Œåªæ£€æµ‹å¯èƒ½ä¼šå‘ç”Ÿçš„æ”¹å˜ï¼Œä½†ä¸çœŸæ­£æ‰§è¡Œæ“ä½œ</span>
</span></span><span style=display:flex><span>--list-hosts    <span style=color:#75715e># åˆ—å‡ºè¿è¡Œä»»åŠ¡çš„ä¸»æœº</span>
</span></span><span style=display:flex><span>--list-tags 	<span style=color:#75715e># åˆ—å‡º tag</span>
</span></span><span style=display:flex><span>--list-tasks 	<span style=color:#75715e># åˆ—å‡º task</span>
</span></span><span style=display:flex><span>--limit HOST_NAME  <span style=color:#75715e># åªé’ˆå¯¹ä¸»æœºåˆ—è¡¨ä¸­çš„ç‰¹å®šä¸»æœºæ‰§è¡Œ</span>
</span></span><span style=display:flex><span>-i INVENTORY_PATH, --inventory INVENTORY_PATH  <span style=color:#75715e># æŒ‡å®šä¸»æœºæ¸…å•æ–‡ä»¶, é€šå¸¸ä¸€ä¸ªé¡¹å¯¹åº”ä¸€ä¸ªä¸»æœºæ¸…å•æ–‡ä»¶</span>
</span></span><span style=display:flex><span>--start-at-task START_AT_TASK <span style=color:#75715e># ä»æŒ‡å®š task å¼€å§‹æ‰§è¡Œ, è€Œéä»å¤´å¼€å§‹, START_AT_TASKä¸ºä»»åŠ¡çš„</span>
</span></span><span style=display:flex><span>name
</span></span><span style=display:flex><span>-v -vv  -vvv 	<span style=color:#75715e># æ˜¾ç¤ºè¿‡ç¨‹</span>
</span></span></code></pre></div><p>èŒƒä¾‹ï¼šæ‰“å° hello world</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat hello.yaml </span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- hosts: remote
</span></span><span style=display:flex><span>  gather_facts: no <span style=color:#75715e># ä¸æ”¶é›†ç›®æ ‡ä¸»æœºä¿¡æ¯ï¼ŒåŠ å¿«æ‰§è¡Œé€Ÿåº¦</span>
</span></span><span style=display:flex><span>  tasks: 
</span></span><span style=display:flex><span>    - name: hello
</span></span><span style=display:flex><span>      command: echo <span style=color:#e6db74>&#34;hello world!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook hello.yaml </span>
</span></span></code></pre></div><p>ç¤ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># åˆ—å‡º playbook ä¸­çš„ä¸»æœº</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook hello.yaml --list-hosts</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>playbook: hello.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  play <span style=color:#75715e>#1 (remote): remote	TAGS: []</span>
</span></span><span style=display:flex><span>    pattern: <span style=color:#f92672>[</span>u<span style=color:#e6db74>&#39;remote&#39;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    hosts <span style=color:#f92672>(</span>1<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>      remote
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ—å‡º playbook ä¸­çš„ä»»åŠ¡</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook hello.yaml --list-tasks</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>playbook: hello.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  play <span style=color:#75715e>#1 (remote): remote	TAGS: []</span>
</span></span><span style=display:flex><span>    tasks:
</span></span><span style=display:flex><span>      hello	TAGS: <span style=color:#f92672>[]</span>
</span></span></code></pre></div><h3 id=34-ignore_errors>3.4 ignore_errors<a hidden class=anchor aria-hidden=true href=#34-ignore_errors>#</a></h3><p>åœ¨ playbook æ‰§è¡Œæ—¶ï¼Œå¦‚æœæŸä¸ª task å‡ºé”™ï¼Œåˆ™åç»­ä»»åŠ¡ä¸ä¼šå†æ‰§è¡Œ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat test_ignore.yaml </span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- hosts: remote
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>  tasks: 
</span></span><span style=display:flex><span>    - name: task1
</span></span><span style=display:flex><span>      command: /bin/false
</span></span><span style=display:flex><span>      ignore_errors: yes  <span style=color:#75715e># å¿½ç•¥è¯¥taskçš„æŠ¥é”™ï¼Œç»§ç»­æ‰§è¡Œåç»­ä»»åŠ¡</span>
</span></span><span style=display:flex><span>    - name: task2
</span></span><span style=display:flex><span>      command: echo <span style=color:#e6db74>&#34;hello world!&#34;</span>
</span></span><span style=display:flex><span>- hosts: remote
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: task3
</span></span><span style=display:flex><span>      command: /bin/false <span style=color:#75715e># æ­¤æ­¥éª¤æŠ¥é”™ï¼Œä¸å†æ‰§è¡Œåç»­ä»»åŠ¡</span>
</span></span><span style=display:flex><span>    - name: task4
</span></span><span style=display:flex><span>      command: echo <span style=color:#e6db74>&#34;END---&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#å®é™…è¿è¡Œæ•ˆæœï¼štask4ä¸ä¼šæ‰§è¡Œ</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook test_ignore.yaml </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> ***********************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task1<span style=color:#f92672>]</span> ************************************************************************
</span></span><span style=display:flex><span>fatal: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span>: FAILED! <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/python&#34;</span><span style=color:#f92672>}</span>, <span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/bin/false&#34;</span><span style=color:#f92672>]</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.272950&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2023-08-23 16:10:01.027320&#34;</span>, <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;non-zero return code&#34;</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 1, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2023-08-23 16:10:00.754370&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[]}</span>
</span></span><span style=display:flex><span>...ignoring
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task2<span style=color:#f92672>]</span> ************************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> ***********************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task3<span style=color:#f92672>]</span> ************************************************************************
</span></span><span style=display:flex><span>fatal: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span>: FAILED! <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/bin/false&#34;</span><span style=color:#f92672>]</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.276205&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2023-08-23 16:10:02.161360&#34;</span>, <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;non-zero return code&#34;</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 1, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2023-08-23 16:10:01.885155&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[]}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP **************************************************************************
</span></span><span style=display:flex><span>remote                     : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span></code></pre></div><h3 id=35-handlers-å’Œ-notify>3.5 handlers å’Œ notify<a hidden class=anchor aria-hidden=true href=#35-handlers-å’Œ-notify>#</a></h3><p>Handlers æœ¬è´¨æ˜¯ task list ï¼Œç±»ä¼¼äº MySQL ä¸­çš„è§¦å‘å™¨è§¦å‘çš„è¡Œä¸ºï¼Œå…¶ä¸­çš„ task ä¸å‰è¿°çš„ task å¹¶æ²¡æœ‰æœ¬è´¨ä¸Šçš„ä¸åŒï¼Œåªæœ‰åœ¨å…³æ³¨çš„èµ„æºå‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡‡å–ä¸€å®šçš„æ“ä½œã€‚</p><p>Notify å¯¹åº”çš„ action åœ¨æ‰€æœ‰ task éƒ½æ‰§è¡Œå®Œæ‰ä¼šæœ€åè¢«è§¦å‘ï¼Œè¿™æ ·å¯é¿å…å¤šä¸ª task å¤šæ¬¡æ”¹å˜å‘ç”Ÿæ—¶æ¯æ¬¡éƒ½è§¦å‘æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œï¼ŒHandlers ä»…åœ¨æ‰€æœ‰çš„å˜åŒ–å‘ç”Ÿå®Œæˆåä¸€æ¬¡æ€§åœ°æ‰§è¡ŒæŒ‡å®šæ“ä½œã€‚</p><p>åœ¨ notify ä¸­åˆ—å‡ºçš„æ“ä½œç§°ä¸º handler ï¼Œä¹Ÿå³ notify ä¸­è°ƒç”¨ handler ä¸­å®šä¹‰çš„æ“ä½œ</p><p><strong>æ³¨æ„:</strong></p><ul><li>å¦‚æœå¤šä¸ª task é€šçŸ¥äº†ç›¸åŒçš„handlersï¼Œ æ­¤handlersä»…ä¼šåœ¨æ‰€æœ‰taskç»“æŸåè¿è¡Œä¸€ æ¬¡ã€‚</li><li>åªæœ‰ notify å¯¹åº”çš„ task å‘ç”Ÿæ”¹å˜äº†æ‰ä¼šé€šçŸ¥ handlersï¼Œæ²¡æœ‰æ”¹å˜åˆ™ä¸ä¼šè§¦å‘handlers</li><li>handlers æ˜¯åœ¨æ‰€æœ‰å‰é¢çš„ tasks éƒ½æˆåŠŸæ‰§è¡Œæ‰ä¼šæ‰§è¡Œï¼Œå¦‚æœå‰é¢ä»»ä½•ä¸€ä¸ª task å¤±è´¥ï¼Œä¼šå¯¼è‡´ handler è·³è¿‡æ‰§è¡Œ</li></ul><p>ç¤ºä¾‹ï¼šæ‰§è¡Œä¸¤ä¸ª handle</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>remote</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>task1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>command</span>: <span style=color:#ae81ff>/bin/true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>notify</span>:   <span style=color:#75715e># è§¦å‘ handlers ä¸­çš„ä»»åŠ¡æ‰§è¡Œ</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>get up</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>go to school</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>handlers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>get up</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Get it&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>go to school</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;I am going to school&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>root@ansible playbooks]# ansible-playbook test.yaml </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>PLAY [remote] ******************************************************************</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>TASK [task1] *******************************************************************</span>
</span></span><span style=display:flex><span><span style=color:#f92672>changed</span>: [<span style=color:#ae81ff>remote]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>RUNNING HANDLER [get up] *******************************************************</span>
</span></span><span style=display:flex><span><span style=color:#f92672>ok</span>: [<span style=color:#ae81ff>remote] =&gt; {</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;msg&#34;: </span><span style=color:#e6db74>&#34;Get it&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>RUNNING HANDLER [go to school] *************************************************</span>
</span></span><span style=display:flex><span><span style=color:#f92672>ok</span>: [<span style=color:#ae81ff>remote] =&gt; {</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;msg&#34;: </span><span style=color:#e6db74>&#34;I am going to school&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>PLAY RECAP *********************************************************************</span>
</span></span><span style=display:flex><span><span style=color:#f92672>remote                     </span>: <span style=color:#ae81ff>ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 </span>
</span></span></code></pre></div><p>å¦‚æœæœ‰ä»»æ„ä¸€ä¸ªtask æ‰§è¡Œå¤±è´¥ï¼Œhandlers ä¸­çš„ä»»åŠ¡ä¸ä¼šæ‰§è¡Œï¼ˆå³ä½¿åŠ äº†<code>ignore_errors</code>ï¼‰ï¼Œæ­¤æ—¶å¯ä»¥åŠ ä¸Š<code>force_handlers: yes</code>æ¥å¼ºåˆ¶æ‰§è¡Œ handlers</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>---
</span></span><span style=display:flex><span>- hosts: remote
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>  force_handlers: yes <span style=color:#75715e># å¿½ç•¥ä»»ä¸€ task æ‰§è¡ŒæŠ¥é”™ï¼Œç»§ç»­å…¶ä»– task åŠå…¶ handler</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: task1
</span></span><span style=display:flex><span>      command: /bin/true
</span></span><span style=display:flex><span>      notify:   <span style=color:#75715e># è§¦å‘ handlers ä¸­çš„ä»»åŠ¡æ‰§è¡Œ</span>
</span></span><span style=display:flex><span>        - get up
</span></span><span style=display:flex><span>    - name: task2
</span></span><span style=display:flex><span>      command: /bin/false 
</span></span><span style=display:flex><span>      notify:
</span></span><span style=display:flex><span>        - go to school	<span style=color:#75715e># ç”±äºtask2 æŠ¥é”™ï¼Œä¸ä¼šé€šçŸ¥ç›¸åº”çš„handleræ‰§è¡Œ</span>
</span></span><span style=display:flex><span>  handlers:
</span></span><span style=display:flex><span>    - name: get up
</span></span><span style=display:flex><span>      debug:
</span></span><span style=display:flex><span>        msg: <span style=color:#e6db74>&#34;Get it&#34;</span>
</span></span><span style=display:flex><span>    - name: go to school
</span></span><span style=display:flex><span>      debug:
</span></span><span style=display:flex><span>        msg: <span style=color:#e6db74>&#34;I am going to school&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook test.yaml </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> ******************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task1<span style=color:#f92672>]</span> *******************************************************************
</span></span><span style=display:flex><span>changed: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task2<span style=color:#f92672>]</span> *******************************************************************
</span></span><span style=display:flex><span>fatal: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span>: FAILED! <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;changed&#34;</span>: true, <span style=color:#e6db74>&#34;cmd&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/bin/false&#34;</span><span style=color:#f92672>]</span>, <span style=color:#e6db74>&#34;delta&#34;</span>: <span style=color:#e6db74>&#34;0:00:00.273631&#34;</span>, <span style=color:#e6db74>&#34;end&#34;</span>: <span style=color:#e6db74>&#34;2023-08-24 08:52:38.649403&#34;</span>, <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;non-zero return code&#34;</span>, <span style=color:#e6db74>&#34;rc&#34;</span>: 1, <span style=color:#e6db74>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;2023-08-24 08:52:38.375772&#34;</span>, <span style=color:#e6db74>&#34;stderr&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stderr_lines&#34;</span>: <span style=color:#f92672>[]</span>, <span style=color:#e6db74>&#34;stdout&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;stdout_lines&#34;</span>: <span style=color:#f92672>[]}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUNNING HANDLER <span style=color:#f92672>[</span>get up<span style=color:#f92672>]</span> *******************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;Get it&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************
</span></span><span style=display:flex><span>remote                     : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> 
</span></span></code></pre></div><h3 id=36-playbook-ä¸­ä½¿ç”¨-tags>3.6 Playbook ä¸­ä½¿ç”¨ tags<a hidden class=anchor aria-hidden=true href=#36-playbook-ä¸­ä½¿ç”¨-tags>#</a></h3><p><a href=https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_tags.html>Tags â€” Ansible Documentation</a></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œansible ä¼šæ‰§è¡Œ playbook ä¸­çš„æ‰€æœ‰ä»»åŠ¡ã€‚æ ¹æ®éœ€è¦ï¼Œå¯ä»¥ç»™æŒ‡å®šçš„ task æŒ‡å®šæ ‡ç­¾ï¼Œå³ tagï¼Œè€Œååœ¨æ‰§è¡Œ playbook æ—¶ï¼Œå¸¦ä¸Šå¯¹åº”çš„ tag ä»¥è¿è¡ŒæŒ‡å®šçš„ taskã€‚</p><ul><li>ä¸€ä¸ª task å¯ä»¥æœ‰å¤šä¸ª tag</li><li>å†…ç½®çš„ tag æœ‰ï¼š taggedï¼Œuntagged å’Œ allï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ä»…è¿è¡Œæœ‰tagï¼Œæ²¡æœ‰tagçš„ä»»åŠ¡å’Œæ‰€æœ‰ä»»åŠ¡ã€‚</li></ul><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat test_tags.yml </span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- hosts: remote
</span></span><span style=display:flex><span>  remote_user: root
</span></span><span style=display:flex><span>  gather_facts: no
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  tasks:
</span></span><span style=display:flex><span>    - name: task1
</span></span><span style=display:flex><span>      debug:
</span></span><span style=display:flex><span>        msg: <span style=color:#e6db74>&#34;task1&#34;</span>
</span></span><span style=display:flex><span>      tags:
</span></span><span style=display:flex><span>        - tag1
</span></span><span style=display:flex><span>        - tag_one
</span></span><span style=display:flex><span>    - name: task2
</span></span><span style=display:flex><span>      debug:
</span></span><span style=display:flex><span>        msg: <span style=color:#e6db74>&#34;task2&#34;</span>
</span></span><span style=display:flex><span>    - name: task3
</span></span><span style=display:flex><span>      debug:
</span></span><span style=display:flex><span>        msg: <span style=color:#e6db74>&#34;task3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ—å‡ºæ‰€æœ‰ tag</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook test_tags.yml --list-tags</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>playbook: test_tags.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  play <span style=color:#75715e>#1 (remote): remote	TAGS: []</span>
</span></span><span style=display:flex><span>      TASK TAGS: <span style=color:#f92672>[</span>tag1, tag_one<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åªè¿è¡Œå¸¦æœ‰ tag1 çš„ task</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook test_tags.yml -t tag1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> ******************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task1<span style=color:#f92672>]</span> *******************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;task1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************
</span></span><span style=display:flex><span>remote                     : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åªè¿è¡Œæ²¡æœ‰ tag çš„ task</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook test_tags.yml -t untagged</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> ******************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task2<span style=color:#f92672>]</span> *******************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;task2&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>task3<span style=color:#f92672>]</span> *******************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;task3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************
</span></span><span style=display:flex><span>remote                     : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ä¸æ‰§è¡Œæœ‰ç‰¹å®š tag çš„ task</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook test_tags.yml --skip-tags tag_one</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ä¸æ‰§è¡Œæ²¡æœ‰ tag çš„ task</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook test_tags.yml --skip-tags untagged</span>
</span></span></code></pre></div><h3 id=37-playbook-ä¸­ä½¿ç”¨å˜é‡>3.7 Playbook ä¸­ä½¿ç”¨å˜é‡<a hidden class=anchor aria-hidden=true href=#37-playbook-ä¸­ä½¿ç”¨å˜é‡>#</a></h3><blockquote><p>åœ¨ Ansible ä¸­ï¼Œ<code>setup</code> æ¨¡å—ç”¨äºæ”¶é›†æœ‰å…³è¿œç¨‹ä¸»æœºçš„å„ç§ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯è¢«ç§°ä¸º &ldquo;facts&rdquo;ã€‚è¿™äº› facts åŒ…æ‹¬æœ‰å…³æ“ä½œç³»ç»Ÿã€ç¡¬ä»¶ã€ç½‘ç»œã€å†…å­˜ã€CPU ç­‰çš„ä¿¡æ¯ï¼Œå¯ä»¥ç”¨äºç¼–å†™æ›´åŠ çµæ´»å’ŒåŠ¨æ€çš„å‰§æœ¬ã€‚ä½¿ç”¨ <code>setup</code> æ¨¡å—å¯ä»¥é€šè¿‡ Ansible æ”¶é›†è¿œç¨‹ä¸»æœºçš„ factsã€‚è°ƒç”¨ playbook æ—¶é»˜è®¤è°ƒç”¨æ­¤æ¨¡å—ï¼Œå¯é€šè¿‡ <code>gather_facts: no</code> æ¥ç¦æ­¢ã€‚</p></blockquote><p><strong>å˜é‡å‘½ä»¤è§„åˆ™</strong>ï¼šç”±å­—æ¯ï¼Œæ•°å­—ï¼Œä¸‹åˆ’çº¿ç»„æˆä¸”åªèƒ½ä»¥å­—æ¯å¼€å¤´</p><p><strong>å˜é‡è°ƒç”¨æ–¹å¼</strong>ï¼šé€šè¿‡ {{ VARIBLE_NAME }} è°ƒç”¨å˜é‡ï¼Œå»ºè®®å˜é‡åå‰ååŠ ç©ºæ ¼ï¼Œä¸”æœ‰æ—¶éœ€è¦ä»¥åŒå¼•å·åŒ…è£¹ â€{{ VARIBLE_NAME }}â€œ ï¼ˆå¦‚ï¼šdebug æ¨¡å—ä¸­ï¼‰</p><p><strong>å˜é‡æ¥æºï¼š</strong></p><ul><li><p>ansible çš„ setup æ¨¡å—æ”¶é›†çš„ facts å˜é‡</p></li><li><p>é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šå˜é‡ï¼Œä¼˜å…ˆçº§æœ€é«˜</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook my_playbook.yml -e <span style=color:#e6db74>&#34;my_variable=value&#34;</span>
</span></span></code></pre></div></li><li><p>åœ¨ playbook ä¸­å®šä¹‰</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Playbook</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>my_var</span>: <span style=color:#e6db74>&#34;Hello, Ansible!&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Display variable</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>my_var</span>
</span></span></code></pre></div></li><li><p>åœ¨ç‹¬ç«‹çš„YAMLæ–‡ä»¶ä¸­å®šä¹‰ï¼Œç„¶åé€šè¿‡å…³é”®å­— <code>vars_files</code> å¼•å…¥</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>remote</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars_fiels</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>my_vars.yml </span>
</span></span></code></pre></div></li><li><p>åœ¨ä¸»æœºæ¸…å•æ–‡ä»¶ä¸­å®šä¹‰</p><ul><li><p><strong>ä¸»æœºå˜é‡ï¼š</strong> åœ¨ä¸»æœºæ¸…å•ï¼ˆInventoryï¼‰ä¸­å®šä¹‰çš„å˜é‡ï¼Œä¼˜å…ˆçº§é«˜äºç»„å˜é‡</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>[<span style=color:#ae81ff>my_hosts]</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>host1 my_variable=host_value</span>
</span></span></code></pre></div></li><li><p><strong>ç»„å˜é‡ï¼š</strong> åœ¨ä¸»æœºæ¸…å•ä¸­çš„ç»„çº§åˆ«å®šä¹‰çš„å˜é‡ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>[<span style=color:#ae81ff>my_group:vars]</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>my_variable=group_value</span>
</span></span></code></pre></div></li></ul></li><li><p>åœ¨é¡¹ç›®ä¸­é’ˆå¯¹ä¸»æœºå’Œä¸»æœºç»„å®šä¹‰</p><p>åœ¨é¡¹ç›®ç›®å½•ä¸‹åˆ›å»º host_vars å’Œ group_vars ç›®å½•ï¼Œåœ¨å…¶ä¸­æ–°å»º YAML æ–‡ä»¶å®šä¹‰å˜é‡</p></li><li><p>åœ¨ role ï¼ˆè§’è‰²ï¼‰ä¸­å®šä¹‰</p><p>åœ¨ Ansible è§’è‰²ä¸­ï¼Œå˜é‡ä¹Ÿæœ‰ä¼˜å…ˆçº§ï¼Œç±»ä¼¼äº Ansible çš„å…¶ä»–å˜é‡ã€‚è§’è‰²å†…çš„å˜é‡å¯ä»¥åˆ†ä¸ºå‡ ä¸ªä¸åŒçš„çº§åˆ«ï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°ä½æ’åˆ—å¦‚ä¸‹ï¼š</p><ol><li><p><strong>è§’è‰²ä»»åŠ¡å˜é‡ï¼ˆRole Task Variablesï¼‰</strong>ï¼šè¿™äº›å˜é‡åœ¨è§’è‰²å†…çš„ä»»åŠ¡ä¸­å®šä¹‰ï¼Œå¹¶ä¸”åªåœ¨ç‰¹å®šä»»åŠ¡ä¸­ç”Ÿæ•ˆã€‚è¿™äº›å˜é‡çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œä¼šè¦†ç›–å…¶ä»–çº§åˆ«çš„å˜é‡ã€‚</p><p>åœ¨è§’è‰²ä»»åŠ¡ä¸­å®šä¹‰çš„å˜é‡ï¼Œé€šå¸¸å­˜å‚¨åœ¨ä»»åŠ¡ä¸­çš„ <code>vars</code> éƒ¨åˆ†ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example role task</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;This is a task with a role-level variable&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>task_variable</span>: <span style=color:#ae81ff>value</span>
</span></span></code></pre></div></li><li><p><strong>è§’è‰²é»˜è®¤å˜é‡ï¼ˆRole Default Variablesï¼‰</strong>ï¼šè§’è‰²çš„é»˜è®¤å˜é‡å­˜å‚¨åœ¨è§’è‰²çš„ <code>defaults</code> ç›®å½•ä¸‹ã€‚è¿™äº›å˜é‡åœ¨è§’è‰²å†…éƒ¨è¢«è®¤ä¸ºæ˜¯é»˜è®¤è®¾ç½®ï¼Œé™¤éè¢«å…¶ä»–çº§åˆ«çš„å˜é‡è¦†ç›–ã€‚</p><p>è§’è‰²é»˜è®¤å˜é‡å­˜å‚¨åœ¨ <code>roles/role_name/defaults/main.yml</code> æ–‡ä»¶ä¸­ã€‚</p></li><li><p><strong>è§’è‰²å˜é‡ï¼ˆRole Variablesï¼‰</strong>ï¼šåœ¨ä½¿ç”¨è§’è‰²æ—¶ï¼Œå¯ä»¥åœ¨ä¸»å‰§æœ¬ä¸­ä¸ºè§’è‰²è®¾ç½®å˜é‡ã€‚è¿™äº›å˜é‡å¯ä»¥å½±å“è§’è‰²ä¸­çš„ä»»åŠ¡å’Œé»˜è®¤å˜é‡ã€‚</p><p>åœ¨ä¸»å‰§æœ¬ä¸­ä¸ºè§’è‰²è®¾ç½®å˜é‡çš„æ–¹å¼å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Playbook using a role</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>target_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>roles</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>role</span>: <span style=color:#ae81ff>role_name</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>role_var</span>: <span style=color:#ae81ff>value</span>
</span></span></code></pre></div></li><li><p><strong>ä¸»æœºæ¸…å•ä¸­çš„å˜é‡ï¼ˆInventory Variablesï¼‰</strong>ï¼šåœ¨ä¸»æœºæ¸…å•ä¸­ä¸ºä¸»æœºæˆ–ä¸»æœºç»„å®šä¹‰çš„å˜é‡ã€‚è¿™äº›å˜é‡åœ¨è§’è‰²å†…ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯å…¶ä¼˜å…ˆçº§è¾ƒä½ã€‚</p><p>åœ¨ä¸»æœºæ¸…å•ä¸­ä¸ºä¸»æœºå®šä¹‰å˜é‡çš„æ–¹å¼å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[target_hosts]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>host1 ansible_ssh_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.1.1 role_var=value</span>
</span></span></code></pre></div></li></ol></li></ul><p><strong>å˜é‡ä¼˜å…ˆçº§ä»é«˜åˆ°ä½å¦‚ä¸‹ï¼š</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>1. å‘½ä»¤è¡Œ -e ä¼ é€’çš„å˜é‡ 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>2. playbook ä¸­ 
</span></span><span style=display:flex><span>   2.1 vars_files å¼•å…¥çš„å˜é‡
</span></span><span style=display:flex><span>   2.1 playbook ä¸­ vars å˜é‡å®šä¹‰ 
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>3. host_vars/ä¸»æœºåæ–‡ä»¶ 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>4. ä¸»æœºæ¸…å•ä¸­çš„ä¸»æœºå˜é‡ 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>5. group_vars
</span></span><span style=display:flex><span>   5.1 ä¸»æœºç»„åæ–‡ä»¶
</span></span><span style=display:flex><span>   5.2 all.yml
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>6. ä¸»æœºæ¸…å•ä¸­çš„ç»„å˜é‡
</span></span></code></pre></div><blockquote><p>æ€»çš„æ¥è¯´ï¼Œå˜é‡å®šä¹‰æ–¹å¼å¤šè€Œæ‚ï¼Œå®é™…ä½¿ç”¨æ—¶åº”é¿å…åœ¨å¤šä¸ªåœ°æ–¹å®šä¹‰åŒä¸€ä¸ªå˜é‡ï¼Œé™ä½å¤æ‚åº¦ï¼Œä»è€Œé™ä½ç»´æŠ¤æˆæœ¬ï¼Œå‡å°‘å‡ºé”™çš„å¯èƒ½æ€§ã€‚</p></blockquote><h4 id=371-ä½¿ç”¨-setup-æ¨¡å—ä¸­çš„å˜é‡>3.7.1 ä½¿ç”¨ setup æ¨¡å—ä¸­çš„å˜é‡<a hidden class=anchor aria-hidden=true href=#371-ä½¿ç”¨-setup-æ¨¡å—ä¸­çš„å˜é‡>#</a></h4><h5 id=3711-ä½¿ç”¨-facts-å˜é‡>3.7.1.1 ä½¿ç”¨ facts å˜é‡<a hidden class=anchor aria-hidden=true href=#3711-ä½¿ç”¨-facts-å˜é‡>#</a></h5><p>æœ¬æ¨¡å—è‡ªåŠ¨åœ¨playbookè°ƒç”¨ï¼Œç”Ÿæˆçš„ç³»ç»ŸçŠ¶æ€ä¿¡æ¯, å¹¶å°†ä¹‹å­˜æ”¾åœ¨factså˜é‡ä¸­</p><p>facts åŒ…æ‹¬çš„ä¿¡æ¯å¾ˆå¤š,å¦‚: ä¸»æœºå, IP, CPU, å†…å­˜, ç½‘å¡ç­‰</p><p><strong>facts å˜é‡çš„å®é™…ä½¿ç”¨åœºæ™¯æ¡ˆä¾‹</strong></p><ul><li><p>é€šè¿‡factså˜é‡è·å–è¢«æ§ç«¯CPUçš„ä¸ªæ•°ä¿¡æ¯ï¼Œä»è€Œç”Ÿæˆä¸åŒçš„Nginxé…ç½®æ–‡ä»¶</p></li><li><p>é€šè¿‡factså˜é‡è·å–è¢«æ§ç«¯å†…å­˜å¤§å°ä¿¡æ¯ï¼Œä»è€Œç”Ÿæˆä¸åŒçš„memcachedçš„é…ç½®æ–‡ä»¶</p></li><li><p>é€šè¿‡factså˜é‡è·å–è¢«æ§ç«¯ä¸»æœºåç§°ä¿¡æ¯ï¼Œä»è€Œç”Ÿæˆä¸åŒçš„Zabbixé…ç½®æ–‡ä»¶</p></li><li><p>é€šè¿‡factså˜é‡è·å–è¢«æ§ç«¯ç½‘å¡ä¿¡æ¯ï¼Œä»è€Œç”Ÿæˆä¸åŒçš„ä¸»æœºå</p><p>&mldr;&mldr;</p></li></ul><p>èŒƒä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># è·å–ç½‘å¡ä¿¡æ¯</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m setup -a &#39;filter=&#34;ansible_default_ipv4&#34;&#39;</span>
</span></span><span style=display:flex><span>localhost | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ansible_default_ipv4&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;address&#34;</span>: <span style=color:#e6db74>&#34;192.168.146.128&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;alias&#34;</span>: <span style=color:#e6db74>&#34;ens33&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;broadcast&#34;</span>: <span style=color:#e6db74>&#34;192.168.146.255&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;gateway&#34;</span>: <span style=color:#e6db74>&#34;192.168.146.254&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;interface&#34;</span>: <span style=color:#e6db74>&#34;ens33&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;macaddress&#34;</span>: <span style=color:#e6db74>&#34;00:0c:29:c6:1a:98&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;mtu&#34;</span>: 1500, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;netmask&#34;</span>: <span style=color:#e6db74>&#34;255.255.255.0&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;network&#34;</span>: <span style=color:#e6db74>&#34;192.168.146.0&#34;</span>, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;ether&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹ä¸»æœºå</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible localhost -m setup -a &#39;filter=&#34;ansible_nodename&#34;&#39;</span>
</span></span><span style=display:flex><span>localhost | SUCCESS <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ansible_facts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ansible_nodename&#34;</span>: <span style=color:#e6db74>&#34;ansible&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;changed&#34;</span>: false
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ ¹æ®ä¸»æœºåç”Ÿæˆæ—¥å¿—æ–‡ä»¶</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># vim touch_host_log.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook touch_host_log.yaml </span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible remote -a &#39;ls /tmp/remote.log&#39;</span>
</span></span><span style=display:flex><span>remote | CHANGED | rc<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> &gt;&gt;
</span></span><span style=display:flex><span>/tmp/remote.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># è·å–ç½‘å¡åœ°å€</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># cat show_ip_of_eth0.yaml </span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- hosts: remote
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tasks: 
</span></span><span style=display:flex><span>    - name: show ens33 ip address of <span style=color:#f92672>{{</span> ansible_facts<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;eth0&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;ipv4&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;address&#34;</span><span style=color:#f92672>]</span> <span style=color:#f92672>}}</span>
</span></span><span style=display:flex><span>      debug:
</span></span><span style=display:flex><span>        msg: Ip address <span style=color:#f92672>{{</span> ansible_facts.ens33.ipv4.address <span style=color:#f92672>}}</span>
</span></span><span style=display:flex><span>    - name: another way
</span></span><span style=display:flex><span>      debug: Ip address <span style=color:#f92672>{{</span> ansible_facts<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;ens33&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;ipv4&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;address&#34;</span><span style=color:#f92672>]</span> <span style=color:#f92672>}}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ansible playbooks<span style=color:#f92672>]</span><span style=color:#75715e># ansible-playbook show_ip_of_eth0.yaml </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> ******************************************************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>Gathering Facts<span style=color:#f92672>]</span> *********************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>show ens33 ip address of <span style=color:#f92672>{{</span> ansible_facts<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;eth0&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;ipv4&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;address&#34;</span><span style=color:#f92672>]</span> <span style=color:#f92672>}}]</span> ***
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;Ip address 192.168.146.129&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#f92672>[</span>another way<span style=color:#f92672>]</span> *************************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#f92672>[</span>remote<span style=color:#f92672>]</span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;msg&#34;</span>: <span style=color:#e6db74>&#34;Hello world!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************
</span></span><span style=display:flex><span>remote                     : ok<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>    changed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    unreachable<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    failed<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    skipped<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    rescued<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>    ignored<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>   
</span></span></code></pre></div><h5 id=3712-æ€§èƒ½ä¼˜åŒ–>3.7.1.2 æ€§èƒ½ä¼˜åŒ–<a hidden class=anchor aria-hidden=true href=#3712-æ€§èƒ½ä¼˜åŒ–>#</a></h5><p>æ‰§è¡Œ playbook æ—¶ï¼Œé»˜è®¤å¯ç”¨ setup æ¨¡å—æ”¶é›†ç›®æ ‡ä¸»æœºçš„ facts å˜é‡ï¼Œä¼šè€—è´¹ä¸€å®šæ—¶é—´ã€‚å¯é€‰åˆ™ä»¥ä¸‹ä¸¤ç§æ–¹å¼è¿›è¡Œé…ç½®</p><ul><li><p>å¦‚æœä¸éœ€è¦ä½¿ç”¨åˆ°ç›®æ ‡ä¸»æœºçš„å˜é‡ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ <code>gather_facts: no</code> é€‰é¡¹æ¥å…³é—­æ­¤è¡Œä¸º</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>all</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span></code></pre></div></li><li><p>åœ¨ Ansible ä¸­ï¼Œ&ldquo;facts ç¼“å­˜&rdquo; æ˜¯æŒ‡å°†ä¸»æœºçš„äº‹å®æ•°æ®ï¼ˆä¾‹å¦‚ä¸»æœºåã€æ“ä½œç³»ç»Ÿä¿¡æ¯ã€IP åœ°å€ç­‰ï¼‰ç¼“å­˜èµ·æ¥ï¼Œä»¥ä¾¿åœ¨åç»­çš„ Ansible è¿è¡Œä¸­é‡ç”¨è¿™äº›æ•°æ®ï¼Œä»è€Œå‡å°‘ç³»ç»Ÿèµ„æºçš„ä½¿ç”¨å’Œæé«˜æ‰§è¡Œæ•ˆç‡ã€‚</p><p>è¦å¯ç”¨ Ansible çš„ Facts ç¼“å­˜åŠŸèƒ½ï¼Œä½ å¯ä»¥åœ¨ Ansible é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œè®¾ç½®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒAnsible å°†äº‹å®æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä½†ä½ ä¹Ÿå¯ä»¥é€‰æ‹©å°†å…¶å­˜å‚¨åœ¨ç£ç›˜ä¸Šä»¥å®ç°æŒä¹…æ€§ã€‚</p><p>ä»¥ä¸‹æ˜¯å¯ç”¨ Ansible Facts ç¼“å­˜çš„é…ç½®ç¤ºä¾‹ï¼š</p><ol><li><strong>å­˜å‚¨åœ¨å†…å­˜ä¸­</strong>ï¼š</li></ol><p>åœ¨ Ansible é…ç½®æ–‡ä»¶ä¸­ï¼ˆé€šå¸¸æ˜¯ <code>/etc/ansible/ansible.cfg</code> æˆ– <code>~/.ansible.cfg</code>ï¼‰ï¼Œæ·»åŠ ä»¥ä¸‹é…ç½®è¡Œï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[defaults]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>gathering</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>smart</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fact_caching</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>memory</span>
</span></span></code></pre></div><ol start=2><li><strong>å­˜å‚¨åœ¨ç£ç›˜ä¸Š</strong>ï¼š</li></ol><p>è¦å°† Facts å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œä½ éœ€è¦é€‰æ‹©ä¸€ä¸ªç›®å½•æ¥ä¿å­˜ç¼“å­˜æ•°æ®ã€‚åœ¨ Ansible é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®è¡Œï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[defaults]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>gathering</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>smart</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fact_caching</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>jsonfile</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fact_caching_connection</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/path/to/cache_directory</span>
</span></span></code></pre></div><p>å°† <code>/path/to/cache_directory</code> æ›¿æ¢ä¸ºä½ æƒ³è¦å­˜å‚¨ Facts ç¼“å­˜æ•°æ®çš„å®é™…ç›®å½•è·¯å¾„ã€‚</p><p>å®Œæˆé…ç½®åï¼Œé‡æ–°è¿è¡Œ Ansible å‘½ä»¤ï¼Œå®ƒå°†ä½¿ç”¨ Facts ç¼“å­˜æ¥åŠ é€Ÿæ‰§è¡Œè¿‡ç¨‹ã€‚</p><p>è¯·æ³¨æ„ï¼Œä»¥ä¸Šé…ç½®ç¤ºä¾‹é€‚ç”¨äº Ansible ç‰ˆæœ¬è¾ƒæ–°çš„æƒ…å†µã€‚åœ¨ç‰¹å®šçš„ Ansible ç‰ˆæœ¬ä¸­ï¼Œé…ç½®é€‰é¡¹å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚åœ¨ä½¿ç”¨å‰ï¼Œè¯·ç¡®ä¿æŸ¥é˜…ä¸ä½ æ‰€ä½¿ç”¨çš„ Ansible ç‰ˆæœ¬ç›¸åŒ¹é…çš„å®˜æ–¹æ–‡æ¡£æˆ–æ‰‹å†Œã€‚</p></li></ul><h4 id=372-å‘½ä»¤è¡Œä¸­ç»™-playbook-ä¼ é€’å˜é‡>3.7.2 å‘½ä»¤è¡Œä¸­ç»™ playbook ä¼ é€’å˜é‡<a hidden class=anchor aria-hidden=true href=#372-å‘½ä»¤è¡Œä¸­ç»™-playbook-ä¼ é€’å˜é‡>#</a></h4><p>åœ¨ Ansible çš„ <code>ansible-playbook</code> å‘½ä»¤è¡Œä¸­ï¼Œå¯ä»¥ä½¿ç”¨ <code>-e</code> é€‰é¡¹æ¥ä¼ é€’é¢å¤–çš„å˜é‡ç»™ playbookã€‚è¿™å¯ä»¥è®©ä½ åœ¨è¿è¡Œ playbook æ—¶åŠ¨æ€åœ°æŒ‡å®šå˜é‡çš„å€¼ï¼Œè€Œä¸å¿…ä¿®æ”¹ playbook æ–‡ä»¶æœ¬èº«ã€‚ä»¥ä¸‹æ˜¯ä¼ é€’å˜é‡çš„å‡ ç§æ–¹å¼ï¼š</p><ol><li><p><strong>ä¼ é€’å•ä¸ªå˜é‡</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook -e <span style=color:#e6db74>&#34;variable_name=variable_value&#34;</span> playbook.yml
</span></span></code></pre></div></li><li><p><strong>ä¼ é€’å¤šä¸ªå˜é‡</strong>ï¼š</p><p>å¦‚æœä½ æƒ³ä¼ é€’å¤šä¸ªå˜é‡ï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ª <code>-e</code> é€‰é¡¹æˆ–è€…å°†å¤šä¸ªå˜é‡æ”¾åœ¨ä¸€ä¸ªå¼•å·ä¸­ï¼Œç”¨ç©ºæ ¼æˆ–é€—å·åˆ†éš”ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook -e <span style=color:#e6db74>&#34;variable1=value1 variable2=value2&#34;</span> playbook.yml
</span></span></code></pre></div><p>æˆ–è€…ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook -e <span style=color:#e6db74>&#34;variable1=value1&#34;</span> -e <span style=color:#e6db74>&#34;variable2=value2&#34;</span> playbook.yml
</span></span></code></pre></div></li><li><p><strong>ä¼ é€’ yaml å˜é‡æ–‡ä»¶</strong></p><p>å‡è®¾ä½ çš„ YAML æ–‡ä»¶ <code>vars.yml</code> å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e>#vars.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>my_variable</span>: <span style=color:#e6db74>&#34;Hello, Ansible!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>database_host</span>: <span style=color:#e6db74>&#34;db.example.com&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>database_port</span>: <span style=color:#ae81ff>3306</span>
</span></span></code></pre></div><p>é€šè¿‡ -e é€‰é¡¹ä¼ é€’æ­¤æ–‡ä»¶ä¸­çš„å˜é‡</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>ansible-playbook -e @vars.yaml playbook.yml</span>
</span></span></code></pre></div></li><li><p><strong>ä¼ é€’ JSON æ–‡ä»¶</strong>ï¼š</p><p>ä½ ä¹Ÿå¯ä»¥å°†å˜é‡ä¿å­˜åœ¨ä¸€ä¸ª JSON æ ¼å¼çš„æ–‡ä»¶ä¸­ï¼Œç„¶åä½¿ç”¨ <code>-e</code> é€‰é¡¹ä¼ é€’æ–‡ä»¶è·¯å¾„ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook -e @variables.json playbook.yml
</span></span></code></pre></div><p>å…¶ä¸­ï¼Œ<code>variables.json</code> æ˜¯ä¸€ä¸ªåŒ…å«å˜é‡çš„ JSON æ–‡ä»¶ã€‚</p></li></ol><p>æ— è®ºä½ é€‰æ‹©å“ªç§æ–¹å¼ï¼Œä¼ é€’çš„å˜é‡éƒ½å¯ä»¥åœ¨ playbook ä¸­ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>[<span style=color:#ae81ff>root@ansible playbooks]# cat playbook.yml </span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Playbook</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>remote</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>my_variable </span>
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>root@ansible playbooks]# ansible-playbook -e @vars.yaml playbook.yml </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>PLAY [Example Playbook] ********************************************************</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>TASK [debug] *******************************************************************</span>
</span></span><span style=display:flex><span><span style=color:#f92672>ok</span>: [<span style=color:#ae81ff>remote] =&gt; {</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;my_variable&#34;: </span><span style=color:#e6db74>&#34;Hello, Ansible!&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>PLAY RECAP *********************************************************************</span>
</span></span><span style=display:flex><span><span style=color:#f92672>remote                     </span>: <span style=color:#ae81ff>ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 </span>
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>my_variable</code> å˜é‡çš„å€¼å°†æ ¹æ®åœ¨å‘½ä»¤è¡Œä¸­ä¼ é€’çš„å€¼è¿›è¡Œè®¾å®šã€‚</p><h4 id=373-åœ¨-playbook-æ–‡ä»¶ä¸­å®šä¹‰å˜é‡>3.7.3 åœ¨ playbook æ–‡ä»¶ä¸­å®šä¹‰å˜é‡<a hidden class=anchor aria-hidden=true href=#373-åœ¨-playbook-æ–‡ä»¶ä¸­å®šä¹‰å˜é‡>#</a></h4><p><strong>åœ¨Playbookçº§åˆ«å®šä¹‰å˜é‡ï¼š</strong></p><p>åœ¨Playbookä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>vars</code>å…³é”®å­—æ¥å®šä¹‰å˜é‡ã€‚è¿™äº›å˜é‡å°†åœ¨æ•´ä¸ªPlaybookä¸­å¯ç”¨ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Playbook</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>my_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>variable_name</span>: <span style=color:#ae81ff>variable_value</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task using variable</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>variable_name</span>
</span></span></code></pre></div><p><strong>å˜é‡ä¹‹é—´ç›¸äº’å¼•ç”¨:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Playbook</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>localhost</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>remote_ip</span>: <span style=color:#e6db74>&#34;{{ ansible_default_ipv4.address }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task using variable</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>remote_ip</span>
</span></span></code></pre></div><h4 id=374-åœ¨å¤–éƒ¨å˜é‡æ–‡ä»¶ä¸­å®šä¹‰å˜é‡>3.7.4 åœ¨å¤–éƒ¨å˜é‡æ–‡ä»¶ä¸­å®šä¹‰å˜é‡ï¼š<a hidden class=anchor aria-hidden=true href=#374-åœ¨å¤–éƒ¨å˜é‡æ–‡ä»¶ä¸­å®šä¹‰å˜é‡>#</a></h4><blockquote><p><code>vars_files</code> ä¸­çš„æ–‡ä»¶è·¯å¾„æ˜¯ç›¸å¯¹äºå½“å‰å·¥ä½œç›®å½•çš„ã€‚å¦‚æœå˜é‡æ–‡ä»¶ä½äº Playbook æ–‡ä»¶çš„åŒä¸€ç›®å½•ä¸­ï¼Œä½ å¯ä»¥ç›´æ¥æä¾›æ–‡ä»¶åï¼Œå¦‚ <code>vars_files: vars.yml</code>ã€‚å¦‚æœåœ¨å…¶ä»–ç›®å½•ä¸­ï¼Œå°±éœ€è¦æä¾›å®Œæ•´çš„ç›¸å¯¹æˆ–ç»å¯¹è·¯å¾„ã€‚</p></blockquote><p>å°†å˜é‡å­˜å‚¨åœ¨å¤–éƒ¨æ–‡ä»¶ä¸­ï¼Œç„¶ååœ¨Playbookä¸­å¯¼å…¥è¿™äº›å˜é‡ã€‚è¿™åœ¨éœ€è¦å…±äº«å˜é‡çš„å¤šä¸ªPlaybookä¹‹é—´å¾ˆæœ‰ç”¨ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Playbook</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>my_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars_files</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>vars.yml</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task using variable</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>variable_name</span>
</span></span></code></pre></div><p>å¤–éƒ¨å˜é‡æ–‡ä»¶ <code>vars.yml</code> çš„å†…å®¹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>variable_name</span>: <span style=color:#ae81ff>variable_value</span>
</span></span></code></pre></div><h4 id=375-åœ¨ä¸»æœºæ¸…å•ä¸­å®šä¹‰å˜é‡>3.7.5 åœ¨ä¸»æœºæ¸…å•ä¸­å®šä¹‰å˜é‡<a hidden class=anchor aria-hidden=true href=#375-åœ¨ä¸»æœºæ¸…å•ä¸­å®šä¹‰å˜é‡>#</a></h4><p>åœ¨Ansibleä¸­ï¼Œä½ å¯ä»¥ä¸ºä¸»æœºå’Œä¸»æœºç»„å®šä¹‰å˜é‡ï¼Œä»¥ä¾¿åœ¨Playbooksä¸­ä½¿ç”¨è¿™äº›å˜é‡æ¥æ§åˆ¶ä»»åŠ¡çš„è¡Œä¸ºã€‚è¿™æœ‰åŠ©äºå®ç°æ›´çµæ´»çš„é…ç½®å’ŒåŠ¨æ€æ€§ã€‚ä¸‹é¢æ˜¯å…³äºå¦‚ä½•åœ¨Ansibleä¸­ä¸ºä¸»æœºå’Œä¸»æœºç»„å®šä¹‰å˜é‡çš„è¯¦ç»†ä¿¡æ¯ï¼š</p><ol><li><p><strong>ä¸»æœºå˜é‡ï¼š</strong></p><p>ä½ å¯ä»¥ä¸ºæ¯ä¸ªå…·ä½“çš„ä¸»æœºå®šä¹‰å˜é‡ï¼Œè¿™äº›å˜é‡åªé€‚ç”¨äºè¯¥ä¸»æœºã€‚åœ¨Ansibleçš„Inventoryæ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯INIæ ¼å¼æˆ–YAMLæ ¼å¼ï¼‰ä¸­ï¼Œä½ å¯ä»¥åƒè¿™æ ·ä¸ºä¸»æœºå®šä¹‰å˜é‡ï¼š</p><p><strong>INIæ ¼å¼ï¼š</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[my_hosts]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>host1 ansible_ssh_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.1.1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[my_hosts:vars]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>some_variable</span><span style=color:#f92672>=</span><span style=color:#e6db74>some_value</span>
</span></span></code></pre></div><p><strong>YAMLæ ¼å¼ï¼š</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>my_hosts</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>host1</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible_ssh_host</span>: <span style=color:#ae81ff>192.168.1.1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>some_variable</span>: <span style=color:#ae81ff>some_value</span>
</span></span></code></pre></div></li><li><p><strong>ä¸»æœºç»„å˜é‡ï¼š</strong></p><p>ä½ å¯ä»¥ä¸ºä¸»æœºç»„å®šä¹‰å˜é‡ï¼Œè¿™äº›å˜é‡å°†åº”ç”¨äºè¯¥ä¸»æœºç»„ä¸­çš„æ‰€æœ‰ä¸»æœºã€‚åŒæ ·ï¼Œåœ¨Inventoryæ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥ä¸ºä¸»æœºç»„å®šä¹‰å˜é‡ï¼š</p><p><strong>INIæ ¼å¼ï¼š</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[my_hosts]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>host1 ansible_ssh_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.1.1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>host2 ansible_ssh_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.1.2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[my_hosts:vars]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>some_variable</span><span style=color:#f92672>=</span><span style=color:#e6db74>some_value</span>
</span></span></code></pre></div><p><strong>YAMLæ ¼å¼ï¼š</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>my_hosts</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>host1</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible_ssh_host</span>: <span style=color:#ae81ff>192.168.1.1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>host2</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible_ssh_host</span>: <span style=color:#ae81ff>192.168.1.2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>some_variable</span>: <span style=color:#ae81ff>some_value</span>
</span></span></code></pre></div></li><li><p><strong>ä½¿ç”¨å˜é‡ï¼š</strong></p><p>åœ¨Playbookä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨å®šä¹‰çš„ä¸»æœºå˜é‡å’Œä¸»æœºç»„å˜é‡ã€‚ä¾‹å¦‚ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Example Playbook</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>my_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task using host variable</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>hostvars[inventory_hostname][&#39;some_variable&#39;]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task using host group variable</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>groupvars[&#39;my_hosts&#39;][&#39;some_variable&#39;]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>normal use</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>some_variable</span>
</span></span></code></pre></div></li></ol><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œ<code>hostvars[inventory_hostname]['some_variable']</code> ç”¨äºè®¿é—®ç‰¹å®šä¸»æœºçš„å˜é‡ï¼Œè€Œ <code>groupvars['my_hosts']['some_variable']</code> ç”¨äºè®¿é—®ä¸»æœºç»„çš„å˜é‡ã€‚</p><p>é€šè¿‡è¿™äº›æ–¹æ³•ï¼Œä½ å¯ä»¥åœ¨Ansibleä¸­ä¸ºä¸»æœºå’Œä¸»æœºç»„å®šä¹‰å˜é‡ï¼Œä»è€Œå®ç°æ›´åŠ åŠ¨æ€å’Œå¯é…ç½®çš„Playbooksã€‚</p><h4 id=376-host_vars-å’Œ-group_vars>3.7.6 host_vars å’Œ group_vars<a hidden class=anchor aria-hidden=true href=#376-host_vars-å’Œ-group_vars>#</a></h4><p>åœ¨ Ansible ä¸­ï¼Œ<code>host_vars</code> å’Œ <code>group_vars</code> æ˜¯ç”¨äºç®¡ç†ä¸»æœºå’Œä¸»æœºç»„å˜é‡çš„ç‰¹æ®Šç›®å½•ã€‚è¿™äº›ç›®å½•å…è®¸ä½ åœ¨ä¸åŒçš„çº§åˆ«ä¸ºä¸»æœºå’Œä¸»æœºç»„å®šä¹‰å˜é‡ï¼Œä»¥ä¾¿åœ¨ä½ çš„ Ansible ä»»åŠ¡ä¸­ä½¿ç”¨ã€‚è¿™æ ·ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦ä¸ºä¸åŒçš„ä¸»æœºæˆ–ä¸»æœºç»„é…ç½®ç‰¹å®šçš„å˜é‡å€¼ï¼Œè€Œä¸å¿…åœ¨æ¯ä¸ªä»»åŠ¡ä¸­éƒ½æ‰‹åŠ¨æŒ‡å®šè¿™äº›å€¼ã€‚</p><p>ä»¥ä¸‹æ˜¯å…³äº <code>host_vars</code> å’Œ <code>group_vars</code> çš„æ›´è¯¦ç»†ä»‹ç»å’Œä½¿ç”¨æ–¹æ³•ï¼š</p><p><strong>1. host_varsï¼š</strong>
<code>host_vars</code> ç›®å½•ç”¨äºä¸ºå•ä¸ªä¸»æœºå®šä¹‰å˜é‡ã€‚åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼Œä½ å¯ä»¥ä¸ºæ¯ä¸ªä¸»æœºåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ YAML æ–‡ä»¶ï¼Œæ–‡ä»¶åä¸ä¸»æœºçš„åç§°åŒ¹é…ã€‚è¿™äº›å˜é‡å°†ä»…åº”ç”¨äºç‰¹å®šçš„ä¸»æœºã€‚</p><p>ç›®å½•ç»“æ„ç¤ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>.
</span></span><span style=display:flex><span>â”œâ”€â”€ inventory.ini
</span></span><span style=display:flex><span>â”œâ”€â”€ host_vars
</span></span><span style=display:flex><span>â”‚   â”œâ”€â”€ server1.yml
</span></span><span style=display:flex><span>â”‚   â”œâ”€â”€ server2.yml
</span></span><span style=display:flex><span>â”‚   â””â”€â”€ ...
</span></span><span style=display:flex><span>â””â”€â”€ group_vars
</span></span><span style=display:flex><span>    â”œâ”€â”€ group1.yml
</span></span><span style=display:flex><span>    â”œâ”€â”€ group2.yml
</span></span><span style=display:flex><span>    â””â”€â”€ ...
</span></span></code></pre></div><p><strong>2. group_varsï¼š</strong>
<code>group_vars</code> ç›®å½•ç”¨äºä¸ºä¸»æœºç»„å®šä¹‰å˜é‡ã€‚ä¸»æœºç»„æ˜¯åœ¨ Ansible ä¸»æœºæ¸…å•æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯ <code>inventory.ini</code>ï¼‰ä¸­å®šä¹‰çš„ã€‚ä½ å¯ä»¥ä¸ºæ¯ä¸ªä¸»æœºç»„åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ YAML æ–‡ä»¶ï¼Œæ–‡ä»¶åä¸ä¸»æœºç»„çš„åç§°åŒ¹é…ã€‚è¿™äº›å˜é‡å°†åº”ç”¨äºä¸»æœºç»„ä¸­çš„æ‰€æœ‰ä¸»æœºã€‚</p><p><strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong></p><ol><li><p>åœ¨ä½ çš„ Ansible é¡¹ç›®ç›®å½•ä¸­åˆ›å»º <code>host_vars</code> å’Œ <code>group_vars</code> ç›®å½•ã€‚</p></li><li><p>åœ¨ <code>host_vars</code> ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ª YAML æ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶å¯¹åº”ä¸€ä¸ªä¸»æœºï¼Œå¹¶åœ¨å…¶ä¸­å®šä¹‰ä½ å¸Œæœ›åœ¨è¿™äº›ä¸»æœºä¸Šä½¿ç”¨çš„å˜é‡ã€‚</p></li><li><p>åœ¨ <code>group_vars</code> ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ª YAML æ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶å¯¹åº”ä¸€ä¸ªä¸»æœºç»„ï¼Œå¹¶åœ¨å…¶ä¸­å®šä¹‰ä½ å¸Œæœ›åœ¨è¿™äº›ä¸»æœºç»„ä¸Šä½¿ç”¨çš„å˜é‡ã€‚</p></li><li><p>åœ¨ Ansible ä¸»æœºæ¸…å•æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯ <code>inventory.ini</code>ï¼‰ä¸­ï¼Œå°†ä¸»æœºåˆ†é…ç»™ç›¸åº”çš„ä¸»æœºç»„ã€‚</p></li><li><p>åœ¨ä½ çš„ Ansible ä»»åŠ¡ä¸­ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›å˜é‡ï¼ŒAnsible ä¼šè‡ªåŠ¨åŠ è½½å®ƒä»¬ã€‚</p></li></ol><p>ç¤ºä¾‹ï¼š</p><p>å‡è®¾ä½ æœ‰ä¸¤å°ä¸»æœºï¼š<code>webserver1</code> å’Œ <code>webserver2</code>ï¼Œä½ è¿˜æœ‰ä¸€ä¸ªä¸»æœºç»„ï¼š<code>webservers</code>ã€‚ä½ æƒ³è¦ä¸ºæ¯ä¸ªä¸»æœºå’Œä¸»æœºç»„å®šä¹‰ä¸€äº›å˜é‡ã€‚</p><p><strong>host_vars/webserver1.yml:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># host_vars/webserver1.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>app_port</span>: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span><span style=color:#f92672>app_env</span>: <span style=color:#ae81ff>production</span>
</span></span></code></pre></div><p><strong>host_vars/webserver2.yml:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># host_vars/webserver2.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>app_port</span>: <span style=color:#ae81ff>8000</span>
</span></span><span style=display:flex><span><span style=color:#f92672>app_env</span>: <span style=color:#ae81ff>staging</span>
</span></span></code></pre></div><p><strong>group_vars/webservers.yml:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># group_vars/webservers.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>app_user</span>: <span style=color:#ae81ff>webuser</span>
</span></span><span style=display:flex><span><span style=color:#f92672>app_path</span>: <span style=color:#ae81ff>/var/www/app</span>
</span></span></code></pre></div><p><strong>inventory.ini:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>[<span style=color:#ae81ff>webservers]</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>webserver1</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>webserver2</span>
</span></span></code></pre></div><p><strong>playbook.yml:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Configure web servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>webservers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Display app settings</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;App running on port {{ app_port }} with environment {{ app_env }}. User: {{ app_user }} Path: {{ app_path }}&#34;</span>
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>webserver1</code> å’Œ <code>webserver2</code> åˆ†åˆ«æœ‰å„è‡ªçš„å˜é‡ï¼Œè€Œ <code>webservers</code> ä¸»æœºç»„å…±äº«äº†ç›¸åŒçš„å˜é‡ã€‚åœ¨ä»»åŠ¡ä¸­ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›å˜é‡ï¼ŒAnsible ä¼šå°†å®ƒä»¬ä¸ç›¸åº”çš„ä¸»æœºæˆ–ä¸»æœºç»„å…³è”èµ·æ¥ã€‚</p><p>ä½¿ç”¨ <code>host_vars</code> å’Œ <code>group_vars</code> å¯ä»¥ä½¿ä½ çš„ Ansible é¡¹ç›®æ›´æœ‰ç»“æ„ï¼Œæ›´æ˜“äºç»´æŠ¤ï¼Œå› ä¸ºä½ å¯ä»¥å°†å˜é‡ä¸ä¸»æœºå’Œä¸»æœºç»„å…³è”èµ·æ¥ï¼Œè€Œä¸å¿…åœ¨æ¯ä¸ªä»»åŠ¡ä¸­éƒ½é‡å¤å®šä¹‰ã€‚</p><h4 id=377-register>3.7.7 register<a hidden class=anchor aria-hidden=true href=#377-register>#</a></h4><p>åœ¨ Ansible ä¸­ï¼Œ<code>register</code> æ˜¯ä¸€ä¸ªç”¨äºæ•è·ä»»åŠ¡æ‰§è¡Œç»“æœçš„å…³é”®å­—ã€‚é€šè¿‡ä½¿ç”¨ <code>register</code>ï¼Œä½ å¯ä»¥å°†ä»»åŠ¡çš„è¾“å‡ºã€è¿”å›å€¼æˆ–å…¶ä»–ä¿¡æ¯ä¿å­˜åˆ°ä¸€ä¸ªå˜é‡ä¸­ï¼Œä»¥ä¾¿åç»­ä»»åŠ¡å¯ä»¥ä½¿ç”¨è¿™äº›ä¿¡æ¯ã€‚è¿™åœ¨å¤„ç†ä»»åŠ¡çš„è¾“å‡ºã€é”™è¯¯å¤„ç†å’Œæ¡ä»¶æ‰§è¡Œæ–¹é¢éå¸¸æœ‰ç”¨ã€‚</p><p><strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong></p><p>åœ¨ Ansible playbook çš„ä»»åŠ¡ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>register</code> æ¥æ•è·ä»»åŠ¡çš„è¾“å‡ºã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªåŸºæœ¬çš„ç”¨æ³•ç¤ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Execute a command</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>myhosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run a command and capture the output</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>command</span>: <span style=color:#ae81ff>echo &#34;Hello, Ansible!&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>register</span>: <span style=color:#ae81ff>command_output</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Display the captured output</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>var</span>: <span style=color:#ae81ff>command_output.stdout</span>
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>register: command_output</code> å°†æ•è· <code>echo</code> å‘½ä»¤çš„è¾“å‡ºï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨ <code>command_output</code> å˜é‡ä¸­ã€‚æ¥ä¸‹æ¥çš„ä»»åŠ¡ä½¿ç”¨ <code>debug</code> æ¨¡å—æ¥æ˜¾ç¤ºè¿™ä¸ªå˜é‡çš„å€¼ã€‚</p><p><code>register</code> å˜é‡å¯¹è±¡ä¸­åŒ…å«å¤šä¸ªå±æ€§ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦ä½¿ç”¨å®ƒä»¬ã€‚ä¸€äº›å¸¸ç”¨çš„å±æ€§åŒ…æ‹¬ï¼š</p><ul><li><code>stdout</code>ï¼šæ•è·ä»»åŠ¡çš„æ ‡å‡†è¾“å‡ºå†…å®¹ã€‚</li><li><code>stderr</code>ï¼šæ•è·ä»»åŠ¡çš„æ ‡å‡†é”™è¯¯è¾“å‡ºå†…å®¹ã€‚</li><li><code>rc</code>ï¼šæ•è·ä»»åŠ¡çš„è¿”å›ä»£ç ï¼ˆé€€å‡ºçŠ¶æ€ç ï¼‰ã€‚</li><li><code>changed</code>ï¼šæŒ‡ç¤ºä»»åŠ¡æ˜¯å¦å¯¼è‡´äº†å˜åŒ–ï¼ˆTrue æˆ– Falseï¼‰ã€‚</li></ul><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ›´å¤æ‚çš„ç¤ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•æ ¹æ® <code>register</code> å˜é‡çš„å€¼æ¥æ‰§è¡Œä¸åŒçš„ä»»åŠ¡ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Check if a file exists</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>myhosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Check file existence</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>stat</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/path/to/file.txt</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>register</span>: <span style=color:#ae81ff>file_status</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Display file status</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;File exists: {{ file_status.stat.exists }}&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>when</span>: <span style=color:#ae81ff>file_status.stat.exists</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Create the file if it doesn&#39;t exist</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/path/to/file.txt</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>touch</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>when</span>: <span style=color:#ae81ff>not file_status.stat.exists</span>
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œé¦–å…ˆä½¿ç”¨ <code>stat</code> æ¨¡å—æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¹¶å°†ç»“æœä¿å­˜åœ¨ <code>file_status</code> å˜é‡ä¸­ã€‚æ¥ä¸‹æ¥çš„ä¸¤ä¸ªä»»åŠ¡æ ¹æ® <code>file_status</code> çš„å€¼æ¥æ‰§è¡Œä¸åŒçš„æ“ä½œï¼šå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œåˆ™æ˜¾ç¤ºä¸€æ¡æ¶ˆæ¯ï¼›å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–‡ä»¶ã€‚</p><p>æ€»ä¹‹ï¼Œ<code>register</code> æ˜¯ Ansible ä¸­éå¸¸æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå¯ä»¥æ•è·ä»»åŠ¡çš„è¾“å‡ºå’ŒçŠ¶æ€ï¼Œå¹¶åœ¨ playbook ä¸­è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ã€åˆ¤æ–­å’Œæ§åˆ¶æµç¨‹ã€‚</p><h3 id=38-jinja2-æ¨¡æ¿çš„ä»‹ç»å’Œä½¿ç”¨>3.8 Jinja2 æ¨¡æ¿çš„ä»‹ç»å’Œä½¿ç”¨<a hidden class=anchor aria-hidden=true href=#38-jinja2-æ¨¡æ¿çš„ä»‹ç»å’Œä½¿ç”¨>#</a></h3><p>Jinja2 æ˜¯ä¸€ç§æ¨¡æ¿å¼•æ“ï¼Œå¹¿æ³›ç”¨äºå°†åŠ¨æ€å†…å®¹åµŒå…¥é™æ€æ–‡æœ¬ä¸­ï¼Œä¾‹å¦‚åœ¨é…ç½®æ–‡ä»¶ã€æŠ¥å‘Šç”Ÿæˆå’Œæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆç­‰é¢†åŸŸã€‚åœ¨ Ansible ä¸­ï¼ŒJinja2 ç”¨äºå¤„ç†å˜é‡ã€æ¡ä»¶è¯­å¥å’Œå¾ªç¯ï¼Œä»¥ç”ŸæˆåŠ¨æ€çš„é…ç½®æ–‡ä»¶å’Œä»»åŠ¡ã€‚</p><p><strong>åŸºæœ¬æ¦‚å¿µï¼š</strong></p><p>Jinja2 æ¨¡æ¿å¼•æ“åŸºäº Pythonï¼Œå®ƒå…è®¸ä½ åœ¨æ–‡æœ¬ä¸­æ’å…¥åŠ¨æ€å€¼ã€æ‰§è¡Œæ¡ä»¶åˆ¤æ–­å’Œå¾ªç¯æ“ä½œã€‚æ¨¡æ¿ä½¿ç”¨åŒå¤§æ‹¬å· <code>{{ }}</code> æ¥è¡¨ç¤ºå˜é‡ï¼Œ<code>{% %}</code> æ¥è¡¨ç¤ºæ§åˆ¶è¯­å¥ï¼Œå¦‚æ¡ä»¶å’Œå¾ªç¯ã€‚</p><p><strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong></p><p>ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ Jinja2 æ¨¡æ¿ç”¨æ³•ç¤ºä¾‹ï¼š</p><p><strong>1. æ’å…¥å˜é‡ï¼š</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Hello, {{ name }}!
</span></span></code></pre></div><p>è¿™å°†ä¼šå°† <code>name</code> å˜é‡çš„å€¼æ’å…¥åˆ°æ–‡æœ¬ä¸­ã€‚</p><p><strong>2. ä½¿ç”¨æ¡ä»¶è¯­å¥ï¼š</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>{% if age &gt; 18 %}
</span></span><span style=display:flex><span>You are an adult.
</span></span><span style=display:flex><span>{% else %}
</span></span><span style=display:flex><span>You are not yet an adult.
</span></span><span style=display:flex><span>{% endif %}
</span></span></code></pre></div><p>æ ¹æ®æ¡ä»¶åˆ¤æ–­æ¥æ˜¾ç¤ºä¸åŒçš„æ–‡æœ¬ã€‚</p><p><strong>3. å¾ªç¯ï¼š</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>{% for item in items %}
</span></span><span style=display:flex><span>- {{ item }}
</span></span><span style=display:flex><span>{% endfor %}
</span></span></code></pre></div><p>åœ¨å¾ªç¯ä¸­éå†åˆ—è¡¨ <code>items</code> å¹¶ä¸ºæ¯ä¸ªé¡¹ç›®ç”Ÿæˆæ–‡æœ¬ã€‚</p><p><strong>4. è¿‡æ»¤å™¨ï¼š</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>{{ text | upper }}
</span></span></code></pre></div><p>ä½¿ç”¨è¿‡æ»¤å™¨å°†æ–‡æœ¬è½¬æ¢ä¸ºå¤§å†™ã€‚</p><p><strong>åœ¨ Ansible ä¸­çš„åº”ç”¨ï¼š</strong></p><p>åœ¨ Ansible Playbooks å’Œæ¨¡æ¿ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ Jinja2 æ¥åŠ¨æ€ç”Ÿæˆé…ç½®æ–‡ä»¶ã€ä»»åŠ¡å’Œå˜é‡ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥åœ¨é…ç½®æ–‡ä»¶æ¨¡æ¿ä¸­æ’å…¥ä¸»æœºå’Œå˜é‡ä¿¡æ¯ï¼Œç„¶åä½¿ç”¨ Ansible å°†æ¨¡æ¿æ¸²æŸ“ä¸ºå®é™…çš„é…ç½®æ–‡ä»¶ã€‚</p><p><strong>ç¤ºä¾‹ï¼š</strong></p><p>å‡è®¾ä½ æœ‰ä¸€ä¸ª <code>web_servers</code> ä¸»æœºç»„ï¼Œå¹¶ä¸”ä½ æƒ³ä¸ºæ¯å°ä¸»æœºç”Ÿæˆä¸€ä¸ª Nginx é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«ä¸»æœºçš„ IP å’Œç«¯å£ä¿¡æ¯ã€‚</p><p><strong>nginx.conf.j2 æ¨¡æ¿æ–‡ä»¶ï¼š</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>server {
</span></span><span style=display:flex><span>    listen {{ nginx_port }};
</span></span><span style=display:flex><span>    server_name {{ ansible_host }};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    location / {
</span></span><span style=display:flex><span>        proxy_pass http://{{ ansible_host }}:{{ app_port }};
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>playbook.yml æ–‡ä»¶ï¼š</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Generate Nginx configs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>web_servers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Render Nginx config</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>src</span>: <span style=color:#ae81ff>nginx.conf.j2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>dest</span>: <span style=color:#ae81ff>/etc/nginx/sites-available/{{ ansible_host }}</span>
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>nginx.conf.j2</code> æ˜¯ä¸€ä¸ª Jinja2 æ¨¡æ¿æ–‡ä»¶ï¼Œä½¿ç”¨äº†å˜é‡å’Œæ§åˆ¶è¯­å¥æ¥åŠ¨æ€ç”Ÿæˆ Nginx é…ç½®æ–‡ä»¶ã€‚<code>template</code> æ¨¡å—ä¼šå°†æ¨¡æ¿æ¸²æŸ“ä¸ºå®é™…çš„é…ç½®æ–‡ä»¶ï¼Œæ”¾ç½®åœ¨ <code>/etc/nginx/sites-available</code> ç›®å½•ä¸‹ï¼Œæ–‡ä»¶åä¸ä¸»æœºåç›¸åŒã€‚</p><p><strong>æ€»ç»“ï¼š</strong></p><p>Jinja2 æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ¨¡æ¿å¼•æ“ï¼Œå¯ä»¥åœ¨ Ansible ä¸­ç”¨äºç”ŸæˆåŠ¨æ€å†…å®¹ï¼Œä»è€Œæé«˜é…ç½®ç®¡ç†å’Œè‡ªåŠ¨åŒ–éƒ¨ç½²çš„çµæ´»æ€§å’Œæ•ˆç‡ã€‚é€šè¿‡ä½¿ç”¨ Jinja2ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦å°†å˜é‡ã€æ¡ä»¶å’Œå¾ªç¯åµŒå…¥åˆ°æ–‡æœ¬ä¸­ï¼Œç”Ÿæˆç¬¦åˆè¦æ±‚çš„é…ç½®å’Œä»»åŠ¡ã€‚</p><h3 id=39-å¾ªç¯å’Œè¿­ä»£>3.9 å¾ªç¯å’Œè¿­ä»£<a hidden class=anchor aria-hidden=true href=#39-å¾ªç¯å’Œè¿­ä»£>#</a></h3><h4 id=378-loop>3.7.8 loop<a hidden class=anchor aria-hidden=true href=#378-loop>#</a></h4><p>åœ¨ Ansible ä¸­ï¼Œè¿­ä»£å’Œå¾ªç¯æ˜¯éå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå®ƒä»¬å…è®¸ä½ å¯¹ä¸€ç»„ä¸»æœºæˆ–ä¸€ç»„æ•°æ®æ‰§è¡Œç›¸åŒçš„æ“ä½œã€‚Ansible æä¾›äº†å¤šç§æ–¹æ³•æ¥å®ç°è¿­ä»£å’Œå¾ªç¯ï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„æ–¹æ³•æ˜¯ä½¿ç”¨ <code>loop</code> å…³é”®å­—æˆ– <code>with_*</code> å…³é”®å­—ç³»åˆ—ã€‚</p><p>ä»¥ä¸‹æ˜¯ Ansible ä¸­å®ç°è¿­ä»£å’Œå¾ªç¯çš„ä¸€äº›æ–¹æ³•ï¼š</p><ol><li><p>ä½¿ç”¨ <code>loop</code> å…³é”®å­—ï¼š
<code>loop</code> å…³é”®å­—å…è®¸ä½ åœ¨ä»»åŠ¡çº§åˆ«å¾ªç¯æ‰§è¡Œä»»åŠ¡ã€‚ä½ å¯ä»¥å°†å…¶ä¸ <code>items</code> å‚æ•°ç»“åˆä½¿ç”¨ï¼Œä¼ é€’ä¸€ä¸ªåˆ—è¡¨æˆ–å­—å…¸ï¼Œç„¶ååœ¨æ¯æ¬¡è¿­ä»£ä¸­è®¿é—®è¯¥åˆ—è¡¨æˆ–å­—å…¸çš„å…ƒç´ ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Loop example</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Item: {{ item }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>loop</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>item1</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>item2</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>item3</span>
</span></span></code></pre></div></li><li><p>ä½¿ç”¨ <code>with_items</code>ï¼š
åœ¨æ—§ç‰ˆæœ¬çš„ Ansible ä¸­ï¼Œä½ å¯èƒ½ä¼šçœ‹åˆ° <code>with_items</code> å…³é”®å­—ï¼Œå®ƒåœ¨è¾ƒæ–°ç‰ˆæœ¬ä¸­å·²è¢« <code>loop</code> æ›¿ä»£ï¼ˆansible 2.5+ï¼‰ï¼Œä½†åœ¨ä¸€äº›æ—§ä»£ç ä¸­ä»ç„¶å¯èƒ½ä¼šä½¿ç”¨ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Loop example (with_items)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Item: {{ item }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with_items</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>item1</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>item2</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>item3</span>
</span></span></code></pre></div></li><li><p>ä½¿ç”¨å…¶ä»– <code>with_*</code> å…³é”®å­—ï¼š
Ansible æä¾›äº†å¤šä¸ª <code>with_*</code> å…³é”®å­—ï¼Œä¾‹å¦‚ <code>with_dict</code>ã€<code>with_fileglob</code>ã€<code>with_sequence</code> ç­‰ï¼Œç”¨äºåœ¨ä¸åŒæƒ…å†µä¸‹è¿›è¡Œå¾ªç¯æ“ä½œã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Looping with a dictionary</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Key: {{ item.key }}, Value: {{ item.value }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with_dict</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>key1</span>: <span style=color:#ae81ff>value1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>key2</span>: <span style=color:#ae81ff>value2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>key3</span>: <span style=color:#ae81ff>value3</span>
</span></span></code></pre></div></li></ol><p>è¿™äº›ç¤ºä¾‹åªæ˜¯ä»‹ç»äº† Ansible ä¸­è¿­ä»£å’Œå¾ªç¯çš„åŸºæœ¬æ¦‚å¿µã€‚ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦ï¼Œç»“åˆ Ansible çš„æ¨¡å—å’ŒåŠŸèƒ½ï¼Œæ›´å¤æ‚åœ°å®ç°è¿­ä»£å’Œå¾ªç¯æ“ä½œã€‚æ— è®ºä½ æ˜¯åœ¨å¤„ç†ä¸»æœºè¿˜æ˜¯æ•°æ®é›†ï¼Œè¿­ä»£å’Œå¾ªç¯éƒ½èƒ½å¸®åŠ©ä½ æ›´é«˜æ•ˆåœ°ç®¡ç†å’Œé…ç½®ç³»ç»Ÿã€‚</p><h4 id=379-until>3.7.9 until<a hidden class=anchor aria-hidden=true href=#379-until>#</a></h4><p>åœ¨Ansibleä¸­ï¼Œ&ldquo;until&rdquo; æ˜¯ä¸€ä¸ªç”¨äºæ§åˆ¶å¾ªç¯æ‰§è¡Œä»»åŠ¡çš„å…³é”®å­—ã€‚å®ƒé€šå¸¸ä¸ &ldquo;register&rdquo;ï¼ˆç”¨äºå­˜å‚¨ä»»åŠ¡æ‰§è¡Œç»“æœï¼‰å’Œä¸€äº›æ¡ä»¶ä¸€èµ·ä½¿ç”¨ï¼Œä»¥ä¾¿åœ¨æ»¡è¶³ç‰¹å®šæ¡ä»¶ä¹‹å‰é‡å¤æ‰§è¡ŒæŸä¸ªä»»åŠ¡ã€‚&ldquo;until&rdquo; çš„ä¸»è¦ä½œç”¨æ˜¯å…è®¸ä»»åŠ¡åœ¨è¾¾åˆ°é¢„æœŸçŠ¶æ€ä¹‹å‰é‡è¯•ï¼Œç›´åˆ°æ»¡è¶³ç‰¹å®šæ¡ä»¶ä¸ºæ­¢ã€‚</p><p>ä»¥ä¸‹æ˜¯ &ldquo;until&rdquo; å…³é”®å­—çš„åŸºæœ¬è¯­æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Retry a task until a condition is met</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>some_module</span>:           <span style=color:#75715e># Replace with the actual module you&#39;re using</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>register</span>: <span style=color:#ae81ff>result      </span> <span style=color:#75715e># Store the task execution result in the &#39;result&#39; variable</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>until</span>: <span style=color:#ae81ff>result is success  </span> <span style=color:#75715e># The condition to check, can be customized based on the task result</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>retries</span>: <span style=color:#ae81ff>10</span>                <span style=color:#75715e># Number of times to retry the task</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>delay</span>: <span style=color:#ae81ff>10</span>                  <span style=color:#75715e># Time (in seconds) to wait between retries</span>
</span></span></code></pre></div><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œ&ldquo;some_module&rdquo; æ˜¯è¦æ‰§è¡Œçš„ä»»åŠ¡æ¨¡å—ï¼Œ&ldquo;result&rdquo; æ˜¯ç”¨äºå­˜å‚¨ä»»åŠ¡æ‰§è¡Œç»“æœçš„å˜é‡ã€‚é€šè¿‡ &ldquo;until&rdquo; å…³é”®å­—ï¼Œä½ å¯ä»¥æŒ‡å®šä¸€ä¸ªæ¡ä»¶æ¥æ£€æŸ¥ä»»åŠ¡æ‰§è¡Œç»“æœæ˜¯å¦æ»¡è¶³é¢„æœŸã€‚å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œä»»åŠ¡å°†åœ¨ &ldquo;retries&rdquo; æ¬¡æ•°å†…é‡å¤æ‰§è¡Œï¼Œæ¯æ¬¡é‡è¯•ä¹‹é—´ä¼šç­‰å¾… &ldquo;delay&rdquo; ç§’ã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªæ›´å…·ä½“çš„ç¤ºä¾‹ï¼Œå‡è®¾ä½ è¦ç­‰å¾…æŸä¸ªæœåŠ¡å¯åŠ¨æˆåŠŸåæ‰ç»§ç»­æ‰§è¡Œåç»­ä»»åŠ¡ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Start the service</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>systemd</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-service</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>state</span>: <span style=color:#ae81ff>started</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>register</span>: <span style=color:#ae81ff>service_result</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Wait for the service to be up</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>wait_for</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>host</span>: <span style=color:#ae81ff>localhost</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>until</span>: <span style=color:#ae81ff>service_result is success</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>retries</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>delay</span>: <span style=color:#ae81ff>5</span>
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œé¦–å…ˆä½¿ç”¨ &ldquo;systemd&rdquo; æ¨¡å—å¯åŠ¨äº†ä¸€ä¸ªåä¸º &ldquo;my-service&rdquo; çš„æœåŠ¡ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ &ldquo;service_result&rdquo; å˜é‡ä¸­ã€‚æ¥ä¸‹æ¥ï¼Œä½¿ç”¨ &ldquo;wait_for&rdquo; æ¨¡å—ç­‰å¾… localhost çš„ 8080 ç«¯å£å¼€æ”¾ï¼Œç›´åˆ° &ldquo;service_result&rdquo; å˜é‡çš„å€¼å˜ä¸º &ldquo;success&rdquo;ï¼Œæˆ–è€…è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ä¸ºæ­¢ã€‚</p><p>è¯·æ³¨æ„ï¼Œ&ldquo;until&rdquo; å¹¶ä¸æ˜¯æ‰€æœ‰Ansibleæ¨¡å—éƒ½æ”¯æŒçš„å‚æ•°ï¼Œåªæœ‰éƒ¨åˆ†æ¨¡å—ï¼ˆå¦‚ &ldquo;wait_for&rdquo;ã€&ldquo;command&rdquo; ç­‰ï¼‰å…è®¸åœ¨ä»»åŠ¡çº§åˆ«ä½¿ç”¨ &ldquo;until&rdquo; æ¥æ‰§è¡Œæ¡ä»¶åˆ¤æ–­å’Œå¾ªç¯æ“ä½œã€‚</p><h4 id=3710-with_lines>3.7.10 with_lines<a hidden class=anchor aria-hidden=true href=#3710-with_lines>#</a></h4><p>åœ¨ Ansible ä¸­ï¼Œ<code>with_lines</code> æ˜¯ä¸€ä¸ªç”¨äºåœ¨ä»»åŠ¡ä¸­éå†æ–‡æœ¬è¡Œçš„å¾ªç¯æ„é€ ã€‚å®ƒå…è®¸ä½ å°†æ¯ä¸€è¡Œä½œä¸ºä¸€ä¸ªè¿­ä»£é¡¹ï¼Œä»¥ä¾¿åœ¨æ¯æ¬¡è¿­ä»£ä¸­æ‰§è¡Œä»»åŠ¡ã€‚</p><p>ä»¥ä¸‹æ˜¯ <code>with_lines</code> çš„åŸºæœ¬è¯­æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Perform tasks with each line of a file</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>some_module</span>:    <span style=color:#75715e># Replace with the actual module you&#39;re using</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with_lines</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>/path/to/file.txt  </span> <span style=color:#75715e># Path to the file containing lines to iterate over</span>
</span></span></code></pre></div><p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œ<code>some_module</code> æ˜¯è¦æ‰§è¡Œçš„ä»»åŠ¡æ¨¡å—ï¼Œ<code>/path/to/file.txt</code> æ˜¯åŒ…å«è¦è¿­ä»£çš„æ–‡æœ¬è¡Œçš„æ–‡ä»¶çš„è·¯å¾„ã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªæ›´å…·ä½“çš„ç¤ºä¾‹ï¼Œå‡è®¾ä½ æœ‰ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«ä¸€äº›IPåœ°å€ï¼Œä½ æƒ³ä½¿ç”¨ <code>ping</code> å‘½ä»¤å¯¹æ¯ä¸ªIPåœ°å€æ‰§è¡Œç½‘ç»œè¿æ¥æµ‹è¯•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ping each IP address from a file</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ping</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>with_lines</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>/path/to/ip_addresses.txt</span>
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>ping</code> æ¨¡å—å°†ä¼šå¯¹æ–‡ä»¶ <code>/path/to/ip_addresses.txt</code> ä¸­çš„æ¯ä¸ªIPåœ°å€æ‰§è¡Œç½‘ç»œè¿æ¥æµ‹è¯•ã€‚Ansibleä¼šå°†æ–‡ä»¶çš„æ¯ä¸€è¡Œä½œä¸ºä¸€ä¸ªè¿­ä»£é¡¹ä¼ é€’ç»™ <code>ping</code> æ¨¡å—ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>with_lines</code> åœ¨å¤„ç†å¤§å‹æ–‡ä»¶æ—¶å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºå®ƒéœ€è¦ä¸€æ¬¡æ€§è¯»å–æ•´ä¸ªæ–‡ä»¶å¹¶å°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚å¦‚æœæ–‡ä»¶è¾ƒå¤§ï¼Œä½ å¯èƒ½éœ€è¦è€ƒè™‘ä½¿ç”¨æ›´é€‚åˆçš„æ–¹æ³•ï¼Œä¾‹å¦‚å°†æ–‡ä»¶å†…å®¹å­˜å‚¨åœ¨å˜é‡ä¸­ï¼Œç„¶åä½¿ç”¨å¾ªç¯ç»“æ„éå†å˜é‡ã€‚</p><p>å¦å¤–ï¼Œä» Ansible 2.5 ç‰ˆæœ¬å¼€å§‹ï¼Œ<code>with_lines</code> å·²è¢«å¼ƒç”¨ï¼Œå»ºè®®ä½¿ç”¨ <code>loop</code> æ„é€ ä»£æ›¿ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ <code>loop</code> æ¥å®Œæˆä¸Šè¿°ç¤ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ping each IP address from a file</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ping</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>loop</span>: <span style=color:#e6db74>&#34;{{ lookup(&#39;file&#39;, &#39;/path/to/ip_addresses.txt&#39;).splitlines() }}&#34;</span>
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>lookup('file', '/path/to/ip_addresses.txt').splitlines()</code> å°†ä¼šè¯»å–æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œå¹¶ä½¿ç”¨æ¢è¡Œç¬¦å°†å…¶æ‹†åˆ†ä¸ºè¡Œçš„åˆ—è¡¨ï¼Œç„¶åä½¿ç”¨ <code>loop</code> å¯¹æ¯ä¸ªIPåœ°å€æ‰§è¡Œ <code>ping</code> æ¨¡å—ã€‚è¿™ç§æ–¹æ³•æ›´ä¸ºçµæ´»ä¸”ä¸ä¼šä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ªæ–‡ä»¶ã€‚</p><h3 id=310-æ¡ä»¶åˆ¤æ–­-when>3.10 æ¡ä»¶åˆ¤æ–­ when<a hidden class=anchor aria-hidden=true href=#310-æ¡ä»¶åˆ¤æ–­-when>#</a></h3><p>åœ¨ Ansible ä¸­ï¼Œ<code>when</code> æ˜¯ä¸€ä¸ªæ¡ä»¶è¯­å¥ï¼Œå®ƒå…è®¸ä½ åœ¨ä»»åŠ¡æ‰§è¡Œä¹‹å‰æŒ‡å®šä¸€ä¸ªæ¡ä»¶ï¼Œåªæœ‰å½“æ¡ä»¶æ»¡è¶³æ—¶ï¼Œä»»åŠ¡æ‰ä¼šè¢«æ‰§è¡Œã€‚è¿™å¯ä»¥ç”¨äºæ ¹æ®ä¸åŒçš„æƒ…å†µæ¥å†³å®šæ˜¯å¦è·³è¿‡æˆ–æ‰§è¡ŒæŸä¸ªä»»åŠ¡ã€‚</p><p>ä»¥ä¸‹æ˜¯ <code>when</code> çš„åŸºæœ¬è¯­æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Perform a task conditionally</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>some_module</span>:     <span style=color:#75715e># Replace with the actual module you&#39;re using</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>condition </span> <span style=color:#75715e># The condition to check before executing the task</span>
</span></span></code></pre></div><p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œ<code>some_module</code> æ˜¯è¦æ‰§è¡Œçš„ä»»åŠ¡æ¨¡å—ï¼Œ<code>condition</code> æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œåªæœ‰åœ¨è¡¨è¾¾å¼è¯„ä¼°ä¸º <code>true</code> æ—¶ï¼Œä»»åŠ¡æ‰ä¼šè¢«æ‰§è¡Œã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªæ›´å…·ä½“çš„ç¤ºä¾‹ï¼Œå‡è®¾ä½ åªæƒ³åœ¨æ“ä½œç³»ç»Ÿæ˜¯ Ubuntu æ—¶æ‰æ‰§è¡Œç‰¹å®šçš„ä»»åŠ¡ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install a package only on Ubuntu</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>apt</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>some-package</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>ansible_distribution == &#39;Ubuntu&#39;</span>
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>apt</code> æ¨¡å—ç”¨äºå®‰è£…è½¯ä»¶åŒ…ï¼Œä½†æ˜¯åªæœ‰å½“ Ansible å˜é‡ <code>ansible_distribution</code> çš„å€¼ä¸º &lsquo;Ubuntu&rsquo; æ—¶ï¼Œä»»åŠ¡æ‰ä¼šè¢«æ‰§è¡Œã€‚</p><p><code>when</code> è¡¨è¾¾å¼å¯ä»¥æ˜¯ Ansible å˜é‡ã€äº‹å®ï¼ˆfactsï¼‰ã€æ¯”è¾ƒæ“ä½œã€é€»è¾‘è¿ç®—ç­‰ã€‚ä½ å¯ä»¥æ ¹æ®éœ€è¦æ¥åˆ›å»ºå¤æ‚çš„æ¡ä»¶æ¥å†³å®šä»»åŠ¡æ˜¯å¦åº”è¯¥è¢«æ‰§è¡Œã€‚ä¾‹å¦‚ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Perform a task only if a certain variable is true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>some_module</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>my_variable == true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Perform a task only if a file exists</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>some_module</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>ansible_facts[&#39;file_exists&#39;] == true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Perform a task only if multiple conditions are true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>some_module</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>ansible_os_family == &#39;Debian&#39; and ansible_distribution_version | version_compare(&#39;9&#39;, &#39;&gt;=&#39;)</span>
</span></span></code></pre></div><p>è¯·æ³¨æ„ï¼Œ<code>when</code> æ˜¯ä¸€ä¸ªåœ¨ä»»åŠ¡çº§åˆ«ä½¿ç”¨çš„å‚æ•°ï¼Œå®ƒé€‚ç”¨äºå•ä¸ªä»»åŠ¡ã€‚å¦‚æœä½ å¸Œæœ›åœ¨å‰§æœ¬ï¼ˆplaybookï¼‰çº§åˆ«ä¸Šè®¾ç½®æ¡ä»¶ï¼Œå¯ä»¥åœ¨æ¯ä¸ªä»»åŠ¡ä¸­ä½¿ç”¨ <code>block</code> ç»“æ„ï¼Œç„¶ååœ¨ <code>block</code> ç»“æ„ä¸Šä½¿ç”¨ <code>when</code> æ¡ä»¶ã€‚</p><h3 id=311-åˆ†ç»„-block>3.11 åˆ†ç»„ block<a hidden class=anchor aria-hidden=true href=#311-åˆ†ç»„-block>#</a></h3><p>åœ¨ Ansible ä¸­ï¼Œ<code>block</code> æ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºä»»åŠ¡å—çš„ç»“æ„ã€‚å®ƒå…è®¸ä½ å°†å¤šä¸ªç›¸å…³çš„ä»»åŠ¡ç»„ç»‡åœ¨ä¸€èµ·ï¼Œä»¥ä¾¿åœ¨å…¶ä¸­åº”ç”¨å…±åŒçš„æ¡ä»¶ã€å¤„ç†é”™è¯¯ä»¥åŠè®¾ç½®é€šç”¨çš„å‚æ•°ã€‚<code>block</code> å¯ä»¥ä¸ <code>rescue</code> å’Œ <code>always</code> é…åˆä½¿ç”¨ï¼Œä»¥æä¾›æ›´ä¸°å¯Œçš„ä»»åŠ¡æ§åˆ¶å’Œé”™è¯¯å¤„ç†èƒ½åŠ›ã€‚</p><p>ä»¥ä¸‹æ˜¯ <code>block</code> ç»“æ„çš„åŸºæœ¬è¯­æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>A playbook with a block</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>target_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>block</span>:         <span style=color:#75715e># Start of the block</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task 1</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>some_module</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task 2</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>some_module</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>rescue</span>:        <span style=color:#75715e># Optional, tasks to run if an error occurs within the block</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Rescue task</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>some_module</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>always</span>:        <span style=color:#75715e># Optional, tasks to run regardless of success or failure</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Always task</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>some_module</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># module arguments...</span>
</span></span></code></pre></div><p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œ<code>block</code> ç»“æ„å†…åŒ…å«ä¸¤ä¸ªä»»åŠ¡ï¼ˆTask 1 å’Œ Task 2ï¼‰ã€‚å¦‚æœ <code>block</code> ç»“æ„å†…çš„ä»»åŠ¡ä¸­çš„ä»»ä½•ä¸€ä¸ªå¤±è´¥ï¼Œé‚£ä¹ˆ <code>rescue</code> éƒ¨åˆ†çš„ä»»åŠ¡å°†ä¼šè¢«æ‰§è¡Œã€‚æ— è®º <code>block</code> ç»“æ„å†…çš„ä»»åŠ¡æˆåŠŸä¸å¦ï¼Œ<code>always</code> éƒ¨åˆ†çš„ä»»åŠ¡éƒ½ä¼šè¢«æ‰§è¡Œã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ›´å…·ä½“çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº† <code>block</code> ç»“æ„å¦‚ä½•ä¸é”™è¯¯å¤„ç†å’Œæ¡ä»¶ä¸€èµ·ä½¿ç”¨ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install a package with error handling</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>target_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>block</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install the package</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>apt</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>some-package</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>rescue</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Handle error</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;An error occurred while installing the package.&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>always</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Clean up</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>apt</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>some-package</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>state</span>: <span style=color:#ae81ff>absent</span>
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>block</code> ç»“æ„å†…çš„ä»»åŠ¡å°è¯•å®‰è£…ä¸€ä¸ªè½¯ä»¶åŒ…ã€‚å¦‚æœå®‰è£…è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œ<code>rescue</code> éƒ¨åˆ†çš„ä»»åŠ¡ä¼šè¢«æ‰§è¡Œï¼Œæ˜¾ç¤ºä¸€æ¡é”™è¯¯æ¶ˆæ¯ã€‚æ— è®ºæ˜¯å¦å‡ºç°é”™è¯¯ï¼Œ<code>always</code> éƒ¨åˆ†çš„ä»»åŠ¡éƒ½ä¼šè¢«æ‰§è¡Œï¼Œç¡®ä¿æœ€ç»ˆå°†è½¯ä»¶åŒ…ä»ç³»ç»Ÿä¸­ç§»é™¤ã€‚</p><p>ä½¿ç”¨ <code>block</code> ç»“æ„å¯ä»¥ä½¿å‰§æœ¬æ›´å…·å¯è¯»æ€§ï¼Œå‡å°‘å†—ä½™ä»£ç ï¼Œå¹¶æä¾›æ›´å¥½çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œå› ä¸ºä½ å¯ä»¥é›†ä¸­ç®¡ç†é”™è¯¯çš„å¤„ç†æ–¹å¼ã€‚</p><h3 id=312-changed_when>3.12 changed_when<a hidden class=anchor aria-hidden=true href=#312-changed_when>#</a></h3><blockquote><p>å½“ç¡®å®šæŸä¸ª task ä¸ä¼šå¯¹è¢«æ§åˆ¶ç«¯åšä¿®æ”¹æ—¶ä½†æ‰§è¡Œç»“æœå´æ˜¾ç¤ºæ˜¯é»„è‰²çš„ changed çŠ¶æ€, å¯ä»¥é€šè¿‡<code>changed_when: false</code> å…³é—­ changed çŠ¶æ€</p></blockquote><p>åœ¨ Ansible ä¸­ï¼Œ<code>changed_when</code> æ˜¯ä¸€ä¸ªç”¨äºæ§åˆ¶ä»»åŠ¡æ˜¯å¦è¢«æ ‡è®°ä¸ºå·²æ›´æ”¹ï¼ˆchangedï¼‰çš„é€‰é¡¹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä»»åŠ¡æ‰§è¡Œå¯¼è‡´äº†ä»»ä½•çŠ¶æ€æ›´æ”¹ï¼Œè¯¥ä»»åŠ¡å°†è¢«æ ‡è®°ä¸ºå·²æ›´æ”¹ã€‚ç„¶è€Œï¼Œé€šè¿‡ä½¿ç”¨ <code>changed_when</code>ï¼Œä½ å¯ä»¥è‡ªå®šä¹‰æ ‡è®°ä»»åŠ¡æ˜¯å¦å·²æ›´æ”¹çš„æ¡ä»¶ï¼Œè€Œä¸ä»…ä»…ä¾èµ–äºé»˜è®¤çš„çŠ¶æ€å˜åŒ–æ£€æµ‹ã€‚</p><p><code>changed_when</code> å…è®¸ä½ åœ¨ä»»åŠ¡çº§åˆ«è®¾ç½®ä¸€ä¸ªæ¡ä»¶è¡¨è¾¾å¼ã€‚å¦‚æœè¯¥è¡¨è¾¾å¼è¯„ä¼°ä¸º <code>true</code>ï¼Œé‚£ä¹ˆä»»åŠ¡å°†è¢«æ ‡è®°ä¸ºå·²æ›´æ”¹ã€‚å¦‚æœè¯¥è¡¨è¾¾å¼è¯„ä¼°ä¸º <code>false</code>ï¼Œé‚£ä¹ˆä»»åŠ¡å°†è¢«æ ‡è®°ä¸ºæœªæ›´æ”¹ã€‚</p><p>ä»¥ä¸‹æ˜¯ <code>changed_when</code> çš„åŸºæœ¬è¯­æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task with custom change condition</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>some_module</span>:    <span style=color:#75715e># Replace with the actual module you&#39;re using</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># module arguments...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>changed_when</span>: <span style=color:#ae81ff>condition_expression</span>
</span></span></code></pre></div><p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œ<code>some_module</code> æ˜¯è¦æ‰§è¡Œçš„ä»»åŠ¡æ¨¡å—ï¼Œ<code>condition_expression</code> æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰æ¡ä»¶è¡¨è¾¾å¼ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦å°†ä»»åŠ¡æ ‡è®°ä¸ºå·²æ›´æ”¹ã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ <code>changed_when</code> æ§åˆ¶ä»»åŠ¡æ˜¯å¦è¢«æ ‡è®°ä¸ºå·²æ›´æ”¹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run a command and control changed status</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>command</span>: <span style=color:#ae81ff>echo &#34;Hello, world!&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>register</span>: <span style=color:#ae81ff>command_output</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>changed_when</span>: <span style=color:#e6db74>&#34;command_output.stdout != &#39;Hello, world!\n&#39;&#34;</span>
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>command</code> æ¨¡å—æ‰§è¡Œä¸€ä¸ªå‘½ä»¤æ¥è¾“å‡º &ldquo;Hello, world!"ï¼Œå¹¶å°†è¾“å‡ºç»“æœå­˜å‚¨åœ¨ <code>command_output</code> å˜é‡ä¸­ã€‚é€šè¿‡ä½¿ç”¨ <code>changed_when</code>ï¼Œæˆ‘ä»¬æŒ‡å®šäº†ä¸€ä¸ªæ¡ä»¶è¡¨è¾¾å¼ï¼Œåªæœ‰å½“å‘½ä»¤çš„è¾“å‡ºä¸ç­‰äº &ldquo;Hello, world!\n&rdquo; æ—¶ï¼Œè¯¥ä»»åŠ¡æ‰ä¼šè¢«æ ‡è®°ä¸ºå·²æ›´æ”¹ã€‚</p><p>é€šè¿‡ä½¿ç”¨ <code>changed_when</code>ï¼Œä½ å¯ä»¥æ›´ç²¾ç¡®åœ°æ§åˆ¶ä»»åŠ¡çš„æ›´æ”¹çŠ¶æ€ï¼Œè€Œä¸å—é»˜è®¤çŠ¶æ€å˜åŒ–æ£€æµ‹çš„é™åˆ¶ã€‚è¿™åœ¨æŸäº›æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ï¼Œç‰¹åˆ«æ˜¯å½“ä»»åŠ¡çš„çŠ¶æ€å˜åŒ–å¯èƒ½ä¸ç›´æ¥ä¸è¾“å‡ºç»“æœç›¸å…³æ—¶ã€‚</p><h3 id=313-æ»šåŠ¨æ‰§è¡Œ-serial>3.13 æ»šåŠ¨æ‰§è¡Œ serial<a hidden class=anchor aria-hidden=true href=#313-æ»šåŠ¨æ‰§è¡Œ-serial>#</a></h3><p>æ»šåŠ¨æ‰§è¡Œï¼ˆRolling Deploymentï¼‰æ˜¯ä¸€ç§è½¯ä»¶éƒ¨ç½²ç­–ç•¥ï¼Œç”¨äºå°†æ–°ç‰ˆæœ¬çš„è½¯ä»¶é€æ­¥éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å°†æ‰€æœ‰å®ä¾‹éƒ½æ›´æ–°ä¸ºæ–°ç‰ˆæœ¬ã€‚è¿™ç§éƒ¨ç½²ç­–ç•¥æ—¨åœ¨å‡å°‘é£é™©ï¼Œç¡®ä¿ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œç¨³å®šæ€§ï¼Œå› ä¸ºå¦‚æœåœ¨å…¨é¢éƒ¨ç½²æ–°ç‰ˆæœ¬åå‡ºç°é—®é¢˜ï¼Œå¯èƒ½ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿã€‚</p><p>åœ¨æ»šåŠ¨æ‰§è¡Œä¸­ï¼Œæ–°ç‰ˆæœ¬çš„è½¯ä»¶ä¼šé¦–å…ˆéƒ¨ç½²åˆ°ä¸€å°éƒ¨åˆ†æœåŠ¡å™¨ï¼ˆé€šå¸¸æ˜¯ä¸€ç»„ï¼‰ä¸Šï¼Œç„¶åè¿›è¡Œæµ‹è¯•å’ŒéªŒè¯ã€‚ä¸€æ—¦æ–°ç‰ˆæœ¬åœ¨è¿™äº›æœåŠ¡å™¨ä¸Šå¾—åˆ°ç¡®è®¤ï¼Œå°±ä¼šé€æ­¥å°†æ–°ç‰ˆæœ¬åº”ç”¨äºå…¶ä»–æœåŠ¡å™¨ï¼Œé€æ­¥å¢åŠ æœåŠ¡å™¨æ•°é‡ï¼Œç›´åˆ°æ‰€æœ‰æœåŠ¡å™¨éƒ½å®Œæˆäº†å‡çº§ã€‚</p><p>åœ¨ Ansible ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ç¼–å†™é€‚å½“çš„å‰§æœ¬ï¼ˆplaybookï¼‰å’Œä»»åŠ¡ï¼Œä»¥åŠä½¿ç”¨ <code>serial</code> å‚æ•°æ¥å®ç°æ»šåŠ¨æ‰§è¡Œã€‚<code>serial</code> å‚æ•°å…è®¸ä½ æŒ‡å®šæ¯æ¬¡åœ¨å¤šå°‘ä¸ªç›®æ ‡ä¸»æœºä¸Šè¿è¡Œä»»åŠ¡ã€‚è¿™ä½¿å¾—ä½ å¯ä»¥æ§åˆ¶åœ¨ä¸€æ¬¡éƒ¨ç½²ä¸­é€æ­¥æ›´æ–°å¤šå°‘å°ä¸»æœºã€‚</p><p>ä»¥ä¸‹æ˜¯ä½¿ç”¨ Ansible å®ç°æ»šåŠ¨æ‰§è¡Œçš„ç¤ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Rolling deployment with Ansible</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>target_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>serial</span>: <span style=color:#ae81ff>2</span>  <span style=color:#75715e># Number of hosts to update simultaneously in each batch</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Deploy new version</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>some_module</span>:   <span style=color:#75715e># Replace with the actual module you&#39;re using</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># module arguments...</span>
</span></span></code></pre></div><p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œ<code>serial: 2</code> è¡¨ç¤ºæ¯æ¬¡å°†åŒæ—¶åœ¨ä¸¤å°ç›®æ ‡ä¸»æœºä¸Šè¿è¡Œä»»åŠ¡ã€‚è¿™ä¼šä½¿å¾—æ¯æ¬¡éƒ¨ç½²åªæ›´æ–°ä¸¤å°ä¸»æœºï¼Œç„¶åé€æ­¥å¢åŠ æ›´æ–°æ•°é‡ï¼Œç›´åˆ°æ‰€æœ‰ç›®æ ‡ä¸»æœºéƒ½å®Œæˆå‡çº§ã€‚</p><p>è¯·æ³¨æ„ï¼Œå®é™…çš„æ»šåŠ¨æ‰§è¡Œç­–ç•¥å¯èƒ½å› ç»„ç»‡çš„éœ€æ±‚å’Œåº”ç”¨ç¨‹åºçš„ç‰¹æ€§è€Œæœ‰æ‰€ä¸åŒã€‚ä½ å¯ä»¥æ ¹æ®å®é™…æƒ…å†µæ¥è°ƒæ•´ <code>serial</code> å‚æ•°çš„å€¼ä»¥åŠéƒ¨ç½²ä»»åŠ¡çš„å…¶ä»–å‚æ•°ï¼Œä»¥æ»¡è¶³ä½ çš„éƒ¨ç½²ç­–ç•¥å’Œå¯ç”¨æ€§è¦æ±‚ã€‚</p><h3 id=314-delegate_to>3.14 delegate_to<a hidden class=anchor aria-hidden=true href=#314-delegate_to>#</a></h3><p>åœ¨ Ansible ä¸­ï¼Œ<code>delegate_to</code> æ˜¯ä¸€ä¸ªç”¨äºæŒ‡å®šä»»åŠ¡åº”è¯¥åœ¨å“ªä¸ªè¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œçš„å‚æ•°ã€‚é€šè¿‡ä½¿ç”¨ <code>delegate_to</code>ï¼Œä½ å¯ä»¥å°†ä»»åŠ¡å§”æ‰˜ç»™ä¸€ä¸ªç‰¹å®šçš„ä¸»æœºæ‰§è¡Œï¼Œè€Œä¸æ˜¯é»˜è®¤åœ¨ç›®æ ‡ä¸»æœºä¸Šæ‰§è¡Œã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ <code>delegate_to</code> å°†ä»»åŠ¡å§”æ‰˜ç»™å¦ä¸€ä¸ªä¸»æœºæ‰§è¡Œï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run a task on a specific host</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>command</span>: <span style=color:#ae81ff>echo &#34;This task runs on a different host&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>delegate_to</span>: <span style=color:#ae81ff>specific_host</span>
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>command</code> æ¨¡å—å°†æ‰§è¡Œ <code>echo</code> å‘½ä»¤ï¼Œä½†æ˜¯ä»»åŠ¡ä¼šè¢«å§”æ‰˜ç»™ <code>specific_host</code> æ‰§è¡Œï¼Œè€Œä¸æ˜¯é»˜è®¤çš„ç›®æ ‡ä¸»æœºã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>delegate_to</code> å‚æ•°é€šå¸¸ç”¨äºç‰¹å®šçš„æƒ…å†µï¼Œä¾‹å¦‚éœ€è¦åœ¨ç‰¹å®šä¸»æœºä¸Šæ‰§è¡Œä¸€äº›é…ç½®ç®¡ç†ä»»åŠ¡ã€æ”¶é›†ä¿¡æ¯æˆ–æ‰§è¡ŒæŸäº›æ•…éšœæ’é™¤æ“ä½œæ—¶ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä»»åŠ¡å°†åœ¨ç›®æ ‡ä¸»æœºä¸Šæ‰§è¡Œï¼Œè€Œä¸éœ€è¦ä½¿ç”¨ <code>delegate_to</code>ã€‚</p><h3 id=315-run_onece>3.15 run_onece<a hidden class=anchor aria-hidden=true href=#315-run_onece>#</a></h3><p>åœ¨ Ansible ä¸­ï¼Œ<code>run_once</code> æ˜¯ä¸€ä¸ªç”¨äºæ§åˆ¶ä»»åŠ¡æ˜¯å¦ä»…åœ¨ä¸€ä¸ªä¸»æœºä¸Šè¿è¡Œçš„å‚æ•°ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒAnsible ä¼šåœ¨ç›®æ ‡ä¸»æœºä¸Šçš„æ¯ä¸ªä¸»æœºä¸Šè¿è¡Œä»»åŠ¡ã€‚ä½†æ˜¯ï¼Œæœ‰æ—¶ä½ å¯èƒ½åªå¸Œæœ›åœ¨æ‰€æœ‰ç›®æ ‡ä¸»æœºä¸­çš„ä¸€ä¸ªä¸Šè¿è¡Œä»»åŠ¡ï¼Œè€Œä¸æ˜¯åœ¨æ¯ä¸ªä¸»æœºä¸Šéƒ½è¿è¡Œã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ <code>run_once</code> ä½¿ä»»åŠ¡åªåœ¨ä¸€ä¸ªä¸»æœºä¸Šè¿è¡Œï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run a task only once</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>command</span>: <span style=color:#ae81ff>echo &#34;This task runs only once&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>run_once</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>command</code> æ¨¡å—ä¼šæ‰§è¡Œ <code>echo</code> å‘½ä»¤ï¼Œä½†æ˜¯è¯¥ä»»åŠ¡åªä¼šåœ¨ç›®æ ‡ä¸»æœºä¸­çš„ä¸€ä¸ªä¸»æœºä¸Šè¿è¡Œã€‚</p><p>ä½¿ç”¨ <code>run_once</code> å‚æ•°é€šå¸¸ç”¨äºä¸€äº›åªéœ€åœ¨æ•´ä¸ªå‰§æœ¬ä¸­æ‰§è¡Œä¸€æ¬¡çš„ä»»åŠ¡ï¼Œä¾‹å¦‚æ”¶é›†æ±‡æ€»ä¿¡æ¯æˆ–é…ç½®åˆå§‹åŒ–ã€‚æ³¨æ„ï¼Œ<code>run_once</code> å¹¶ä¸ä¼šå½±å“å…¶ä»–ä»»åŠ¡çš„æ‰§è¡Œæ–¹å¼ï¼Œå…¶ä»–ä»»åŠ¡ä»ç„¶ä¼šåœ¨æ¯ä¸ªç›®æ ‡ä¸»æœºä¸Šè¿è¡Œã€‚</p><h3 id=316-ç¯å¢ƒå˜é‡-environment>3.16 ç¯å¢ƒå˜é‡ environment<a hidden class=anchor aria-hidden=true href=#316-ç¯å¢ƒå˜é‡-environment>#</a></h3><p>åœ¨ Ansible ä¸­ï¼Œ<code>environment</code> æ˜¯ä¸€ä¸ªå‚æ•°ï¼Œç”¨äºåœ¨ä»»åŠ¡çº§åˆ«è®¾ç½®ç¯å¢ƒå˜é‡ã€‚é€šè¿‡ä½¿ç”¨ <code>environment</code> å‚æ•°ï¼Œä½ å¯ä»¥ä¸ºä»»åŠ¡è®¾ç½®ç‰¹å®šçš„ç¯å¢ƒå˜é‡ï¼Œè¿™äº›å˜é‡å°†åœ¨ä»»åŠ¡æ‰§è¡ŒæœŸé—´å¯¹å‘½ä»¤ã€è„šæœ¬ç­‰æ“ä½œäº§ç”Ÿå½±å“ã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ <code>environment</code> å‚æ•°è®¾ç½®ç¯å¢ƒå˜é‡ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run a task with custom environment variables</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>command</span>: <span style=color:#ae81ff>echo &#34;VAR1 is $VAR1, VAR2 is $VAR2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>VAR1</span>: <span style=color:#ae81ff>value1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>VAR2</span>: <span style=color:#ae81ff>value2</span>
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>command</code> æ¨¡å—ä¼šæ‰§è¡Œ <code>echo</code> å‘½ä»¤ï¼Œæ‰“å°å‡ºç”± <code>environment</code> å‚æ•°æŒ‡å®šçš„ç¯å¢ƒå˜é‡å€¼ã€‚</p><p>ä½¿ç”¨ <code>environment</code> å‚æ•°å¯ä»¥è®©ä½ åœ¨ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­è®¾ç½®ä¸´æ—¶ç¯å¢ƒå˜é‡ï¼Œè¿™å¯¹äºå®šåˆ¶ä»»åŠ¡è¡Œä¸ºã€ä¼ é€’é…ç½®ä¿¡æ¯æˆ–è®¾ç½®æ‰§è¡Œç¯å¢ƒéå¸¸æœ‰ç”¨ã€‚è¿™äº›ç¯å¢ƒå˜é‡åªä¼šåœ¨ä»»åŠ¡æ‰§è¡ŒæœŸé—´ç”Ÿæ•ˆï¼Œä¸ä¼šå½±å“åˆ°å…¶ä»–ä»»åŠ¡æˆ–ç›®æ ‡ä¸»æœºçš„çŠ¶æ€ã€‚</p><h3 id=317-include-å’Œ-import>3.17 include å’Œ import<a hidden class=anchor aria-hidden=true href=#317-include-å’Œ-import>#</a></h3><p>åœ¨ Ansible ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>include</code> å’Œ <code>import</code> è¯­å¥æ¥å®ç° YAML æ–‡ä»¶ä¹‹é—´çš„ç›¸äº’è°ƒç”¨å’Œé‡ç”¨ã€‚è¿™å¯ä»¥å¸®åŠ©ä½ ç»„ç»‡å’Œç®¡ç†å¤§å‹çš„ Ansible å‰§æœ¬ï¼Œä½¿å…¶æ›´åŠ æ¨¡å—åŒ–å’Œæ˜“äºç»´æŠ¤ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œæ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <code>include</code> å’Œ <code>import_playbook</code> æ¥å®ç° YAML æ–‡ä»¶ä¹‹é—´çš„ç›¸äº’è°ƒç”¨å’Œé‡ç”¨ã€‚</p><p>å‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹æ–‡ä»¶ç»“æ„ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>ansible_project/
</span></span><span style=display:flex><span>â”œâ”€â”€ main_playbook.yml
</span></span><span style=display:flex><span>â”œâ”€â”€ tasks/
</span></span><span style=display:flex><span>â”‚   â”œâ”€â”€ common_tasks.yml
</span></span><span style=display:flex><span>â”‚   â”œâ”€â”€ task1.yml
</span></span><span style=display:flex><span>â”‚   â””â”€â”€ task2.yml
</span></span><span style=display:flex><span>â””â”€â”€ playbooks/
</span></span><span style=display:flex><span>    â””â”€â”€ other_playbook.yml
</span></span></code></pre></div><ol><li><code>main_playbook.yml</code> æ˜¯ä¸»å‰§æœ¬æ–‡ä»¶ï¼Œå®ƒå¼•å…¥äº†å…¶ä»–æ–‡ä»¶å¹¶å®šä¹‰äº†ä¸€äº›ä»»åŠ¡ã€‚</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Main Playbook</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>target_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>include</span>: <span style=color:#ae81ff>tasks/common_tasks.yml</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>include</span>: <span style=color:#ae81ff>tasks/task1.yml</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>include</span>: <span style=color:#ae81ff>tasks/task2.yml</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>import_playbook</span>: <span style=color:#ae81ff>playbooks/other_playbook.yml</span>
</span></span></code></pre></div><ol start=2><li><code>common_tasks.yml</code> æ–‡ä»¶åŒ…å«ä¸€äº›å…¬å…±ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡å¯ä»¥è¢«å¤šä¸ªå‰§æœ¬é‡ç”¨ã€‚</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Common Task 1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;This is a common task.&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Common Task 2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Another common task.&#34;</span>
</span></span></code></pre></div><ol start=3><li><code>task1.yml</code> æ–‡ä»¶åŒ…å«ç‰¹å®šçš„ä»»åŠ¡ã€‚</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task 1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Task 1 is executed.&#34;</span>
</span></span></code></pre></div><ol start=4><li><code>task2.yml</code> æ–‡ä»¶ä¹ŸåŒ…å«ç‰¹å®šçš„ä»»åŠ¡ã€‚</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task 2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Task 2 is executed.&#34;</span>
</span></span></code></pre></div><ol start=5><li><code>other_playbook.yml</code> æ˜¯å¦ä¸€ä¸ªç‹¬ç«‹çš„å‰§æœ¬ã€‚</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Other Playbook</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>other_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task in Other Playbook</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;This task is from another playbook.&#34;</span>
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>main_playbook.yml</code> å¼•å…¥äº†å¤šä¸ªæ–‡ä»¶å¹¶å®šä¹‰äº†ä¸€ç³»åˆ—ä»»åŠ¡ã€‚<code>common_tasks.yml</code> åŒ…å«äº†ä¸€äº›å…¬å…±ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡å¯ä»¥åœ¨ä¸»å‰§æœ¬å’Œå…¶ä»–å‰§æœ¬ä¸­é‡ç”¨ã€‚<code>task1.yml</code> å’Œ <code>task2.yml</code> åˆ†åˆ«åŒ…å«ç‰¹å®šçš„ä»»åŠ¡ã€‚<code>other_playbook.yml</code> æ˜¯å¦ä¸€ä¸ªç‹¬ç«‹çš„å‰§æœ¬ï¼Œå®ƒå¯ä»¥è¢«å¯¼å…¥åˆ°ä¸»å‰§æœ¬ä¸­ã€‚</p><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥å°† Ansible ä»£ç æ¨¡å—åŒ–ï¼Œæé«˜å¯ç»´æŠ¤æ€§ï¼Œå¹¶æ ¹æ®éœ€è¦é‡ç”¨ä»»åŠ¡å’Œå‰§æœ¬ã€‚</p><h2 id=4-ansible-roles>4 Ansible Roles<a hidden class=anchor aria-hidden=true href=#4-ansible-roles>#</a></h2><p>Ansible è§’è‰²æ˜¯ä¸€ç§ç”¨äºç»„ç»‡å’Œé‡ç”¨ Ansible ä»£ç çš„ç»“æ„åŒ–æ–¹å¼ã€‚è§’è‰²å…è®¸ä½ å°†ä»»åŠ¡ã€å˜é‡ã€æ¨¡æ¿å’Œå¤„ç†é€»è¾‘ç»„ç»‡æˆä¸€ä¸ªå¯ç‹¬ç«‹è°ƒç”¨çš„å•å…ƒï¼Œä½¿å¾—ä½ èƒ½å¤Ÿæ›´å¥½åœ°ç®¡ç†å¤æ‚çš„å‰§æœ¬å’Œéƒ¨ç½²ã€‚</p><p>è§’è‰²çš„ç»„ç»‡ç»“æ„å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>my_role/
</span></span><span style=display:flex><span>â”œâ”€â”€ tasks/
</span></span><span style=display:flex><span>â”‚   â”œâ”€â”€ main.yml
</span></span><span style=display:flex><span>â”‚   â”œâ”€â”€ task1.yml
</span></span><span style=display:flex><span>â”‚   â””â”€â”€ task2.yml
</span></span><span style=display:flex><span>â”œâ”€â”€ vars/
</span></span><span style=display:flex><span>â”‚   â””â”€â”€ main.yml
</span></span><span style=display:flex><span>â”œâ”€â”€ templates/
</span></span><span style=display:flex><span>â”‚   â”œâ”€â”€ template1.j2
</span></span><span style=display:flex><span>â”‚   â””â”€â”€ template2.j2
</span></span><span style=display:flex><span>â””â”€â”€ meta/
</span></span><span style=display:flex><span>    â””â”€â”€ main.yml
</span></span></code></pre></div><ul><li><code>tasks/</code> ç›®å½•åŒ…å«ä¸»ä»»åŠ¡æ–‡ä»¶ <code>main.yml</code>ï¼Œä»¥åŠå…¶ä»–ä»»åŠ¡æ–‡ä»¶å¦‚ <code>task1.yml</code> å’Œ <code>task2.yml</code>ï¼Œè¿™äº›æ–‡ä»¶åŒ…å«è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚</li><li><code>vars/</code> ç›®å½•åŒ…å«å˜é‡æ–‡ä»¶ <code>main.yml</code>ï¼Œè¿™äº›å˜é‡å¯ä»¥åœ¨è§’è‰²ä¸­ä½¿ç”¨ã€‚</li><li><code>templates/</code> ç›®å½•åŒ…å«æ¨¡æ¿æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶å¯ä»¥åœ¨è§’è‰²ä¸­ä½¿ç”¨ä½œä¸ºé…ç½®æ–‡ä»¶æ¨¡æ¿ã€‚</li><li><code>meta/</code> ç›®å½•åŒ…å«è§’è‰²å…ƒæ•°æ®æ–‡ä»¶ <code>main.yml</code>ï¼Œå…¶ä¸­åŒ…å«æœ‰å…³è§’è‰²çš„ä¿¡æ¯ï¼Œå¦‚ä½œè€…ã€ä¾èµ–ç­‰ã€‚</li></ul><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•åˆ›å»ºå’Œä½¿ç”¨ Ansible è§’è‰²ã€‚</p><ol><li>åˆ›å»ºä¸€ä¸ªåä¸º <code>my_role</code> çš„è§’è‰²ç›®å½•ç»“æ„ï¼š</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>ansible_project/
</span></span><span style=display:flex><span>â””â”€â”€ roles/
</span></span><span style=display:flex><span>    â””â”€â”€ my_role/
</span></span><span style=display:flex><span>        â”œâ”€â”€ tasks/
</span></span><span style=display:flex><span>        â”‚   â””â”€â”€ main.yml
</span></span><span style=display:flex><span>        â”œâ”€â”€ vars/
</span></span><span style=display:flex><span>        â”‚   â””â”€â”€ main.yml
</span></span><span style=display:flex><span>        â”œâ”€â”€ templates/
</span></span><span style=display:flex><span>        â”‚   â””â”€â”€ template1.j2
</span></span><span style=display:flex><span>        â””â”€â”€ meta/
</span></span><span style=display:flex><span>            â””â”€â”€ main.yml
</span></span></code></pre></div><ol start=2><li>ç¼–è¾‘ <code>my_role/tasks/main.yml</code> æ–‡ä»¶ï¼Œå®šä¹‰è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼š</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task 1 in Role</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Task 1 of my_role is executed.&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Task 2 in Role</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>debug</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>msg</span>: <span style=color:#e6db74>&#34;Task 2 of my_role is executed.&#34;</span>
</span></span></code></pre></div><ol start=3><li>ç¼–è¾‘ <code>my_role/vars/main.yml</code> æ–‡ä»¶ï¼Œå®šä¹‰è§’è‰²å˜é‡ï¼š</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>role_var1</span>: <span style=color:#ae81ff>value1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>role_var2</span>: <span style=color:#ae81ff>value2</span>
</span></span></code></pre></div><ol start=4><li>ç¼–è¾‘ <code>my_role/templates/template1.j2</code> æ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶æ¨¡æ¿ï¼š</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[Section]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>var1</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>{{ role_var1 }}</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>var2</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>{{ role_var2 }}</span>
</span></span></code></pre></div><ol start=5><li>ç¼–è¾‘ <code>my_role/meta/main.yml</code> æ–‡ä»¶ï¼Œå®šä¹‰è§’è‰²å…ƒæ•°æ®ï¼š</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>galaxy_info</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>author</span>: <span style=color:#ae81ff>Your Name</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>description</span>: <span style=color:#ae81ff>A sample Ansible role</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>license</span>: <span style=color:#ae81ff>MIT</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>min_ansible_version</span>: <span style=color:#ae81ff>2.9</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>platforms</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Fedora</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>versions</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>all</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ubuntu</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>versions</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>all</span>
</span></span></code></pre></div><ol start=6><li>åœ¨ä¸»å‰§æœ¬ä¸­ä½¿ç”¨è§’è‰²ï¼š</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Playbook using the role</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>target_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>roles</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>my_role</span>
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>my_role</code> è§’è‰²è¢«å®šä¹‰ä¸ºä¸€ä¸ªç‹¬ç«‹çš„ç›®å½•ï¼Œå…¶ä¸­åŒ…å«äº†ä»»åŠ¡ã€å˜é‡ã€æ¨¡æ¿å’Œå…ƒæ•°æ®ã€‚ä¸»å‰§æœ¬é€šè¿‡ <code>roles</code> éƒ¨åˆ†å¼•ç”¨äº†è¿™ä¸ªè§’è‰²ï¼Œå¹¶åœ¨ç›®æ ‡ä¸»æœºä¸Šæ‰§è¡Œäº†è§’è‰²ä¸­çš„ä»»åŠ¡å’Œæ“ä½œã€‚</p><p>ä½¿ç”¨è§’è‰²å¯ä»¥ä½¿ Ansible ä»£ç æ›´åŠ æ¨¡å—åŒ–ã€æ˜“äºç»´æŠ¤å’Œé‡ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤šä¸ªé¡¹ç›®ã€ç¯å¢ƒæˆ–åº”ç”¨ç¨‹åºæ—¶ã€‚</p></div><div class=post-reward><div style=padding:0;margin:0;width:100%;font-size:16px;text-align:center><div id=QR style=opacity:0><div id=wechat style=display:inline-block><a class=fancybox rel=group><img id=wechat_qr src=https://senmer.github.io/static/img/wechat_pay.png alt=wechat_pay></a><p>å¾®ä¿¡</p></div><div id=alipay style=display:inline-block><a class=fancybox rel=group><img id=alipay_qr src=https://senmer.github.io/static/img/alipay.png alt=alipay></a><p>æ”¯ä»˜å®</p></div></div><button id=rewardButton onclick='var qr=document.getElementById("QR");qr.style.opacity==="0"?qr.style.opacity="1":qr.style.opacity="0"'>
<span>ğŸ§§ é¼“åŠ±</span></button></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://senmer.github.io/zh/posts/tech/zookeeper/zookeeper/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>Zookeeper</span></a>
<a class=next href=https://senmer.github.io/zh/posts/tech/java/java-%E9%9B%86%E5%90%88/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>java-é›†åˆ</span></a></nav></footer></div><style>.comments_details summary::marker{font-size:20px;content:'ğŸ‘‰å±•å¼€è¯„è®º';color:var(--content)}.comments_details[open] summary::marker{font-size:20px;content:'ğŸ‘‡å…³é—­è¯„è®º';color:var(--content)}</style><div><details class=comments_details open><summary style=display:none></summary><div id=tcomment></div></details><script src=https://cdn.staticfile.org/twikoo/1.6.16/twikoo.all.min.js></script><script>twikoo.init({envId:"https://hugo-api-khaki.vercel.app/# å¡«å†™è‡ªå·±çš„twikoo id",el:"#tcomment",lang:"zh-CN",region:null,path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><span>Copyright
&copy;
2020-2023
<a href=https://senmer.github.io/zh/ style=color:#939393>WZ's Blog</a>
All Rights Reserved</span>
<a href=https://beian.miit.gov.cn/ target=_blank style=color:#939393></a>&nbsp;
<span><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null" style=display:inline-block;text-decoration:none;height:20px;color:#939393><img src style="float:left;margin:0 5px 0 0"></a></span>
<span id=busuanzi_container><span class="fa fa-user"></span> <span id=busuanzi_value_site_uv></span>
<span class="fa fa-eye"></span> <span id=busuanzi_value_site_pv></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span></span></a>
<script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>200||document.documentElement.scrollTop>200?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{(function(){document.cookie="change-themes="+escape("false")})(),document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.body.addEventListener("copy",function(e){if(window.getSelection().toString()&&window.getSelection().toString().length>50){let t=e.clipboardData||window.clipboardData;if(t){e.preventDefault();let n=window.getSelection().toString()+`

â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€ŒWZ's Blogã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚
åŸæ–‡é“¾æ¥ï¼š`+location.href,s=window.getSelection().toString()+`

â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€ŒWZ's Blogã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚
åŸæ–‡é“¾æ¥ï¼š`+location.href;t.setData("text/html",n),t.setData("text/plain",s)}}})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="å¤åˆ¶";function i(){t.innerText="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerText="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){let t=e.textContent+`
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€ŒWZ's Blogã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚
åŸæ–‡é“¾æ¥ï¼š`+location.href;navigator.clipboard.writeText(t),i();return}const n=document.createRange();n.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(n);try{document.execCommand("copy"),i()}catch{}s.removeRange(n)});let l=e.className.replaceAll("language-",""),n=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),o=document.createElement("div");o.innerText=l,n.setAttribute("class","mac-tool"),a.setAttribute("class","mac bb1"),r.setAttribute("class","mac bb2"),c.setAttribute("class","mac bb3"),o.setAttribute("class","language-type"),n.appendChild(a),n.appendChild(r),n.appendChild(c),n.appendChild(o),s.classList.contains("highlight")?(s.appendChild(t),s.appendChild(n)):s.parentNode.firstChild==s||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?(e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t),s.appendChild(n)):(e.parentNode.appendChild(t),s.appendChild(n)))})</script></body></html>